<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<script>
    <property key="dff.charset" value="windows-1252" />
    <property key="dff.date" value="2020-Jul-15 15:08:16" />
    <property key="dff.version" value="5.1.0.20200628" />
    <property key="submodel.description" value="Pluguin to publish your maps online. (Experimental)&#x0A;windows only for now" />
    <property key="submodel.documentation" value="https://mappia.earth/mappia_publisher/" />
    <property key="submodel.group" value="Web" />
    <property key="submodel.import" value='CreateLegendFromQntEntry { { &quot;inputMap&quot; : Map, &quot;MaximumNumberOfCategories&quot; : PositiveIntegerValue } { } { &quot;categoriesAsCsv&quot; : Table, &quot;generatedCategories&quot; : Categorization } }' />
    <property key="submodel.largeicon" value="iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAHuklEQVR42rVXCVCU5xmGNk0iVmLwBooCixwL7P57sPe9/7H3fR+wB9dyLofVig4ahLCLmhAp5hKNxsQmsWiiBicSDjUHU0OTpk47aae2TUwnbSedSqaxU+n3o2t2WTZCMn4z3+z/v9//fu/zvcfzfpuUtPTxQG4pXyyxB4YU/ta3yBJ1edLKlSuT7udI31xSwFQ6W2TetiNslXMScTcOs9XuFpJQrsQ8zWGmyjHKkFtHhGZ/ZwFDjACV5O9tNC0tLVXpbz9tatkzIfe3X9M3dr5PEStViTZfvmbNeobM3Fe+a+AG7KqfNjTvfpMk0qDf1f6PJLaal2Te4AWRpWqco3FfLGJIuoXW6iGG3DIqNPm7soiMIvDdo9kUDo9n8u2lIcYRibPu2RIuelZkrZo0Bvf8BfMEr+Qx+YVLNf4QMP4K7Gw4AZ5XgY3PbSykbuBqykc5SkcNkD3IUtrdfL33FFdXMQFO+xJFpDWnZRAyxdaa1wVm//Gk5cvXcbTuaRqskfONvsvZhdDGxZnetOlhiSNwEnYGjuLJhovIItVF/Hf16tUrgCdOcXTOPfPDUMKW81F34xWW2rENX8vII5PB6S/ja5BIJSjDLKObiMT132o7P780Gy1vPiu21x6KGMcH7n7c1ZEK4GhdQzyd5zAeJtwYCEmT3Nf2EVWqVkR0SvlKt6Lyp0ORdxJfhQiM/suFTKk0IQBdQ+cY5mn5OIdIzIqWI+VNJwkQSxAlSgYn7Yad9SMyb+srQGcyh8zIi9YRGn0d+IzWAe8H/d3PzaSkpKQvCAB21l0isuEWtsrxThlqrom4GS5v6qPB+uqoT38IibUuXf3O3/l7np9hKW09K9LTV0fvhXlaDxdzUDP+TKBziGWY+TRDYTuore/440/yIVqc8XVZWTkCo28yUn5speMZlsrxOn4ypsYV5OrLW/HkZMqtjSyF45LIWnM4n8bvgp2NR/l6z2NstfN9ibX66TwymzznNXfju6nrc+g0zLgPEmtOEVloGS43BLveAom7NQ4A2DgISmd3tIzEU6Bcreddgcl7UmDynwfJOM5Wux5bl5u7Fl8vYsNOzNs6EClbCNa6uFr3mzx9xRlza/enQnPlGwp/kBfjGfC9JrDjZBwAqSPwWh7E5s8nIrbGOVC779hNrr7iKpEpVkWvg1O55d62gZgiKiBvosvM5z27B/8u97RMkHlyTXTFsJSWeteO/j+Dx4djSAfQ6NSdzE/Op0pEPF35IbJQPcpS2dsEJt9QNpFeyVDaXmUqbEfXZhevm8t0bgyAB+hycwcdNY0XC+QwSai4SEGMDrmvfUrmbRkhsrA5RtywsbiwOnzkZmGZ6G7FJM01FkdgmC6z1IJYXhKYfb8oYiKyCHKRpXogl8LF7tS0gYYaJ2mooa6YL/PK/a2DpXyZmCGzvM1QWHbhJHW7DOXj0QkrdQbGxPaaMwVMqdCy5fEPxbZAz10AoPafVVS2fwJiNji/BOdKyuzfHwFwuzOlpzDllr2AH67om3b9FnhvOLuUlh+tAwCMzdsmuVQgU4E8GwMh+Ny+ff+vMwoKVs2tAMIYtm3tuw7i/fiG7MI4ygThCMcAAJtRYaNf6qj70NzWc42psD6F50sMAF4cAJxKV7DUzh3GYNdnnq6n/wDK8TYfFLGlGqmr4Zc0RO/DWypX6zoNerzjDtMBABWhCIAiGh8CFXMO5MJAAY1fDRjwIA6GatVNQ1uxYUovfILSi5yFgthnUBixEvplD60nENYIjJ5ursHzgdRR3w/CN4i6m5+IxrZMbK+7iiPEX7IhLklkrjoA4voOiP/eMtR4JIfE1LMU9n0A4HmQH4w5MEyJA65teIESQsbAnF1w9mA36F7dxxyduz3iJXX11jdKuJgpxjuauo5TTKWjcp7TlrGUjm3VfS/8m6VyXqGjhiYg+8HdBmSXdtB6ZV8lNP7NvEUNI4131H4stdf/Hr8+xMZZ79kGLhyvRssyiRQCKKuX0YrmaUBEU4DBzkFilW2uIfWqV0Dd8OeLMB6Z/6OEETEkVFtxD8TlR8bmMpJ1S+hvOKfjMeNoXAdoiGGkqAzlwY76brw3EEgsiOt1n6A2qz6ldmHXFzJUcaxptu/C4MIgwsg0VtV6APDKzoV6UbJz+/4pwAPH2RrXFF1mqIrwAFbRcmwzTSCjhOCfgY1uJjql58Xm2Rtfz8zi48mx5xb8Bm6qv0ooKWMt2A1Nrd0XsIrge6mpqWnRcrGtZrxkO7/n21zseTE4O/P1V7PRo388HgQrpL9Vukt0mBZGiuMAlPDVfH1D568kttqjkRLEB9ti+wgo/2cpxr8B8Xwi0P+lhOHq+BsZuDZpAh2XYFfDa0mZmcuAKIXRqL+eyLj3eEtC45Hx1MShxIkZQnnxd4Pc0rXqwPZxma/tzCrQ05k79f9IBAD9uW1W9Uz53Lz2z7/GGPYBcJE1aghdUB8KIWcWzIdHsrIeVdVsuwD44Tfc3eYvF1Nqn3zxpxgAioPOxZTnlwnviBkEQqahsfMDpKvmX/cRwI173tSLt3BooARv3ScAE4v6u0ANwYP32oz3hHZW2K+/O2lh9J4AoBBqWBQAYqfpQaDw8hKo996zF9m/5D+M5DCqAcrnQPl88R0NzwDD45ReTB/Z8/9yI4/haFpiAAAAAABJRU5ErkJggg==" />
    <property key="submodel.name" value="MappiaPreviewMapOnline" />
    <property key="submodel.smallicon" value="iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAC4UlEQVR42mNgQANSxsZcbon5PsEFzZkeicXNtsEJpW5R2RHGDr4iDAQAo3tCQb9bfN5Ju+DECQ7hGdF8MjJCweUd2o6R6V2usTmn/bOq1uu5uXFj08zkGpff4RSVYWblF11sF5TUYBuYaO+VVJZhG5Ya7BSe0WPpE+3sGp1dZx+S0gRyJYpur5SyeSDNILZdcFIFyDUg2jetIsU1NneioWeoqEtEhoNncqGvlVugmG96+VqgGjawZhkZGU6nyLR266CEWsfQRHsr39g8C48IBfuQpCqftIqd1gFxTQ7hKRZBuY3pJu5hwUDvFPllVk4x9wvWAxvgEpXnbxMQbwxi2wQml/uklp6y9InKYdDWZrMLSS0HucY2KDHEJ638rGtMbgdYD9A1UeVd+QwQJydWu0ZmRVoHxFba+SeGm3qEVtgExOVbB8ZH24elVtoGxXtb+kdXmHuG17nF5vo6hqd1OYYmewfmNiwDGxCQVX3YOjAuHhYe5t6RWSDawj/KxTe94iowUFNBfEu/mHxYbDmEpRVHV0+4L66nx83gHJ3daBUcH2zlG1MOdFqSiUtgoU1AbJpVQHymXVhCvUmV32qTVs9Hxi2eT0yavBZaRcQ2A2Ms3SEstRtsnF96ZZBPSqUX2Bbf+EjP5KJr1v4x6Q4NDixADXeNutz+I2OzHs8bJkke6r6p5SVgA0S1tXkCc2oXAgOyxjYo2RsUfSY1vi3GLR7PYZqqNrf/n3xoHtwQ6+rQXZZ+EYbwdOCXWbMcmNJMwH4vCluDbCNI899/f/+DwNRD88FiJt0ef4w6XVeZdnlJgA3QBkYZMNHMtAtJcjNr9nkA02w7IfDv3OPL/n//9QNswNIz6/77zoqHG27Y5bYVkRyNjVl9MyqXWbaGfEf399uv78EG2E0M/I8m9wkjUxg1uZehGzDt8IL/80+s/G/e5/0PTW4vZrb6z8Bo1OlWCpS8j24QEv5l1OW+x6DdQwEAz35TFJ4jlw4AAAAASUVORK5CYII=" />
    <functor name="String">
        <property key="dff.functor.alias" value="expressionNotUsed" />
        <inputport name="constant" peerid="v7" />
    </functor>
    <functor name="LoadLookupTable">
        <property key="dff.functor.alias" value="loadTemporaryFilterTable" />
        <property key="viewer.table" value="yes" />
        <inputport name="filename" peerid="v9" />
        <inputport name="suffixDigits">0</inputport>
        <inputport name="step">.none</inputport>
        <inputport name="workdir">.none</inputport>
        <outputport name="table" id="v1" />
    </functor>
    <functor name="IntegerValue">
        <property key="dff.functor.alias" value="Max Zoom" />
        <property key="dff.functor.comment" value="Max zoom of details." />
        <property key="dff.functor.extendedcomment" value="The maximum detail level.&#x0A;* Each increased zoom double the publication time.&#x0A;* https://wiki.openstreetmap.org/wiki/Zoom_levels" />
        <property key="submodel.in.constant.advanced" value="yes" />
        <property key="submodel.in.constant.description" value="Max zoom of details." />
        <property key="submodel.in.constant.name" value="maxZoom" />
        <property key="submodel.in.constant.optional" value="yes" />
        <property key="submodel.in.constant.order" value="4" />
        <inputport name="constant">5</inputport>
        <outputport name="object" id="v2" />
    </functor>
    <functor name="Map">
        <property key="dff.functor.alias" value="Map To Preview" />
        <property key="dff.functor.comment" value="Map to display online." />
        <property key="submodel.in.constant.advanced" value="no" />
        <property key="submodel.in.constant.description" value="Map to display online." />
        <property key="submodel.in.constant.name" value="mapToPreview" />
        <property key="submodel.in.constant.optional" value="no" />
        <property key="submodel.in.constant.order" value="1" />
        <property key="viewer.object" value="yes" />
        <outputport name="object" id="v3" />
    </functor>
    <functor name="ExtractStructNumber">
        <property key="dff.functor.alias" value="extractStructNumber802" />
        <property key="submodel.out.number.description" value="Returns 1 when finish" />
        <property key="submodel.out.number.name" value="output" />
        <property key="submodel.out.number.order" value="1" />
        <inputport name="struct" peerid="v13" />
        <inputport name="name">$&quot;(out)&quot;</inputport>
    </functor>
    <functor name="String">
        <property key="dff.functor.alias" value="Map Filename Or Title" />
        <property key="dff.functor.comment" value="The title or path for the published map." />
        <property key="submodel.in.constant.advanced" value="no" />
        <property key="submodel.in.constant.description" value="The title or path for the published map." />
        <property key="submodel.in.constant.name" value="mapFilenameOrTitle" />
        <property key="submodel.in.constant.optional" value="yes" />
        <property key="submodel.in.constant.order" value="6" />
        <inputport name="constant">$&quot;(New Dinamica Online Example Map)&quot;</inputport>
        <outputport name="object" id="v4" />
    </functor>
    <functor name="TableJunction">
        <property key="dff.functor.alias" value="tableJunction41962" />
        <inputport name="possibleTable1" peerid="v24" />
        <inputport name="possibleTable2" peerid="v25" />
        <outputport name="table" id="v5" />
    </functor>
    <containerfunctor name="CalculateMap">
        <property key="dff.container.collapsed" value="no" />
        <property key="dff.functor.alias" value="calculateMap2703" />
        <property key="viewer.result" value="yes" />
        <inputport name="expression">[&#x0A;    if isNull(i1) then&#x0A;        null&#x0A;    else &#x0A;        t1[&gt;=i1] ? v1&#x0A;]</inputport>
        <inputport name="cellType">.uint8</inputport>
        <inputport name="nullValue">.default</inputport>
        <inputport name="resultIsSparse">.no</inputport>
        <inputport name="resultFormat">.none</inputport>
        <outputport name="result" id="v6" />
        <functor name="NumberMap">
            <property key="dff.functor.alias" value="numberMap2704" />
            <inputport name="map" peerid="v3" />
            <inputport name="mapNumber">1</inputport>
        </functor>
        <functor name="NumberTable">
            <property key="dff.functor.alias" value="numberTable2716" />
            <inputport name="table" peerid="v1" />
            <inputport name="tableNumber">1</inputport>
        </functor>
        <functor name="NumberValue">
            <property key="dff.functor.alias" value="numberValue36570" />
            <inputport name="value" peerid="v10" />
            <inputport name="valueNumber">1</inputport>
        </functor>
    </containerfunctor>
    <containerfunctor name="Group">
        <property key="dff.functor.alias" value="group2717" />
        <inputport name="sequenceInput">.none</inputport>
        <functor name="ExtractStructString">
            <property key="dff.functor.alias" value="extractStructString2706" />
            <inputport name="struct" peerid="v11" />
            <inputport name="name">$&quot;(exp)&quot;</inputport>
            <outputport name="string" id="v7" />
        </functor>
        <functor name="ExtractStructString">
            <property key="dff.functor.alias" value="extractStructString2706" />
            <property key="viewer.string" value="yes" />
            <inputport name="struct" peerid="v11" />
            <inputport name="name">$&quot;(csv)&quot;</inputport>
            <outputport name="string" id="v8" />
        </functor>
        <functor name="SaveTextFile">
            <property key="dff.functor.alias" value="saveTemporaryFilterTable" />
            <inputport name="text" peerid="v8" />
            <inputport name="filename" peerid="v9" />
            <inputport name="suffixDigits">2</inputport>
            <inputport name="step">.none</inputport>
            <inputport name="workdir">.none</inputport>
        </functor>
        <functor name="GenerateTemporaryFile">
            <property key="dff.functor.alias" value="generateTemporaryFile2708" />
            <inputport name="extension">$&quot;(csv)&quot;</inputport>
            <inputport name="createFile">.no</inputport>
            <outputport name="filename" id="v9" />
        </functor>
        <functor name="ExtractStructNumber">
            <property key="dff.functor.alias" value="maxValue" />
            <property key="dff.functor.comment" value="Last else" />
            <property key="viewer.number" value="yes" />
            <inputport name="struct" peerid="v11" />
            <inputport name="name">$&quot;(max)&quot;</inputport>
            <outputport name="number" id="v10" />
        </functor>
        <containerfunctor name="CalculatePythonExpression">
            <property key="dff.container.collapsed" value="no" />
            <property key="dff.functor.alias" value="calculatePythonExpression2698" />
            <inputport name="expression">&quot;aW1wb3J0IGpzb24KY3N2TGVnZW5kID0gZGluYW1pY2EuaW5wdXRzWyJ0MSJdCgpnZW5Dc3YgPSBbJ0NhdGVnb3J5KiwgVG8sJ10KaGVhZCA9IGNzdkxlZ2VuZFswXQpyZXN1bHQgPSBbXQppRWxtID0gMApmb3IgZWxtIGluIGNzdkxlZ2VuZFsxOl06CgljdXJMaW5lID0gJycKCWlmIGxlbihyZXN1bHQpID09IDA6CgkJY3VyTGluZSA9ICdpZiBpMSA8PSAnICsgc3RyKGVsbVtoZWFkLmluZGV4KCdUbycpXSkgKyAnIHRoZW4gJyArIHN0cihpRWxtKQoJZWxpZiBpRWxtICsgMiA9PSBsZW4oY3N2TGVnZW5kKTogIyArMiDDqSBwcSB0aXJhIG8gaGVhZCBkbyBjc3YKCQljdXJMaW5lID0gJ2Vsc2UgJyArIHN0cihpRWxtKQoJZWxzZToKCQljdXJMaW5lID0gJyBlbHNlIGlmIGkxIDw9ICcgKyBzdHIoZWxtW2hlYWQuaW5kZXgoJ1RvJyldKSArICcgdGhlbiAnICsgc3RyKGlFbG0pCglyZXN1bHQuYXBwZW5kKGN1ckxpbmUpCglnZW5Dc3YuYXBwZW5kKHN0cihlbG1baGVhZC5pbmRleCgnVG8nKV0pICsgIiwgIiArIHN0cihpRWxtKSkKCWlFbG0gPSBpRWxtICsgMQpwcmludChqc29uLmR1bXBzKGNzdkxlZ2VuZCkpCnByaW50KCItLS0tLS0tLS0tLS0tLSIpCnByaW50KCdcbicuam9pbihyZXN1bHQpKQppRWxtID0gaUVsbSAtIDEKZGluYW1pY2Eub3V0cHV0c1snbWF4J10gPSBpRWxtCmRpbmFtaWNhLm91dHB1dHNbJ2V4cCddID0gJ1xuJy5qb2luKHJlc3VsdCkKZGluYW1pY2Eub3V0cHV0c1snY3N2J10gPSAnXG4nLmpvaW4oZ2VuQ3N2KQ==&quot;</inputport>
            <outputport name="result" id="v11" />
            <functor name="NumberTable">
                <property key="dff.functor.alias" value="numberTable2699" />
                <inputport name="table" peerid="v5" />
                <inputport name="tableNumber">1</inputport>
            </functor>
            <functor name="NumberString">
                <property key="dff.functor.alias" value="numberString2709" />
                <inputport name="value" peerid="v9" />
                <inputport name="valueNumber">1</inputport>
            </functor>
        </containerfunctor>
    </containerfunctor>
    <containerfunctor name="Group">
        <property key="dff.functor.alias" value="group2723" />
        <inputport name="sequenceInput">.none</inputport>
        <functor name="SaveMap">
            <property key="dff.functor.alias" value="saveMap2720" />
            <inputport name="map" peerid="v6" />
            <inputport name="filename" peerid="v12" />
            <inputport name="suffixDigits">2</inputport>
            <inputport name="step">.none</inputport>
            <inputport name="useCompression">.yes</inputport>
            <inputport name="workdir">.none</inputport>
            <inputport name="ignoreCostlySparseCategories">.yes</inputport>
        </functor>
        <functor name="GenerateTemporaryFile">
            <property key="dff.functor.alias" value="mapToPublish" />
            <inputport name="extension">$&quot;(tif)&quot;</inputport>
            <inputport name="createFile">.no</inputport>
            <outputport name="filename" id="v12" />
        </functor>
    </containerfunctor>
    <containerfunctor name="CalculatePythonExpression">
        <property key="dff.container.collapsed" value="no" />
        <property key="dff.functor.alias" value="calculatePythonExpression2724" />
        <inputport name="expression">&quot;IyEvdXNyL2Jpbi9weXRob24KIyAtKi0gY29kaW5nOiB1dGYtOCAtKi0KCiMgI0hhY2sgcGFyYSBjb3JyaWdpciBvIHByb2JsZW1hIGNvbSBvIGRlZmF1bHRlbmNvZGluZywgZGVzc2EgbWFuZWlyYSBmdW5jaW9uYSBlbSBxdWFscXVlciBjb21wdXRhZG9yIHF1ZSBwb3NzdWEgbyBlbmNvZGluZyAndXRmLTgnLgojIGltcG9ydCBzeXMKIyByZWxvYWQoc3lzKQojIHN5cy5zZXRkZWZhdWx0ZW5jb2RpbmcoInV0Zi04IikKCnZlcnNpb24gPSAnMC4xJwoKaW1wb3J0IG9zCmltcG9ydCBqc29uCmZyb20gcGF0aGxpYiBpbXBvcnQgUGF0aAppbXBvcnQgd2ViYnJvd3NlcgojIGltcG9ydCBzeXMKIyBpbXBvcnQgaW1wb3J0bGliCiMgIyBpbXBvcnRsaWIucmVsb2FkKHN5cykKIyAjIHN5cy5zZXRkZWZhdWx0ZW5jb2RpbmcoJ1VURjgnKQoKCmlzRGluYW1pY2EgPSBGYWxzZQp0cnk6CiAgICBkaW5hbWljYS5wYWNrYWdlKCJvcyIpCiAgICBpc0RpbmFtaWNhID0gVHJ1ZQpleGNlcHQ6CiAgICBpc0RpbmFtaWNhID0gRmFsc2UKCgp0cnk6CiAgICBmcm9tIG9zZ2VvIGltcG9ydCBvZ3IsIG9zciwgZ2RhbApleGNlcHQ6CiAgICBpbXBvcnQgdGVtcGZpbGUKICAgIGltcG9ydCBzaHV0aWwKCiAgICBpZiBpc0RpbmFtaWNhOgogICAgICAgIGRpbmFtaWNhLnBhY2thZ2UoIndoZWVsPT0wLjMzLjYiLCBOb25lLCAid2hlZWwiKQogICAgICAgIGRpbmFtaWNhLnBhY2thZ2UoIndnZXQ9PTMuMiIsIE5vbmUsICJ3Z2V0IikKICAgICAgICBkaXJlY3RvcnkgPSB0ZW1wZmlsZS5ta2R0ZW1wKCkKICAgICAgICBnZGFsQ29tcGlsZWRGaWxlID0gb3MucGF0aC5qb2luKGRpcmVjdG9yeSwgJ0dEQUwtMi40LjEtY3AzNy1jcDM3bS13aW5fYW1kNjQud2hsJykKICAgICAgICB3Z2V0LmRvd25sb2FkKCJodHRwczovL2dpdGh1Yi5jb20vYXNmaXhpYS9yYXN0ZXJzdGF0c193aGVlbC9yYXcvbWFzdGVyL0dEQUwtMi40LjEtY3AzNy1jcDM3bS13aW5fYW1kNjQud2hsIiwgZ2RhbENvbXBpbGVkRmlsZSkKICAgICAgICBkaW5hbWljYS5wYWNrYWdlKCJnZGFsIiwgZ2RhbENvbXBpbGVkRmlsZSkKICAgICAgICBvcy5yZW1vdmUoZ2RhbENvbXBpbGVkRmlsZSkKCm9zLmVudmlyb25bJ0dJVF9QWVRIT05fUkVGUkVTSCddID0gJ3F1aWV0JwppZiBpc0RpbmFtaWNhOgogICAgZGluYW1pY2EucGFja2FnZSgicmVxdWVzdHMiKQogICAgZGluYW1pY2EucGFja2FnZSgiR2l0UHl0aG9uIiwgTm9uZSwgImdpdCIpCiAgICBkaW5hbWljYS5wYWNrYWdlKCJ4bWx0b2RpY3QiKQogICAgZGluYW1pY2EucGFja2FnZSgiUGlsbG93IiwgTm9uZSwgIlBJTCIpCgp0cnk6CiAgICBpbXBvcnQgUU1lc3NhZ2VCb3gKZXhjZXB0OgogICAgcGFzcwoKaW1wb3J0IGN0eXBlcwoKCmNsYXNzIFFNZXNzYWdlQm94KCk6CiAgICBtZXNzYWdlQm94ID0gY3R5cGVzLndpbmRsbC51c2VyMzIuTWVzc2FnZUJveFcKICAgICNzZXRUaW1lciA9IGN0eXBlcy53aW5kbGwudXNlcjMyLlNldFRpbWVyVyAjKE5VTEwsIE5VTEwsIGludCh0aW1lb3V0ICogMTAwMCksIE5VTEwpCiAgICBJREFCT1JUID0gMyAjVGhlIEFib3J0IGJ1dHRvbiB3YXMgc2VsZWN0ZWQuCiAgICBJRENPTlRJTlVFID0gMTEgI1RoZSBDb250aW51ZSBidXR0b24gd2FzIHNlbGVjdGVkLgogICAgSURSRVRSWSA9IDQgI1RoZSBSZXRyeSBidXR0b24gd2FzIHNlbGVjdGVkLgogICAgSURUUllBR0FJTiA9IDEwICNUaGUgVHJ5IEFnYWluIGJ1dHRvbiB3YXMgc2VsZWN0ZWQuCiAgICBJRFlFUyA9IDYgI1RoZSBZZXMgYnV0dG9uIHdhcyBzZWxlY3RlZC4KICAgIFllcyA9IDYKICAgIElETk8gPSA3ICNUaGUgTm8gYnV0dG9uIHdhcyBzZWxlY3RlZC4KICAgIE5vID0gNwogICAgSURDQU5DRUwgPSAyICNUaGUgQ2FuY2VsIGJ1dHRvbiB3YXMgc2VsZWN0ZWQuCiAgICBDYW5jZWwgPSAyCiAgICBJRElHTk9SRSA9IDUgI1RoZSBJZ25vcmUgYnV0dG9uIHdhcyBzZWxlY3RlZC4KICAgIERpc2NhcmQgPSA1CiAgICBJbmZvcm1hdGlvbiA9IDQwCiAgICBJRE9LID0gMSAjVGhlIE9LIGJ1dHRvbiB3YXMgc2VsZWN0ZWQuCiAgICBPayA9IDEKCiAgICBtZXNzYWdlID0gTm9uZQogICAgdGl0bGUgPSBOb25lCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHNldFRleHQobWVzc2FnZSk6CiAgICAgICAgUU1lc3NhZ2VCb3gubWVzc2FnZSA9IG1lc3NhZ2UKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgc2V0V2luZG93VGl0bGUodGl0bGUpOgogICAgICAgIFFNZXNzYWdlQm94LnRpdGxlID0gdGl0bGUKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgc2V0SWNvbihpY29uKToKICAgICAgICBwYXNzCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHNldFN0YW5kYXJkQnV0dG9ucyhidXR0b25zKToKICAgICAgICBwYXNzCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGV4ZWNfKCk6CiAgICAgICAgcmV0dXJuIFFNZXNzYWdlQm94LnF1ZXN0aW9uKE5vbmUsIFFNZXNzYWdlQm94LnRpdGxlLCBRTWVzc2FnZUJveC5tZXNzYWdlKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBxdWVzdGlvbihuc2VpLCB0aXRsZSwgbXNnLCBkZWZhdWx0QnV0dG9uPU5vbmUsIGJ1dHRvbnM9Tm9uZSk6CiAgICAgICAgcmV0dXJuIFFNZXNzYWdlQm94Lm1lc3NhZ2VCb3goTm9uZSwgbXNnLCB0aXRsZSwgMykKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZXJyb3IobXNnLCBkZWZhdWx0QnV0dG9uPU5vbmUsIGJ1dHRvbnM9Tm9uZSk6CiAgICAgICAgcmV0dXJuIFFNZXNzYWdlQm94Lm1lc3NhZ2VCb3goTm9uZSwgbXNnLCAiRXJyb3IiLCAyKQoKCgoKCgoKY2xhc3MgRmVlZGJhY2soKToKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBwdXNoQ29uc29sZUluZm8obWVzc2FnZSk6CiAgICAgICAgcHJpbnQobWVzc2FnZSkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgc2V0UHJvZ3Jlc3MocGVyY2VudGFnZSk6CiAgICAgICAgcHJpbnQoIlByb2dyZXNzOiAiICsgc3RyKHBlcmNlbnRhZ2UpKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBzZXRQcm9ncmVzc1RleHQobWVzc2FnZSk6CiAgICAgICAgcHJpbnQobWVzc2FnZSkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgaXNDYW5jZWxlZCgpOgogICAgICAgIHJldHVybiBGYWxzZQoKCgoKdHJ5OgogICAgZnJvbSBjb2xvcml6ZV9yZ2IgaW1wb3J0IGFwcGx5TGVnZW5kQ3N2LCBhcHBseUxlZ2VuZCwgcmVhZExlZ2VuZCwgcHJlcGFyZUxlZ2VuZApleGNlcHQ6CiAgICBwYXNzICNOb3QgaW4gRGluYW1pY2EgQ29kZQoKIyB0cnk6CiMgICAgIGRpbmFtaWNhLnBhY2thZ2UoIlB5UE5HIiwgTm9uZSwgInBuZyIpCiMgZXhjZXB0OgojICAgICBwYXNzCiMKIyBpbXBvcnQgcG5nCiMKIyBzID0gWycxMTAwMTAwMTAwMTEnLAojICAgICAgJzEwMTAxMTAxMDEwMCcsCiMgICAgICAnMTEwMDEwMTEwMTAxJywKIyAgICAgICcxMDAwMTAwMTAwMTEnXQojIHMgPSBbW2ludChjKSBmb3IgYyBpbiByb3ddIGZvciByb3cgaW4gc10KIwojIHBhbGV0dGU9WygweDU1LDB4NTUsMHg1NSksICgweGZmLDB4OTksMHg5OSldCiMgdyA9IHBuZy5Xcml0ZXIobGVuKHNbMF0pLCBsZW4ocyksIHBhbGV0dGU9cGFsZXR0ZSwgYml0ZGVwdGg9MSkKIyBmID0gb3BlbigncG5nLnBuZycsICd3YicpCiMgdy53cml0ZShmLCBzKQoKCmZyb20gUElMIGltcG9ydCBJbWFnZQppbXBvcnQgY3N2CgoKCmNsYXNzIExlZ2VuZEVudHJ5OgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNhdGVnb3J5LCBmcm9tVmFsdWUsIHRvVmFsdWUsIGNhdGVnb3J5TmFtZSwgcmVkLCBncmVlbiwgYmx1ZSk6CiAgICAgICAgc2VsZi5jYXRlZ29yeSA9IGludChjYXRlZ29yeSkKICAgICAgICBzZWxmLmZyb21WYWx1ZSA9IGZsb2F0KGZyb21WYWx1ZSkKICAgICAgICBzZWxmLnRvVmFsdWUgPSBmbG9hdCh0b1ZhbHVlKQogICAgICAgIHNlbGYuY2F0ZWdvcnlOYW1lID0gY2F0ZWdvcnlOYW1lCiAgICAgICAgc2VsZi5yZWQgPSBpbnQocmVkKQogICAgICAgIHNlbGYuZ3JlZW4gPSBpbnQoZ3JlZW4pCiAgICAgICAgc2VsZi5ibHVlID0gaW50KGJsdWUpCgogICAgZGVmIGdldFJHQkEoc2VsZik6CiAgICAgICAgcmV0dXJuIChzZWxmLnJlZCwgc2VsZi5ncmVlbiwgc2VsZi5ibHVlLCAyNTUpCgpkZWYgYXBwbHlMZWdlbmQocG5nUGF0aCwgbGVnZW5kT2JqKToKICAgIHdpdGggSW1hZ2Uub3BlbihwbmdQYXRoKSBhcyBpbToKICAgICAgICBpbS5jb252ZXJ0KCdSR0JBJykKICAgICAgICBiYWNrZ3JvdW5kID0gSW1hZ2UubmV3KCJSR0JBIiwgKDI1NiwgMjU2KSwgKDAsIDAsIDAsIDI1NSkpCiAgICAgICAgcGl4ZGF0YSA9IGltLmxvYWQoKQogICAgICAgIHRvRGF0YSA9IGJhY2tncm91bmQubG9hZCgpCgogICAgICAgIHdpZHRoID0gMjU2CiAgICAgICAgaGVpZ2h0ID0gMjU2CiAgICAgICAgZm9yIHkgaW4gcmFuZ2UoaGVpZ2h0KToKICAgICAgICAgICAgZm9yIHggaW4gcmFuZ2Uod2lkdGgpOgogICAgICAgICAgICAgICAgY3VyVmFsdWUgPSBwaXhkYXRhW3gsIHldWzBdICMrIHBpeGRhdGFbeCwgeV1bMV0KICAgICAgICAgICAgICAgIGlmIHBpeGRhdGFbeCwgeV0gPT0gKDAsIDApOgogICAgICAgICAgICAgICAgICAgIHRvRGF0YVt4LCB5XSA9ICgwLCAwLCAwLCAwKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICB0b0RhdGFbeCwgeV0gPSBnZXRMZWdlbmRGb3JWYWx1ZShjdXJWYWx1ZSwgbGVnZW5kT2JqKS5nZXRSR0JBKCkKICAgICAgICBiYWNrZ3JvdW5kLnNhdmUocG5nUGF0aCwgIlBORyIpCgpkZWYgcmVhZExlZ2VuZChjc3ZQYXRoKToKICAgIHJldHVybiBwcmVwYXJlTGVnZW5kKFthIGZvciBhIGluIGNzdi5yZWFkZXIob3Blbihjc3ZQYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpLCBlc2NhcGVjaGFyPSdcXCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNraXBpbml0aWFsc3BhY2U9RmFsc2UsIGRlbGltaXRlcj0nLCcsIHF1b3Rpbmc9Y3N2LlFVT1RFX05PTkUpXSkKCmRlZiBhcHBseUxlZ2VuZENzdihwbmdQYXRoLCBsZWdlbmRQYXRoKToKICAgIHJldHVybiBhcHBseUxlZ2VuZChwbmdQYXRoLCByZWFkTGVnZW5kKGxlZ2VuZFBhdGgpKQoKZGVmIHByZXBhcmVMZWdlbmQoY3N2TGVnZW5kKToKICAgIHJlc3VsdCA9IFtdCiAgICBpID0gMAogICAgaGVhZFRtcCA9IGNzdkxlZ2VuZC5wb3AoMCkKICAgIGlmIG5vdCAobGVuKGhlYWRUbXApID49IDcgYW5kICdjYXRlZ29yeScgaW4gaGVhZFRtcFswXS5sb3dlcigpIGFuZCAnZnJvbScgaW4gaGVhZFRtcFsxXS5sb3dlcigpIGFuZCAndG8nIGluIGhlYWRUbXBbMl0ubG93ZXIoKQogICAgICAgICAgICBhbmQgJ2NhdGVnb3J5X25hbWUnIGluIGhlYWRUbXBbM10ubG93ZXIoKSBhbmQgJ3JlZCcgaW4gaGVhZFRtcFs0XS5sb3dlcigpIGFuZCAnZ3JlZW4nIGluIGhlYWRUbXBbNV0ubG93ZXIoKQogICAgICAgICAgICBhbmQgJ2JsdWUnIGluIGhlYWRUbXBbNl0ubG93ZXIoKSk6CiAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJUaGUgQ1NWIFN0eWxlIGlzIGludmFsaWQgcGxlYXNlIGNvbmZpcm0gdGhlIEZpZWxkczogJ0NhdGVnb3J5KicsICcgRnJvbScsICcgVG8nLCAnIENhdGVnb3J5X05hbWUnLCAnIHJlZCcsICcgZ3JlZW4nLCAnIGJsdWUnIikKICAgIGZvciBlbG0gaW4gY3N2TGVnZW5kOgogICAgICAgIHJlc3VsdC5hcHBlbmQoTGVnZW5kRW50cnkoZWxtWzBdLCBlbG1bMV0sIGVsbVsyXSwgZWxtWzNdLCBlbG1bNF0sIGVsbVs1XSwgZWxtWzZdKSkKICAgIHJldHVybiByZXN1bHQKCiNDYXRlZ29yeSosIEZyb20sIFRvLCBDYXRlZ29yeV9OYW1lLCByZWQsIGdyZWVuLCBibHVlLApkZWYgZ2V0TGVnZW5kRm9yVmFsdWUodmFsdWUsIGxlZ2VuZCk6CiAgICByZXR1cm4gW2wgZm9yIGwgaW4gbGVnZW5kIGlmIGwuY2F0ZWdvcnkgPT0gdmFsdWVdWzBdCgojICMgIyAjIGRpYWxlY3QgPSBjc3YuRGlhbGVjdCgpCiMgIyAjICMgZGlhbGVjdC5za2lwaW5pdGlhbHNwYWNlID0gVHJ1ZQojICMgIyAjIGRpYWxlY3QuZGVsaW1pdGVyID0gJywnCiMgIyAjICMgZGlhbGVjdC5xdW90aW5nID0gJyInCiMgIyAjICMgZGlhbGVjdC5lc2NhcGVjaGFyID0gJ1xcJwojICMgYXBwbHlMZWdlbmQocG5nUGF0aCwgcHJlcGFyZUxlZ2VuZChjc3YuRGljdFJlYWRlcihvcGVuKCdJOlxcRGFuaWxvXFxUcmFtcG9cXGRhdGFfZGlyXFxkYXRhXFxsYXVyZWxcXGxhbmRfdXNlXzE5OTJfMjAxNVxcbGFuZF91c2VfMTk5Ml8yMDE1Xzcuc2xkJywgInIiLCBlbmNvZGluZz0idXRmLTgiKSwgZXNjYXBlY2hhcj0nXFwnLCBza2lwaW5pdGlhbHNwYWNlPUZhbHNlLCBkZWxpbWl0ZXI9JywnLCBxdW90aW5nPWNzdi5RVU9URV9OT05FKSkpCiMgc2xkUGF0aCA9ICdJOlxcRGFuaWxvXFxUcmFtcG9cXGRhdGFfZGlyXFxkYXRhXFxsYXVyZWxcXGxhbmRfdXNlXzE5OTJfMjAxNVxcbGFuZF91c2VfMTk5Ml8yMDE1Xzcuc2xkJwojIHBuZ1BhdGggPSAiQzpcXFVzZXJzXFxEYW5pbG9cXEFwcERhdGFcXExvY2FsXFxUZW1wXFxvdXRwdXREaXJcXGl5aWVsZF9ydWJiZXIyXFwxXFxyZ2JhXFw0XFwwMDA1XzAwMDcucG5nIgojIGFwcGx5TGVnZW5kQ3N2KHBuZ1BhdGgsIHNsZFBhdGgpCgoKdHJ5OgogICAgZnJvbSBVVElMUyBpbXBvcnQgVVRJTFMKZXhjZXB0OgogICAgcGFzcyAjTm90IGluIERpbmFtaWNhIENvZGUKCmltcG9ydCByZQppbXBvcnQgdGltZQppbXBvcnQgbWF0aAppbXBvcnQgb3MKaW1wb3J0IHVuaWNvZGVkYXRhCmltcG9ydCB0ZW1wZmlsZQpmcm9tIGh0dHAgaW1wb3J0IEhUVFBTdGF0dXMKZnJvbSB1cmxsaWIucGFyc2UgaW1wb3J0IHVybGVuY29kZQppbXBvcnQgcmVxdWVzdHMKZnJvbSB4bWwuc2F4LnNheHV0aWxzIGltcG9ydCBlc2NhcGUKZnJvbSB6aXBmaWxlIGltcG9ydCBaaXBGaWxlCgppc0RpbmFtaWNhID0gRmFsc2UKdHJ5OgogICAgZGluYW1pY2EucGFja2FnZSgib3MiKQogICAgaXNEaW5hbWljYSA9IFRydWUKZXhjZXB0OgogICAgaXNEaW5hbWljYSA9IEZhbHNlCgp0cnk6CiAgICBmcm9tIFFNZXNzYWdlQm94IGltcG9ydCBRTWVzc2FnZUJveApleGNlcHQ6CiAgICBwYXNzICNOb3QgaW4gRGluYW1pY2EgQ29kZQoKdHJ5OgogICAgZnJvbSBxZ2lzLlB5UXQuUXRXaWRnZXRzIGltcG9ydCBRTWVzc2FnZUJveAogICAgZnJvbSBxZ2lzLlB5UXQuUXRDb3JlIGltcG9ydCBRVGltZXIKICAgIGZyb20gcWdpcy5jb3JlIGltcG9ydCAoUWdzUHJvamVjdCwgUWdzQ29vcmRpbmF0ZVRyYW5zZm9ybSwgUWdzTWVzc2FnZUxvZywgUWdzVmVjdG9yTGF5ZXIsIFFnc1Jhc3RlckxheWVyKQpleGNlcHQ6CiAgICBwYXNzICNOb3QgaW4gUUdJUwoKaW1wb3J0IHJhbmRvbQppbXBvcnQgc3RyaW5nCgpjbGFzcyBVVElMUzoKCiAgICAjRGFuaWxvIG8gemlwIHByZWNpc2EgZGVsZXRhciBkcHMKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiB6aXBGaWxlcyhkaXIsIHBhdHRlcm4pOgogICAgICAgIGN1clRtcEZpbGUgPSB0ZW1wZmlsZS5OYW1lZFRlbXBvcmFyeUZpbGUoc3VmZml4PScuemlwJywgZGVsZXRlPUZhbHNlKQogICAgICAgIGNvbXBQYXR0ZXJuID0gcmUuY29tcGlsZShwYXR0ZXJuKQogICAgICAgICMgY3JlYXRlIGEgWmlwRmlsZSBvYmplY3QKICAgICAgICB3aXRoIFppcEZpbGUoY3VyVG1wRmlsZSwgJ3cnKSBhcyB6aXBPYmo6CiAgICAgICAgICAgICMgSXRlcmF0ZSBvdmVyIGFsbCB0aGUgZmlsZXMgaW4gZGlyZWN0b3J5CiAgICAgICAgICAgIGZvciBmb2xkZXJOYW1lLCBzdWJmb2xkZXJzLCBmaWxlbmFtZXMgaW4gb3Mud2FsayhkaXIpOgogICAgICAgICAgICAgICAgZm9yIGZpbGVuYW1lIGluIGZpbGVuYW1lczoKICAgICAgICAgICAgICAgICAgICBpZiBub3QgY29tcFBhdHRlcm4ubWF0Y2goZmlsZW5hbWUpOgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgICMgY3JlYXRlIGNvbXBsZXRlIGZpbGVwYXRoIG9mIGZpbGUgaW4gZGlyZWN0b3J5CiAgICAgICAgICAgICAgICAgICAgZmlsZVBhdGggPSBvcy5wYXRoLmpvaW4oZm9sZGVyTmFtZSwgZmlsZW5hbWUpCiAgICAgICAgICAgICAgICAgICAgIyBBZGQgZmlsZSB0byB6aXAKICAgICAgICAgICAgICAgICAgICB6aXBPYmoud3JpdGUoZmlsZVBhdGgsIG9zLnBhdGguYmFzZW5hbWUoZmlsZVBhdGgpKQogICAgICAgICAgICByZXR1cm4gY3VyVG1wRmlsZQogICAgICAgIHJldHVybiBOb25lCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldEZpbGVTaXplKGRpciwgcGF0dGVybik6CiAgICAgICAgdG90YWwgPSAwCiAgICAgICAgY29tcFBhdHRlcm4gPSByZS5jb21waWxlKHBhdHRlcm4pCiAgICAgICAgZm9yIGZvbGRlck5hbWUsIHN1YmZvbGRlcnMsIGZpbGVuYW1lcyBpbiBvcy53YWxrKGRpcik6CiAgICAgICAgICAgIGZvciBmaWxlbmFtZSBpbiBmaWxlbmFtZXM6CiAgICAgICAgICAgICAgICBpZiBub3QgY29tcFBhdHRlcm4ubWF0Y2goZmlsZW5hbWUpOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBmaWxlUGF0aCA9IG9zLnBhdGguam9pbihmb2xkZXJOYW1lLCBmaWxlbmFtZSkKICAgICAgICAgICAgICAgIGlmIG9zLnBhdGguaXNmaWxlKGZpbGVQYXRoKToKICAgICAgICAgICAgICAgICAgICB0b3RhbCA9IHRvdGFsICsgb3MucGF0aC5nZXRzaXplKGZpbGVQYXRoKQogICAgICAgIHJldHVybiB0b3RhbAoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBjaGVja0ZvckNhbmNlbGVkKGZlZWRiYWNrLCBtc2c9J0NhbmNlbGxpbmcnKToKICAgICAgICBpZiBmZWVkYmFjay5pc0NhbmNlbGVkKCk6CiAgICAgICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbyhtc2cpCiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiVXNlciBjYW5jZWxlZCB0aGUgcGx1Z2luIGV4ZWN1dGlvbi4iKQoKICAgICNEYW5pbG8gLy9EYW5pbG8gcmV0dXJuIGEgIFRlbXBvcmFyeUZpbGUgd2hlbiB3b3JrcwogICAgI0RhbmlsbyBvIHppcCBwcmVjaXNhIGRlbGV0YXIKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZW5lcmF0ZVppcExheWVyKGxheWVyKToKICAgICAgICBwcmludCgiR2VuZXJhdGluZyB6aXAgZm9yICIgKyBsYXllci5uYW1lKCkgKyAiIGxheWVyLiIpCiAgICAgICAgc291cmNlVXJpID0gbGF5ZXIuZGF0YVByb3ZpZGVyKCkuZGF0YVNvdXJjZVVyaSgpCiAgICAgICAgYWJzb2x1dGVQYXRoID0gTm9uZQogICAgICAgIGlmIGlzaW5zdGFuY2UobGF5ZXIsIFFnc1Jhc3RlckxheWVyKToKICAgICAgICAgICAgaWYgJy50aWZmJyBpbiBzb3VyY2VVcmk6CiAgICAgICAgICAgICAgICBhYnNvbHV0ZVBhdGggPSBzb3VyY2VVcmlbOihzb3VyY2VVcmkuaW5kZXgoIi50aWZmIikgKyA1KV0KICAgICAgICAgICAgZWxpZiAnLnRpZicgaW4gc291cmNlVXJpOgogICAgICAgICAgICAgICAgYWJzb2x1dGVQYXRoID0gc291cmNlVXJpWzooc291cmNlVXJpLmluZGV4KCIudGlmIikgKyA0KV0KICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHByaW50KCJPbmx5IHRpZmYgYW5kIHRpZiBpcyBhbGxvd2FibGUgdG8gZG93bmxvYWQuIikKICAgICAgICBlbGlmIGlzaW5zdGFuY2UobGF5ZXIsIFFnc1ZlY3RvckxheWVyKToKICAgICAgICAgICAgaWYgJy5zaHAnIGluIHNvdXJjZVVyaToKICAgICAgICAgICAgICAgIGFic29sdXRlUGF0aCA9IHNvdXJjZVVyaVs6KHNvdXJjZVVyaS5pbmRleCgiLnNocCIpICsgNCldCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwcmludCgiT25seSBzaHAgZmlsZSBpcyBhbGxvd2FibGUgdG8gZG93bmxvYWQuIikKICAgICAgICBpZiBhYnNvbHV0ZVBhdGggaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGZpbGVOYW1lID0gb3MucGF0aC5iYXNlbmFtZShhYnNvbHV0ZVBhdGgpCiAgICAgICAgICAgIGZpbGVOYW1lV2l0aG91dEV4dCA9IG9zLnBhdGguc3BsaXRleHQoZmlsZU5hbWUpWzBdCiAgICAgICAgICAgIGRpck5hbWUgPSBvcy5wYXRoLmRpcm5hbWUoYWJzb2x1dGVQYXRoKQogICAgICAgICAgICB6aXBGaWxlID0gVVRJTFMuemlwRmlsZXMoZGlyTmFtZSArIG9zLnBhdGguc2VwLCBmaWxlTmFtZVdpdGhvdXRFeHQgKyAiKiIpCiAgICAgICAgICAgIHppcEZpbGUuY2xvc2UoKQogICAgICAgICAgICBpZiBvcy5wYXRoLmdldHNpemUoemlwRmlsZS5uYW1lKSA+IDJlOToKICAgICAgICAgICAgICAgIHByaW50KCJUaGUgbWFwIGZpbGVzaXplIGlzIGdyZWF0ZXIgdGhhbiB0aGUgR2l0SHViIDJHYiBsaW1pdC4gKGFsbCBmaWxlcyBpbiB0aGlzIGZvbGRlciBzdGFydGluZyB3aXRoICIgKyBmaWxlTmFtZVdpdGhvdXRFeHQgKyAiIHdlcmUgaW5jbHVkZWQuIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJldHVybiB6aXBGaWxlCiAgICAgICAgcmV0dXJuIE5vbmUKCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHJ1bkxvbmdUYXNrKGZ1bmN0aW9uLCBmZWVkYmFjaywgd2FpdE1lc3NhZ2U9IlBsZWFzZSBXYWl0Iiwgc2Vjb25kc1JlcG9ydD02MCwgKmFyZ3MsICoqa3dBcmdzKToKICAgICAgICBmcm9tIGNvbmN1cnJlbnQgaW1wb3J0IGZ1dHVyZXMKICAgICAgICAjIGZlZWRiYWNrLnNldFByb2dyZXNzKDEpCiAgICAgICAgc3RlcFRpbWVyID0gMC41CiAgICAgICAgdG90YWxUaW1lID0gMAogICAgICAgIHdpdGggZnV0dXJlcy5UaHJlYWRQb29sRXhlY3V0b3IobWF4X3dvcmtlcnM9MSkgYXMgZXhlY3V0b3I6CiAgICAgICAgICAgIGpvYiA9IGV4ZWN1dG9yLnN1Ym1pdChmdW5jdGlvbiwgKmFyZ3MsICoqa3dBcmdzKQogICAgICAgICAgICBlbGFwc2VkVGltZSA9IDAKICAgICAgICAgICAgd2hpbGUgam9iLmRvbmUoKSA9PSBGYWxzZToKICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoc3RlcFRpbWVyKQogICAgICAgICAgICAgICAgZWxhcHNlZFRpbWUgPSBlbGFwc2VkVGltZSArIHN0ZXBUaW1lcgogICAgICAgICAgICAgICAgdG90YWxUaW1lID0gdG90YWxUaW1lICsgc3RlcFRpbWVyCiAgICAgICAgICAgICAgICBpZiBlbGFwc2VkVGltZSA+IHNlY29uZHNSZXBvcnQ6CiAgICAgICAgICAgICAgICAgICAgY2FuY2VsTXNnID0gIlxuQ2FuY2VsbGluZywgcGxlYXNlIHdhaXQgdGhlIGN1cnJlbnQgc3RlcCB0byBmaW5pc2ggZ3JhY2VmdWxseS4iIGlmIGZlZWRiYWNrLmlzQ2FuY2VsZWQoKSBlbHNlICcnCiAgICAgICAgICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJFbGFwc2VkICIgKyBzdHIocm91bmQodG90YWxUaW1lKSkgKyAiczogIiArIHdhaXRNZXNzYWdlICsgY2FuY2VsTXNnKQogICAgICAgICAgICAgICAgICAgIGVsYXBzZWRUaW1lID0gMAogICAgICAgICAgICAgICAgIyBpZiBjYW5DYW5jZWxOb3cgYW5kIGZlZWRiYWNrLmlzQ2FuY2VsZWQoKToKICAgICAgICAgICAgICAgICMgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiSm9iIHN0YXJ0aW5nIHRvIGNhbmNlbC4iKQogICAgICAgICAgICAgICAgIyAgICAgam9iLmNhbmNlbCgpCiAgICAgICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiRWxhcHNlZCAiICsgc3RyKHJvdW5kKHRvdGFsVGltZSkpICsgInMgb24gdGhpcyBzdGVwLiIpCiAgICAgICAgICAgICMgVVRJTFMuY2hlY2tGb3JDYW5jZWxlZChmZWVkYmFjaykKICAgICAgICAgICAgcmV0dXJuIGpvYi5yZXN1bHQoKQoKICAgICIiIgogICAgVXNlIHNhZmVyIG5hbWVzLgogICAgIiIiCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgbm9ybWFsaXplTmFtZShuYW1lLCBpc0ZpbGVuYW1lPVRydWUsIGVzY2FwZVhtbD1UcnVlLCByZW1vdmVBY2NlbnRzPVRydWUpOgogICAgICAgIG5vcm1hbGl6ZWQgPSBuYW1lCiAgICAgICAgaWYgZXNjYXBlWG1sOgogICAgICAgICAgICBub3JtYWxpemVkID0gVVRJTFMuZXNjYXBlWG1sKG5vcm1hbGl6ZWQpCiAgICAgICAgaWYgcmVtb3ZlQWNjZW50czoKICAgICAgICAgICAgbm9ybWFsaXplZCA9IFVUSUxTLnN0cmlwX2FjY2VudHMobm9ybWFsaXplZCkKICAgICAgICBpZiBpc0ZpbGVuYW1lOgogICAgICAgICAgICBub3JtYWxpemVkID0gVVRJTFMuZXNjYXBlRmlsZW5hbWUobm9ybWFsaXplZCkKICAgICAgICByZXR1cm4gbm9ybWFsaXplZC5sb3dlcigpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGVzY2FwZUZpbGVuYW1lKGNvbnRlbnQpOgogICAgICAgIHJldHVybiByZS5zdWIociJcVyIsICJfIiwgY29udGVudCkKCiAgICAjaHR0cHM6Ly9weW5hdGl2ZS5jb20vcHl0aG9uLWdlbmVyYXRlLXJhbmRvbS1zdHJpbmcvCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgcmFuZG9tU3RyaW5nKHN0cmluZ0xlbmd0aD0yNyk6CiAgICAgICAgIiIiR2VuZXJhdGUgYSByYW5kb20gc3RyaW5nIG9mIGZpeGVkIGxlbmd0aCAiIiIKICAgICAgICBsZXR0ZXJzID0gc3RyaW5nLmFzY2lpX2xvd2VyY2FzZQogICAgICAgIHJldHVybiAnJy5qb2luKHJhbmRvbS5jaG9pY2UobGV0dGVycykgZm9yIGkgaW4gcmFuZ2Uoc3RyaW5nTGVuZ3RoKSkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgc2VuZFJlcG9ydChkaWN0UGFyYW0pOgogICAgICAgIHJlcSA9IHJlcXVlc3RzLmdldCh1cmw9J2h0dHA6Ly9jc3IudWZtZy5ici9pbWFnZXJ5L3NhdmVfcmVwb3J0cy5waHA/JyArIHVybGVuY29kZShkaWN0UGFyYW0pKQogICAgICAgIGlmIHJlcS5zdGF0dXNfY29kZSA9PSBIVFRQU3RhdHVzLk9LOgogICAgICAgICAgICByZXR1cm4gcmVxLnRleHQKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gJycKCiAgICAjUmV0dXJuIHRoZSBtYXAgZXh0ZW50cyBpbiB0aGUgZ2l2ZW4gcHJvamVjdGlvbgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldE1hcEV4dGVudChsYXllciwgcHJvamVjdGlvbik6CiAgICAgICAgbWFwRXh0ZW50ID0gbGF5ZXIuZXh0ZW50KCkKICAgICAgICBwcm9qZWN0aW9uLnZhbGlkYXRlKCkKICAgICAgICBsYXllci5jcnMoKS52YWxpZGF0ZSgpCiAgICAgICAgc3JjX3RvX3Byb2ogPSBRZ3NDb29yZGluYXRlVHJhbnNmb3JtKGxheWVyLmNycygpLCBwcm9qZWN0aW9uLCBRZ3NQcm9qZWN0Lmluc3RhbmNlKCkudHJhbnNmb3JtQ29udGV4dCgpIGlmIGdldGF0dHIobGF5ZXIsICJ0cmFuc2Zvcm1Db250ZXh0IiwgTm9uZSkgaXMgTm9uZSBlbHNlIGxheWVyLnRyYW5zZm9ybUNvbnRleHQoKSkKICAgICAgICByZXR1cm4gc3JjX3RvX3Byb2oudHJhbnNmb3JtQm91bmRpbmdCb3gobWFwRXh0ZW50KQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBlc2NhcGVYbWwoY29udGVudCk6CiAgICAgICAgcmV0dXJuIGVzY2FwZShjb250ZW50KQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBzdHJpcF9hY2NlbnRzKHMpOgogICAgICAgcmV0dXJuICcnLmpvaW4oYyBmb3IgYyBpbiB1bmljb2RlZGF0YS5ub3JtYWxpemUoJ05GRCcsIHMpCiAgICAgICAgICAgICAgICAgICAgICBpZiB1bmljb2RlZGF0YS5jYXRlZ29yeShjKSAhPSAnTW4nKQoKICAgICMgVE1TIGZ1bmN0aW9ucyB0YWtlbiBmcm9tIGh0dHBzOi8vYWxhc3RhaXJhLndvcmRwcmVzcy5jb20vMjAxMS8wNy8wNi9jb252ZXJ0aW5nLXRtcy10aWxlLWNvb3JkaW5hdGVzLXRvLWdvb2dsZWJpbmdvc20tdGlsZS1jb29yZGluYXRlcy8gI3NwZWxsb2sKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiB0bXMoeXRpbGUsIHpvb20pOgogICAgICAgIG4gPSAyLjAgKiogem9vbQogICAgICAgIHl0aWxlID0gbiAtIHl0aWxlIC0gMQogICAgICAgIHJldHVybiBpbnQoeXRpbGUpCgogICAgIyBNYXRoIGZ1bmN0aW9ucyB0YWtlbiBmcm9tIGh0dHBzOi8vd2lraS5vcGVuc3RyZWV0bWFwLm9yZy93aWtpL1NsaXBweV9tYXBfdGlsZW5hbWVzICNzcGVsbG9rCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZGVnMm51bShsYXRfZGVnLCBsb25fZGVnLCB6b29tKToKICAgICAgICBRZ3NNZXNzYWdlTG9nLmxvZ01lc3NhZ2UoIiBlICIuam9pbihbc3RyKGxhdF9kZWcpLCBzdHIobG9uX2RlZyksIHN0cih6b29tKV0pLCB0YWc9IlByb2Nlc3NpbmciKQogICAgICAgIGxhdF9yYWQgPSBtYXRoLnJhZGlhbnMobGF0X2RlZykKICAgICAgICBuID0gMi4wICoqIHpvb20KICAgICAgICB4dGlsZSA9IGludCgobG9uX2RlZyArIDE4MC4wKSAvIDM2MC4wICogbikKICAgICAgICB5dGlsZSA9IGludCgoMS4wIC0gbWF0aC5hc2luaChtYXRoLnRhbihsYXRfcmFkKSkgLyBtYXRoLnBpKSAvIDIuMCAqIG4pCiAgICAgICAgcmV0dXJuICh4dGlsZSwgeXRpbGUpCgogICAgIyBNYXRoIGZ1bmN0aW9ucyB0YWtlbiBmcm9tIGh0dHBzOi8vd2lraS5vcGVuc3RyZWV0bWFwLm9yZy93aWtpL1NsaXBweV9tYXBfdGlsZW5hbWVzICNzcGVsbG9rCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgbnVtMmRlZyh4dGlsZSwgeXRpbGUsIHpvb20pOgogICAgICAgIG4gPSAyLjAgKiogem9vbQogICAgICAgIGxvbl9kZWcgPSB4dGlsZSAvIG4gKiAzNjAuMCAtIDE4MC4wCiAgICAgICAgbGF0X3JhZCA9IG1hdGguYXRhbihtYXRoLnNpbmgobWF0aC5waSAqICgxIC0gMiAqIHl0aWxlIC8gbikpKQogICAgICAgIGxhdF9kZWcgPSBtYXRoLmRlZ3JlZXMobGF0X3JhZCkKICAgICAgICByZXR1cm4gKGxhdF9kZWcsIGxvbl9kZWcpCgogICAgIyBUaGlzIGZ1bmN0aW9uIGdldHMgYSBzeXN0ZW0gdmFyaWFibGUKICAgICMgaXQgd2FzIG5lY2Vzc2FyeSB0byB1c2UgdGhpcyBpbnN0ZWFkIG9mIG9zLmVudmlyb25bIlBBVEgiXSBiZWNhdXNlIFFHSVMgb3ZlcndyaXRlcyB0aGUgcGF0aCB2YXJpYWJsZQogICAgIyB0aGUgd2luMzIgbGlicmFyaWVzIGFwcGVhciBub3QgdG8gYmUgcGFydCBvZiB0aGUgc3RhbmRhcmQgcHl0aG9uIGluc3RhbGwsIGJ1dCB0aGV5IGFyZSBpbmNsdWRlZCBpbiB0aGUKICAgICMgcHl0aG9uIHZlcnNpb24gdGhhdCBjb21lcyB3aXRoIFFHSVMKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRlbnZfc3lzdGVtKHZhcm5hbWUsIGRlZmF1bHQ9JycpOgogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IG9zCiAgICAgICAgICAgIGltcG9ydCB3aW4zMmFwaQogICAgICAgICAgICBpbXBvcnQgd2luMzJjb24KICAgICAgICAgICAgdiA9IGRlZmF1bHQKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmtleSA9IHdpbjMyYXBpLlJlZ09wZW5LZXkod2luMzJjb24uSEtFWV9MT0NBTF9NQUNISU5FLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1NZU1RFTVxcQ3VycmVudENvbnRyb2xTZXRcXENvbnRyb2xcXFNlc3Npb24gTWFuYWdlclxcRW52aXJvbm1lbnQnKQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHYgPSBzdHIod2luMzJhcGkuUmVnUXVlcnlWYWx1ZUV4KHJrZXksIHZhcm5hbWUpWzBdKQogICAgICAgICAgICAgICAgICAgIHYgPSB3aW4zMmFwaS5FeHBhbmRFbnZpcm9ubWVudFN0cmluZ3ModikKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICAgICB3aW4zMmFwaS5SZWdDbG9zZUtleShya2V5KQogICAgICAgICAgICByZXR1cm4gdgogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcmV0dXJuICcnCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGlzX2V4ZShmcGF0aCk6CiAgICAgICAgcmV0dXJuIG9zLnBhdGguaXNmaWxlKGZwYXRoKSBhbmQgb3MuYWNjZXNzKGZwYXRoLCBvcy5YX09LKQoKICAgICMgaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzc3MDE3L3Rlc3QtaWYtZXhlY3V0YWJsZS1leGlzdHMtaW4tcHl0aG9uLzEyNjExNTIzCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgd2hpY2gocHJvZ3JhbSk6CiAgICAgICAgZnBhdGgsIGZuYW1lID0gb3MucGF0aC5zcGxpdChwcm9ncmFtKQogICAgICAgIGlmIGZwYXRoOgogICAgICAgICAgICBpZiBVVElMUy5pc19leGUocHJvZ3JhbSk6CiAgICAgICAgICAgICAgICByZXR1cm4gcHJvZ3JhbQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGZvciBwYXRoIGluIG9zLmVudmlyb25bIlBBVEgiXS5zcGxpdChvcy5wYXRoc2VwKToKICAgICAgICAgICAgICAgIGV4ZV9maWxlID0gb3MucGF0aC5qb2luKHBhdGgsIHByb2dyYW0pCiAgICAgICAgICAgICAgICBpZiBVVElMUy5pc19leGUoZXhlX2ZpbGUpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBleGVfZmlsZQogICAgICAgICAgICBmb3IgcGF0aCBpbiBVVElMUy5nZXRlbnZfc3lzdGVtKCJQQVRIIikuc3BsaXQob3MucGF0aHNlcCk6CiAgICAgICAgICAgICAgICBleGVfZmlsZSA9IG9zLnBhdGguam9pbihwYXRoLCBwcm9ncmFtKQogICAgICAgICAgICAgICAgaWYgVVRJTFMuaXNfZXhlKGV4ZV9maWxlKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhlX2ZpbGUKCiAgICAgICAgcmV0dXJuIE5vbmUKCmNsYXNzIFVzZXJJbnRlcnJ1cHRlZChFeGNlcHRpb24pOgogICAgcGFzcwoKIyBjbGFzcyBUaW1lZE1lc3NhZ2VCb3goUU1lc3NhZ2VCb3gpOgojICAgICBkZWYgX19pbml0X18oc2VsZiwgdGltZW91dCwgbWVzc2FnZSwgY2FsbGJhY2spOgojICAgICAgICAgc3VwZXIoVGltZWRNZXNzYWdlQm94LCBzZWxmKS5fX2luaXRfXygpCiMgICAgICAgICBzZWxmLnRpbWVvdXQgPSB0aW1lb3V0CiMgICAgICAgICBzZWxmLmNhbGxiYWNrID0gY2FsbGJhY2sKIwojICAgICBkZWYgaW50ZXJ2YWxDYWxsYmFjayhzZWxmKToKIyAgICAgICAgIHNlbGYuY2FsbGJhY2soKQojICAgICAgICAgUVRpbWVyKCkuc2luZ2xlU2hvdChzZWxmLnRpbWVvdXQqMTAwMCwgc2VsZi5pbnRlcnZhbENhbGxiYWNrKQojCiMgICAgIGRlZiBzaG93RXZlbnQoc2VsZiwgZXZlbnQpOgojICAgICAgICAgUVRpbWVyKCkuc2luZ2xlU2hvdChzZWxmLnRpbWVvdXQqMTAwMCwgc2VsZi5pbnRlcnZhbENhbGxiYWNrKQojICAgICAgICAgc3VwZXIoVGltZWRNZXNzYWdlQm94LCBzZWxmKS5zaG93RXZlbnQoZXZlbnQpCgoKdHJ5OgogICAgZnJvbSBHaXRIdWIgaW1wb3J0IEdpdEh1YgpleGNlcHQ6CiAgICBwYXNzICNOb3QgaW4gRGluYW1pY2EgQ29kZQoKaW1wb3J0IHJlCmltcG9ydCBvcwppbXBvcnQgcmFuZG9tCmltcG9ydCB3ZWJicm93c2VyCmltcG9ydCByZXF1ZXN0cwppbXBvcnQgdGltZQppbXBvcnQganNvbgppbXBvcnQgZ2xvYgppbXBvcnQgdGVtcGZpbGUKaW1wb3J0IHBsYXRmb3JtCmltcG9ydCBzdWJwcm9jZXNzCmZyb20gaHR0cCBpbXBvcnQgSFRUUFN0YXR1cwpmcm9tIHJlcXVlc3RzIGltcG9ydCByZXF1ZXN0CmZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lCmZyb20gdGltZSBpbXBvcnQgc2xlZXAKCgoKaXNEaW5hbWljYSA9IEZhbHNlCnRyeToKICAgIGRpbmFtaWNhLnBhY2thZ2UoIm9zIikKICAgIGlzRGluYW1pY2EgPSBUcnVlCmV4Y2VwdDoKICAgIGlzRGluYW1pY2EgPSBGYWxzZQoKdHJ5OgogICAgZnJvbSBVVElMUyBpbXBvcnQgVVRJTFMKICAgIGZyb20gUU1lc3NhZ2VCb3ggaW1wb3J0IFFNZXNzYWdlQm94CmV4Y2VwdDoKICAgIHBhc3MgI05vdCBpbiBEaW5hbWljYSBDb2RlCgp0cnk6CiAgICBmcm9tIHFnaXMuUHlRdC5RdFdpZGdldHMgaW1wb3J0IFFNZXNzYWdlQm94CmV4Y2VwdDoKICAgIHBhc3MgI05vdCBpbiBRR0lTCgpjbGFzcyBHaXRIdWI6CgogICAgb3JpZ2luTmFtZSA9ICJtYXBwaWEiCiAgICByZWxlYXNlTmFtZSA9ICJNYXBfRG93bmxvYWQiCiAgICBnaXRodWJBcGkgPSAnaHR0cHM6Ly9hcGkuZ2l0aHViLmNvbS8nCgogICAgcGVyc29uYWxfdG9rZW4gPSAnJwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiB0ZXN0TG9naW4odXNlciwgdG9rZW4pOgogICAgICAgIHJldHVybiByZXF1ZXN0cy5nZXQodXJsPUdpdEh1Yi5naXRodWJBcGkgKyAndXNlcicsIGF1dGg9KHVzZXIsIHRva2VuKSkuc3RhdHVzX2NvZGUgPT0gMjAwCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHByZXBhcmVFbnZpcm9ubWVudChnaXRFeGVjdXRhYmxlKToKICAgICAgICBpZiBub3QgZ2l0RXhlY3V0YWJsZToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZ2l0UHJvZ3JhbUZvbGRlciA9IG9zLnBhdGguZGlybmFtZShnaXRFeGVjdXRhYmxlKQogICAgICAgICNmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oZ2l0UHJvZ3JhbUZvbGRlcikgI2NpbnphIGVzY29uZGlkbwogICAgICAgICNmZWVkYmFjay5zZXRQcm9ncmVzc1RleHQoZ2l0RXhlY3V0YWJsZSkgI3ByZXRvCiAgICAgICAgb3MuZW52aXJvblsnR0lUX1BZVEhPTl9HSVRfRVhFQ1VUQUJMRSddID0gZ2l0RXhlY3V0YWJsZQogICAgICAgICNpbml0aWFsUGF0aCA9IG9zLmVudmlyb25bJ1BBVEgnXQogICAgICAgIG9zLmVudmlyb25bJ0dJVF9QWVRIT05fUkVGUkVTSCddID0gJ3F1aWV0JwogICAgICAgIGltcG9ydCBnaXQKICAgICAgICBnaXQucmVmcmVzaChnaXRFeGVjdXRhYmxlKQogICAgICAgIHRyeToKICAgICAgICAgICAgb3MuZW52aXJvblsnUEFUSCddLnNwbGl0KG9zLnBhdGhzZXApLmluZGV4KGdpdFByb2dyYW1Gb2xkZXIpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBvcy5lbnZpcm9uWyJQQVRIIl0gPSBnaXRQcm9ncmFtRm9sZGVyICsgb3MucGF0aHNlcCArIG9zLmVudmlyb25bIlBBVEgiXQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBpbnN0YWxsX2dpdChtdXN0QXNrVXNlcik6CiAgICAgICAgZGVmIHVzZXJDb25maXJtZWQoKToKICAgICAgICAgICAgcmV0dXJuIFFNZXNzYWdlQm94LlllcyA9PSBRTWVzc2FnZUJveC5xdWVzdGlvbihOb25lLCAiUmVxdWlyZWQgR0lUIGV4ZWN1dGFibGUgd2FzIG5vdCBmb3VuZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIkNsaWNrICdZRVMnIHRvIHN0YXJ0IGRvd25sb2FkIGFuZCBjb250aW51ZSwgb3RoZXJ3aXNlIHBsZWFzZSBzZWxlY3QgdGhlIGV4ZWN1dGFibGUgbWFudWFsbHkuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0QnV0dG9uPVFNZXNzYWdlQm94LlllcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXR0b25zPShRTWVzc2FnZUJveC5ZZXMgfCBRTWVzc2FnZUJveC5ObyB8IFFNZXNzYWdlQm94LkNhbmNlbCkpCgogICAgICAgIGlmIG5vdCAoIldpbmRvd3MiIGluIHBsYXRmb3JtLnN5c3RlbSgpIG9yICJDWUdXSU5fTlQiIGluIHBsYXRmb3JtLnN5c3RlbSgpKToKICAgICAgICAgICAgUU1lc3NhZ2VCb3gucXVlc3Rpb24oTm9uZSwgIkZhaWxlZCB0byBmaW5kIEdJVCBleGVjdXRhYmxlIiwgIlBsZWFzZSBpbnN0YWxsIGdpdCBpbiB5b3VyIHN5c3RlbSBhbmQgZmlsbCB0aGUgcGFyYW1ldGVyIEdJVCBleGVjdXRhYmxlIHBhdGguIikKICAgICAgICBpZiAobm90IG11c3RBc2tVc2VyIG9yIHVzZXJDb25maXJtZWQoKSkgPT0gRmFsc2U6CiAgICAgICAgICAgIHJldHVybiAnJwoKICAgICAgICBkZWYgZG93bmxvYWRfZmlsZSh1cmwsIHRvRGlyKToKICAgICAgICAgICAgbG9jYWxfZmlsZW5hbWUgPSBvcy5wYXRoLmpvaW4odG9EaXIsIHVybC5zcGxpdCgnLycpWy0xXSkKICAgICAgICAgICAgIyBOT1RFIHRoZSBzdHJlYW09VHJ1ZSBwYXJhbWV0ZXIgYmVsb3cKICAgICAgICAgICAgd2l0aCByZXF1ZXN0cy5nZXQodXJsLCBzdHJlYW09VHJ1ZSkgYXMgcjoKICAgICAgICAgICAgICAgIHIucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgICAgICAgICAgICB3aXRoIG9wZW4obG9jYWxfZmlsZW5hbWUsICd3YicpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgZm9yIGNodW5rIGluIHIuaXRlcl9jb250ZW50KGNodW5rX3NpemU9ODE5Mik6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGNodW5rOiAgIyBmaWx0ZXIgb3V0IGtlZXAtYWxpdmUgbmV3IGNodW5rcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZi53cml0ZShjaHVuaykKICAgICAgICAgICAgcmV0dXJuIGxvY2FsX2ZpbGVuYW1lCgogICAgICAgIHRtcERpciA9IHRlbXBmaWxlLm1rZHRlbXAoKQogICAgICAgIGdpdFVybCA9ICJodHRwczovL2dpdGh1Yi5jb20vZ2l0LWZvci13aW5kb3dzL2dpdC9yZWxlYXNlcy9kb3dubG9hZC92Mi4yNS4xLndpbmRvd3MuMS9Qb3J0YWJsZUdpdC0yLjI1LjEtNjQtYml0Ljd6LmV4ZSIKICAgICAgICAjIFFNZXNzYWdlQm94LmluZm9ybWF0aW9uKE5vbmUsICJTdGFydGluZyBHSVQgZG93bmxvYWQiLCAiVGhpcyBzdGVwIHdpbGwgdGFrZSBzb21lIHRpbWUsIGl0IGRlcGVuZHMgb24geW91ciBpbnRlcm5ldCBzcGVlZC5cbkNsaWNrICdPSycgdG8gY29udGludWUuIiwgZGVmYXVsdEJ1dHRvbj1RTWVzc2FnZUJveC5PaywgYnV0dG9ucz1RTWVzc2FnZUJveC5PaykKICAgICAgICBzZWxmRXh0cmFjdG9yID0gZG93bmxvYWRfZmlsZShnaXRVcmwsIHRtcERpcikKICAgICAgICBwb3J0YWJsZUdpdCA9IG9zLnBhdGguam9pbih0bXBEaXIsICJwb3J0YWJsZWdpdCIpCiAgICAgICAgaWYgKG5vdCBvcy5wYXRoLmlzZmlsZShzZWxmRXh0cmFjdG9yKSk6CiAgICAgICAgICAgIHJldHVybiAnJwogICAgICAgIHN1YnByb2Nlc3MuY2hlY2tfb3V0cHV0KFtzZWxmRXh0cmFjdG9yLCAnLW8nLCBwb3J0YWJsZUdpdCwgIi15Il0pCiAgICAgICAgcmV0dXJuIG9zLnBhdGguam9pbihwb3J0YWJsZUdpdCwgJ21pbmd3NjQnLCAnYmluJywgJ2dpdC5leGUnKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRHaXRFeGUoKToKICAgICAgICBnaXRFeGUgPSAnJwogICAgICAgIHRyeToKICAgICAgICAgICAgZ2l0RXhlID0gb3MuZW52aXJvblsnR0lUX1BZVEhPTl9HSVRfRVhFQ1VUQUJMRSddCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCiAgICAgICAgcmV0dXJuIGdpdEV4ZQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRSZXBvc2l0b3J5U2l6ZSh1c2VyLCByZXBvc2l0b3J5LCBwYXNzd29yZCk6CiAgICAgICAgcmVzcG9uc2UgPSBHaXRIdWIuX3JlcXVlc3QoJ0dFVCcsICdodHRwczovL2FwaS5naXRodWIuY29tL3JlcG9zLycgKyB1c2VyICsgIi8iICsgcmVwb3NpdG9yeSwgdG9rZW49cGFzc3dvcmQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVycz17J0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ30pCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiByZXNwb25zZS5zdGF0dXNfY29kZSA9PSAyMDA6CiAgICAgICAgICAgICAgICByZXR1cm4ganNvbi5sb2FkcyhyZXNwb25zZS5jb250ZW50KVsnc2l6ZSddCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwcmludCgiRmFpbGVkIHRvIGdldCB0aGUgcmVwb3NpdG9yeSBzaXplLCBpZ25vcmluZyBpdC4iKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIHJldHVybiBOb25lCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldEdpdFVybChnaXRodWJVc2VyLCBnaXRodWJSZXBvc2l0b3J5KToKICAgICAgICByZXR1cm4gImh0dHBzOi8vZ2l0aHViLmNvbS8iICsgZ2l0aHViVXNlciArICIvIiArIGdpdGh1YlJlcG9zaXRvcnkgKyAiLyIKCiAgICAjTm8gcGFzc3dvcmQgdG8gYWxsb3cgdXNpbmcgY29uZmlndXJlZCBTU0hLZXkuCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0R2l0UGFzc1VybCh1c2VyLCByZXBvc2l0b3J5LCBwYXNzd29yZCk6CiAgICAgICAgaWYgcGFzc3dvcmQgaXMgTm9uZSBvciBub3QgcGFzc3dvcmQ6CiAgICAgICAgICAgIHJldHVybiBHaXRIdWIuZ2V0R2l0VXJsKHVzZXIsIHJlcG9zaXRvcnkpCiAgICAgICAgcmV0dXJuICJodHRwczovLyIgKyB1c2VyICsgIjoiICsgcGFzc3dvcmQgKyAiQGdpdGh1Yi5jb20vIiArIHVzZXIgKyAiLyIgKyByZXBvc2l0b3J5ICsgIi8iCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGxzcmVtb3RlKHVybCk6CiAgICAgICAgaW1wb3J0IGdpdAogICAgICAgIHJlbW90ZV9yZWZzID0ge30KICAgICAgICBnID0gZ2l0LmNtZC5HaXQoKQogICAgICAgIGZvciByZWYgaW4gZy5sc19yZW1vdGUodXJsKS5zcGxpdCgnXG4nKToKICAgICAgICAgICAgaGFzaF9yZWZfbGlzdCA9IHJlZi5zcGxpdCgnXHQnKQogICAgICAgICAgICByZW1vdGVfcmVmc1toYXNoX3JlZl9saXN0WzFdXSA9IGhhc2hfcmVmX2xpc3RbMF0KICAgICAgICByZXR1cm4gcmVtb3RlX3JlZnMKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZXhpc3RzUmVwb3NpdG9yeSh1c2VyLCByZXBvc2l0b3J5KToKICAgICAgICB0cnk6CiAgICAgICAgICAgICNmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIlVSTDogIiArIEdpdEh1Yi5nZXRHaXRVcmwodXNlciwgcmVwb3NpdG9yeSkpCiAgICAgICAgICAgIHJlc3AgPSByZXF1ZXN0cy5nZXQoR2l0SHViLmdldEdpdFVybCh1c2VyLCByZXBvc2l0b3J5KSkKICAgICAgICAgICAgaWYgcmVzcC5zdGF0dXNfY29kZSA9PSAyMDA6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICNyZXN1bHQgPSBHaXRIdWIubHNyZW1vdGUoR2l0SHViLmdldEdpdFVybCh1c2VyLCByZXBvc2l0b3J5KSkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBjb25maWdVc2VyKHJlcG8sIHVzZXIpOgogICAgICAgIHJlcG8uZ2l0LmNvbmZpZygidXNlci5lbWFpbCIsIHVzZXIpCiAgICAgICAgcmVwby5naXQuY29uZmlnKCJ1c2VyLm5hbWUiLCB1c2VyKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRSZXBvc2l0b3J5KGZvbGRlciwgdXNlciwgcmVwb3NpdG9yeSwgcGFzc3dvcmQsIGZlZWRiYWNrKToKICAgICAgICBmcm9tIGdpdCBpbXBvcnQgUmVwbwogICAgICAgIGZyb20gZ2l0IGltcG9ydCBJbnZhbGlkR2l0UmVwb3NpdG9yeUVycm9yCgogICAgICAgICMgI07Do28gZXN0w6EgZnVuY2lvbmFuZG8gYSB2YWxpZGHDp8OjbyAjRklYTUUgUmVwb3NpdG9yeSBjcmVhdGlvbiB2ZXJpZmljYXRpb24gaXMgbm90IHdvcmtpbmcgKE1vZGlmeSB0aGUgY3JlYXRlIFJlcG8gZnVuY3Rpb24gdG8gdmVyaWZ5IHRoZSBjcmVhdGlvbikKICAgICAgICAjICNmZWVkYmFjay5wdXNoQ29uc29sZUluZm8odXNlciArICcgYXQgJyArIHJlcG9zaXRvcnkpCiAgICAgICAgIyBpZiBub3QgR2l0SHViLmV4aXN0c1JlcG9zaXRvcnkodXNlciwgcmVwb3NpdG9yeSk6CiAgICAgICAgIyAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJUaGUgcmVwb3NpdG9yeSAiICsgcmVwb3NpdG9yeSArICIgZG9lc24ndCBleGlzdHMuXG5QbGVhc2UgY3JlYXRlIGEgbmV3IG9uZSBhdCBodHRwczovL2dpdGh1Yi5jb20vbmV3IC4iKQogICAgICAgICMgICAgIHJldHVybiBOb25lCgogICAgICAgICNDcmlhIG91IHBlZ2EgbyByZXBvc2l0w7NyaW8gYXR1YWwuCiAgICAgICAgcmVwbyA9IE5vbmUKICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoZm9sZGVyKSBvciAob3MucGF0aC5leGlzdHMoZm9sZGVyKSBhbmQgbm90IG9zLmxpc3RkaXIoZm9sZGVyKSk6CiAgICAgICAgICAgIHJlcG9TaXplID0gR2l0SHViLmdldFJlcG9zaXRvcnlTaXplKHVzZXIsIHJlcG9zaXRvcnksIHBhc3N3b3JkKQogICAgICAgICAgICBpZiByZXBvU2l6ZSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHJlcG9TaXplID0gc3RyKHJlcG9TaXplKSArICIoa2IpIgogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmVwb1NpemUgPSAnJwogICAgICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkNsb25pbmcgZ2l0IHJlcG9zaXRvcnk6ICIgKyBHaXRIdWIuZ2V0R2l0VXJsKHVzZXIsIHJlcG9zaXRvcnkpICsgIlxuUGxlYXNlIHdhaXQsIGl0IHdpbGwgZG93bmxvYWQgYWxsIG1hcHMgaW4geW91ciByZXBvc2l0b3J5LiAiICsgcmVwb1NpemUpCiAgICAgICAgICAgIHJlcG8gPSBHaXRJbnRlcmFjdGl2ZS5jbG9uZVJlcG8odXNlciwgcmVwb3NpdG9yeSwgZm9sZGVyLCBmZWVkYmFjaykjUmVwby5jbG9uZV9mcm9tKEdpdEh1Yi5nZXRHaXRVcmwodXNlciwgcmVwb3NpdG9yeSksIGZvbGRlciwgcmVjdXJzaXZlPVRydWUsIHByb2dyZXNzPUdpdEh1Yi5nZXRHaXRQcm9ncmVzc1JlcG9ydChmZWVkYmFjaykpCiAgICAgICAgICAgIGFzc2VydCAob3MucGF0aC5leGlzdHMoZm9sZGVyKSkKICAgICAgICAgICAgYXNzZXJ0KHJlcG8pCiAgICAgICAgZWxzZToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmVwbyA9IFJlcG8oZm9sZGVyKQogICAgICAgICAgICAgICAgcmVwb1VybCA9IHJlcG8uZ2l0LnJlbW90ZSgiLXYiKQogICAgICAgICAgICAgICAgZXhwZWN0ZWRVcmwgPSBHaXRIdWIuZ2V0R2l0VXJsKHVzZXIsIHJlcG9zaXRvcnkpCiAgICAgICAgICAgICAgICBpZiByZXBvVXJsIGFuZCBub3QgKGV4cGVjdGVkVXJsIGluIHJlLmNvbXBpbGUoIltcXG5cXHQgXSIpLnNwbGl0KHJlcG9VcmwpKToKICAgICAgICAgICAgICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIllvdXIgcmVtb3RlIFVSTCAiICsgcmVwb1VybCArICIgZG9lcyBub3QgbWF0Y2ggdGhlIGV4cGVjdGVkIHVybCAiICsgZXhwZWN0ZWRVcmwpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGV4Y2VwdCBJbnZhbGlkR2l0UmVwb3NpdG9yeUVycm9yIGFzIGU6CiAgICAgICAgICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIlRoZSBkZXN0aW5hdGlvbiBmb2xkZXIgbXVzdCBiZSBhIHJlcG9zaXRvcnkgb3IgYW4gZW1wdHkgZm9sZGVyLiBSZWFzb246ICIgKyBzdHIoZSkpCiAgICAgICAgICAgICAgICAjcmVwbyA9IFJlcG8uaW5pdChmb2xkZXIsIGJhcmU9RmFsc2UpCiAgICAgICAgcmV0dXJuIHJlcG8KCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgaXNPcHRpb25zT2soZm9sZGVyLCB1c2VyLCByZXBvc2l0b3J5LCBmZWVkYmFjaywgZ2hQYXNzd29yZD1Ob25lLCBtdXN0QXNrVXNlcj1GYWxzZSk6CiAgICAgICAgdHJ5IDoKICAgICAgICAgICAgI0NyaWEgb3UgcGVnYSBvIHJlcG9zaXTDs3JpbyBhdHVhbC4KICAgICAgICAgICAgcmVwbyA9IEdpdEh1Yi5nZXRSZXBvc2l0b3J5KGZvbGRlciwgdXNlciwgcmVwb3NpdG9yeSwgZ2hQYXNzd29yZCwgZmVlZGJhY2spCiAgICAgICAgICAgIGlmIG5vdCByZXBvOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIEdpdEh1Yi5jb25maWdVc2VyKHJlcG8sIHVzZXIpCiAgICAgICAgICAgIGlmIHJlcG8uZ2l0LnN0YXR1cygiLS1wb3JjZWxhaW4iKToKICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gbm90IG11c3RBc2tVc2VyIG9yIFFNZXNzYWdlQm94LnF1ZXN0aW9uKE5vbmUsICJMb2NhbCByZXBvc2l0b3J5IGlzIG5vdCBjbGVhbi4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIlRoZSBmb2xkZXIgaGF2ZSBsb2NhbCBjaGFuZ2VzLCB3ZSBuZWVkIHRvIGZpeCB0byBjb250aW51ZS5cbkNsaWNrICdESVNDQVJEJyB0byBkaXNjYXJkIGNoYW5nZXMsICdZRVMnIHRvIGNvbW1pdCBjaGFuZ2VzLCBvdGhlcndpc2UgY2xpY2sgJ0NBTkNFTCcgdG8gY2FuY2VsIGFuZCByZXNvbHZlIG1hbnVhbGx5LiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXR0b25zPShRTWVzc2FnZUJveC5EaXNjYXJkIHwgUU1lc3NhZ2VCb3guWWVzIHwgUU1lc3NhZ2VCb3guQ2FuY2VsKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHRCdXR0b249UU1lc3NhZ2VCb3guRGlzY2FyZCkKICAgICAgICAgICAgICAgIGlmIG5vdCBtdXN0QXNrVXNlciBvciByZXNwb25zZSA9PSBRTWVzc2FnZUJveC5ZZXM6CiAgICAgICAgICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJQdWxsaW5nIHJlbW90ZSByZXBvc2l0b3J5IGNoYW5nZXMgdG8geW91ciBkaXJlY3RvcnkuIikKICAgICAgICAgICAgICAgICAgICBHaXRIdWIudHJ5UHVsbFJlcG9zaXRvcnkocmVwbywgdXNlciwgcmVwb3NpdG9yeSwgZmVlZGJhY2spICAjIERhbmlsbwogICAgICAgICAgICAgICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiQWRkaW5nIGFsbCBmaWxlcyBpbiBmb2xkZXIiKQogICAgICAgICAgICAgICAgICAgIEdpdEh1Yi5hZGRGaWxlcyhyZXBvLCB1c2VyLCByZXBvc2l0b3J5LCBmZWVkYmFjaykKICAgICAgICAgICAgICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkFkZGluZyBhbGwgZmlsZXMgaW4gZm9sZGVyIikKICAgICAgICAgICAgICAgICAgICBHaXRIdWIuZ2l0Q29tbWl0KHJlcG8sIG1zZz0iUUdJUyAtIEFkZGluZyBhbGwgZmlsZXMgaW4gZm9sZGVyICIgKyBkYXRldGltZS5ub3coKS5zdHJmdGltZSgiJWQvJW0vJVkgJUg6JU06JVMiKSwgZmVlZGJhY2s9ZmVlZGJhY2spCiAgICAgICAgICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJRR0lTIC0gU2VuZGluZyBjaGFuZ2VzIHRvIEdpdGh1YiIpCiAgICAgICAgICAgICAgICAgICAgIyB0cnk6CiAgICAgICAgICAgICAgICAgICAgIyAgICAgVVRJTFMucnVuTG9uZ1Rhc2socmVwby5naXQucHVsbCwgZmVlZGJhY2ssICdQZWFzZSB3YWl0LCBwdWxsaW5nIGNoYW5nZXMuJywgMzApCiAgICAgICAgICAgICAgICAgICAgIyBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgIyAgICAgcGFzcwogICAgICAgICAgICAgICAgICAgIEdpdEh1Yi5wdXNoQ2hhbmdlcyhyZXBvLCB1c2VyLCByZXBvc2l0b3J5LCBnaFBhc3N3b3JkLCBmZWVkYmFjaykKICAgICAgICAgICAgICAgIGVsaWYgcmVzcG9uc2UgPT0gUU1lc3NhZ2VCb3guRGlzY2FyZDoKICAgICAgICAgICAgICAgICAgICByZXBvLmdpdC5jbGVhbigiLWRmIikKICAgICAgICAgICAgICAgICAgICByZXBvLmdpdC5jaGVja291dCgnLS0nLCAnLicpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiRXJyb3I6IExvY2FsIHJlcG9zaXRvcnkgaXMgbm90IGNsZWFuLlxuUGxlYXNlIGNvbW1pdCB0aGUgY2hhbmdlcyBtYWRlIHRvIGxvY2FsIHJlcG9zaXRvcnkgYmVmb3JlIHJ1bi5cblVzZTogZ2l0IGFkZCAqIGFuZCBnaXQgY29tbWl0IC1tIFwiTVNHXCIiKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIEdpdEh1Yi50cnlQdWxsUmVwb3NpdG9yeShyZXBvLCB1c2VyLCByZXBvc2l0b3J5LCBmZWVkYmFjaykKICAgICAgICAgICAgICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkdpdDogQ2hlY2tpbmcgb3V0IGNoYW5nZXMuIikKICAgICAgICAgICAgICAgICAgICByZXBvLmdpdC5jaGVja291dCgnLS0nLCAnLicpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZXg6CiAgICAgICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiQ2FuY2VsZWQgZHVlIHRvOiB7MH0iLmZvcm1hdChleCkpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBmaW5kR2l0RXhlKGdpdEV4ZSwgZm91bmRfZ2l0LCBtdXN0QXNrVXNlcik6CiAgICAgICAgaWYgKG5vdCBnaXRFeGUgb3Igbm90IG9zLnBhdGguaXNmaWxlKGdpdEV4ZSkpIGFuZCAobm90ICdHSVRfUFlUSE9OX0dJVF9FWEVDVVRBQkxFJyBpbiBvcy5lbnZpcm9uIG9yIG5vdCBvcy5wYXRoLmlzZmlsZShvcy5lbnZpcm9uWydHSVRfUFlUSE9OX0dJVF9FWEVDVVRBQkxFJ10pKSBhbmQgKG5vdCBmb3VuZF9naXQgb3Igb3MucGF0aC5pc2ZpbGUoZm91bmRfZ2l0KSk6CiAgICAgICAgICAgIGdpdEV4ZSA9IEdpdEh1Yi5pbnN0YWxsX2dpdChtdXN0QXNrVXNlcikKICAgICAgICByZXR1cm4gZ2l0RXhlCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHRyeVB1bGxSZXBvc2l0b3J5KHJlcG8sIHVzZXIsIHJlcG9zaXRvcnksIGZlZWRiYWNrKToKICAgICAgICBHaXRIdWIuY29uZmlnVXNlcihyZXBvLCB1c2VyKQogICAgICAgIHRyeToKICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJHaXQ6IFB1bGxpbmcgcmVtb3RlIHJlcG9zaXRvcnkgY3VycmVudCBzdGF0ZS4iKQogICAgICAgICAgICAjIFVUSUxTLnJ1bkxvbmdUYXNrKHJlcG8uZ2l0LnB1bGwsIGZlZWRiYWNrLCAnUGVhc2Ugd2FpdCwgcHVsbGluZyBjaGFuZ2VzLicsIDMwLCAiIC1zIHJlY3Vyc2l2ZSAtWCBvdXJzICIgKyBHaXRIdWIuZ2V0R2l0VXJsKHVzZXIsIHJlcG9zaXRvcnkpICsgIm1hc3RlciIpCiAgICAgICAgICAgIFVUSUxTLnJ1bkxvbmdUYXNrKHJlcG8uZ2l0LnB1bGwsIGZlZWRiYWNrLCAnUGVhc2Ugd2FpdCwgcHVsbGluZyBjaGFuZ2VzLicsIDMwLCAiLXMiLCAicmVjdXJzaXZlIiwgIi1YIiwgIm91cnMiLCBHaXRIdWIuZ2V0R2l0VXJsKHVzZXIsIHJlcG9zaXRvcnkpLCAibWFzdGVyIikKICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJCZWZvcmUgZmV0Y2ggY2hhbmdlcy4iKQogICAgICAgICAgICBVVElMUy5ydW5Mb25nVGFzayhyZXBvLmdpdC5mZXRjaCwgZmVlZGJhY2ssICdQbGVhc2Ugd2FpdCwgZmV0Y2hpbmcgY2hhbmdlcy4nLCAzMCwgR2l0SHViLmdldEdpdFVybCh1c2VyLCByZXBvc2l0b3J5KSwgIm1hc3RlciIpCiAgICAgICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiR2l0OiBEb2luZyBjaGVja291dC4iKQogICAgICAgICAgICBVVElMUy5ydW5Mb25nVGFzayhyZXBvLmdpdC5jaGVja291dCwgZmVlZGJhY2ssICdQbGVhc2Ugd2FpdCwgZG9pbmcgY2hlY2tvdXQnLCAzMCwgIi0tb3VycyIpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGNyZWF0ZVJlcG8oZ2hSZXBvc2l0b3J5LCBnaFVzZXIsIGdoUGFzcywgZmVlZGJhY2spOgogICAgICAgIHBheWxvYWQgPSB7CiAgICAgICAgICAgICduYW1lJzogZ2hSZXBvc2l0b3J5LAogICAgICAgICAgICAnZGVzY3JpcHRpb24nOiAnUmVwb3NpdG9yeSBjb2ludGFpbmluZyBtYXBzIG9mIHRoZSBtYXBwaWEgcHVibGlzaGVyLicsCiAgICAgICAgICAgICdicmFuY2gnOiAnbWFzdGVyJywKICAgICAgICAgICAgJ2F1dG9faW5pdCc6ICd0cnVlJwogICAgICAgIH0KICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkNyZWF0aW5nIHRoZSBuZXcgcmVwb3NpdG9yeTogIiArIGdoUmVwb3NpdG9yeSkKICAgICAgICByZXNwID0gcmVxdWVzdHMucG9zdChHaXRIdWIuZ2l0aHViQXBpICsgJ3VzZXIvcmVwb3MnLCBhdXRoPShnaFVzZXIsIGdoUGFzcyksIGRhdGE9anNvbi5kdW1wcyhwYXlsb2FkKSkKICAgICAgICBpZiByZXNwLnN0YXR1c19jb2RlID09IDIwMToKICAgICAgICAgICAgc2xlZXAoMSkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgcnVuTG9uZ1Rhc2soZnVuY3Rpb24sIGZlZWRiYWNrLCB3YWl0TWVzc2FnZT0iUGxlYXNlIFdhaXQiLCBzZWNvbmRzUmVwb3J0PTYwLCAqYXJncywgKiprd0FyZ3MpOgogICAgICAgIGZyb20gY29uY3VycmVudCBpbXBvcnQgZnV0dXJlcwogICAgICAgICMgZmVlZGJhY2suc2V0UHJvZ3Jlc3MoMSkKICAgICAgICBzdGVwVGltZXIgPSAwLjUKICAgICAgICB0b3RhbFRpbWUgPSAwCiAgICAgICAgd2l0aCBmdXR1cmVzLlRocmVhZFBvb2xFeGVjdXRvcihtYXhfd29ya2Vycz0xKSBhcyBleGVjdXRvcjoKICAgICAgICAgICAgam9iID0gZXhlY3V0b3Iuc3VibWl0KGZ1bmN0aW9uLCAqYXJncywgKiprd0FyZ3MpCiAgICAgICAgICAgIGVsYXBzZWRUaW1lID0gMAogICAgICAgICAgICB3aGlsZSBqb2IuZG9uZSgpID09IEZhbHNlOgogICAgICAgICAgICAgICAgdGltZS5zbGVlcChzdGVwVGltZXIpCiAgICAgICAgICAgICAgICBlbGFwc2VkVGltZSA9IGVsYXBzZWRUaW1lICsgc3RlcFRpbWVyCiAgICAgICAgICAgICAgICB0b3RhbFRpbWUgPSB0b3RhbFRpbWUgKyBzdGVwVGltZXIKICAgICAgICAgICAgICAgIGlmIGVsYXBzZWRUaW1lID4gc2Vjb25kc1JlcG9ydDoKICAgICAgICAgICAgICAgICAgICBjYW5jZWxNc2cgPSAiXG5DYW5jZWxsaW5nLCBwbGVhc2Ugd2FpdCB0aGUgY3VycmVudCBzdGVwIHRvIGZpbmlzaCBncmFjZWZ1bGx5LiIgaWYgZmVlZGJhY2suaXNDYW5jZWxlZCgpIGVsc2UgJycKICAgICAgICAgICAgICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkVsYXBzZWQgIiArIHN0cihyb3VuZCh0b3RhbFRpbWUpKSArICJzOiAiICsgd2FpdE1lc3NhZ2UgKyBjYW5jZWxNc2cpCiAgICAgICAgICAgICAgICAgICAgZWxhcHNlZFRpbWUgPSAwCiAgICAgICAgICAgICAgICAjIGlmIGNhbkNhbmNlbE5vdyBhbmQgZmVlZGJhY2suaXNDYW5jZWxlZCgpOgogICAgICAgICAgICAgICAgIyAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJKb2Igc3RhcnRpbmcgdG8gY2FuY2VsLiIpCiAgICAgICAgICAgICAgICAjICAgICBqb2IuY2FuY2VsKCkKICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJFbGFwc2VkICIgKyBzdHIocm91bmQodG90YWxUaW1lKSkgKyAicyBvbiB0aGlzIHN0ZXAuIikKICAgICAgICAgICAgIyBVVElMUy5jaGVja0ZvckNhbmNlbGVkKGZlZWRiYWNrKQogICAgICAgICAgICByZXR1cm4gam9iLnJlc3VsdCgpCgoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRHaXRDcmVkZW50aWFscyhjdXJVc2VyLCBjdXJQYXNzLCBtdXN0QXNrVXNlcik6CiAgICAgICAgc3RhdGUgPSBVVElMUy5yYW5kb21TdHJpbmcoKQogICAgICAgIGlmIChub3QgY3VyVXNlcik6CiAgICAgICAgICAgIGN1clVzZXIgPSAnJwogICAgICAgIGlmIChjdXJQYXNzIGlzIE5vbmUgb3Igbm90IGN1clBhc3Mgb3Igbm90IGN1clVzZXIpIG9yIChHaXRIdWIudGVzdExvZ2luKGN1clVzZXIsIGN1clBhc3MpID09IEZhbHNlIGFuZCAobXVzdEFza1VzZXIgb3IgUU1lc3NhZ2VCb3gucXVlc3Rpb24oCiAgICAgICAgICAgICAgICBOb25lLCAiQ3JlZGVudGlhbHMgcmVxdWlyZWQiLCAiUGxlYXNlIGluZm9ybSB5b3VyIGNyZWRlbnRpYWxzLCBjb3VsZCB3ZSBvcGVuIGxvZ2luIGxpbmsgZm9yIHlvdT8iKSA9PSBRTWVzc2FnZUJveC5ZZXMpKToKICAgICAgICAgICAgdXJsID0gJ2h0dHBzOi8vZ2l0aHViLmNvbS9sb2dpbi9vYXV0aC9hdXRob3JpemU/cmVkaXJlY3RfdXJpPWh0dHBzOi8vY3NyLnVmbWcuYnIvaW1hZ2VyeS9nZXRfa2V5LnBocCZjbGllbnRfaWQ9MTBiMjhhMzg4YjBlNjZlODdjZWUmbG9naW49JyArIGN1clVzZXIgKyAnJnNjb3BlPXJlYWQ6dXNlciUyMHJlcG8mc3RhdGU9JyArIHN0YXRlCiAgICAgICAgICAgIGNyZWRlbnRpYWxzID0gewogICAgICAgICAgICAgICAgJ3ZhbHVlJzogTm9uZQogICAgICAgICAgICB9CiAgICAgICAgICAgIEdpdEh1Yi5nZXRDcmVkZW50aWFscyhzdGF0ZSkKICAgICAgICAgICAgd2ViYnJvd3Nlci5vcGVuKHVybCwgMSkKICAgICAgICAgICAgaXNGaXJzdE9wZW4gPSBUcnVlCiAgICAgICAgICAgIGRlZiBjaGVja0xvZ2luVmFsaWRhdGlvbihidG4sIHFudENhbGxiYWNrcyk6CiAgICAgICAgICAgICAgICBjcmVkZW50aWFsc1sndmFsdWUnXSA9IGNyZWRlbnRpYWxzWyd2YWx1ZSddIG9yIEdpdEh1Yi5nZXRDcmVkZW50aWFscyhzdGF0ZSkKICAgICAgICAgICAgICAgIGlmIGNyZWRlbnRpYWxzWyd2YWx1ZSddIGFuZCBub3QgbXVzdEFza1VzZXI6CiAgICAgICAgICAgICAgICAgICAgYnRuLmRvbmUoMCkKICAgICAgICAgICAgd2hpbGUgbm90IGNyZWRlbnRpYWxzWyd2YWx1ZSddOgogICAgICAgICAgICAgICAgc2xlZXAoMSkKICAgICAgICAgICAgICAgIGF1eE1zZyA9ICcnIGlmIGlzRmlyc3RPcGVuIGVsc2UgJ1xuXG5XYWl0aW5nIHZhbGlkYXRpb24sIHJlLW9wZW5uaW5nIHRoZSBhdXRob3JpemF0aW9uIGdpdGh1YiBwYWdlLlxuUGxlYXNlIGxvZ2luIG9uIGEgR2l0aHViIGFjY291bnQgdG8gY29udGludWUuJwogICAgICAgICAgICAgICAgaXNGaXJzdE9wZW4gPSBGYWxzZQogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSBDdXN0b21NZXNzYWdlQm94LnNob3dXaXRoQ2FsbGJhY2soMjAwMCwKICAgICAgICAgICAgICAgICAgICAgICJTdGVwcyB0byBjb25maXJtIHlvdXIgY3JlZGVudGlhbHM6XG4xKSBFbnRlciBjcmVkZW50aWFsc1xuMikgY2xpY2sgdG8gJ2F1dGhvcml6ZSBNYXBwaWEnIFxuMykgV2FpdCBhbmQgQ2xpY2sgJ1lFUycgdG8gY29uZmlybS5cbiBPciAnTk8nIHRvIGNhbmNlbC5cbk9wZW5uaW5nIHRoZSBnaXRodWIgYXV0aGVudGljYXRpb24gbGluayBpbiBicm93c2VyLiIgKyBhdXhNc2csCiAgICAgICAgICAgICAgICAgICAgICAiUGxlYXNlIGNvbmZpcm0gY3JlZGVudGlhbHMgYXQgR2l0aHViIHNpdGUgdG8gY29udGludWUiLCBjaGVja0xvZ2luVmFsaWRhdGlvbiwgYnV0dG9ucz1RTWVzc2FnZUJveC5ZZXMgfCBRTWVzc2FnZUJveC5ObykKICAgICAgICAgICAgICAgIGNyZWRlbnRpYWxzWyd2YWx1ZSddID0gY3JlZGVudGlhbHNbJ3ZhbHVlJ10gb3IgR2l0SHViLmdldENyZWRlbnRpYWxzKHN0YXRlKQogICAgICAgICAgICAgICAgaWYgcmVzcG9uc2UgPT0gUU1lc3NhZ2VCb3guWWVzIGFuZCBub3QgY3JlZGVudGlhbHNbJ3ZhbHVlJ106CiAgICAgICAgICAgICAgICAgICAgd2ViYnJvd3Nlci5vcGVuKHVybCwgMikKICAgICAgICAgICAgICAgIGVsaWYgcmVzcG9uc2UgIT0gUU1lc3NhZ2VCb3guWWVzIGFuZCBub3QgY3JlZGVudGlhbHNbJ3ZhbHVlJ106CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChOb25lLCBOb25lKQogICAgICAgICAgICByZXR1cm4gKGNyZWRlbnRpYWxzWyd2YWx1ZSddWyd1c2VyJ10sIGNyZWRlbnRpYWxzWyd2YWx1ZSddWyd0b2tlbiddKQogICAgICAgIHJldHVybiAoY3VyVXNlciwgY3VyUGFzcykKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgYWRkRmlsZXMocmVwbywgdXNlciwgcmVwb3NpdG9yeSwgZmVlZGJhY2spOgogICAgICAgIHJldHVybiBHaXRJbnRlcmFjdGl2ZS5hZGRGaWxlcyhyZXBvLCB1c2VyLCByZXBvc2l0b3J5LCBmZWVkYmFjaykKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2l0Q29tbWl0KHJlcG8sIG1zZywgZmVlZGJhY2spOgogICAgICAgIHJldHVybiBHaXRJbnRlcmFjdGl2ZS5naXRDb21taXQocmVwbywgbXNnLCBmZWVkYmFjaykKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgcHVzaENoYW5nZXMocmVwbywgdXNlciwgcmVwb3NpdG9yeSwgcGFzc3dvcmQsIGZlZWRiYWNrKToKICAgICAgICByZXR1cm4gR2l0SW50ZXJhY3RpdmUucHVzaENoYW5nZXMocmVwbywgdXNlciwgcmVwb3NpdG9yeSwgcGFzc3dvcmQsIGZlZWRiYWNrKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBwdWJsaXNoVGlsZXNUb0dpdEh1Yihmb2xkZXIsIHVzZXIsIHJlcG9zaXRvcnksIGZlZWRiYWNrLCB2ZXJzaW9uLCBwYXNzd29yZD1Ob25lKToKICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oJ0dpdGh1YiBmb3VuZCBjb21taXRpbmcgdG8geW91ciBhY2NvdW50LicpCgogICAgICAgIHJlcG8gPSBHaXRIdWIuZ2V0UmVwb3NpdG9yeShmb2xkZXIsIHVzZXIsIHJlcG9zaXRvcnksIHBhc3N3b3JkLCBmZWVkYmFjaykKCiAgICAgICAgbm93ID0gZGF0ZXRpbWUubm93KCkKICAgICAgICAjIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzY1NjUzNTcvZ2l0LXB1c2gtcmVxdWlyZXMtdXNlcm5hbWUtYW5kLXBhc3N3b3JkCiAgICAgICAgcmVwby5naXQuY29uZmlnKCJjcmVkZW50aWFsLmhlbHBlciIsICIgIiwgInN0b3JlIikKICAgICAgICBHaXRIdWIudHJ5UHVsbFJlcG9zaXRvcnkocmVwbywgdXNlciwgcmVwb3NpdG9yeSwgZmVlZGJhY2spICNEYW5pbG8KICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oJ0dpdDogQWRkIGFsbCBnZW5lcmF0ZWQgdGlsZXMgdG8geW91ciByZXBvc2l0b3J5LicpCiAgICAgICAgR2l0SHViLmFkZEZpbGVzKHJlcG8sIHVzZXIsIHJlcG9zaXRvcnksIGZlZWRiYWNrKQogICAgICAgICNmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkdpdDogTWVyZ2luLiIpCiAgICAgICAgI3JlcG8uZ2l0Lm1lcmdlKCItcyByZWN1cnNpdmUiLCAiLVggb3VycyIpCiAgICAgICAgI2ZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiR2l0OiBQdXNoaW5nIGNoYW5nZXMuIikKICAgICAgICAjcmVwby5naXQucHVzaChHaXRIdWIuZ2V0R2l0VXJsKHVzZXIsIHJlcG9zaXRvcnkpLCAibWFzdGVyOnJlZnMvaGVhZHMvbWFzdGVyIikKICAgICAgICBpZiByZXBvLmluZGV4LmRpZmYoTm9uZSkgb3IgcmVwby51bnRyYWNrZWRfZmlsZXM6CiAgICAgICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiTm8gY2hhbmdlcywgbm90aGluZyB0byBjb21taXQuIikKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkdpdDogQ29tbWl0dGluZyBjaGFuZ2VzLiIpCiAgICAgICAgR2l0SHViLmdpdENvbW1pdChyZXBvLCAiUUdJUyAtICIgKyBub3cuc3RyZnRpbWUoIiVkLyVtLyVZICVIOiVNOiVTIikgKyAiIHZlcnNpb246ICIgKyB2ZXJzaW9uLCBmZWVkYmFjaykKICAgICAgICAjIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiQ1JFQVRJTkcgVEFHIikKICAgICAgICAjIHRhZyA9IG5vdy5zdHJmdGltZSgiJVklbSVkLSVIJU0lUyIpCiAgICAgICAgIyBuZXdfdGFnID0gcmVwby5jcmVhdGVfdGFnKHRhZywgbWVzc2FnZT0nQXV0b21hdGljIHRhZyAiezB9IicuZm9ybWF0KHRhZykpCiAgICAgICAgIyByZXBvLnJlbW90ZXNbb3JpZ2luTmFtZV0ucHVzaChuZXdfdGFnKQogICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiR2l0OiBQdXNoaW5nIG1vZGlmaWNhdGlvbnMgdG8gcmVtb3RlIHJlcG9zaXRvcnkuIikKICAgICAgICBHaXRIdWIucHVzaENoYW5nZXMocmVwbywgdXNlciwgcmVwb3NpdG9yeSwgcGFzc3dvcmQsIGZlZWRiYWNrKQogICAgICAgIHJldHVybiBOb25lCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldENyZWRlbnRpYWxzKHNlY3JldCk6CiAgICAgICAgI0RhbmlsbyAjRklYTUUgY29sb2NhciBVTklRVUUgbm8gQkQKICAgICAgICByZXNwID0gcmVxdWVzdHMuZ2V0KCdodHRwczovL2Nzci51Zm1nLmJyL2ltYWdlcnkvdmVyaWZ5X2tleS5waHA/c3RhdGU9JyArIHNlY3JldCkKICAgICAgICBpZiByZXNwLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgcmV0dXJuIGpzb24ubG9hZHMocmVzcC50ZXh0KQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgIyBAc3RhdGljbWV0aG9kCiAgICAjIGRlZiBnZXRBY2Nlc3NUb2tlbihjdXJVc2VyLCBjdXJQYXNzKToKICAgICMgICAgIGRlZiBpc05vdFRva2VuKGNvbnRlbnQpOgogICAgIyAgICAgICAgIHJldHVybiBub3QgcmUubWF0Y2gocideW2EtejAtOV17NDB9JCcsIGNvbnRlbnQpCiAgICAjICAgICAjIGRlZiBjcmVhdGVUb2tlbkZyb21QYXNzKHVzZXIsIHBhc3N3b3JkKToKICAgICMgICAgICMgICAgIHBhcmFtcyA9IHsKICAgICMgICAgICMgICAgICAgICAic2NvcGVzIjogWyJyZXBvIiwgIndyaXRlOm9yZyJdLAogICAgIyAgICAgIyAgICAgICAgICJub3RlIjogIk1hcHBpYSBBY2Nlc3MgKCIgKyBzdHIocmFuZG9tLnVuaWZvcm0oMCwgMSkgKiAxMDAwMDApICsgIikiCiAgICAjICAgICAjICAgICB9CiAgICAjICAgICAjICAgICByZXNwID0gcmVxdWVzdHMucG9zdCh1cmw9R2l0SHViLmdpdGh1YkFwaSArICdhdXRob3JpemF0aW9ucycsIGhlYWRlcnM9eydjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbid9LCBhdXRoPSh1c2VyLCBwYXNzd29yZCksIGRhdGE9anNvbi5kdW1wcyhwYXJhbXMpKQogICAgIyAgICAgIyAgICAgaWYgcmVzcC5zdGF0dXNfY29kZSA9PSBIVFRQU3RhdHVzLkNSRUFURUQ6CiAgICAjICAgICAjICAgICAgICAgcmV0dXJuIGpzb24ubG9hZHMocmVzcC50ZXh0KVsidG9rZW4iXQogICAgIyAgICAgIyAgICAgZWxpZiByZXNwLnN0YXR1c19jb2RlID09IEhUVFBTdGF0dXMuVU5QUk9DRVNTQUJMRV9FTlRJVFk6CiAgICAjICAgICAjICAgICAgICAgI2RldmVyaWEgdGVudGFyIG1haXMgdW1hIHZlegogICAgIyAgICAgIyAgICAgICAgIHJldHVybiBOb25lCiAgICAjICAgICAjICAgICBlbGlmIHJlc3Auc3RhdHVzX2NvZGUgPT0gSFRUUFN0YXR1cy5VTkFVVEhPUklaRUQ6CiAgICAjICAgICAjICAgICAgICAgUU1lc3NhZ2VCb3gud2FybmluZyhOb25lLCAiTWFwcGlhIFB1Ymxpc2hlciBFcnJvciIsICJGYWlsZWQgdG8gbG9naW4sIHBsZWFzZSBjaGVjayBpZiB0aGUgZW50ZXJlZCB1c2VybmFtZS9wYXNzd29yZCBpcyB2YWxpZCBhdCAoaHR0cHM6Ly9naXRodWIuY29tL2xvZ2luKSIpCiAgICAjICAgICAjICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJFcnJvcjogRmFpbGVkIHRvIGxvZ2luLCBwbGVhc2UgVmVyaWZ5IHRoZSBlbnRlcmVkIHVzZXJuYW1lL3Bhc3N3b3JkLiIpCiAgICAjICAgICAjICAgICBlbHNlOgogICAgIyAgICAgIyAgICAgICAgIFFNZXNzYWdlQm94Lndhcm5pbmcoTm9uZSwgIk1hcHBpYSBQdWJsaXNoZXIgRXJyb3IiLCAiRmFpbGVkIHRvIGNyZWF0ZSBhIG5ldyB0b2tlbi4gUmVzcG9uc2UgY29kZTogIiArIHN0cihyZXNwLnN0YXR1c19jb2RlKSArICIgQ29udGVudDogIiArIHN0cihyZXNwLnRleHQpKQogICAgIyAgICAgIyAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiRXJyb3I6IEZhaWxlZCB0byBjcmVhdGUgdG9rZW4uIFJlc3BvbnNlIGNvZGU6ICIgKyBzdHIocmVzcC5zdGF0dXNfY29kZSkgKyAiIENvbnRlbnQ6ICIgKyBzdHIocmVzcC50ZXh0KSkKICAgICMgICAgIGZvdW5kVG9rZW4gPSBOb25lCiAgICAjICAgICBpZiBub3QgR2l0SHViLnRlc3RMb2dpbihjdXJVc2VyLCBjdXJQYXNzKToKICAgICMgICAgICAgICBRTWVzc2FnZUJveC53YXJuaW5nKE5vbmUsICJNYXBwaWEgUHVibGlzaGVyIEVycm9yIiwKICAgICMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJGYWlsZWQgdG8gbG9naW4sIHBsZWFzZSBjaGVjayBpZiB0aGUgZW50ZXJlZCB1c2VybmFtZS9wYXNzd29yZCBpcyB2YWxpZCBhdCAoaHR0cHM6Ly9naXRodWIuY29tL2xvZ2luKSIpCiAgICAjICAgICAgICAgRXhjZXB0aW9uKCJFcnJvcjogRmFpbGVkIHRvIGxvZ2luLiIpCiAgICAjICAgICAgICAgZm91bmRUb2tlbiA9IE5vbmUKICAgICMgICAgIGVsaWYgbm90IGlzTm90VG9rZW4oY3VyUGFzcykgYW5kIEdpdEh1Yi50ZXN0TG9naW4oY3VyVXNlciwgY3VyUGFzcyk6CiAgICAjICAgICAgICAgZm91bmRUb2tlbiA9IGN1clBhc3MKICAgICMgICAgIGVsaWYgR2l0SHViLnBlcnNvbmFsX3Rva2VuIGFuZCBub3QgaXNOb3RUb2tlbihHaXRIdWIucGVyc29uYWxfdG9rZW4pIGFuZCBHaXRIdWIudGVzdExvZ2luKGN1clVzZXIsIEdpdEh1Yi5wZXJzb25hbF90b2tlbik6CiAgICAjICAgICAgICAgZm91bmRUb2tlbiA9IEdpdEh1Yi5wZXJzb25hbF90b2tlbgogICAgIyAgICAgIyBlbGlmIFFNZXNzYWdlQm94LnF1ZXN0aW9uKE5vbmUsICJLZXkgcmVxdWlyZWQgaW5zdGVhZCBvZiBwYXNzd29yZC4iLCAiV2FudCB0aGUgbWFwcGlhIHRvIGF1dG9tYXRpY2FsbHkgY3JlYXRlIGEga2V5IGZvciB5b3U/IE90aGVyd2lzZSBwbGVhc2UgYWNjZXNzIHRoZSBsaW5rOiBodHRwczovL2dpdGh1Yi5jb20vc2V0dGluZ3MvdG9rZW5zIHRvIGNyZWF0ZSB0aGUga2V5LiIsIGRlZmF1bHRCdXR0b249UU1lc3NhZ2VCb3guWWVzKSA9PSBRTWVzc2FnZUJveC5ZZXM6CiAgICAjICAgICAjICAgICByZXRyaWVzID0gMQogICAgIyAgICAgIyAgICAgdG9rZW4gPSBOb25lCiAgICAjICAgICAjICAgICB3aGlsZSB0b2tlbiBpcyBOb25lIGFuZCByZXRyaWVzIDw9IDU6CiAgICAjICAgICAjICAgICAgICAgdG9rZW4gPSBjcmVhdGVUb2tlbkZyb21QYXNzKGN1clVzZXIsIGN1clBhc3MpCiAgICAjICAgICAjICAgICAgICAgcmV0cmllcyA9IHJldHJpZXMgKyAxCiAgICAjICAgICAjICAgICBpZiB0b2tlbiBpcyBOb25lOgogICAgIyAgICAgIyAgICAgICAgIGlmIFFNZXNzYWdlQm94LnF1ZXN0aW9uKE5vbmUsICJUaGUgdG9rZW4gY3JlYXRpb24gaGF2ZSBmYWlsZWQuIFdhbnQgdG8gb3BlbiB0aGUgY3JlYXRpb24gbGluaz8iLCBkZWZhdWx0QnV0dG9uPVFNZXNzYWdlQm94LlllcykgPT0gUU1lc3NhZ2VCb3guWWVzOgogICAgIyAgICAgIyAgICAgICAgICAgICB3ZWJicm93c2VyLm9wZW5fbmV3KCdodHRwczovL2dpdGh1Yi5jb20vc2V0dGluZ3MvdG9rZW5zJykKICAgICMgICAgICMgICAgICAgICByYWlzZSBFeGNlcHRpb24oIkVycm9yOiBTb21ldGhpbmcgZ29lcyB3cm9uZyBjcmVhdGluZyB0aGUgdG9rZW4uIE9wZW5pbmcgdGhlIGJyb3dzZXIsIHBsZWFzZSBjcmVhdGUgeW91ciB0b2tlbiBtYW51YWxseSBhdCBodHRwczovL2dpdGh1Yi5jb20vc2V0dGluZ3MvdG9rZW5zIGFuZCBlbmFibGUgZW5hYmxlIHRoZSBzY29wZSBncm91cCAncmVwbycuIFBsZWFzZSBjb3B5IHRoZSByZXN1bHRpbmcgdGV4dC4iKQogICAgIyAgICAgIyAgICAgR2l0SHViLnBlcnNvbmFsX3Rva2VuID0gdG9rZW4KICAgICMgICAgICMgICAgIFFNZXNzYWdlQm94Lndhcm5pbmcoTm9uZSwgIkluZm9ybWF0aW9uIiwgIkNyZWF0ZWQgdGhlIGZvbGxvd2luZyB0b2tlbiwgcGxlYXNlIGNvcHkgaXQgdG8gdXNlIGxhdGVyICciICsgdG9rZW4gKyAiJy4iKQogICAgIyAgICAgIyAgICAgZm91bmRUb2tlbiA9IHRva2VuCiAgICAjICAgICBlbHNlOgogICAgIyAgICAgICAgIGZvdW5kVG9rZW4gPSBOb25lCiAgICAjICAgICByZXR1cm4gZm91bmRUb2tlbgoKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgX3JlcXVlc3QoKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICB3aXRoX2F1dGggPSBrd2FyZ3MucG9wKCJ3aXRoX2F1dGgiLCBUcnVlKQogICAgICAgIHRva2VuID0ga3dhcmdzLnBvcCgidG9rZW4iLCAnJykKICAgICAgICBpZiBub3QgdG9rZW46CiAgICAgICAgICAgIHRva2VuID0gb3MuZW52aXJvbi5nZXQoIkdJVEhVQl9UT0tFTiIsIE5vbmUpCiAgICAgICAgaWYgdG9rZW4gYW5kIHdpdGhfYXV0aDoKICAgICAgICAgICAga3dhcmdzWyJhdXRoIl0gPSAodG9rZW4sICd4LW9hdXRoLWJhc2ljJykKICAgICAgICBmb3IgXyBpbiByYW5nZSgzKToKICAgICAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0KCphcmdzLCAqKmt3YXJncykKICAgICAgICAgICAgaXNfdHJhdmlzID0gb3MuZ2V0ZW52KCJUUkFWSVMiLCBOb25lKSBpcyBub3QgTm9uZQogICAgICAgICAgICBpZiBpc190cmF2aXMgYW5kIDQwMCA8PSByZXNwb25zZS5zdGF0dXNfY29kZSA8IDUwMDoKICAgICAgICAgICAgICAgIHByaW50KCJSZXRyeWluZyBpbiAxcyAoJXMgQ2xpZW50IEVycm9yOiAlcyBmb3IgdXJsOiAlcykiICUgKAogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLnN0YXR1c19jb2RlLCByZXNwb25zZS5yZWFzb24sIHJlc3BvbnNlLnVybCkpCiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKDEpCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBicmVhawogICAgICAgIHJldHVybiByZXNwb25zZQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfcmVjdXJzaXZlX2doX2dldChocmVmLCBpdGVtcywgcGFzc3dvcmQ9Tm9uZSk6CiAgICAgICAgIiIiUmVjdXJzaXZlbHkgZ2V0IGxpc3Qgb2YgR2l0SHViIG9iamVjdHMuCgogICAgICAgIFNlZSBodHRwczovL2RldmVsb3Blci5naXRodWIuY29tL3YzL2d1aWRlcy90cmF2ZXJzaW5nLXdpdGgtcGFnaW5hdGlvbi8KICAgICAgICAiIiIKICAgICAgICByZXNwb25zZSA9IEdpdEh1Yi5fcmVxdWVzdCgnR0VUJywgaHJlZiwgdG9rZW49cGFzc3dvcmQpCiAgICAgICAgcmVzcG9uc2UucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgICAgaXRlbXMuZXh0ZW5kKHJlc3BvbnNlLmpzb24oKSkKICAgICAgICBpZiAibGluayIgbm90IGluIHJlc3BvbnNlLmhlYWRlcnM6CiAgICAgICAgICAgIHJldHVybgogICAgICAgICMgbGlua3MgPSBsaW5rX2hlYWRlci5wYXJzZShyZXNwb25zZS5oZWFkZXJzWyJsaW5rIl0pCiAgICAgICAgIyByZWxzID0ge2xpbmsucmVsOiBsaW5rLmhyZWYgZm9yIGxpbmsgaW4gbGlua3MubGlua3N9CiAgICAgICAgIyBpZiAibmV4dCIgaW4gcmVsczoKICAgICAgICAjICAgICBnaFJlbGVhc2UuX3JlY3Vyc2l2ZV9naF9nZXQocmVsc1sibmV4dCJdLCBpdGVtcykKCiAgICAjUmV0dXJuIGEgbGlzdCBvZiBhc3NldHMgaW4gY29tbWl0ICdyZWxlYXNlTmFtZScgd2l0aGluIHRoaXMgcmVwb3NpdG9yeS4KICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRBc3NldHModXNlciwgcmVwb3NpdG9yeSwgcGFzc3dvcmQsIHRhZ05hbWUpOgogICAgICAgIHJlbGVhc2UgPSBHaXRIdWIuZ2V0UmVsZWFzZSh1c2VyLCByZXBvc2l0b3J5LCBwYXNzd29yZCwgdGFnTmFtZSkKICAgICAgICBpZiBub3QgcmVsZWFzZToKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCdSZWxlYXNlIHdpdGggdGFnX25hbWUgezB9IG5vdCBmb3VuZCcuZm9ybWF0KHRhZ05hbWUpKQogICAgICAgIGFzc2V0cyA9IFtdCiAgICAgICAgR2l0SHViLl9yZWN1cnNpdmVfZ2hfZ2V0KEdpdEh1Yi5naXRodWJBcGkgKyAncmVwb3MvezB9L3JlbGVhc2VzL3sxfS9hc3NldHMnLmZvcm1hdCgKICAgICAgICAgICAgdXNlciArICIvIiArIHJlcG9zaXRvcnksIHJlbGVhc2VbImlkIl0pLCBhc3NldHMsIHBhc3N3b3JkKQogICAgICAgIHJldHVybiBhc3NldHMKCiAgICAjSWYgZXhpc3RzIGdldCB0aGUgcmVsZWFzZSB3aXRoIG5hbWUgJ3JlbGVhc2VOYW1lJy4KICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRSZWxlYXNlKHVzZXIsIHJlcG9zaXRvcnksIHBhc3N3b3JkLCB0YWdOYW1lKToKICAgICAgICBkZWYgX2dldFJlbGVhc2UoaHJlZiwgcGFzc3dvcmQsIHRhZ05hbWUpOgogICAgICAgICAgICByZWxlYXNlUmVzcCA9IEdpdEh1Yi5fcmVxdWVzdCgnR0VUJywgaHJlZiwgdG9rZW49cGFzc3dvcmQpCiAgICAgICAgICAgIHJlbGVhc2VSZXNwLnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICAgICAgICByZXN1bHQgPSBOb25lCiAgICAgICAgICAgIGZvciBjdXJSZXNwIGluIHJlbGVhc2VSZXNwLmpzb24oKToKICAgICAgICAgICAgICAgIGlmIChjdXJSZXNwIGFuZCAoY3VyUmVzcFsndGFnX25hbWUnXSA9PSB0YWdOYW1lKSk6CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gY3VyUmVzcAogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGlmIHJlc3VsdCBpcyBOb25lIGFuZCAnbGluaycgaW4gcmVsZWFzZVJlc3AuaGVhZGVyczoKICAgICAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiUGxlYXNlIHJlcG9ydDogbm90IGltcGxlbWVudGVkIHlldC4iICsganNvbi5kdW1wcyhyZWxlYXNlUmVzcC5oZWFkZXJzWyJsaW5rIl0pKQogICAgICAgICMgaWYgJ2xpbmsnIGluIHJlbGVhc2VSZXNwLmhlYWRlcnM6ICNEYW5pbG8gcHJlY2lzYSBpbXBsZW1lbnRhciBhaW5kYQogICAgICAgICNhZGQgcmVzcCB0byBjdXJSZXNwLgogICAgICAgICMgICAgICMgbGlua3MgPSBsaW5rX2hlYWRlci5wYXJzZShyZXNwb25zZS5oZWFkZXJzWyJsaW5rIl0pCiAgICAgICAgIyAgICAgIyByZWxzID0ge2xpbmsucmVsOiBsaW5rLmhyZWYgZm9yIGxpbmsgaW4gbGlua3MubGlua3N9CiAgICAgICAgIyAgICAgIyBpZiAibmV4dCIgaW4gcmVsczoKICAgICAgICAjICAgICAjICAgICBnaFJlbGVhc2UuX3JlY3Vyc2l2ZV9naF9nZXQocmVsc1sibmV4dCJdLCBpdGVtcywgdG9rZW4pCiAgICAgICAgIyAgICAgIyBEYW5pbG8gcHJlY2lzbyBmYXplciBvIHBhcnNlCiAgICAgICAgICAgIHJldHVybiByZXN1bHQKICAgICAgICByZXR1cm4gX2dldFJlbGVhc2UoR2l0SHViLmdpdGh1YkFwaSArICdyZXBvcy8nICsgdXNlciArICIvIiArIHJlcG9zaXRvcnkgKyAiL3JlbGVhc2VzIiwgcGFzc3dvcmQsIHRhZ05hbWUpCgogICAgI0NyZWF0ZSB0aGUgZG93bmxvYWQgdGFnIG9yIHJlcG9ydCBhIGVycm9yLgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGNyZWF0ZURvd25sb2FkVGFnKHVzZXIsIHJlcG9zaXRvcnksIHBhc3N3b3JkLCBmZWVkYmFjayk6CiAgICAgICAgZGF0YSA9IHsKICAgICAgICAgICAgJ3RhZ19uYW1lJzogR2l0SHViLnJlbGVhc2VOYW1lLAogICAgICAgICAgICAnbmFtZSc6IEdpdEh1Yi5yZWxlYXNlTmFtZSwKICAgICAgICAgICAgJ2JvZHknOiBHaXRIdWIucmVsZWFzZU5hbWUsCiAgICAgICAgICAgICdkcmFmdCc6IEZhbHNlLAogICAgICAgICAgICAncHJlcmVsZWFzZSc6IEZhbHNlCiAgICAgICAgfQogICAgICAgIHJlc3BvbnNlID0gR2l0SHViLl9yZXF1ZXN0KCdQT1NUJywgR2l0SHViLmdpdGh1YkFwaSArICdyZXBvcy8nICsgdXNlciArICIvIiArIHJlcG9zaXRvcnkgKyAiL3JlbGVhc2VzIiwgdG9rZW49cGFzc3dvcmQsIGRhdGE9anNvbi5kdW1wcyhkYXRhKSwgaGVhZGVycz17J0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ30pCiAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDQyMikgYW5kIEdpdEh1Yi5nZXRSZWxlYXNlKHVzZXIsIHJlcG9zaXRvcnksIHBhc3N3b3JkLCBHaXRIdWIucmVsZWFzZU5hbWUpIGlzIG5vdCBOb25lOiAjdm91IGNvbnNpZGVyYXIgcSBqYSBlc3TDoSBjcmlhZG8KICAgICAgICAgICAgcGFzcwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJlc3BvbnNlLnJhaXNlX2Zvcl9zdGF0dXMoKQoKICAgICNUcnkgdG8gYWRkIHRoZSAndXBsb2FkRmlsZScgYXMgYSBsYXllciBhc3NldC4KICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBhZGRSZWxlYXNlRmlsZSh1c2VyLCBwYXNzd29yZCwgcmVwb3NpdG9yeSwgbWF4UmV0cnksIGZvcmNlVXBkYXRlRmlsZSwgdXBsb2FkRmlsZSwgbGF5ZXIsIGZlZWRiYWNrKToKICAgICAgICBpZiB1cGxvYWRGaWxlIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgcmVsZWFzZVJlZiA9IEdpdEh1Yi5nZXRSZWxlYXNlKHVzZXIsIHJlcG9zaXRvcnksIHBhc3N3b3JkLCBHaXRIdWIucmVsZWFzZU5hbWUpCgogICAgICAgIGlmIHJlbGVhc2VSZWYgaXMgTm9uZSBvciByZWxlYXNlUmVmWyd1cGxvYWRfdXJsJ10gaXMgTm9uZToKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJSZWxlYXNlICciICsgR2l0SHViLnJlbGVhc2VOYW1lICsgIicgd2FzIG5vdCBmb3VuZCIpCiAgICAgICAgYXNzZXRzID0gR2l0SHViLmdldEFzc2V0cyh1c2VyLCByZXBvc2l0b3J5LCBwYXNzd29yZCwgR2l0SHViLnJlbGVhc2VOYW1lKQogICAgICAgIHVwbG9hZFVybCA9IHJlbGVhc2VSZWZbJ3VwbG9hZF91cmwnXQogICAgICAgIGlmICJ7IiBpbiB1cGxvYWRVcmw6CiAgICAgICAgICAgIHVwbG9hZFVybCA9IHVwbG9hZFVybFs6dXBsb2FkVXJsLmluZGV4KCJ7IildCiAgICAgICAgYmFzZW5hbWUgPSBVVElMUy5ub3JtYWxpemVOYW1lKG9zLnBhdGguYmFzZW5hbWUobGF5ZXIubmFtZSgpKSkgKyBzdHIob3MucGF0aC5zcGxpdGV4dCh1cGxvYWRGaWxlKVsxXSkKICAgICAgICAjRXhhbXBsZTogIydodHRwczovL2dpdGh1Yi5jb20vYXNmaXhpYS9NYXBwaWFfRXhhbXBsZV90L3JlbGVhc2VzL2Rvd25sb2FkL01hcF9Eb3dubG9hZC9kaXN0YW5jZV90b19kZWZvcmVzdGVkLnRpZicKICAgICAgICBmaWxlRG93bmxvYWRQYXRoID0gJ2h0dHBzOi8vZ2l0aHViLmNvbS8nICsgdXNlciArICIvIiArIHJlcG9zaXRvcnkgKyAiL3JlbGVhc2VzL2Rvd25sb2FkLyIgKyBHaXRIdWIucmVsZWFzZU5hbWUgKyAiLyIgKyBiYXNlbmFtZQoKICAgICAgICBmb3IgYXNzZXQgaW4gYXNzZXRzOgogICAgICAgICAgICBpZiBhc3NldFsibmFtZSJdID09IGJhc2VuYW1lOgogICAgICAgICAgICAgICAgIyBTZWUgaHR0cHM6Ly9kZXZlbG9wZXIuZ2l0aHViLmNvbS92My9yZXBvcy9yZWxlYXNlcy8jcmVzcG9uc2UtZm9yLXVwc3RyZWFtLWZhaWx1cmUgICMgbm9xYTogRTUwMQogICAgICAgICAgICAgICAgaWYgYXNzZXRbInN0YXRlIl0gPT0gIm5ldyIgb3IgYXNzZXRbInN0YXRlIl0gPT0gInVwbG9hZGVkIjogI292ZXJyaWRlIHRoZSBvbGQgZmlsZSBpZiBsYXN0IHVwbG9hZCBmYWlsZWQgb3IgdXBkYXRlIGlmICdmb3JjZVVwZGF0ZUZpbGUnIGlzIHRydWUuCiAgICAgICAgICAgICAgICAgICAgaWYgYXNzZXRbInN0YXRlIl0gPT0gInVwbG9hZGVkIiBhbmQgbm90IGZvcmNlVXBkYXRlRmlsZToKICAgICAgICAgICAgICAgICAgICAgICAgZmVlZGJhY2suc2V0UHJvZ3Jlc3NUZXh0KCJGaWxlICVzIGFscmVhZHkgdXBsb2FkZWQuIiAlIGFzc2V0WyduYW1lJ10pCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmaWxlRG93bmxvYWRQYXRoCiAgICAgICAgICAgICAgICAgICAgaWYgYXNzZXRbInN0YXRlIl0gPT0gIm5ldyI6CiAgICAgICAgICAgICAgICAgICAgICAgIGZlZWRiYWNrLnNldFByb2dyZXNzVGV4dCgiICBkZWxldGluZyAlcyAoaW52YWxpZCBhc3NldCAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ3aXRoIHN0YXRlIHNldCB0byAnbmV3JykiICUgYXNzZXRbJ25hbWUnXSkKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBmZWVkYmFjay5zZXRQcm9ncmVzc1RleHQoIlVwZGF0aW5nIGZpbGUgJXMuIiAlIGFzc2V0WyduYW1lJ10pCiAgICAgICAgICAgICAgICAgICAgdXJsID0gKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgR2l0SHViLmdpdGh1YkFwaQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKyAncmVwb3MvezB9L3JlbGVhc2VzL2Fzc2V0cy97MX0nLmZvcm1hdCh1c2VyICsgIi8iICsgcmVwb3NpdG9yeSwgYXNzZXRbJ2lkJ10pCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gR2l0SHViLl9yZXF1ZXN0KCdERUxFVEUnLCB1cmwsIHRva2VuPXBhc3N3b3JkKQogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLnJhaXNlX2Zvcl9zdGF0dXMoKQoKICAgICAgICBmaWxlX3NpemUgPSBvcy5wYXRoLmdldHNpemUodXBsb2FkRmlsZSkKICAgICAgICBmZWVkYmFjay5zZXRQcm9ncmVzc1RleHQoIiAgVXBsb2FkaW5nICVzIG9mIHNpemUgJXMgKE1CKSIgJSAoYmFzZW5hbWUsIHN0cihmaWxlX3NpemUgLyAxMGU1KSkpCgogICAgICAgIHVybCA9ICd7MH0/bmFtZT17MX0nLmZvcm1hdCh1cGxvYWRVcmwsIGJhc2VuYW1lKQoKICAgICAgICAjIEF0dGVtcHQgdXBsb2FkCiAgICAgICAgd2l0aCBvcGVuKHVwbG9hZEZpbGUsICdyYicpIGFzIGY6CiAgICAgICAgICAgIHdpdGggcHJvZ3Jlc3NfcmVwb3J0ZXJfY2xzKAogICAgICAgICAgICAgICAgICAgIGxhYmVsPWJhc2VuYW1lLCBsZW5ndGg9ZmlsZV9zaXplLCBmZWVkYmFjaz1mZWVkYmFjaykgYXMgcmVwb3J0ZXI6CiAgICAgICAgICAgICAgICByZXNwb25zZSA9IEdpdEh1Yi5fcmVxdWVzdCgKICAgICAgICAgICAgICAgICAgICAnUE9TVCcsIHVybCwgaGVhZGVycz17J0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nfSwKICAgICAgICAgICAgICAgICAgICBkYXRhPV9Qcm9ncmVzc0ZpbGVSZWFkZXIoZiwgcmVwb3J0ZXIpLCB0b2tlbj1wYXNzd29yZCkKICAgICAgICAgICAgICAgIGRhdGEgPSByZXNwb25zZS5qc29uKCkKCiAgICAgICAgaWYgcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPT0gNTAyIGFuZCBtYXhSZXRyeSA+IDE6CiAgICAgICAgICAgIGZlZWRiYWNrLnNldFByb2dyZXNzVGV4dCgiUmV0cnlpbmcgKHVwbG9hZCBmYWlsZWQgd2l0aCBzdGF0dXNfY29kZT01MDIpIikKICAgICAgICAgICAgcmV0dXJuIEdpdEh1Yi5hZGRSZWxlYXNlRmlsZSh1c2VyLCBwYXNzd29yZCwgcmVwb3NpdG9yeSwgbWF4UmV0cnkgLSAxLCBmb3JjZVVwZGF0ZUZpbGUsIHVwbG9hZEZpbGUsIGxheWVyLCBmZWVkYmFjaykKICAgICAgICBlbGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDUwMiBhbmQgbWF4UmV0cnkgPD0gMToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXNwb25zZS5yYWlzZV9mb3Jfc3RhdHVzKCkKICAgICAgICByZXR1cm4gZmlsZURvd25sb2FkUGF0aAoKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIEFVWCBDTEFTUyAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwoKY2xhc3MgcHJvZ3Jlc3NfcmVwb3J0ZXJfY2xzKG9iamVjdCk6CiAgICByZXBvcnRQcm9ncmVzcyA9IEZhbHNlCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGxhYmVsPScnLCBsZW5ndGg9MCwgZmVlZGJhY2s9Tm9uZSk6CiAgICAgICAgc2VsZi5sYWJlbCA9IGxhYmVsCiAgICAgICAgc2VsZi5sZW5ndGggPSBsZW5ndGgKICAgICAgICBzZWxmLnRvdGFsID0gMAogICAgICAgIHNlbGYubGFzdFJlcG9ydCA9IDAKICAgICAgICBzZWxmLmZlZWRiYWNrID0gZmVlZGJhY2sKCiAgICBkZWYgdXBkYXRlKHNlbGYsIGNodW5rX3NpemUpOgogICAgICAgIHNlbGYudG90YWwgPSBzZWxmLnRvdGFsICsgY2h1bmtfc2l6ZQogICAgICAgIGlmIHNlbGYuZmVlZGJhY2sgaXMgbm90IE5vbmUgYW5kIHNlbGYudG90YWwgPiAoc2VsZi5sYXN0UmVwb3J0ICsgKHNlbGYubGVuZ3RoICogMC4xKSk6CiAgICAgICAgICAgIHNlbGYuZmVlZGJhY2suc2V0UHJvZ3Jlc3NUZXh0KCdUb3RhbDogJyArIHN0cihzZWxmLnRvdGFsIC8gMTAwMCkgKyAiIChrYikiKQogICAgICAgICAgICBzZWxmLmxhc3RSZXBvcnQgPSBzZWxmLnRvdGFsCiAgICAgICAgcGFzcwoKICAgIGRlZiBfX2VudGVyX18oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYKCiAgICBkZWYgX19leGl0X18oc2VsZiwgZXhjX3R5cGUsIGV4Y192YWx1ZSwgdGIpOgogICAgICAgIHBhc3MKCiNXcmFwcGVyIHVzZWQgdG8gY2FwdHVyZSBGaWxlIElPIHJlYWQgcHJvZ3Jlc3MuCmNsYXNzIF9Qcm9ncmVzc0ZpbGVSZWFkZXIob2JqZWN0KToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBzdHJlYW0sIHJlcG9ydGVyKToKICAgICAgICBzZWxmLl9zdHJlYW0gPSBzdHJlYW0KICAgICAgICBzZWxmLl9yZXBvcnRlciA9IHJlcG9ydGVyCgogICAgZGVmIHJlYWQoc2VsZiwgX3NpemUpOgogICAgICAgIF9jaHVuayA9IHNlbGYuX3N0cmVhbS5yZWFkKF9zaXplKQogICAgICAgIHNlbGYuX3JlcG9ydGVyLnVwZGF0ZShsZW4oX2NodW5rKSkKICAgICAgICByZXR1cm4gX2NodW5rCgogICAgZGVmIF9fZ2V0YXR0cl9fKHNlbGYsIGF0dHIpOgogICAgICAgIHJldHVybiBnZXRhdHRyKHNlbGYuX3N0cmVhbSwgYXR0cikKCmNsYXNzIEN1c3RvbU1lc3NhZ2VCb3goUU1lc3NhZ2VCb3gpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsICpfX2FyZ3MpOgogICAgICAgIFFNZXNzYWdlQm94Ll9faW5pdF9fKHNlbGYpCiAgICAgICAgc2VsZi50aW1lb3V0ID0gMAogICAgICAgIHNlbGYuY2FsbGJhY2sgPSBOb25lCiAgICAgICAgc2VsZi5jdXJyZW50VGltZSA9IDAKCiAgICBkZWYgc2hvd0V2ZW50KHNlbGYsIFFTaG93RXZlbnQpOgogICAgICAgIHNlbGYuY3VycmVudFRpbWUgPSAwCiAgICAgICAgaWYgc2VsZi5hdXRvY2xvc2U6CiAgICAgICAgICAgIHNlbGYuc3RhcnRUaW1lcihzZWxmLnRpbWVvdXQpCgogICAgZGVmIHRpbWVyRXZlbnQoc2VsZiwgZXZlbnQpOgogICAgICAgICMgdHJ5OgogICAgICAgIGlmIHNlbGYuaXNIaWRkZW4oKToKICAgICAgICAgICAgc2VsZi5raWxsVGltZXIoZXZlbnQudGltZXJJZCgpKQogICAgICAgICAgICBzZWxmLmRlbGV0ZUxheWVyKCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmN1cnJlbnRUaW1lICs9IDEKICAgICAgICAgICAgc2VsZi5jYWxsYmFjayhzZWxmLCBzZWxmLmN1cnJlbnRUaW1lKQogICAgICAgICMgZXhjZXB0OgogICAgICAgICMgICAgIHNlbGYucXVpdCgpCiAgICAgICAgIyBpZiBzZWxmLmN1cnJlbnRUaW1lID49IHNlbGYudGltZW91dDoKICAgICAgICAjICAgICBzZWxmLmRvbmUoMCkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgc2hvd1dpdGhDYWxsYmFjayh0aW1lb3V0TXNDYWxsYmFjaywgbWVzc2FnZSwgdGl0bGUsIGNhbGxiYWNrLCBpY29uPVFNZXNzYWdlQm94LkluZm9ybWF0aW9uLCBidXR0b25zPVFNZXNzYWdlQm94Lk9rKToKICAgICAgICB3ID0gQ3VzdG9tTWVzc2FnZUJveCgpCiAgICAgICAgdy5hdXRvY2xvc2UgPSBUcnVlCiAgICAgICAgdy5jYWxsYmFjayA9IGNhbGxiYWNrCiAgICAgICAgdy50aW1lb3V0ID0gdGltZW91dE1zQ2FsbGJhY2sKICAgICAgICB3LnNldFRleHQobWVzc2FnZSkKICAgICAgICB3LnNldFdpbmRvd1RpdGxlKHRpdGxlKQogICAgICAgIHcuc2V0SWNvbihpY29uKQogICAgICAgIHcuc2V0U3RhbmRhcmRCdXR0b25zKGJ1dHRvbnMpCiAgICAgICAgcmV0dXJuIHcuZXhlY18oKQoKY2xhc3MgR2l0SW50ZXJhY3RpdmUoKSA6CgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGNsb25lUmVwbyh1c2VyLCByZXBvc2l0b3J5LCBmb2xkZXIsIGZlZWRiYWNrKToKICAgICAgICBmcm9tIGdpdCBpbXBvcnQgUmVwbwogICAgICAgIHJldHVybiBVVElMUy5ydW5Mb25nVGFzayhSZXBvLmNsb25lX2Zyb20sIGZlZWRiYWNrLCB3YWl0TWVzc2FnZT0iUGxlYXNlIHdhaXQgdG8gY29tcGxldGUgdGhlIGRvd25sb2FkLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Vjb25kc1JlcG9ydD0xNSwgdXJsPUdpdEh1Yi5nZXRHaXRVcmwodXNlciwgcmVwb3NpdG9yeSksIHRvX3BhdGg9Zm9sZGVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZT1UcnVlKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBwdXNoQ2hhbmdlcyhyZXBvLCB1c2VyLCByZXBvc2l0b3J5LCBwYXNzd29yZCwgZmVlZGJhY2spOgogICAgICAgIHJldHVybiBVVElMUy5ydW5Mb25nVGFzayhyZXBvLmdpdC5wdXNoLCBmZWVkYmFjaywgJ1BsZWFzZSB3YWl0LCB1cGxvYWRpbmcgY2hhbmdlcy4nLCAzMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgR2l0SHViLmdldEdpdFBhc3NVcmwodXNlciwgcmVwb3NpdG9yeSwgcGFzc3dvcmQpLCAibWFzdGVyOnJlZnMvaGVhZHMvbWFzdGVyIikKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2l0Q29tbWl0KHJlcG8sIG1zZywgZmVlZGJhY2spOgogICAgICAgIHJldHVybiBVVElMUy5ydW5Mb25nVGFzayhyZXBvLmdpdC5jb21taXQsIGZlZWRiYWNrLCAnUGxlYXNlIHdhaXQsIHVwbG9hZGluZyBjaGFuZ2VzLicsIDMwLCBtPW1zZykKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgYWRkRmlsZXMocmVwbywgdXNlciwgcmVwb3NpdG9yeSwgZmVlZGJhY2spOgogICAgICAgIG9yaWdpbk5hbWUgPSAibWFwcGlhIgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVwby5naXQucmVtb3RlKCJhZGQiLCBvcmlnaW5OYW1lLCBHaXRIdWIuZ2V0R2l0VXJsKHVzZXIsIHJlcG9zaXRvcnkpKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcmVwby5naXQucmVtb3RlKCJzZXQtdXJsIiwgb3JpZ2luTmFtZSwgR2l0SHViLmdldEdpdFVybCh1c2VyLCByZXBvc2l0b3J5KSkKICAgICAgICByZXR1cm4gVVRJTFMucnVuTG9uZ1Rhc2socmVwby5naXQuYWRkLCBmZWVkYmFjaywgd2FpdE1lc3NhZ2U9J1BsZWFzZSB3YWl0LCBpZGVudGlmeWluZyBjaGFuZ2VzIG9uIHlvdXIgcmVwb3NpdG9yeS4nLCBzZWNvbmRzUmVwb3J0PTMwLCBhbGw9VHJ1ZSkgIyBBZGljaW9uYSB0b2RvcyBhcnF1aXZvcwoKCnRyeToKICAgIGZyb20gRmVlZGJhY2sgaW1wb3J0IEZlZWRiYWNrCmV4Y2VwdDoKICAgIHBhc3MgI05vdCBpbiBEaW5hbWljYSBDb2RlCgpjbGFzcyBGZWVkYmFjaygpOgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHB1c2hDb25zb2xlSW5mbyhtZXNzYWdlKToKICAgICAgICBwcmludChtZXNzYWdlKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBzZXRQcm9ncmVzcyhwZXJjZW50YWdlKToKICAgICAgICBwcmludCgiUHJvZ3Jlc3M6ICIgKyBzdHIocGVyY2VudGFnZSkpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHNldFByb2dyZXNzVGV4dChtZXNzYWdlKToKICAgICAgICBwcmludChtZXNzYWdlKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBpc0NhbmNlbGVkKCk6CiAgICAgICAgcmV0dXJuIEZhbHNlCgoKCgoKdHJ5OgogICAgZnJvbSBnZGFsMnRpbGVzX2xvY2FsIGltcG9ydCBnZW5lcmF0ZVRpbGVGb3JNYXAKZXhjZXB0OgogICAgcGFzcyAjTm90IGluIERpbmFtaWNhIENvZGUKCiMhL3Vzci9iaW4vZW52IHB5dGhvbgojIC0qLSBjb2Rpbmc6IHV0Zi04IC0qLQojICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgojICAkSWQkCiMKIyBQcm9qZWN0OiAgR29vZ2xlIFN1bW1lciBvZiBDb2RlIDIwMDcsIDIwMDggKGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vc29jLykKIyBTdXBwb3J0OiAgQlJHTSAoaHR0cDovL3d3dy5icmdtLmZyKQojIFB1cnBvc2U6ICBDb252ZXJ0IGEgcmFzdGVyIGludG8gVE1TIChUaWxlIE1hcCBTZXJ2aWNlKSB0aWxlcyBpbiBhIGRpcmVjdG9yeS4KIyAgICAgICAgICAgLSBnZW5lcmF0ZSBHb29nbGUgRWFydGggbWV0YWRhdGEgKEtNTCBTdXBlck92ZXJsYXkpCiMgICAgICAgICAgIC0gZ2VuZXJhdGUgc2ltcGxlIEhUTUwgdmlld2VyIGJhc2VkIG9uIEdvb2dsZSBNYXBzIGFuZCBPcGVuTGF5ZXJzCiMgICAgICAgICAgIC0gc3VwcG9ydCBvZiBnbG9iYWwgdGlsZXMgKFNwaGVyaWNhbCBNZXJjYXRvcikgZm9yIGNvbXBhdGliaWxpdHkKIyAgICAgICAgICAgICAgIHdpdGggaW50ZXJhY3RpdmUgd2ViIG1hcHMgYSBsYSBHb29nbGUgTWFwcwojIEF1dGhvcjogICBLbG9rYW4gUGV0ciBQcmlkYWwsIGtsb2thbiBhdCBrbG9rYW4gZG90IGN6CiMgV2ViOiAgICAgIGh0dHA6Ly93d3cua2xva2FuLmN6L3Byb2plY3RzL2dkYWwydGlsZXMvCiMgR1VJOiAgICAgIGh0dHA6Ly93d3cubWFwdGlsZXIub3JnLwojCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyBDb3B5cmlnaHQgKGMpIDIwMDgsIEtsb2thbiBQZXRyIFByaWRhbAojIENvcHlyaWdodCAoYykgMjAxMC0yMDEzLCBFdmVuIFJvdWF1bHQgPGV2ZW4gZG90IHJvdWF1bHQgYXQgbWluZXMtcGFyaXMgZG90IG9yZz4KIwojICBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQojICBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLAojICB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uCiMgIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLAojICBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUKIyAgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKIwojICBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAojICBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KIwojICBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwojICBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKIyAgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwKIyAgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKIyAgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcKIyAgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUgojICBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiMgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCgoKCmltcG9ydCBtYXRoCmZyb20gbXVsdGlwcm9jZXNzaW5nIGltcG9ydCBQaXBlLCBQb29sLCBQcm9jZXNzLCBNYW5hZ2VyCmltcG9ydCBvcwppbXBvcnQgdGVtcGZpbGUKaW1wb3J0IHNodXRpbAppbXBvcnQgc3lzCmltcG9ydCB0aW1lCmZyb20gdXVpZCBpbXBvcnQgdXVpZDQKZnJvbSB4bWwuZXRyZWUgaW1wb3J0IEVsZW1lbnRUcmVlCgpmcm9tIG9zZ2VvIGltcG9ydCBnZGFsCmZyb20gb3NnZW8gaW1wb3J0IG9zcgoKdHJ5OgogICAgZnJvbSBjb2xvcml6ZV9yZ2IgaW1wb3J0IGFwcGx5TGVnZW5kCmV4Y2VwdDoKICAgIHBhc3MgI05vdCBpbiBEaW5hbWljYSBDb2RlCgp0cnk6CiAgICBmcm9tIFBJTCBpbXBvcnQgSW1hZ2UKICAgIGltcG9ydCBudW1weQogICAgaW1wb3J0IG9zZ2VvLmdkYWxfYXJyYXkgYXMgZ2RhbGFycmF5CmV4Y2VwdCBFeGNlcHRpb246CiAgICAjICdhbnRpYWxpYXMnIHJlc2FtcGxpbmcgaXMgbm90IGF2YWlsYWJsZQogICAgcGFzcwoKX192ZXJzaW9uX18gPSAiJElkJCIKCnJlc2FtcGxpbmdfbGlzdCA9ICgnYXZlcmFnZScsICduZWFyJywgJ2JpbGluZWFyJywgJ2N1YmljJywgJ2N1Ymljc3BsaW5lJywgJ2xhbmN6b3MnLCAgJ2FudGlhbGlhcycpCnByb2ZpbGVfbGlzdCA9ICgnbWVyY2F0b3InLCAnZ2VvZGV0aWMnLCAncmFzdGVyJykKd2Vidmlld2VyX2xpc3QgPSAoJ2FsbCcsICdnb29nbGUnLCAnb3BlbmxheWVycycsICdsZWFmbGV0JywgJ25vbmUnKQoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KCl9fZG9jX19nbG9iYWxtYXB0aWxlcyA9ICIiIgpnbG9iYWxtYXB0aWxlcy5weQoKR2xvYmFsIE1hcCBUaWxlcyBhcyBkZWZpbmVkIGluIFRpbGUgTWFwIFNlcnZpY2UgKFRNUykgUHJvZmlsZXMKPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KCkZ1bmN0aW9ucyBuZWNlc3NhcnkgZm9yIGdlbmVyYXRpb24gb2YgZ2xvYmFsIHRpbGVzIHVzZWQgb24gdGhlIHdlYi4KSXQgY29udGFpbnMgY2xhc3NlcyBpbXBsZW1lbnRpbmcgY29vcmRpbmF0ZSBjb252ZXJzaW9ucyBmb3I6CgogIC0gR2xvYmFsTWVyY2F0b3IgKGJhc2VkIG9uIEVQU0c6Mzg1NykKICAgICAgIGZvciBHb29nbGUgTWFwcywgWWFob28gTWFwcywgQmluZyBNYXBzIGNvbXBhdGlibGUgdGlsZXMKICAtIEdsb2JhbEdlb2RldGljIChiYXNlZCBvbiBFUFNHOjQzMjYpCiAgICAgICBmb3IgT3BlbkxheWVycyBCYXNlIE1hcCBhbmQgR29vZ2xlIEVhcnRoIGNvbXBhdGlibGUgdGlsZXMKCk1vcmUgaW5mbyBhdDoKCmh0dHA6Ly93aWtpLm9zZ2VvLm9yZy93aWtpL1RpbGVfTWFwX1NlcnZpY2VfU3BlY2lmaWNhdGlvbgpodHRwOi8vd2lraS5vc2dlby5vcmcvd2lraS9XTVNfVGlsaW5nX0NsaWVudF9SZWNvbW1lbmRhdGlvbgpodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvYmIyNTk2ODkuYXNweApodHRwOi8vY29kZS5nb29nbGUuY29tL2FwaXMvbWFwcy9kb2N1bWVudGF0aW9uL292ZXJsYXlzLmh0bWwjR29vZ2xlX01hcHNfQ29vcmRpbmF0ZXMKCkNyZWF0ZWQgYnkgS2xva2FuIFBldHIgUHJpZGFsIG9uIDIwMDgtMDctMDMuCkdvb2dsZSBTdW1tZXIgb2YgQ29kZSAyMDA4LCBwcm9qZWN0IEdEQUwyVGlsZXMgZm9yIE9TR0VPLgoKSW4gY2FzZSB5b3UgdXNlIHRoaXMgY2xhc3MgaW4geW91ciBwcm9kdWN0LCB0cmFuc2xhdGUgaXQgdG8gYW5vdGhlciBsYW5ndWFnZQpvciBmaW5kIGl0IHVzZWZ1bCBmb3IgeW91ciBwcm9qZWN0IHBsZWFzZSBsZXQgbWUga25vdy4KTXkgZW1haWw6IGtsb2thbiBhdCBrbG9rYW4gZG90IGN6LgpJIHdvdWxkIGxpa2UgdG8ga25vdyB3aGVyZSBpdCB3YXMgdXNlZC4KCkNsYXNzIGlzIGF2YWlsYWJsZSB1bmRlciB0aGUgb3Blbi1zb3VyY2UgR0RBTCBsaWNlbnNlICh3d3cuZ2RhbC5vcmcpLgoiIiIKCk1BWFpPT01MRVZFTCA9IDMyCgoKY2xhc3MgR2xvYmFsTWVyY2F0b3Iob2JqZWN0KToKICAgIHIiIiIKICAgIFRNUyBHbG9iYWwgTWVyY2F0b3IgUHJvZmlsZQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgogICAgRnVuY3Rpb25zIG5lY2Vzc2FyeSBmb3IgZ2VuZXJhdGlvbiBvZiB0aWxlcyBpbiBTcGhlcmljYWwgTWVyY2F0b3IgcHJvamVjdGlvbiwKICAgIEVQU0c6Mzg1Ny4KCiAgICBTdWNoIHRpbGVzIGFyZSBjb21wYXRpYmxlIHdpdGggR29vZ2xlIE1hcHMsIEJpbmcgTWFwcywgWWFob28gTWFwcywKICAgIFVLIE9yZG5hbmNlIFN1cnZleSBPcGVuU3BhY2UgQVBJLCAuLi4KICAgIGFuZCB5b3UgY2FuIG92ZXJsYXkgdGhlbSBvbiB0b3Agb2YgYmFzZSBtYXBzIG9mIHRob3NlIHdlYiBtYXBwaW5nIGFwcGxpY2F0aW9ucy4KCiAgICBQaXhlbCBhbmQgdGlsZSBjb29yZGluYXRlcyBhcmUgaW4gVE1TIG5vdGF0aW9uIChvcmlnaW4gWzAsMF0gaW4gYm90dG9tLWxlZnQpLgoKICAgIFdoYXQgY29vcmRpbmF0ZSBjb252ZXJzaW9ucyBkbyB3ZSBuZWVkIGZvciBUTVMgR2xvYmFsIE1lcmNhdG9yIHRpbGVzOjoKCiAgICAgICAgIExhdExvbiAgICAgIDwtPiAgICAgICBNZXRlcnMgICAgICA8LT4gICAgIFBpeGVscyAgICA8LT4gICAgICAgVGlsZQoKICAgICBXR1M4NCBjb29yZGluYXRlcyAgIFNwaGVyaWNhbCBNZXJjYXRvciAgUGl4ZWxzIGluIHB5cmFtaWQgIFRpbGVzIGluIHB5cmFtaWQKICAgICAgICAgbGF0L2xvbiAgICAgICAgICAgIFhZIGluIG1ldGVycyAgICAgWFkgcGl4ZWxzIFogem9vbSAgICAgIFhZWiBmcm9tIFRNUwogICAgICAgIEVQU0c6NDMyNiAgICAgICAgICAgRVBTRzozODcKICAgICAgICAgLi0tLS0uICAgICAgICAgICAgICAtLS0tLS0tLS0gICAgICAgICAgICAgICAtLSAgICAgICAgICAgICAgICBUTVMKICAgICAgICAvICAgICAgXCAgICAgPC0+ICAgICB8ICAgICAgIHwgICAgIDwtPiAgICAgLy0tLS0vICAgIDwtPiAgICAgIEdvb2dsZQogICAgICAgIFwgICAgICAvICAgICAgICAgICAgIHwgICAgICAgfCAgICAgICAgICAgLy0tLS0tLS0tLyAgICAgICAgICBRdWFkVHJlZQogICAgICAgICAtLS0tLSAgICAgICAgICAgICAgIC0tLS0tLS0tLSAgICAgICAgIC8tLS0tLS0tLS0tLS0vCiAgICAgICBLTUwsIHB1YmxpYyAgICAgICAgIFdlYk1hcFNlcnZpY2UgICAgICAgICBXZWIgQ2xpZW50cyAgICAgIFRpbGVNYXBTZXJ2aWNlCgogICAgV2hhdCBpcyB0aGUgY29vcmRpbmF0ZSBleHRlbnQgb2YgRWFydGggaW4gRVBTRzozODU3PwoKICAgICAgWy0yMDAzNzUwOC4zNDI3ODkyNDQsIC0yMDAzNzUwOC4zNDI3ODkyNDQsIDIwMDM3NTA4LjM0Mjc4OTI0NCwgMjAwMzc1MDguMzQyNzg5MjQ0XQogICAgICBDb25zdGFudCAyMDAzNzUwOC4zNDI3ODkyNDQgY29tZXMgZnJvbSB0aGUgY2lyY3VtZmVyZW5jZSBvZiB0aGUgRWFydGggaW4gbWV0ZXJzLAogICAgICB3aGljaCBpcyA0MCB0aG91c2FuZCBraWxvbWV0ZXJzLCB0aGUgY29vcmRpbmF0ZSBvcmlnaW4gaXMgaW4gdGhlIG1pZGRsZSBvZiBleHRlbnQuCiAgICAgIEluIGZhY3QgeW91IGNhbiBjYWxjdWxhdGUgdGhlIGNvbnN0YW50IGFzOiAyICogbWF0aC5waSAqIDYzNzgxMzcgLyAyLjAKICAgICAgJCBlY2hvIDE4MCA4NSB8IGdkYWx0cmFuc2Zvcm0gLXNfc3JzIEVQU0c6NDMyNiAtdF9zcnMgRVBTRzozODU3CiAgICAgIFBvbGFyIGFyZWFzIHdpdGggYWJzKGxhdGl0dWRlKSBiaWdnZXIgdGhlbiA4NS4wNTExMjg3OCBhcmUgY2xpcHBlZCBvZmYuCgogICAgV2hhdCBhcmUgem9vbSBsZXZlbCBjb25zdGFudHMgKHBpeGVscy9tZXRlcikgZm9yIHB5cmFtaWQgd2l0aCBFUFNHOjM4NTc/CgogICAgICB3aG9sZSByZWdpb24gaXMgb24gdG9wIG9mIHB5cmFtaWQgKHpvb209MCkgY292ZXJlZCBieSAyNTZ4MjU2IHBpeGVscyB0aWxlLAogICAgICBldmVyeSBsb3dlciB6b29tIGxldmVsIHJlc29sdXRpb24gaXMgYWx3YXlzIGRpdmlkZWQgYnkgdHdvCiAgICAgIGluaXRpYWxSZXNvbHV0aW9uID0gMjAwMzc1MDguMzQyNzg5MjQ0ICogMiAvIDI1NiA9IDE1NjU0My4wMzM5MjgwNDA2MgoKICAgIFdoYXQgaXMgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbiBUTVMgYW5kIEdvb2dsZSBNYXBzL1F1YWRUcmVlIHRpbGUgbmFtZSBjb252ZW50aW9uPwoKICAgICAgVGhlIHRpbGUgcmFzdGVyIGl0c2VsZiBpcyB0aGUgc2FtZSAoZXF1YWwgZXh0ZW50LCBwcm9qZWN0aW9uLCBwaXhlbCBzaXplKSwKICAgICAgdGhlcmUgaXMganVzdCBkaWZmZXJlbnQgaWRlbnRpZmljYXRpb24gb2YgdGhlIHNhbWUgcmFzdGVyIHRpbGUuCiAgICAgIFRpbGVzIGluIFRNUyBhcmUgY291bnRlZCBmcm9tIFswLDBdIGluIHRoZSBib3R0b20tbGVmdCBjb3JuZXIsIGlkIGlzIFhZWi4KICAgICAgR29vZ2xlIHBsYWNlZCB0aGUgb3JpZ2luIFswLDBdIHRvIHRoZSB0b3AtbGVmdCBjb3JuZXIsIHJlZmVyZW5jZSBpcyBYWVouCiAgICAgIE1pY3Jvc29mdCBpcyByZWZlcmVuY2luZyB0aWxlcyBieSBhIFF1YWRUcmVlIG5hbWUsIGRlZmluZWQgb24gdGhlIHdlYnNpdGU6CiAgICAgIGh0dHA6Ly9tc2RuMi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvYmIyNTk2ODkuYXNweAoKICAgIFRoZSBsYXQvbG9uIGNvb3JkaW5hdGVzIGFyZSB1c2luZyBXR1M4NCBkYXR1bSwgeWVzPwoKICAgICAgWWVzLCBhbGwgbGF0L2xvbiB3ZSBhcmUgbWVudGlvbmluZyBzaG91bGQgdXNlIFdHUzg0IEdlb2RldGljIERhdHVtLgogICAgICBXZWxsLCB0aGUgd2ViIGNsaWVudHMgbGlrZSBHb29nbGUgTWFwcyBhcmUgcHJvamVjdGluZyB0aG9zZSBjb29yZGluYXRlcyBieQogICAgICBTcGhlcmljYWwgTWVyY2F0b3IsIHNvIGluIGZhY3QgbGF0L2xvbiBjb29yZGluYXRlcyBvbiBzcGhlcmUgYXJlIHRyZWF0ZWQgYXMgaWYKICAgICAgdGhlIHdlcmUgb24gdGhlIFdHUzg0IGVsbGlwc29pZC4KCiAgICAgIEZyb20gTVNETiBkb2N1bWVudGF0aW9uOgogICAgICBUbyBzaW1wbGlmeSB0aGUgY2FsY3VsYXRpb25zLCB3ZSB1c2UgdGhlIHNwaGVyaWNhbCBmb3JtIG9mIHByb2plY3Rpb24sIG5vdAogICAgICB0aGUgZWxsaXBzb2lkYWwgZm9ybS4gU2luY2UgdGhlIHByb2plY3Rpb24gaXMgdXNlZCBvbmx5IGZvciBtYXAgZGlzcGxheSwKICAgICAgYW5kIG5vdCBmb3IgZGlzcGxheWluZyBudW1lcmljIGNvb3JkaW5hdGVzLCB3ZSBkb24ndCBuZWVkIHRoZSBleHRyYSBwcmVjaXNpb24KICAgICAgb2YgYW4gZWxsaXBzb2lkYWwgcHJvamVjdGlvbi4gVGhlIHNwaGVyaWNhbCBwcm9qZWN0aW9uIGNhdXNlcyBhcHByb3hpbWF0ZWx5CiAgICAgIDAuMzMgcGVyY2VudCBzY2FsZSBkaXN0b3J0aW9uIGluIHRoZSBZIGRpcmVjdGlvbiwgd2hpY2ggaXMgbm90IHZpc3VhbGx5CiAgICAgIG5vdGljZWFibGUuCgogICAgSG93IGRvIEkgY3JlYXRlIGEgcmFzdGVyIGluIEVQU0c6Mzg1NyBhbmQgY29udmVydCBjb29yZGluYXRlcyB3aXRoIFBST0ouND8KCiAgICAgIFlvdSBjYW4gdXNlIHN0YW5kYXJkIEdJUyB0b29scyBsaWtlIGdkYWx3YXJwLCBjczJjcyBvciBnZGFsdHJhbnNmb3JtLgogICAgICBBbGwgb2YgdGhlIHRvb2xzIHN1cHBvcnRzIC10X3NycyAnZXBzZzozODU3Jy4KCiAgICAgIEZvciBvdGhlciBHSVMgcHJvZ3JhbXMgY2hlY2sgdGhlIGV4YWN0IGRlZmluaXRpb24gb2YgdGhlIHByb2plY3Rpb246CiAgICAgIE1vcmUgaW5mbyBhdCBodHRwOi8vc3BhdGlhbHJlZmVyZW5jZS5vcmcvcmVmL3VzZXIvZ29vZ2xlLXByb2plY3Rpb24vCiAgICAgIFRoZSBzYW1lIHByb2plY3Rpb24gaXMgZGVzaWduYXRlZCBhcyBFUFNHOjM4NTcuIFdLVCBkZWZpbml0aW9uIGlzIGluIHRoZQogICAgICBvZmZpY2lhbCBFUFNHIGRhdGFiYXNlLgoKICAgICAgUHJvajQgVGV4dDoKICAgICAgICArcHJvaj1tZXJjICthPTYzNzgxMzcgK2I9NjM3ODEzNyArbGF0X3RzPTAuMCArbG9uXzA9MC4wICt4XzA9MC4wICt5XzA9MAogICAgICAgICtrPTEuMCArdW5pdHM9bSArbmFkZ3JpZHM9QG51bGwgK25vX2RlZnMKCiAgICAgIEh1bWFuIHJlYWRhYmxlIFdLVCBmb3JtYXQgb2YgRVBTRzozODU3OgogICAgICAgICBQUk9KQ1NbIkdvb2dsZSBNYXBzIEdsb2JhbCBNZXJjYXRvciIsCiAgICAgICAgICAgICBHRU9HQ1NbIldHUyA4NCIsCiAgICAgICAgICAgICAgICAgREFUVU1bIldHU18xOTg0IiwKICAgICAgICAgICAgICAgICAgICAgU1BIRVJPSURbIldHUyA4NCIsNjM3ODEzNywyOTguMjU3MjIzNTYzLAogICAgICAgICAgICAgICAgICAgICAgICAgQVVUSE9SSVRZWyJFUFNHIiwiNzAzMCJdXSwKICAgICAgICAgICAgICAgICAgICAgQVVUSE9SSVRZWyJFUFNHIiwiNjMyNiJdXSwKICAgICAgICAgICAgICAgICBQUklNRU1bIkdyZWVud2ljaCIsMF0sCiAgICAgICAgICAgICAgICAgVU5JVFsiZGVncmVlIiwwLjAxNzQ1MzI5MjUxOTk0MzNdLAogICAgICAgICAgICAgICAgIEFVVEhPUklUWVsiRVBTRyIsIjQzMjYiXV0sCiAgICAgICAgICAgICBQUk9KRUNUSU9OWyJNZXJjYXRvcl8xU1AiXSwKICAgICAgICAgICAgIFBBUkFNRVRFUlsiY2VudHJhbF9tZXJpZGlhbiIsMF0sCiAgICAgICAgICAgICBQQVJBTUVURVJbInNjYWxlX2ZhY3RvciIsMV0sCiAgICAgICAgICAgICBQQVJBTUVURVJbImZhbHNlX2Vhc3RpbmciLDBdLAogICAgICAgICAgICAgUEFSQU1FVEVSWyJmYWxzZV9ub3J0aGluZyIsMF0sCiAgICAgICAgICAgICBVTklUWyJtZXRyZSIsMSwKICAgICAgICAgICAgICAgICBBVVRIT1JJVFlbIkVQU0ciLCI5MDAxIl1dXQogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHRpbGVTaXplPTI1Nik6CiAgICAgICAgIkluaXRpYWxpemUgdGhlIFRNUyBHbG9iYWwgTWVyY2F0b3IgcHlyYW1pZCIKICAgICAgICBzZWxmLnRpbGVTaXplID0gdGlsZVNpemUKICAgICAgICBzZWxmLmluaXRpYWxSZXNvbHV0aW9uID0gMiAqIG1hdGgucGkgKiA2Mzc4MTM3IC8gc2VsZi50aWxlU2l6ZQogICAgICAgICMgMTU2NTQzLjAzMzkyODA0MDYyIGZvciB0aWxlU2l6ZSAyNTYgcGl4ZWxzCiAgICAgICAgc2VsZi5vcmlnaW5TaGlmdCA9IDIgKiBtYXRoLnBpICogNjM3ODEzNyAvIDIuMAogICAgICAgICMgMjAwMzc1MDguMzQyNzg5MjQ0CgogICAgZGVmIExhdExvblRvTWV0ZXJzKHNlbGYsIGxhdCwgbG9uKToKICAgICAgICAiQ29udmVydHMgZ2l2ZW4gbGF0L2xvbiBpbiBXR1M4NCBEYXR1bSB0byBYWSBpbiBTcGhlcmljYWwgTWVyY2F0b3IgRVBTRzozODU3IgoKICAgICAgICBteCA9IGxvbiAqIHNlbGYub3JpZ2luU2hpZnQgLyAxODAuMAogICAgICAgIG15ID0gbWF0aC5sb2cobWF0aC50YW4oKDkwICsgbGF0KSAqIG1hdGgucGkgLyAzNjAuMCkpIC8gKG1hdGgucGkgLyAxODAuMCkKCiAgICAgICAgbXkgPSBteSAqIHNlbGYub3JpZ2luU2hpZnQgLyAxODAuMAogICAgICAgIHJldHVybiBteCwgbXkKCiAgICBkZWYgTWV0ZXJzVG9MYXRMb24oc2VsZiwgbXgsIG15KToKICAgICAgICAiQ29udmVydHMgWFkgcG9pbnQgZnJvbSBTcGhlcmljYWwgTWVyY2F0b3IgRVBTRzozODU3IHRvIGxhdC9sb24gaW4gV0dTODQgRGF0dW0iCgogICAgICAgIGxvbiA9IChteCAvIHNlbGYub3JpZ2luU2hpZnQpICogMTgwLjAKICAgICAgICBsYXQgPSAobXkgLyBzZWxmLm9yaWdpblNoaWZ0KSAqIDE4MC4wCgogICAgICAgIGxhdCA9IDE4MCAvIG1hdGgucGkgKiAoMiAqIG1hdGguYXRhbihtYXRoLmV4cChsYXQgKiBtYXRoLnBpIC8gMTgwLjApKSAtIG1hdGgucGkgLyAyLjApCiAgICAgICAgcmV0dXJuIGxhdCwgbG9uCgogICAgZGVmIFBpeGVsc1RvTWV0ZXJzKHNlbGYsIHB4LCBweSwgem9vbSk6CiAgICAgICAgIkNvbnZlcnRzIHBpeGVsIGNvb3JkaW5hdGVzIGluIGdpdmVuIHpvb20gbGV2ZWwgb2YgcHlyYW1pZCB0byBFUFNHOjM4NTciCgogICAgICAgIHJlcyA9IHNlbGYuUmVzb2x1dGlvbih6b29tKQogICAgICAgIG14ID0gcHggKiByZXMgLSBzZWxmLm9yaWdpblNoaWZ0CiAgICAgICAgbXkgPSBweSAqIHJlcyAtIHNlbGYub3JpZ2luU2hpZnQKICAgICAgICByZXR1cm4gbXgsIG15CgogICAgZGVmIE1ldGVyc1RvUGl4ZWxzKHNlbGYsIG14LCBteSwgem9vbSk6CiAgICAgICAgIkNvbnZlcnRzIEVQU0c6Mzg1NyB0byBweXJhbWlkIHBpeGVsIGNvb3JkaW5hdGVzIGluIGdpdmVuIHpvb20gbGV2ZWwiCgogICAgICAgIHJlcyA9IHNlbGYuUmVzb2x1dGlvbih6b29tKQogICAgICAgIHB4ID0gKG14ICsgc2VsZi5vcmlnaW5TaGlmdCkgLyByZXMKICAgICAgICBweSA9IChteSArIHNlbGYub3JpZ2luU2hpZnQpIC8gcmVzCiAgICAgICAgcmV0dXJuIHB4LCBweQoKICAgIGRlZiBQaXhlbHNUb1RpbGUoc2VsZiwgcHgsIHB5KToKICAgICAgICAiUmV0dXJucyBhIHRpbGUgY292ZXJpbmcgcmVnaW9uIGluIGdpdmVuIHBpeGVsIGNvb3JkaW5hdGVzIgoKICAgICAgICB0eCA9IGludChtYXRoLmNlaWwocHggLyBmbG9hdChzZWxmLnRpbGVTaXplKSkgLSAxKQogICAgICAgIHR5ID0gaW50KG1hdGguY2VpbChweSAvIGZsb2F0KHNlbGYudGlsZVNpemUpKSAtIDEpCiAgICAgICAgcmV0dXJuIHR4LCB0eQoKICAgIGRlZiBQaXhlbHNUb1Jhc3RlcihzZWxmLCBweCwgcHksIHpvb20pOgogICAgICAgICJNb3ZlIHRoZSBvcmlnaW4gb2YgcGl4ZWwgY29vcmRpbmF0ZXMgdG8gdG9wLWxlZnQgY29ybmVyIgoKICAgICAgICBtYXBTaXplID0gc2VsZi50aWxlU2l6ZSA8PCB6b29tCiAgICAgICAgcmV0dXJuIHB4LCBtYXBTaXplIC0gcHkKCiAgICBkZWYgTWV0ZXJzVG9UaWxlKHNlbGYsIG14LCBteSwgem9vbSk6CiAgICAgICAgIlJldHVybnMgdGlsZSBmb3IgZ2l2ZW4gbWVyY2F0b3IgY29vcmRpbmF0ZXMiCgogICAgICAgIHB4LCBweSA9IHNlbGYuTWV0ZXJzVG9QaXhlbHMobXgsIG15LCB6b29tKQogICAgICAgIHJldHVybiBzZWxmLlBpeGVsc1RvVGlsZShweCwgcHkpCgogICAgZGVmIFRpbGVCb3VuZHMoc2VsZiwgdHgsIHR5LCB6b29tKToKICAgICAgICAiUmV0dXJucyBib3VuZHMgb2YgdGhlIGdpdmVuIHRpbGUgaW4gRVBTRzozODU3IGNvb3JkaW5hdGVzIgoKICAgICAgICBtaW54LCBtaW55ID0gc2VsZi5QaXhlbHNUb01ldGVycyh0eCpzZWxmLnRpbGVTaXplLCB0eSpzZWxmLnRpbGVTaXplLCB6b29tKQogICAgICAgIG1heHgsIG1heHkgPSBzZWxmLlBpeGVsc1RvTWV0ZXJzKCh0eCsxKSpzZWxmLnRpbGVTaXplLCAodHkrMSkqc2VsZi50aWxlU2l6ZSwgem9vbSkKICAgICAgICByZXR1cm4gKG1pbngsIG1pbnksIG1heHgsIG1heHkpCgogICAgZGVmIFRpbGVMYXRMb25Cb3VuZHMoc2VsZiwgdHgsIHR5LCB6b29tKToKICAgICAgICAiUmV0dXJucyBib3VuZHMgb2YgdGhlIGdpdmVuIHRpbGUgaW4gbGF0aXR1ZGUvbG9uZ2l0dWRlIHVzaW5nIFdHUzg0IGRhdHVtIgoKICAgICAgICBib3VuZHMgPSBzZWxmLlRpbGVCb3VuZHModHgsIHR5LCB6b29tKQogICAgICAgIG1pbkxhdCwgbWluTG9uID0gc2VsZi5NZXRlcnNUb0xhdExvbihib3VuZHNbMF0sIGJvdW5kc1sxXSkKICAgICAgICBtYXhMYXQsIG1heExvbiA9IHNlbGYuTWV0ZXJzVG9MYXRMb24oYm91bmRzWzJdLCBib3VuZHNbM10pCgogICAgICAgIHJldHVybiAobWluTGF0LCBtaW5Mb24sIG1heExhdCwgbWF4TG9uKQoKICAgIGRlZiBSZXNvbHV0aW9uKHNlbGYsIHpvb20pOgogICAgICAgICJSZXNvbHV0aW9uIChtZXRlcnMvcGl4ZWwpIGZvciBnaXZlbiB6b29tIGxldmVsIChtZWFzdXJlZCBhdCBFcXVhdG9yKSIKCiAgICAgICAgIyByZXR1cm4gKDIgKiBtYXRoLnBpICogNjM3ODEzNykgLyAoc2VsZi50aWxlU2l6ZSAqIDIqKnpvb20pCiAgICAgICAgcmV0dXJuIHNlbGYuaW5pdGlhbFJlc29sdXRpb24gLyAoMioqem9vbSkKCiAgICBkZWYgWm9vbUZvclBpeGVsU2l6ZShzZWxmLCBwaXhlbFNpemUpOgogICAgICAgICJNYXhpbWFsIHNjYWxlZG93biB6b29tIG9mIHRoZSBweXJhbWlkIGNsb3Nlc3QgdG8gdGhlIHBpeGVsU2l6ZS4iCgogICAgICAgIGZvciBpIGluIHJhbmdlKE1BWFpPT01MRVZFTCk6CiAgICAgICAgICAgIGlmIHBpeGVsU2l6ZSA+IHNlbGYuUmVzb2x1dGlvbihpKToKICAgICAgICAgICAgICAgIGlmIGkgIT0gLTE6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGktMQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMCAgICAjIFdlIGRvbid0IHdhbnQgdG8gc2NhbGUgdXAKCiAgICBkZWYgR29vZ2xlVGlsZShzZWxmLCB0eCwgdHksIHpvb20pOgogICAgICAgICJDb252ZXJ0cyBUTVMgdGlsZSBjb29yZGluYXRlcyB0byBHb29nbGUgVGlsZSBjb29yZGluYXRlcyIKCiAgICAgICAgIyBjb29yZGluYXRlIG9yaWdpbiBpcyBtb3ZlZCBmcm9tIGJvdHRvbS1sZWZ0IHRvIHRvcC1sZWZ0IGNvcm5lciBvZiB0aGUgZXh0ZW50CiAgICAgICAgcmV0dXJuIHR4LCAoMioqem9vbSAtIDEpIC0gdHkKCiAgICBkZWYgUXVhZFRyZWUoc2VsZiwgdHgsIHR5LCB6b29tKToKICAgICAgICAiQ29udmVydHMgVE1TIHRpbGUgY29vcmRpbmF0ZXMgdG8gTWljcm9zb2Z0IFF1YWRUcmVlIgoKICAgICAgICBxdWFkS2V5ID0gIiIKICAgICAgICB0eSA9ICgyKip6b29tIC0gMSkgLSB0eQogICAgICAgIGZvciBpIGluIHJhbmdlKHpvb20sIDAsIC0xKToKICAgICAgICAgICAgZGlnaXQgPSAwCiAgICAgICAgICAgIG1hc2sgPSAxIDw8IChpLTEpCiAgICAgICAgICAgIGlmICh0eCAmIG1hc2spICE9IDA6CiAgICAgICAgICAgICAgICBkaWdpdCArPSAxCiAgICAgICAgICAgIGlmICh0eSAmIG1hc2spICE9IDA6CiAgICAgICAgICAgICAgICBkaWdpdCArPSAyCiAgICAgICAgICAgIHF1YWRLZXkgKz0gc3RyKGRpZ2l0KQoKICAgICAgICByZXR1cm4gcXVhZEtleQoKCmNsYXNzIEdsb2JhbEdlb2RldGljKG9iamVjdCk6CiAgICByIiIiCiAgICBUTVMgR2xvYmFsIEdlb2RldGljIFByb2ZpbGUKICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAgIEZ1bmN0aW9ucyBuZWNlc3NhcnkgZm9yIGdlbmVyYXRpb24gb2YgZ2xvYmFsIHRpbGVzIGluIFBsYXRlIENhcnJlIHByb2plY3Rpb24sCiAgICBFUFNHOjQzMjYsICJ1bnByb2plY3RlZCBwcm9maWxlIi4KCiAgICBTdWNoIHRpbGVzIGFyZSBjb21wYXRpYmxlIHdpdGggR29vZ2xlIEVhcnRoIChhcyBhbnkgb3RoZXIgRVBTRzo0MzI2IHJhc3RlcnMpCiAgICBhbmQgeW91IGNhbiBvdmVybGF5IHRoZSB0aWxlcyBvbiB0b3Agb2YgT3BlbkxheWVycyBiYXNlIG1hcC4KCiAgICBQaXhlbCBhbmQgdGlsZSBjb29yZGluYXRlcyBhcmUgaW4gVE1TIG5vdGF0aW9uIChvcmlnaW4gWzAsMF0gaW4gYm90dG9tLWxlZnQpLgoKICAgIFdoYXQgY29vcmRpbmF0ZSBjb252ZXJzaW9ucyBkbyB3ZSBuZWVkIGZvciBUTVMgR2xvYmFsIEdlb2RldGljIHRpbGVzPwoKICAgICAgR2xvYmFsIEdlb2RldGljIHRpbGVzIGFyZSB1c2luZyBnZW9kZXRpYyBjb29yZGluYXRlcyAobGF0aXR1ZGUsbG9uZ2l0dWRlKQogICAgICBkaXJlY3RseSBhcyBwbGFuYXIgY29vcmRpbmF0ZXMgWFkgKGl0IGlzIGFsc28gY2FsbGVkIFVucHJvamVjdGVkIG9yIFBsYXRlCiAgICAgIENhcnJlKS4gV2UgbmVlZCBvbmx5IHNjYWxpbmcgdG8gcGl4ZWwgcHlyYW1pZCBhbmQgY3V0dGluZyB0byB0aWxlcy4KICAgICAgUHlyYW1pZCBoYXMgb24gdG9wIGxldmVsIHR3byB0aWxlcywgc28gaXQgaXMgbm90IHNxdWFyZSBidXQgcmVjdGFuZ2xlLgogICAgICBBcmVhIFstMTgwLC05MCwxODAsOTBdIGlzIHNjYWxlZCB0byA1MTJ4MjU2IHBpeGVscy4KICAgICAgVE1TIGhhcyBjb29yZGluYXRlIG9yaWdpbiAoZm9yIHBpeGVscyBhbmQgdGlsZXMpIGluIGJvdHRvbS1sZWZ0IGNvcm5lci4KICAgICAgUmFzdGVycyBhcmUgaW4gRVBTRzo0MzI2IGFuZCB0aGVyZWZvcmUgYXJlIGNvbXBhdGlibGUgd2l0aCBHb29nbGUgRWFydGguCgogICAgICAgICBMYXRMb24gICAgICA8LT4gICAgICBQaXhlbHMgICAgICA8LT4gICAgIFRpbGVzCgogICAgIFdHUzg0IGNvb3JkaW5hdGVzICAgUGl4ZWxzIGluIHB5cmFtaWQgIFRpbGVzIGluIHB5cmFtaWQKICAgICAgICAgbGF0L2xvbiAgICAgICAgIFhZIHBpeGVscyBaIHpvb20gICAgICBYWVogZnJvbSBUTVMKICAgICAgICBFUFNHOjQzMjYKICAgICAgICAgLi0tLS0uICAgICAgICAgICAgICAgIC0tLS0KICAgICAgICAvICAgICAgXCAgICAgPC0+ICAgIC8tLS0tLS0tLS8gICAgPC0+ICAgICAgVE1TCiAgICAgICAgXCAgICAgIC8gICAgICAgICAvLS0tLS0tLS0tLS0tLS0vCiAgICAgICAgIC0tLS0tICAgICAgICAvLS0tLS0tLS0tLS0tLS0tLS0tLS0vCiAgICAgICBXTVMsIEtNTCAgICBXZWIgQ2xpZW50cywgR29vZ2xlIEVhcnRoICBUaWxlTWFwU2VydmljZQogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHRtc2NvbXBhdGlibGUsIHRpbGVTaXplPTI1Nik6CiAgICAgICAgc2VsZi50aWxlU2l6ZSA9IHRpbGVTaXplCiAgICAgICAgaWYgdG1zY29tcGF0aWJsZSBpcyBub3QgTm9uZToKICAgICAgICAgICAgIyBEZWZhdWx0cyB0aGUgcmVzb2x1dGlvbiBmYWN0b3IgdG8gMC43MDMxMjUgKDIgdGlsZXMgQCBsZXZlbCAwKQogICAgICAgICAgICAjIEFkaGVycyB0byBPU0dlbyBUTVMgc3BlYwogICAgICAgICAgICAjIGh0dHA6Ly93aWtpLm9zZ2VvLm9yZy93aWtpL1RpbGVfTWFwX1NlcnZpY2VfU3BlY2lmaWNhdGlvbiNnbG9iYWwtZ2VvZGV0aWMKICAgICAgICAgICAgc2VsZi5yZXNGYWN0ID0gMTgwLjAgLyBzZWxmLnRpbGVTaXplCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBEZWZhdWx0cyB0aGUgcmVzb2x1dGlvbiBmYWN0b3IgdG8gMS40MDYyNSAoMSB0aWxlIEAgbGV2ZWwgMCkKICAgICAgICAgICAgIyBBZGhlcmVzIE9wZW5MYXllcnMsIE1hcFByb3h5LCBldGMgZGVmYXVsdCByZXNvbHV0aW9uIGZvciBXTVRTCiAgICAgICAgICAgIHNlbGYucmVzRmFjdCA9IDM2MC4wIC8gc2VsZi50aWxlU2l6ZQoKICAgIGRlZiBMb25MYXRUb1BpeGVscyhzZWxmLCBsb24sIGxhdCwgem9vbSk6CiAgICAgICAgIkNvbnZlcnRzIGxvbi9sYXQgdG8gcGl4ZWwgY29vcmRpbmF0ZXMgaW4gZ2l2ZW4gem9vbSBvZiB0aGUgRVBTRzo0MzI2IHB5cmFtaWQiCgogICAgICAgIHJlcyA9IHNlbGYucmVzRmFjdCAvIDIqKnpvb20KICAgICAgICBweCA9ICgxODAgKyBsb24pIC8gcmVzCiAgICAgICAgcHkgPSAoOTAgKyBsYXQpIC8gcmVzCiAgICAgICAgcmV0dXJuIHB4LCBweQoKICAgIGRlZiBQaXhlbHNUb1RpbGUoc2VsZiwgcHgsIHB5KToKICAgICAgICAiUmV0dXJucyBjb29yZGluYXRlcyBvZiB0aGUgdGlsZSBjb3ZlcmluZyByZWdpb24gaW4gcGl4ZWwgY29vcmRpbmF0ZXMiCgogICAgICAgIHR4ID0gaW50KG1hdGguY2VpbChweCAvIGZsb2F0KHNlbGYudGlsZVNpemUpKSAtIDEpCiAgICAgICAgdHkgPSBpbnQobWF0aC5jZWlsKHB5IC8gZmxvYXQoc2VsZi50aWxlU2l6ZSkpIC0gMSkKICAgICAgICByZXR1cm4gdHgsIHR5CgogICAgZGVmIExvbkxhdFRvVGlsZShzZWxmLCBsb24sIGxhdCwgem9vbSk6CiAgICAgICAgIlJldHVybnMgdGhlIHRpbGUgZm9yIHpvb20gd2hpY2ggY292ZXJzIGdpdmVuIGxvbi9sYXQgY29vcmRpbmF0ZXMiCgogICAgICAgIHB4LCBweSA9IHNlbGYuTG9uTGF0VG9QaXhlbHMobG9uLCBsYXQsIHpvb20pCiAgICAgICAgcmV0dXJuIHNlbGYuUGl4ZWxzVG9UaWxlKHB4LCBweSkKCiAgICBkZWYgUmVzb2x1dGlvbihzZWxmLCB6b29tKToKICAgICAgICAiUmVzb2x1dGlvbiAoYXJjL3BpeGVsKSBmb3IgZ2l2ZW4gem9vbSBsZXZlbCAobWVhc3VyZWQgYXQgRXF1YXRvcikiCgogICAgICAgIHJldHVybiBzZWxmLnJlc0ZhY3QgLyAyKip6b29tCgogICAgZGVmIFpvb21Gb3JQaXhlbFNpemUoc2VsZiwgcGl4ZWxTaXplKToKICAgICAgICAiTWF4aW1hbCBzY2FsZWRvd24gem9vbSBvZiB0aGUgcHlyYW1pZCBjbG9zZXN0IHRvIHRoZSBwaXhlbFNpemUuIgoKICAgICAgICBmb3IgaSBpbiByYW5nZShNQVhaT09NTEVWRUwpOgogICAgICAgICAgICBpZiBwaXhlbFNpemUgPiBzZWxmLlJlc29sdXRpb24oaSk6CiAgICAgICAgICAgICAgICBpZiBpICE9IDA6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGktMQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMCAgICAjIFdlIGRvbid0IHdhbnQgdG8gc2NhbGUgdXAKCiAgICBkZWYgVGlsZUJvdW5kcyhzZWxmLCB0eCwgdHksIHpvb20pOgogICAgICAgICJSZXR1cm5zIGJvdW5kcyBvZiB0aGUgZ2l2ZW4gdGlsZSIKICAgICAgICByZXMgPSBzZWxmLnJlc0ZhY3QgLyAyKip6b29tCiAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgdHgqc2VsZi50aWxlU2l6ZSpyZXMgLSAxODAsCiAgICAgICAgICAgIHR5KnNlbGYudGlsZVNpemUqcmVzIC0gOTAsCiAgICAgICAgICAgICh0eCsxKSpzZWxmLnRpbGVTaXplKnJlcyAtIDE4MCwKICAgICAgICAgICAgKHR5KzEpKnNlbGYudGlsZVNpemUqcmVzIC0gOTAKICAgICAgICApCgogICAgZGVmIFRpbGVMYXRMb25Cb3VuZHMoc2VsZiwgdHgsIHR5LCB6b29tKToKICAgICAgICAiUmV0dXJucyBib3VuZHMgb2YgdGhlIGdpdmVuIHRpbGUgaW4gdGhlIFNXTkUgZm9ybSIKICAgICAgICBiID0gc2VsZi5UaWxlQm91bmRzKHR4LCB0eSwgem9vbSkKICAgICAgICByZXR1cm4gKGJbMV0sIGJbMF0sIGJbM10sIGJbMl0pCgoKY2xhc3MgWm9vbWlmeShvYmplY3QpOgogICAgIiIiCiAgICBUaWxlcyBjb21wYXRpYmxlIHdpdGggdGhlIFpvb21pZnkgdmlld2VyCiAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZiwgd2lkdGgsIGhlaWdodCwgdGlsZXNpemU9MjU2LCB0aWxlZm9ybWF0PSdqcGcnKToKICAgICAgICAiIiJJbml0aWFsaXphdGlvbiBvZiB0aGUgWm9vbWlmeSB0aWxlIHRyZWUiIiIKCiAgICAgICAgc2VsZi50aWxlc2l6ZSA9IHRpbGVzaXplCiAgICAgICAgc2VsZi50aWxlZm9ybWF0ID0gdGlsZWZvcm1hdAogICAgICAgIGltYWdlc2l6ZSA9ICh3aWR0aCwgaGVpZ2h0KQogICAgICAgIHRpbGVzID0gKG1hdGguY2VpbCh3aWR0aCAvIHRpbGVzaXplKSwgbWF0aC5jZWlsKGhlaWdodCAvIHRpbGVzaXplKSkKCiAgICAgICAgIyBTaXplIChpbiB0aWxlcykgZm9yIGVhY2ggdGllciBvZiBweXJhbWlkLgogICAgICAgIHNlbGYudGllclNpemVJblRpbGVzID0gW10KICAgICAgICBzZWxmLnRpZXJTaXplSW5UaWxlcy5hcHBlbmQodGlsZXMpCgogICAgICAgICMgSW1hZ2Ugc2l6ZSBpbiBwaXhlbHMgZm9yIGVhY2ggcHlyYW1pZCB0aWVyc2VsZgogICAgICAgIHNlbGYudGllckltYWdlU2l6ZSA9IFtdCiAgICAgICAgc2VsZi50aWVySW1hZ2VTaXplLmFwcGVuZChpbWFnZXNpemUpCgogICAgICAgIHdoaWxlIChpbWFnZXNpemVbMF0gPiB0aWxlc2l6ZSBvciBpbWFnZXNpemVbMV0gPiB0aWxlc2l6ZSk6CiAgICAgICAgICAgIGltYWdlc2l6ZSA9IChtYXRoLmZsb29yKGltYWdlc2l6ZVswXSAvIDIpLCBtYXRoLmZsb29yKGltYWdlc2l6ZVsxXSAvIDIpKQogICAgICAgICAgICB0aWxlcyA9IChtYXRoLmNlaWwoaW1hZ2VzaXplWzBdIC8gdGlsZXNpemUpLCBtYXRoLmNlaWwoaW1hZ2VzaXplWzFdIC8gdGlsZXNpemUpKQogICAgICAgICAgICBzZWxmLnRpZXJTaXplSW5UaWxlcy5hcHBlbmQodGlsZXMpCiAgICAgICAgICAgIHNlbGYudGllckltYWdlU2l6ZS5hcHBlbmQoaW1hZ2VzaXplKQoKICAgICAgICBzZWxmLnRpZXJTaXplSW5UaWxlcy5yZXZlcnNlKCkKICAgICAgICBzZWxmLnRpZXJJbWFnZVNpemUucmV2ZXJzZSgpCgogICAgICAgICMgRGVwdGggb2YgdGhlIFpvb21pZnkgcHlyYW1pZCwgbnVtYmVyIG9mIHRpZXJzICh6b29tIGxldmVscykKICAgICAgICBzZWxmLm51bWJlck9mVGllcnMgPSBsZW4oc2VsZi50aWVyU2l6ZUluVGlsZXMpCgogICAgICAgICMgTnVtYmVyIG9mIHRpbGVzIHVwIHRvIHRoZSBnaXZlbiB0aWVyIG9mIHB5cmFtaWQuCiAgICAgICAgc2VsZi50aWxlQ291bnRVcFRvVGllciA9IFtdCiAgICAgICAgc2VsZi50aWxlQ291bnRVcFRvVGllclswXSA9IDAKICAgICAgICBmb3IgaSBpbiByYW5nZSgxLCBzZWxmLm51bWJlck9mVGllcnMrMSk6CiAgICAgICAgICAgIHNlbGYudGlsZUNvdW50VXBUb1RpZXIuYXBwZW5kKAogICAgICAgICAgICAgICAgc2VsZi50aWVyU2l6ZUluVGlsZXNbaS0xXVswXSAqIHNlbGYudGllclNpemVJblRpbGVzW2ktMV1bMV0gKwogICAgICAgICAgICAgICAgc2VsZi50aWxlQ291bnRVcFRvVGllcltpLTFdCiAgICAgICAgICAgICkKCiAgICBkZWYgdGlsZWZpbGVuYW1lKHNlbGYsIHgsIHksIHopOgogICAgICAgICIiIlJldHVybnMgZmlsZW5hbWUgZm9yIHRpbGUgd2l0aCBnaXZlbiBjb29yZGluYXRlcyIiIgoKICAgICAgICB0aWxlSW5kZXggPSB4ICsgeSAqIHNlbGYudGllclNpemVJblRpbGVzW3pdWzBdICsgc2VsZi50aWxlQ291bnRVcFRvVGllclt6XQogICAgICAgIHJldHVybiBvcy5wYXRoLmpvaW4oIlRpbGVHcm91cCUuMGYiICUgbWF0aC5mbG9vcih0aWxlSW5kZXggLyAyNTYpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIiVzLSVzLSVzLiVzIiAlICh6LCB4LCB5LCBzZWxmLnRpbGVmb3JtYXQpKQoKCmNsYXNzIEdEQUxFcnJvcihFeGNlcHRpb24pOgogICAgcGFzcwoKCmRlZiBleGl0X3dpdGhfZXJyb3IobWVzc2FnZSwgZGV0YWlscz0iIik6CiAgICAjIE1lc3NhZ2UgcHJpbnRpbmcgYW5kIGV4aXQgY29kZSBrZXB0IGZyb20gdGhlIHdheSBpdCB3b3JrZWQgdXNpbmcgdGhlIE9wdGlvblBhcnNlciAoaW4gY2FzZQogICAgIyBzb21lb25lIHBhcnNlcyB0aGUgZXJyb3Igb3V0cHV0KQogICAgc3lzLnN0ZGVyci53cml0ZSgiVXNhZ2U6IGdkYWwydGlsZXNfbG9jYWwucHkgW29wdGlvbnNdIGlucHV0X2ZpbGUgW291dHB1dF1cblxuIikKICAgIHN5cy5zdGRlcnIud3JpdGUoImdkYWwydGlsZXNfbG9jYWwucHk6IGVycm9yOiAlc1xuIiAlIG1lc3NhZ2UpCiAgICBpZiBkZXRhaWxzOgogICAgICAgIHN5cy5zdGRlcnIud3JpdGUoIlxuXG4lc1xuIiAlIGRldGFpbHMpCgogICAgc3lzLmV4aXQoMikKCgpkZWYgZ2VuZXJhdGVfa21sKHR4LCB0eSwgdHosIHRpbGVleHQsIHRpbGVzaXplLCB0aWxlc3duZSwgb3B0aW9ucywgY2hpbGRyZW49Tm9uZSwgKiphcmdzKToKICAgICIiIgogICAgVGVtcGxhdGUgZm9yIHRoZSBLTUwuIFJldHVybnMgZmlsbGVkIHN0cmluZy4KICAgICIiIgogICAgaWYgbm90IGNoaWxkcmVuOgogICAgICAgIGNoaWxkcmVuID0gW10KCiAgICBhcmdzWyd0eCddLCBhcmdzWyd0eSddLCBhcmdzWyd0eiddID0gdHgsIHR5LCB0egogICAgYXJnc1sndGlsZWZvcm1hdCddID0gdGlsZWV4dAogICAgaWYgJ3RpbGVzaXplJyBub3QgaW4gYXJnczoKICAgICAgICBhcmdzWyd0aWxlc2l6ZSddID0gdGlsZXNpemUKCiAgICBpZiAnbWlubG9kcGl4ZWxzJyBub3QgaW4gYXJnczoKICAgICAgICBhcmdzWydtaW5sb2RwaXhlbHMnXSA9IGludChhcmdzWyd0aWxlc2l6ZSddIC8gMikKICAgIGlmICdtYXhsb2RwaXhlbHMnIG5vdCBpbiBhcmdzOgogICAgICAgIGFyZ3NbJ21heGxvZHBpeGVscyddID0gaW50KGFyZ3NbJ3RpbGVzaXplJ10gKiA4KQogICAgaWYgY2hpbGRyZW4gPT0gW106CiAgICAgICAgYXJnc1snbWF4bG9kcGl4ZWxzJ10gPSAtMQoKICAgIGlmIHR4IGlzIE5vbmU6CiAgICAgICAgdGlsZWttbCA9IEZhbHNlCiAgICAgICAgYXJnc1sndGl0bGUnXSA9IG9wdGlvbnMudGl0bGUKICAgIGVsc2U6CiAgICAgICAgdGlsZWttbCA9IFRydWUKICAgICAgICBhcmdzWyd0aXRsZSddID0gIiVkLyVkLyVkLmttbCIgJSAodHosIHR4LCB0eSkKICAgICAgICBhcmdzWydzb3V0aCddLCBhcmdzWyd3ZXN0J10sIGFyZ3NbJ25vcnRoJ10sIGFyZ3NbJ2Vhc3QnXSA9IHRpbGVzd25lKHR4LCB0eSwgdHopCgogICAgaWYgdHggPT0gMDoKICAgICAgICBhcmdzWydkcmF3T3JkZXInXSA9IDIgKiB0eiArIDEKICAgIGVsaWYgdHggaXMgbm90IE5vbmU6CiAgICAgICAgYXJnc1snZHJhd09yZGVyJ10gPSAyICogdHoKICAgIGVsc2U6CiAgICAgICAgYXJnc1snZHJhd09yZGVyJ10gPSAwCgogICAgdXJsID0gb3B0aW9ucy51cmwKICAgIGlmIG5vdCB1cmw6CiAgICAgICAgaWYgdGlsZWttbDoKICAgICAgICAgICAgdXJsID0gIi4uLy4uLyIKICAgICAgICBlbHNlOgogICAgICAgICAgICB1cmwgPSAiIgoKICAgIHMgPSAiIiI8P3htbCB2ZXJzaW9uPSIxLjAiIGVuY29kaW5nPSJ1dGYtOCI/Pgo8a21sIHhtbG5zPSJodHRwOi8vd3d3Lm9wZW5naXMubmV0L2ttbC8yLjIiPgogIDxEb2N1bWVudD4KICAgIDxuYW1lPiUodGl0bGUpczwvbmFtZT4KICAgIDxkZXNjcmlwdGlvbj48L2Rlc2NyaXB0aW9uPgogICAgPFN0eWxlPgogICAgICA8TGlzdFN0eWxlIGlkPSJoaWRlQ2hpbGRyZW4iPgogICAgICAgIDxsaXN0SXRlbVR5cGU+Y2hlY2tIaWRlQ2hpbGRyZW48L2xpc3RJdGVtVHlwZT4KICAgICAgPC9MaXN0U3R5bGU+CiAgICA8L1N0eWxlPiIiIiAlIGFyZ3MKICAgIGlmIHRpbGVrbWw6CiAgICAgICAgcyArPSAiIiIKICAgIDxSZWdpb24+CiAgICAgIDxMYXRMb25BbHRCb3g+CiAgICAgICAgPG5vcnRoPiUobm9ydGgpLjE0Zjwvbm9ydGg+CiAgICAgICAgPHNvdXRoPiUoc291dGgpLjE0Zjwvc291dGg+CiAgICAgICAgPGVhc3Q+JShlYXN0KS4xNGY8L2Vhc3Q+CiAgICAgICAgPHdlc3Q+JSh3ZXN0KS4xNGY8L3dlc3Q+CiAgICAgIDwvTGF0TG9uQWx0Qm94PgogICAgICA8TG9kPgogICAgICAgIDxtaW5Mb2RQaXhlbHM+JShtaW5sb2RwaXhlbHMpZDwvbWluTG9kUGl4ZWxzPgogICAgICAgIDxtYXhMb2RQaXhlbHM+JShtYXhsb2RwaXhlbHMpZDwvbWF4TG9kUGl4ZWxzPgogICAgICA8L0xvZD4KICAgIDwvUmVnaW9uPgogICAgPEdyb3VuZE92ZXJsYXk+CiAgICAgIDxkcmF3T3JkZXI+JShkcmF3T3JkZXIpZDwvZHJhd09yZGVyPgogICAgICA8SWNvbj4KICAgICAgICA8aHJlZj4lKHR5KWQuJSh0aWxlZm9ybWF0KXM8L2hyZWY+CiAgICAgIDwvSWNvbj4KICAgICAgPExhdExvbkJveD4KICAgICAgICA8bm9ydGg+JShub3J0aCkuMTRmPC9ub3J0aD4KICAgICAgICA8c291dGg+JShzb3V0aCkuMTRmPC9zb3V0aD4KICAgICAgICA8ZWFzdD4lKGVhc3QpLjE0ZjwvZWFzdD4KICAgICAgICA8d2VzdD4lKHdlc3QpLjE0Zjwvd2VzdD4KICAgICAgPC9MYXRMb25Cb3g+CiAgICA8L0dyb3VuZE92ZXJsYXk+CiIiIiAlIGFyZ3MKCiAgICBmb3IgY3gsIGN5LCBjeiBpbiBjaGlsZHJlbjoKICAgICAgICBjc291dGgsIGN3ZXN0LCBjbm9ydGgsIGNlYXN0ID0gdGlsZXN3bmUoY3gsIGN5LCBjeikKICAgICAgICBzICs9ICIiIgogICAgPE5ldHdvcmtMaW5rPgogICAgICA8bmFtZT4lZC8lZC8lZC4lczwvbmFtZT4KICAgICAgPFJlZ2lvbj4KICAgICAgICA8TGF0TG9uQWx0Qm94PgogICAgICAgICAgPG5vcnRoPiUuMTRmPC9ub3J0aD4KICAgICAgICAgIDxzb3V0aD4lLjE0Zjwvc291dGg+CiAgICAgICAgICA8ZWFzdD4lLjE0ZjwvZWFzdD4KICAgICAgICAgIDx3ZXN0PiUuMTRmPC93ZXN0PgogICAgICAgIDwvTGF0TG9uQWx0Qm94PgogICAgICAgIDxMb2Q+CiAgICAgICAgICA8bWluTG9kUGl4ZWxzPiVkPC9taW5Mb2RQaXhlbHM+CiAgICAgICAgICA8bWF4TG9kUGl4ZWxzPi0xPC9tYXhMb2RQaXhlbHM+CiAgICAgICAgPC9Mb2Q+CiAgICAgIDwvUmVnaW9uPgogICAgICA8TGluaz4KICAgICAgICA8aHJlZj4lcyVkLyVkLyVkLmttbDwvaHJlZj4KICAgICAgICA8dmlld1JlZnJlc2hNb2RlPm9uUmVnaW9uPC92aWV3UmVmcmVzaE1vZGU+CiAgICAgICAgPHZpZXdGb3JtYXQvPgogICAgICA8L0xpbms+CiAgICA8L05ldHdvcmtMaW5rPgogICAgICAgICIiIiAlIChjeiwgY3gsIGN5LCBhcmdzWyd0aWxlZm9ybWF0J10sIGNub3J0aCwgY3NvdXRoLCBjZWFzdCwgY3dlc3QsCiAgICAgICAgICAgICAgIGFyZ3NbJ21pbmxvZHBpeGVscyddLCB1cmwsIGN6LCBjeCwgY3kpCgogICAgcyArPSAiIiIgICAgICA8L0RvY3VtZW50Pgo8L2ttbD4KICAgICIiIgogICAgcmV0dXJuIHMKCgpkZWYgc2NhbGVfcXVlcnlfdG9fdGlsZShkc3F1ZXJ5LCBkc3RpbGUsIHRpbGVkcml2ZXIsIG9wdGlvbnMsIHRpbGVmaWxlbmFtZT0nJyk6CiAgICAiIiJTY2FsZXMgZG93biBxdWVyeSBkYXRhc2V0IHRvIHRoZSB0aWxlIGRhdGFzZXQiIiIKCiAgICBxdWVyeXNpemUgPSBkc3F1ZXJ5LlJhc3RlclhTaXplCiAgICB0aWxlc2l6ZSA9IGRzdGlsZS5SYXN0ZXJYU2l6ZQogICAgdGlsZWJhbmRzID0gZHN0aWxlLlJhc3RlckNvdW50CgogICAgaWYgb3B0aW9ucy5yZXNhbXBsaW5nID09ICdhdmVyYWdlJzoKCiAgICAgICAgIyBGdW5jdGlvbjogZ2RhbC5SZWdlbmVyYXRlT3ZlcnZpZXcoKQogICAgICAgIGZvciBpIGluIHJhbmdlKDEsIHRpbGViYW5kcysxKToKICAgICAgICAgICAgIyBCbGFjayBib3JkZXIgYXJvdW5kIE5PREFUQQogICAgICAgICAgICByZXMgPSBnZGFsLlJlZ2VuZXJhdGVPdmVydmlldyhkc3F1ZXJ5LkdldFJhc3RlckJhbmQoaSksIGRzdGlsZS5HZXRSYXN0ZXJCYW5kKGkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYXZlcmFnZScpCiAgICAgICAgICAgIGlmIHJlcyAhPSAwOgogICAgICAgICAgICAgICAgZXhpdF93aXRoX2Vycm9yKCJSZWdlbmVyYXRlT3ZlcnZpZXcoKSBmYWlsZWQgb24gJXMsIGVycm9yICVkIiAlICgKICAgICAgICAgICAgICAgICAgICB0aWxlZmlsZW5hbWUsIHJlcykpCgogICAgZWxpZiBvcHRpb25zLnJlc2FtcGxpbmcgPT0gJ2FudGlhbGlhcyc6CgogICAgICAgICMgU2NhbGluZyBieSBQSUwgKFB5dGhvbiBJbWFnaW5nIExpYnJhcnkpIC0gaW1wcm92ZWQgTGFuY3pvcwogICAgICAgIGFycmF5ID0gbnVtcHkuemVyb3MoKHF1ZXJ5c2l6ZSwgcXVlcnlzaXplLCB0aWxlYmFuZHMpLCBudW1weS51aW50OCkKICAgICAgICBmb3IgaSBpbiByYW5nZSh0aWxlYmFuZHMpOgogICAgICAgICAgICBhcnJheVs6LCA6LCBpXSA9IGdkYWxhcnJheS5CYW5kUmVhZEFzQXJyYXkoZHNxdWVyeS5HZXRSYXN0ZXJCYW5kKGkrMSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAwLCAwLCBxdWVyeXNpemUsIHF1ZXJ5c2l6ZSkKICAgICAgICBpbSA9IEltYWdlLmZyb21hcnJheShhcnJheSwgJ1JHQkEnKSAgICAgIyBBbHdheXMgZm91ciBiYW5kcwogICAgICAgIGltMSA9IGltLnJlc2l6ZSgodGlsZXNpemUsIHRpbGVzaXplKSwgSW1hZ2UuQU5USUFMSUFTKQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKHRpbGVmaWxlbmFtZSk6CiAgICAgICAgICAgIGltMCA9IEltYWdlLm9wZW4odGlsZWZpbGVuYW1lKQogICAgICAgICAgICBpbTEgPSBJbWFnZS5jb21wb3NpdGUoaW0xLCBpbTAsIGltMSkKICAgICAgICBpbTEuc2F2ZSh0aWxlZmlsZW5hbWUsIHRpbGVkcml2ZXIpCgogICAgZWxzZToKCiAgICAgICAgaWYgb3B0aW9ucy5yZXNhbXBsaW5nID09ICduZWFyJzoKICAgICAgICAgICAgZ2RhbF9yZXNhbXBsaW5nID0gZ2RhbC5HUkFfTmVhcmVzdE5laWdoYm91cgoKICAgICAgICBlbGlmIG9wdGlvbnMucmVzYW1wbGluZyA9PSAnYmlsaW5lYXInOgogICAgICAgICAgICBnZGFsX3Jlc2FtcGxpbmcgPSBnZGFsLkdSQV9CaWxpbmVhcgoKICAgICAgICBlbGlmIG9wdGlvbnMucmVzYW1wbGluZyA9PSAnY3ViaWMnOgogICAgICAgICAgICBnZGFsX3Jlc2FtcGxpbmcgPSBnZGFsLkdSQV9DdWJpYwoKICAgICAgICBlbGlmIG9wdGlvbnMucmVzYW1wbGluZyA9PSAnY3ViaWNzcGxpbmUnOgogICAgICAgICAgICBnZGFsX3Jlc2FtcGxpbmcgPSBnZGFsLkdSQV9DdWJpY1NwbGluZQoKICAgICAgICBlbGlmIG9wdGlvbnMucmVzYW1wbGluZyA9PSAnbGFuY3pvcyc6CiAgICAgICAgICAgIGdkYWxfcmVzYW1wbGluZyA9IGdkYWwuR1JBX0xhbmN6b3MKCiAgICAgICAgIyBPdGhlciBhbGdvcml0aG1zIGFyZSBpbXBsZW1lbnRlZCBieSBnZGFsLlJlcHJvamVjdEltYWdlKCkuCiAgICAgICAgZHNxdWVyeS5TZXRHZW9UcmFuc2Zvcm0oKDAuMCwgdGlsZXNpemUgLyBmbG9hdChxdWVyeXNpemUpLCAwLjAsIDAuMCwgMC4wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aWxlc2l6ZSAvIGZsb2F0KHF1ZXJ5c2l6ZSkpKQogICAgICAgIGRzdGlsZS5TZXRHZW9UcmFuc2Zvcm0oKDAuMCwgMS4wLCAwLjAsIDAuMCwgMC4wLCAxLjApKQoKICAgICAgICByZXMgPSBnZGFsLlJlcHJvamVjdEltYWdlKGRzcXVlcnksIGRzdGlsZSwgTm9uZSwgTm9uZSwgZ2RhbF9yZXNhbXBsaW5nKQogICAgICAgIGlmIHJlcyAhPSAwOgogICAgICAgICAgICBleGl0X3dpdGhfZXJyb3IoIlJlcHJvamVjdEltYWdlKCkgZmFpbGVkIG9uICVzLCBlcnJvciAlZCIgJSAodGlsZWZpbGVuYW1lLCByZXMpKQoKCmRlZiBzZXR1cF9ub19kYXRhX3ZhbHVlcyhpbnB1dF9kYXRhc2V0LCBvcHRpb25zKToKICAgICIiIgogICAgRXh0cmFjdCB0aGUgTk9EQVRBIHZhbHVlcyBmcm9tIHRoZSBkYXRhc2V0IG9yIHVzZSB0aGUgcGFzc2VkIGFyZ3VtZW50cyBhcyBvdmVycmlkZSBpZiBhbnkKICAgICIiIgogICAgaW5fbm9kYXRhID0gW10KICAgIGlmIG9wdGlvbnMuc3Jjbm9kYXRhOgogICAgICAgIG5kcyA9IGxpc3QobWFwKGZsb2F0LCBvcHRpb25zLnNyY25vZGF0YS5zcGxpdCgnLCcpKSkKICAgICAgICBpZiBsZW4obmRzKSA8IGlucHV0X2RhdGFzZXQuUmFzdGVyQ291bnQ6CiAgICAgICAgICAgIGluX25vZGF0YSA9IChuZHMgKiBpbnB1dF9kYXRhc2V0LlJhc3RlckNvdW50KVs6aW5wdXRfZGF0YXNldC5SYXN0ZXJDb3VudF0KICAgICAgICBlbHNlOgogICAgICAgICAgICBpbl9ub2RhdGEgPSBuZHMKICAgIGVsc2U6CiAgICAgICAgZm9yIGkgaW4gcmFuZ2UoMSwgaW5wdXRfZGF0YXNldC5SYXN0ZXJDb3VudCsxKToKICAgICAgICAgICAgcmFzdGVyX25vX2RhdGEgPSBpbnB1dF9kYXRhc2V0LkdldFJhc3RlckJhbmQoaSkuR2V0Tm9EYXRhVmFsdWUoKQogICAgICAgICAgICBpZiByYXN0ZXJfbm9fZGF0YSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGluX25vZGF0YS5hcHBlbmQocmFzdGVyX25vX2RhdGEpCgogICAgaWYgb3B0aW9ucy52ZXJib3NlOgogICAgICAgIHByaW50KCJOT0RBVEE6ICVzIiAlIGluX25vZGF0YSkKCiAgICByZXR1cm4gaW5fbm9kYXRhCgoKZGVmIHNldHVwX2lucHV0X3NycyhpbnB1dF9kYXRhc2V0LCBvcHRpb25zKToKICAgICIiIgogICAgRGV0ZXJtaW5lcyBhbmQgcmV0dXJucyB0aGUgSW5wdXQgU3BhdGlhbCBSZWZlcmVuY2UgU3lzdGVtIChTUlMpIGFzIGFuIG9zciBvYmplY3QgYW5kIGFzIGEKICAgIFdLVCByZXByZXNlbnRhdGlvbgoKICAgIFVzZXMgaW4gcHJpb3JpdHkgdGhlIG9uZSBwYXNzZWQgaW4gdGhlIGNvbW1hbmQgbGluZSBhcmd1bWVudHMuIElmIE5vbmUsIHRyaWVzIHRvIGV4dHJhY3QgdGhlbQogICAgZnJvbSB0aGUgaW5wdXQgZGF0YXNldAogICAgIiIiCgogICAgaW5wdXRfc3JzID0gTm9uZQogICAgaW5wdXRfc3JzX3drdCA9IE5vbmUKCiAgICBpZiBvcHRpb25zLnNfc3JzOgogICAgICAgIGlucHV0X3NycyA9IG9zci5TcGF0aWFsUmVmZXJlbmNlKCkKICAgICAgICBpbnB1dF9zcnMuU2V0RnJvbVVzZXJJbnB1dChvcHRpb25zLnNfc3JzKQogICAgICAgIGlucHV0X3Nyc193a3QgPSBpbnB1dF9zcnMuRXhwb3J0VG9Xa3QoKQogICAgZWxzZToKICAgICAgICBpbnB1dF9zcnNfd2t0ID0gaW5wdXRfZGF0YXNldC5HZXRQcm9qZWN0aW9uKCkKICAgICAgICBpZiBub3QgaW5wdXRfc3JzX3drdCBhbmQgaW5wdXRfZGF0YXNldC5HZXRHQ1BDb3VudCgpICE9IDA6CiAgICAgICAgICAgIGlucHV0X3Nyc193a3QgPSBpbnB1dF9kYXRhc2V0LkdldEdDUFByb2plY3Rpb24oKQogICAgICAgIGlmIGlucHV0X3Nyc193a3Q6CiAgICAgICAgICAgIGlucHV0X3NycyA9IG9zci5TcGF0aWFsUmVmZXJlbmNlKCkKICAgICAgICAgICAgaW5wdXRfc3JzLkltcG9ydEZyb21Xa3QoaW5wdXRfc3JzX3drdCkKCiAgICByZXR1cm4gaW5wdXRfc3JzLCBpbnB1dF9zcnNfd2t0CgoKZGVmIHNldHVwX291dHB1dF9zcnMoaW5wdXRfc3JzLCBvcHRpb25zKToKICAgICIiIgogICAgU2V0dXAgdGhlIGRlc2lyZWQgU1JTIChiYXNlZCBvbiBvcHRpb25zKQogICAgIiIiCiAgICBvdXRwdXRfc3JzID0gb3NyLlNwYXRpYWxSZWZlcmVuY2UoKQoKICAgIGlmIG9wdGlvbnMucHJvZmlsZSA9PSAnbWVyY2F0b3InOgogICAgICAgIG91dHB1dF9zcnMuSW1wb3J0RnJvbUVQU0coMzg1NykKICAgIGVsaWYgb3B0aW9ucy5wcm9maWxlID09ICdnZW9kZXRpYyc6CiAgICAgICAgb3V0cHV0X3Nycy5JbXBvcnRGcm9tRVBTRyg0MzI2KQogICAgZWxzZToKICAgICAgICBvdXRwdXRfc3JzID0gaW5wdXRfc3JzCgogICAgcmV0dXJuIG91dHB1dF9zcnMKCgpkZWYgaGFzX2dlb3JlZmVyZW5jZShkYXRhc2V0KToKICAgIHJldHVybiAoZGF0YXNldC5HZXRHZW9UcmFuc2Zvcm0oKSAhPSAoMC4wLCAxLjAsIDAuMCwgMC4wLCAwLjAsIDEuMCkgb3IKICAgICAgICAgICAgZGF0YXNldC5HZXRHQ1BDb3VudCgpICE9IDApCgoKZGVmIHJlcHJvamVjdF9kYXRhc2V0KGZyb21fZGF0YXNldCwgZnJvbV9zcnMsIHRvX3Nycywgb3B0aW9ucz1Ob25lKToKICAgICIiIgogICAgUmV0dXJucyB0aGUgaW5wdXQgZGF0YXNldCBpbiB0aGUgZXhwZWN0ZWQgImRlc3RpbmF0aW9uIiBTUlMuCiAgICBJZiB0aGUgZGF0YXNldCBpcyBhbHJlYWR5IGluIHRoZSBjb3JyZWN0IFNSUywgcmV0dXJucyBpdCB1bm1vZGlmaWVkCiAgICAiIiIKICAgIGlmIG5vdCBmcm9tX3NycyBvciBub3QgdG9fc3JzOgogICAgICAgIHJhaXNlIEdEQUxFcnJvcigiZnJvbSBhbmQgdG8gU1JTIG11c3QgYmUgZGVmaW5lZCB0byByZXByb2plY3QgdGhlIGRhdGFzZXQiKQoKICAgIGlmIChmcm9tX3Nycy5FeHBvcnRUb1Byb2o0KCkgIT0gdG9fc3JzLkV4cG9ydFRvUHJvajQoKSkgb3IgKGZyb21fZGF0YXNldC5HZXRHQ1BDb3VudCgpICE9IDApOgogICAgICAgIHRvX2RhdGFzZXQgPSBnZGFsLkF1dG9DcmVhdGVXYXJwZWRWUlQoZnJvbV9kYXRhc2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbV9zcnMuRXhwb3J0VG9Xa3QoKSwgdG9fc3JzLkV4cG9ydFRvV2t0KCkpCgogICAgICAgIGlmIG9wdGlvbnMgYW5kIG9wdGlvbnMudmVyYm9zZToKICAgICAgICAgICAgcHJpbnQoIldhcnBpbmcgb2YgdGhlIHJhc3RlciBieSBBdXRvQ3JlYXRlV2FycGVkVlJUIChyZXN1bHQgc2F2ZWQgaW50byAndGlsZXMudnJ0JykiKQogICAgICAgICAgICB0b19kYXRhc2V0LkdldERyaXZlcigpLkNyZWF0ZUNvcHkoInRpbGVzLnZydCIsIHRvX2RhdGFzZXQpCgogICAgICAgIHJldHVybiB0b19kYXRhc2V0CiAgICBlbHNlOgogICAgICAgIHJldHVybiBmcm9tX2RhdGFzZXQKCgpkZWYgYWRkX2dkYWxfd2FycF9vcHRpb25zX3RvX3N0cmluZyh2cnRfc3RyaW5nLCB3YXJwX29wdGlvbnMpOgogICAgaWYgbm90IHdhcnBfb3B0aW9uczoKICAgICAgICByZXR1cm4gdnJ0X3N0cmluZwoKICAgIHZydF9yb290ID0gRWxlbWVudFRyZWUuZnJvbXN0cmluZyh2cnRfc3RyaW5nKQogICAgb3B0aW9ucyA9IHZydF9yb290LmZpbmQoIkdEQUxXYXJwT3B0aW9ucyIpCgogICAgaWYgb3B0aW9ucyBpcyBOb25lOgogICAgICAgIHJldHVybiB2cnRfc3RyaW5nCgogICAgZm9yIGtleSwgdmFsdWUgaW4gd2FycF9vcHRpb25zLml0ZW1zKCk6CiAgICAgICAgdGIgPSBFbGVtZW50VHJlZS5UcmVlQnVpbGRlcigpCiAgICAgICAgdGIuc3RhcnQoIk9wdGlvbiIsIHsibmFtZSI6IGtleX0pCiAgICAgICAgdGIuZGF0YSh2YWx1ZSkKICAgICAgICB0Yi5lbmQoIk9wdGlvbiIpCiAgICAgICAgZWxlbSA9IHRiLmNsb3NlKCkKICAgICAgICBvcHRpb25zLmluc2VydCgwLCBlbGVtKQoKICAgIHJldHVybiBFbGVtZW50VHJlZS50b3N0cmluZyh2cnRfcm9vdCkuZGVjb2RlKCkKCgpkZWYgdXBkYXRlX25vX2RhdGFfdmFsdWVzKHdhcnBlZF92cnRfZGF0YXNldCwgbm9kYXRhX3ZhbHVlcywgb3B0aW9ucz1Ob25lKToKICAgICIiIgogICAgVGFrZXMgYW4gYXJyYXkgb2YgTk9EQVRBIHZhbHVlcyBhbmQgZm9yY2VzIHRoZW0gb24gdGhlIFdhcnBlZFZSVCBmaWxlIGRhdGFzZXQgcGFzc2VkCiAgICAiIiIKICAgICMgVE9ETzogZ2JhdGFpbGxlIC0gU2VlbXMgdGhhdCBJIGZvcmdvdCB0ZXN0cyB0aGVyZQogICAgaWYgbm9kYXRhX3ZhbHVlcyAhPSBbXToKICAgICAgICB0ZW1wX2ZpbGUgPSBnZXR0ZW1wZmlsZW5hbWUoJy1nZGFsMnRpbGVzLnZydCcpCiAgICAgICAgd2FycGVkX3ZydF9kYXRhc2V0LkdldERyaXZlcigpLkNyZWF0ZUNvcHkodGVtcF9maWxlLCB3YXJwZWRfdnJ0X2RhdGFzZXQpCiAgICAgICAgd2l0aCBvcGVuKHRlbXBfZmlsZSwgJ3InKSBhcyBmOgogICAgICAgICAgICB2cnRfc3RyaW5nID0gZi5yZWFkKCkKCiAgICAgICAgdnJ0X3N0cmluZyA9IGFkZF9nZGFsX3dhcnBfb3B0aW9uc190b19zdHJpbmcoCiAgICAgICAgICAgIHZydF9zdHJpbmcsIHsiSU5JVF9ERVNUIjogIk5PX0RBVEEiLCAiVU5JRklFRF9TUkNfTk9EQVRBIjogIllFUyJ9KQoKIyBUT0RPOiBnYmF0YWlsbGUgLSBjaGVjayB0aGUgbmVlZCBmb3IgdGhpcyByZXBsYWNlbWVudC4gU2VlbXMgdG8gd29yayB3aXRob3V0CiMgICAgICAgICAjIHJlcGxhY2UgQmFuZE1hcHBpbmcgdGFnIGZvciBOT0RBVEEgYmFuZHMuLi4uCiMgICAgICAgICBmb3IgaSBpbiByYW5nZShsZW4obm9kYXRhX3ZhbHVlcykpOgojICAgICAgICAgICAgIHMgPSBzLnJlcGxhY2UoCiMgICAgICAgICAgICAgICAgICc8QmFuZE1hcHBpbmcgc3JjPSIlaSIgZHN0PSIlaSIvPicgJSAoKGkrMSksIChpKzEpKSwKIyAgICAgICAgICAgICAgICAgIiIiCiMgPEJhbmRNYXBwaW5nIHNyYz0iJWkiIGRzdD0iJWkiPgojIDxTcmNOb0RhdGFSZWFsPiVpPC9TcmNOb0RhdGFSZWFsPgojIDxTcmNOb0RhdGFJbWFnPjA8L1NyY05vRGF0YUltYWc+CiMgPERzdE5vRGF0YVJlYWw+JWk8L0RzdE5vRGF0YVJlYWw+CiMgPERzdE5vRGF0YUltYWc+MDwvRHN0Tm9EYXRhSW1hZz4KIyA8L0JhbmRNYXBwaW5nPgojICAgICAgICAgICAgICAgICAiIiIgJSAoKGkrMSksIChpKzEpLCBub2RhdGFfdmFsdWVzW2ldLCBub2RhdGFfdmFsdWVzW2ldKSkKCiAgICAgICAgIyBzYXZlIHRoZSBjb3JyZWN0ZWQgVlJUCiAgICAgICAgd2l0aCBvcGVuKHRlbXBfZmlsZSwgJ3cnKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlKHZydF9zdHJpbmcpCgogICAgICAgIGNvcnJlY3RlZF9kYXRhc2V0ID0gZ2RhbC5PcGVuKHRlbXBfZmlsZSkKICAgICAgICBvcy51bmxpbmsodGVtcF9maWxlKQoKICAgICAgICAjIHNldCBOT0RBVEFfVkFMVUUgbWV0YWRhdGEKICAgICAgICBjb3JyZWN0ZWRfZGF0YXNldC5TZXRNZXRhZGF0YUl0ZW0oCiAgICAgICAgICAgICdOT0RBVEFfVkFMVUVTJywgJyAnLmpvaW4oW3N0cihpKSBmb3IgaSBpbiBub2RhdGFfdmFsdWVzXSkpCgogICAgICAgIGlmIG9wdGlvbnMgYW5kIG9wdGlvbnMudmVyYm9zZToKICAgICAgICAgICAgcHJpbnQoIk1vZGlmaWVkIHdhcnBpbmcgcmVzdWx0IHNhdmVkIGludG8gJ3RpbGVzMS52cnQnIikKICAgICAgICAgICAgIyBUT0RPOiBnYmF0YWlsbGUgLSB0ZXN0IHJlcGxhY2luZyB0aGF0IHdpdGggYSBnZGFsIHdyaXRlIG9mIHRoZSBkYXRhc2V0IChtb3JlCiAgICAgICAgICAgICMgYWNjdXJhdGVseSB3aGF0J3MgdXNlZCwgZXZlbiBpZiBzaG91bGQgYmUgdGhlIHNhbWUKICAgICAgICAgICAgd2l0aCBvcGVuKCJ0aWxlczEudnJ0IiwgInciKSBhcyBmOgogICAgICAgICAgICAgICAgZi53cml0ZSh2cnRfc3RyaW5nKQoKICAgICAgICByZXR1cm4gY29ycmVjdGVkX2RhdGFzZXQKCgpkZWYgYWRkX2FscGhhX2JhbmRfdG9fc3RyaW5nX3ZydCh2cnRfc3RyaW5nKToKICAgICMgVE9ETzogZ2JhdGFpbGxlIC0gT2xkIGNvZGUgc3BlYWsgb2YgdGhpcyBiZWluZyBlcXVpdmFsZW50IHRvIGdkYWx3YXJwIC1kc3RhbHBoYQogICAgIyBUbyBiZSBjaGVja2VkCgogICAgdnJ0X3Jvb3QgPSBFbGVtZW50VHJlZS5mcm9tc3RyaW5nKHZydF9zdHJpbmcpCgogICAgaW5kZXggPSAwCiAgICBuYl9iYW5kcyA9IDAKICAgIGZvciBzdWJlbGVtIGluIGxpc3QodnJ0X3Jvb3QpOgogICAgICAgIGlmIHN1YmVsZW0udGFnID09ICJWUlRSYXN0ZXJCYW5kIjoKICAgICAgICAgICAgbmJfYmFuZHMgKz0gMQogICAgICAgICAgICBjb2xvcl9ub2RlID0gc3ViZWxlbS5maW5kKCIuL0NvbG9ySW50ZXJwIikKICAgICAgICAgICAgaWYgY29sb3Jfbm9kZSBpcyBub3QgTm9uZSBhbmQgY29sb3Jfbm9kZS50ZXh0ID09ICJBbHBoYSI6CiAgICAgICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oIkFscGhhIGJhbmQgYWxyZWFkeSBwcmVzZW50IikKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBuYl9iYW5kczoKICAgICAgICAgICAgICAgICMgVGhpcyBtZWFucyB0aGF0IHdlIGFyZSBvbmUgZWxlbWVudCBhZnRlciB0aGUgQmFuZCBkZWZpbml0aW9ucwogICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgaW5kZXggKz0gMQoKICAgIHRiID0gRWxlbWVudFRyZWUuVHJlZUJ1aWxkZXIoKQogICAgdGIuc3RhcnQoIlZSVFJhc3RlckJhbmQiLAogICAgICAgICAgICAgeydkYXRhVHlwZSc6ICJCeXRlIiwgImJhbmQiOiBzdHIobmJfYmFuZHMgKyAxKSwgInN1YkNsYXNzIjogIlZSVFdhcnBlZFJhc3RlckJhbmQifSkKICAgIHRiLnN0YXJ0KCJDb2xvckludGVycCIsIHt9KQogICAgdGIuZGF0YSgiQWxwaGEiKQogICAgdGIuZW5kKCJDb2xvckludGVycCIpCiAgICB0Yi5lbmQoIlZSVFJhc3RlckJhbmQiKQogICAgZWxlbSA9IHRiLmNsb3NlKCkKCiAgICB2cnRfcm9vdC5pbnNlcnQoaW5kZXgsIGVsZW0pCgogICAgd2FycF9vcHRpb25zID0gdnJ0X3Jvb3QuZmluZCgiLi8vR0RBTFdhcnBPcHRpb25zIikKICAgIHRiID0gRWxlbWVudFRyZWUuVHJlZUJ1aWxkZXIoKQogICAgdGIuc3RhcnQoIkRzdEFscGhhQmFuZCIsIHt9KQogICAgdGIuZGF0YShzdHIobmJfYmFuZHMgKyAxKSkKICAgIHRiLmVuZCgiRHN0QWxwaGFCYW5kIikKICAgIGVsZW0gPSB0Yi5jbG9zZSgpCiAgICB3YXJwX29wdGlvbnMuYXBwZW5kKGVsZW0pCgogICAgIyBUT0RPOiBnYmF0YWlsbGUgLSB0aGlzIGlzIGEgR0RBTFdhcnBPcHRpb25zLiBXaHkgcHV0IGl0IGluIGEgc3BlY2lmaWMgcGxhY2U/CiAgICB0YiA9IEVsZW1lbnRUcmVlLlRyZWVCdWlsZGVyKCkKICAgIHRiLnN0YXJ0KCJPcHRpb24iLCB7Im5hbWUiOiAiSU5JVF9ERVNUIn0pCiAgICB0Yi5kYXRhKCIwIikKICAgIHRiLmVuZCgiT3B0aW9uIikKICAgIGVsZW0gPSB0Yi5jbG9zZSgpCiAgICB3YXJwX29wdGlvbnMuYXBwZW5kKGVsZW0pCgogICAgcmV0dXJuIEVsZW1lbnRUcmVlLnRvc3RyaW5nKHZydF9yb290KS5kZWNvZGUoKQoKCmRlZiB1cGRhdGVfYWxwaGFfdmFsdWVfZm9yX25vbl9hbHBoYV9pbnB1dHMod2FycGVkX3ZydF9kYXRhc2V0LCBvcHRpb25zPU5vbmUpOgogICAgIiIiCiAgICBIYW5kbGVzIGRhdGFzZXQgd2l0aCAxIG9yIDMgYmFuZHMsIGkuZS4gd2l0aG91dCBhbHBoYSBjaGFubmVsLCBpbiB0aGUgY2FzZSB0aGUgbm9kYXRhIHZhbHVlIGhhcwogICAgbm90IGJlZW4gZm9yY2VkIGJ5IG9wdGlvbnMKICAgICIiIgogICAgaWYgd2FycGVkX3ZydF9kYXRhc2V0LlJhc3RlckNvdW50IGluIFsxLCAzXToKICAgICAgICB0ZW1wZmlsZW5hbWUgPSBnZXR0ZW1wZmlsZW5hbWUoJy1nZGFsMnRpbGVzLnZydCcpCiAgICAgICAgd2FycGVkX3ZydF9kYXRhc2V0LkdldERyaXZlcigpLkNyZWF0ZUNvcHkodGVtcGZpbGVuYW1lLCB3YXJwZWRfdnJ0X2RhdGFzZXQpCiAgICAgICAgd2l0aCBvcGVuKHRlbXBmaWxlbmFtZSkgYXMgZjoKICAgICAgICAgICAgb3JpZ19kYXRhID0gZi5yZWFkKCkKICAgICAgICBhbHBoYV9kYXRhID0gYWRkX2FscGhhX2JhbmRfdG9fc3RyaW5nX3ZydChvcmlnX2RhdGEpCiAgICAgICAgd2l0aCBvcGVuKHRlbXBmaWxlbmFtZSwgJ3cnKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlKGFscGhhX2RhdGEpCgogICAgICAgIHdhcnBlZF92cnRfZGF0YXNldCA9IGdkYWwuT3Blbih0ZW1wZmlsZW5hbWUpCiAgICAgICAgb3MudW5saW5rKHRlbXBmaWxlbmFtZSkKCiAgICAgICAgaWYgb3B0aW9ucyBhbmQgb3B0aW9ucy52ZXJib3NlOgogICAgICAgICAgICBwcmludCgiTW9kaWZpZWQgLWRzdGFscGhhIHdhcnBpbmcgcmVzdWx0IHNhdmVkIGludG8gJ3RpbGVzMS52cnQnIikKICAgICAgICAgICAgIyBUT0RPOiBnYmF0YWlsbGUgLSB0ZXN0IHJlcGxhY2luZyB0aGF0IHdpdGggYSBnZGFsIHdyaXRlIG9mIHRoZSBkYXRhc2V0IChtb3JlCiAgICAgICAgICAgICMgYWNjdXJhdGVseSB3aGF0J3MgdXNlZCwgZXZlbiBpZiBzaG91bGQgYmUgdGhlIHNhbWUKICAgICAgICAgICAgd2l0aCBvcGVuKCJ0aWxlczEudnJ0IiwgInciKSBhcyBmOgogICAgICAgICAgICAgICAgZi53cml0ZShhbHBoYV9kYXRhKQoKICAgIHJldHVybiB3YXJwZWRfdnJ0X2RhdGFzZXQKCgpkZWYgbmJfZGF0YV9iYW5kcyhkYXRhc2V0KToKICAgICIiIgogICAgUmV0dXJuIHRoZSBudW1iZXIgb2YgZGF0YSAobm9uLWFscGhhKSBiYW5kcyBvZiBhIGdkYWwgZGF0YXNldAogICAgIiIiCiAgICBhbHBoYWJhbmQgPSBkYXRhc2V0LkdldFJhc3RlckJhbmQoMSkuR2V0TWFza0JhbmQoKQogICAgaWYgKChhbHBoYWJhbmQuR2V0TWFza0ZsYWdzKCkgJiBnZGFsLkdNRl9BTFBIQSkgb3IKICAgICAgICAgICAgZGF0YXNldC5SYXN0ZXJDb3VudCA9PSA0IG9yCiAgICAgICAgICAgIGRhdGFzZXQuUmFzdGVyQ291bnQgPT0gMik6CiAgICAgICAgcmV0dXJuIGRhdGFzZXQuUmFzdGVyQ291bnQgLSAxCiAgICBlbHNlOgogICAgICAgIHJldHVybiBkYXRhc2V0LlJhc3RlckNvdW50CgoKZGVmIGdldHRlbXBmaWxlbmFtZShzdWZmaXgpOgogICAgIiIiUmV0dXJucyBhIHRlbXBvcmFyeSBmaWxlbmFtZSIiIgogICAgaWYgJ18nIGluIG9zLmVudmlyb246CiAgICAgICAgIyB0ZW1wZmlsZS5ta3RlbXAoKSBjcmFzaGVzIG9uIHNvbWUgV2luZSB2ZXJzaW9ucyAodGhlIG9uZSBvZiBVYnVudHUgMTIuMDQgcGFydGljdWxhcmx5KQogICAgICAgIGlmIG9zLmVudmlyb25bJ18nXS5maW5kKCd3aW5lJykgPj0gMDoKICAgICAgICAgICAgdG1wZGlyID0gJy4nCiAgICAgICAgICAgIGlmICdUTVAnIGluIG9zLmVudmlyb246CiAgICAgICAgICAgICAgICB0bXBkaXIgPSBvcy5lbnZpcm9uWydUTVAnXQogICAgICAgICAgICBpbXBvcnQgdGltZQogICAgICAgICAgICBpbXBvcnQgcmFuZG9tCiAgICAgICAgICAgIHJhbmRvbS5zZWVkKHRpbWUudGltZSgpKQogICAgICAgICAgICByYW5kb21fcGFydCA9ICdmaWxlJWQnICUgcmFuZG9tLnJhbmRpbnQoMCwgMTAwMDAwMDAwMCkKICAgICAgICAgICAgcmV0dXJuIG9zLnBhdGguam9pbih0bXBkaXIsIHJhbmRvbV9wYXJ0ICsgc3VmZml4KQoKICAgIHJldHVybiB0ZW1wZmlsZS5ta3RlbXAoc3VmZml4KQoKCmRlZiBjcmVhdGVfYmFzZV90aWxlKHRpbGVfam9iX2luZm8sIHRpbGVfZGV0YWlsLCBvcHRpb25zLCBxdWV1ZT1Ob25lKToKICAgIGdkYWwuQWxsUmVnaXN0ZXIoKQoKICAgIGRhdGFCYW5kc0NvdW50ID0gdGlsZV9qb2JfaW5mby5uYl9kYXRhX2JhbmRzCiAgICBvdXRwdXQgPSB0aWxlX2pvYl9pbmZvLm91dHB1dF9maWxlX3BhdGgKICAgIHRpbGVleHQgPSB0aWxlX2pvYl9pbmZvLnRpbGVfZXh0ZW5zaW9uCiAgICB0aWxlc2l6ZSA9IHRpbGVfam9iX2luZm8udGlsZV9zaXplCiAgICBvcHRpb25zID0gdGlsZV9qb2JfaW5mby5vcHRpb25zCgogICAgdGlsZWJhbmRzID0gZGF0YUJhbmRzQ291bnQgKyAxCiAgICBkcyA9IGdkYWwuT3Blbih0aWxlX2pvYl9pbmZvLnNyY19maWxlLCBnZGFsLkdBX1JlYWRPbmx5KQogICAgbWVtX2RydiA9IGdkYWwuR2V0RHJpdmVyQnlOYW1lKCdNRU0nKQogICAgb3V0X2RydiA9IGdkYWwuR2V0RHJpdmVyQnlOYW1lKHRpbGVfam9iX2luZm8udGlsZV9kcml2ZXIpCiAgICBhbHBoYWJhbmQgPSBkcy5HZXRSYXN0ZXJCYW5kKDEpLkdldE1hc2tCYW5kKCkKCiAgICB0eCA9IHRpbGVfZGV0YWlsLnR4CiAgICB0eSA9IHRpbGVfZGV0YWlsLnR5CiAgICB0eiA9IHRpbGVfZGV0YWlsLnR6CiAgICByeCA9IHRpbGVfZGV0YWlsLnJ4CiAgICByeSA9IHRpbGVfZGV0YWlsLnJ5CiAgICByeHNpemUgPSB0aWxlX2RldGFpbC5yeHNpemUKICAgIHJ5c2l6ZSA9IHRpbGVfZGV0YWlsLnJ5c2l6ZQogICAgd3ggPSB0aWxlX2RldGFpbC53eAogICAgd3kgPSB0aWxlX2RldGFpbC53eQogICAgd3hzaXplID0gdGlsZV9kZXRhaWwud3hzaXplCiAgICB3eXNpemUgPSB0aWxlX2RldGFpbC53eXNpemUKICAgIHF1ZXJ5c2l6ZSA9IHRpbGVfZGV0YWlsLnF1ZXJ5c2l6ZQoKICAgICMgVGlsZSBkYXRhc2V0IGluIG1lbW9yeQogICAgdGlsZWZpbGVuYW1lID0gb3MucGF0aC5qb2luKAogICAgICAgIG91dHB1dCwgc3RyKHR6KSwgJ3swOjA0ZH0nLmZvcm1hdCh0eCkgKyAiXyIgKyAnezA6MDRkfScuZm9ybWF0KHR5KSArICIuIiArIHRpbGVleHQpCiAgICBkc3RpbGUgPSBtZW1fZHJ2LkNyZWF0ZSgnJywgdGlsZXNpemUsIHRpbGVzaXplLCB0aWxlYmFuZHMpCgogICAgZGF0YSA9IGFscGhhID0gTm9uZQoKICAgIGlmIG9wdGlvbnMudmVyYm9zZToKICAgICAgICBwcmludCgiXHRSZWFkUmFzdGVyIEV4dGVudDogIiwKICAgICAgICAgICAgICAocngsIHJ5LCByeHNpemUsIHJ5c2l6ZSksICh3eCwgd3ksIHd4c2l6ZSwgd3lzaXplKSkKCiAgICAjIFF1ZXJ5IGlzIGluICduZWFyZXN0IG5laWdoYm91cicgYnV0IGNhbiBiZSBiaWdnZXIgaW4gdGhlbiB0aGUgdGlsZXNpemUKICAgICMgV2Ugc2NhbGUgZG93biB0aGUgcXVlcnkgdG8gdGhlIHRpbGVzaXplIGJ5IHN1cHBsaWVkIGFsZ29yaXRobS4KCiAgICBpZiByeHNpemUgIT0gMCBhbmQgcnlzaXplICE9IDAgYW5kIHd4c2l6ZSAhPSAwIGFuZCB3eXNpemUgIT0gMDoKICAgICAgICBkYXRhID0gZHMuUmVhZFJhc3RlcihyeCwgcnksIHJ4c2l6ZSwgcnlzaXplLCB3eHNpemUsIHd5c2l6ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYW5kX2xpc3Q9bGlzdChyYW5nZSgxLCBkYXRhQmFuZHNDb3VudCsxKSkpCiAgICAgICAgYWxwaGEgPSBhbHBoYWJhbmQuUmVhZFJhc3RlcihyeCwgcnksIHJ4c2l6ZSwgcnlzaXplLCB3eHNpemUsIHd5c2l6ZSkKCiAgICAjIFRoZSB0aWxlIGluIG1lbW9yeSBpcyBhIHRyYW5zcGFyZW50IGZpbGUgYnkgZGVmYXVsdC4gV3JpdGUgcGl4ZWwgdmFsdWVzIGludG8gaXQgaWYKICAgICMgYW55CiAgICBpZiBkYXRhOgogICAgICAgIGlmIHRpbGVzaXplID09IHF1ZXJ5c2l6ZToKICAgICAgICAgICAgIyBVc2UgdGhlIFJlYWRSYXN0ZXIgcmVzdWx0IGRpcmVjdGx5IGluIHRpbGVzICgnbmVhcmVzdCBuZWlnaGJvdXInIHF1ZXJ5KQogICAgICAgICAgICBkc3RpbGUuV3JpdGVSYXN0ZXIod3gsIHd5LCB3eHNpemUsIHd5c2l6ZSwgZGF0YSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhbmRfbGlzdD1saXN0KHJhbmdlKDEsIGRhdGFCYW5kc0NvdW50KzEpKSkKICAgICAgICAgICAgZHN0aWxlLldyaXRlUmFzdGVyKHd4LCB3eSwgd3hzaXplLCB3eXNpemUsIGFscGhhLCBiYW5kX2xpc3Q9W3RpbGViYW5kc10pCgogICAgICAgICAgICAjIE5vdGU6IEZvciBzb3VyY2UgZHJpdmVycyBiYXNlZCBvbiBXYXZlTGV0IGNvbXByZXNzaW9uIChKUEVHMjAwMCwgRUNXLAogICAgICAgICAgICAjIE1yU0lEKSB0aGUgUmVhZFJhc3RlciBmdW5jdGlvbiByZXR1cm5zIGhpZ2gtcXVhbGl0eSByYXN0ZXIgKG5vdCB1Z2x5CiAgICAgICAgICAgICMgbmVhcmVzdCBuZWlnaGJvdXIpCiAgICAgICAgICAgICMgVE9ETzogVXNlIGRpcmVjdGx5ICduZWFyJyBmb3IgV2F2ZUxldCBmaWxlcwogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgQmlnIFJlYWRSYXN0ZXIgcXVlcnkgaW4gbWVtb3J5IHNjYWxlZCB0byB0aGUgdGlsZXNpemUgLSBhbGwgYnV0ICduZWFyJwogICAgICAgICAgICAjIGFsZ28KICAgICAgICAgICAgZHNxdWVyeSA9IG1lbV9kcnYuQ3JlYXRlKCcnLCBxdWVyeXNpemUsIHF1ZXJ5c2l6ZSwgdGlsZWJhbmRzKQogICAgICAgICAgICAjIFRPRE86IGZpbGwgdGhlIG51bGwgdmFsdWUgaW4gY2FzZSBhIHRpbGUgd2l0aG91dCBhbHBoYSBpcyBwcm9kdWNlZCAobm93CiAgICAgICAgICAgICMgb25seSBwbmcgdGlsZXMgYXJlIHN1cHBvcnRlZCkKICAgICAgICAgICAgZHNxdWVyeS5Xcml0ZVJhc3Rlcih3eCwgd3ksIHd4c2l6ZSwgd3lzaXplLCBkYXRhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhbmRfbGlzdD1saXN0KHJhbmdlKDEsIGRhdGFCYW5kc0NvdW50KzEpKSkKICAgICAgICAgICAgZHNxdWVyeS5Xcml0ZVJhc3Rlcih3eCwgd3ksIHd4c2l6ZSwgd3lzaXplLCBhbHBoYSwgYmFuZF9saXN0PVt0aWxlYmFuZHNdKQoKICAgICAgICAgICAgc2NhbGVfcXVlcnlfdG9fdGlsZShkc3F1ZXJ5LCBkc3RpbGUsIHRpbGVfam9iX2luZm8udGlsZV9kcml2ZXIsIG9wdGlvbnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGlsZWZpbGVuYW1lPXRpbGVmaWxlbmFtZSkKICAgICAgICAgICAgZGVsIGRzcXVlcnkKCiAgICAjIEZvcmNlIGZyZWVpbmcgdGhlIG1lbW9yeSB0byBtYWtlIHN1cmUgdGhlIEMrKyBkZXN0cnVjdG9yIGlzIGNhbGxlZCBhbmQgdGhlIG1lbW9yeSBhcyB3ZWxsIGFzCiAgICAjIHRoZSBmaWxlIGxvY2tzIGFyZSByZWxlYXNlZAogICAgZGVsIGRzCiAgICBkZWwgZGF0YQoKICAgIGlmIG9wdGlvbnMucmVzYW1wbGluZyAhPSAnYW50aWFsaWFzJzoKICAgICAgICAjIFdyaXRlIGEgY29weSBvZiB0aWxlIHRvIHBuZy9qcGcKICAgICAgICBvdXRfZHJ2LkNyZWF0ZUNvcHkodGlsZWZpbGVuYW1lLCBkc3RpbGUsIHN0cmljdD0wKQoKICAgIGRlbCBkc3RpbGUKCiAgICBvcHRpb25zLmdlbmVyYXRlZEZpbGVzLmFwcGVuZCh0aWxlZmlsZW5hbWUpCiAgICAjIGFwcGx5TGVnZW5kKHRpbGVmaWxlbmFtZSwgb3B0aW9ucy5sZWdlbmRPYmopCgogICAgIyAjIENyZWF0ZSBhIEtNTCBmaWxlIGZvciB0aGlzIHRpbGUuCiAgICAjIGlmIHRpbGVfam9iX2luZm8ua21sOgogICAgIyAgICAga21sZmlsZW5hbWUgPSBvcy5wYXRoLmpvaW4ob3V0cHV0LCBzdHIodHopLCBzdHIodHgpLCAnJWQua21sJyAlIHR5KQogICAgIyAgICAgaWYgbm90IG9wdGlvbnMucmVzdW1lIG9yIG5vdCBvcy5wYXRoLmV4aXN0cyhrbWxmaWxlbmFtZSk6CiAgICAjICAgICAgICAgd2l0aCBvcGVuKGttbGZpbGVuYW1lLCAnd2InKSBhcyBmOgogICAgIyAgICAgICAgICAgICBmLndyaXRlKGdlbmVyYXRlX2ttbCgKICAgICMgICAgICAgICAgICAgICAgIHR4LCB0eSwgdHosIHRpbGVfam9iX2luZm8udGlsZV9leHRlbnNpb24sIHRpbGVfam9iX2luZm8udGlsZV9zaXplLAogICAgIyAgICAgICAgICAgICAgICAgdGlsZV9qb2JfaW5mby50aWxlX3N3bmUsIHRpbGVfam9iX2luZm8ub3B0aW9ucwogICAgIyAgICAgICAgICAgICApLmVuY29kZSgndXRmLTgnKSkKCiAgICBpZiBxdWV1ZToKICAgICAgICBxdWV1ZS5wdXQoInRpbGUgJXMgJXMgJXMiICUgKHR4LCB0eSwgdHopKQoKCmRlZiBjcmVhdGVfb3ZlcnZpZXdfdGlsZXModGlsZV9qb2JfaW5mbywgb3V0cHV0X2ZvbGRlciwgb3B0aW9ucyk6CiAgICAiIiJHZW5lcmF0aW9uIG9mIHRoZSBvdmVydmlldyB0aWxlcyAoaGlnaGVyIGluIHRoZSBweXJhbWlkKSBiYXNlZCBvbiBleGlzdGluZyB0aWxlcyIiIgogICAgbWVtX2RyaXZlciA9IGdkYWwuR2V0RHJpdmVyQnlOYW1lKCdNRU0nKQogICAgdGlsZV9kcml2ZXIgPSB0aWxlX2pvYl9pbmZvLnRpbGVfZHJpdmVyCiAgICBvdXRfZHJpdmVyID0gZ2RhbC5HZXREcml2ZXJCeU5hbWUodGlsZV9kcml2ZXIpCgogICAgdGlsZWJhbmRzID0gdGlsZV9qb2JfaW5mby5uYl9kYXRhX2JhbmRzICsgMQoKICAgICMgVXNhZ2Ugb2YgZXhpc3RpbmcgdGlsZXM6IGZyb20gNCB1bmRlcmx5aW5nIHRpbGVzIGdlbmVyYXRlIG9uZSBhcyBvdmVydmlldy4KCiAgICB0Y291bnQgPSAwCiAgICBmb3IgdHogaW4gcmFuZ2UodGlsZV9qb2JfaW5mby50bWF4eiAtIDEsIHRpbGVfam9iX2luZm8udG1pbnogLSAxLCAtMSk6CiAgICAgICAgdG1pbngsIHRtaW55LCB0bWF4eCwgdG1heHkgPSB0aWxlX2pvYl9pbmZvLnRtaW5tYXhbdHpdCiAgICAgICAgdGNvdW50ICs9ICgxICsgYWJzKHRtYXh4LXRtaW54KSkgKiAoMSArIGFicyh0bWF4eS10bWlueSkpCgogICAgdGkgPSAwCgogICAgaWYgdGNvdW50ID09IDA6CiAgICAgICAgcmV0dXJuCgogICAgaWYgbm90IG9wdGlvbnMucXVpZXQ6CiAgICAgICAgcHJpbnQoIkdlbmVyYXRpbmcgT3ZlcnZpZXcgVGlsZXM6IikKCiAgICBwcm9ncmVzc19iYXIgPSBQcm9ncmVzc0Jhcih0Y291bnQpCiAgICBwcm9ncmVzc19iYXIuc3RhcnQoKQoKICAgIGZvciB0eiBpbiByYW5nZSh0aWxlX2pvYl9pbmZvLnRtYXh6IC0gMSwgdGlsZV9qb2JfaW5mby50bWlueiAtIDEsIC0xKToKICAgICAgICB0bWlueCwgdG1pbnksIHRtYXh4LCB0bWF4eSA9IHRpbGVfam9iX2luZm8udG1pbm1heFt0el0KICAgICAgICBmb3IgdHkgaW4gcmFuZ2UodG1heHksIHRtaW55IC0gMSwgLTEpOgogICAgICAgICAgICBmb3IgdHggaW4gcmFuZ2UodG1pbngsIHRtYXh4ICsgMSk6CgogICAgICAgICAgICAgICAgdGkgKz0gMQogICAgICAgICAgICAgICAgeXRpbGUgPSBHREFMMlRpbGVzLmdldFl0aWxlKHR5LCB0eiwgb3B0aW9ucykKICAgICAgICAgICAgICAgIHRpbGVmaWxlbmFtZSA9IG9zLnBhdGguam9pbihvdXRwdXRfZm9sZGVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cih0eiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgI3N0cih0eCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyIlcy4lcyIgJSAoeXRpbGUsIHRpbGVfam9iX2luZm8udGlsZV9leHRlbnNpb24pKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7MDowNGR9Jy5mb3JtYXQodHgpICsgIl8iICsgJ3swOjA0ZH0nLmZvcm1hdCh5dGlsZSkgKyAiLiIgKyB0aWxlX2pvYl9pbmZvLnRpbGVfZXh0ZW5zaW9uKQoKICAgICAgICAgICAgICAgIGlmIG9wdGlvbnMudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICBwcmludCh0aSwgJy8nLCB0Y291bnQsIHRpbGVmaWxlbmFtZSkKCiAgICAgICAgICAgICAgICBpZiBvcHRpb25zLnJlc3VtZSBhbmQgb3MucGF0aC5leGlzdHModGlsZWZpbGVuYW1lKToKICAgICAgICAgICAgICAgICAgICBpZiBvcHRpb25zLnZlcmJvc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KCJUaWxlIGdlbmVyYXRpb24gc2tpcHBlZCBiZWNhdXNlIG9mIC0tcmVzdW1lIikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBwcm9ncmVzc19iYXIubG9nX3Byb2dyZXNzKCkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgICAgICMgQ3JlYXRlIGRpcmVjdG9yaWVzIGZvciB0aGUgdGlsZQogICAgICAgICAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKG9zLnBhdGguZGlybmFtZSh0aWxlZmlsZW5hbWUpKToKICAgICAgICAgICAgICAgICAgICBvcy5tYWtlZGlycyhvcy5wYXRoLmRpcm5hbWUodGlsZWZpbGVuYW1lKSkKCiAgICAgICAgICAgICAgICBkc3F1ZXJ5ID0gbWVtX2RyaXZlci5DcmVhdGUoJycsIDIgKiB0aWxlX2pvYl9pbmZvLnRpbGVfc2l6ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAyICogdGlsZV9qb2JfaW5mby50aWxlX3NpemUsIHRpbGViYW5kcykKICAgICAgICAgICAgICAgICMgVE9ETzogZmlsbCB0aGUgbnVsbCB2YWx1ZQogICAgICAgICAgICAgICAgZHN0aWxlID0gbWVtX2RyaXZlci5DcmVhdGUoJycsIHRpbGVfam9iX2luZm8udGlsZV9zaXplLCB0aWxlX2pvYl9pbmZvLnRpbGVfc2l6ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbGViYW5kcykKCiAgICAgICAgICAgICAgICAjIFRPRE86IEltcGxlbWVudCBtb3JlIGNsZXZlciB3YWxraW5nIG9uIHRoZSB0aWxlcyB3aXRoIGNhY2hlIGZ1bmN0aW9uYWxpdHkKICAgICAgICAgICAgICAgICMgcHJvYmFibHkgd2FsayBzaG91bGQgc3RhcnQgd2l0aCByZWFkaW5nIG9mIGZvdXIgdGlsZXMgZnJvbSB0b3AgbGVmdCBjb3JuZXIKICAgICAgICAgICAgICAgICMgSGlsYmVydCBjdXJ2ZQoKICAgICAgICAgICAgICAgIGNoaWxkcmVuID0gW10KICAgICAgICAgICAgICAgICMgUmVhZCB0aGUgdGlsZXMgYW5kIHdyaXRlIHRoZW0gdG8gcXVlcnkgd2luZG93CiAgICAgICAgICAgICAgICBmb3IgeSBpbiByYW5nZSgyICogdHksIDIgKiB0eSArIDIpOgogICAgICAgICAgICAgICAgICAgIGZvciB4IGluIHJhbmdlKDIgKiB0eCwgMiAqIHR4ICsgMik6CiAgICAgICAgICAgICAgICAgICAgICAgIG1pbngsIG1pbnksIG1heHgsIG1heHkgPSB0aWxlX2pvYl9pbmZvLnRtaW5tYXhbdHogKyAxXQogICAgICAgICAgICAgICAgICAgICAgICBpZiB4ID49IG1pbnggYW5kIHggPD0gbWF4eCBhbmQgeSA+PSBtaW55IGFuZCB5IDw9IG1heHk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5dGlsZTIgPSBHREFMMlRpbGVzLmdldFl0aWxlKHksIHR6KzEsIG9wdGlvbnMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkc3F1ZXJ5dGlsZSA9IGdkYWwuT3BlbigKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcy5wYXRoLmpvaW4ob3V0cHV0X2ZvbGRlciwgc3RyKHR6ICsgMSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7MDowNGR9Jy5mb3JtYXQoeCkgKyAiXyIgKyAnezA6MDRkfScuZm9ybWF0KHl0aWxlMikgKyAiLiIgKyB0aWxlX2pvYl9pbmZvLnRpbGVfZXh0ZW5zaW9uKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgI3N0cih4KSwgIiVzLiVzIiAlICh5dGlsZTIsIHRpbGVfam9iX2luZm8udGlsZV9leHRlbnNpb24pKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZGFsLkdBX1JlYWRPbmx5KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5ID09IDAgYW5kIHkgPT0gMSkgb3IgKHR5ICE9IDAgYW5kICh5ICUgKDIgKiB0eSkpICE9IDApOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbGVwb3N5ID0gMAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aWxlcG9zeSA9IHRpbGVfam9iX2luZm8udGlsZV9zaXplCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0eDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aWxlcG9zeCA9IHggJSAoMiAqIHR4KSAqIHRpbGVfam9iX2luZm8udGlsZV9zaXplCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGlmIHR4ID09IDAgYW5kIHggPT0gMToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aWxlcG9zeCA9IHRpbGVfam9iX2luZm8udGlsZV9zaXplCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbGVwb3N4ID0gMAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHNxdWVyeS5Xcml0ZVJhc3RlcigKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aWxlcG9zeCwgdGlsZXBvc3ksIHRpbGVfam9iX2luZm8udGlsZV9zaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbGVfam9iX2luZm8udGlsZV9zaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRzcXVlcnl0aWxlLlJlYWRSYXN0ZXIoMCwgMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbGVfam9iX2luZm8udGlsZV9zaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGlsZV9qb2JfaW5mby50aWxlX3NpemUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhbmRfbGlzdD1saXN0KHJhbmdlKDEsIHRpbGViYW5kcyArIDEpKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuLmFwcGVuZChbeCwgeSwgdHogKyAxXSkKCiAgICAgICAgICAgICAgICBzY2FsZV9xdWVyeV90b190aWxlKGRzcXVlcnksIGRzdGlsZSwgdGlsZV9kcml2ZXIsIG9wdGlvbnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbGVmaWxlbmFtZT10aWxlZmlsZW5hbWUpCiAgICAgICAgICAgICAgICAjIFdyaXRlIGEgY29weSBvZiB0aWxlIHRvIHBuZy9qcGcKICAgICAgICAgICAgICAgIGlmIG9wdGlvbnMucmVzYW1wbGluZyAhPSAnYW50aWFsaWFzJzoKICAgICAgICAgICAgICAgICAgICAjIFdyaXRlIGEgY29weSBvZiB0aWxlIHRvIHBuZy9qcGcKICAgICAgICAgICAgICAgICAgICBvdXRfZHJpdmVyLkNyZWF0ZUNvcHkodGlsZWZpbGVuYW1lLCBkc3RpbGUsIHN0cmljdD0wKQoKICAgICAgICAgICAgICAgIGRlbCBkc3RpbGUKCiAgICAgICAgICAgICAgICBvcHRpb25zLmdlbmVyYXRlZEZpbGVzLmFwcGVuZCh0aWxlZmlsZW5hbWUpCiAgICAgICAgICAgICAgICAjIGFwcGx5TGVnZW5kKHRpbGVmaWxlbmFtZSwgb3B0aW9ucy5sZWdlbmRPYmopCgogICAgICAgICAgICAgICAgaWYgb3B0aW9ucy52ZXJib3NlOgogICAgICAgICAgICAgICAgICAgIHByaW50KCJcdGJ1aWxkIGZyb20gem9vbSIsIHR6ICsgMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAiIHRpbGVzOiIsICgyICogdHgsIDIgKiB0eSksICgyICogdHggKyAxLCAyICogdHkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICgyICogdHgsIDIgKiB0eSArIDEpLCAoMiAqIHR4ICsgMSwgMiAqIHR5ICsgMSkpCgogICAgICAgICAgICAgICAgIyAjIENyZWF0ZSBhIEtNTCBmaWxlIGZvciB0aGlzIHRpbGUuCiAgICAgICAgICAgICAgICAjIGlmIHRpbGVfam9iX2luZm8ua21sOgogICAgICAgICAgICAgICAgIyAgICAgd2l0aCBvcGVuKG9zLnBhdGguam9pbigKICAgICAgICAgICAgICAgICMgICAgICAgICBvdXRwdXRfZm9sZGVyLAogICAgICAgICAgICAgICAgIyAgICAgICAgICclZC8lZC8lZC5rbWwnICUgKHR6LCB0eCwgdHkpCiAgICAgICAgICAgICAgICAjICAgICApLCAnd2InKSBhcyBmOgogICAgICAgICAgICAgICAgIyAgICAgICAgIGYud3JpdGUoZ2VuZXJhdGVfa21sKAogICAgICAgICAgICAgICAgIyAgICAgICAgICAgICB0eCwgdHksIHR6LCB0aWxlX2pvYl9pbmZvLnRpbGVfZXh0ZW5zaW9uLCB0aWxlX2pvYl9pbmZvLnRpbGVfc2l6ZSwKICAgICAgICAgICAgICAgICMgICAgICAgICAgICAgZ2V0X3RpbGVfc3duZSh0aWxlX2pvYl9pbmZvLCBvcHRpb25zKSwgb3B0aW9ucywgY2hpbGRyZW4KICAgICAgICAgICAgICAgICMgICAgICAgICApLmVuY29kZSgndXRmLTgnKSkKCiAgICAgICAgICAgICAgICBpZiBub3Qgb3B0aW9ucy52ZXJib3NlIGFuZCBub3Qgb3B0aW9ucy5xdWlldDoKICAgICAgICAgICAgICAgICAgICBwcm9ncmVzc19iYXIubG9nX3Byb2dyZXNzKCkKCgpkZWYgb3B0cGFyc2VfaW5pdCgpOgogICAgIiIiUHJlcGFyZSB0aGUgb3B0aW9uIHBhcnNlciBmb3IgaW5wdXQgKGFyZ3YpIiIiCgogICAgZnJvbSBvcHRwYXJzZSBpbXBvcnQgT3B0aW9uUGFyc2VyLCBPcHRpb25Hcm91cAogICAgdXNhZ2UgPSAiVXNhZ2U6ICVwcm9nIFtvcHRpb25zXSBpbnB1dF9maWxlIFtvdXRwdXRdIgogICAgcCA9IE9wdGlvblBhcnNlcih1c2FnZSwgdmVyc2lvbj0iJXByb2cgIiArIF9fdmVyc2lvbl9fKQogICAgcC5hZGRfb3B0aW9uKCItcCIsICItLXByb2ZpbGUiLCBkZXN0PSdwcm9maWxlJywKICAgICAgICAgICAgICAgICB0eXBlPSdjaG9pY2UnLCBjaG9pY2VzPXByb2ZpbGVfbGlzdCwKICAgICAgICAgICAgICAgICBoZWxwPSgiVGlsZSBjdXR0aW5nIHByb2ZpbGUgKCVzKSAtIGRlZmF1bHQgJ21lcmNhdG9yJyAiCiAgICAgICAgICAgICAgICAgICAgICAgIihHb29nbGUgTWFwcyBjb21wYXRpYmxlKSIgJSAiLCIuam9pbihwcm9maWxlX2xpc3QpKSkKICAgIHAuYWRkX29wdGlvbigiLXIiLCAiLS1yZXNhbXBsaW5nIiwgZGVzdD0icmVzYW1wbGluZyIsCiAgICAgICAgICAgICAgICAgdHlwZT0nY2hvaWNlJywgY2hvaWNlcz1yZXNhbXBsaW5nX2xpc3QsCiAgICAgICAgICAgICAgICAgaGVscD0iUmVzYW1wbGluZyBtZXRob2QgKCVzKSAtIGRlZmF1bHQgJ2F2ZXJhZ2UnIiAlICIsIi5qb2luKHJlc2FtcGxpbmdfbGlzdCkpCiAgICBwLmFkZF9vcHRpb24oIi1zIiwgIi0tc19zcnMiLCBkZXN0PSJzX3NycyIsIG1ldGF2YXI9IlNSUyIsCiAgICAgICAgICAgICAgICAgaGVscD0iVGhlIHNwYXRpYWwgcmVmZXJlbmNlIHN5c3RlbSB1c2VkIGZvciB0aGUgc291cmNlIGlucHV0IGRhdGEiKQogICAgcC5hZGRfb3B0aW9uKCIteiIsICItLXpvb20iLCBkZXN0PSJ6b29tIiwKICAgICAgICAgICAgICAgICBoZWxwPSJab29tIGxldmVscyB0byByZW5kZXIgKGZvcm1hdDonMi01JyBvciAnMTAnKS4iKQogICAgcC5hZGRfb3B0aW9uKCItZSIsICItLXJlc3VtZSIsIGRlc3Q9InJlc3VtZSIsIGFjdGlvbj0ic3RvcmVfdHJ1ZSIsCiAgICAgICAgICAgICAgICAgaGVscD0iUmVzdW1lIG1vZGUuIEdlbmVyYXRlIG9ubHkgbWlzc2luZyBmaWxlcy4iKQogICAgcC5hZGRfb3B0aW9uKCItYSIsICItLXNyY25vZGF0YSIsIGRlc3Q9InNyY25vZGF0YSIsIG1ldGF2YXI9Ik5PREFUQSIsCiAgICAgICAgICAgICAgICAgaGVscD0iTk9EQVRBIHRyYW5zcGFyZW5jeSB2YWx1ZSB0byBhc3NpZ24gdG8gdGhlIGlucHV0IGRhdGEiKQogICAgcC5hZGRfb3B0aW9uKCItZCIsICItLXRtc2NvbXBhdGlibGUiLCBkZXN0PSJ0bXNjb21wYXRpYmxlIiwgYWN0aW9uPSJzdG9yZV90cnVlIiwKICAgICAgICAgICAgICAgICBoZWxwPSgiV2hlbiB1c2luZyB0aGUgZ2VvZGV0aWMgcHJvZmlsZSwgc3BlY2lmaWVzIHRoZSBiYXNlIHJlc29sdXRpb24gIgogICAgICAgICAgICAgICAgICAgICAgICJhcyAwLjcwMzEyNSBvciAyIHRpbGVzIGF0IHpvb20gbGV2ZWwgMC4iKSkKICAgIHAuYWRkX29wdGlvbigiLXgiLCAiLS14eXoiLCAKICAgICAgICAgICAgICAgICBhY3Rpb249J3N0b3JlX3RydWUnLCBkZXN0PSd4eXonLAogICAgICAgICAgICAgICAgIGhlbHA9IlVzZSBYWVogdGlsZSBudW1iZXJpbmcgaW5zdGVhZCBvZiBUTVMiKQogICAgcC5hZGRfb3B0aW9uKCItdiIsICItLXZlcmJvc2UiLAogICAgICAgICAgICAgICAgIGFjdGlvbj0ic3RvcmVfdHJ1ZSIsIGRlc3Q9InZlcmJvc2UiLAogICAgICAgICAgICAgICAgIGhlbHA9IlByaW50IHN0YXR1cyBtZXNzYWdlcyB0byBzdGRvdXQiKQogICAgcC5hZGRfb3B0aW9uKCItcSIsICItLXF1aWV0IiwKICAgICAgICAgICAgICAgICBhY3Rpb249InN0b3JlX3RydWUiLCBkZXN0PSJxdWlldCIsCiAgICAgICAgICAgICAgICAgaGVscD0iRGlzYWJsZSBtZXNzYWdlcyBhbmQgc3RhdHVzIHRvIHN0ZG91dCIpCiAgICBwLmFkZF9vcHRpb24oIi0tcHJvY2Vzc2VzIiwKICAgICAgICAgICAgICAgICBkZXN0PSJuYl9wcm9jZXNzZXMiLAogICAgICAgICAgICAgICAgIHR5cGU9J2ludCcsCiAgICAgICAgICAgICAgICAgaGVscD0iTnVtYmVyIG9mIHByb2Nlc3NlcyB0byB1c2UgZm9yIHRpbGluZyIpCgogICAgIyBLTUwgb3B0aW9ucwogICAgZyA9IE9wdGlvbkdyb3VwKHAsICJLTUwgKEdvb2dsZSBFYXJ0aCkgb3B0aW9ucyIsCiAgICAgICAgICAgICAgICAgICAgIk9wdGlvbnMgZm9yIGdlbmVyYXRlZCBHb29nbGUgRWFydGggU3VwZXJPdmVybGF5IG1ldGFkYXRhIikKICAgIGcuYWRkX29wdGlvbigiLWsiLCAiLS1mb3JjZS1rbWwiLCBkZXN0PSdrbWwnLCBhY3Rpb249InN0b3JlX3RydWUiLAogICAgICAgICAgICAgICAgIGhlbHA9KCJHZW5lcmF0ZSBLTUwgZm9yIEdvb2dsZSBFYXJ0aCAtIGRlZmF1bHQgZm9yICdnZW9kZXRpYycgcHJvZmlsZSBhbmQgIgogICAgICAgICAgICAgICAgICAgICAgICIncmFzdGVyJyBpbiBFUFNHOjQzMjYuIEZvciBhIGRhdGFzZXQgd2l0aCBkaWZmZXJlbnQgcHJvamVjdGlvbiB1c2UgIgogICAgICAgICAgICAgICAgICAgICAgICJ3aXRoIGNhdXRpb24hIikpCiAgICBnLmFkZF9vcHRpb24oIi1uIiwgIi0tbm8ta21sIiwgZGVzdD0na21sJywgYWN0aW9uPSJzdG9yZV9mYWxzZSIsCiAgICAgICAgICAgICAgICAgaGVscD0iQXZvaWQgYXV0b21hdGljIGdlbmVyYXRpb24gb2YgS01MIGZpbGVzIGZvciBFUFNHOjQzMjYiKQogICAgZy5hZGRfb3B0aW9uKCItdSIsICItLXVybCIsIGRlc3Q9J3VybCcsCiAgICAgICAgICAgICAgICAgaGVscD0iVVJMIGFkZHJlc3Mgd2hlcmUgdGhlIGdlbmVyYXRlZCB0aWxlcyBhcmUgZ29pbmcgdG8gYmUgcHVibGlzaGVkIikKICAgIHAuYWRkX29wdGlvbl9ncm91cChnKQoKICAgICMgSFRNTCBvcHRpb25zCiAgICBnID0gT3B0aW9uR3JvdXAocCwgIldlYiB2aWV3ZXIgb3B0aW9ucyIsCiAgICAgICAgICAgICAgICAgICAgIk9wdGlvbnMgZm9yIGdlbmVyYXRlZCBIVE1MIHZpZXdlcnMgYSBsYSBHb29nbGUgTWFwcyIpCiAgICBnLmFkZF9vcHRpb24oIi13IiwgIi0td2Vidmlld2VyIiwgZGVzdD0nd2Vidmlld2VyJywgdHlwZT0nY2hvaWNlJywgY2hvaWNlcz13ZWJ2aWV3ZXJfbGlzdCwKICAgICAgICAgICAgICAgICBoZWxwPSJXZWIgdmlld2VyIHRvIGdlbmVyYXRlICglcykgLSBkZWZhdWx0ICdhbGwnIiAlICIsIi5qb2luKHdlYnZpZXdlcl9saXN0KSkKICAgIGcuYWRkX29wdGlvbigiLXQiLCAiLS10aXRsZSIsIGRlc3Q9J3RpdGxlJywKICAgICAgICAgICAgICAgICBoZWxwPSJUaXRsZSBvZiB0aGUgbWFwIikKICAgIGcuYWRkX29wdGlvbigiLWMiLCAiLS1jb3B5cmlnaHQiLCBkZXN0PSdjb3B5cmlnaHQnLAogICAgICAgICAgICAgICAgIGhlbHA9IkNvcHlyaWdodCBmb3IgdGhlIG1hcCIpCiAgICBnLmFkZF9vcHRpb24oIi1nIiwgIi0tZ29vZ2xla2V5IiwgZGVzdD0nZ29vZ2xla2V5JywKICAgICAgICAgICAgICAgICBoZWxwPSJHb29nbGUgTWFwcyBBUEkga2V5IGZyb20gaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9hcGlzL21hcHMvc2lnbnVwLmh0bWwiKQogICAgZy5hZGRfb3B0aW9uKCItYiIsICItLWJpbmdrZXkiLCBkZXN0PSdiaW5na2V5JywKICAgICAgICAgICAgICAgICBoZWxwPSJCaW5nIE1hcHMgQVBJIGtleSBmcm9tIGh0dHBzOi8vd3d3LmJpbmdtYXBzcG9ydGFsLmNvbS8iKQogICAgcC5hZGRfb3B0aW9uX2dyb3VwKGcpCgogICAgcC5zZXRfZGVmYXVsdHModmVyYm9zZT1GYWxzZSwgcHJvZmlsZT0ibWVyY2F0b3IiLCBrbWw9RmFsc2UsIHVybD0nJywgem9vbT0nMC0yJywgeHl6PVRydWUsCiAgICAgICAgICAgICAgICAgICB3ZWJ2aWV3ZXI9J25vbmUnLCBjb3B5cmlnaHQ9JycsIHJlc2FtcGxpbmc9J25lYXInLCByZXN1bWU9RmFsc2UsCiAgICAgICAgICAgICAgICAgICBnb29nbGVrZXk9J0lOU0VSVF9ZT1VSX0tFWV9IRVJFJywgYmluZ2tleT0nSU5TRVJUX1lPVVJfS0VZX0hFUkUnLAogICAgICAgICAgICAgICAgICAgcHJvY2Vzc2VzPTEpCgogICAgcmV0dXJuIHAKCgpkZWYgcHJvY2Vzc19hcmdzKGFyZ3YpOgogICAgcGFyc2VyID0gb3B0cGFyc2VfaW5pdCgpCiAgICBvcHRpb25zLCBhcmdzID0gcGFyc2VyLnBhcnNlX2FyZ3MoYXJncz1hcmd2KQoKICAgICMgQXJncyBzaG91bGQgYmUgZWl0aGVyIGFuIGlucHV0IGZpbGUgT1IgYW4gaW5wdXQgZmlsZSBhbmQgYW4gb3V0cHV0IGZvbGRlcgogICAgaWYgKGxlbihhcmdzKSA9PSAwKToKICAgICAgICBleGl0X3dpdGhfZXJyb3IoIllvdSBuZWVkIHRvIHNwZWNpZnkgYXQgbGVhc3QgYW4gaW5wdXQgZmlsZSBhcyBhcmd1bWVudCB0byB0aGUgc2NyaXB0IikKICAgIGlmIChsZW4oYXJncykgPiAyKToKICAgICAgICBleGl0X3dpdGhfZXJyb3IoIlByb2Nlc3Npbmcgb2Ygc2V2ZXJhbCBpbnB1dCBmaWxlcyBpcyBub3Qgc3VwcG9ydGVkLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJQbGVhc2UgZmlyc3QgdXNlIGEgdG9vbCBsaWtlIGdkYWxfdnJ0bWVyZ2UucHkgb3IgZ2RhbF9tZXJnZS5weSBvbiB0aGUgIgogICAgICAgICAgICAgICAgICAgICAgICAiZmlsZXM6IGdkYWxfdnJ0bWVyZ2UucHkgLW8gbWVyZ2VkLnZydCAlcyIgJSAiICIuam9pbihhcmdzKSkKCiAgICBpbnB1dF9maWxlID0gYXJnc1swXQogICAgaWYgbm90IG9zLnBhdGguaXNmaWxlKGlucHV0X2ZpbGUpOgogICAgICAgIGV4aXRfd2l0aF9lcnJvcigiVGhlIHByb3ZpZGVkIGlucHV0IGZpbGUgJXMgZG9lcyBub3QgZXhpc3Qgb3IgaXMgbm90IGEgZmlsZSIgJSBpbnB1dF9maWxlKQoKICAgIGlmIGxlbihhcmdzKSA9PSAyOgogICAgICAgIG91dHB1dF9mb2xkZXIgPSBhcmdzWzFdCiAgICBlbHNlOgogICAgICAgIG91dHB1dF9mb2xkZXIgPSBvcy5wYXRoLmJhc2VuYW1lKGlucHV0X2ZpbGUpCgogICAgb3B0aW9ucyA9IG9wdGlvbnNfcG9zdF9wcm9jZXNzaW5nKG9wdGlvbnMsIGlucHV0X2ZpbGUsIG91dHB1dF9mb2xkZXIpCgogICAgcmV0dXJuIGlucHV0X2ZpbGUsIG91dHB1dF9mb2xkZXIsIG9wdGlvbnMKCgpkZWYgb3B0aW9uc19wb3N0X3Byb2Nlc3Npbmcob3B0aW9ucywgaW5wdXRfZmlsZSwgb3V0cHV0X2ZvbGRlcik6CiAgICBpZiBub3Qgb3B0aW9ucy50aXRsZToKICAgICAgICBvcHRpb25zLnRpdGxlID0gb3MucGF0aC5iYXNlbmFtZShpbnB1dF9maWxlKQoKICAgIGlmIG9wdGlvbnMudXJsIGFuZCBub3Qgb3B0aW9ucy51cmwuZW5kc3dpdGgoJy8nKToKICAgICAgICBvcHRpb25zLnVybCArPSAnLycKICAgIGlmIG9wdGlvbnMudXJsOgogICAgICAgIG91dF9wYXRoID0gb3V0cHV0X2ZvbGRlcgogICAgICAgIGlmIG91dF9wYXRoLmVuZHN3aXRoKCIvIik6CiAgICAgICAgICAgIG91dF9wYXRoID0gb3V0X3BhdGhbOi0xXQogICAgICAgIG9wdGlvbnMudXJsICs9IG9zLnBhdGguYmFzZW5hbWUob3V0X3BhdGgpICsgJy8nCgogICAgIyBTdXBwb3J0ZWQgb3B0aW9ucwogICAgaWYgb3B0aW9ucy5yZXNhbXBsaW5nID09ICdhdmVyYWdlJzoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIGdkYWwuUmVnZW5lcmF0ZU92ZXJ2aWV3OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGV4aXRfd2l0aF9lcnJvcigiJ2F2ZXJhZ2UnIHJlc2FtcGxpbmcgYWxnb3JpdGhtIGlzIG5vdCBhdmFpbGFibGUuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJQbGVhc2UgdXNlIC1yICduZWFyJyBhcmd1bWVudCBvciB1cGdyYWRlIHRvIG5ld2VyIHZlcnNpb24gb2YgR0RBTC4iKQoKICAgIGVsaWYgb3B0aW9ucy5yZXNhbXBsaW5nID09ICdhbnRpYWxpYXMnOgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbnVtcHk6ICAgICAjIHB5bGludDpkaXNhYmxlPVcwMTI1CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgZXhpdF93aXRoX2Vycm9yKCInYW50aWFsaWFzJyByZXNhbXBsaW5nIGFsZ29yaXRobSBpcyBub3QgYXZhaWxhYmxlLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiSW5zdGFsbCBQSUwgKFB5dGhvbiBJbWFnaW5nIExpYnJhcnkpIGFuZCBudW1weS4iKQoKICAgIHRyeToKICAgICAgICBvcy5wYXRoLmJhc2VuYW1lKGlucHV0X2ZpbGUpLmVuY29kZSgnYXNjaWknKQogICAgZXhjZXB0IFVuaWNvZGVFbmNvZGVFcnJvcjoKICAgICAgICBmdWxsX2FzY2lpID0gRmFsc2UKICAgIGVsc2U6CiAgICAgICAgZnVsbF9hc2NpaSA9IFRydWUKCiAgICAjIExDX0NUWVBFIGNoZWNrCiAgICBpZiBub3QgZnVsbF9hc2NpaSBhbmQgJ1VURi04JyBub3QgaW4gb3MuZW52aXJvbi5nZXQoIkxDX0NUWVBFIiwgIiIpOgogICAgICAgIGlmIG5vdCBvcHRpb25zLnF1aWV0OgogICAgICAgICAgICBwcmludCgiXG5XQVJOSU5HOiAiCiAgICAgICAgICAgICAgICAgICJZb3UgYXJlIHJ1bm5pbmcgZ2RhbDJ0aWxlc19sb2NhbC5weSB3aXRoIGEgTENfQ1RZUEUgZW52aXJvbm1lbnQgdmFyaWFibGUgdGhhdCBpcyAiCiAgICAgICAgICAgICAgICAgICJub3QgVVRGLTggY29tcGF0aWJsZSwgYW5kIHlvdXIgaW5wdXQgZmlsZSBjb250YWlucyBub24tYXNjaWkgY2hhcmFjdGVycy4gIgogICAgICAgICAgICAgICAgICAiVGhlIGdlbmVyYXRlZCBzYW1wbGUgZ29vZ2xlbWFwcywgb3BlbmxheWVycyBvciAiCiAgICAgICAgICAgICAgICAgICJsZWFmbGV0IGZpbGVzIG1pZ2h0IGNvbnRhaW4gc29tZSBpbnZhbGlkIGNoYXJhY3RlcnMgYXMgYSByZXN1bHRcbiIpCgogICAgIyBPdXRwdXQgdGhlIHJlc3VsdHMKICAgIGlmIG9wdGlvbnMudmVyYm9zZToKICAgICAgICBwcmludCgiT3B0aW9uczoiLCBvcHRpb25zKQogICAgICAgIHByaW50KCJJbnB1dDoiLCBpbnB1dF9maWxlKQogICAgICAgIHByaW50KCJPdXRwdXQ6Iiwgb3V0cHV0X2ZvbGRlcikKICAgICAgICBwcmludCgiQ2FjaGU6ICVzIE1CIiAlIChnZGFsLkdldENhY2hlTWF4KCkgLyAxMDI0IC8gMTAyNCkpCiAgICAgICAgcHJpbnQoJycpCgogICAgcmV0dXJuIG9wdGlvbnMKCgpjbGFzcyBUaWxlRGV0YWlsKG9iamVjdCk6CiAgICB0eCA9IDAKICAgIHR5ID0gMAogICAgdHogPSAwCiAgICByeCA9IDAKICAgIHJ5ID0gMAogICAgcnhzaXplID0gMAogICAgcnlzaXplID0gMAogICAgd3ggPSAwCiAgICB3eSA9IDAKICAgIHd4c2l6ZSA9IDAKICAgIHd5c2l6ZSA9IDAKICAgIHF1ZXJ5c2l6ZSA9IDAKCiAgICBkZWYgX19pbml0X18oc2VsZiwgKiprd2FyZ3MpOgogICAgICAgIGZvciBrZXkgaW4ga3dhcmdzOgogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsIGtleSk6CiAgICAgICAgICAgICAgICBzZXRhdHRyKHNlbGYsIGtleSwga3dhcmdzW2tleV0pCgogICAgZGVmIF9fdW5pY29kZV9fKHNlbGYpOgogICAgICAgIHJldHVybiAiVGlsZURldGFpbCAlc1xuJXNcbiVzXG4iICUgKHNlbGYudHgsIHNlbGYudHksIHNlbGYudHopCgogICAgZGVmIF9fc3RyX18oc2VsZik6CiAgICAgICAgcmV0dXJuICJUaWxlRGV0YWlsICVzXG4lc1xuJXNcbiIgJSAoc2VsZi50eCwgc2VsZi50eSwgc2VsZi50eikKCiAgICBkZWYgX19yZXByX18oc2VsZik6CiAgICAgICAgcmV0dXJuICJUaWxlRGV0YWlsICVzXG4lc1xuJXNcbiIgJSAoc2VsZi50eCwgc2VsZi50eSwgc2VsZi50eikKCgpjbGFzcyBUaWxlSm9iSW5mbyhvYmplY3QpOgogICAgIiIiCiAgICBQbGFpbiBvYmplY3QgdG8gaG9sZCB0aWxlIGpvYiBjb25maWd1cmF0aW9uIGZvciBhIGRhdGFzZXQKICAgICIiIgogICAgc3JjX2ZpbGUgPSAiIgogICAgbmJfZGF0YV9iYW5kcyA9IDAKICAgIG91dHB1dF9maWxlX3BhdGggPSAiIgogICAgdGlsZV9leHRlbnNpb24gPSAiIgogICAgdGlsZV9zaXplID0gMAogICAgdGlsZV9kcml2ZXIgPSBOb25lCiAgICBrbWwgPSBGYWxzZQogICAgdG1pbm1heCA9IFtdCiAgICB0bWlueiA9IDAKICAgIHRtYXh6ID0gMAogICAgaW5fc3JzX3drdCA9IDAKICAgIG91dF9nZW9fdHJhbnMgPSBbXQogICAgb21pbnkgPSAwCiAgICBpc19lcHNnXzQzMjYgPSBGYWxzZQogICAgb3B0aW9ucyA9IE5vbmUKCiAgICBkZWYgX19pbml0X18oc2VsZiwgKiprd2FyZ3MpOgogICAgICAgIGZvciBrZXkgaW4ga3dhcmdzOgogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsIGtleSk6CiAgICAgICAgICAgICAgICBzZXRhdHRyKHNlbGYsIGtleSwga3dhcmdzW2tleV0pCgogICAgZGVmIF9fdW5pY29kZV9fKHNlbGYpOgogICAgICAgIHJldHVybiAiVGlsZUpvYkluZm8gJXNcbiIgJSAoc2VsZi5zcmNfZmlsZSkKCiAgICBkZWYgX19zdHJfXyhzZWxmKToKICAgICAgICByZXR1cm4gIlRpbGVKb2JJbmZvICVzXG4iICUgKHNlbGYuc3JjX2ZpbGUpCgogICAgZGVmIF9fcmVwcl9fKHNlbGYpOgogICAgICAgIHJldHVybiAiVGlsZUpvYkluZm8gJXNcbiIgJSAoc2VsZi5zcmNfZmlsZSkKCgpjbGFzcyBHZGFsMlRpbGVzRXJyb3IoRXhjZXB0aW9uKToKICAgIHBhc3MKCgpjbGFzcyBHREFMMlRpbGVzKG9iamVjdCk6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGlucHV0X2ZpbGUsIG91dHB1dF9mb2xkZXIsIG9wdGlvbnMpOgogICAgICAgICIiIkNvbnN0cnVjdG9yIGZ1bmN0aW9uIC0gaW5pdGlhbGl6YXRpb24iIiIKICAgICAgICBzZWxmLm91dF9kcnYgPSBOb25lCiAgICAgICAgc2VsZi5tZW1fZHJ2ID0gTm9uZQogICAgICAgIHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQgPSBOb25lCiAgICAgICAgc2VsZi5vdXRfc3JzID0gTm9uZQogICAgICAgIHNlbGYubmF0aXZlem9vbSA9IE5vbmUKICAgICAgICBzZWxmLnRtaW5tYXggPSBOb25lCiAgICAgICAgc2VsZi50c2l6ZSA9IE5vbmUKICAgICAgICBzZWxmLm1lcmNhdG9yID0gTm9uZQogICAgICAgIHNlbGYuZ2VvZGV0aWMgPSBOb25lCiAgICAgICAgc2VsZi5hbHBoYWJhbmQgPSBOb25lCiAgICAgICAgc2VsZi5kYXRhQmFuZHNDb3VudCA9IE5vbmUKICAgICAgICBzZWxmLm91dF9ndCA9IE5vbmUKICAgICAgICBzZWxmLnRpbGVzd25lID0gTm9uZQogICAgICAgIHNlbGYuc3duZSA9IE5vbmUKICAgICAgICBzZWxmLm9taW54ID0gTm9uZQogICAgICAgIHNlbGYub21heHggPSBOb25lCiAgICAgICAgc2VsZi5vbWF4eSA9IE5vbmUKICAgICAgICBzZWxmLm9taW55ID0gTm9uZQoKICAgICAgICBzZWxmLmlucHV0X2ZpbGUgPSBOb25lCiAgICAgICAgc2VsZi5vdXRwdXRfZm9sZGVyID0gTm9uZQoKICAgICAgICAjIFRpbGUgZm9ybWF0CiAgICAgICAgc2VsZi50aWxlc2l6ZSA9IDI1NgogICAgICAgIHNlbGYudGlsZWRyaXZlciA9ICdQTkcnCiAgICAgICAgc2VsZi50aWxlZXh0ID0gJ3BuZycKICAgICAgICBzZWxmLnRtcF9kaXIgPSB0ZW1wZmlsZS5ta2R0ZW1wKCkKICAgICAgICBzZWxmLnRtcF92cnRfZmlsZW5hbWUgPSBvcy5wYXRoLmpvaW4oc2VsZi50bXBfZGlyLCBzdHIodXVpZDQoKSkgKyAnLnZydCcpCgogICAgICAgICMgU2hvdWxkIHdlIHJlYWQgYmlnZ2VyIHdpbmRvdyBvZiB0aGUgaW5wdXQgcmFzdGVyIGFuZCBzY2FsZSBpdCBkb3duPwogICAgICAgICMgTm90ZTogTW9kaWZpZWQgbGF0ZXIgYnkgb3Blbl9pbnB1dCgpCiAgICAgICAgIyBOb3QgZm9yICduZWFyJyByZXNhbXBsaW5nCiAgICAgICAgIyBOb3QgZm9yIFdhdmVsZXQgYmFzZWQgZHJpdmVycyAoSlBFRzIwMDAsIEVDVywgTXJTSUQpCiAgICAgICAgIyBOb3QgZm9yICdyYXN0ZXInIHByb2ZpbGUKICAgICAgICBzZWxmLnNjYWxlZHF1ZXJ5ID0gVHJ1ZQogICAgICAgICMgSG93IGJpZyBzaG91bGQgYmUgcXVlcnkgd2luZG93IGJlIGZvciBzY2FsaW5nIGRvd24KICAgICAgICAjIExhdGVyIG9uIHJlc2V0IGFjY29yZGluZyB0aGUgY2hvc2VuIHJlc2FtcGxpbmcgYWxnb3JpZ2h0bQogICAgICAgIHNlbGYucXVlcnlzaXplID0gNCAqIHNlbGYudGlsZXNpemUKCiAgICAgICAgIyBTaG91bGQgd2UgdXNlIFJlYWQgb24gdGhlIGlucHV0IGZpbGUgZm9yIGdlbmVyYXRpbmcgb3ZlcnZpZXcgdGlsZXM/CiAgICAgICAgIyBOb3RlOiBNb2RpZmllZCBsYXRlciBieSBvcGVuX2lucHV0KCkKICAgICAgICAjIE90aGVyd2lzZSB0aGUgb3ZlcnZpZXcgdGlsZXMgYXJlIGdlbmVyYXRlZCBmcm9tIGV4aXN0aW5nIHVuZGVybHlpbmcgdGlsZXMKICAgICAgICBzZWxmLm92ZXJ2aWV3cXVlcnkgPSBGYWxzZQoKICAgICAgICBzZWxmLmlucHV0X2ZpbGUgPSBpbnB1dF9maWxlCiAgICAgICAgc2VsZi5vdXRwdXRfZm9sZGVyID0gb3V0cHV0X2ZvbGRlcgogICAgICAgIHNlbGYub3B0aW9ucyA9IG9wdGlvbnMKCiAgICAgICAgaWYgc2VsZi5vcHRpb25zLnJlc2FtcGxpbmcgPT0gJ25lYXInOgogICAgICAgICAgICBzZWxmLnF1ZXJ5c2l6ZSA9IHNlbGYudGlsZXNpemUKCiAgICAgICAgZWxpZiBzZWxmLm9wdGlvbnMucmVzYW1wbGluZyA9PSAnYmlsaW5lYXInOgogICAgICAgICAgICBzZWxmLnF1ZXJ5c2l6ZSA9IHNlbGYudGlsZXNpemUgKiAyCgogICAgICAgICMgVXNlciBzcGVjaWZpZWQgem9vbSBsZXZlbHMKICAgICAgICBzZWxmLnRtaW56ID0gTm9uZQogICAgICAgIHNlbGYudG1heHogPSBOb25lCiAgICAgICAgaWYgc2VsZi5vcHRpb25zLnpvb206CiAgICAgICAgICAgIG1pbm1heCA9IHNlbGYub3B0aW9ucy56b29tLnNwbGl0KCctJywgMSkKICAgICAgICAgICAgbWlubWF4LmV4dGVuZChbJyddKQogICAgICAgICAgICB6b29tX21pbiwgem9vbV9tYXggPSBtaW5tYXhbOjJdCiAgICAgICAgICAgIHNlbGYudG1pbnogPSBpbnQoem9vbV9taW4pCiAgICAgICAgICAgIGlmIHpvb21fbWF4OgogICAgICAgICAgICAgICAgc2VsZi50bWF4eiA9IGludCh6b29tX21heCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYudG1heHogPSBpbnQoem9vbV9taW4pCgogICAgICAgICMgS01MIGdlbmVyYXRpb24KICAgICAgICBzZWxmLmttbCA9IHNlbGYub3B0aW9ucy5rbWwKCiAgICAjIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGRlZiBvcGVuX2lucHV0KHNlbGYpOgogICAgICAgICIiIkluaXRpYWxpemF0aW9uIG9mIHRoZSBpbnB1dCByYXN0ZXIsIHJlcHJvamVjdGlvbiBpZiBuZWNlc3NhcnkiIiIKICAgICAgICBnZGFsLkFsbFJlZ2lzdGVyKCkKCiAgICAgICAgc2VsZi5vdXRfZHJ2ID0gZ2RhbC5HZXREcml2ZXJCeU5hbWUoc2VsZi50aWxlZHJpdmVyKQogICAgICAgIHNlbGYubWVtX2RydiA9IGdkYWwuR2V0RHJpdmVyQnlOYW1lKCdNRU0nKQoKICAgICAgICBpZiBub3Qgc2VsZi5vdXRfZHJ2OgogICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oIlRoZSAnJXMnIGRyaXZlciB3YXMgbm90IGZvdW5kLCBpcyBpdCBhdmFpbGFibGUgaW4gdGhpcyBHREFMIGJ1aWxkPyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnRpbGVkcml2ZXIpCiAgICAgICAgaWYgbm90IHNlbGYubWVtX2RydjoKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJUaGUgJ01FTScgZHJpdmVyIHdhcyBub3QgZm91bmQsIGlzIGl0IGF2YWlsYWJsZSBpbiB0aGlzIEdEQUwgYnVpbGQ/IikKCiAgICAgICAgIyBPcGVuIHRoZSBpbnB1dCBmaWxlCgogICAgICAgIGlmIHNlbGYuaW5wdXRfZmlsZToKICAgICAgICAgICAgaW5wdXRfZGF0YXNldCA9IGdkYWwuT3BlbihzZWxmLmlucHV0X2ZpbGUsIGdkYWwuR0FfUmVhZE9ubHkpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJObyBpbnB1dCBmaWxlIHdhcyBzcGVjaWZpZWQiKQoKICAgICAgICBpZiBzZWxmLm9wdGlvbnMudmVyYm9zZToKICAgICAgICAgICAgcHJpbnQoIklucHV0IGZpbGU6IiwKICAgICAgICAgICAgICAgICAgIiggJXNQIHggJXNMIC0gJXMgYmFuZHMpIiAlIChpbnB1dF9kYXRhc2V0LlJhc3RlclhTaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0X2RhdGFzZXQuUmFzdGVyWVNpemUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXRfZGF0YXNldC5SYXN0ZXJDb3VudCkpCgogICAgICAgIGlmIG5vdCBpbnB1dF9kYXRhc2V0OgogICAgICAgICAgICAjIE5vdGU6IEdEQUwgcHJpbnRzIHRoZSBFUlJPUiBtZXNzYWdlIHRvbwogICAgICAgICAgICBleGl0X3dpdGhfZXJyb3IoIkl0IGlzIG5vdCBwb3NzaWJsZSB0byBvcGVuIHRoZSBpbnB1dCBmaWxlICclcycuIiAlIHNlbGYuaW5wdXRfZmlsZSkKCiAgICAgICAgIyBSZWFkIG1ldGFkYXRhIGZyb20gdGhlIGlucHV0IGZpbGUKICAgICAgICBpZiBpbnB1dF9kYXRhc2V0LlJhc3RlckNvdW50ID09IDA6CiAgICAgICAgICAgIGV4aXRfd2l0aF9lcnJvcigiSW5wdXQgZmlsZSAnJXMnIGhhcyBubyByYXN0ZXIgYmFuZCIgJSBzZWxmLmlucHV0X2ZpbGUpCgogICAgICAgIGlmIGlucHV0X2RhdGFzZXQuR2V0UmFzdGVyQmFuZCgxKS5HZXRSYXN0ZXJDb2xvclRhYmxlKCk6CiAgICAgICAgICAgIGV4aXRfd2l0aF9lcnJvcigKICAgICAgICAgICAgICAgICJQbGVhc2UgY29udmVydCB0aGlzIGZpbGUgdG8gUkdCL1JHQkEgYW5kIHJ1biBnZGFsMnRpbGVzIG9uIHRoZSByZXN1bHQuIiwKICAgICAgICAgICAgICAgICJGcm9tIHBhbGV0dGVkIGZpbGUgeW91IGNhbiBjcmVhdGUgUkdCQSBmaWxlICh0ZW1wLnZydCkgYnk6XG4iCiAgICAgICAgICAgICAgICAiZ2RhbF90cmFuc2xhdGUgLW9mIHZydCAtZXhwYW5kIHJnYmEgJXMgdGVtcC52cnRcbiIKICAgICAgICAgICAgICAgICJ0aGVuIHJ1bjpcbiIKICAgICAgICAgICAgICAgICJnZGFsMnRpbGVzIHRlbXAudnJ0IiAlIHNlbGYuaW5wdXRfZmlsZQogICAgICAgICAgICApCgogICAgICAgIGluX25vZGF0YSA9IHNldHVwX25vX2RhdGFfdmFsdWVzKGlucHV0X2RhdGFzZXQsIHNlbGYub3B0aW9ucykKCiAgICAgICAgaWYgc2VsZi5vcHRpb25zLnZlcmJvc2U6CiAgICAgICAgICAgIHByaW50KCJQcmVwcm9jZXNzZWQgZmlsZToiLAogICAgICAgICAgICAgICAgICAiKCAlc1AgeCAlc0wgLSAlcyBiYW5kcykiICUgKGlucHV0X2RhdGFzZXQuUmFzdGVyWFNpemUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXRfZGF0YXNldC5SYXN0ZXJZU2l6ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnB1dF9kYXRhc2V0LlJhc3RlckNvdW50KSkKCiAgICAgICAgaW5fc3JzLCBzZWxmLmluX3Nyc193a3QgPSBzZXR1cF9pbnB1dF9zcnMoaW5wdXRfZGF0YXNldCwgc2VsZi5vcHRpb25zKQoKICAgICAgICBzZWxmLm91dF9zcnMgPSBzZXR1cF9vdXRwdXRfc3JzKGluX3Nycywgc2VsZi5vcHRpb25zKQoKICAgICAgICAjIElmIGlucHV0IGFuZCBvdXRwdXQgcmVmZXJlbmNlIHN5c3RlbXMgYXJlIGRpZmZlcmVudCwgd2UgcmVwcm9qZWN0IHRoZSBpbnB1dCBkYXRhc2V0IGludG8KICAgICAgICAjIHRoZSBvdXRwdXQgcmVmZXJlbmNlIHN5c3RlbSBmb3IgZWFzaWVyIG1hbmlwdWxhdGlvbgoKICAgICAgICBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0ID0gTm9uZQoKICAgICAgICBpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSBpbiAoJ21lcmNhdG9yJywgJ2dlb2RldGljJyk6CgogICAgICAgICAgICBpZiBub3QgaW5fc3JzOgogICAgICAgICAgICAgICAgZXhpdF93aXRoX2Vycm9yKAogICAgICAgICAgICAgICAgICAgICJJbnB1dCBmaWxlIGhhcyB1bmtub3duIFNSUy4iLAogICAgICAgICAgICAgICAgICAgICJVc2UgLS1zX3NycyBFU1BHOnh5eiAob3Igc2ltaWxhcikgdG8gcHJvdmlkZSBzb3VyY2UgcmVmZXJlbmNlIHN5c3RlbS4iKQoKICAgICAgICAgICAgaWYgbm90IGhhc19nZW9yZWZlcmVuY2UoaW5wdXRfZGF0YXNldCk6CiAgICAgICAgICAgICAgICBleGl0X3dpdGhfZXJyb3IoCiAgICAgICAgICAgICAgICAgICAgIlRoZXJlIGlzIG5vIGdlb3JlZmVyZW5jZSAtIG5laXRoZXIgYWZmaW5lIHRyYW5zZm9ybWF0aW9uICh3b3JsZGZpbGUpICIKICAgICAgICAgICAgICAgICAgICAibm9yIEdDUHMuIFlvdSBjYW4gZ2VuZXJhdGUgb25seSAncmFzdGVyJyBwcm9maWxlIHRpbGVzLiIsCiAgICAgICAgICAgICAgICAgICAgIkVpdGhlciBnZGFsMnRpbGVzIHdpdGggcGFyYW1ldGVyIC1wICdyYXN0ZXInIG9yIHVzZSBhbm90aGVyIEdJUyAiCiAgICAgICAgICAgICAgICAgICAgInNvZnR3YXJlIGZvciBnZW9yZWZlcmVuY2UgZS5nLiBnZGFsX3RyYW5zZm9ybSAtZ2NwIC8gLWFfdWxsciAvIC1hX3NycyIKICAgICAgICAgICAgICAgICkKCiAgICAgICAgICAgIGlmICgoaW5fc3JzLkV4cG9ydFRvUHJvajQoKSAhPSBzZWxmLm91dF9zcnMuRXhwb3J0VG9Qcm9qNCgpKSBvcgogICAgICAgICAgICAgICAgICAgIChpbnB1dF9kYXRhc2V0LkdldEdDUENvdW50KCkgIT0gMCkpOgogICAgICAgICAgICAgICAgc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldCA9IHJlcHJvamVjdF9kYXRhc2V0KAogICAgICAgICAgICAgICAgICAgIGlucHV0X2RhdGFzZXQsIGluX3Nycywgc2VsZi5vdXRfc3JzKQoKICAgICAgICAgICAgICAgIGlmIGluX25vZGF0YToKICAgICAgICAgICAgICAgICAgICBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0ID0gdXBkYXRlX25vX2RhdGFfdmFsdWVzKAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0LCBpbl9ub2RhdGEsIG9wdGlvbnM9c2VsZi5vcHRpb25zKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0ID0gdXBkYXRlX2FscGhhX3ZhbHVlX2Zvcl9ub25fYWxwaGFfaW5wdXRzKAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0LCBvcHRpb25zPXNlbGYub3B0aW9ucykKCiAgICAgICAgICAgIGlmIHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQgYW5kIHNlbGYub3B0aW9ucy52ZXJib3NlOgogICAgICAgICAgICAgICAgcHJpbnQoIlByb2plY3RlZCBmaWxlOiIsICJ0aWxlcy52cnQiLCAiKCAlc1AgeCAlc0wgLSAlcyBiYW5kcykiICUgKAogICAgICAgICAgICAgICAgICAgIHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQuUmFzdGVyWFNpemUsCiAgICAgICAgICAgICAgICAgICAgc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldC5SYXN0ZXJZU2l6ZSwKICAgICAgICAgICAgICAgICAgICBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0LlJhc3RlckNvdW50KSkKCiAgICAgICAgaWYgbm90IHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQ6CiAgICAgICAgICAgIHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQgPSBpbnB1dF9kYXRhc2V0CgogICAgICAgICNTYWx2YSBvIGFycXVpdm8gcmVwcm9qZXRhZG8KICAgICAgICBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0LkdldERyaXZlcigpLkNyZWF0ZUNvcHkoc2VsZi50bXBfdnJ0X2ZpbGVuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0KQoKICAgICAgICAjIEdldCBhbHBoYSBiYW5kIChlaXRoZXIgZGlyZWN0bHkgb3IgZnJvbSBOT0RBVEEgdmFsdWUpCiAgICAgICAgc2VsZi5hbHBoYWJhbmQgPSBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0LkdldFJhc3RlckJhbmQoMSkuR2V0TWFza0JhbmQoKQogICAgICAgIHNlbGYuZGF0YUJhbmRzQ291bnQgPSBuYl9kYXRhX2JhbmRzKHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQpCgogICAgICAgICMgS01MIHRlc3QKICAgICAgICBzZWxmLmlzZXBzZzQzMjYgPSBGYWxzZQogICAgICAgIHNyczQzMjYgPSBvc3IuU3BhdGlhbFJlZmVyZW5jZSgpCiAgICAgICAgc3JzNDMyNi5JbXBvcnRGcm9tRVBTRyg0MzI2KQogICAgICAgIGlmIHNlbGYub3V0X3NycyBhbmQgc3JzNDMyNi5FeHBvcnRUb1Byb2o0KCkgPT0gc2VsZi5vdXRfc3JzLkV4cG9ydFRvUHJvajQoKToKICAgICAgICAgICAgc2VsZi5rbWwgPSBUcnVlCiAgICAgICAgICAgIHNlbGYuaXNlcHNnNDMyNiA9IFRydWUKICAgICAgICAgICAgaWYgc2VsZi5vcHRpb25zLnZlcmJvc2U6CiAgICAgICAgICAgICAgICBwcmludCgiS01MIGF1dG90ZXN0IE9LISIpCgogICAgICAgICMgUmVhZCB0aGUgZ2VvcmVmZXJlbmNlCiAgICAgICAgc2VsZi5vdXRfZ3QgPSBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0LkdldEdlb1RyYW5zZm9ybSgpCgogICAgICAgICMgVGVzdCB0aGUgc2l6ZSBvZiB0aGUgcGl4ZWwKCiAgICAgICAgIyBSZXBvcnQgZXJyb3IgaW4gY2FzZSByb3RhdGlvbi9za2V3IGlzIGluIGdlb3RyYW5zZm9ybSAocG9zc2libGUgb25seSBpbiAncmFzdGVyJyBwcm9maWxlKQogICAgICAgIGlmIChzZWxmLm91dF9ndFsyXSwgc2VsZi5vdXRfZ3RbNF0pICE9ICgwLCAwKToKICAgICAgICAgICAgZXhpdF93aXRoX2Vycm9yKCJHZW9yZWZlcmVuY2Ugb2YgdGhlIHJhc3RlciBjb250YWlucyByb3RhdGlvbiBvciBza2V3LiAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiU3VjaCByYXN0ZXIgaXMgbm90IHN1cHBvcnRlZC4gUGxlYXNlIHVzZSBnZGFsd2FycCBmaXJzdC4iKQoKICAgICAgICAjIEhlcmUgd2UgZXhwZWN0OiBwaXhlbCBpcyBzcXVhcmUsIG5vIHJvdGF0aW9uIG9uIHRoZSByYXN0ZXIKCiAgICAgICAgIyBPdXRwdXQgQm91bmRzIC0gY29vcmRpbmF0ZXMgaW4gdGhlIG91dHB1dCBTUlMKICAgICAgICBzZWxmLm9taW54ID0gc2VsZi5vdXRfZ3RbMF0KICAgICAgICBzZWxmLm9tYXh4ID0gc2VsZi5vdXRfZ3RbMF0gKyBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0LlJhc3RlclhTaXplICogc2VsZi5vdXRfZ3RbMV0KICAgICAgICBzZWxmLm9tYXh5ID0gc2VsZi5vdXRfZ3RbM10KICAgICAgICBzZWxmLm9taW55ID0gc2VsZi5vdXRfZ3RbM10gLSBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0LlJhc3RlcllTaXplICogc2VsZi5vdXRfZ3RbMV0KICAgICAgICAjIE5vdGU6IG1heWJlIHJvdW5kKHgsIDE0KSB0byBhdm9pZCB0aGUgZ2RhbF90cmFuc2xhdGUgYmVoYXZpb3VyLCB3aGVuIDAgYmVjb21lcyAtMWUtMTUKCiAgICAgICAgaWYgc2VsZi5vcHRpb25zLnZlcmJvc2U6CiAgICAgICAgICAgIHByaW50KCJCb3VuZHMgKG91dHB1dCBzcnMpOiIsIHJvdW5kKHNlbGYub21pbngsIDEzKSwgc2VsZi5vbWlueSwgc2VsZi5vbWF4eCwgc2VsZi5vbWF4eSkKCiAgICAgICAgIyBDYWxjdWxhdGluZyByYW5nZXMgZm9yIHRpbGVzIGluIGRpZmZlcmVudCB6b29tIGxldmVscwogICAgICAgIGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdtZXJjYXRvcic6CgogICAgICAgICAgICBzZWxmLm1lcmNhdG9yID0gR2xvYmFsTWVyY2F0b3IoKQoKICAgICAgICAgICAgIyBGdW5jdGlvbiB3aGljaCBnZW5lcmF0ZXMgU1dORSBpbiBMYXRMb25nIGZvciBnaXZlbiB0aWxlCiAgICAgICAgICAgIHNlbGYudGlsZXN3bmUgPSBzZWxmLm1lcmNhdG9yLlRpbGVMYXRMb25Cb3VuZHMKCiAgICAgICAgICAgICMgR2VuZXJhdGUgdGFibGUgd2l0aCBtaW4gbWF4IHRpbGUgY29vcmRpbmF0ZXMgZm9yIGFsbCB6b29tbGV2ZWxzCiAgICAgICAgICAgIHNlbGYudG1pbm1heCA9IGxpc3QocmFuZ2UoMCwgMzIpKQogICAgICAgICAgICBmb3IgdHogaW4gcmFuZ2UoMCwgMzIpOgogICAgICAgICAgICAgICAgdG1pbngsIHRtaW55ID0gc2VsZi5tZXJjYXRvci5NZXRlcnNUb1RpbGUoc2VsZi5vbWlueCwgc2VsZi5vbWlueSwgdHopCiAgICAgICAgICAgICAgICB0bWF4eCwgdG1heHkgPSBzZWxmLm1lcmNhdG9yLk1ldGVyc1RvVGlsZShzZWxmLm9tYXh4LCBzZWxmLm9tYXh5LCB0eikKICAgICAgICAgICAgICAgICMgY3JvcCB0aWxlcyBleHRlbmRpbmcgd29ybGQgbGltaXRzICgrLTE4MCwrLTkwKQogICAgICAgICAgICAgICAgdG1pbngsIHRtaW55ID0gbWF4KDAsIHRtaW54KSwgbWF4KDAsIHRtaW55KQogICAgICAgICAgICAgICAgdG1heHgsIHRtYXh5ID0gbWluKDIqKnR6LTEsIHRtYXh4KSwgbWluKDIqKnR6LTEsIHRtYXh5KQogICAgICAgICAgICAgICAgc2VsZi50bWlubWF4W3R6XSA9ICh0bWlueCwgdG1pbnksIHRtYXh4LCB0bWF4eSkKCiAgICAgICAgICAgICMgVE9ETzogTWFwcyBjcm9zc2luZyAxODBFIChBbGFza2E/KQoKICAgICAgICAgICAgIyBHZXQgdGhlIG1pbmltYWwgem9vbSBsZXZlbCAobWFwIGNvdmVycyBhcmVhIGVxdWl2YWxlbnQgdG8gb25lIHRpbGUpCiAgICAgICAgICAgIGlmIHNlbGYudG1pbnogaXMgTm9uZToKICAgICAgICAgICAgICAgIHNlbGYudG1pbnogPSBzZWxmLm1lcmNhdG9yLlpvb21Gb3JQaXhlbFNpemUoCiAgICAgICAgICAgICAgICAgICAgc2VsZi5vdXRfZ3RbMV0gKgogICAgICAgICAgICAgICAgICAgIG1heChzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0LlJhc3RlclhTaXplLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0LlJhc3RlcllTaXplKSAvCiAgICAgICAgICAgICAgICAgICAgZmxvYXQoc2VsZi50aWxlc2l6ZSkpCgogICAgICAgICAgICAjIEdldCB0aGUgbWF4aW1hbCB6b29tIGxldmVsCiAgICAgICAgICAgICMgKGNsb3Nlc3QgcG9zc2libGUgem9vbSBsZXZlbCB1cCBvbiB0aGUgcmVzb2x1dGlvbiBvZiByYXN0ZXIpCiAgICAgICAgICAgIGlmIHNlbGYudG1heHogaXMgTm9uZToKICAgICAgICAgICAgICAgIHNlbGYudG1heHogPSBzZWxmLm1lcmNhdG9yLlpvb21Gb3JQaXhlbFNpemUoc2VsZi5vdXRfZ3RbMV0pCgogICAgICAgICAgICBpZiBzZWxmLm9wdGlvbnMudmVyYm9zZToKICAgICAgICAgICAgICAgIHByaW50KCJCb3VuZHMgKGxhdGxvbmcpOiIsCiAgICAgICAgICAgICAgICAgICAgICBzZWxmLm1lcmNhdG9yLk1ldGVyc1RvTGF0TG9uKHNlbGYub21pbngsIHNlbGYub21pbnkpLAogICAgICAgICAgICAgICAgICAgICAgc2VsZi5tZXJjYXRvci5NZXRlcnNUb0xhdExvbihzZWxmLm9tYXh4LCBzZWxmLm9tYXh5KSkKICAgICAgICAgICAgICAgIHByaW50KCdNaW5ab29tTGV2ZWw6Jywgc2VsZi50bWlueikKICAgICAgICAgICAgICAgIHByaW50KCJNYXhab29tTGV2ZWw6IiwKICAgICAgICAgICAgICAgICAgICAgIHNlbGYudG1heHosCiAgICAgICAgICAgICAgICAgICAgICAiKCIsCiAgICAgICAgICAgICAgICAgICAgICBzZWxmLm1lcmNhdG9yLlJlc29sdXRpb24oc2VsZi50bWF4eiksCiAgICAgICAgICAgICAgICAgICAgICAiKSIpCgogICAgICAgIGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdnZW9kZXRpYyc6CgogICAgICAgICAgICBzZWxmLmdlb2RldGljID0gR2xvYmFsR2VvZGV0aWMoc2VsZi5vcHRpb25zLnRtc2NvbXBhdGlibGUpCgogICAgICAgICAgICAjIEZ1bmN0aW9uIHdoaWNoIGdlbmVyYXRlcyBTV05FIGluIExhdExvbmcgZm9yIGdpdmVuIHRpbGUKICAgICAgICAgICAgc2VsZi50aWxlc3duZSA9IHNlbGYuZ2VvZGV0aWMuVGlsZUxhdExvbkJvdW5kcwoKICAgICAgICAgICAgIyBHZW5lcmF0ZSB0YWJsZSB3aXRoIG1pbiBtYXggdGlsZSBjb29yZGluYXRlcyBmb3IgYWxsIHpvb21sZXZlbHMKICAgICAgICAgICAgc2VsZi50bWlubWF4ID0gbGlzdChyYW5nZSgwLCAzMikpCiAgICAgICAgICAgIGZvciB0eiBpbiByYW5nZSgwLCAzMik6CiAgICAgICAgICAgICAgICB0bWlueCwgdG1pbnkgPSBzZWxmLmdlb2RldGljLkxvbkxhdFRvVGlsZShzZWxmLm9taW54LCBzZWxmLm9taW55LCB0eikKICAgICAgICAgICAgICAgIHRtYXh4LCB0bWF4eSA9IHNlbGYuZ2VvZGV0aWMuTG9uTGF0VG9UaWxlKHNlbGYub21heHgsIHNlbGYub21heHksIHR6KQogICAgICAgICAgICAgICAgIyBjcm9wIHRpbGVzIGV4dGVuZGluZyB3b3JsZCBsaW1pdHMgKCstMTgwLCstOTApCiAgICAgICAgICAgICAgICB0bWlueCwgdG1pbnkgPSBtYXgoMCwgdG1pbngpLCBtYXgoMCwgdG1pbnkpCiAgICAgICAgICAgICAgICB0bWF4eCwgdG1heHkgPSBtaW4oMioqKHR6KzEpLTEsIHRtYXh4KSwgbWluKDIqKnR6LTEsIHRtYXh5KQogICAgICAgICAgICAgICAgc2VsZi50bWlubWF4W3R6XSA9ICh0bWlueCwgdG1pbnksIHRtYXh4LCB0bWF4eSkKCiAgICAgICAgICAgICMgVE9ETzogTWFwcyBjcm9zc2luZyAxODBFIChBbGFza2E/KQoKICAgICAgICAgICAgIyBHZXQgdGhlIG1heGltYWwgem9vbSBsZXZlbAogICAgICAgICAgICAjIChjbG9zZXN0IHBvc3NpYmxlIHpvb20gbGV2ZWwgdXAgb24gdGhlIHJlc29sdXRpb24gb2YgcmFzdGVyKQogICAgICAgICAgICBpZiBzZWxmLnRtaW56IGlzIE5vbmU6CiAgICAgICAgICAgICAgICBzZWxmLnRtaW56ID0gc2VsZi5nZW9kZXRpYy5ab29tRm9yUGl4ZWxTaXplKAogICAgICAgICAgICAgICAgICAgIHNlbGYub3V0X2d0WzFdICoKICAgICAgICAgICAgICAgICAgICBtYXgoc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldC5SYXN0ZXJYU2l6ZSwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldC5SYXN0ZXJZU2l6ZSkgLwogICAgICAgICAgICAgICAgICAgIGZsb2F0KHNlbGYudGlsZXNpemUpKQoKICAgICAgICAgICAgIyBHZXQgdGhlIG1heGltYWwgem9vbSBsZXZlbAogICAgICAgICAgICAjIChjbG9zZXN0IHBvc3NpYmxlIHpvb20gbGV2ZWwgdXAgb24gdGhlIHJlc29sdXRpb24gb2YgcmFzdGVyKQogICAgICAgICAgICBpZiBzZWxmLnRtYXh6IGlzIE5vbmU6CiAgICAgICAgICAgICAgICBzZWxmLnRtYXh6ID0gc2VsZi5nZW9kZXRpYy5ab29tRm9yUGl4ZWxTaXplKHNlbGYub3V0X2d0WzFdKQoKICAgICAgICAgICAgaWYgc2VsZi5vcHRpb25zLnZlcmJvc2U6CiAgICAgICAgICAgICAgICBwcmludCgiQm91bmRzIChsYXRsb25nKToiLCBzZWxmLm9taW54LCBzZWxmLm9taW55LCBzZWxmLm9tYXh4LCBzZWxmLm9tYXh5KQoKICAgICAgICBpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAncmFzdGVyJzoKCiAgICAgICAgICAgIGRlZiBsb2cyKHgpOgogICAgICAgICAgICAgICAgcmV0dXJuIG1hdGgubG9nMTAoeCkgLyBtYXRoLmxvZzEwKDIpCgogICAgICAgICAgICBzZWxmLm5hdGl2ZXpvb20gPSBpbnQoCiAgICAgICAgICAgICAgICBtYXgobWF0aC5jZWlsKGxvZzIoc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldC5SYXN0ZXJYU2l6ZS9mbG9hdChzZWxmLnRpbGVzaXplKSkpLAogICAgICAgICAgICAgICAgICAgIG1hdGguY2VpbChsb2cyKHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQuUmFzdGVyWVNpemUvZmxvYXQoc2VsZi50aWxlc2l6ZSkpKSkpCgogICAgICAgICAgICBpZiBzZWxmLm9wdGlvbnMudmVyYm9zZToKICAgICAgICAgICAgICAgIHByaW50KCJOYXRpdmUgem9vbSBvZiB0aGUgcmFzdGVyOiIsIHNlbGYubmF0aXZlem9vbSkKCiAgICAgICAgICAgICMgR2V0IHRoZSBtaW5pbWFsIHpvb20gbGV2ZWwgKHdob2xlIHJhc3RlciBpbiBvbmUgdGlsZSkKICAgICAgICAgICAgaWYgc2VsZi50bWlueiBpcyBOb25lOgogICAgICAgICAgICAgICAgc2VsZi50bWlueiA9IDAKCiAgICAgICAgICAgICMgR2V0IHRoZSBtYXhpbWFsIHpvb20gbGV2ZWwgKG5hdGl2ZSByZXNvbHV0aW9uIG9mIHRoZSByYXN0ZXIpCiAgICAgICAgICAgIGlmIHNlbGYudG1heHogaXMgTm9uZToKICAgICAgICAgICAgICAgIHNlbGYudG1heHogPSBzZWxmLm5hdGl2ZXpvb20KCiAgICAgICAgICAgICMgR2VuZXJhdGUgdGFibGUgd2l0aCBtaW4gbWF4IHRpbGUgY29vcmRpbmF0ZXMgZm9yIGFsbCB6b29tbGV2ZWxzCiAgICAgICAgICAgIHNlbGYudG1pbm1heCA9IGxpc3QocmFuZ2UoMCwgc2VsZi50bWF4eisxKSkKICAgICAgICAgICAgc2VsZi50c2l6ZSA9IGxpc3QocmFuZ2UoMCwgc2VsZi50bWF4eisxKSkKICAgICAgICAgICAgZm9yIHR6IGluIHJhbmdlKDAsIHNlbGYudG1heHorMSk6CiAgICAgICAgICAgICAgICB0c2l6ZSA9IDIuMCoqKHNlbGYubmF0aXZlem9vbS10eikqc2VsZi50aWxlc2l6ZQogICAgICAgICAgICAgICAgdG1pbngsIHRtaW55ID0gMCwgMAogICAgICAgICAgICAgICAgdG1heHggPSBpbnQobWF0aC5jZWlsKHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQuUmFzdGVyWFNpemUgLyB0c2l6ZSkpIC0gMQogICAgICAgICAgICAgICAgdG1heHkgPSBpbnQobWF0aC5jZWlsKHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQuUmFzdGVyWVNpemUgLyB0c2l6ZSkpIC0gMQogICAgICAgICAgICAgICAgc2VsZi50c2l6ZVt0el0gPSBtYXRoLmNlaWwodHNpemUpCiAgICAgICAgICAgICAgICBzZWxmLnRtaW5tYXhbdHpdID0gKHRtaW54LCB0bWlueSwgdG1heHgsIHRtYXh5KQoKICAgICAgICAgICAgIyBGdW5jdGlvbiB3aGljaCBnZW5lcmF0ZXMgU1dORSBpbiBMYXRMb25nIGZvciBnaXZlbiB0aWxlCiAgICAgICAgICAgIGlmIHNlbGYua21sIGFuZCBzZWxmLmluX3Nyc193a3Q6CiAgICAgICAgICAgICAgICBjdCA9IG9zci5Db29yZGluYXRlVHJhbnNmb3JtYXRpb24oaW5fc3JzLCBzcnM0MzI2KQoKICAgICAgICAgICAgICAgIGRlZiByYXN0ZXJ0aWxlc3duZSh4LCB5LCB6KToKICAgICAgICAgICAgICAgICAgICBwaXhlbHNpemV4ID0gKDIqKihzZWxmLnRtYXh6LXopICogc2VsZi5vdXRfZ3RbMV0pICAgICAgICMgWC1waXhlbCBzaXplIGluIGxldmVsCiAgICAgICAgICAgICAgICAgICAgd2VzdCA9IHNlbGYub3V0X2d0WzBdICsgeCpzZWxmLnRpbGVzaXplKnBpeGVsc2l6ZXgKICAgICAgICAgICAgICAgICAgICBlYXN0ID0gd2VzdCArIHNlbGYudGlsZXNpemUqcGl4ZWxzaXpleAogICAgICAgICAgICAgICAgICAgIHNvdXRoID0gc2VsZi5vbWlueSArIHkqc2VsZi50aWxlc2l6ZSpwaXhlbHNpemV4CiAgICAgICAgICAgICAgICAgICAgbm9ydGggPSBzb3V0aCArIHNlbGYudGlsZXNpemUqcGl4ZWxzaXpleAogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLmlzZXBzZzQzMjY6CiAgICAgICAgICAgICAgICAgICAgICAgICMgVHJhbnNmb3JtYXRpb24gdG8gRVBTRzo0MzI2IChXR1M4NCBkYXR1bSkKICAgICAgICAgICAgICAgICAgICAgICAgd2VzdCwgc291dGggPSBjdC5UcmFuc2Zvcm1Qb2ludCh3ZXN0LCBzb3V0aClbOjJdCiAgICAgICAgICAgICAgICAgICAgICAgIGVhc3QsIG5vcnRoID0gY3QuVHJhbnNmb3JtUG9pbnQoZWFzdCwgbm9ydGgpWzoyXQogICAgICAgICAgICAgICAgICAgIHJldHVybiBzb3V0aCwgd2VzdCwgbm9ydGgsIGVhc3QKCiAgICAgICAgICAgICAgICBzZWxmLnRpbGVzd25lID0gcmFzdGVydGlsZXN3bmUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYudGlsZXN3bmUgPSBsYW1iZGEgeCwgeSwgejogKDAsIDAsIDAsIDApICAgIyBub3FhCgogICAgZGVmIGdlbmVyYXRlX21ldGFkYXRhKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEdlbmVyYXRpb24gb2YgbWFpbiBtZXRhZGF0YSBmaWxlcyBhbmQgSFRNTCB2aWV3ZXJzIChtZXRhZGF0YSByZWxhdGVkIHRvIHBhcnRpY3VsYXIKICAgICAgICB0aWxlcyBhcmUgZ2VuZXJhdGVkIGR1cmluZyB0aGUgdGlsZSBwcm9jZXNzaW5nKS4KICAgICAgICAiIiIKCiAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKHNlbGYub3V0cHV0X2ZvbGRlcik6CiAgICAgICAgICAgIG9zLm1ha2VkaXJzKHNlbGYub3V0cHV0X2ZvbGRlcikKCiAgICAgICAgaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ21lcmNhdG9yJzoKCiAgICAgICAgICAgIHNvdXRoLCB3ZXN0ID0gc2VsZi5tZXJjYXRvci5NZXRlcnNUb0xhdExvbihzZWxmLm9taW54LCBzZWxmLm9taW55KQogICAgICAgICAgICBub3J0aCwgZWFzdCA9IHNlbGYubWVyY2F0b3IuTWV0ZXJzVG9MYXRMb24oc2VsZi5vbWF4eCwgc2VsZi5vbWF4eSkKICAgICAgICAgICAgc291dGgsIHdlc3QgPSBtYXgoLTg1LjA1MTEyODc4LCBzb3V0aCksIG1heCgtMTgwLjAsIHdlc3QpCiAgICAgICAgICAgIG5vcnRoLCBlYXN0ID0gbWluKDg1LjA1MTEyODc4LCBub3J0aCksIG1pbigxODAuMCwgZWFzdCkKICAgICAgICAgICAgc2VsZi5zd25lID0gKHNvdXRoLCB3ZXN0LCBub3J0aCwgZWFzdCkKCiAgICAgICAgICAgICMgR2VuZXJhdGUgZ29vZ2xlbWFwcy5odG1sCiAgICAgICAgICAgIGlmIHNlbGYub3B0aW9ucy53ZWJ2aWV3ZXIgaW4gKCdhbGwnLCAnZ29vZ2xlJykgYW5kIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdtZXJjYXRvcic6CiAgICAgICAgICAgICAgICBpZiAobm90IHNlbGYub3B0aW9ucy5yZXN1bWUgb3Igbm90CiAgICAgICAgICAgICAgICAgICAgICAgIG9zLnBhdGguZXhpc3RzKG9zLnBhdGguam9pbihzZWxmLm91dHB1dF9mb2xkZXIsICdnb29nbGVtYXBzLmh0bWwnKSkpOgogICAgICAgICAgICAgICAgICAgIHdpdGggb3Blbihvcy5wYXRoLmpvaW4oc2VsZi5vdXRwdXRfZm9sZGVyLCAnZ29vZ2xlbWFwcy5odG1sJyksICd3YicpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgICAgIGYud3JpdGUoc2VsZi5nZW5lcmF0ZV9nb29nbGVtYXBzKCkuZW5jb2RlKCd1dGYtOCcpKQoKICAgICAgICAgICAgIyBHZW5lcmF0ZSBvcGVubGF5ZXJzLmh0bWwKICAgICAgICAgICAgaWYgc2VsZi5vcHRpb25zLndlYnZpZXdlciBpbiAoJ2FsbCcsICdvcGVubGF5ZXJzJyk6CiAgICAgICAgICAgICAgICBpZiAobm90IHNlbGYub3B0aW9ucy5yZXN1bWUgb3Igbm90CiAgICAgICAgICAgICAgICAgICAgICAgIG9zLnBhdGguZXhpc3RzKG9zLnBhdGguam9pbihzZWxmLm91dHB1dF9mb2xkZXIsICdvcGVubGF5ZXJzLmh0bWwnKSkpOgogICAgICAgICAgICAgICAgICAgIHdpdGggb3Blbihvcy5wYXRoLmpvaW4oc2VsZi5vdXRwdXRfZm9sZGVyLCAnb3BlbmxheWVycy5odG1sJyksICd3YicpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgICAgIGYud3JpdGUoc2VsZi5nZW5lcmF0ZV9vcGVubGF5ZXJzKCkuZW5jb2RlKCd1dGYtOCcpKQoKICAgICAgICAgICAgIyBHZW5lcmF0ZSBsZWFmbGV0Lmh0bWwKICAgICAgICAgICAgaWYgc2VsZi5vcHRpb25zLndlYnZpZXdlciBpbiAoJ2FsbCcsICdsZWFmbGV0Jyk6CiAgICAgICAgICAgICAgICBpZiAobm90IHNlbGYub3B0aW9ucy5yZXN1bWUgb3Igbm90CiAgICAgICAgICAgICAgICAgICAgICAgIG9zLnBhdGguZXhpc3RzKG9zLnBhdGguam9pbihzZWxmLm91dHB1dF9mb2xkZXIsICdsZWFmbGV0Lmh0bWwnKSkpOgogICAgICAgICAgICAgICAgICAgIHdpdGggb3Blbihvcy5wYXRoLmpvaW4oc2VsZi5vdXRwdXRfZm9sZGVyLCAnbGVhZmxldC5odG1sJyksICd3YicpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgICAgIGYud3JpdGUoc2VsZi5nZW5lcmF0ZV9sZWFmbGV0KCkuZW5jb2RlKCd1dGYtOCcpKQoKICAgICAgICBlbGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdnZW9kZXRpYyc6CgogICAgICAgICAgICB3ZXN0LCBzb3V0aCA9IHNlbGYub21pbngsIHNlbGYub21pbnkKICAgICAgICAgICAgZWFzdCwgbm9ydGggPSBzZWxmLm9tYXh4LCBzZWxmLm9tYXh5CiAgICAgICAgICAgIHNvdXRoLCB3ZXN0ID0gbWF4KC05MC4wLCBzb3V0aCksIG1heCgtMTgwLjAsIHdlc3QpCiAgICAgICAgICAgIG5vcnRoLCBlYXN0ID0gbWluKDkwLjAsIG5vcnRoKSwgbWluKDE4MC4wLCBlYXN0KQogICAgICAgICAgICBzZWxmLnN3bmUgPSAoc291dGgsIHdlc3QsIG5vcnRoLCBlYXN0KQoKICAgICAgICAgICAgIyBHZW5lcmF0ZSBvcGVubGF5ZXJzLmh0bWwKICAgICAgICAgICAgaWYgc2VsZi5vcHRpb25zLndlYnZpZXdlciBpbiAoJ2FsbCcsICdvcGVubGF5ZXJzJyk6CiAgICAgICAgICAgICAgICBpZiAobm90IHNlbGYub3B0aW9ucy5yZXN1bWUgb3Igbm90CiAgICAgICAgICAgICAgICAgICAgICAgIG9zLnBhdGguZXhpc3RzKG9zLnBhdGguam9pbihzZWxmLm91dHB1dF9mb2xkZXIsICdvcGVubGF5ZXJzLmh0bWwnKSkpOgogICAgICAgICAgICAgICAgICAgIHdpdGggb3Blbihvcy5wYXRoLmpvaW4oc2VsZi5vdXRwdXRfZm9sZGVyLCAnb3BlbmxheWVycy5odG1sJyksICd3YicpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgICAgIGYud3JpdGUoc2VsZi5nZW5lcmF0ZV9vcGVubGF5ZXJzKCkuZW5jb2RlKCd1dGYtOCcpKQoKICAgICAgICBlbGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdyYXN0ZXInOgoKICAgICAgICAgICAgd2VzdCwgc291dGggPSBzZWxmLm9taW54LCBzZWxmLm9taW55CiAgICAgICAgICAgIGVhc3QsIG5vcnRoID0gc2VsZi5vbWF4eCwgc2VsZi5vbWF4eQoKICAgICAgICAgICAgc2VsZi5zd25lID0gKHNvdXRoLCB3ZXN0LCBub3J0aCwgZWFzdCkKCiAgICAgICAgICAgICMgR2VuZXJhdGUgb3BlbmxheWVycy5odG1sCiAgICAgICAgICAgIGlmIHNlbGYub3B0aW9ucy53ZWJ2aWV3ZXIgaW4gKCdhbGwnLCAnb3BlbmxheWVycycpOgogICAgICAgICAgICAgICAgaWYgKG5vdCBzZWxmLm9wdGlvbnMucmVzdW1lIG9yIG5vdAogICAgICAgICAgICAgICAgICAgICAgICBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4oc2VsZi5vdXRwdXRfZm9sZGVyLCAnb3BlbmxheWVycy5odG1sJykpKToKICAgICAgICAgICAgICAgICAgICB3aXRoIG9wZW4ob3MucGF0aC5qb2luKHNlbGYub3V0cHV0X2ZvbGRlciwgJ29wZW5sYXllcnMuaHRtbCcpLCAnd2InKSBhcyBmOgogICAgICAgICAgICAgICAgICAgICAgICBmLndyaXRlKHNlbGYuZ2VuZXJhdGVfb3BlbmxheWVycygpLmVuY29kZSgndXRmLTgnKSkKCiAgICAgICAgIyBHZW5lcmF0ZSB0aWxlbWFwcmVzb3VyY2UueG1sLgogICAgICAgIGlmIG5vdCBzZWxmLm9wdGlvbnMucmVzdW1lIG9yIG5vdCBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4oc2VsZi5vdXRwdXRfZm9sZGVyLCAndGlsZW1hcHJlc291cmNlLnhtbCcpKToKICAgICAgICAgICAgd2l0aCBvcGVuKG9zLnBhdGguam9pbihzZWxmLm91dHB1dF9mb2xkZXIsICd0aWxlbWFwcmVzb3VyY2UueG1sJyksICd3YicpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlKHNlbGYuZ2VuZXJhdGVfdGlsZW1hcHJlc291cmNlKCkuZW5jb2RlKCd1dGYtOCcpKQoKICAgICAgICBpZiBzZWxmLmttbDoKICAgICAgICAgICAgIyBUT0RPOiBNYXliZSBwcm9ibGVtIGZvciBub3QgYXV0b21hdGljYWxseSBnZW5lcmF0ZWQgdG1pbnoKICAgICAgICAgICAgIyBUaGUgcm9vdCBLTUwgc2hvdWxkIGNvbnRhaW4gbGlua3MgdG8gYWxsIHRpbGVzIGluIHRoZSB0bWlueiBsZXZlbAogICAgICAgICAgICBjaGlsZHJlbiA9IFtdCiAgICAgICAgICAgIHhtaW4sIHltaW4sIHhtYXgsIHltYXggPSBzZWxmLnRtaW5tYXhbc2VsZi50bWluel0KICAgICAgICAgICAgZm9yIHggaW4gcmFuZ2UoeG1pbiwgeG1heCsxKToKICAgICAgICAgICAgICAgIGZvciB5IGluIHJhbmdlKHltaW4sIHltYXgrMSk6CiAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW4uYXBwZW5kKFt4LCB5LCBzZWxmLnRtaW56XSkKICAgICAgICAgICAgIyBHZW5lcmF0ZSBSb290IEtNTAogICAgICAgICAgICBpZiBzZWxmLmttbDoKICAgICAgICAgICAgICAgIGlmIChub3Qgc2VsZi5vcHRpb25zLnJlc3VtZSBvciBub3QKICAgICAgICAgICAgICAgICAgICAgICAgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKHNlbGYub3V0cHV0X2ZvbGRlciwgJ2RvYy5rbWwnKSkpOgogICAgICAgICAgICAgICAgICAgIHdpdGggb3Blbihvcy5wYXRoLmpvaW4oc2VsZi5vdXRwdXRfZm9sZGVyLCAnZG9jLmttbCcpLCAnd2InKSBhcyBmOgogICAgICAgICAgICAgICAgICAgICAgICBmLndyaXRlKGdlbmVyYXRlX2ttbCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIE5vbmUsIE5vbmUsIE5vbmUsIHNlbGYudGlsZWV4dCwgc2VsZi50aWxlc2l6ZSwgc2VsZi50aWxlc3duZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYub3B0aW9ucywgY2hpbGRyZW4KICAgICAgICAgICAgICAgICAgICAgICAgKS5lbmNvZGUoJ3V0Zi04JykpCgogICAgZGVmIGdlbmVyYXRlX2Jhc2VfdGlsZXMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgR2VuZXJhdGlvbiBvZiB0aGUgYmFzZSB0aWxlcyAodGhlIGxvd2VzdCBpbiB0aGUgcHlyYW1pZCkgZGlyZWN0bHkgZnJvbSB0aGUgaW5wdXQgcmFzdGVyCiAgICAgICAgIiIiCgogICAgICAgIGlmIG5vdCBzZWxmLm9wdGlvbnMucXVpZXQ6CiAgICAgICAgICAgIHByaW50KCJHZW5lcmF0aW5nIEJhc2UgVGlsZXM6IikKCiAgICAgICAgaWYgc2VsZi5vcHRpb25zLnZlcmJvc2U6CiAgICAgICAgICAgIHByaW50KCcnKQogICAgICAgICAgICBwcmludCgiVGlsZXMgZ2VuZXJhdGVkIGZyb20gdGhlIG1heCB6b29tIGxldmVsOiIpCiAgICAgICAgICAgIHByaW50KCItLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIikKICAgICAgICAgICAgcHJpbnQoJycpCgogICAgICAgICMgU2V0IHRoZSBib3VuZHMKICAgICAgICB0bWlueCwgdG1pbnksIHRtYXh4LCB0bWF4eSA9IHNlbGYudG1pbm1heFtzZWxmLnRtYXh6XQoKICAgICAgICBkcyA9IHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQKICAgICAgICB0aWxlYmFuZHMgPSBzZWxmLmRhdGFCYW5kc0NvdW50ICsgMQogICAgICAgIHF1ZXJ5c2l6ZSA9IHNlbGYucXVlcnlzaXplCgogICAgICAgIGlmIHNlbGYub3B0aW9ucy52ZXJib3NlOgogICAgICAgICAgICBwcmludCgiZGF0YUJhbmRzQ291bnQ6ICIsIHNlbGYuZGF0YUJhbmRzQ291bnQpCiAgICAgICAgICAgIHByaW50KCJ0aWxlYmFuZHM6ICIsIHRpbGViYW5kcykKCiAgICAgICAgdGNvdW50ID0gKDErYWJzKHRtYXh4LXRtaW54KSkgKiAoMSthYnModG1heHktdG1pbnkpKQogICAgICAgIHRpID0gMAoKICAgICAgICB0aWxlX2RldGFpbHMgPSBbXQoKICAgICAgICB0eiA9IHNlbGYudG1heHoKICAgICAgICBmb3IgdHkgaW4gcmFuZ2UodG1heHksIHRtaW55LTEsIC0xKToKICAgICAgICAgICAgZm9yIHR4IGluIHJhbmdlKHRtaW54LCB0bWF4eCsxKToKCiAgICAgICAgICAgICAgICB0aSArPSAxCiAgICAgICAgICAgICAgICB5dGlsZSA9IEdEQUwyVGlsZXMuZ2V0WXRpbGUodHksIHR6LCBzZWxmLm9wdGlvbnMpCiAgICAgICAgICAgICAgICB0aWxlZmlsZW5hbWUgPSBvcy5wYXRoLmpvaW4oCiAgICAgICAgICAgICAgICAgICAgc2VsZi5vdXRwdXRfZm9sZGVyLCBzdHIodHopLCAnezA6MDRkfScuZm9ybWF0KHR4KSArICJfIiArICd7MDowNGR9Jy5mb3JtYXQoeXRpbGUpICsgIi4iICsgc2VsZi50aWxlZXh0KQogICAgICAgICAgICAgICAgaWYgc2VsZi5vcHRpb25zLnZlcmJvc2U6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQodGksICcvJywgdGNvdW50LCB0aWxlZmlsZW5hbWUpCgogICAgICAgICAgICAgICAgaWYgc2VsZi5vcHRpb25zLnJlc3VtZSBhbmQgb3MucGF0aC5leGlzdHModGlsZWZpbGVuYW1lKToKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLm9wdGlvbnMudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQoIlRpbGUgZ2VuZXJhdGlvbiBza2lwcGVkIGJlY2F1c2Ugb2YgLS1yZXN1bWUiKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgIyBDcmVhdGUgZGlyZWN0b3JpZXMgZm9yIHRoZSB0aWxlCiAgICAgICAgICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMob3MucGF0aC5kaXJuYW1lKHRpbGVmaWxlbmFtZSkpOgogICAgICAgICAgICAgICAgICAgIG9zLm1ha2VkaXJzKG9zLnBhdGguZGlybmFtZSh0aWxlZmlsZW5hbWUpKQoKICAgICAgICAgICAgICAgIGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdtZXJjYXRvcic6CiAgICAgICAgICAgICAgICAgICAgIyBUaWxlIGJvdW5kcyBpbiBFUFNHOjM4NTcKICAgICAgICAgICAgICAgICAgICBiID0gc2VsZi5tZXJjYXRvci5UaWxlQm91bmRzKHR4LCB0eSwgdHopCiAgICAgICAgICAgICAgICBlbGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdnZW9kZXRpYyc6CiAgICAgICAgICAgICAgICAgICAgYiA9IHNlbGYuZ2VvZGV0aWMuVGlsZUJvdW5kcyh0eCwgdHksIHR6KQoKICAgICAgICAgICAgICAgICMgRG9uJ3Qgc2NhbGUgdXAgYnkgbmVhcmVzdCBuZWlnaGJvdXIsIGJldHRlciBjaGFuZ2UgdGhlIHF1ZXJ5c2l6ZQogICAgICAgICAgICAgICAgIyB0byB0aGUgbmF0aXZlIHJlc29sdXRpb24gKGFuZCByZXR1cm4gc21hbGxlciBxdWVyeSB0aWxlKSBmb3Igc2NhbGluZwoKICAgICAgICAgICAgICAgIGlmIHNlbGYub3B0aW9ucy5wcm9maWxlIGluICgnbWVyY2F0b3InLCAnZ2VvZGV0aWMnKToKICAgICAgICAgICAgICAgICAgICByYiwgd2IgPSBzZWxmLmdlb19xdWVyeShkcywgYlswXSwgYlszXSwgYlsyXSwgYlsxXSkKCiAgICAgICAgICAgICAgICAgICAgIyBQaXhlbCBzaXplIGluIHRoZSByYXN0ZXIgY292ZXJpbmcgcXVlcnkgZ2VvIGV4dGVudAogICAgICAgICAgICAgICAgICAgIG5hdGl2ZXNpemUgPSB3YlswXSArIHdiWzJdCiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5vcHRpb25zLnZlcmJvc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KCJcdE5hdGl2ZSBFeHRlbnQgKHF1ZXJ5c2l6ZSIsIG5hdGl2ZXNpemUsICIpOiAiLCByYiwgd2IpCgogICAgICAgICAgICAgICAgICAgICMgVGlsZSBib3VuZHMgaW4gcmFzdGVyIGNvb3JkaW5hdGVzIGZvciBSZWFkUmFzdGVyIHF1ZXJ5CiAgICAgICAgICAgICAgICAgICAgcmIsIHdiID0gc2VsZi5nZW9fcXVlcnkoZHMsIGJbMF0sIGJbM10sIGJbMl0sIGJbMV0sIHF1ZXJ5c2l6ZT1xdWVyeXNpemUpCgogICAgICAgICAgICAgICAgICAgIHJ4LCByeSwgcnhzaXplLCByeXNpemUgPSByYgogICAgICAgICAgICAgICAgICAgIHd4LCB3eSwgd3hzaXplLCB3eXNpemUgPSB3YgoKICAgICAgICAgICAgICAgIGVsc2U6ICAgICAjICdyYXN0ZXInIHByb2ZpbGU6CgogICAgICAgICAgICAgICAgICAgIHRzaXplID0gaW50KHNlbGYudHNpemVbdHpdKSAgICMgdGlsZXNpemUgaW4gcmFzdGVyIGNvb3JkaW5hdGVzIGZvciBhY3R1YWwgem9vbQogICAgICAgICAgICAgICAgICAgIHhzaXplID0gc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldC5SYXN0ZXJYU2l6ZSAgICAgIyBzaXplIG9mIHRoZSByYXN0ZXIgaW4gcGl4ZWxzCiAgICAgICAgICAgICAgICAgICAgeXNpemUgPSBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0LlJhc3RlcllTaXplCiAgICAgICAgICAgICAgICAgICAgaWYgdHogPj0gc2VsZi5uYXRpdmV6b29tOgogICAgICAgICAgICAgICAgICAgICAgICBxdWVyeXNpemUgPSBzZWxmLnRpbGVzaXplCgogICAgICAgICAgICAgICAgICAgIHJ4ID0gKHR4KSAqIHRzaXplCiAgICAgICAgICAgICAgICAgICAgcnhzaXplID0gMAogICAgICAgICAgICAgICAgICAgIGlmIHR4ID09IHRtYXh4OgogICAgICAgICAgICAgICAgICAgICAgICByeHNpemUgPSB4c2l6ZSAlIHRzaXplCiAgICAgICAgICAgICAgICAgICAgaWYgcnhzaXplID09IDA6CiAgICAgICAgICAgICAgICAgICAgICAgIHJ4c2l6ZSA9IHRzaXplCgogICAgICAgICAgICAgICAgICAgIHJ5c2l6ZSA9IDAKICAgICAgICAgICAgICAgICAgICBpZiB0eSA9PSB0bWF4eToKICAgICAgICAgICAgICAgICAgICAgICAgcnlzaXplID0geXNpemUgJSB0c2l6ZQogICAgICAgICAgICAgICAgICAgIGlmIHJ5c2l6ZSA9PSAwOgogICAgICAgICAgICAgICAgICAgICAgICByeXNpemUgPSB0c2l6ZQogICAgICAgICAgICAgICAgICAgIHJ5ID0geXNpemUgLSAodHkgKiB0c2l6ZSkgLSByeXNpemUKCiAgICAgICAgICAgICAgICAgICAgd3gsIHd5ID0gMCwgMAogICAgICAgICAgICAgICAgICAgIHd4c2l6ZSA9IGludChyeHNpemUvZmxvYXQodHNpemUpICogc2VsZi50aWxlc2l6ZSkKICAgICAgICAgICAgICAgICAgICB3eXNpemUgPSBpbnQocnlzaXplL2Zsb2F0KHRzaXplKSAqIHNlbGYudGlsZXNpemUpCiAgICAgICAgICAgICAgICAgICAgaWYgd3lzaXplICE9IHNlbGYudGlsZXNpemU6CiAgICAgICAgICAgICAgICAgICAgICAgIHd5ID0gc2VsZi50aWxlc2l6ZSAtIHd5c2l6ZQoKICAgICAgICAgICAgICAgICMgUmVhZCB0aGUgc291cmNlIHJhc3RlciBpZiBhbnl0aGluZyBpcyBnb2luZyBpbnNpZGUgdGhlIHRpbGUgYXMgcGVyIHRoZSBjb21wdXRlZAogICAgICAgICAgICAgICAgIyBnZW9fcXVlcnkKICAgICAgICAgICAgICAgIHRpbGVfZGV0YWlscy5hcHBlbmQoCiAgICAgICAgICAgICAgICAgICAgVGlsZURldGFpbCgKICAgICAgICAgICAgICAgICAgICAgICAgdHg9dHgsIHR5PXl0aWxlLCB0ej10eiwgcng9cngsIHJ5PXJ5LCByeHNpemU9cnhzaXplLCByeXNpemU9cnlzaXplLCB3eD13eCwKICAgICAgICAgICAgICAgICAgICAgICAgd3k9d3ksIHd4c2l6ZT13eHNpemUsIHd5c2l6ZT13eXNpemUsIHF1ZXJ5c2l6ZT1xdWVyeXNpemUsCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgKQoKICAgICAgICBjb25mID0gVGlsZUpvYkluZm8oCiAgICAgICAgICAgIHNyY19maWxlPXNlbGYudG1wX3ZydF9maWxlbmFtZSwKICAgICAgICAgICAgbmJfZGF0YV9iYW5kcz1zZWxmLmRhdGFCYW5kc0NvdW50LAogICAgICAgICAgICBvdXRwdXRfZmlsZV9wYXRoPXNlbGYub3V0cHV0X2ZvbGRlciwKICAgICAgICAgICAgdGlsZV9leHRlbnNpb249c2VsZi50aWxlZXh0LAogICAgICAgICAgICB0aWxlX2RyaXZlcj1zZWxmLnRpbGVkcml2ZXIsCiAgICAgICAgICAgIHRpbGVfc2l6ZT1zZWxmLnRpbGVzaXplLAogICAgICAgICAgICBrbWw9c2VsZi5rbWwsCiAgICAgICAgICAgIHRtaW5tYXg9c2VsZi50bWlubWF4LAogICAgICAgICAgICB0bWluej1zZWxmLnRtaW56LAogICAgICAgICAgICB0bWF4ej1zZWxmLnRtYXh6LAogICAgICAgICAgICBpbl9zcnNfd2t0PXNlbGYuaW5fc3JzX3drdCwKICAgICAgICAgICAgb3V0X2dlb190cmFucz1zZWxmLm91dF9ndCwKICAgICAgICAgICAgb21pbnk9c2VsZi5vbWlueSwKICAgICAgICAgICAgaXNfZXBzZ180MzI2PXNlbGYuaXNlcHNnNDMyNiwKICAgICAgICAgICAgb3B0aW9ucz1zZWxmLm9wdGlvbnMsCiAgICAgICAgKQoKICAgICAgICByZXR1cm4gY29uZiwgdGlsZV9kZXRhaWxzCgogICAgZGVmIGdlb19xdWVyeShzZWxmLCBkcywgdWx4LCB1bHksIGxyeCwgbHJ5LCBxdWVyeXNpemU9MCk6CiAgICAgICAgIiIiCiAgICAgICAgRm9yIGdpdmVuIGRhdGFzZXQgYW5kIHF1ZXJ5IGluIGNhcnRvZ3JhcGhpYyBjb29yZGluYXRlcyByZXR1cm5zIHBhcmFtZXRlcnMgZm9yIFJlYWRSYXN0ZXIoKQogICAgICAgIGluIHJhc3RlciBjb29yZGluYXRlcyBhbmQgeC95IHNoaWZ0cyAoZm9yIGJvcmRlciB0aWxlcykuIElmIHRoZSBxdWVyeXNpemUgaXMgbm90IGdpdmVuLCB0aGUKICAgICAgICBleHRlbnQgaXMgcmV0dXJuZWQgaW4gdGhlIG5hdGl2ZSByZXNvbHV0aW9uIG9mIGRhdGFzZXQgZHMuCgogICAgICAgIHJhaXNlcyBHZGFsMlRpbGVzRXJyb3IgaWYgdGhlIGRhdGFzZXQgZG9lcyBub3QgY29udGFpbiBhbnl0aGluZyBpbnNpZGUgdGhpcyBnZW9fcXVlcnkKICAgICAgICAiIiIKICAgICAgICBnZW90cmFuID0gZHMuR2V0R2VvVHJhbnNmb3JtKCkKICAgICAgICByeCA9IGludCgodWx4IC0gZ2VvdHJhblswXSkgLyBnZW90cmFuWzFdICsgMC4wMDEpCiAgICAgICAgcnkgPSBpbnQoKHVseSAtIGdlb3RyYW5bM10pIC8gZ2VvdHJhbls1XSArIDAuMDAxKQogICAgICAgIHJ4c2l6ZSA9IGludCgobHJ4IC0gdWx4KSAvIGdlb3RyYW5bMV0gKyAwLjUpCiAgICAgICAgcnlzaXplID0gaW50KChscnkgLSB1bHkpIC8gZ2VvdHJhbls1XSArIDAuNSkKCiAgICAgICAgaWYgbm90IHF1ZXJ5c2l6ZToKICAgICAgICAgICAgd3hzaXplLCB3eXNpemUgPSByeHNpemUsIHJ5c2l6ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHd4c2l6ZSwgd3lzaXplID0gcXVlcnlzaXplLCBxdWVyeXNpemUKCiAgICAgICAgIyBDb29yZGluYXRlcyBzaG91bGQgbm90IGdvIG91dCBvZiB0aGUgYm91bmRzIG9mIHRoZSByYXN0ZXIKICAgICAgICB3eCA9IDAKICAgICAgICBpZiByeCA8IDA6CiAgICAgICAgICAgIHJ4c2hpZnQgPSBhYnMocngpCiAgICAgICAgICAgIHd4ID0gaW50KHd4c2l6ZSAqIChmbG9hdChyeHNoaWZ0KSAvIHJ4c2l6ZSkpCiAgICAgICAgICAgIHd4c2l6ZSA9IHd4c2l6ZSAtIHd4CiAgICAgICAgICAgIHJ4c2l6ZSA9IHJ4c2l6ZSAtIGludChyeHNpemUgKiAoZmxvYXQocnhzaGlmdCkgLyByeHNpemUpKQogICAgICAgICAgICByeCA9IDAKICAgICAgICBpZiByeCtyeHNpemUgPiBkcy5SYXN0ZXJYU2l6ZToKICAgICAgICAgICAgd3hzaXplID0gaW50KHd4c2l6ZSAqIChmbG9hdChkcy5SYXN0ZXJYU2l6ZSAtIHJ4KSAvIHJ4c2l6ZSkpCiAgICAgICAgICAgIHJ4c2l6ZSA9IGRzLlJhc3RlclhTaXplIC0gcngKCiAgICAgICAgd3kgPSAwCiAgICAgICAgaWYgcnkgPCAwOgogICAgICAgICAgICByeXNoaWZ0ID0gYWJzKHJ5KQogICAgICAgICAgICB3eSA9IGludCh3eXNpemUgKiAoZmxvYXQocnlzaGlmdCkgLyByeXNpemUpKQogICAgICAgICAgICB3eXNpemUgPSB3eXNpemUgLSB3eQogICAgICAgICAgICByeXNpemUgPSByeXNpemUgLSBpbnQocnlzaXplICogKGZsb2F0KHJ5c2hpZnQpIC8gcnlzaXplKSkKICAgICAgICAgICAgcnkgPSAwCiAgICAgICAgaWYgcnkrcnlzaXplID4gZHMuUmFzdGVyWVNpemU6CiAgICAgICAgICAgIHd5c2l6ZSA9IGludCh3eXNpemUgKiAoZmxvYXQoZHMuUmFzdGVyWVNpemUgLSByeSkgLyByeXNpemUpKQogICAgICAgICAgICByeXNpemUgPSBkcy5SYXN0ZXJZU2l6ZSAtIHJ5CgogICAgICAgIHJldHVybiAocngsIHJ5LCByeHNpemUsIHJ5c2l6ZSksICh3eCwgd3ksIHd4c2l6ZSwgd3lzaXplKQoKICAgIGRlZiBnZW5lcmF0ZV90aWxlbWFwcmVzb3VyY2Uoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgVGVtcGxhdGUgZm9yIHRpbGVtYXByZXNvdXJjZS54bWwuIFJldHVybnMgZmlsbGVkIHN0cmluZy4gRXhwZWN0ZWQgdmFyaWFibGVzOgogICAgICAgICAgdGl0bGUsIG5vcnRoLCBzb3V0aCwgZWFzdCwgd2VzdCwgaXNlcHNnNDMyNiwgcHJvamVjdGlvbiwgcHVibGlzaHVybCwKICAgICAgICAgIHpvb21waXhlbHMsIHRpbGVzaXplLCB0aWxlZm9ybWF0LCBwcm9maWxlCiAgICAgICAgIiIiCgogICAgICAgIGFyZ3MgPSB7fQogICAgICAgIGFyZ3NbJ3RpdGxlJ10gPSBzZWxmLm9wdGlvbnMudGl0bGUKICAgICAgICBhcmdzWydzb3V0aCddLCBhcmdzWyd3ZXN0J10sIGFyZ3NbJ25vcnRoJ10sIGFyZ3NbJ2Vhc3QnXSA9IHNlbGYuc3duZQogICAgICAgIGFyZ3NbJ3RpbGVzaXplJ10gPSBzZWxmLnRpbGVzaXplCiAgICAgICAgYXJnc1sndGlsZWZvcm1hdCddID0gc2VsZi50aWxlZXh0CiAgICAgICAgYXJnc1sncHVibGlzaHVybCddID0gc2VsZi5vcHRpb25zLnVybAogICAgICAgIGFyZ3NbJ3Byb2ZpbGUnXSA9IHNlbGYub3B0aW9ucy5wcm9maWxlCgogICAgICAgIGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdtZXJjYXRvcic6CiAgICAgICAgICAgIGFyZ3NbJ3NycyddID0gIkVQU0c6Mzg1NyIKICAgICAgICBlbGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdnZW9kZXRpYyc6CiAgICAgICAgICAgIGFyZ3NbJ3NycyddID0gIkVQU0c6NDMyNiIKICAgICAgICBlbGlmIHNlbGYub3B0aW9ucy5zX3NyczoKICAgICAgICAgICAgYXJnc1snc3JzJ10gPSBzZWxmLm9wdGlvbnMuc19zcnMKICAgICAgICBlbGlmIHNlbGYub3V0X3NyczoKICAgICAgICAgICAgYXJnc1snc3JzJ10gPSBzZWxmLm91dF9zcnMuRXhwb3J0VG9Xa3QoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGFyZ3NbJ3NycyddID0gIiIKCiAgICAgICAgcyA9ICIiIjw/eG1sIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9InV0Zi04Ij8+CiAgICA8VGlsZU1hcCB2ZXJzaW9uPSIxLjAuMCIgdGlsZW1hcHNlcnZpY2U9Imh0dHA6Ly90bXMub3NnZW8ub3JnLzEuMC4wIj4KICAgICAgPFRpdGxlPiUodGl0bGUpczwvVGl0bGU+CiAgICAgIDxBYnN0cmFjdD48L0Fic3RyYWN0PgogICAgICA8U1JTPiUoc3JzKXM8L1NSUz4KICAgICAgPEJvdW5kaW5nQm94IG1pbng9IiUod2VzdCkuMTRmIiBtaW55PSIlKHNvdXRoKS4xNGYiIG1heHg9IiUoZWFzdCkuMTRmIiBtYXh5PSIlKG5vcnRoKS4xNGYiLz4KICAgICAgPE9yaWdpbiB4PSIlKHdlc3QpLjE0ZiIgeT0iJShzb3V0aCkuMTRmIi8+CiAgICAgIDxUaWxlRm9ybWF0IHdpZHRoPSIlKHRpbGVzaXplKWQiIGhlaWdodD0iJSh0aWxlc2l6ZSlkIiBtaW1lLXR5cGU9ImltYWdlLyUodGlsZWZvcm1hdClzIiBleHRlbnNpb249IiUodGlsZWZvcm1hdClzIi8+CiAgICAgIDxUaWxlU2V0cyBwcm9maWxlPSIlKHByb2ZpbGUpcyI+CiIiIiAlIGFyZ3MgICAgIyBub3FhCiAgICAgICAgZm9yIHogaW4gcmFuZ2Uoc2VsZi50bWlueiwgc2VsZi50bWF4eisxKToKICAgICAgICAgICAgaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ3Jhc3Rlcic6CiAgICAgICAgICAgICAgICBzICs9ICIiIiAgICAgICAgPFRpbGVTZXQgaHJlZj0iJXMlZCIgdW5pdHMtcGVyLXBpeGVsPSIlLjE0ZiIgb3JkZXI9IiVkIi8+XG4iIiIgJSAoCiAgICAgICAgICAgICAgICAgICAgYXJnc1sncHVibGlzaHVybCddLCB6LCAoMioqKHNlbGYubmF0aXZlem9vbS16KSAqIHNlbGYub3V0X2d0WzFdKSwgeikKICAgICAgICAgICAgZWxpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAnbWVyY2F0b3InOgogICAgICAgICAgICAgICAgcyArPSAiIiIgICAgICAgIDxUaWxlU2V0IGhyZWY9IiVzJWQiIHVuaXRzLXBlci1waXhlbD0iJS4xNGYiIG9yZGVyPSIlZCIvPlxuIiIiICUgKAogICAgICAgICAgICAgICAgICAgIGFyZ3NbJ3B1Ymxpc2h1cmwnXSwgeiwgMTU2NTQzLjAzMzkvMioqeiwgeikKICAgICAgICAgICAgZWxpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAnZ2VvZGV0aWMnOgogICAgICAgICAgICAgICAgcyArPSAiIiIgICAgICAgIDxUaWxlU2V0IGhyZWY9IiVzJWQiIHVuaXRzLXBlci1waXhlbD0iJS4xNGYiIG9yZGVyPSIlZCIvPlxuIiIiICUgKAogICAgICAgICAgICAgICAgICAgIGFyZ3NbJ3B1Ymxpc2h1cmwnXSwgeiwgMC43MDMxMjUvMioqeiwgeikKICAgICAgICBzICs9ICIiIiAgICAgIDwvVGlsZVNldHM+CiAgICA8L1RpbGVNYXA+CiAgICAiIiIKICAgICAgICByZXR1cm4gcwoKICAgIGRlZiBnZW5lcmF0ZV9nb29nbGVtYXBzKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFRlbXBsYXRlIGZvciBnb29nbGVtYXBzLmh0bWwgaW1wbGVtZW50aW5nIE92ZXJsYXkgb2YgdGlsZXMgZm9yICdtZXJjYXRvcicgcHJvZmlsZS4KICAgICAgICBJdCByZXR1cm5zIGZpbGxlZCBzdHJpbmcuIEV4cGVjdGVkIHZhcmlhYmxlczoKICAgICAgICB0aXRsZSwgZ29vZ2xlbWFwc2tleSwgbm9ydGgsIHNvdXRoLCBlYXN0LCB3ZXN0LCBtaW56b29tLCBtYXh6b29tLCB0aWxlc2l6ZSwgdGlsZWZvcm1hdCwKICAgICAgICBwdWJsaXNodXJsCiAgICAgICAgIiIiCiAgICAgICAgYXJncyA9IHt9CiAgICAgICAgYXJnc1sndGl0bGUnXSA9IHNlbGYub3B0aW9ucy50aXRsZQogICAgICAgIGFyZ3NbJ2dvb2dsZW1hcHNrZXknXSA9IHNlbGYub3B0aW9ucy5nb29nbGVrZXkKICAgICAgICBhcmdzWydzb3V0aCddLCBhcmdzWyd3ZXN0J10sIGFyZ3NbJ25vcnRoJ10sIGFyZ3NbJ2Vhc3QnXSA9IHNlbGYuc3duZQogICAgICAgIGFyZ3NbJ21pbnpvb20nXSA9IHNlbGYudG1pbnoKICAgICAgICBhcmdzWydtYXh6b29tJ10gPSBzZWxmLnRtYXh6CiAgICAgICAgYXJnc1sndGlsZXNpemUnXSA9IHNlbGYudGlsZXNpemUKICAgICAgICBhcmdzWyd0aWxlZm9ybWF0J10gPSBzZWxmLnRpbGVleHQKICAgICAgICBhcmdzWydwdWJsaXNodXJsJ10gPSBzZWxmLm9wdGlvbnMudXJsCiAgICAgICAgYXJnc1snY29weXJpZ2h0J10gPSBzZWxmLm9wdGlvbnMuY29weXJpZ2h0CgogICAgICAgIHMgPSByIiIiPCFET0NUWVBFIGh0bWwgUFVCTElDICItLy9XM0MvL0RURCBYSFRNTCAxLjAgU3RyaWN0Ly9FTiIgImh0dHA6Ly93d3cudzMub3JnL1RSL3hodG1sMS9EVEQveGh0bWwxLXN0cmljdC5kdGQiPgogICAgICAgICAgICA8aHRtbCB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgeG1sbnM6dj0idXJuOnNjaGVtYXMtbWljcm9zb2Z0LWNvbTp2bWwiPgogICAgICAgICAgICAgIDxoZWFkPgogICAgICAgICAgICAgICAgPHRpdGxlPiUodGl0bGUpczwvdGl0bGU+CiAgICAgICAgICAgICAgICA8bWV0YSBodHRwLWVxdWl2PSJjb250ZW50LXR5cGUiIGNvbnRlbnQ9InRleHQvaHRtbDsgY2hhcnNldD11dGYtOCIvPgogICAgICAgICAgICAgICAgPG1ldGEgaHR0cC1lcXVpdj0naW1hZ2V0b29sYmFyJyBjb250ZW50PSdubycvPgogICAgICAgICAgICAgICAgPHN0eWxlIHR5cGU9InRleHQvY3NzIj4gdlw6KiB7YmVoYXZpb3I6dXJsKCNkZWZhdWx0I1ZNTCk7fQogICAgICAgICAgICAgICAgICAgIGh0bWwsIGJvZHkgeyBvdmVyZmxvdzogaGlkZGVuOyBwYWRkaW5nOiAwOyBoZWlnaHQ6IDEwMCUlOyB3aWR0aDogMTAwJSU7IGZvbnQtZmFtaWx5OiAnTHVjaWRhIEdyYW5kZScsR2VuZXZhLEFyaWFsLFZlcmRhbmEsc2Fucy1zZXJpZjsgfQogICAgICAgICAgICAgICAgICAgIGJvZHkgeyBtYXJnaW46IDEwcHg7IGJhY2tncm91bmQ6ICNmZmY7IH0KICAgICAgICAgICAgICAgICAgICBoMSB7IG1hcmdpbjogMDsgcGFkZGluZzogNnB4OyBib3JkZXI6MDsgZm9udC1zaXplOiAyMHB0OyB9CiAgICAgICAgICAgICAgICAgICAgI2hlYWRlciB7IGhlaWdodDogNDNweDsgcGFkZGluZzogMDsgYmFja2dyb3VuZC1jb2xvcjogI2VlZTsgYm9yZGVyOiAxcHggc29saWQgIzg4ODsgfQogICAgICAgICAgICAgICNzdWJoZWFkZXIgeyBoZWlnaHQ6IDEycHg7IHRleHQtYWxpZ246IHJpZ2h0OyBmb250LXNpemU6IDEwcHg7IGNvbG9yOiAjNTU1O30KICAgICAgICAgICAgICAjbWFwIHsgaGVpZ2h0OiA5NSUlOyBib3JkZXI6IDFweCBzb2xpZCAjODg4OyB9CiAgICAgICAgICA8L3N0eWxlPgogICAgICAgICAgPHNjcmlwdCBzcmM9J2h0dHA6Ly9tYXBzLmdvb2dsZS5jb20vbWFwcz9maWxlPWFwaSZhbXA7dj0yJmFtcDtrZXk9JShnb29nbGVtYXBza2V5KXMnPjwvc2NyaXB0PgogICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgIC8vPCFbQ0RBVEFbCgogICAgICAgICAgLyoKICAgICAgICAgICAgICAgICAqIENvbnN0YW50cyBmb3IgZ2l2ZW4gbWFwCiAgICAgICAgICAgICAgICAgKiBUT0RPOiByZWFkIGl0IGZyb20gdGlsZW1hcHJlc291cmNlLnhtbAogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgdmFyIG1hcEJvdW5kcyA9IG5ldyBHTGF0TG5nQm91bmRzKG5ldyBHTGF0TG5nKCUoc291dGgpcywgJSh3ZXN0KXMpLCBuZXcgR0xhdExuZyglKG5vcnRoKXMsICUoZWFzdClzKSk7CiAgICAgICAgICAgICAgICB2YXIgbWFwTWluWm9vbSA9ICUobWluem9vbSlzOwogICAgICAgICAgICAgICAgdmFyIG1hcE1heFpvb20gPSAlKG1heHpvb20pczsKCiAgICAgICAgICAgICAgICB2YXIgb3BhY2l0eSA9IDAuNzU7CiAgICAgICAgICAgICAgICB2YXIgbWFwOwogICAgICAgICAgICAgICAgdmFyIGh5YnJpZE92ZXJsYXk7CgogICAgICAgICAgICAgICAgLyoKICAgICAgICAgICAgICAgICAqIENyZWF0ZSBhIEN1c3RvbSBPcGFjaXR5IEdDb250cm9sCiAgICAgICAgICAgICAgICAgKiBodHRwOi8vd3d3Lm1hcHRpbGVyLm9yZy9nb29nbGUtbWFwcy1vdmVybGF5LW9wYWNpdHktY29udHJvbC8KICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgIHZhciBDVHJhbnNwYXJlbmN5TEVOR1RIID0gNTg7CiAgICAgICAgICAgICAgICAvLyBtYXhpbXVtIHdpZHRoIHRoYXQgdGhlIGtub2IgY2FuIG1vdmUgKHNsaWRlIHdpZHRoIG1pbnVzIGtub2Igd2lkdGgpCgogICAgICAgICAgICAgICAgZnVuY3Rpb24gQ1RyYW5zcGFyZW5jeUNvbnRyb2woIG92ZXJsYXkgKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdmVybGF5ID0gb3ZlcmxheTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9wYWNpdHkgPSBvdmVybGF5LmdldFRpbGVMYXllcigpLmdldE9wYWNpdHkoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIENUcmFuc3BhcmVuY3lDb250cm9sLnByb3RvdHlwZSA9IG5ldyBHQ29udHJvbCgpOwoKICAgICAgICAgICAgICAgIC8vIFRoaXMgZnVuY3Rpb24gcG9zaXRpb25zIHRoZSBzbGlkZXIgdG8gbWF0Y2ggdGhlIHNwZWNpZmllZCBvcGFjaXR5CiAgICAgICAgICAgICAgICBDVHJhbnNwYXJlbmN5Q29udHJvbC5wcm90b3R5cGUuc2V0U2xpZGVyID0gZnVuY3Rpb24ocG9zKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxlZnQgPSBNYXRoLnJvdW5kKChDVHJhbnNwYXJlbmN5TEVOR1RIKnBvcykpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2xpZGUubGVmdCA9IGxlZnQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5rbm9iLnN0eWxlLmxlZnQgPSBsZWZ0KyJweCI7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5rbm9iLnN0eWxlLnRvcCA9ICIwcHgiOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFRoaXMgZnVuY3Rpb24gcmVhZHMgdGhlIHNsaWRlciBhbmQgc2V0cyB0aGUgb3ZlcmxheSBvcGFjaXR5IGxldmVsCiAgICAgICAgICAgICAgICBDVHJhbnNwYXJlbmN5Q29udHJvbC5wcm90b3R5cGUuc2V0T3BhY2l0eSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIC8vIHNldCB0aGUgZ2xvYmFsIHZhcmlhYmxlCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eSA9IHRoaXMuc2xpZGUubGVmdC9DVHJhbnNwYXJlbmN5TEVOR1RIOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWFwLmNsZWFyT3ZlcmxheXMoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1hcC5hZGRPdmVybGF5KHRoaXMub3ZlcmxheSwgeyB6UHJpb3JpdHk6IDAgfSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubWFwLmdldEN1cnJlbnRNYXBUeXBlKCkgPT0gR19IWUJSSURfTUFQKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWFwLmFkZE92ZXJsYXkoaHlicmlkT3ZlcmxheSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFRoaXMgZ2V0cyBjYWxsZWQgYnkgdGhlIEFQSSB3aGVuIGFkZENvbnRyb2wobmV3IENUcmFuc3BhcmVuY3lDb250cm9sKCkpCiAgICAgICAgICAgICAgICBDVHJhbnNwYXJlbmN5Q29udHJvbC5wcm90b3R5cGUuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKG1hcCkgewogICAgICAgICAgICAgICAgICAgIHZhciB0aGF0PXRoaXM7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYXAgPSBtYXA7CgogICAgICAgICAgICAgICAgICAgIC8vIElzIHRoaXMgTVNJRSwgaWYgc28gd2UgbmVlZCB0byB1c2UgQWxwaGFJbWFnZUxvYWRlcgogICAgICAgICAgICAgICAgICAgIHZhciBhZ2VudCA9IG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoKGFnZW50LmluZGV4T2YoIm1zaWUiKSA+IC0xKSAmJiAoYWdlbnQuaW5kZXhPZigib3BlcmEiKSA8IDEpKXt0aGlzLmllID0gdHJ1ZX0gZWxzZSB7dGhpcy5pZSA9IGZhbHNlfQoKICAgICAgICAgICAgICAgICAgICAvLyBjcmVhdGUgdGhlIGJhY2tncm91bmQgZ3JhcGhpYyBhcyBhIDxkaXY+IGNvbnRhaW5pbmcgYW4gaW1hZ2UKICAgICAgICAgICAgICAgICAgICB2YXIgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLnN0eWxlLndpZHRoPSI3MHB4IjsKICAgICAgICAgICAgICAgICAgICBjb250YWluZXIuc3R5bGUuaGVpZ2h0PSIyMXB4IjsKCiAgICAgICAgICAgICAgICAgICAgLy8gSGFuZGxlIHRyYW5zcGFyZW50IFBORyBmaWxlcyBpbiBNU0lFCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaWUpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2FkZXIgPSAiZmlsdGVyOnByb2dpZDpEWEltYWdlVHJhbnNmb3JtLk1pY3Jvc29mdC5BbHBoYUltYWdlTG9hZGVyKHNyYz0naHR0cDovL3d3dy5tYXB0aWxlci5vcmcvaW1nL29wYWNpdHktc2xpZGVyLnBuZycsIHNpemluZ01ldGhvZD0nY3JvcCcpOyI7CiAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXIuaW5uZXJIVE1MID0gJzxkaXYgc3R5bGU9ImhlaWdodDoyMXB4OyB3aWR0aDo3MHB4OyAnICtsb2FkZXIrICciID48L2Rpdj4nOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXIuaW5uZXJIVE1MID0gJzxkaXYgc3R5bGU9ImhlaWdodDoyMXB4OyB3aWR0aDo3MHB4OyBiYWNrZ3JvdW5kLWltYWdlOiB1cmwoaHR0cDovL3d3dy5tYXB0aWxlci5vcmcvaW1nL29wYWNpdHktc2xpZGVyLnBuZykiID48L2Rpdj4nOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gY3JlYXRlIHRoZSBrbm9iIGFzIGEgR0RyYWdnYWJsZU9iamVjdAogICAgICAgICAgICAgICAgICAgIC8vIEhhbmRsZSB0cmFuc3BhcmVudCBQTkcgZmlsZXMgaW4gTVNJRQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmllKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgbG9hZGVyID0gInByb2dpZDpEWEltYWdlVHJhbnNmb3JtLk1pY3Jvc29mdC5BbHBoYUltYWdlTG9hZGVyKHNyYz0naHR0cDovL3d3dy5tYXB0aWxlci5vcmcvaW1nL29wYWNpdHktc2xpZGVyLnBuZycsIHNpemluZ01ldGhvZD0nY3JvcCcpOyI7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmtub2IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMua25vYi5zdHlsZS5oZWlnaHQ9IjIxcHgiOwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5rbm9iLnN0eWxlLndpZHRoPSIxM3B4IjsKICAgICAgICAgICAgICAgICAgdGhpcy5rbm9iLnN0eWxlLm92ZXJmbG93PSJoaWRkZW4iOwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5rbm9iX2ltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5rbm9iX2ltZy5zdHlsZS5oZWlnaHQ9IjIxcHgiOwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5rbm9iX2ltZy5zdHlsZS53aWR0aD0iODNweCI7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmtub2JfaW1nLnN0eWxlLmZpbHRlcj1sb2FkZXI7CiAgICAgICAgICAgICAgICAgIHRoaXMua25vYl9pbWcuc3R5bGUucG9zaXRpb249InJlbGF0aXZlIjsKICAgICAgICAgICAgICAgICAgdGhpcy5rbm9iX2ltZy5zdHlsZS5sZWZ0PSItNzBweCI7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmtub2IuYXBwZW5kQ2hpbGQodGhpcy5rbm9iX2ltZyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMua25vYiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5rbm9iLnN0eWxlLmhlaWdodD0iMjFweCI7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmtub2Iuc3R5bGUud2lkdGg9IjEzcHgiOwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5rbm9iLnN0eWxlLmJhY2tncm91bmRJbWFnZT0idXJsKGh0dHA6Ly93d3cubWFwdGlsZXIub3JnL2ltZy9vcGFjaXR5LXNsaWRlci5wbmcpIjsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMua25vYi5zdHlsZS5iYWNrZ3JvdW5kUG9zaXRpb249Ii03MHB4IDBweCI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZCh0aGlzLmtub2IpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2xpZGU9bmV3IEdEcmFnZ2FibGVPYmplY3QodGhpcy5rbm9iLCB7Y29udGFpbmVyOmNvbnRhaW5lcn0pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2xpZGUuc2V0RHJhZ2dhYmxlQ3Vyc29yKCdwb2ludGVyJyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zbGlkZS5zZXREcmFnZ2luZ0N1cnNvcigncG9pbnRlcicpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gY29udGFpbmVyOwoKICAgICAgICAgICAgICAgICAgICAvLyBhdHRhY2ggdGhlIGNvbnRyb2wgdG8gdGhlIG1hcAogICAgICAgICAgICAgICAgICAgIG1hcC5nZXRDb250YWluZXIoKS5hcHBlbmRDaGlsZChjb250YWluZXIpOwoKICAgICAgICAgICAgICAgICAgICAvLyBpbml0IHNsaWRlcgogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U2xpZGVyKHRoaXMub3BhY2l0eSk7CgogICAgICAgICAgICAgICAgICAgIC8vIExpc3RlbiBmb3IgdGhlIHNsaWRlciBiZWluZyBtb3ZlZCBhbmQgc2V0IHRoZSBvcGFjaXR5CiAgICAgICAgICAgICAgICAgICAgR0V2ZW50LmFkZExpc3RlbmVyKHRoaXMuc2xpZGUsICJkcmFnZW5kIiwgZnVuY3Rpb24oKSB7dGhhdC5zZXRPcGFjaXR5KCl9KTsKICAgICAgICAgICAgICAgICAgICAvL0dFdmVudC5hZGRMaXN0ZW5lcih0aGlzLmNvbnRhaW5lciwgImNsaWNrIiwgZnVuY3Rpb24oIHgsIHkgKSB7IGFsZXJ0KHgsIHkpIH0pOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29udGFpbmVyOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAvLyBTZXQgdGhlIGRlZmF1bHQgcG9zaXRpb24gZm9yIHRoZSBjb250cm9sCiAgICAgICAgICAgICAgICAgIENUcmFuc3BhcmVuY3lDb250cm9sLnByb3RvdHlwZS5nZXREZWZhdWx0UG9zaXRpb24gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEdDb250cm9sUG9zaXRpb24oR19BTkNIT1JfVE9QX1JJR0hULCBuZXcgR1NpemUoNywgNDcpKTsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgICAgKiBGdWxsLXNjcmVlbiBXaW5kb3cgUmVzaXplCiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBnZXRXaW5kb3dIZWlnaHQoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYuaW5uZXJIZWlnaHQpIHJldHVybiBzZWxmLmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgICAgIGlmIChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LmJvZHkpIHJldHVybiBkb2N1bWVudC5ib2R5LmNsaWVudEhlaWdodDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBnZXRXaW5kb3dXaWR0aCgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5pbm5lcldpZHRoKSByZXR1cm4gc2VsZi5pbm5lcldpZHRoOwogICAgICAgICAgICAgICAgICAgIGlmIChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoOwogICAgICAgICAgICAgICAgICAgIGlmIChkb2N1bWVudC5ib2R5KSByZXR1cm4gZG9jdW1lbnQuYm9keS5jbGllbnRXaWR0aDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiByZXNpemUoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1hcCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJtYXAiKTsKICAgICAgICAgICAgICAgICAgICB2YXIgaGVhZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImhlYWRlciIpOwogICAgICAgICAgICAgICAgICAgIHZhciBzdWJoZWFkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic3ViaGVhZGVyIik7CiAgICAgICAgICAgICAgICAgICAgbWFwLnN0eWxlLmhlaWdodCA9IChnZXRXaW5kb3dIZWlnaHQoKS04MCkgKyAicHgiOwogICAgICAgICAgICAgICAgICAgIG1hcC5zdHlsZS53aWR0aCA9IChnZXRXaW5kb3dXaWR0aCgpLTIwKSArICJweCI7CiAgICAgICAgICAgICAgICAgICAgaGVhZGVyLnN0eWxlLndpZHRoID0gKGdldFdpbmRvd1dpZHRoKCktMjApICsgInB4IjsKICAgICAgICAgICAgICAgICAgICBzdWJoZWFkZXIuc3R5bGUud2lkdGggPSAoZ2V0V2luZG93V2lkdGgoKS0yMCkgKyAicHgiOwogICAgICAgICAgICAgICAgICAgIC8vIG1hcC5jaGVja1Jlc2l6ZSgpOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICogTWFpbiBsb2FkIGZ1bmN0aW9uOgogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgZnVuY3Rpb24gbG9hZCgpIHsKCiAgICAgICAgICAgICAgICAgICBpZiAoR0Jyb3dzZXJJc0NvbXBhdGlibGUoKSkgewoKICAgICAgICAgICAgICAgICAgICAgIC8vIEJ1ZyBpbiB0aGUgR29vZ2xlIE1hcHM6IENvcHlyaWdodCBmb3IgT3ZlcmxheSBpcyBub3QgY29ycmVjdGx5IGRpc3BsYXllZAogICAgICAgICAgICAgICAgICAgICAgdmFyIGdjciA9IEdNYXBUeXBlLnByb3RvdHlwZS5nZXRDb3B5cmlnaHRzOwogICAgICAgICAgICAgICAgICAgICAgR01hcFR5cGUucHJvdG90eXBlLmdldENvcHlyaWdodHMgPSBmdW5jdGlvbihib3VuZHMsem9vbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbIiUoY29weXJpZ2h0KXMiXS5jb25jYXQoZ2NyLmNhbGwodGhpcyxib3VuZHMsem9vbSkpOwogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgIG1hcCA9IG5ldyBHTWFwMiggZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm1hcCIpLCB7IGJhY2tncm91bmRDb2xvcjogJyNmZmYnIH0gKTsKCiAgICAgICAgICAgICAgICAgICAgICBtYXAuYWRkTWFwVHlwZShHX1BIWVNJQ0FMX01BUCk7CiAgICAgICAgICAgICAgICAgICAgICBtYXAuc2V0TWFwVHlwZShHX1BIWVNJQ0FMX01BUCk7CgogICAgICAgICAgICAgICAgICAgICAgbWFwLnNldENlbnRlciggbWFwQm91bmRzLmdldENlbnRlcigpLCBtYXAuZ2V0Qm91bmRzWm9vbUxldmVsKCBtYXBCb3VuZHMgKSk7CgogICAgICAgICAgICAgICAgICAgICAgaHlicmlkT3ZlcmxheSA9IG5ldyBHVGlsZUxheWVyT3ZlcmxheSggR19IWUJSSURfTUFQLmdldFRpbGVMYXllcnMoKVsxXSApOwogICAgICAgICAgICAgICAgICAgICAgR0V2ZW50LmFkZExpc3RlbmVyKG1hcCwgIm1hcHR5cGVjaGFuZ2VkIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXAuZ2V0Q3VycmVudE1hcFR5cGUoKSA9PSBHX0hZQlJJRF9NQVApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcC5hZGRPdmVybGF5KGh5YnJpZE92ZXJsYXkpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICBtYXAucmVtb3ZlT3ZlcmxheShoeWJyaWRPdmVybGF5KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSApOwoKICAgICAgICAgICAgICAgICAgICAgIHZhciB0aWxlbGF5ZXIgPSBuZXcgR1RpbGVMYXllcihHQ29weXJpZ2h0Q29sbGVjdGlvbignJyksIG1hcE1pblpvb20sIG1hcE1heFpvb20pOwogICAgICAgICAgICAgICAgICAgICAgdmFyIG1lcmNhdG9yID0gbmV3IEdNZXJjYXRvclByb2plY3Rpb24obWFwTWF4Wm9vbSsxKTsKICAgICAgICAgICAgICAgICAgICAgIHRpbGVsYXllci5nZXRUaWxlVXJsID0gZnVuY3Rpb24odGlsZSx6b29tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCh6b29tIDwgbWFwTWluWm9vbSkgfHwgKHpvb20gPiBtYXBNYXhab29tKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gImh0dHA6Ly93d3cubWFwdGlsZXIub3JnL2ltZy9ub25lLnBuZyI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB5bWF4ID0gMSA8PCB6b29tOwogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB5ID0geW1heCAtIHRpbGUueSAtMTsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGlsZUJvdW5kcyA9IG5ldyBHTGF0TG5nQm91bmRzKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXJjYXRvci5mcm9tUGl4ZWxUb0xhdExuZyggbmV3IEdQb2ludCggKHRpbGUueCkqMjU2LCAodGlsZS55KzEpKjI1NiApICwgem9vbSApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXJjYXRvci5mcm9tUGl4ZWxUb0xhdExuZyggbmV3IEdQb2ludCggKHRpbGUueCsxKSoyNTYsICh0aWxlLnkpKjI1NiApICwgem9vbSApCiAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWFwQm91bmRzLmludGVyc2VjdHModGlsZUJvdW5kcykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHpvb20rIi8iK3RpbGUueCsiLyIreSsiLnBuZyI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICJodHRwOi8vd3d3Lm1hcHRpbGVyLm9yZy9pbWcvbm9uZS5wbmciOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIC8vIElFIDctOiBzdXBwb3J0IGZvciBQTkcgYWxwaGEgY2hhbm5lbAogICAgICAgICAgICAgICAgICAgICAgLy8gVW5mb3J0dW5hdGVseSwgdGhlIG9wYWNpdHkgZm9yIHdob2xlIG92ZXJsYXkgaXMgdGhlbiBub3QgY2hhbmdlYWJsZSwgZWl0aGVyIG9yLi4uCiAgICAgICAgICAgICAgICAgICAgICB0aWxlbGF5ZXIuaXNQbmcgPSBmdW5jdGlvbigpIHsgcmV0dXJuIHRydWU7fTsKICAgICAgICAgICAgICAgICAgICAgIHRpbGVsYXllci5nZXRPcGFjaXR5ID0gZnVuY3Rpb24oKSB7IHJldHVybiBvcGFjaXR5OyB9CgogICAgICAgICAgICAgICAgICAgICAgb3ZlcmxheSA9IG5ldyBHVGlsZUxheWVyT3ZlcmxheSggdGlsZWxheWVyICk7CiAgICAgICAgICAgICAgICAgICAgICBtYXAuYWRkT3ZlcmxheShvdmVybGF5KTsKCiAgICAgICAgICAgICAgICAgICAgICBtYXAuYWRkQ29udHJvbChuZXcgR0xhcmdlTWFwQ29udHJvbCgpKTsKICAgICAgICAgICAgICAgICAgICAgIG1hcC5hZGRDb250cm9sKG5ldyBHSGllcmFyY2hpY2FsTWFwVHlwZUNvbnRyb2woKSk7CiAgICAgICAgICAgICAgICAgICAgICBtYXAuYWRkQ29udHJvbChuZXcgQ1RyYW5zcGFyZW5jeUNvbnRyb2woIG92ZXJsYXkgKSk7CiAgICAgICAgIiIiICUgYXJncyAgICAjIG5vcWEKICAgICAgICBpZiBzZWxmLmttbDoKICAgICAgICAgICAgcyArPSAiIiIKICAgICAgICAgICAgICAgICAgICAgIG1hcC5hZGRNYXBUeXBlKEdfU0FURUxMSVRFXzNEX01BUCk7CiAgICAgICAgICAgICAgICAgICAgICBtYXAuZ2V0RWFydGhJbnN0YW5jZShnZXRFYXJ0aEluc3RhbmNlQ0IpOwogICAgICAgICIiIgogICAgICAgIHMgKz0gIiIiCgogICAgICAgICAgICAgICAgICAgICAgbWFwLmVuYWJsZUNvbnRpbnVvdXNab29tKCk7CiAgICAgICAgICAgICAgICAgICAgICBtYXAuZW5hYmxlU2Nyb2xsV2hlZWxab29tKCk7CgogICAgICAgICAgICAgICAgICAgICAgbWFwLnNldE1hcFR5cGUoR19IWUJSSURfTUFQKTsKICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgIHJlc2l6ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICIiIgogICAgICAgIGlmIHNlbGYua21sOgogICAgICAgICAgICBzICs9ICIiIgogICAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0RWFydGhJbnN0YW5jZUNCKG9iamVjdCkgewogICAgICAgICAgICAgICAgICAgdmFyIGdlID0gb2JqZWN0OwoKICAgICAgICAgICAgICAgICAgIGlmIChnZSkgewogICAgICAgICAgICAgICAgICAgICAgIHZhciB1cmwgPSBkb2N1bWVudC5sb2NhdGlvbi50b1N0cmluZygpOwogICAgICAgICAgICAgICAgICAgICAgIHVybCA9IHVybC5zdWJzdHIoMCx1cmwubGFzdEluZGV4T2YoJy8nKSkrJy9kb2Mua21sJzsKICAgICAgICAgICAgICAgICAgICAgICB2YXIgbGluayA9IGdlLmNyZWF0ZUxpbmsoIiIpOwogICAgICAgICAgICAgICAgICAgICAgIGlmICgiJShwdWJsaXNodXJsKXMiKSB7IGxpbmsuc2V0SHJlZigiJShwdWJsaXNodXJsKXMvZG9jLmttbCIpIH0KICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsgbGluay5zZXRIcmVmKHVybCkgfTsKICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV0d29ya0xpbmsgPSBnZS5jcmVhdGVOZXR3b3JrTGluaygiIik7CiAgICAgICAgICAgICAgICAgICAgICAgbmV0d29ya0xpbmsuc2V0TmFtZSgiVE1TIE1hcCBPdmVybGF5Iik7CiAgICAgICAgICAgICAgICAgICAgICAgbmV0d29ya0xpbmsuc2V0Rmx5VG9WaWV3KHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgIG5ldHdvcmtMaW5rLnNldExpbmsobGluayk7CiAgICAgICAgICAgICAgICAgICAgICAgZ2UuZ2V0RmVhdHVyZXMoKS5hcHBlbmRDaGlsZChuZXR3b3JrTGluayk7CiAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgIC8vIGFsZXJ0KCJZb3Ugc2hvdWxkIG9wZW4gYSBLTUwgaW4gR29vZ2xlIEVhcnRoIik7CiAgICAgICAgICAgICAgICAgICAgICAgLy8gYWRkIGRpdiB3aXRoIHRoZSBsaW5rIHRvIGdlbmVyYXRlZCBLTUwuLi4gLSBtYXliZSBKYXZhU2NyaXB0IHJlZGlyZWN0IHRvIHRoZSBVUkwgb2YgS01MPwogICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICIiIiAlIGFyZ3MgICAgIyBub3FhCiAgICAgICAgcyArPSAiIiIKICAgICAgICAgICAgICAgIG9ucmVzaXplPWZ1bmN0aW9uKCl7IHJlc2l6ZSgpOyB9OwoKICAgICAgICAgICAgICAgIC8vXV0+CiAgICAgICAgICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgICAgICA8L2hlYWQ+CiAgICAgICAgICAgICAgPGJvZHkgb25sb2FkPSJsb2FkKCkiPgogICAgICAgICAgICAgICAgICA8ZGl2IGlkPSJoZWFkZXIiPjxoMT4lKHRpdGxlKXM8L2gxPjwvZGl2PgogICAgICAgICAgICAgICAgICA8ZGl2IGlkPSJzdWJoZWFkZXIiPkdlbmVyYXRlZCBieSA8YSBocmVmPSJodHRwOi8vd3d3Lmtsb2thbi5jei9wcm9qZWN0cy9nZGFsMnRpbGVzLyI+R0RBTDJUaWxlczwvYT4sIENvcHlyaWdodCAmY29weTsgMjAwOCA8YSBocmVmPSJodHRwOi8vd3d3Lmtsb2thbi5jei8iPktsb2thbiBQZXRyIFByaWRhbDwvYT4sICA8YSBocmVmPSJodHRwOi8vd3d3LmdkYWwub3JnLyI+R0RBTDwvYT4gJmFtcDsgPGEgaHJlZj0iaHR0cDovL3d3dy5vc2dlby5vcmcvIj5PU0dlbzwvYT4gPGEgaHJlZj0iaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9zb2MvIj5HU29DPC9hPgogICAgICAgICAgICA8IS0tIFBMRUFTRSwgTEVUIFRISVMgTk9URSBBQk9VVCBBVVRIT1IgQU5EIFBST0pFQ1QgU09NRVdIRVJFIE9OIFlPVVIgV0VCU0lURSwgT1IgQVQgTEVBU1QgSU4gVEhFIENPTU1FTlQgSU4gSFRNTC4gVEhBTksgWU9VIC0tPgogICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgIDxkaXYgaWQ9Im1hcCI+PC9kaXY+CiAgICAgICAgICAgICAgPC9ib2R5PgogICAgICAgICAgICA8L2h0bWw+CiAgICAgICAgIiIiICUgYXJncyAgICAjIG5vcWEKCiAgICAgICAgcmV0dXJuIHMKCiAgICBkZWYgZ2VuZXJhdGVfbGVhZmxldChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBUZW1wbGF0ZSBmb3IgbGVhZmxldC5odG1sIGltcGxlbWVudGluZyBvdmVybGF5IG9mIHRpbGVzIGZvciAnbWVyY2F0b3InIHByb2ZpbGUuCiAgICAgICAgSXQgcmV0dXJucyBmaWxsZWQgc3RyaW5nLiBFeHBlY3RlZCB2YXJpYWJsZXM6CiAgICAgICAgdGl0bGUsIG5vcnRoLCBzb3V0aCwgZWFzdCwgd2VzdCwgbWluem9vbSwgbWF4em9vbSwgdGlsZXNpemUsIHRpbGVmb3JtYXQsIHB1Ymxpc2h1cmwKICAgICAgICAiIiIKCiAgICAgICAgYXJncyA9IHt9CiAgICAgICAgYXJnc1sndGl0bGUnXSA9IHNlbGYub3B0aW9ucy50aXRsZS5yZXBsYWNlKCciJywgJ1xcIicpCiAgICAgICAgYXJnc1snaHRtbHRpdGxlJ10gPSBzZWxmLm9wdGlvbnMudGl0bGUKICAgICAgICBhcmdzWydzb3V0aCddLCBhcmdzWyd3ZXN0J10sIGFyZ3NbJ25vcnRoJ10sIGFyZ3NbJ2Vhc3QnXSA9IHNlbGYuc3duZQogICAgICAgIGFyZ3NbJ2NlbnRlcmxvbiddID0gKGFyZ3NbJ25vcnRoJ10gKyBhcmdzWydzb3V0aCddKSAvIDIuCiAgICAgICAgYXJnc1snY2VudGVybGF0J10gPSAoYXJnc1snd2VzdCddICsgYXJnc1snZWFzdCddKSAvIDIuCiAgICAgICAgYXJnc1snbWluem9vbSddID0gc2VsZi50bWluegogICAgICAgIGFyZ3NbJ21heHpvb20nXSA9IHNlbGYudG1heHoKICAgICAgICBhcmdzWydiZWdpbnpvb20nXSA9IHNlbGYudG1heHoKICAgICAgICBhcmdzWyd0aWxlc2l6ZSddID0gc2VsZi50aWxlc2l6ZSAgIyBub3QgdXNlZAogICAgICAgIGFyZ3NbJ3RpbGVmb3JtYXQnXSA9IHNlbGYudGlsZWV4dAogICAgICAgIGFyZ3NbJ3B1Ymxpc2h1cmwnXSA9IHNlbGYub3B0aW9ucy51cmwgICMgbm90IHVzZWQKICAgICAgICBhcmdzWydjb3B5cmlnaHQnXSA9IHNlbGYub3B0aW9ucy5jb3B5cmlnaHQucmVwbGFjZSgnIicsICdcXCInKQoKICAgICAgICBzID0gIiIiPCFET0NUWVBFIGh0bWw+CiAgICAgICAgPGh0bWwgbGFuZz0iZW4iPgogICAgICAgICAgPGhlYWQ+CiAgICAgICAgICAgIDxtZXRhIGNoYXJzZXQ9InV0Zi04Ij4KICAgICAgICAgICAgPG1ldGEgbmFtZT0ndmlld3BvcnQnIGNvbnRlbnQ9J3dpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xLjAsIG1heGltdW0tc2NhbGU9MS4wLCB1c2VyLXNjYWxhYmxlPW5vJyAvPgogICAgICAgICAgICA8dGl0bGU+JShodG1sdGl0bGUpczwvdGl0bGU+CgogICAgICAgICAgICA8IS0tIExlYWZsZXQgLS0+CiAgICAgICAgICAgIDxsaW5rIHJlbD0ic3R5bGVzaGVldCIgaHJlZj0iaHR0cDovL2Nkbi5sZWFmbGV0anMuY29tL2xlYWZsZXQtMC43LjUvbGVhZmxldC5jc3MiIC8+CiAgICAgICAgICAgIDxzY3JpcHQgc3JjPSJodHRwOi8vY2RuLmxlYWZsZXRqcy5jb20vbGVhZmxldC0wLjcuNS9sZWFmbGV0LmpzIj48L3NjcmlwdD4KCiAgICAgICAgICAgIDxzdHlsZT4KICAgICAgICAgICAgICAgIGJvZHkgeyBtYXJnaW46MDsgcGFkZGluZzowOyB9CiAgICAgICAgICAgICAgICBib2R5LCB0YWJsZSwgdHIsIHRkLCB0aCwgZGl2LCBoMSwgaDIsIGlucHV0IHsgZm9udC1mYW1pbHk6ICJDYWxpYnJpIiwgIlRyZWJ1Y2hldCBNUyIsICJVYnVudHUiLCBTZXJpZjsgZm9udC1zaXplOiAxMXB0OyB9CiAgICAgICAgICAgICAgICAjbWFwIHsgcG9zaXRpb246YWJzb2x1dGU7IHRvcDowOyBib3R0b206MDsgd2lkdGg6MTAwJSU7IH0gLyogZnVsbCBzaXplICovCiAgICAgICAgICAgICAgICAuY3RsIHsKICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAycHggMTBweCAycHggMTBweDsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwyNTUsMjU1LDAuOSk7CiAgICAgICAgICAgICAgICAgICAgYm94LXNoYWRvdzogMCAwIDE1cHggcmdiYSgwLDAsMCwwLjIpOwogICAgICAgICAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDVweDsKICAgICAgICAgICAgICAgICAgICB0ZXh0LWFsaWduOiByaWdodDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC50aXRsZSB7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zaXplOiAxOHB0OwogICAgICAgICAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLnNyYyB7CiAgICAgICAgICAgICAgICAgICAgZm9udC1zaXplOiAxMHB0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgPC9zdHlsZT4KCiAgICAgICAgPC9oZWFkPgogICAgICAgIDxib2R5PgoKICAgICAgICA8ZGl2IGlkPSJtYXAiPjwvZGl2PgoKICAgICAgICA8c2NyaXB0PgogICAgICAgIC8qICoqKiogTGVhZmxldCAqKioqICovCgogICAgICAgIC8vIEJhc2UgbGF5ZXJzCiAgICAgICAgLy8gIC4uIE9wZW5TdHJlZXRNYXAKICAgICAgICB2YXIgb3NtID0gTC50aWxlTGF5ZXIoJ2h0dHA6Ly97c30udGlsZS5vc20ub3JnL3t6fS97eH0ve3l9LnBuZycsIHthdHRyaWJ1dGlvbjogJyZjb3B5OyA8YSBocmVmPSJodHRwOi8vb3NtLm9yZy9jb3B5cmlnaHQiPk9wZW5TdHJlZXRNYXA8L2E+IGNvbnRyaWJ1dG9ycyd9KTsKCiAgICAgICAgLy8gIC4uIENhcnRvREIgUG9zaXRyb24KICAgICAgICB2YXIgY2FydG9kYiA9IEwudGlsZUxheWVyKCdodHRwOi8ve3N9LmJhc2VtYXBzLmNhcnRvY2RuLmNvbS9saWdodF9hbGwve3p9L3t4fS97eX0ucG5nJywge2F0dHJpYnV0aW9uOiAnJmNvcHk7IDxhIGhyZWY9Imh0dHA6Ly93d3cub3BlbnN0cmVldG1hcC5vcmcvY29weXJpZ2h0Ij5PcGVuU3RyZWV0TWFwPC9hPiBjb250cmlidXRvcnMsICZjb3B5OyA8YSBocmVmPSJodHRwOi8vY2FydG9kYi5jb20vYXR0cmlidXRpb25zIj5DYXJ0b0RCPC9hPid9KTsKCiAgICAgICAgLy8gIC4uIE9TTSBUb25lcgogICAgICAgIHZhciB0b25lciA9IEwudGlsZUxheWVyKCdodHRwOi8ve3N9LnRpbGUuc3RhbWVuLmNvbS90b25lci97en0ve3h9L3t5fS5wbmcnLCB7YXR0cmlidXRpb246ICdNYXAgdGlsZXMgYnkgPGEgaHJlZj0iaHR0cDovL3N0YW1lbi5jb20iPlN0YW1lbiBEZXNpZ248L2E+LCB1bmRlciA8YSBocmVmPSJodHRwOi8vY3JlYXRpdmVjb21tb25zLm9yZy9saWNlbnNlcy9ieS8zLjAiPkNDIEJZIDMuMDwvYT4uIERhdGEgYnkgPGEgaHJlZj0iaHR0cDovL29wZW5zdHJlZXRtYXAub3JnIj5PcGVuU3RyZWV0TWFwPC9hPiwgdW5kZXIgPGEgaHJlZj0iaHR0cDovL3d3dy5vcGVuc3RyZWV0bWFwLm9yZy9jb3B5cmlnaHQiPk9EYkw8L2E+Lid9KTsKCiAgICAgICAgLy8gIC4uIFdoaXRlIGJhY2tncm91bmQKICAgICAgICB2YXIgd2hpdGUgPSBMLnRpbGVMYXllcigiZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFRQUFBQUVBQVFNQUFBQm12RG9sQUFBQUExQk1WRVgvLy8rbnhCdklBQUFBSDBsRVFWUVlHZTNCQVEwQUFBRENJUHVuZmc0M1lBQUFBQUFBQUFBQTV3SWhBQUFCOWFLOUJBQUFBQUJKUlU1RXJrSmdnZz09Iik7CgogICAgICAgIC8vIE92ZXJsYXkgbGF5ZXJzIChUTVMpCiAgICAgICAgdmFyIGx5ciA9IEwudGlsZUxheWVyKCcuL3t6fS97eH0ve3l9LiUodGlsZWZvcm1hdClzJywge3RtczogdHJ1ZSwgb3BhY2l0eTogMC43LCBhdHRyaWJ1dGlvbjogIiUoY29weXJpZ2h0KXMifSk7CgogICAgICAgIC8vIE1hcAogICAgICAgIHZhciBtYXAgPSBMLm1hcCgnbWFwJywgewogICAgICAgICAgICBjZW50ZXI6IFslKGNlbnRlcmxvbilzLCAlKGNlbnRlcmxhdClzXSwKICAgICAgICAgICAgem9vbTogJShiZWdpbnpvb20pcywKICAgICAgICAgICAgbWluWm9vbTogJShtaW56b29tKXMsCiAgICAgICAgICAgIG1heFpvb206ICUobWF4em9vbSlzLAogICAgICAgICAgICBsYXllcnM6IFtvc21dCiAgICAgICAgfSk7CgogICAgICAgIHZhciBiYXNlbWFwcyA9IHsiT3BlblN0cmVldE1hcCI6IG9zbSwgIkNhcnRvREIgUG9zaXRyb24iOiBjYXJ0b2RiLCAiU3RhbWVuIFRvbmVyIjogdG9uZXIsICJXaXRob3V0IGJhY2tncm91bmQiOiB3aGl0ZX0KICAgICAgICB2YXIgb3ZlcmxheW1hcHMgPSB7IkxheWVyIjogbHlyfQoKICAgICAgICAvLyBUaXRsZQogICAgICAgIHZhciB0aXRsZSA9IEwuY29udHJvbCgpOwogICAgICAgIHRpdGxlLm9uQWRkID0gZnVuY3Rpb24obWFwKSB7CiAgICAgICAgICAgIHRoaXMuX2RpdiA9IEwuRG9tVXRpbC5jcmVhdGUoJ2RpdicsICdjdGwgdGl0bGUnKTsKICAgICAgICAgICAgdGhpcy51cGRhdGUoKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2RpdjsKICAgICAgICB9OwogICAgICAgIHRpdGxlLnVwZGF0ZSA9IGZ1bmN0aW9uKHByb3BzKSB7CiAgICAgICAgICAgIHRoaXMuX2Rpdi5pbm5lckhUTUwgPSAiJSh0aXRsZSlzIjsKICAgICAgICB9OwogICAgICAgIHRpdGxlLmFkZFRvKG1hcCk7CgogICAgICAgIC8vIE5vdGUKICAgICAgICB2YXIgc3JjID0gJ0dlbmVyYXRlZCBieSA8YSBocmVmPSJodHRwOi8vd3d3Lmtsb2thbi5jei9wcm9qZWN0cy9nZGFsMnRpbGVzLyI+R0RBTDJUaWxlczwvYT4sIENvcHlyaWdodCAmY29weTsgMjAwOCA8YSBocmVmPSJodHRwOi8vd3d3Lmtsb2thbi5jei8iPktsb2thbiBQZXRyIFByaWRhbDwvYT4sICA8YSBocmVmPSJodHRwOi8vd3d3LmdkYWwub3JnLyI+R0RBTDwvYT4gJmFtcDsgPGEgaHJlZj0iaHR0cDovL3d3dy5vc2dlby5vcmcvIj5PU0dlbzwvYT4gPGEgaHJlZj0iaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9zb2MvIj5HU29DPC9hPic7CiAgICAgICAgdmFyIHRpdGxlID0gTC5jb250cm9sKHtwb3NpdGlvbjogJ2JvdHRvbWxlZnQnfSk7CiAgICAgICAgdGl0bGUub25BZGQgPSBmdW5jdGlvbihtYXApIHsKICAgICAgICAgICAgdGhpcy5fZGl2ID0gTC5Eb21VdGlsLmNyZWF0ZSgnZGl2JywgJ2N0bCBzcmMnKTsKICAgICAgICAgICAgdGhpcy51cGRhdGUoKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2RpdjsKICAgICAgICB9OwogICAgICAgIHRpdGxlLnVwZGF0ZSA9IGZ1bmN0aW9uKHByb3BzKSB7CiAgICAgICAgICAgIHRoaXMuX2Rpdi5pbm5lckhUTUwgPSBzcmM7CiAgICAgICAgfTsKICAgICAgICB0aXRsZS5hZGRUbyhtYXApOwoKCiAgICAgICAgLy8gQWRkIGJhc2UgbGF5ZXJzCiAgICAgICAgTC5jb250cm9sLmxheWVycyhiYXNlbWFwcywgb3ZlcmxheW1hcHMsIHtjb2xsYXBzZWQ6IGZhbHNlfSkuYWRkVG8obWFwKTsKCiAgICAgICAgLy8gRml0IHRvIG92ZXJsYXkgYm91bmRzIChTVyBhbmQgTkUgcG9pbnRzIHdpdGggKGxhdCwgbG9uKSkKICAgICAgICBtYXAuZml0Qm91bmRzKFtbJShzb3V0aClzLCAlKGVhc3Qpc10sIFslKG5vcnRoKXMsICUod2VzdClzXV0pOwoKICAgICAgICA8L3NjcmlwdD4KCiAgICAgICAgPC9ib2R5PgogICAgICAgIDwvaHRtbD4KCiAgICAgICAgIiIiICUgYXJncyAgICAjIG5vcWEKCiAgICAgICAgcmV0dXJuIHMKCiAgICBkZWYgZ2VuZXJhdGVfb3BlbmxheWVycyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBUZW1wbGF0ZSBmb3Igb3BlbmxheWVycy5odG1sIGltcGxlbWVudGluZyBvdmVybGF5IG9mIGF2YWlsYWJsZSBTcGhlcmljYWwgTWVyY2F0b3IgbGF5ZXJzLgoKICAgICAgICBJdCByZXR1cm5zIGZpbGxlZCBzdHJpbmcuIEV4cGVjdGVkIHZhcmlhYmxlczoKICAgICAgICB0aXRsZSwgYmluZ2tleSwgbm9ydGgsIHNvdXRoLCBlYXN0LCB3ZXN0LCBtaW56b29tLCBtYXh6b29tLCB0aWxlc2l6ZSwgdGlsZWZvcm1hdCwgcHVibGlzaHVybAogICAgICAgICIiIgoKICAgICAgICBhcmdzID0ge30KICAgICAgICBhcmdzWyd0aXRsZSddID0gc2VsZi5vcHRpb25zLnRpdGxlCiAgICAgICAgYXJnc1snYmluZ2tleSddID0gc2VsZi5vcHRpb25zLmJpbmdrZXkKICAgICAgICBhcmdzWydzb3V0aCddLCBhcmdzWyd3ZXN0J10sIGFyZ3NbJ25vcnRoJ10sIGFyZ3NbJ2Vhc3QnXSA9IHNlbGYuc3duZQogICAgICAgIGFyZ3NbJ21pbnpvb20nXSA9IHNlbGYudG1pbnoKICAgICAgICBhcmdzWydtYXh6b29tJ10gPSBzZWxmLnRtYXh6CiAgICAgICAgYXJnc1sndGlsZXNpemUnXSA9IHNlbGYudGlsZXNpemUKICAgICAgICBhcmdzWyd0aWxlZm9ybWF0J10gPSBzZWxmLnRpbGVleHQKICAgICAgICBhcmdzWydwdWJsaXNodXJsJ10gPSBzZWxmLm9wdGlvbnMudXJsCiAgICAgICAgYXJnc1snY29weXJpZ2h0J10gPSBzZWxmLm9wdGlvbnMuY29weXJpZ2h0CiAgICAgICAgaWYgc2VsZi5vcHRpb25zLnRtc2NvbXBhdGlibGU6CiAgICAgICAgICAgIGFyZ3NbJ3Rtc29mZnNldCddID0gIi0xIgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGFyZ3NbJ3Rtc29mZnNldCddID0gIiIKICAgICAgICBpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAncmFzdGVyJzoKICAgICAgICAgICAgYXJnc1sncmFzdGVyem9vbWxldmVscyddID0gc2VsZi50bWF4eisxCiAgICAgICAgICAgIGFyZ3NbJ3Jhc3Rlcm1heHJlc29sdXRpb24nXSA9IDIqKihzZWxmLm5hdGl2ZXpvb20pICogc2VsZi5vdXRfZ3RbMV0KCiAgICAgICAgcyA9IHIiIiI8IURPQ1RZUEUgaHRtbCBQVUJMSUMgIi0vL1czQy8vRFREIFhIVE1MIDEuMCBTdHJpY3QvL0VOIiAiaHR0cDovL3d3dy53My5vcmcvVFIveGh0bWwxL0RURC94aHRtbDEtc3RyaWN0LmR0ZCI+CiAgICAgICAgPGh0bWwgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiCiAgICAgICAgICA8aGVhZD4KICAgICAgICAgICAgPHRpdGxlPiUodGl0bGUpczwvdGl0bGU+CiAgICAgICAgICAgIDxtZXRhIGh0dHAtZXF1aXY9J2ltYWdldG9vbGJhcicgY29udGVudD0nbm8nLz4KICAgICAgICAgICAgPHN0eWxlIHR5cGU9InRleHQvY3NzIj4gdlw6KiB7YmVoYXZpb3I6dXJsKCNkZWZhdWx0I1ZNTCk7fQogICAgICAgICAgICAgICAgaHRtbCwgYm9keSB7IG92ZXJmbG93OiBoaWRkZW47IHBhZGRpbmc6IDA7IGhlaWdodDogMTAwJSU7IHdpZHRoOiAxMDAlJTsgZm9udC1mYW1pbHk6ICdMdWNpZGEgR3JhbmRlJyxHZW5ldmEsQXJpYWwsVmVyZGFuYSxzYW5zLXNlcmlmOyB9CiAgICAgICAgICAgICAgICBib2R5IHsgbWFyZ2luOiAxMHB4OyBiYWNrZ3JvdW5kOiAjZmZmOyB9CiAgICAgICAgICAgICAgICBoMSB7IG1hcmdpbjogMDsgcGFkZGluZzogNnB4OyBib3JkZXI6MDsgZm9udC1zaXplOiAyMHB0OyB9CiAgICAgICAgICAgICNoZWFkZXIgeyBoZWlnaHQ6IDQzcHg7IHBhZGRpbmc6IDA7IGJhY2tncm91bmQtY29sb3I6ICNlZWU7IGJvcmRlcjogMXB4IHNvbGlkICM4ODg7IH0KICAgICAgICAgICAgI3N1YmhlYWRlciB7IGhlaWdodDogMTJweDsgdGV4dC1hbGlnbjogcmlnaHQ7IGZvbnQtc2l6ZTogMTBweDsgY29sb3I6ICM1NTU7fQogICAgICAgICAgICAjbWFwIHsgaGVpZ2h0OiA5NSUlOyBib3JkZXI6IDFweCBzb2xpZCAjODg4OyB9CiAgICAgICAgICAgIC5vbEltYWdlTG9hZEVycm9yIHsgZGlzcGxheTogbm9uZTsgfQogICAgICAgICAgICAub2xDb250cm9sTGF5ZXJTd2l0Y2hlciAubGF5ZXJzRGl2IHsgYm9yZGVyLXJhZGl1czogMTBweCAwIDAgMTBweDsgfQogICAgICAgIDwvc3R5bGU+IiIiICUgYXJncyAgICAjIG5vcWEKCiAgICAgICAgaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ21lcmNhdG9yJzoKICAgICAgICAgICAgcyArPSAiIiIKICAgICAgICAgICAgPHNjcmlwdCBzcmM9J2h0dHA6Ly9tYXBzLmdvb2dsZS5jb20vbWFwcy9hcGkvanM/c2Vuc29yPWZhbHNlJnY9My43Jz48L3NjcmlwdD4KICAgICAgICAgICAgIiIiICUgYXJncwoKICAgICAgICBzICs9ICIiIgogICAgICAgICAgICA8c2NyaXB0IHNyYz0iaHR0cDovL3d3dy5vcGVubGF5ZXJzLm9yZy9hcGkvMi4xMi9PcGVuTGF5ZXJzLmpzIj48L3NjcmlwdD4KICAgICAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICAgICB2YXIgbWFwOwogICAgICAgICAgICAgIHZhciBtYXBCb3VuZHMgPSBuZXcgT3BlbkxheWVycy5Cb3VuZHMoICUod2VzdClzLCAlKHNvdXRoKXMsICUoZWFzdClzLCAlKG5vcnRoKXMpOwogICAgICAgICAgICAgIHZhciBtYXBNaW5ab29tID0gJShtaW56b29tKXM7CiAgICAgICAgICAgICAgdmFyIG1hcE1heFpvb20gPSAlKG1heHpvb20pczsKICAgICAgICAgICAgICB2YXIgZW1wdHlUaWxlVVJMID0gImh0dHA6Ly93d3cubWFwdGlsZXIub3JnL2ltZy9ub25lLnBuZyI7CiAgICAgICAgICAgICAgT3BlbkxheWVycy5JTUFHRV9SRUxPQURfQVRURU1QVFMgPSAzOwoKICAgICAgICAgICAgICBmdW5jdGlvbiBpbml0KCl7IiIiICUgYXJncwoKICAgICAgICBpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAnbWVyY2F0b3InOgogICAgICAgICAgICBzICs9ICIiIgogICAgICAgICAgICAgICAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgICAgICAgICAgICAgICAgIGRpdjogIm1hcCIsCiAgICAgICAgICAgICAgICAgICAgICBjb250cm9sczogW10sCiAgICAgICAgICAgICAgICAgICAgICBwcm9qZWN0aW9uOiAiRVBTRzozODU3IiwKICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXlQcm9qZWN0aW9uOiBuZXcgT3BlbkxheWVycy5Qcm9qZWN0aW9uKCJFUFNHOjQzMjYiKSwKICAgICAgICAgICAgICAgICAgICAgIG51bVpvb21MZXZlbHM6IDIwCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIG1hcCA9IG5ldyBPcGVuTGF5ZXJzLk1hcChvcHRpb25zKTsKCiAgICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBHb29nbGUgTWVyY2F0b3IgbGF5ZXJzCiAgICAgICAgICAgICAgICAgIHZhciBnbWFwID0gbmV3IE9wZW5MYXllcnMuTGF5ZXIuR29vZ2xlKCJHb29nbGUgU3RyZWV0cyIsCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IGdvb2dsZS5tYXBzLk1hcFR5cGVJZC5ST0FETUFQLAogICAgICAgICAgICAgICAgICAgICAgc3BoZXJpY2FsTWVyY2F0b3I6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHZhciBnc2F0ID0gbmV3IE9wZW5MYXllcnMuTGF5ZXIuR29vZ2xlKCJHb29nbGUgU2F0ZWxsaXRlIiwKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogZ29vZ2xlLm1hcHMuTWFwVHlwZUlkLlNBVEVMTElURSwKICAgICAgICAgICAgICAgICAgICAgIHNwaGVyaWNhbE1lcmNhdG9yOiB0cnVlCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB2YXIgZ2h5YiA9IG5ldyBPcGVuTGF5ZXJzLkxheWVyLkdvb2dsZSgiR29vZ2xlIEh5YnJpZCIsCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IGdvb2dsZS5tYXBzLk1hcFR5cGVJZC5IWUJSSUQsCiAgICAgICAgICAgICAgICAgICAgICBzcGhlcmljYWxNZXJjYXRvcjogdHJ1ZQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgdmFyIGd0ZXIgPSBuZXcgT3BlbkxheWVycy5MYXllci5Hb29nbGUoIkdvb2dsZSBUZXJyYWluIiwKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogZ29vZ2xlLm1hcHMuTWFwVHlwZUlkLlRFUlJBSU4sCiAgICAgICAgICAgICAgICAgICAgICBzcGhlcmljYWxNZXJjYXRvcjogdHJ1ZQogICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBCaW5nIGxheWVycwogICAgICAgICAgICAgICAgICB2YXIgYnJvYWQgPSBuZXcgT3BlbkxheWVycy5MYXllci5CaW5nKHsKICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICJCaW5nIFJvYWRzIiwKICAgICAgICAgICAgICAgICAgICAgIGtleTogIiUoYmluZ2tleSlzIiwKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJSb2FkIiwKICAgICAgICAgICAgICAgICAgICAgIHNwaGVyaWNhbE1lcmNhdG9yOiB0cnVlCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB2YXIgYmFlciA9IG5ldyBPcGVuTGF5ZXJzLkxheWVyLkJpbmcoewogICAgICAgICAgICAgICAgICAgICAgbmFtZTogIkJpbmcgQWVyaWFsIiwKICAgICAgICAgICAgICAgICAgICAgIGtleTogIiUoYmluZ2tleSlzIiwKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJBZXJpYWwiLAogICAgICAgICAgICAgICAgICAgICAgc3BoZXJpY2FsTWVyY2F0b3I6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHZhciBiaHliID0gbmV3IE9wZW5MYXllcnMuTGF5ZXIuQmluZyh7CiAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAiQmluZyBIeWJyaWQiLAogICAgICAgICAgICAgICAgICAgICAga2V5OiAiJShiaW5na2V5KXMiLAogICAgICAgICAgICAgICAgICAgICAgdHlwZTogIkFlcmlhbFdpdGhMYWJlbHMiLAogICAgICAgICAgICAgICAgICAgICAgc3BoZXJpY2FsTWVyY2F0b3I6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAvLyBDcmVhdGUgT1NNIGxheWVyCiAgICAgICAgICAgICAgICAgIHZhciBvc20gPSBuZXcgT3BlbkxheWVycy5MYXllci5PU00oIk9wZW5TdHJlZXRNYXAiKTsKCiAgICAgICAgICAiIiIgJSBhcmdzICAgICMgbm9xYQoJCSAgCiAgICAgICAgICAgIGlmIHNlbGYub3B0aW9ucy54eXo6CiAgICAgICAgICAgICAgICBzICs9ICIiIgkJICAKICAgICAgICAgICAgICAgICAgLy8gY3JlYXRlIFRNUyBPdmVybGF5IGxheWVyCiAgICAgICAgICAgICAgICAgICB2YXIgdG1zb3ZlcmxheSA9IG5ldyBPcGVuTGF5ZXJzLkxheWVyLlhZWigiWFlaIE92ZXJsYXkiLAogICAgICAgICAgICAgICAgICAgICAgIiR7en0vJHt4fS8ke3l9LnBuZyIsIHsKICAgICAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb25FZmZlY3Q6ICdyZXNpemUnLAogICAgICAgICAgICAgICAgICAgICAgaXNCYXNlTGF5ZXI6IGZhbHNlCiAgICAgICAgICAgICAgICAgIH0pOwoJCQkJICAKCQkgICAgICAgICIiIiAlIGFyZ3MgICAgIyBub3FhCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzICs9ICIiIgkJICAKICAgICAgICAgICAgICAgICAgLy8gY3JlYXRlIFRNUyBPdmVybGF5IGxheWVyCiAgICAgICAgICAgICAgICAgICB2YXIgdG1zb3ZlcmxheSA9IG5ldyBPcGVuTGF5ZXJzLkxheWVyLlRNUygiVE1TIE92ZXJsYXkiLCAiIiwKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgc2VydmljZVZlcnNpb246ICcuJywKICAgICAgICAgICAgICAgICAgICAgIGxheWVybmFtZTogJy4nLAogICAgICAgICAgICAgICAgICAgICAgYWxwaGE6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnJSh0aWxlZm9ybWF0KXMnLAogICAgICAgICAgICAgICAgICAgICAgaXNCYXNlTGF5ZXI6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgZ2V0VVJMOiBnZXRVUkwKICAgICAgICAgICAgICAgICAgfSk7CgkJCQkgIAoJCSAgICAgICAgIiIiICUgYXJncyAgICAjIG5vcWEJCSAgCgkJICAKICAgICAgICAgICAgcyArPSAiIiIgIAogICAgICAgICAgICAgICAgICBpZiAoT3BlbkxheWVycy5VdGlsLmFscGhhSGFjaygpID09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICB0bXNvdmVybGF5LnNldE9wYWNpdHkoMC43KTsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgbWFwLmFkZExheWVycyhbZ21hcCwgZ3NhdCwgZ2h5YiwgZ3RlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJvYWQsIGJhZXIsIGJoeWIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9zbSwgdG1zb3ZlcmxheV0pOwoKICAgICAgICAgICAgICAgICAgdmFyIHN3aXRjaGVyQ29udHJvbCA9IG5ldyBPcGVuTGF5ZXJzLkNvbnRyb2wuTGF5ZXJTd2l0Y2hlcigpOwogICAgICAgICAgICAgICAgICBtYXAuYWRkQ29udHJvbChzd2l0Y2hlckNvbnRyb2wpOwogICAgICAgICAgICAgICAgICBzd2l0Y2hlckNvbnRyb2wubWF4aW1pemVDb250cm9sKCk7CgogICAgICAgICAgICAgICAgICBtYXAuem9vbVRvRXh0ZW50KG1hcEJvdW5kcy50cmFuc2Zvcm0obWFwLmRpc3BsYXlQcm9qZWN0aW9uLCBtYXAucHJvamVjdGlvbikpOwogICAgICAgICAgIiIiICUgYXJncyAgICAjIG5vcWEKCiAgICAgICAgZWxpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAnZ2VvZGV0aWMnOgogICAgICAgICAgICBzICs9ICIiIgogICAgICAgICAgICAgICAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgICAgICAgICAgICAgICAgIGRpdjogIm1hcCIsCiAgICAgICAgICAgICAgICAgICAgICBjb250cm9sczogW10sCiAgICAgICAgICAgICAgICAgICAgICBwcm9qZWN0aW9uOiAiRVBTRzo0MzI2IgogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBtYXAgPSBuZXcgT3BlbkxheWVycy5NYXAob3B0aW9ucyk7CgogICAgICAgICAgICAgICAgICB2YXIgd21zID0gbmV3IE9wZW5MYXllcnMuTGF5ZXIuV01TKCJWTWFwMCIsCiAgICAgICAgICAgICAgICAgICAgICAiaHR0cDovL3RpbGVjYWNoZS5vc2dlby5vcmcvd21zLWMvQmFzaWMucHk/IiwKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBsYXllcnM6ICdiYXNpYycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0OiAnaW1hZ2UvcG5nJwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB2YXIgdG1zb3ZlcmxheSA9IG5ldyBPcGVuTGF5ZXJzLkxheWVyLlRNUygiVE1TIE92ZXJsYXkiLCAiIiwKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgc2VydmljZVZlcnNpb246ICcuJywKICAgICAgICAgICAgICAgICAgICAgIGxheWVybmFtZTogJy4nLAogICAgICAgICAgICAgICAgICAgICAgYWxwaGE6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnJSh0aWxlZm9ybWF0KXMnLAogICAgICAgICAgICAgICAgICAgICAgaXNCYXNlTGF5ZXI6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgZ2V0VVJMOiBnZXRVUkwKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIGlmIChPcGVuTGF5ZXJzLlV0aWwuYWxwaGFIYWNrKCkgPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgIHRtc292ZXJsYXkuc2V0T3BhY2l0eSgwLjcpOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBtYXAuYWRkTGF5ZXJzKFt3bXMsdG1zb3ZlcmxheV0pOwoKICAgICAgICAgICAgICAgICAgdmFyIHN3aXRjaGVyQ29udHJvbCA9IG5ldyBPcGVuTGF5ZXJzLkNvbnRyb2wuTGF5ZXJTd2l0Y2hlcigpOwogICAgICAgICAgICAgICAgICBtYXAuYWRkQ29udHJvbChzd2l0Y2hlckNvbnRyb2wpOwogICAgICAgICAgICAgICAgICBzd2l0Y2hlckNvbnRyb2wubWF4aW1pemVDb250cm9sKCk7CgogICAgICAgICAgICAgICAgICBtYXAuem9vbVRvRXh0ZW50KG1hcEJvdW5kcyk7CiAgICAgICAgICAgIiIiICUgYXJncyAgICMgbm9xYQoKICAgICAgICBlbGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdyYXN0ZXInOgogICAgICAgICAgICBzICs9ICIiIgogICAgICAgICAgICAgICAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgICAgICAgICAgICAgICAgIGRpdjogIm1hcCIsCiAgICAgICAgICAgICAgICAgICAgICBjb250cm9sczogW10sCiAgICAgICAgICAgICAgICAgICAgICBtYXhFeHRlbnQ6IG5ldyBPcGVuTGF5ZXJzLkJvdW5kcyglKHdlc3QpcywgJShzb3V0aClzLCAlKGVhc3QpcywgJShub3J0aClzKSwKICAgICAgICAgICAgICAgICAgICAgIG1heFJlc29sdXRpb246ICUocmFzdGVybWF4cmVzb2x1dGlvbilmLAogICAgICAgICAgICAgICAgICAgICAgbnVtWm9vbUxldmVsczogJShyYXN0ZXJ6b29tbGV2ZWxzKWQKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgbWFwID0gbmV3IE9wZW5MYXllcnMuTWFwKG9wdGlvbnMpOwoKICAgICAgICAgICAgICAgICAgdmFyIGxheWVyID0gbmV3IE9wZW5MYXllcnMuTGF5ZXIuVE1TKCJUTVMgTGF5ZXIiLCAiIiwKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgc2VydmljZVZlcnNpb246ICcuJywKICAgICAgICAgICAgICAgICAgICAgIGxheWVybmFtZTogJy4nLAogICAgICAgICAgICAgICAgICAgICAgYWxwaGE6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnJSh0aWxlZm9ybWF0KXMnLAogICAgICAgICAgICAgICAgICAgICAgZ2V0VVJMOiBnZXRVUkwKICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICBtYXAuYWRkTGF5ZXIobGF5ZXIpOwogICAgICAgICAgICAgICAgICBtYXAuem9vbVRvRXh0ZW50KG1hcEJvdW5kcyk7CiAgICAgICAgIiIiICUgYXJncyAgICAjIG5vcWEKCiAgICAgICAgcyArPSAiIiIKICAgICAgICAgICAgICAgICAgbWFwLmFkZENvbnRyb2xzKFtuZXcgT3BlbkxheWVycy5Db250cm9sLlBhblpvb21CYXIoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgT3BlbkxheWVycy5Db250cm9sLk5hdmlnYXRpb24oKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgT3BlbkxheWVycy5Db250cm9sLk1vdXNlUG9zaXRpb24oKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgT3BlbkxheWVycy5Db250cm9sLkFyZ1BhcnNlcigpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBPcGVuTGF5ZXJzLkNvbnRyb2wuQXR0cmlidXRpb24oKV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAiIiIgJSBhcmdzCgogICAgICAgIGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdtZXJjYXRvcicgYW5kIHNlbGYub3B0aW9ucy54eXogaXMgTm9uZToKICAgICAgICAgICAgcyArPSAiIiIKICAgICAgICAgICAgICBmdW5jdGlvbiBnZXRVUkwoYm91bmRzKSB7CiAgICAgICAgICAgICAgICAgIGJvdW5kcyA9IHRoaXMuYWRqdXN0Qm91bmRzKGJvdW5kcyk7CiAgICAgICAgICAgICAgICAgIHZhciByZXMgPSB0aGlzLmdldFNlcnZlclJlc29sdXRpb24oKTsKICAgICAgICAgICAgICAgICAgdmFyIHggPSBNYXRoLnJvdW5kKChib3VuZHMubGVmdCAtIHRoaXMudGlsZU9yaWdpbi5sb24pIC8gKHJlcyAqIHRoaXMudGlsZVNpemUudykpOwogICAgICAgICAgICAgICAgICB2YXIgeSA9IE1hdGgucm91bmQoKGJvdW5kcy5ib3R0b20gLSB0aGlzLnRpbGVPcmlnaW4ubGF0KSAvIChyZXMgKiB0aGlzLnRpbGVTaXplLmgpKTsKICAgICAgICAgICAgICAgICAgdmFyIHogPSB0aGlzLmdldFNlcnZlclpvb20oKTsKICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubWFwLmJhc2VMYXllci5DTEFTU19OQU1FID09PSAnT3BlbkxheWVycy5MYXllci5CaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgeis9MTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgcGF0aCA9IHRoaXMuc2VydmljZVZlcnNpb24gKyAiLyIgKyB0aGlzLmxheWVybmFtZSArICIvIiArIHogKyAiLyIgKyB4ICsgIi8iICsgeSArICIuIiArIHRoaXMudHlwZTsKICAgICAgICAgICAgICAgICAgdmFyIHVybCA9IHRoaXMudXJsOwogICAgICAgICAgICAgICAgICBpZiAoT3BlbkxheWVycy5VdGlsLmlzQXJyYXkodXJsKSkgewogICAgICAgICAgICAgICAgICAgICAgdXJsID0gdGhpcy5zZWxlY3RVcmwocGF0aCwgdXJsKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAobWFwQm91bmRzLmludGVyc2VjdHNCb3VuZHMoYm91bmRzKSAmJiAoeiA+PSBtYXBNaW5ab29tKSAmJiAoeiA8PSBtYXBNYXhab29tKSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVybCArIHBhdGg7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZW1wdHlUaWxlVVJMOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAiIiIgJSBhcmdzICAgICMgbm9xYQoKICAgICAgICBlbGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdnZW9kZXRpYyc6CiAgICAgICAgICAgIHMgKz0gIiIiCiAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0VVJMKGJvdW5kcykgewogICAgICAgICAgICAgICAgICBib3VuZHMgPSB0aGlzLmFkanVzdEJvdW5kcyhib3VuZHMpOwogICAgICAgICAgICAgICAgICB2YXIgcmVzID0gdGhpcy5nZXRTZXJ2ZXJSZXNvbHV0aW9uKCk7CiAgICAgICAgICAgICAgICAgIHZhciB4ID0gTWF0aC5yb3VuZCgoYm91bmRzLmxlZnQgLSB0aGlzLnRpbGVPcmlnaW4ubG9uKSAvIChyZXMgKiB0aGlzLnRpbGVTaXplLncpKTsKICAgICAgICAgICAgICAgICAgdmFyIHkgPSBNYXRoLnJvdW5kKChib3VuZHMuYm90dG9tIC0gdGhpcy50aWxlT3JpZ2luLmxhdCkgLyAocmVzICogdGhpcy50aWxlU2l6ZS5oKSk7CiAgICAgICAgICAgICAgICAgIHZhciB6ID0gdGhpcy5nZXRTZXJ2ZXJab29tKCklKHRtc29mZnNldClzOwogICAgICAgICAgICAgICAgICB2YXIgcGF0aCA9IHRoaXMuc2VydmljZVZlcnNpb24gKyAiLyIgKyB0aGlzLmxheWVybmFtZSArICIvIiArIHogKyAiLyIgKyB4ICsgIi8iICsgeSArICIuIiArIHRoaXMudHlwZTsKICAgICAgICAgICAgICAgICAgdmFyIHVybCA9IHRoaXMudXJsOwogICAgICAgICAgICAgICAgICBpZiAoT3BlbkxheWVycy5VdGlsLmlzQXJyYXkodXJsKSkgewogICAgICAgICAgICAgICAgICAgICAgdXJsID0gdGhpcy5zZWxlY3RVcmwocGF0aCwgdXJsKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAobWFwQm91bmRzLmludGVyc2VjdHNCb3VuZHMoYm91bmRzKSAmJiAoeiA+PSBtYXBNaW5ab29tKSAmJiAoeiA8PSBtYXBNYXhab29tKSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVybCArIHBhdGg7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZW1wdHlUaWxlVVJMOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAiIiIgJSBhcmdzICAgICMgbm9xYQoKICAgICAgICBlbGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdyYXN0ZXInOgogICAgICAgICAgICBzICs9ICIiIgogICAgICAgICAgICAgIGZ1bmN0aW9uIGdldFVSTChib3VuZHMpIHsKICAgICAgICAgICAgICAgICAgYm91bmRzID0gdGhpcy5hZGp1c3RCb3VuZHMoYm91bmRzKTsKICAgICAgICAgICAgICAgICAgdmFyIHJlcyA9IHRoaXMuZ2V0U2VydmVyUmVzb2x1dGlvbigpOwogICAgICAgICAgICAgICAgICB2YXIgeCA9IE1hdGgucm91bmQoKGJvdW5kcy5sZWZ0IC0gdGhpcy50aWxlT3JpZ2luLmxvbikgLyAocmVzICogdGhpcy50aWxlU2l6ZS53KSk7CiAgICAgICAgICAgICAgICAgIHZhciB5ID0gTWF0aC5yb3VuZCgoYm91bmRzLmJvdHRvbSAtIHRoaXMudGlsZU9yaWdpbi5sYXQpIC8gKHJlcyAqIHRoaXMudGlsZVNpemUuaCkpOwogICAgICAgICAgICAgICAgICB2YXIgeiA9IHRoaXMuZ2V0U2VydmVyWm9vbSgpOwogICAgICAgICAgICAgICAgICB2YXIgcGF0aCA9IHRoaXMuc2VydmljZVZlcnNpb24gKyAiLyIgKyB0aGlzLmxheWVybmFtZSArICIvIiArIHogKyAiLyIgKyB4ICsgIi8iICsgeSArICIuIiArIHRoaXMudHlwZTsKICAgICAgICAgICAgICAgICAgdmFyIHVybCA9IHRoaXMudXJsOwogICAgICAgICAgICAgICAgICBpZiAoT3BlbkxheWVycy5VdGlsLmlzQXJyYXkodXJsKSkgewogICAgICAgICAgICAgICAgICAgICAgdXJsID0gdGhpcy5zZWxlY3RVcmwocGF0aCwgdXJsKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAobWFwQm91bmRzLmludGVyc2VjdHNCb3VuZHMoYm91bmRzKSAmJiAoeiA+PSBtYXBNaW5ab29tKSAmJiAoeiA8PSBtYXBNYXhab29tKSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVybCArIHBhdGg7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZW1wdHlUaWxlVVJMOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAiIiIgJSBhcmdzICAgICMgbm9xYQoKICAgICAgICBzICs9ICIiIgogICAgICAgICAgIGZ1bmN0aW9uIGdldFdpbmRvd0hlaWdodCgpIHsKICAgICAgICAgICAgICAgIGlmIChzZWxmLmlubmVySGVpZ2h0KSByZXR1cm4gc2VsZi5pbm5lckhlaWdodDsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0OwogICAgICAgICAgICAgICAgICAgIGlmIChkb2N1bWVudC5ib2R5KSByZXR1cm4gZG9jdW1lbnQuYm9keS5jbGllbnRIZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGdldFdpbmRvd1dpZHRoKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLmlubmVyV2lkdGgpIHJldHVybiBzZWxmLmlubmVyV2lkdGg7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50V2lkdGgpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50V2lkdGg7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LmJvZHkpIHJldHVybiBkb2N1bWVudC5ib2R5LmNsaWVudFdpZHRoOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiByZXNpemUoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1hcCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJtYXAiKTsKICAgICAgICAgICAgICAgICAgICB2YXIgaGVhZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImhlYWRlciIpOwogICAgICAgICAgICAgICAgICAgIHZhciBzdWJoZWFkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic3ViaGVhZGVyIik7CiAgICAgICAgICAgICAgICAgICAgbWFwLnN0eWxlLmhlaWdodCA9IChnZXRXaW5kb3dIZWlnaHQoKS04MCkgKyAicHgiOwogICAgICAgICAgICAgICAgICAgIG1hcC5zdHlsZS53aWR0aCA9IChnZXRXaW5kb3dXaWR0aCgpLTIwKSArICJweCI7CiAgICAgICAgICAgICAgICAgICAgaGVhZGVyLnN0eWxlLndpZHRoID0gKGdldFdpbmRvd1dpZHRoKCktMjApICsgInB4IjsKICAgICAgICAgICAgICAgICAgICBzdWJoZWFkZXIuc3R5bGUud2lkdGggPSAoZ2V0V2luZG93V2lkdGgoKS0yMCkgKyAicHgiOwogICAgICAgICAgICAgICAgICAgIGlmIChtYXAudXBkYXRlU2l6ZSkgeyBtYXAudXBkYXRlU2l6ZSgpOyB9OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG9ucmVzaXplPWZ1bmN0aW9uKCl7IHJlc2l6ZSgpOyB9OwoKICAgICAgICAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICAgICAgIDwvaGVhZD4KICAgICAgICAgICAgICA8Ym9keSBvbmxvYWQ9ImluaXQoKSI+CiAgICAgICAgICAgICAgICA8ZGl2IGlkPSJoZWFkZXIiPjxoMT4lKHRpdGxlKXM8L2gxPjwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBpZD0ic3ViaGVhZGVyIj5HZW5lcmF0ZWQgYnkgPGEgaHJlZj0iaHR0cDovL3d3dy5rbG9rYW4uY3ovcHJvamVjdHMvZ2RhbDJ0aWxlcy8iPkdEQUwyVGlsZXM8L2E+LCBDb3B5cmlnaHQgJmNvcHk7IDIwMDggPGEgaHJlZj0iaHR0cDovL3d3dy5rbG9rYW4uY3ovIj5LbG9rYW4gUGV0ciBQcmlkYWw8L2E+LCAgPGEgaHJlZj0iaHR0cDovL3d3dy5nZGFsLm9yZy8iPkdEQUw8L2E+ICZhbXA7IDxhIGhyZWY9Imh0dHA6Ly93d3cub3NnZW8ub3JnLyI+T1NHZW88L2E+IDxhIGhyZWY9Imh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vc29jLyI+R1NvQzwvYT4KICAgICAgICAgICAgICAgIDwhLS0gUExFQVNFLCBMRVQgVEhJUyBOT1RFIEFCT1VUIEFVVEhPUiBBTkQgUFJPSkVDVCBTT01FV0hFUkUgT04gWU9VUiBXRUJTSVRFLCBPUiBBVCBMRUFTVCBJTiBUSEUgQ09NTUVOVCBJTiBIVE1MLiBUSEFOSyBZT1UgLS0+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgaWQ9Im1hcCI+PC9kaXY+CiAgICAgICAgICAgICAgICA8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCIgPnJlc2l6ZSgpPC9zY3JpcHQ+CiAgICAgICAgICAgICAgPC9ib2R5PgogICAgICAgICAgICA8L2h0bWw+IiIiICUgYXJncyAgICMgbm9xYQoKICAgICAgICByZXR1cm4gcwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRZdGlsZSh0eSwgdHosIG9wdGlvbnMpOgogICAgICAgICIiIgogICAgICAgIENhbGN1bGF0ZXMgdGhlIHktdGlsZSBudW1iZXIgYmFzZWQgb24gd2hldGhlciBYWVogb3IgVE1TIChkZWZhdWx0KSBzeXN0ZW0gaXMgdXNlZAogICAgICAgIDpwYXJhbSB0eTogVGhlIHktdGlsZSBudW1iZXIKICAgICAgICA6cmV0dXJuOiBUaGUgdHJhbnNmb3JtZWQgdGlsZSBudW1iZXIKICAgICAgICAiIiIKICAgICAgICBpZiBvcHRpb25zLnh5ejoKICAgICAgICAgICAgcmV0dXJuICgyKip0eiAtIDEpIC0gdHkgICMgQ29udmVydCBmcm9tIFRNUyB0byBYWVogbnVtYmVyaW5nIHN5c3RlbQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiB0eQoKCmRlZiB3b3JrZXJfdGlsZV9kZXRhaWxzKGlucHV0X2ZpbGUsIG91dHB1dF9mb2xkZXIsIG9wdGlvbnMsIHNlbmRfcGlwZT1Ob25lKToKICAgIHRyeToKICAgICAgICBnZGFsMnRpbGVzID0gR0RBTDJUaWxlcyhpbnB1dF9maWxlLCBvdXRwdXRfZm9sZGVyLCBvcHRpb25zKQogICAgICAgIGdkYWwydGlsZXMub3Blbl9pbnB1dCgpCiAgICAgICAgZ2RhbDJ0aWxlcy5nZW5lcmF0ZV9tZXRhZGF0YSgpCiAgICAgICAgdGlsZV9qb2JfaW5mbywgdGlsZV9kZXRhaWxzID0gZ2RhbDJ0aWxlcy5nZW5lcmF0ZV9iYXNlX3RpbGVzKCkKICAgICAgICByZXR1cm5fZGF0YSA9ICh0aWxlX2pvYl9pbmZvLCB0aWxlX2RldGFpbHMpCiAgICAgICAgaWYgc2VuZF9waXBlOgogICAgICAgICAgICBzZW5kX3BpcGUuc2VuZChyZXR1cm5fZGF0YSkKCiAgICAgICAgcmV0dXJuIHJldHVybl9kYXRhCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoIndvcmtlcl90aWxlX2RldGFpbHMgZmFpbGVkICIsIHN0cihlKSkKCgpkZWYgcHJvZ3Jlc3NfcHJpbnRlcl90aHJlYWQocXVldWUsIG5iX2pvYnMpOgogICAgcGIgPSBQcm9ncmVzc0JhcihuYl9qb2JzKQogICAgcGIuc3RhcnQoKQogICAgZm9yIF8gaW4gcmFuZ2UobmJfam9icyk6CiAgICAgICAgcXVldWUuZ2V0KCkKICAgICAgICBwYi5sb2dfcHJvZ3Jlc3MoKQogICAgICAgIHF1ZXVlLnRhc2tfZG9uZSgpCgoKY2xhc3MgUHJvZ3Jlc3NCYXIob2JqZWN0KToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgdG90YWxfaXRlbXMpOgogICAgICAgIHNlbGYudG90YWxfaXRlbXMgPSB0b3RhbF9pdGVtcwogICAgICAgIHNlbGYubmJfaXRlbXNfZG9uZSA9IDAKICAgICAgICBzZWxmLmN1cnJlbnRfcHJvZ3Jlc3MgPSAwCiAgICAgICAgc2VsZi5TVEVQID0gMi41CgogICAgZGVmIHN0YXJ0KHNlbGYpOgogICAgICAgIHN5cy5zdGRvdXQud3JpdGUoIjAiKQoKICAgIGRlZiBsb2dfcHJvZ3Jlc3Moc2VsZiwgbmJfaXRlbXM9MSk6CiAgICAgICAgc2VsZi5uYl9pdGVtc19kb25lICs9IG5iX2l0ZW1zCiAgICAgICAgcHJvZ3Jlc3MgPSBmbG9hdChzZWxmLm5iX2l0ZW1zX2RvbmUpIC8gc2VsZi50b3RhbF9pdGVtcyAqIDEwMAogICAgICAgIGlmIHByb2dyZXNzID49IHNlbGYuY3VycmVudF9wcm9ncmVzcyArIHNlbGYuU1RFUDoKICAgICAgICAgICAgZG9uZSA9IEZhbHNlCiAgICAgICAgICAgIHdoaWxlIG5vdCBkb25lOgogICAgICAgICAgICAgICAgaWYgc2VsZi5jdXJyZW50X3Byb2dyZXNzICsgc2VsZi5TVEVQIDw9IHByb2dyZXNzOgogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm9ncmVzcyArPSBzZWxmLlNURVAKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLmN1cnJlbnRfcHJvZ3Jlc3MgJSAxMCA9PSAwOgogICAgICAgICAgICAgICAgICAgICAgICBzeXMuc3Rkb3V0LndyaXRlKHN0cihpbnQoc2VsZi5jdXJyZW50X3Byb2dyZXNzKSkpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuY3VycmVudF9wcm9ncmVzcyA9PSAxMDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzeXMuc3Rkb3V0LndyaXRlKCJcbiIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgc3lzLnN0ZG91dC53cml0ZSgiLiIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGRvbmUgPSBUcnVlCiAgICAgICAgc3lzLnN0ZG91dC5mbHVzaCgpCgoKZGVmIGdldF90aWxlX3N3bmUodGlsZV9qb2JfaW5mbywgb3B0aW9ucyk6CiAgICBpZiBvcHRpb25zLnByb2ZpbGUgPT0gJ21lcmNhdG9yJzoKICAgICAgICBtZXJjYXRvciA9IEdsb2JhbE1lcmNhdG9yKCkKICAgICAgICB0aWxlX3N3bmUgPSBtZXJjYXRvci5UaWxlTGF0TG9uQm91bmRzCiAgICBlbGlmIG9wdGlvbnMucHJvZmlsZSA9PSAnZ2VvZGV0aWMnOgogICAgICAgIGdlb2RldGljID0gR2xvYmFsR2VvZGV0aWMob3B0aW9ucy50bXNjb21wYXRpYmxlKQogICAgICAgIHRpbGVfc3duZSA9IGdlb2RldGljLlRpbGVMYXRMb25Cb3VuZHMKICAgIGVsaWYgb3B0aW9ucy5wcm9maWxlID09ICdyYXN0ZXInOgogICAgICAgIHNyczQzMjYgPSBvc3IuU3BhdGlhbFJlZmVyZW5jZSgpCiAgICAgICAgc3JzNDMyNi5JbXBvcnRGcm9tRVBTRyg0MzI2KQogICAgICAgIGlmIHRpbGVfam9iX2luZm8ua21sIGFuZCB0aWxlX2pvYl9pbmZvLmluX3Nyc193a3Q6CiAgICAgICAgICAgIGluX3NycyA9IG9zci5TcGF0aWFsUmVmZXJlbmNlKCkKICAgICAgICAgICAgaW5fc3JzLkltcG9ydEZyb21Xa3QodGlsZV9qb2JfaW5mby5pbl9zcnNfd2t0KQogICAgICAgICAgICBjdCA9IG9zci5Db29yZGluYXRlVHJhbnNmb3JtYXRpb24oaW5fc3JzLCBzcnM0MzI2KQoKICAgICAgICAgICAgZGVmIHJhc3RlcnRpbGVzd25lKHgsIHksIHopOgogICAgICAgICAgICAgICAgcGl4ZWxzaXpleCA9ICgyICoqICh0aWxlX2pvYl9pbmZvLnRtYXh6IC0geikgKiB0aWxlX2pvYl9pbmZvLm91dF9nZW9fdHJhbnNbMV0pCiAgICAgICAgICAgICAgICB3ZXN0ID0gdGlsZV9qb2JfaW5mby5vdXRfZ2VvX3RyYW5zWzBdICsgeCAqIHRpbGVfam9iX2luZm8udGlsZXNpemUgKiBwaXhlbHNpemV4CiAgICAgICAgICAgICAgICBlYXN0ID0gd2VzdCArIHRpbGVfam9iX2luZm8udGlsZXNpemUgKiBwaXhlbHNpemV4CiAgICAgICAgICAgICAgICBzb3V0aCA9IHRpbGVfam9iX2luZm8ub21pbnkgKyB5ICogdGlsZV9qb2JfaW5mby50aWxlc2l6ZSAqIHBpeGVsc2l6ZXgKICAgICAgICAgICAgICAgIG5vcnRoID0gc291dGggKyB0aWxlX2pvYl9pbmZvLnRpbGVzaXplICogcGl4ZWxzaXpleAogICAgICAgICAgICAgICAgaWYgbm90IHRpbGVfam9iX2luZm8uaXNfZXBzZ180MzI2OgogICAgICAgICAgICAgICAgICAgICMgVHJhbnNmb3JtYXRpb24gdG8gRVBTRzo0MzI2IChXR1M4NCBkYXR1bSkKICAgICAgICAgICAgICAgICAgICB3ZXN0LCBzb3V0aCA9IGN0LlRyYW5zZm9ybVBvaW50KHdlc3QsIHNvdXRoKVs6Ml0KICAgICAgICAgICAgICAgICAgICBlYXN0LCBub3J0aCA9IGN0LlRyYW5zZm9ybVBvaW50KGVhc3QsIG5vcnRoKVs6Ml0KICAgICAgICAgICAgICAgIHJldHVybiBzb3V0aCwgd2VzdCwgbm9ydGgsIGVhc3QKCiAgICAgICAgICAgIHRpbGVfc3duZSA9IHJhc3RlcnRpbGVzd25lCiAgICAgICAgZWxzZToKICAgICAgICAgICAgdGlsZV9zd25lID0gbGFtYmRhIHgsIHksIHo6ICgwLCAwLCAwLCAwKSAgICMgbm9xYQogICAgZWxzZToKICAgICAgICB0aWxlX3N3bmUgPSBsYW1iZGEgeCwgeSwgejogKDAsIDAsIDAsIDApICAgIyBub3FhCgogICAgcmV0dXJuIHRpbGVfc3duZQoKCmRlZiBzaW5nbGVfdGhyZWFkZWRfdGlsaW5nKGlucHV0X2ZpbGUsIG91dHB1dF9mb2xkZXIsIG9wdGlvbnMpOgogICAgIiIiCiAgICBLZWVwIGEgc2luZ2xlIHRocmVhZGVkIHZlcnNpb24gdGhhdCBzdGF5cyBjbGVhciBvZiBtdWx0aXByb2Nlc3NpbmcsIGZvciBwbGF0Zm9ybXMgdGhhdCB3b3VsZCBub3QKICAgIHN1cHBvcnQgaXQKICAgICIiIgogICAgaWYgb3B0aW9ucy52ZXJib3NlOgogICAgICAgIHByaW50KCJCZWdpbiB0aWxlcyBkZXRhaWxzIGNhbGMiKQogICAgY29uZiwgdGlsZV9kZXRhaWxzID0gd29ya2VyX3RpbGVfZGV0YWlscyhpbnB1dF9maWxlLCBvdXRwdXRfZm9sZGVyLCBvcHRpb25zKQoKICAgIGlmIG9wdGlvbnMudmVyYm9zZToKICAgICAgICBwcmludCgiVGlsZXMgZGV0YWlscyBjYWxjIGNvbXBsZXRlLiIpCgogICAgaWYgbm90IG9wdGlvbnMudmVyYm9zZSBhbmQgbm90IG9wdGlvbnMucXVpZXQ6CiAgICAgICAgcHJvZ3Jlc3NfYmFyID0gUHJvZ3Jlc3NCYXIobGVuKHRpbGVfZGV0YWlscykpCiAgICAgICAgcHJvZ3Jlc3NfYmFyLnN0YXJ0KCkKCiAgICBmb3IgdGlsZV9kZXRhaWwgaW4gdGlsZV9kZXRhaWxzOgogICAgICAgIGNyZWF0ZV9iYXNlX3RpbGUoY29uZiwgdGlsZV9kZXRhaWwsIG9wdGlvbnMpCgogICAgICAgIGlmIG5vdCBvcHRpb25zLnZlcmJvc2UgYW5kIG5vdCBvcHRpb25zLnF1aWV0OgogICAgICAgICAgICBwcm9ncmVzc19iYXIubG9nX3Byb2dyZXNzKCkKCiAgICBjcmVhdGVfb3ZlcnZpZXdfdGlsZXMoY29uZiwgb3V0cHV0X2ZvbGRlciwgb3B0aW9ucykKCiAgICBzaHV0aWwucm10cmVlKG9zLnBhdGguZGlybmFtZShjb25mLnNyY19maWxlKSkKCgpkZWYgbXVsdGlfdGhyZWFkZWRfdGlsaW5nKGlucHV0X2ZpbGUsIG91dHB1dF9mb2xkZXIsIG9wdGlvbnMpOgogICAgbmJfcHJvY2Vzc2VzID0gb3B0aW9ucy5uYl9wcm9jZXNzZXMgb3IgMQogICAgKGNvbmZfcmVjZWl2ZXIsIGNvbmZfc2VuZGVyKSA9IFBpcGUoRmFsc2UpCgogICAgaWYgb3B0aW9ucy52ZXJib3NlOgogICAgICAgIHByaW50KCJCZWdpbiB0aWxlcyBkZXRhaWxzIGNhbGMiKQogICAgcCA9IFByb2Nlc3ModGFyZ2V0PXdvcmtlcl90aWxlX2RldGFpbHMsCiAgICAgICAgICAgICAgICBhcmdzPVtpbnB1dF9maWxlLCBvdXRwdXRfZm9sZGVyLCBvcHRpb25zXSwKICAgICAgICAgICAgICAgIGt3YXJncz17InNlbmRfcGlwZSI6IGNvbmZfc2VuZGVyfSkKICAgIHAuc3RhcnQoKQogICAgIyBNYWtlIHN1cmUgdG8gY29uc3VtZSB0aGUgcXVldWUgYmVmb3JlIGpvaW5pbmcuIElmIHRoZSBwYXlsb2FkIGlzIHRvbyBiaWcsIGl0IHdvbid0IGJlIHB1dCBpbgogICAgIyBvbmUgZ28gaW4gdGhlIHF1ZXVlIGFuZCB0aGVyZWZvcmUgdGhlIHNlbmRpbmcgcHJvY2VzcyB3aWxsIG5ldmVyIGZpbmlzaCwgd2FpdGluZyBmb3Igc3BhY2UgaW4KICAgICMgdGhlIHF1ZXVlIHRvIHNlbmQgZGF0YQogICAgY29uZiwgdGlsZV9kZXRhaWxzID0gY29uZl9yZWNlaXZlci5yZWN2KCkKICAgIHAuam9pbigpCiAgICBpZiBvcHRpb25zLnZlcmJvc2U6CiAgICAgICAgcHJpbnQoIlRpbGVzIGRldGFpbHMgY2FsYyBjb21wbGV0ZS4iKQogICAgIyBIYXZlIHRvIGNyZWF0ZSB0aGUgUXVldWUgdGhyb3VnaCBhIG11bHRpcHJvY2Vzc2luZy5NYW5hZ2VyIHRvIGdldCBhIFF1ZXVlIFByb3h5LAogICAgIyBvdGhlcndpc2UgeW91IGNhbid0IHBhc3MgaXQgYXMgYSBwYXJhbSBpbiB0aGUgbWV0aG9kIGludm9rZWQgYnkgdGhlIHBvb2wuLi4KICAgIG1hbmFnZXIgPSBNYW5hZ2VyKCkKICAgIHF1ZXVlID0gbWFuYWdlci5RdWV1ZSgpCiAgICBwb29sID0gUG9vbChwcm9jZXNzZXM9bmJfcHJvY2Vzc2VzKQogICAgIyBUT0RPOiBnYmF0YWlsbGUgLSBjaGVjayB0aGUgY29uZnMgZm9yIHdoaWNoIGVhY2ggZWxlbWVudCBpcyBhbiBhcnJheS4uLiBvbmUgdXNlbGVzcyBsZXZlbD8KICAgICMgVE9ETzogZ2JhdGFpbGxlIC0gYXNzaWduIGFuIElEIHRvIGVhY2ggam9iIGZvciBwcmludCBpbiB2ZXJib3NlIG1vZGUgIlJlYWRSYXN0ZXIgRXh0ZW50IC4uLiIKICAgICMgVE9ETzogZ2JhdGFpbGxlIC0gY2hlY2sgbWVtb3J5IGZvb3RwcmludCBhbmQgdGltZSBvbiBiaWcgaW1hZ2UuIGFyZSB0aGV5IG9wZW5lZCB4IHRpbWVzCiAgICBmb3IgdGlsZV9kZXRhaWwgaW4gdGlsZV9kZXRhaWxzOgogICAgICAgIHBvb2wuYXBwbHlfYXN5bmMoY3JlYXRlX2Jhc2VfdGlsZSwgKGNvbmYsIHRpbGVfZGV0YWlsLCBvcHRpb25zKSwgeyJxdWV1ZSI6IHF1ZXVlfSkKCiAgICBpZiBub3Qgb3B0aW9ucy52ZXJib3NlIGFuZCBub3Qgb3B0aW9ucy5xdWlldDoKICAgICAgICBwID0gUHJvY2Vzcyh0YXJnZXQ9cHJvZ3Jlc3NfcHJpbnRlcl90aHJlYWQsIGFyZ3M9W3F1ZXVlLCBsZW4odGlsZV9kZXRhaWxzKV0pCiAgICAgICAgcC5zdGFydCgpCgogICAgcG9vbC5jbG9zZSgpCiAgICBwb29sLmpvaW4oKSAgICAgIyBKb2JzIGZpbmlzaGVkCiAgICBpZiBub3Qgb3B0aW9ucy52ZXJib3NlIGFuZCBub3Qgb3B0aW9ucy5xdWlldDoKICAgICAgICBwLmpvaW4oKSAgICAgICAgIyBUcmFjZXMgZG9uZQoKICAgIGNyZWF0ZV9vdmVydmlld190aWxlcyhjb25mLCBvdXRwdXRfZm9sZGVyLCBvcHRpb25zKQoKICAgIHNodXRpbC5ybXRyZWUob3MucGF0aC5kaXJuYW1lKGNvbmYuc3JjX2ZpbGUpKQoKCiMgZGVmIG1haW4oKToKIyAgICAgIyBUT0RPOiBnYmF0YWlsbGUgLSB1c2UgbWtkdGVtcCB0byB3b3JrIGluIGEgdGVtcCBkaXJlY3RvcnkKIyAgICAgIyBUT0RPOiBnYmF0YWlsbGUgLSBkZWJ1ZyBpbnRlcm1lZGlhdGUgdGlsZXMudnJ0IG5vdCBwcm9kdWNlZCBhbnltb3JlPwojICAgICAjIFRPRE86IGdiYXRhaWxsZSAtIFJlZmFjdG9yIGdlbmVyYXRlIG92ZXJ2aWV3IHRpbGVzIHRvIG5vdCBkZXBlbmQgb24gc2VsZiB2YXJpYWJsZXMKIyAgICAgYXJndiA9IGdkYWwuR2VuZXJhbENtZExpbmVQcm9jZXNzb3Ioc3lzLmFyZ3YpCiMgICAgIGlucHV0X2ZpbGUsIG91dHB1dF9mb2xkZXIsIG9wdGlvbnMgPSBwcm9jZXNzX2FyZ3MoYXJndlsxOl0pCiMgICAgIG5iX3Byb2Nlc3NlcyA9IG9wdGlvbnMubmJfcHJvY2Vzc2VzIG9yIDEKIwojICAgICBpZiBuYl9wcm9jZXNzZXMgPT0gMToKIyAgICAgICAgIHNpbmdsZV90aHJlYWRlZF90aWxpbmcoaW5wdXRfZmlsZSwgb3V0cHV0X2ZvbGRlciwgb3B0aW9ucykKIyAgICAgZWxzZToKIyAgICAgICAgIG11bHRpX3RocmVhZGVkX3RpbGluZyhpbnB1dF9maWxlLCBvdXRwdXRfZm9sZGVyLCBvcHRpb25zKQojCiMgaWYgX19uYW1lX18gPT0gJ19fbWFpbl9fJzoKIyAgICAgIyBzdGFydF90aW1lID0gdGltZS50aW1lKCkKIyAgICAgbWFpbigpCiMgICAgICMgcHJpbnQoIi0tLSAlcyBzZWNvbmRzIC0tLSIgJSAodGltZS50aW1lKCkgLSBzdGFydF90aW1lKSkKCiNnZGFsX3RyYW5zbGF0ZSAtb2YgdnJ0IC1leHBhbmQgcmdiYSBGOlxEYW5pbG9cVHJhbXBvXGRhdGFfZGlyXGRhdGFccmVtYW5lc2NlbnRlc19mbG9yZXN0YWlzX2Rlc21hdGFtZW50b1xicmFzaWxccHJvZGVzXHByb2Rlcy50aWYgcHJvZGVzLnZydAojIGlucHV0X2ZpbGUgPSAiRjpcXERhbmlsb1xcVHJhbXBvXFxkYXRhX2RpclxcZGF0YVxccmVtYW5lc2NlbnRlc19mbG9yZXN0YWlzX2Rlc21hdGFtZW50b1xcYnJhc2lsXFxwcm9kZXNcXHByb2Rlcy52cnQiICMiRjpcXERhbmlsb1xcVHJhbXBvXFxkYXRhX2RpclxcZGF0YVxccmVtYW5lc2NlbnRlc19mbG9yZXN0YWlzX2Rlc21hdGFtZW50b1xcYnJhc2lsXFxwZXJkYV9jb2JlcnR1cmFfdmVnZXRhbF9hbm9faGFuc2VuXFxsb3NzeWVhci50aWYiCiMgb3V0cHV0X2ZvbGRlciA9ICJGOlxcRGFuaWxvXFxUZW1wXFxyZXN1bHRcXHByb2Rlc19wdWJsaXNoXFwiCiNnZW5lcmF0ZVRpbGVGb3JNYXAoaW5wdXRfZmlsZSwgb3V0cHV0X2ZvbGRlcikKCmNsYXNzIE9wdGlvbnM6CiAgICBwcm9maWxlID0gIm1lcmNhdG9yIgogICAgcmVzYW1wbGluZyA9ICduZWFyJwogICAgc19zcnMgPSBOb25lCiAgICB6b29tPSAnMC0yJwogICAgcmVzdW1lID0gRmFsc2UKICAgIHNyY25vZGF0YSA9ICcnCiAgICB0bXNjb21wYXRpYmxlID0gRmFsc2UKICAgIHh5eiA9IFRydWUKICAgIHZlcmJvc2UgPSBGYWxzZQogICAgcXVpZXQgPSBUcnVlCiAgICBuYl9wcm9jZXNzZXMgPSAxCiAgICBrbWwgPSBGYWxzZQogICAgdXJsID0gJycKICAgIHdlYnZpZXdlciA9J25vbmUnCiAgICB0aXRsZSA9ICcnCiAgICBjb3B5cmlnaHQgPSAnJwogICAgZ29vZ2xla2V5ID0gJycKICAgIGJpbmdrZXkgPSAnJwogICAgbGVnZW5kT2JqID0gTm9uZQogICAgZ2VuZXJhdGVkRmlsZXMgPSBbXQoKZGVmIGdlbmVyYXRlVGlsZUZvck1hcChpbnB1dF9maWxlLCBvdXRwdXRfZm9sZGVyLCBtYXhab29tLCByZXN1bWUsIGxlZ2VuZE9iaik6CiAgICBvcHRpb25zID0gT3B0aW9ucygpCiAgICBvcHRpb25zLnZlcmJvc2UgPSBGYWxzZQogICAgb3B0aW9ucy5yZXNhbXBsaW5nID0gJ25lYXInCiAgICBvcHRpb25zLnpvb20gPSAnMC0nICsgc3RyKG1heFpvb20pCiAgICBvcHRpb25zLnJlc3VtZSA9IHJlc3VtZQogICAgb3B0aW9ucy5sZWdlbmRPYmogPSBsZWdlbmRPYmoKICAgIHNpbmdsZV90aHJlYWRlZF90aWxpbmcoaW5wdXRfZmlsZSwgb3V0cHV0X2ZvbGRlciwgb3B0aW9ucykKICAgIGZvciBmaWxlbmFtZSBpbiBvcHRpb25zLmdlbmVyYXRlZEZpbGVzOgogICAgICAgIGFwcGx5TGVnZW5kKGZpbGVuYW1lLCBvcHRpb25zLmxlZ2VuZE9iaikKICAgICNtdWx0aV90aHJlYWRlZF90aWxpbmcoaW5wdXRfZmlsZSwgb3V0cHV0X2ZvbGRlciwgb3B0aW9ucykKCgp0cnk6CiAgICBmcm9tIFdNU0NhcGFiaWxpdGllcyBpbXBvcnQgV01TQ2FwYWJpbGl0aWVzCiAgICBmcm9tIFdNU0NhcGFiaWxpdGllcyBpbXBvcnQgV01TQkJveApleGNlcHQ6CiAgICBwYXNzICNOb3QgaW4gRGluYW1pY2EgQ29kZQoKIyEvdXNyL2Jpbi9lbnYgcHl0aG9uCiMgLSotIGNvZGluZzogdXRmLTggLSotCgoKaXNEaW5hbWljYSA9IEZhbHNlCnRyeToKICAgIGRpbmFtaWNhLnBhY2thZ2UoIm9zIikKICAgIGlzRGluYW1pY2EgPSBUcnVlCmV4Y2VwdDoKICAgIGlzRGluYW1pY2EgPSBGYWxzZQoKaWYgbm90IGlzRGluYW1pY2E6CiAgICB0cnk6CiAgICAgICAgZnJvbSAuVVRJTFMgaW1wb3J0IFVUSUxTCiAgICAgICAgZnJvbSAuIGltcG9ydCB4bWx0b2RpY3QKICAgIGV4Y2VwdDoKICAgICAgICBwYXNzICNOb3QgaW4gUUdJUwoKICAgIHRyeToKICAgICAgICBmcm9tIFVUSUxTIGltcG9ydCBVVElMUwogICAgICAgIGZyb20geG1sdG9kaWN0IGltcG9ydCB4bWx0b2RpY3QKICAgIGV4Y2VwdDoKICAgICAgICBwYXNzICNOb3QgaW4gRGluYW1pY2EgQ29kZQoKZnJvbSBjb2xsZWN0aW9ucyBpbXBvcnQgT3JkZXJlZERpY3QKaW1wb3J0IGNvbGxlY3Rpb25zCmZyb20gcGF0aGxpYiBpbXBvcnQgUGF0aAppbXBvcnQganNvbgppbXBvcnQgb3MKaW1wb3J0IGlvCmltcG9ydCBjc3YKaW1wb3J0IHJlCgojIHRyeToKIyAgICAgZnJvbSBxZ2lzLmNvcmUgaW1wb3J0IChRZ3NDb29yZGluYXRlUmVmZXJlbmNlU3lzdGVtLCBRZ3NQcm9qZWN0LCBRZ3NQb2ludFhZLCBRZ3NDb29yZGluYXRlVHJhbnNmb3JtLCBRZ3NWZWN0b3JMYXllcikKIyBleGNlcHQ6CiMgICAgIHBhc3MKCmNsYXNzIFdNU0NhcGFiaWxpdGllczoKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0RGVmYXVsdENhcGFiaWxpdGllcygpOgogICAgICAgIHJldHVybiAnJyc8P3htbCB2ZXJzaW9uPSIxLjAiIGVuY29kaW5nPSJVVEYtOCI/PjwhRE9DVFlQRSBXTVRfTVNfQ2FwYWJpbGl0aWVzIFNZU1RFTSAiaHR0cDovL21hcHMuY3NyLnVmbWcuYnI6ODAvZ2Vvc2VydmVyL3NjaGVtYXMvd21zLzEuMS4xL1dNU19NU19DYXBhYmlsaXRpZXMuZHRkIlsKICAgIDwhRUxFTUVOVCBWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyAoVGlsZVNldCopID4KICAgIDwhRUxFTUVOVCBUaWxlU2V0IChTUlMsIEJvdW5kaW5nQm94PywgUmVzb2x1dGlvbnMsIFdpZHRoLCBIZWlnaHQsIEZvcm1hdCwgTGF5ZXJzKiwgU3R5bGVzKikgPgogICAgPCFFTEVNRU5UIFJlc29sdXRpb25zICgjUENEQVRBKSA+CiAgICA8IUVMRU1FTlQgV2lkdGggKCNQQ0RBVEEpID4KICAgIDwhRUxFTUVOVCBIZWlnaHQgKCNQQ0RBVEEpID4KICAgIDwhRUxFTUVOVCBMYXllcnMgKCNQQ0RBVEEpID4KICAgIDwhRUxFTUVOVCBTdHlsZXMgKCNQQ0RBVEEpID4KICAgIF0+CiAgICA8V01UX01TX0NhcGFiaWxpdGllcyB2ZXJzaW9uPSIxLjEuMSIgdXBkYXRlU2VxdWVuY2U9IjYzMjU4Ij4KICAgICAgPFNlcnZpY2U+CiAgICAgICAgPE5hbWU+T0dDOldNUzwvTmFtZT4KICAgICAgICA8VGl0bGU+Q1NSIFdlYiBNYXAgU2VydmljZTwvVGl0bGU+CiAgICAgICAgPEFic3RyYWN0PkNvbXBsaWFudCBXTVMgUmVzcG9uc2U8L0Fic3RyYWN0PgogICAgICAgIDxLZXl3b3JkTGlzdD4KICAgICAgICAgIDxLZXl3b3JkPldGUzwvS2V5d29yZD4KICAgICAgICAgIDxLZXl3b3JkPldNUzwvS2V5d29yZD4KICAgICAgICAgIDxLZXl3b3JkPkdFT1NFUlZFUjwvS2V5d29yZD4KICAgICAgICA8L0tleXdvcmRMaXN0PgogICAgICAgIDxPbmxpbmVSZXNvdXJjZSB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeGxpbms6dHlwZT0ic2ltcGxlIiB4bGluazpocmVmPSJodHRwOi8vZ2Vvc2VydmVyLnNvdXJjZWZvcmdlLm5ldC9odG1sL2luZGV4LnBocCIvPgogICAgICAgIDxDb250YWN0SW5mb3JtYXRpb24+CiAgICAgICAgICA8Q29udGFjdFBlcnNvblByaW1hcnk+CiAgICAgICAgICAgIDxDb250YWN0UGVyc29uPkdJVEhVQiBvd25lcjwvQ29udGFjdFBlcnNvbj4KICAgICAgICAgICAgPENvbnRhY3RPcmdhbml6YXRpb24+R0lUSFVCIG93bmVyPC9Db250YWN0T3JnYW5pemF0aW9uPgogICAgICAgICAgPC9Db250YWN0UGVyc29uUHJpbWFyeT4KICAgICAgICAgIDxDb250YWN0UG9zaXRpb24+Q2hpZWYgZ2VvZ3JhcGhlcjwvQ29udGFjdFBvc2l0aW9uPgogICAgICAgICAgPENvbnRhY3RBZGRyZXNzPgogICAgICAgICAgICA8QWRkcmVzc1R5cGU+V29yazwvQWRkcmVzc1R5cGU+CiAgICAgICAgICAgIDxBZGRyZXNzLz4KICAgICAgICAgICAgPENpdHk+QWxleGFuZHJpYTwvQ2l0eT4KICAgICAgICAgICAgPFN0YXRlT3JQcm92aW5jZS8+CiAgICAgICAgICAgIDxQb3N0Q29kZS8+CiAgICAgICAgICAgIDxDb3VudHJ5PkVneXB0PC9Db3VudHJ5PgogICAgICAgICAgPC9Db250YWN0QWRkcmVzcz4KICAgICAgICAgIDxDb250YWN0Vm9pY2VUZWxlcGhvbmUvPgogICAgICAgICAgPENvbnRhY3RGYWNzaW1pbGVUZWxlcGhvbmUvPgogICAgICAgICAgPENvbnRhY3RFbGVjdHJvbmljTWFpbEFkZHJlc3M+Y2xhdWRpdXMucHRvbG9tYWV1c0BnbWFpbC5jb208L0NvbnRhY3RFbGVjdHJvbmljTWFpbEFkZHJlc3M+CiAgICAgICAgPC9Db250YWN0SW5mb3JtYXRpb24+CiAgICAgICAgPEZlZXM+Tk9ORTwvRmVlcz4KICAgICAgICA8QWNjZXNzQ29uc3RyYWludHM+Tk9ORTwvQWNjZXNzQ29uc3RyYWludHM+CiAgICAgIDwvU2VydmljZT4KICAgICAgPENhcGFiaWxpdHk+CiAgICAgICAgPFJlcXVlc3Q+CiAgICAgICAgICA8R2V0Q2FwYWJpbGl0aWVzPgogICAgICAgICAgICA8Rm9ybWF0PmFwcGxpY2F0aW9uL3ZuZC5vZ2Mud21zX3htbDwvRm9ybWF0PgogICAgICAgICAgICA8RENQVHlwZT4KICAgICAgICAgICAgICA8SFRUUD4KICAgICAgICAgICAgICAgIDxHZXQ+CiAgICAgICAgICAgICAgICAgIDxPbmxpbmVSZXNvdXJjZSB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeGxpbms6dHlwZT0ic2ltcGxlIiB4bGluazpocmVmPSJodHRwOi8vbWFwcy5jc3IudWZtZy5icjo4MC9nZW9zZXJ2ZXIvd21zP1NFUlZJQ0U9V01TJmFtcDsiLz4KICAgICAgICAgICAgICAgIDwvR2V0PgogICAgICAgICAgICAgICAgPFBvc3Q+CiAgICAgICAgICAgICAgICAgIDxPbmxpbmVSZXNvdXJjZSB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeGxpbms6dHlwZT0ic2ltcGxlIiB4bGluazpocmVmPSJodHRwOi8vbWFwcy5jc3IudWZtZy5icjo4MC9nZW9zZXJ2ZXIvd21zP1NFUlZJQ0U9V01TJmFtcDsiLz4KICAgICAgICAgICAgICAgIDwvUG9zdD4KICAgICAgICAgICAgICA8L0hUVFA+CiAgICAgICAgICAgIDwvRENQVHlwZT4KICAgICAgICAgIDwvR2V0Q2FwYWJpbGl0aWVzPgogICAgICAgICAgPEdldE1hcD4KICAgICAgICAgICAgPEZvcm1hdD5pbWFnZS9wbmc8L0Zvcm1hdD4KICAgICAgICAgICAgPERDUFR5cGU+CiAgICAgICAgICAgICAgPEhUVFA+CiAgICAgICAgICAgICAgICA8R2V0PgogICAgICAgICAgICAgICAgICA8T25saW5lUmVzb3VyY2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOnR5cGU9InNpbXBsZSIgeGxpbms6aHJlZj0iaHR0cDovL21hcHMuY3NyLnVmbWcuYnI6ODAvZ2Vvc2VydmVyL3dtcz9TRVJWSUNFPVdNUyZhbXA7Ii8+CiAgICAgICAgICAgICAgICA8L0dldD4KICAgICAgICAgICAgICA8L0hUVFA+CiAgICAgICAgICAgIDwvRENQVHlwZT4KICAgICAgICAgIDwvR2V0TWFwPgogICAgICAgICAgPEdldEZlYXR1cmVJbmZvPgogICAgICAgICAgICA8Rm9ybWF0PnRleHQvcGxhaW48L0Zvcm1hdD4KICAgICAgICAgICAgPEZvcm1hdD5hcHBsaWNhdGlvbi92bmQub2djLmdtbDwvRm9ybWF0PgogICAgICAgICAgICA8Rm9ybWF0PmFwcGxpY2F0aW9uL3ZuZC5vZ2MuZ21sLzMuMS4xPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxGb3JtYXQ+dGV4dC9odG1sPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxGb3JtYXQ+YXBwbGljYXRpb24vanNvbjwvRm9ybWF0PgogICAgICAgICAgICA8RENQVHlwZT4KICAgICAgICAgICAgICA8SFRUUD4KICAgICAgICAgICAgICAgIDxHZXQ+CiAgICAgICAgICAgICAgICAgIDxPbmxpbmVSZXNvdXJjZSB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeGxpbms6dHlwZT0ic2ltcGxlIiB4bGluazpocmVmPSJodHRwOi8vbWFwcy5jc3IudWZtZy5icjo4MC9nZW9zZXJ2ZXIvd21zP1NFUlZJQ0U9V01TJmFtcDsiLz4KICAgICAgICAgICAgICAgIDwvR2V0PgogICAgICAgICAgICAgICAgPFBvc3Q+CiAgICAgICAgICAgICAgICAgIDxPbmxpbmVSZXNvdXJjZSB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeGxpbms6dHlwZT0ic2ltcGxlIiB4bGluazpocmVmPSJodHRwOi8vbWFwcy5jc3IudWZtZy5icjo4MC9nZW9zZXJ2ZXIvd21zP1NFUlZJQ0U9V01TJmFtcDsiLz4KICAgICAgICAgICAgICAgIDwvUG9zdD4KICAgICAgICAgICAgICA8L0hUVFA+CiAgICAgICAgICAgIDwvRENQVHlwZT4KICAgICAgICAgIDwvR2V0RmVhdHVyZUluZm8+CiAgICAgICAgICA8RGVzY3JpYmVMYXllcj4KICAgICAgICAgICAgPEZvcm1hdD5hcHBsaWNhdGlvbi92bmQub2djLndtc194bWw8L0Zvcm1hdD4KICAgICAgICAgICAgPERDUFR5cGU+CiAgICAgICAgICAgICAgPEhUVFA+CiAgICAgICAgICAgICAgICA8R2V0PgogICAgICAgICAgICAgICAgICA8T25saW5lUmVzb3VyY2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOnR5cGU9InNpbXBsZSIgeGxpbms6aHJlZj0iaHR0cDovL21hcHMuY3NyLnVmbWcuYnI6ODAvZ2Vvc2VydmVyL3dtcz9TRVJWSUNFPVdNUyZhbXA7Ii8+CiAgICAgICAgICAgICAgICA8L0dldD4KICAgICAgICAgICAgICA8L0hUVFA+CiAgICAgICAgICAgIDwvRENQVHlwZT4KICAgICAgICAgIDwvRGVzY3JpYmVMYXllcj4KICAgICAgICAgIDxHZXRMZWdlbmRHcmFwaGljPgogICAgICAgICAgICA8Rm9ybWF0PmltYWdlL3BuZzwvRm9ybWF0PgogICAgICAgICAgICA8RENQVHlwZT4KICAgICAgICAgICAgICA8SFRUUD4KICAgICAgICAgICAgICAgIDxHZXQ+CiAgICAgICAgICAgICAgICAgIDxPbmxpbmVSZXNvdXJjZSB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeGxpbms6dHlwZT0ic2ltcGxlIiB4bGluazpocmVmPSJodHRwOi8vbWFwcy5jc3IudWZtZy5icjo4MC9nZW9zZXJ2ZXIvd21zP1NFUlZJQ0U9V01TJmFtcDsiLz4KICAgICAgICAgICAgICAgIDwvR2V0PgogICAgICAgICAgICAgIDwvSFRUUD4KICAgICAgICAgICAgPC9EQ1BUeXBlPgogICAgICAgICAgPC9HZXRMZWdlbmRHcmFwaGljPgogICAgICAgICAgPEdldFN0eWxlcz4KICAgICAgICAgICAgPEZvcm1hdD5hcHBsaWNhdGlvbi92bmQub2djLnNsZCt4bWw8L0Zvcm1hdD4KICAgICAgICAgICAgPERDUFR5cGU+CiAgICAgICAgICAgICAgPEhUVFA+CiAgICAgICAgICAgICAgICA8R2V0PgogICAgICAgICAgICAgICAgICA8T25saW5lUmVzb3VyY2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOnR5cGU9InNpbXBsZSIgeGxpbms6aHJlZj0iaHR0cDovL21hcHMuY3NyLnVmbWcuYnI6ODAvZ2Vvc2VydmVyL3dtcz9TRVJWSUNFPVdNUyZhbXA7Ii8+CiAgICAgICAgICAgICAgICA8L0dldD4KICAgICAgICAgICAgICA8L0hUVFA+CiAgICAgICAgICAgIDwvRENQVHlwZT4KICAgICAgICAgIDwvR2V0U3R5bGVzPgogICAgICAgIDwvUmVxdWVzdD4KICAgICAgICA8RXhjZXB0aW9uPgogICAgICAgICAgPEZvcm1hdD5hcHBsaWNhdGlvbi92bmQub2djLnNlX3htbDwvRm9ybWF0PgogICAgICAgICAgPEZvcm1hdD5hcHBsaWNhdGlvbi92bmQub2djLnNlX2luaW1hZ2U8L0Zvcm1hdD4KICAgICAgICA8L0V4Y2VwdGlvbj4KICAgICAgICA8VmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXM+CiAgICAgICAgICA8bm90ZW1wdHk+PC9ub3RlbXB0eT4KICAgICAgICA8L1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzPgogICAgICAgIDxVc2VyRGVmaW5lZFN5bWJvbGl6YXRpb24gU3VwcG9ydFNMRD0iMSIgVXNlckxheWVyPSIxIiBVc2VyU3R5bGU9IjEiIFJlbW90ZVdGUz0iMSIvPgogICAgICAgIDxMYXllciBxdWVyeWFibGU9IjAiIG9wYXF1ZT0iMCIgbm9TdWJzZXRzPSIwIj4KICAgICAgICAgIDxUaXRsZT5NYXBTZXJ2ZXIgdmlhIEdJdEh1YjwvVGl0bGU+CiAgICAgICAgICA8QWJzdHJhY3Q+R2l0SHViIFdNUzwvQWJzdHJhY3Q+CiAgICAgICAgICA8IS0tQWxsIHN1cHBvcnRlZCBFUFNHIHByb2plY3Rpb25zOi0tPgogICAgICAgICAgPFNSUz5FUFNHOjM4NTc8L1NSUz4KICAgICAgICAgIDxTUlM+RVBTRzo0MzI2PC9TUlM+CiAgICAgICAgICA8U1JTPkVQU0c6OTAwOTEzPC9TUlM+CiAgICAgICAgICA8U1JTPkVQU0c6NDIzMDM8L1NSUz4KICAgICAgICAgIDxMYXRMb25Cb3VuZGluZ0JveCBtaW54PSItMTgwLjAwMDA0MDc0MTk5OTk4IiBtaW55PSItOTAuMCIgbWF4eD0iMTgwLjAwMDAwMDAwMDAwMDEiIG1heHk9IjkwLjAiLz4KICAgICAgICA8L0xheWVyPgogICAgICA8L0NhcGFiaWxpdHk+CiAgICA8L1dNVF9NU19DYXBhYmlsaXRpZXM+JycnCgogICAgIyBAc3RhdGljbWV0aG9kCiAgICAjIGRlZiBjb252ZXJ0Q29vcmRpbmF0ZVByb2ooY3JzUHJvaiwgZnJvbVgsIGZyb21ZLCBvdXRwdXRQcm9qZWN0ZWQpOgogICAgIwogICAgIyAgICAgcmVnZXggPSByIl5bIF0qUFJPSkNTIgogICAgIyAgICAgaXNQcm9qZWN0ZWQgPSByZS5tYXRjaChyZWdleCwgY3JzUHJvaikKICAgICMKICAgICMgICAgIGlmIChpc1Byb2plY3RlZCBhbmQgb3V0cHV0UHJvamVjdGVkKSBvciAoIG5vdCBpc1Byb2plY3RlZCBhbmQgIG5vdCBvdXRwdXRQcm9qZWN0ZWQpOgogICAgIyAgICAgICAgIHJldHVybiAoZnJvbVgsIGZyb21ZKQogICAgIyAgICAgZWxzZToKICAgICMgICAgICAgICBmUHJvaiA9IFFnc0Nvb3JkaW5hdGVSZWZlcmVuY2VTeXN0ZW0oKQogICAgIyAgICAgICAgIGZQcm9qLmNyZWF0ZUZyb21Xa3QoY3JzUHJvaikKICAgICMgICAgICAgICB0UHJvaiA9IFFnc0Nvb3JkaW5hdGVSZWZlcmVuY2VTeXN0ZW0oKQogICAgIyAgICAgICAgIHRQcm9qLmNyZWF0ZUZyb21Qcm9qNCgiK3Byb2o9bWVyYyArYT02Mzc4MTM3ICtiPTYzNzgxMzcgK2xhdF90cz0wLjAgK2xvbl8wPTAuMCAreF8wPTAuMCAreV8wPTAgK2s9MS4wICt1bml0cz1tICtuYWRncmlkcz1AbnVsbCArd2t0ZXh0ICArbm9fZGVmcyIgaWYgb3V0cHV0UHJvamVjdGVkIGVsc2UgIitwcm9qPWxvbmdsYXQgK2RhdHVtPVdHUzg0ICtub19kZWZzICIpCiAgICAjICAgICAgICAgbmV3Q29vcmQgPSBRZ3NDb29yZGluYXRlVHJhbnNmb3JtKGZQcm9qLCB0UHJvaiwgUWdzUHJvamVjdC5pbnN0YW5jZSgpKS50cmFuc2Zvcm0oUWdzUG9pbnRYWShmcm9tWCwgZnJvbVkpLCBUcnVlKQogICAgIyAgICAgcmV0dXJuIChuZXdDb29yZC54LCBuZXdDb29yZC55KQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRNYXBLZXl3b3JkKGlzU2hhcGVmaWxlLCBtYXhab29tLCBkbExpbms9Tm9uZSk6CiAgICAgICAgaWYgZGxMaW5rIGlzIE5vbmUgb3IgbGVuKGRsTGluaykgPT0gMDoKICAgICAgICAgICAgZGxMaW5rID0gJ2Rpc2FibGVkb3dubG9hZCcKICAgICAgICBlbGlmICc6JyBpbiBkbExpbms6CiAgICAgICAgICAgIGRsTGluayA9IGRsTGlua1soZGxMaW5rLmluZGV4KCc6JykgKyAxKTpdCiAgICAgICAgZWxpZiAny7gnIGluIGRsTGluazoKICAgICAgICAgICAgZGxMaW5rID0gZGxMaW5rWyhkbExpbmsuaW5kZXgoJ8u4JykgKyAxKTpdCiAgICAgICAgcmV0dXJuICJncm91cMu4IiArICgnc2hwJyBpZiBpc1NoYXBlZmlsZSBlbHNlICd0aWYnKSArICLLuMu4y7giICsgZGxMaW5rICsgIsu4bm90TGlzdGluZ8u4y7htYXhab29ty7giICsgc3RyKG1heFpvb20pCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldE1hcERlc2NyaXB0aW9uKGxheWVyTmFtZUlELCBsYXllckF0dHIsIGxhdE1pblgsIGxhdE1pblksIGxhdE1heFgsIGxhdE1heFksIHByb2pNaW5YLCBwcm9qTWluWSwgcHJvak1heFgsIHByb2pNYXhZLCBtYXhab29tLCBpc1NoYXBlZmlsZSwgZExpbmspOgogICAgICAgIGxheWVyQXR0ciA9IFVUSUxTLm5vcm1hbGl6ZU5hbWUobGF5ZXJBdHRyKQogICAgICAgIGxheWVyTmFtZUlEID0gVVRJTFMubm9ybWFsaXplTmFtZShsYXllck5hbWVJRCkKICAgICAgICAjIEludmVydGkgbyBtaW54L21pbnkgZSBtYXhYL21heFkgZG8gZXBzZyA0MzI2IHBxIGVzdGF2YSB0cm9jYW5kbyBubyBnZW9zZXJ2ZXIsIG1hcyBuIHNlaSBwcSBpc3NvIGFjb250ZWNlLgogICAgICAgIHJldHVybiAiIiI8Q09OVEVOVD4KICAgICAgICAgIDxMYXllciBxdWVyeWFibGU9IjEiIG9wYXF1ZT0iMCI+CiAgICAgICAgICA8TmFtZT5HSDoiIiIgKyBsYXllck5hbWVJRCArICIiIjwvTmFtZT4KICAgICAgICAgIDxUaXRsZT4iIiIgKyBsYXllck5hbWVJRCArICIiIjwvVGl0bGU+CiAgICAgICAgICA8QWJzdHJhY3Q+R0g6IiIiICsgbGF5ZXJOYW1lSUQgKyAiIiIgQUJTVFJBQ1Q8L0Fic3RyYWN0PgogICAgICAgICAgPEtleXdvcmRMaXN0PgogICAgICAgICAgICA8S2V5d29yZD4iIiIgKyBXTVNDYXBhYmlsaXRpZXMuZ2V0TWFwS2V5d29yZChpc1NoYXBlZmlsZSwgbWF4Wm9vbSwgZExpbmspICsgIiIiPC9LZXl3b3JkPgogICAgICAgICAgPC9LZXl3b3JkTGlzdD4KICAgICAgICAgIDxTUlM+RVBTRzo0MzI2PC9TUlM+CiAgICAgICAgICA8TGF0TG9uQm91bmRpbmdCb3ggbWlueD1cIiIiIiArIHN0cihsYXRNaW5YKSArICIiIlwiIG1pbnk9XCIiIiIgKyBzdHIobGF0TWluWSkgKyAiIiJcIiBtYXh4PVwiIiIiICsgc3RyKAogICAgICAgICAgICBsYXRNYXhYKSArICIiIlwiIG1heHk9XCIiIiIgKyBzdHIobGF0TWF4WSkgKyAiIiJcIi8+CiAgICAgICAgICA8Qm91bmRpbmdCb3ggU1JTPSJFUFNHOjQzMjYiIG1pbng9XCIiIiIgKyBzdHIocHJvak1pblgpICsgIiIiXCIgbWlueT1cIiIiIiArIHN0cigKICAgICAgICAgICAgcHJvak1pblkpICsgIiIiXCIgbWF4eD1cIiIiIiArIHN0cihwcm9qTWF4WCkgKyAiIiJcIiBtYXh5PVwiIiIiICsgc3RyKHByb2pNYXhZKSArICIiIlwiLz4KICAgICAgICAgIDxTdHlsZT4KICAgICAgICAgICA8TmFtZT4iIiIgKyBsYXllckF0dHIgKyAiIiI8L05hbWU+CiAgICAgICAgICAgPFRpdGxlPiIiIiArIGxheWVyQXR0ciArICIiIjwvVGl0bGU+CiAgICAgICAgICAgPEFic3RyYWN0Lz4KICAgICAgICAgICA8TGVnZW5kVVJMIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+CiAgICAgICAgICAgPEZvcm1hdD5pbWFnZS9wbmc8L0Zvcm1hdD4KICAgICAgICAgICA8T25saW5lUmVzb3VyY2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOnR5cGU9InNpbXBsZSIgeGxpbms6aHJlZj0iaHR0cHM6Ly9tYXBzLmNzci51Zm1nLmJyOjQ0My9nZW9zZXJ2ZXIvd21zP3JlcXVlc3Q9R2V0TGVnZW5kR3JhcGhpYyZhbXA7Zm9ybWF0PWltYWdlJTJGcG5nJmFtcDt3aWR0aD0yMCZhbXA7aGVpZ2h0PTIwJmFtcDtsYXllcj0iIiIgKyBsYXllck5hbWVJRCArICIiIlwiLz4KICAgICAgICAgICA8L0xlZ2VuZFVSTD4KICAgICAgICAgIDwvU3R5bGU+CiAgICAgICAgPC9MYXllcj4KICAgICAgICA8L0NPTlRFTlQ+CiAgICAgICAgIiIiCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldFRpbGVTZXREZXNjcmlwdGlvbihmaWxlTmFtZUlkLCBsYXRNaW5YLCBsYXRNaW5ZLCBsYXRNYXhYLCBsYXRNYXhZLCBwcm9qTWluWCwgcHJvak1pblksIHByb2pNYXhYLCBwcm9qTWF4WSk6CiAgICAgICAgIyA8Qm91bmRpbmdCb3ggU1JTPSJFUFNHOjQzMjYiIG1pbng9XCIiIiIgKyBzdHIobGF0TWluWCkgKyAiIiJcIiBtaW55PVwiIiIiICsgc3RyKGxhdE1pblkpICsgIiIiXCIgbWF4eD1cIiIiIiArIHN0cihsYXRNYXhYKSArICIiIlwiIG1heHk9XCIiIiIgKyBzdHIobGF0TWF4WSkgKyAiIiJcIi8+CiAgICAgICAgcmV0dXJuICIiIjw/eG1sIHZlcnNpb249XCIxLjBcIiBlbmNvZGluZz1cIlVURi04XCI/PgogICAgICAgIDxDT05URU5UPgogICAgICAgICAgPFRpbGVTZXQ+CiAgICAgICAgICAgIDxTUlM+RVBTRzo0MzI2PC9TUlM+CiAgICAgICAgICAgIDxCb3VuZGluZ0JveCBTUlM9IkVQU0c6NDMyNiIgbWlueD0iLTE4MC4wIiBtaW55PSItOTAuMCIgbWF4eD0iMC4wIiBtYXh5PSI5MC4wIi8+CiAgICAgICAgPFJlc29sdXRpb25zPjAuNzAzMTI1IDAuMzUxNTYyNSAwLjE3NTc4MTI1IDAuMDg3ODkwNjI1IDAuMDQzOTQ1MzEyNSAwLjAyMTk3MjY1NjI1IDAuMDEwOTg2MzI4MTI1IDAuMDA1NDkzMTY0MDYyNSAwLjAwMjc0NjU4MjAzMTI1IDAuMDAxMzczMjkxMDE1NjI1IDYuODY2NDU1MDc4MTI1RS00IDMuNDMzMjI3NTM5MDYyNUUtNCAxLjcxNjYxMzc2OTUzMTI1RS00IDguNTgzMDY4ODQ3NjU2MjVFLTUgNC4yOTE1MzQ0MjM4MjgxMjVFLTUgMi4xNDU3NjcyMTE5MTQwNjI1RS01IDEuMDcyODgzNjA1OTU3MDMxMkUtNSA1LjM2NDQxODAyOTc4NTE1NkUtNiAyLjY4MjIwOTAxNDg5MjU3OEUtNiAxLjM0MTEwNDUwNzQ0NjI4OUUtNiA2LjcwNTUyMjUzNzIzMTQ0NUUtNyAzLjM1Mjc2MTI2ODYxNTcyMjdFLTcgPC9SZXNvbHV0aW9ucz4KICAgICAgICAgICAgPFdpZHRoPjI1NjwvV2lkdGg+CiAgICAgICAgICAgIDxIZWlnaHQ+MjU2PC9IZWlnaHQ+CiAgICAgICAgICAgIDxGb3JtYXQ+aW1hZ2UvcG5nPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxMYXllcnM+R0g6IiIiICsgZmlsZU5hbWVJZCArICIiIjwvTGF5ZXJzPgogICAgICAgICAgICA8U3R5bGVzLz4KICAgICAgICAgIDwvVGlsZVNldD4KICAgICAgICAgIDxUaWxlU2V0PgogICAgICAgICAgICA8U1JTPkVQU0c6OTAwOTEzPC9TUlM+CiAgICAgICAgICAgIDxCb3VuZGluZ0JveCBTUlM9IkVQU0c6OTAwOTEzIiBtaW54PSItMi4wMDM3NTA4MzRFNyIgbWlueT0iLTIuMDAzNzUwODM0RTciIG1heHg9IjIuMDAzNzUwODM0RTciIG1heHk9IjIuMDAzNzUwODM0RTciLz4KICAgICAgICA8UmVzb2x1dGlvbnM+MTU2NTQzLjAzMzkwNjI1IDc4MjcxLjUxNjk1MzEyNSAzOTEzNS43NTg0NzY1NjI1IDE5NTY3Ljg3OTIzODI4MTI1IDk3ODMuOTM5NjE5MTQwNjI1IDQ4OTEuOTY5ODA5NTcwMzEyNSAyNDQ1Ljk4NDkwNDc4NTE1NjIgMTIyMi45OTI0NTIzOTI1NzgxIDYxMS40OTYyMjYxOTYyODkxIDMwNS43NDgxMTMwOTgxNDQ1MyAxNTIuODc0MDU2NTQ5MDcyMjYgNzYuNDM3MDI4Mjc0NTM2MTMgMzguMjE4NTE0MTM3MjY4MDY2IDE5LjEwOTI1NzA2ODYzNDAzMyA5LjU1NDYyODUzNDMxNzAxNyA0Ljc3NzMxNDI2NzE1ODUwOCAyLjM4ODY1NzEzMzU3OTI1NCAxLjE5NDMyODU2Njc4OTYyNyAwLjU5NzE2NDI4MzM5NDgxMzUgMC4yOTg1ODIxNDE2OTc0MDY3NyAwLjE0OTI5MTA3MDg0ODcwMzM4IDAuMDc0NjQ1NTM1NDI0MzUxNjkgMC4wMzczMjI3Njc3MTIxNzU4NDYgMC4wMTg2NjEzODM4NTYwODc5MjMgMC4wMDkzMzA2OTE5MjgwNDM5NjEgMC4wMDQ2NjUzNDU5NjQwMjE5ODEgMC4wMDIzMzI2NzI5ODIwMTA5OTA0IDAuMDAxMTY2MzM2NDkxMDA1NDk1MiA1LjgzMTY4MjQ1NTAyNzQ3NkUtNCAyLjkxNTg0MTIyNzUxMzczOEUtNCAxLjQ1NzkyMDYxMzc1Njg2OUUtNCA8L1Jlc29sdXRpb25zPgogICAgICAgICAgICA8V2lkdGg+MjU2PC9XaWR0aD4KICAgICAgICAgICAgPEhlaWdodD4yNTY8L0hlaWdodD4KICAgICAgICAgICAgPEZvcm1hdD5pbWFnZS9wbmc8L0Zvcm1hdD4KICAgICAgICAgICAgPExheWVycz5HSDoiIiIgKyBmaWxlTmFtZUlkICsgIiIiPC9MYXllcnM+CiAgICAgICAgICAgIDxTdHlsZXMvPgogICAgICAgICAgPC9UaWxlU2V0PgogICAgICAgICAgPC9DT05URU5UPgogICAgICAgICIiIgogICAgICAgICMgPEJvdW5kaW5nQm94IFNSUz0iRVBTRzo5MDA5MTMiIG1pbng9XCIiIiIgKyBzdHIocHJvak1pblgpICsgIiIiXCIgbWlueT1cIiIiIiArIHN0cihwcm9qTWluWSkgKyAiIiJcIiBtYXh4PVwiIiIiICsgc3RyKHByb2pNYXhYKSArICIiIlwiIG1heHk9XCIiIiIgKyBzdHIocHJvak1heFkpICsgIiIiXCIvPgoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRBbGxMYXllcnMoY29udGVudCwgbGF5ZXJBdHRyPScxJyk6CiAgICAgICAgI0ZJWE1FIHNob3VsZCB1c2UgdGhlIHN0eWxlIG5hbWUgdG8gaWRlbnRpZnkgdGhlIGxheWVyIGF0dHJpYnV0ZXMKICAgICAgICBkb2MgPSB4bWx0b2RpY3QucGFyc2UoY29udGVudCkKICAgICAgICBhbGxMYXllcnMgPSBbXQogICAgICAgIHRyeToKICAgICAgICAgICAgbGF5ZXJEZWZpbml0aW9ucyA9IGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10KICAgICAgICAgICAgaWYgbGF5ZXJEZWZpbml0aW9ucyBpcyBub3QgTm9uZSBhbmQgaXNpbnN0YW5jZShsYXllckRlZmluaXRpb25zLCBsaXN0KSBhbmQgbGVuKGxheWVyRGVmaW5pdGlvbnMpOgogICAgICAgICAgICAgICAgYWxsTGF5ZXJzID0gW2N1ckxheWVyWyJOYW1lIl0gZm9yIGN1ckxheWVyIGluIGxheWVyRGVmaW5pdGlvbnNdCiAgICAgICAgICAgIGVsaWYgbGF5ZXJEZWZpbml0aW9ucyBpcyBub3QgTm9uZSBhbmQgaXNpbnN0YW5jZShkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddLCBjb2xsZWN0aW9ucy5PcmRlcmVkRGljdCkgYW5kIGxlbihsYXllckRlZmluaXRpb25zKToKICAgICAgICAgICAgICAgIGFsbExheWVycyA9IFtsYXllckRlZmluaXRpb25zWyJOYW1lIl1dCiAgICAgICAgZXhjZXB0IEtleUVycm9yIGFzIGU6CiAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4gYWxsTGF5ZXJzCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldE9wZXJhdGlvbnNMaXN0Rm9yQ3VzdG9tTGF5ZXIoZG9jTGF5ZXIpOgogICAgICAgICNGSVhNRSBOw6NvIGRldmVyaWEgbW9kaWZpY2FyIG8gaW5wdXQgbnVtYSBmdW5jYW8gZGUgZ2V0CiAgICAgICAgI0ZJWE1FIGNvZGlnbyBkdXBsaWNhZG8KICAgICAgICBpZiBub3QgIk9wZXJhdGlvbiIgaW4gZG9jTGF5ZXI6CiAgICAgICAgICAgIGRvY0xheWVyWyJPcGVyYXRpb24iXSA9IFtdCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKGRvY0xheWVyWyJPcGVyYXRpb24iXSwgY29sbGVjdGlvbnMuT3JkZXJlZERpY3QpOgogICAgICAgICAgICBkb2NMYXllclsiT3BlcmF0aW9uIl0gPSBbZG9jTGF5ZXJbIk9wZXJhdGlvbiJdXQoKICAgICAgICBpZiBsZW4oZG9jTGF5ZXJbIk9wZXJhdGlvbiJdKSA9PSAwOgogICAgICAgICAgICByZXR1cm4gW10KICAgICAgICBlbGlmIGlzaW5zdGFuY2UoZG9jTGF5ZXJbIk9wZXJhdGlvbiJdLCBzdHIpOgogICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oanNvbi5kdW1wcyhkb2NMYXllcikpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIFt7J3R5cGUnOiBvcGVyYXRpb25bIkB0eXBlIl0sICdhdHRyaWJ1dGUnOiBvcGVyYXRpb25bIiN0ZXh0Il19IGZvciBvcGVyYXRpb24gaW4gZG9jTGF5ZXJbJ09wZXJhdGlvbiddXQoKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0QWxsQ3VzdG9tTGF5ZXJzKGNvbnRlbnQsIGxheWVyQXR0cj0nMScpOgogICAgICAgIGRvYyA9IHhtbHRvZGljdC5wYXJzZShjb250ZW50KQogICAgICAgIGFsbEN1c3RvbUxheWVycyA9IFtdCiAgICAgICAgaWYgJ0N1c3RvbUxheWVyJyAgaW4gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXToKICAgICAgICAgICAgbGF5ZXJEZWZpbml0aW9ucyA9IGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bJ0N1c3RvbUxheWVyJ10KCiAgICAgICAgICAgIGlmIGxheWVyRGVmaW5pdGlvbnMgaXMgbm90IE5vbmUgYW5kIGlzaW5zdGFuY2UobGF5ZXJEZWZpbml0aW9ucywgY29sbGVjdGlvbnMuT3JkZXJlZERpY3QpOgogICAgICAgICAgICAgICAgbGF5ZXJEZWZpbml0aW9ucyA9IFtsYXllckRlZmluaXRpb25zXQogICAgICAgICAgICBpZiBsYXllckRlZmluaXRpb25zIGlzIG5vdCBOb25lIGFuZCBpc2luc3RhbmNlKGxheWVyRGVmaW5pdGlvbnMsIGxpc3QpIGFuZCBsZW4obGF5ZXJEZWZpbml0aW9ucykgPiAwOgogICAgICAgICAgICAgICAgZm9yIGN1ckxheWVyIGluIGxheWVyRGVmaW5pdGlvbnM6CiAgICAgICAgICAgICAgICAgICAgZm9yIG9wZXJhdGlvbiBpbiBXTVNDYXBhYmlsaXRpZXMuZ2V0T3BlcmF0aW9uc0xpc3RGb3JDdXN0b21MYXllcihjdXJMYXllcik6CiAgICAgICAgICAgICAgICAgICAgICAgIGFsbEN1c3RvbUxheWVycy5hcHBlbmQoY3VyTGF5ZXJbIk5hbWUiXSArICI7IiArIG9wZXJhdGlvblsnYXR0cmlidXRlJ10pCiAgICAgICAgICAgICAgICAgICAgICAgICNhbGxDdXN0b21MYXllcnMuYXBwZW5kKGN1ckxheWVyWyJOYW1lIl0gKyAiOiIgKyBvcGVyYXRpb25bJ2F0dHJpYnV0ZSddICsgIjoiICsgb3BlcmF0aW9uWyd0eXBlJ10pCiAgICAgICAgcmV0dXJuIGFsbEN1c3RvbUxheWVycwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRDdXJyZW50Q2FwYWJpbGl0aWVzRG9jKGRpcmVjdG9yeSk6CiAgICAgICAgY2FwYWJpbGl0aWVzUGF0aCA9IG9zLnBhdGguam9pbihkaXJlY3RvcnksICJnZXRDYXBhYmlsaXRpZXMueG1sIikKICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShjYXBhYmlsaXRpZXNQYXRoKToKICAgICAgICAgICAgd2l0aCBpby5vcGVuKGNhcGFiaWxpdGllc1BhdGgsIG1vZGU9InIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBjYXBhYmlsaXRpZXNGaWxlOgogICAgICAgICAgICAgICAgY2FwYWJpbGl0aWVzQ29udGVudCA9IGNhcGFiaWxpdGllc0ZpbGUucmVhZCgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgY2FwYWJpbGl0aWVzQ29udGVudCA9IFdNU0NhcGFiaWxpdGllcy5nZXREZWZhdWx0Q2FwYWJpbGl0aWVzKCkKICAgICAgICBkb2MgPSB4bWx0b2RpY3QucGFyc2UoY2FwYWJpbGl0aWVzQ29udGVudCkKICAgICAgICByZXR1cm4gZG9jCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHNhdmVDdXJyZW50Q2FwYWJpbGl0aWVzKGRpcmVjdG9yeSwgZG9jKToKICAgICAgICBjYXBhYmlsaXRpZXNQYXRoID0gb3MucGF0aC5qb2luKGRpcmVjdG9yeSwgImdldENhcGFiaWxpdGllcy54bWwiKQogICAgICAgIHdpdGggaW8ub3BlbihjYXBhYmlsaXRpZXNQYXRoLCBtb2RlPSJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgY2FwYWJpbGl0aWVzRmlsZToKICAgICAgICAgICAgY2FwYWJpbGl0aWVzRmlsZS53cml0ZSh4bWx0b2RpY3QudW5wYXJzZShkb2MsIHByZXR0eT1UcnVlKSkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0Q3VzdG9tTGF5ZXJEZWZhdWx0RGVmaW5pdGlvbihsYXllck5hbWUpOgogICAgICAgIGxheWVyTmFtZSA9IFVUSUxTLm5vcm1hbGl6ZU5hbWUobGF5ZXJOYW1lKQogICAgICAgIHJldHVybiB4bWx0b2RpY3QucGFyc2UoIiIiPD94bWwgdmVyc2lvbj1cIjEuMFwiIGVuY29kaW5nPVwiVVRGLThcIj8+CiAgICAgICAgICAgIDxDT05URU5UPgogICAgICAgICAgICAgICAgPE5hbWU+R0g6IiIiICsgbGF5ZXJOYW1lICsgIiIiPC9OYW1lPgogICAgICAgICAgICAgICAgPFRpdGxlPiIiIitsYXllck5hbWUgKyIiIjwvVGl0bGU+CiAgICAgICAgICAgIDwvQ09OVEVOVD4iIiIpWyJDT05URU5UIl0KCiAgICAjY3VzdG9tRG9jIMOpIHVtIERpY3QgdmluZG8gZG8geG1sdG9kaWN0LiBsYXllckF0dHIgZSBvcGVyYXRpb24gc8OjbyBzdHJpbmdzCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgYWRkT3BlcmF0aW9uKGN1c3RvbURvYywgbGF5ZXJBdHRyLCBvcGVyYXRpb24pOgogICAgICAgIGxheWVyQXR0ciA9IFVUSUxTLm5vcm1hbGl6ZU5hbWUobGF5ZXJBdHRyKQogICAgICAgIGlmIG5vdCAiT3BlcmF0aW9uIiBpbiBjdXN0b21Eb2M6CiAgICAgICAgICAgIGN1c3RvbURvY1siT3BlcmF0aW9uIl0gPSBsaXN0KCkKICAgICAgICBpZiBpc2luc3RhbmNlKGN1c3RvbURvY1siT3BlcmF0aW9uIl0sIGNvbGxlY3Rpb25zLk9yZGVyZWREaWN0KToKICAgICAgICAgICAgY3VzdG9tRG9jWyJPcGVyYXRpb24iXSA9IFtjdXN0b21Eb2NbIk9wZXJhdGlvbiJdXQoKICAgICAgICBmb3VuZCA9IEZhbHNlCiAgICAgICAgZm9yIGN1ck9wZXJhdGlvbkRpY3QgaW4gY3VzdG9tRG9jWyJPcGVyYXRpb24iXToKICAgICAgICAgICAgaWYgbm90IGZvdW5kIGFuZCAnQHR5cGUnIGluIGN1ck9wZXJhdGlvbkRpY3QgYW5kIGN1ck9wZXJhdGlvbkRpY3RbJ0B0eXBlJ10gPT0gb3BlcmF0aW9uIGFuZCBjdXJPcGVyYXRpb25EaWN0WycjdGV4dCddID09IGxheWVyQXR0cjoKICAgICAgICAgICAgICAgIGZvdW5kID0gVHJ1ZQogICAgICAgIGlmIG5vdCBmb3VuZDoKICAgICAgICAgICAgY3VzdG9tRG9jWydPcGVyYXRpb24nXS5hcHBlbmQoeG1sdG9kaWN0LnBhcnNlKCIiIjw/eG1sIHZlcnNpb249XCIxLjBcIiBlbmNvZGluZz1cIlVURi04XCI/PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPENPTlRFTlQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8T3BlcmF0aW9uIHR5cGU9XCIiIiIgKyBvcGVyYXRpb24gKyAiIiJcIj4iIiIgKyBsYXllckF0dHIgKyAiIiI8L09wZXJhdGlvbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvQ09OVEVOVD4iIiIpWyJDT05URU5UIl1bIk9wZXJhdGlvbiJdKQogICAgICAgIHJldHVybiBjdXN0b21Eb2MKCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHVwZGF0ZUN1c3RvbVhNTChkaXJlY3RvcnksIGxheWVyVGl0bGUsIGxheWVyQXR0ciwgb3BlcmF0aW9uKToKICAgICAgICBkb2MgPSBXTVNDYXBhYmlsaXRpZXMuZ2V0Q3VycmVudENhcGFiaWxpdGllc0RvYyhkaXJlY3RvcnkpCiAgICAgICAgZmlsZW5hbWUgPSBVVElMUy5ub3JtYWxpemVOYW1lKGxheWVyVGl0bGUpICAjIGxheWVyIE5hbWUgbm8gcWdpcwoKICAgICAgICBpZiAnQ3VzdG9tTGF5ZXInIGluIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ106CiAgICAgICAgICAgIGlmIHR5cGUoZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsiQ3VzdG9tTGF5ZXIiXSkgaXMgY29sbGVjdGlvbnMuT3JkZXJlZERpY3Q6CiAgICAgICAgICAgICAgICBjdXJMYXllciA9IGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bIkN1c3RvbUxheWVyIl0KICAgICAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bIkN1c3RvbUxheWVyIl0gPSBbY3VyTGF5ZXJdCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsnQ3VzdG9tTGF5ZXInXSA9IFtdCgogICAgICAgIGN1ckxheWVyRGVmaW5pdGlvbiA9IE5vbmUKICAgICAgICBpZiAnQ3VzdG9tTGF5ZXInIGluIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ106CiAgICAgICAgICAgIGZvciBpTGF5ZXIgaW4gcmFuZ2UobGVuKGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bIkN1c3RvbUxheWVyIl0pIC0gMSwgLTEsIC0xKToKICAgICAgICAgICAgICAgIGN1ckxheWVyID0gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsiQ3VzdG9tTGF5ZXIiXVtpTGF5ZXJdCiAgICAgICAgICAgICAgICBpZiAiTmFtZSIgaW4gY3VyTGF5ZXIgYW5kIGZpbGVuYW1lIGluIGN1ckxheWVyWyJOYW1lIl06CiAgICAgICAgICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsiQ3VzdG9tTGF5ZXIiXS5wb3AoaUxheWVyKQogICAgICAgICAgICAgICAgICAgIGN1ckxheWVyRGVmaW5pdGlvbiA9IGN1ckxheWVyCiAgICAgICAgICAgICAgICAgICAgI1RPRE8gdmVyaWZpY2FyIHNlIG7Do28gcmVzdGFyYW0gb3V0cm9zIGNvbSBtZXNtbyBub21lLgogICAgICAgIGlmIGN1ckxheWVyRGVmaW5pdGlvbiBpcyBOb25lOgogICAgICAgICAgICBjdXJMYXllckRlZmluaXRpb24gPSBXTVNDYXBhYmlsaXRpZXMuZ2V0Q3VzdG9tTGF5ZXJEZWZhdWx0RGVmaW5pdGlvbihmaWxlbmFtZSkKICAgICAgICBXTVNDYXBhYmlsaXRpZXMuYWRkT3BlcmF0aW9uKGN1ckxheWVyRGVmaW5pdGlvbiwgbGF5ZXJBdHRyLCBvcGVyYXRpb24pCiAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsiQ3VzdG9tTGF5ZXIiXS5hcHBlbmQoY3VyTGF5ZXJEZWZpbml0aW9uKQogICAgICAgIFdNU0NhcGFiaWxpdGllcy5zYXZlQ3VycmVudENhcGFiaWxpdGllcyhkaXJlY3RvcnksIGRvYykKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgc2V0Q2FwYWJpbGl0aWVzRGVmYXVsdE1heFpvb20oZGlyZWN0b3J5KToKICAgICAgICBkb2MgPSBXTVNDYXBhYmlsaXRpZXMuZ2V0Q3VycmVudENhcGFiaWxpdGllc0RvYyhkaXJlY3RvcnkpCgogICAgICAgIGlmICdMYXllcicgaW4gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXToKICAgICAgICAgICAgaWYgdHlwZShkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddKSBpcyBjb2xsZWN0aW9ucy5PcmRlcmVkRGljdDoKICAgICAgICAgICAgICAgIGN1ckxheWVyID0gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXQogICAgICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXSA9IFtjdXJMYXllcl0KCiAgICAgICAgaWYgJ0xheWVyJyBpbiBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddOgogICAgICAgICAgICBmb3IgaUxheWVyIGluIHJhbmdlKGxlbihkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddKSAtIDEsIC0xLCAtMSk6CiAgICAgICAgICAgICAgICBjdXJMYXllciA9IGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ11baUxheWVyXQogICAgICAgICAgICAgICAgaWYgIktleXdvcmRMaXN0IiBpbiBjdXJMYXllciBhbmQgdHlwZShjdXJMYXllclsnS2V5d29yZExpc3QnXSkgaXMgY29sbGVjdGlvbnMuT3JkZXJlZERpY3QgYW5kICgiS2V5d29yZCIgaW4gY3VyTGF5ZXJbJ0tleXdvcmRMaXN0J10pIGFuZCBjdXJMYXllclsnS2V5d29yZExpc3QnXVsnS2V5d29yZCddID09ICdHSVRIVUInOgogICAgICAgICAgICAgICAgICAgIGN1ckxheWVyWydLZXl3b3JkTGlzdCddWydLZXl3b3JkJ10gPSBXTVNDYXBhYmlsaXRpZXMuZ2V0TWFwS2V5d29yZChGYWxzZSwgOCkKICAgICAgICBXTVNDYXBhYmlsaXRpZXMuc2F2ZUN1cnJlbnRDYXBhYmlsaXRpZXMoZGlyZWN0b3J5LCBkb2MpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHVwZGF0ZVhNTChkaXJlY3RvcnksIGxheWVyRXh0ZW50cywgbGF5ZXJNZXJjYXRvckV4dGVudHMsIGlzU2hhcGVmaWxlLCBsYXllclRpdGxlLCBsYXllckF0dHIsIG1heFpvb20sIGRvd25sb2FkTGluayk6CiAgICAgICAgZG9jID0gV01TQ2FwYWJpbGl0aWVzLmdldEN1cnJlbnRDYXBhYmlsaXRpZXNEb2MoZGlyZWN0b3J5KQoKICAgICAgICBmaWxlbmFtZSA9IFVUSUxTLm5vcm1hbGl6ZU5hbWUobGF5ZXJUaXRsZSkgI2xheWVyIE5hbWUgbm8gcWdpcwoKICAgICAgICBhc3NlcnQgaXNpbnN0YW5jZShsYXllckV4dGVudHMsIFdNU0JCb3gpIGFuZCBpc2luc3RhbmNlKGxheWVyTWVyY2F0b3JFeHRlbnRzLCBXTVNCQm94KQoKICAgICAgICAjICNleHRlbnRzLCBwcm9qZWN0aW9uCiAgICAgICAgIyBwcm9qTWF4WCA9IGxheWVyLmV4dGVudCgpLnhNYXhpbXVtKCkKICAgICAgICBwcm9qTWF4WCA9IGxheWVyRXh0ZW50cy54TWF4aW11bSgpCiAgICAgICAgIyBwcm9qTWluWCA9IGxheWVyLmV4dGVudCgpLnhNaW5pbXVtKCkKICAgICAgICBwcm9qTWluWCA9IGxheWVyRXh0ZW50cy54TWluaW11bSgpCiAgICAgICAgIyBwcm9qTWF4WSA9IGxheWVyLmV4dGVudCgpLnlNYXhpbXVtKCkKICAgICAgICBwcm9qTWF4WSA9IGxheWVyRXh0ZW50cy55TWF4aW11bSgpCiAgICAgICAgIyBwcm9qTWluWSA9IGxheWVyLmV4dGVudCgpLnlNaW5pbXVtKCkKICAgICAgICBwcm9qTWluWSA9IGxheWVyRXh0ZW50cy55TWluaW11bSgpCiAgICAgICAgIyBsbEV4dGVudCA9IFVUSUxTLmdldE1hcEV4dGVudChsYXllciwgUWdzQ29vcmRpbmF0ZVJlZmVyZW5jZVN5c3RlbSgnRVBTRzo0MzI2JykpCiAgICAgICAgIyBsYXRNYXhYID0gbGxFeHRlbnQueE1heGltdW0oKQogICAgICAgIGxhdE1heFggPSBsYXllck1lcmNhdG9yRXh0ZW50cy54TWF4aW11bSgpCiAgICAgICAgIyBsYXRNaW5YID0gbGxFeHRlbnQueE1pbmltdW0oKQogICAgICAgIGxhdE1pblggPSBsYXllck1lcmNhdG9yRXh0ZW50cy54TWluaW11bSgpCiAgICAgICAgIyBsYXRNYXhZID0gbGxFeHRlbnQueU1heGltdW0oKQogICAgICAgIGxhdE1heFkgPSBsYXllck1lcmNhdG9yRXh0ZW50cy55TWF4aW11bSgpCiAgICAgICAgIyBsYXRNaW5ZID0gbGxFeHRlbnQueU1pbmltdW0oKQogICAgICAgIGxhdE1pblkgPSBsYXllck1lcmNhdG9yRXh0ZW50cy55TWluaW11bSgpCiAgICAgICAgI2lzU2hhcGVmaWxlID0gKGlzaW5zdGFuY2UobGF5ZXIsIFFnc1ZlY3RvckxheWVyKSkKCgogICAgICAgIGlmICdMYXllcicgaW4gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXToKICAgICAgICAgICAgaWYgdHlwZShkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddKSBpcyBjb2xsZWN0aW9ucy5PcmRlcmVkRGljdDoKICAgICAgICAgICAgICAgIGN1ckxheWVyID0gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXQogICAgICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXSA9IFtjdXJMYXllcl0KCiAgICAgICAgaWYgJ0xheWVyJyBpbiBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddOgogICAgICAgICAgICBmb3IgaUxheWVyIGluIHJhbmdlKGxlbihkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddKSAtIDEsIC0xLCAtMSk6CiAgICAgICAgICAgICAgICBjdXJMYXllciA9IGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ11baUxheWVyXQogICAgICAgICAgICAgICAgaWYgIk5hbWUiIGluIGN1ckxheWVyIGFuZCBjdXJMYXllclsiTmFtZSJdID09ICJHSDoiICsgZmlsZW5hbWU6CiAgICAgICAgICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXS5wb3AoaUxheWVyKQoKICAgICAgICAjRklYTUUgT25lIGF0dHJpYnV0ZSBvbmx5LiAoSXMgYWx3YXlzIG92ZXJ3cml0aW5nKQogICAgICAgIG5ld0xheWVyRGVzY3JpcHRpb24gPSB4bWx0b2RpY3QucGFyc2UoCiAgICAgICAgICAgIFdNU0NhcGFiaWxpdGllcy5nZXRNYXBEZXNjcmlwdGlvbihmaWxlbmFtZSwgbGF5ZXJBdHRyLCBsYXRNaW5YLCBsYXRNaW5ZLCBsYXRNYXhYLCBsYXRNYXhZLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvak1pblgsIHByb2pNaW5ZLCBwcm9qTWF4WCwgcHJvak1heFksIG1heFpvb20sIGlzU2hhcGVmaWxlLCBkb3dubG9hZExpbmspKVsnQ09OVEVOVCddCiAgICAgICAgaWYgJ0xheWVyJyBpbiBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddOgogICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddLmFwcGVuZChuZXdMYXllckRlc2NyaXB0aW9uWydMYXllciddKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ10gPSBuZXdMYXllckRlc2NyaXB0aW9uCgogICAgICAgIG5ld1RpbGVTZXREZXNjcmlwdGlvbiA9IHhtbHRvZGljdC5wYXJzZSgKICAgICAgICAgICAgV01TQ2FwYWJpbGl0aWVzLmdldFRpbGVTZXREZXNjcmlwdGlvbihmaWxlbmFtZSwgbGF0TWluWCwgbGF0TWluWSwgbGF0TWF4WCwgbGF0TWF4WSwgcHJvak1pblgsIHByb2pNaW5ZLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2pNYXhYLCBwcm9qTWF4WSkpWydDT05URU5UJ10KCiAgICAgICAgaWYgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXSBpcyBub3QgTm9uZSBhbmQgJ1RpbGVTZXQnIGluIFwKICAgICAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ106CiAgICAgICAgICAgIGlmIHR5cGUoZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsKICAgICAgICAgICAgICAgICAgICAgICAgJ1RpbGVTZXQnXSkgaXMgY29sbGVjdGlvbnMuT3JkZXJlZERpY3Q6CiAgICAgICAgICAgICAgICBjdXJUaWxlU2V0ID0gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsnVGlsZVNldCddCiAgICAgICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWydUaWxlU2V0J10gPSBbCiAgICAgICAgICAgICAgICAgICAgY3VyVGlsZVNldF0gICMgVHJhbnNmb3JtcyBpbnRvIGEgbGlzdAoKICAgICAgICBpZiBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddIGlzIG5vdCBOb25lIGFuZCAnVGlsZVNldCcgaW4gXAogICAgICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXToKICAgICAgICAgICAgZm9yIGlUaWxlU2V0IGluIHJhbmdlKAogICAgICAgICAgICAgICAgICAgIGxlbihkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWydUaWxlU2V0J10pIC0gMSwKICAgICAgICAgICAgICAgICAgICAtMSwgLTEpOgogICAgICAgICAgICAgICAgY3VyVGlsZVNldCA9IGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bJ1RpbGVTZXQnXVtpVGlsZVNldF0KICAgICAgICAgICAgICAgIGlmICJMYXllcnMiIGluIGN1clRpbGVTZXQgYW5kIGN1clRpbGVTZXRbIkxheWVycyJdID09ICJHSDoiICsgZmlsZW5hbWU6CiAgICAgICAgICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsnVGlsZVNldCddLnBvcChpVGlsZVNldCkKICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsnVGlsZVNldCddICs9IG5ld1RpbGVTZXREZXNjcmlwdGlvblsKICAgICAgICAgICAgICAgICdUaWxlU2V0J10gICMgRG9pcyBlbGVtZW50b3MgYyBtZXNtYSBjaGF2ZSByZXByZXNlbnRhIGNvbSBsaXN0YQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ10gPSBuZXdUaWxlU2V0RGVzY3JpcHRpb24KICAgICAgICBXTVNDYXBhYmlsaXRpZXMuc2F2ZUN1cnJlbnRDYXBhYmlsaXRpZXMoZGlyZWN0b3J5LCBkb2MpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHdyaXRlX2Rlc2NyaXB0aW9uKGRpcmVjdG9yeSwgbGF5ZXJUaXRsZSwgbGF5ZXJBdHRyLCBjZWxsVHlwZU5hbWUsIG51bGxWYWx1ZSwgb3BlcmF0aW9uKToKICAgICAgICBsYXllclRpdGxlID0gVVRJTFMubm9ybWFsaXplTmFtZShsYXllclRpdGxlKQogICAgICAgIGNlbGxUeXBlTmFtZSA9IFVUSUxTLm5vcm1hbGl6ZU5hbWUoY2VsbFR5cGVOYW1lKQogICAgICAgIGZpbGVjc3YgPSAiZGVzY3JpcHRpb24uY3N2IgogICAgICAgIGNzdlBhdGggPSBvcy5wYXRoLmpvaW4oZGlyZWN0b3J5LCBmaWxlY3N2KQogICAgICAgIGpzb25QYXRoID0gb3MucGF0aC5qb2luKGRpcmVjdG9yeSwgImRlc2NyaXB0aW9uLmpzb24iKQogICAgICAgIGlmIG9zLnBhdGguaXNmaWxlKGNzdlBhdGgpOgogICAgICAgICAgICBjc3ZGaWxlID0gb3Blbihjc3ZQYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgY3N2RmlsZSA9IGlvLlN0cmluZ0lPKCJLZXkqLCBjZWxsLCBudWxsLCBvcGVyYXRpb24sIGF0dHIsXG4tOTk5OSwgXCJcIiwgLTEsIFwiXCIsIG5lbmh1bWEsICIpCgogICAgICAgIGNzdl9yZWFkZXIgPSBjc3YuRGljdFJlYWRlcihjc3ZGaWxlLCBkZWxpbWl0ZXI9JywnKQogICAgICAgIGxpbmVfY291bnQgPSAwCiAgICAgICAgZWxlbWVudHMgPSBbY2VsbFR5cGVOYW1lLCBzdHIobnVsbFZhbHVlKSwgb3BlcmF0aW9uLCBsYXllckF0dHJdCiAgICAgICAgZm9yIHJvdyBpbiBjc3ZfcmVhZGVyOgogICAgICAgICAgICBjdXJFbnRyeSA9IHsKICAgICAgICAgICAgICAgICdjZWxsVHlwZSc6IHJvd1snIGNlbGwnXS5zdHJpcCgpLAogICAgICAgICAgICAgICAgJ251bGxWYWx1ZSc6IHJvd1snIG51bGwnXS5zdHJpcCgpLAogICAgICAgICAgICAgICAgJ29wZXJhdGlvbic6IHJvd1snIG9wZXJhdGlvbiddLnN0cmlwKCksCiAgICAgICAgICAgICAgICAnYXR0cmlidXRlJzogcm93WycgYXR0ciddLnN0cmlwKCkKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiBsaW5lX2NvdW50ID4gMCBhbmQgY3VyRW50cnlbJ29wZXJhdGlvbiddICE9IG9wZXJhdGlvbiBhbmQgY3VyRW50cnlbJ2F0dHJpYnV0ZSddICE9IGxheWVyQXR0cjoKICAgICAgICAgICAgICAgICMgS2V5ICosIGNlbGwsIG51bGwsIG9wZXJhdGlvbiwgYXR0ciwKICAgICAgICAgICAgICAgIGVsZW1lbnRzLmFwcGVuZChjdXJFbnRyeVsnY2VsbFR5cGUnXSkKICAgICAgICAgICAgICAgIGVsZW1lbnRzLmFwcGVuZChjdXJFbnRyeVsnbnVsbFZhbHVlJ10pCiAgICAgICAgICAgICAgICBlbGVtZW50cy5hcHBlbmQoY3VyRW50cnlbJ29wZXJhdGlvbiddKQogICAgICAgICAgICAgICAgZWxlbWVudHMuYXBwZW5kKGN1ckVudHJ5WydhdHRyaWJ1dGUnXSkKICAgICAgICAgICAgbGluZV9jb3VudCArPSAxCiAgICAgICAgd2l0aCBvcGVuKGpzb25QYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGpzb25GaWxlOgogICAgICAgICAgICBqc29uRmlsZS53cml0ZShqc29uLmR1bXBzKGVsZW1lbnRzKSkKICAgICAgICBjc3ZGaWxlLmNsb3NlKCkKCmNsYXNzIFdNU0JCb3goKToKICAgIHhNYXggPSBOb25lCiAgICBkZWYgeE1heGltdW0oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYueE1heAoKICAgIHhNaW4gPSBOb25lCiAgICBkZWYgeE1pbmltdW0oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYueE1pbgoKICAgIHlNYXggPSBOb25lCiAgICBkZWYgeU1heGltdW0oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYueU1heAoKICAgIHlNaW4gPSBOb25lCiAgICBkZWYgeU1pbmltdW0oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYueU1pbgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB4TWF4LCB4TWluLCB5TWF4LCB5TWluKToKICAgICAgICBzZWxmLnhNYXggPSB4TWF4CiAgICAgICAgc2VsZi54TWluID0geE1pbgogICAgICAgIHNlbGYueU1heCA9IHlNYXgKICAgICAgICBzZWxmLnlNaW4gPSB5TWluCgoKCnRyeToKICAgIGZyb20gR0RBTF9VVElMUyBpbXBvcnQgR0RBTF9VVElMUwpleGNlcHQ6CiAgICBwYXNzICNOb3QgaW4gRGluYW1pY2EgQ29kZQoKZnJvbSBvc2dlbyBpbXBvcnQgZ2RhbCxvZ3Isb3NyCgojVGhhbmtzIHRvIGh0dHBzOi8vZ2lzLnN0YWNrZXhjaGFuZ2UuY29tL3F1ZXN0aW9ucy81NzgzNC9ob3ctdG8tZ2V0LXJhc3Rlci1jb3JuZXItY29vcmRpbmF0ZXMtdXNpbmctcHl0aG9uLWdkYWwtYmluZGluZ3MKY2xhc3MgR0RBTF9VVElMUzoKCiAgICAjRGFuaWxvIHZhaSA0IHBvbnRvcyBbTGVmdCBCb3R0b20sICBMZWZ0IFRvcCwgUmlnaHQgQm90dG9tLCBSaWdodCBUb3BdCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgX2dldEV4dGVudChndCxjb2xzLHJvd3MpOgogICAgICAgICcnJyBSZXR1cm4gbGlzdCBvZiBjb3JuZXIgY29vcmRpbmF0ZXMgZnJvbSBhIGdlb3RyYW5zZm9ybQoKICAgICAgICAgICAgQHR5cGUgZ3Q6ICAgQ3t0dXBsZS9saXN0fQogICAgICAgICAgICBAcGFyYW0gZ3Q6IGdlb3RyYW5zZm9ybQogICAgICAgICAgICBAdHlwZSBjb2xzOiAgIEN7aW50fQogICAgICAgICAgICBAcGFyYW0gY29sczogbnVtYmVyIG9mIGNvbHVtbnMgaW4gdGhlIGRhdGFzZXQKICAgICAgICAgICAgQHR5cGUgcm93czogICBDe2ludH0KICAgICAgICAgICAgQHBhcmFtIHJvd3M6IG51bWJlciBvZiByb3dzIGluIHRoZSBkYXRhc2V0CiAgICAgICAgICAgIEBydHlwZTogICAgQ3tbZmxvYXQsLi4uLGZsb2F0XX0KICAgICAgICAgICAgQHJldHVybjogICBjb29yZGluYXRlcyBvZiBlYWNoIGNvcm5lcgogICAgICAgICcnJwogICAgICAgIGV4dD1bXQogICAgICAgIHhhcnI9WzAsY29sc10KICAgICAgICB5YXJyPVswLHJvd3NdCgogICAgICAgIGZvciBweCBpbiB4YXJyOgogICAgICAgICAgICBmb3IgcHkgaW4geWFycjoKICAgICAgICAgICAgICAgIHg9Z3RbMF0rKHB4Kmd0WzFdKSsocHkqZ3RbMl0pCiAgICAgICAgICAgICAgICB5PWd0WzNdKyhweCpndFs0XSkrKHB5Kmd0WzVdKQogICAgICAgICAgICAgICAgZXh0LmFwcGVuZChbeCx5XSkKICAgICAgICAgICAgICAgIHByaW50KHgseSkKICAgICAgICAgICAgeWFyci5yZXZlcnNlKCkKICAgICAgICByZXR1cm4gZXh0CgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIF9yZXByb2plY3RDb29yZHMoY29vcmRzLHNyY19zcnMsdGd0X3Nycyk6CiAgICAgICAgJycnIFJlcHJvamVjdCBhIGxpc3Qgb2YgeCx5IGNvb3JkaW5hdGVzLgoKICAgICAgICAgICAgQHR5cGUgZ2VvbTogICAgIEN7dHVwbGUvbGlzdH0KICAgICAgICAgICAgQHBhcmFtIGdlb206ICAgIExpc3Qgb2YgW1t4LHldLC4uLlt4LHldXSBjb29yZGluYXRlcwogICAgICAgICAgICBAdHlwZSBzcmNfc3JzOiAgQ3tvc3IuU3BhdGlhbFJlZmVyZW5jZX0KICAgICAgICAgICAgQHBhcmFtIHNyY19zcnM6IE9TUiBTcGF0aWFsUmVmZXJlbmNlIG9iamVjdAogICAgICAgICAgICBAdHlwZSB0Z3Rfc3JzOiAgQ3tvc3IuU3BhdGlhbFJlZmVyZW5jZX0KICAgICAgICAgICAgQHBhcmFtIHRndF9zcnM6IE9TUiBTcGF0aWFsUmVmZXJlbmNlIG9iamVjdAogICAgICAgICAgICBAcnR5cGU6ICAgICAgICAgQ3t0dXBsZS9saXN0fQogICAgICAgICAgICBAcmV0dXJuOiAgICAgICAgTGlzdCBvZiB0cmFuc2Zvcm1lZCBbW3gseV0sLi4uW3gseV1dIGNvb3JkaW5hdGVzCiAgICAgICAgJycnCiAgICAgICAgdHJhbnNfY29vcmRzPVtdCiAgICAgICAgdHJhbnNmb3JtID0gb3NyLkNvb3JkaW5hdGVUcmFuc2Zvcm1hdGlvbiggc3JjX3NycywgdGd0X3NycykKICAgICAgICBmb3IgeCx5IGluIGNvb3JkczoKICAgICAgICAgICAgeCx5LHogPSB0cmFuc2Zvcm0uVHJhbnNmb3JtUG9pbnQoeCx5KQogICAgICAgICAgICB0cmFuc19jb29yZHMuYXBwZW5kKFt4LHldKQogICAgICAgIHJldHVybiB0cmFuc19jb29yZHMKCiAgICAjZGFuaWxvIHNlIG8gZXBzZ0NvZGUgw6kgTm9uZSByZXRvcm5hIG8gZG8gcHLDs3ByaW8gbWFwYSBzZW0gYWx0ZXJhci4KICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRFeHRlbnQocmFzdGVyUGF0aCwgZXBzZ0NvZGU9Tm9uZSk6CiAgICAgICAgZHMgPSBnZGFsLk9wZW4ocmFzdGVyUGF0aCwgZ2RhbC5HQV9SZWFkT25seSkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGd0ID0gZHMuR2V0R2VvVHJhbnNmb3JtKCkKICAgICAgICAgICAgY29scyA9IGRzLlJhc3RlclhTaXplCiAgICAgICAgICAgIHJvd3MgPSBkcy5SYXN0ZXJZU2l6ZQogICAgICAgICAgICBleHQgPSBHREFMX1VUSUxTLl9nZXRFeHRlbnQoZ3QsIGNvbHMsIHJvd3MpCiAgICAgICAgICAgIGlmIGVwc2dDb2RlIGlzIE5vbmU6CiAgICAgICAgICAgICAgICByZXR1cm4gR0RBTF9VVElMUy5nZXRBcnJheUZyb21FeHQoZXh0KQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc3JjX3Nycz1vc3IuU3BhdGlhbFJlZmVyZW5jZSgpCiAgICAgICAgICAgICAgICBzcmNfc3JzLkltcG9ydEZyb21Xa3QoZHMuR2V0UHJvamVjdGlvbigpKQogICAgICAgICAgICAgICAgdGd0X3NycyA9IG9zci5TcGF0aWFsUmVmZXJlbmNlKCkKICAgICAgICAgICAgICAgIHRndF9zcnMuSW1wb3J0RnJvbUVQU0coZXBzZ0NvZGUpCiAgICAgICAgICAgICAgICByZXR1cm4gR0RBTF9VVElMUy5nZXRBcnJheUZyb21FeHQoR0RBTF9VVElMUy5fcmVwcm9qZWN0Q29vcmRzKGV4dCxzcmNfc3JzLHRndF9zcnMpKQogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgIGRzID0gTm9uZQoKICAgICNSZXRvcm5hIHhNYXgsIHhNaW4sIHlNYXgsIHlNaW4gZG8gZXh0ZW50cy4KICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRBcnJheUZyb21FeHQoZXh0KToKICAgICAgICBtYXhQb2ludCA9IGV4dFszXQogICAgICAgIG1pblBvaW50ID0gZXh0WzFdCiAgICAgICAgcmV0dXJuIChtYXhQb2ludFswXSwgbWluUG9pbnRbMF0sIG1heFBvaW50WzFdLCBtaW5Qb2ludFsxXSkKCiAgICAjIEBzdGF0aWNtZXRob2QKICAgICMgI1BlZ2EgYXMgaW5mb3JtYWNvZXMgZGUgY2VsdWxhIGRpcmV0byBkbyByYXN0ZXIsIHVzYW5kbyBvIEdEQUwuCiAgICAjIGRlZiBnZXRSYXN0ZXJDZWxsSW5mbyhtYXBEYXRhUGF0aCk6CiAgICAjICAgICAjIGNlbGxJbmZvID0gZGljdCgpCiAgICAjICAgICAjICMgaWYgVXRpbHMuaXNSYXN0ZXJGaWxlKHNlbGYuX19tYXBEYXRhUGF0aCkgOgogICAgIyAgICAgIyBoRGF0YXNldCA9IGdkYWwuT3BlbihtYXBEYXRhUGF0aCwgZ2RhbC5HQV9SZWFkT25seSkKICAgICMgICAgICMgdHJ5OgogICAgIyAgICAgIyAgICAgaWYgaERhdGFzZXQgaXMgbm90IE5vbmUgYW5kIGhEYXRhc2V0LlJhc3RlckNvdW50ID4gMCA6CiAgICAjICAgICAjICAgICAgICAgY3VyQmFuZCA9IGhEYXRhc2V0LkdldFJhc3RlckJhbmQoMSkKICAgICMgICAgICMgICAgICAgICB1bmljb2RlKGdkYWwuR2V0RGF0YVR5cGVOYW1lKGN1ckJhbmQuRGF0YVR5cGUpKQogICAgIyAgICAgIyAgICAgICAgIGNlbGxJbmZvW3UiTnVsbCBDZWxsIFZhbHVlIl0gPSB1bmljb2RlKGN1ckJhbmQuR2V0Tm9EYXRhVmFsdWUoKSkKICAgICMgICAgICMgICAgICAgICBjZWxsSW5mb1t1Ik51bWJlciBvZiBMaW5lcyJdID0gdW5pY29kZShoRGF0YXNldC5SYXN0ZXJZU2l6ZSkKICAgICMgICAgICMgICAgICAgICBjZWxsSW5mb1t1Ik51bWJlciBvZiBDb2x1bW5zIl0gPSB1bmljb2RlKGhEYXRhc2V0LlJhc3RlclhTaXplKQogICAgIyAgICAgIyAgICAgICAgIGFkZkdlb1RyYW5zZm9ybSA9IGhEYXRhc2V0LkdldEdlb1RyYW5zZm9ybShjYW5fcmV0dXJuX251bGwgPSBUcnVlKQogICAgIyAgICAgIyAgICAgICAgIGlmIGFkZkdlb1RyYW5zZm9ybSBpcyBub3QgTm9uZSA6CiAgICAjICAgICAjICAgICAgICAgICAgIGNlbGxJbmZvW3UiQ2VsbCBXaWR0aCJdID0gdW5pY29kZShhZGZHZW9UcmFuc2Zvcm1bMV0pCiAgICAjICAgICAjICAgICAgICAgICAgIGNlbGxJbmZvW3UiQ2VsbCBIZWlnaHQiXSA9IHVuaWNvZGUoZmFicyhhZGZHZW9UcmFuc2Zvcm1bNV0pKQogICAgIyAgICAgIyAgICAgICAgIGNlbGxJbmZvW3UiTnVtYmVyIG9mIExheWVycyJdID0gdW5pY29kZShoRGF0YXNldC5SYXN0ZXJDb3VudCkKICAgICMgICAgICMgZmluYWxseToKICAgICMgICAgICMgICAgIGhEYXRhc2V0ID0gTm9uZQogICAgIyAgICAgIyByZXR1cm4gY2VsbEluZm8KICAgICMgICAgIHJldHVybiAiIgoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRDZWxsVHlwZShyYXN0ZXJQYXRoKToKICAgICAgICB1bmljb2RlKGdkYWwuR2V0RGF0YVR5cGVOYW1lKGN1ckJhbmQuRGF0YVR5cGUpKQoKCgoKCnRyeToKICAgIGZyb20gV01TQ2FwYWJpbGl0aWVzIGltcG9ydCBXTVNDYXBhYmlsaXRpZXMKZXhjZXB0OgogICAgcGFzcwoKIyEvdXNyL2Jpbi9lbnYgcHl0aG9uCiMgLSotIGNvZGluZzogdXRmLTggLSotCgoKaXNEaW5hbWljYSA9IEZhbHNlCnRyeToKICAgIGRpbmFtaWNhLnBhY2thZ2UoIm9zIikKICAgIGlzRGluYW1pY2EgPSBUcnVlCmV4Y2VwdDoKICAgIGlzRGluYW1pY2EgPSBGYWxzZQoKaWYgbm90IGlzRGluYW1pY2E6CiAgICB0cnk6CiAgICAgICAgZnJvbSAuVVRJTFMgaW1wb3J0IFVUSUxTCiAgICAgICAgZnJvbSAuIGltcG9ydCB4bWx0b2RpY3QKICAgIGV4Y2VwdDoKICAgICAgICBwYXNzICNOb3QgaW4gUUdJUwoKICAgIHRyeToKICAgICAgICBmcm9tIFVUSUxTIGltcG9ydCBVVElMUwogICAgICAgIGZyb20geG1sdG9kaWN0IGltcG9ydCB4bWx0b2RpY3QKICAgIGV4Y2VwdDoKICAgICAgICBwYXNzICNOb3QgaW4gRGluYW1pY2EgQ29kZQoKZnJvbSBjb2xsZWN0aW9ucyBpbXBvcnQgT3JkZXJlZERpY3QKaW1wb3J0IGNvbGxlY3Rpb25zCmZyb20gcGF0aGxpYiBpbXBvcnQgUGF0aAppbXBvcnQganNvbgppbXBvcnQgb3MKaW1wb3J0IGlvCmltcG9ydCBjc3YKaW1wb3J0IHJlCgojIHRyeToKIyAgICAgZnJvbSBxZ2lzLmNvcmUgaW1wb3J0IChRZ3NDb29yZGluYXRlUmVmZXJlbmNlU3lzdGVtLCBRZ3NQcm9qZWN0LCBRZ3NQb2ludFhZLCBRZ3NDb29yZGluYXRlVHJhbnNmb3JtLCBRZ3NWZWN0b3JMYXllcikKIyBleGNlcHQ6CiMgICAgIHBhc3MKCmNsYXNzIFdNU0NhcGFiaWxpdGllczoKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0RGVmYXVsdENhcGFiaWxpdGllcygpOgogICAgICAgIHJldHVybiAnJyc8P3htbCB2ZXJzaW9uPSIxLjAiIGVuY29kaW5nPSJVVEYtOCI/PjwhRE9DVFlQRSBXTVRfTVNfQ2FwYWJpbGl0aWVzIFNZU1RFTSAiaHR0cDovL21hcHMuY3NyLnVmbWcuYnI6ODAvZ2Vvc2VydmVyL3NjaGVtYXMvd21zLzEuMS4xL1dNU19NU19DYXBhYmlsaXRpZXMuZHRkIlsKICAgIDwhRUxFTUVOVCBWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyAoVGlsZVNldCopID4KICAgIDwhRUxFTUVOVCBUaWxlU2V0IChTUlMsIEJvdW5kaW5nQm94PywgUmVzb2x1dGlvbnMsIFdpZHRoLCBIZWlnaHQsIEZvcm1hdCwgTGF5ZXJzKiwgU3R5bGVzKikgPgogICAgPCFFTEVNRU5UIFJlc29sdXRpb25zICgjUENEQVRBKSA+CiAgICA8IUVMRU1FTlQgV2lkdGggKCNQQ0RBVEEpID4KICAgIDwhRUxFTUVOVCBIZWlnaHQgKCNQQ0RBVEEpID4KICAgIDwhRUxFTUVOVCBMYXllcnMgKCNQQ0RBVEEpID4KICAgIDwhRUxFTUVOVCBTdHlsZXMgKCNQQ0RBVEEpID4KICAgIF0+CiAgICA8V01UX01TX0NhcGFiaWxpdGllcyB2ZXJzaW9uPSIxLjEuMSIgdXBkYXRlU2VxdWVuY2U9IjYzMjU4Ij4KICAgICAgPFNlcnZpY2U+CiAgICAgICAgPE5hbWU+T0dDOldNUzwvTmFtZT4KICAgICAgICA8VGl0bGU+Q1NSIFdlYiBNYXAgU2VydmljZTwvVGl0bGU+CiAgICAgICAgPEFic3RyYWN0PkNvbXBsaWFudCBXTVMgUmVzcG9uc2U8L0Fic3RyYWN0PgogICAgICAgIDxLZXl3b3JkTGlzdD4KICAgICAgICAgIDxLZXl3b3JkPldGUzwvS2V5d29yZD4KICAgICAgICAgIDxLZXl3b3JkPldNUzwvS2V5d29yZD4KICAgICAgICAgIDxLZXl3b3JkPkdFT1NFUlZFUjwvS2V5d29yZD4KICAgICAgICA8L0tleXdvcmRMaXN0PgogICAgICAgIDxPbmxpbmVSZXNvdXJjZSB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeGxpbms6dHlwZT0ic2ltcGxlIiB4bGluazpocmVmPSJodHRwOi8vZ2Vvc2VydmVyLnNvdXJjZWZvcmdlLm5ldC9odG1sL2luZGV4LnBocCIvPgogICAgICAgIDxDb250YWN0SW5mb3JtYXRpb24+CiAgICAgICAgICA8Q29udGFjdFBlcnNvblByaW1hcnk+CiAgICAgICAgICAgIDxDb250YWN0UGVyc29uPkdJVEhVQiBvd25lcjwvQ29udGFjdFBlcnNvbj4KICAgICAgICAgICAgPENvbnRhY3RPcmdhbml6YXRpb24+R0lUSFVCIG93bmVyPC9Db250YWN0T3JnYW5pemF0aW9uPgogICAgICAgICAgPC9Db250YWN0UGVyc29uUHJpbWFyeT4KICAgICAgICAgIDxDb250YWN0UG9zaXRpb24+Q2hpZWYgZ2VvZ3JhcGhlcjwvQ29udGFjdFBvc2l0aW9uPgogICAgICAgICAgPENvbnRhY3RBZGRyZXNzPgogICAgICAgICAgICA8QWRkcmVzc1R5cGU+V29yazwvQWRkcmVzc1R5cGU+CiAgICAgICAgICAgIDxBZGRyZXNzLz4KICAgICAgICAgICAgPENpdHk+QWxleGFuZHJpYTwvQ2l0eT4KICAgICAgICAgICAgPFN0YXRlT3JQcm92aW5jZS8+CiAgICAgICAgICAgIDxQb3N0Q29kZS8+CiAgICAgICAgICAgIDxDb3VudHJ5PkVneXB0PC9Db3VudHJ5PgogICAgICAgICAgPC9Db250YWN0QWRkcmVzcz4KICAgICAgICAgIDxDb250YWN0Vm9pY2VUZWxlcGhvbmUvPgogICAgICAgICAgPENvbnRhY3RGYWNzaW1pbGVUZWxlcGhvbmUvPgogICAgICAgICAgPENvbnRhY3RFbGVjdHJvbmljTWFpbEFkZHJlc3M+Y2xhdWRpdXMucHRvbG9tYWV1c0BnbWFpbC5jb208L0NvbnRhY3RFbGVjdHJvbmljTWFpbEFkZHJlc3M+CiAgICAgICAgPC9Db250YWN0SW5mb3JtYXRpb24+CiAgICAgICAgPEZlZXM+Tk9ORTwvRmVlcz4KICAgICAgICA8QWNjZXNzQ29uc3RyYWludHM+Tk9ORTwvQWNjZXNzQ29uc3RyYWludHM+CiAgICAgIDwvU2VydmljZT4KICAgICAgPENhcGFiaWxpdHk+CiAgICAgICAgPFJlcXVlc3Q+CiAgICAgICAgICA8R2V0Q2FwYWJpbGl0aWVzPgogICAgICAgICAgICA8Rm9ybWF0PmFwcGxpY2F0aW9uL3ZuZC5vZ2Mud21zX3htbDwvRm9ybWF0PgogICAgICAgICAgICA8RENQVHlwZT4KICAgICAgICAgICAgICA8SFRUUD4KICAgICAgICAgICAgICAgIDxHZXQ+CiAgICAgICAgICAgICAgICAgIDxPbmxpbmVSZXNvdXJjZSB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeGxpbms6dHlwZT0ic2ltcGxlIiB4bGluazpocmVmPSJodHRwOi8vbWFwcy5jc3IudWZtZy5icjo4MC9nZW9zZXJ2ZXIvd21zP1NFUlZJQ0U9V01TJmFtcDsiLz4KICAgICAgICAgICAgICAgIDwvR2V0PgogICAgICAgICAgICAgICAgPFBvc3Q+CiAgICAgICAgICAgICAgICAgIDxPbmxpbmVSZXNvdXJjZSB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeGxpbms6dHlwZT0ic2ltcGxlIiB4bGluazpocmVmPSJodHRwOi8vbWFwcy5jc3IudWZtZy5icjo4MC9nZW9zZXJ2ZXIvd21zP1NFUlZJQ0U9V01TJmFtcDsiLz4KICAgICAgICAgICAgICAgIDwvUG9zdD4KICAgICAgICAgICAgICA8L0hUVFA+CiAgICAgICAgICAgIDwvRENQVHlwZT4KICAgICAgICAgIDwvR2V0Q2FwYWJpbGl0aWVzPgogICAgICAgICAgPEdldE1hcD4KICAgICAgICAgICAgPEZvcm1hdD5pbWFnZS9wbmc8L0Zvcm1hdD4KICAgICAgICAgICAgPERDUFR5cGU+CiAgICAgICAgICAgICAgPEhUVFA+CiAgICAgICAgICAgICAgICA8R2V0PgogICAgICAgICAgICAgICAgICA8T25saW5lUmVzb3VyY2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOnR5cGU9InNpbXBsZSIgeGxpbms6aHJlZj0iaHR0cDovL21hcHMuY3NyLnVmbWcuYnI6ODAvZ2Vvc2VydmVyL3dtcz9TRVJWSUNFPVdNUyZhbXA7Ii8+CiAgICAgICAgICAgICAgICA8L0dldD4KICAgICAgICAgICAgICA8L0hUVFA+CiAgICAgICAgICAgIDwvRENQVHlwZT4KICAgICAgICAgIDwvR2V0TWFwPgogICAgICAgICAgPEdldEZlYXR1cmVJbmZvPgogICAgICAgICAgICA8Rm9ybWF0PnRleHQvcGxhaW48L0Zvcm1hdD4KICAgICAgICAgICAgPEZvcm1hdD5hcHBsaWNhdGlvbi92bmQub2djLmdtbDwvRm9ybWF0PgogICAgICAgICAgICA8Rm9ybWF0PmFwcGxpY2F0aW9uL3ZuZC5vZ2MuZ21sLzMuMS4xPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxGb3JtYXQ+dGV4dC9odG1sPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxGb3JtYXQ+YXBwbGljYXRpb24vanNvbjwvRm9ybWF0PgogICAgICAgICAgICA8RENQVHlwZT4KICAgICAgICAgICAgICA8SFRUUD4KICAgICAgICAgICAgICAgIDxHZXQ+CiAgICAgICAgICAgICAgICAgIDxPbmxpbmVSZXNvdXJjZSB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeGxpbms6dHlwZT0ic2ltcGxlIiB4bGluazpocmVmPSJodHRwOi8vbWFwcy5jc3IudWZtZy5icjo4MC9nZW9zZXJ2ZXIvd21zP1NFUlZJQ0U9V01TJmFtcDsiLz4KICAgICAgICAgICAgICAgIDwvR2V0PgogICAgICAgICAgICAgICAgPFBvc3Q+CiAgICAgICAgICAgICAgICAgIDxPbmxpbmVSZXNvdXJjZSB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeGxpbms6dHlwZT0ic2ltcGxlIiB4bGluazpocmVmPSJodHRwOi8vbWFwcy5jc3IudWZtZy5icjo4MC9nZW9zZXJ2ZXIvd21zP1NFUlZJQ0U9V01TJmFtcDsiLz4KICAgICAgICAgICAgICAgIDwvUG9zdD4KICAgICAgICAgICAgICA8L0hUVFA+CiAgICAgICAgICAgIDwvRENQVHlwZT4KICAgICAgICAgIDwvR2V0RmVhdHVyZUluZm8+CiAgICAgICAgICA8RGVzY3JpYmVMYXllcj4KICAgICAgICAgICAgPEZvcm1hdD5hcHBsaWNhdGlvbi92bmQub2djLndtc194bWw8L0Zvcm1hdD4KICAgICAgICAgICAgPERDUFR5cGU+CiAgICAgICAgICAgICAgPEhUVFA+CiAgICAgICAgICAgICAgICA8R2V0PgogICAgICAgICAgICAgICAgICA8T25saW5lUmVzb3VyY2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOnR5cGU9InNpbXBsZSIgeGxpbms6aHJlZj0iaHR0cDovL21hcHMuY3NyLnVmbWcuYnI6ODAvZ2Vvc2VydmVyL3dtcz9TRVJWSUNFPVdNUyZhbXA7Ii8+CiAgICAgICAgICAgICAgICA8L0dldD4KICAgICAgICAgICAgICA8L0hUVFA+CiAgICAgICAgICAgIDwvRENQVHlwZT4KICAgICAgICAgIDwvRGVzY3JpYmVMYXllcj4KICAgICAgICAgIDxHZXRMZWdlbmRHcmFwaGljPgogICAgICAgICAgICA8Rm9ybWF0PmltYWdlL3BuZzwvRm9ybWF0PgogICAgICAgICAgICA8RENQVHlwZT4KICAgICAgICAgICAgICA8SFRUUD4KICAgICAgICAgICAgICAgIDxHZXQ+CiAgICAgICAgICAgICAgICAgIDxPbmxpbmVSZXNvdXJjZSB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeGxpbms6dHlwZT0ic2ltcGxlIiB4bGluazpocmVmPSJodHRwOi8vbWFwcy5jc3IudWZtZy5icjo4MC9nZW9zZXJ2ZXIvd21zP1NFUlZJQ0U9V01TJmFtcDsiLz4KICAgICAgICAgICAgICAgIDwvR2V0PgogICAgICAgICAgICAgIDwvSFRUUD4KICAgICAgICAgICAgPC9EQ1BUeXBlPgogICAgICAgICAgPC9HZXRMZWdlbmRHcmFwaGljPgogICAgICAgICAgPEdldFN0eWxlcz4KICAgICAgICAgICAgPEZvcm1hdD5hcHBsaWNhdGlvbi92bmQub2djLnNsZCt4bWw8L0Zvcm1hdD4KICAgICAgICAgICAgPERDUFR5cGU+CiAgICAgICAgICAgICAgPEhUVFA+CiAgICAgICAgICAgICAgICA8R2V0PgogICAgICAgICAgICAgICAgICA8T25saW5lUmVzb3VyY2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOnR5cGU9InNpbXBsZSIgeGxpbms6aHJlZj0iaHR0cDovL21hcHMuY3NyLnVmbWcuYnI6ODAvZ2Vvc2VydmVyL3dtcz9TRVJWSUNFPVdNUyZhbXA7Ii8+CiAgICAgICAgICAgICAgICA8L0dldD4KICAgICAgICAgICAgICA8L0hUVFA+CiAgICAgICAgICAgIDwvRENQVHlwZT4KICAgICAgICAgIDwvR2V0U3R5bGVzPgogICAgICAgIDwvUmVxdWVzdD4KICAgICAgICA8RXhjZXB0aW9uPgogICAgICAgICAgPEZvcm1hdD5hcHBsaWNhdGlvbi92bmQub2djLnNlX3htbDwvRm9ybWF0PgogICAgICAgICAgPEZvcm1hdD5hcHBsaWNhdGlvbi92bmQub2djLnNlX2luaW1hZ2U8L0Zvcm1hdD4KICAgICAgICA8L0V4Y2VwdGlvbj4KICAgICAgICA8VmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXM+CiAgICAgICAgICA8bm90ZW1wdHk+PC9ub3RlbXB0eT4KICAgICAgICA8L1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzPgogICAgICAgIDxVc2VyRGVmaW5lZFN5bWJvbGl6YXRpb24gU3VwcG9ydFNMRD0iMSIgVXNlckxheWVyPSIxIiBVc2VyU3R5bGU9IjEiIFJlbW90ZVdGUz0iMSIvPgogICAgICAgIDxMYXllciBxdWVyeWFibGU9IjAiIG9wYXF1ZT0iMCIgbm9TdWJzZXRzPSIwIj4KICAgICAgICAgIDxUaXRsZT5NYXBTZXJ2ZXIgdmlhIEdJdEh1YjwvVGl0bGU+CiAgICAgICAgICA8QWJzdHJhY3Q+R2l0SHViIFdNUzwvQWJzdHJhY3Q+CiAgICAgICAgICA8IS0tQWxsIHN1cHBvcnRlZCBFUFNHIHByb2plY3Rpb25zOi0tPgogICAgICAgICAgPFNSUz5FUFNHOjM4NTc8L1NSUz4KICAgICAgICAgIDxTUlM+RVBTRzo0MzI2PC9TUlM+CiAgICAgICAgICA8U1JTPkVQU0c6OTAwOTEzPC9TUlM+CiAgICAgICAgICA8U1JTPkVQU0c6NDIzMDM8L1NSUz4KICAgICAgICAgIDxMYXRMb25Cb3VuZGluZ0JveCBtaW54PSItMTgwLjAwMDA0MDc0MTk5OTk4IiBtaW55PSItOTAuMCIgbWF4eD0iMTgwLjAwMDAwMDAwMDAwMDEiIG1heHk9IjkwLjAiLz4KICAgICAgICA8L0xheWVyPgogICAgICA8L0NhcGFiaWxpdHk+CiAgICA8L1dNVF9NU19DYXBhYmlsaXRpZXM+JycnCgogICAgIyBAc3RhdGljbWV0aG9kCiAgICAjIGRlZiBjb252ZXJ0Q29vcmRpbmF0ZVByb2ooY3JzUHJvaiwgZnJvbVgsIGZyb21ZLCBvdXRwdXRQcm9qZWN0ZWQpOgogICAgIwogICAgIyAgICAgcmVnZXggPSByIl5bIF0qUFJPSkNTIgogICAgIyAgICAgaXNQcm9qZWN0ZWQgPSByZS5tYXRjaChyZWdleCwgY3JzUHJvaikKICAgICMKICAgICMgICAgIGlmIChpc1Byb2plY3RlZCBhbmQgb3V0cHV0UHJvamVjdGVkKSBvciAoIG5vdCBpc1Byb2plY3RlZCBhbmQgIG5vdCBvdXRwdXRQcm9qZWN0ZWQpOgogICAgIyAgICAgICAgIHJldHVybiAoZnJvbVgsIGZyb21ZKQogICAgIyAgICAgZWxzZToKICAgICMgICAgICAgICBmUHJvaiA9IFFnc0Nvb3JkaW5hdGVSZWZlcmVuY2VTeXN0ZW0oKQogICAgIyAgICAgICAgIGZQcm9qLmNyZWF0ZUZyb21Xa3QoY3JzUHJvaikKICAgICMgICAgICAgICB0UHJvaiA9IFFnc0Nvb3JkaW5hdGVSZWZlcmVuY2VTeXN0ZW0oKQogICAgIyAgICAgICAgIHRQcm9qLmNyZWF0ZUZyb21Qcm9qNCgiK3Byb2o9bWVyYyArYT02Mzc4MTM3ICtiPTYzNzgxMzcgK2xhdF90cz0wLjAgK2xvbl8wPTAuMCAreF8wPTAuMCAreV8wPTAgK2s9MS4wICt1bml0cz1tICtuYWRncmlkcz1AbnVsbCArd2t0ZXh0ICArbm9fZGVmcyIgaWYgb3V0cHV0UHJvamVjdGVkIGVsc2UgIitwcm9qPWxvbmdsYXQgK2RhdHVtPVdHUzg0ICtub19kZWZzICIpCiAgICAjICAgICAgICAgbmV3Q29vcmQgPSBRZ3NDb29yZGluYXRlVHJhbnNmb3JtKGZQcm9qLCB0UHJvaiwgUWdzUHJvamVjdC5pbnN0YW5jZSgpKS50cmFuc2Zvcm0oUWdzUG9pbnRYWShmcm9tWCwgZnJvbVkpLCBUcnVlKQogICAgIyAgICAgcmV0dXJuIChuZXdDb29yZC54LCBuZXdDb29yZC55KQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRNYXBLZXl3b3JkKGlzU2hhcGVmaWxlLCBtYXhab29tLCBkbExpbms9Tm9uZSk6CiAgICAgICAgaWYgZGxMaW5rIGlzIE5vbmUgb3IgbGVuKGRsTGluaykgPT0gMDoKICAgICAgICAgICAgZGxMaW5rID0gJ2Rpc2FibGVkb3dubG9hZCcKICAgICAgICBlbGlmICc6JyBpbiBkbExpbms6CiAgICAgICAgICAgIGRsTGluayA9IGRsTGlua1soZGxMaW5rLmluZGV4KCc6JykgKyAxKTpdCiAgICAgICAgZWxpZiAny7gnIGluIGRsTGluazoKICAgICAgICAgICAgZGxMaW5rID0gZGxMaW5rWyhkbExpbmsuaW5kZXgoJ8u4JykgKyAxKTpdCiAgICAgICAgcmV0dXJuICJncm91cMu4IiArICgnc2hwJyBpZiBpc1NoYXBlZmlsZSBlbHNlICd0aWYnKSArICLLuMu4y7giICsgZGxMaW5rICsgIsu4bm90TGlzdGluZ8u4y7htYXhab29ty7giICsgc3RyKG1heFpvb20pCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldE1hcERlc2NyaXB0aW9uKGxheWVyTmFtZUlELCBsYXllckF0dHIsIGxhdE1pblgsIGxhdE1pblksIGxhdE1heFgsIGxhdE1heFksIHByb2pNaW5YLCBwcm9qTWluWSwgcHJvak1heFgsIHByb2pNYXhZLCBtYXhab29tLCBpc1NoYXBlZmlsZSwgZExpbmspOgogICAgICAgIGxheWVyQXR0ciA9IFVUSUxTLm5vcm1hbGl6ZU5hbWUobGF5ZXJBdHRyKQogICAgICAgIGxheWVyTmFtZUlEID0gVVRJTFMubm9ybWFsaXplTmFtZShsYXllck5hbWVJRCkKICAgICAgICAjIEludmVydGkgbyBtaW54L21pbnkgZSBtYXhYL21heFkgZG8gZXBzZyA0MzI2IHBxIGVzdGF2YSB0cm9jYW5kbyBubyBnZW9zZXJ2ZXIsIG1hcyBuIHNlaSBwcSBpc3NvIGFjb250ZWNlLgogICAgICAgIHJldHVybiAiIiI8Q09OVEVOVD4KICAgICAgICAgIDxMYXllciBxdWVyeWFibGU9IjEiIG9wYXF1ZT0iMCI+CiAgICAgICAgICA8TmFtZT5HSDoiIiIgKyBsYXllck5hbWVJRCArICIiIjwvTmFtZT4KICAgICAgICAgIDxUaXRsZT4iIiIgKyBsYXllck5hbWVJRCArICIiIjwvVGl0bGU+CiAgICAgICAgICA8QWJzdHJhY3Q+R0g6IiIiICsgbGF5ZXJOYW1lSUQgKyAiIiIgQUJTVFJBQ1Q8L0Fic3RyYWN0PgogICAgICAgICAgPEtleXdvcmRMaXN0PgogICAgICAgICAgICA8S2V5d29yZD4iIiIgKyBXTVNDYXBhYmlsaXRpZXMuZ2V0TWFwS2V5d29yZChpc1NoYXBlZmlsZSwgbWF4Wm9vbSwgZExpbmspICsgIiIiPC9LZXl3b3JkPgogICAgICAgICAgPC9LZXl3b3JkTGlzdD4KICAgICAgICAgIDxTUlM+RVBTRzo0MzI2PC9TUlM+CiAgICAgICAgICA8TGF0TG9uQm91bmRpbmdCb3ggbWlueD1cIiIiIiArIHN0cihsYXRNaW5YKSArICIiIlwiIG1pbnk9XCIiIiIgKyBzdHIobGF0TWluWSkgKyAiIiJcIiBtYXh4PVwiIiIiICsgc3RyKAogICAgICAgICAgICBsYXRNYXhYKSArICIiIlwiIG1heHk9XCIiIiIgKyBzdHIobGF0TWF4WSkgKyAiIiJcIi8+CiAgICAgICAgICA8Qm91bmRpbmdCb3ggU1JTPSJFUFNHOjQzMjYiIG1pbng9XCIiIiIgKyBzdHIocHJvak1pblgpICsgIiIiXCIgbWlueT1cIiIiIiArIHN0cigKICAgICAgICAgICAgcHJvak1pblkpICsgIiIiXCIgbWF4eD1cIiIiIiArIHN0cihwcm9qTWF4WCkgKyAiIiJcIiBtYXh5PVwiIiIiICsgc3RyKHByb2pNYXhZKSArICIiIlwiLz4KICAgICAgICAgIDxTdHlsZT4KICAgICAgICAgICA8TmFtZT4iIiIgKyBsYXllckF0dHIgKyAiIiI8L05hbWU+CiAgICAgICAgICAgPFRpdGxlPiIiIiArIGxheWVyQXR0ciArICIiIjwvVGl0bGU+CiAgICAgICAgICAgPEFic3RyYWN0Lz4KICAgICAgICAgICA8TGVnZW5kVVJMIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+CiAgICAgICAgICAgPEZvcm1hdD5pbWFnZS9wbmc8L0Zvcm1hdD4KICAgICAgICAgICA8T25saW5lUmVzb3VyY2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOnR5cGU9InNpbXBsZSIgeGxpbms6aHJlZj0iaHR0cHM6Ly9tYXBzLmNzci51Zm1nLmJyOjQ0My9nZW9zZXJ2ZXIvd21zP3JlcXVlc3Q9R2V0TGVnZW5kR3JhcGhpYyZhbXA7Zm9ybWF0PWltYWdlJTJGcG5nJmFtcDt3aWR0aD0yMCZhbXA7aGVpZ2h0PTIwJmFtcDtsYXllcj0iIiIgKyBsYXllck5hbWVJRCArICIiIlwiLz4KICAgICAgICAgICA8L0xlZ2VuZFVSTD4KICAgICAgICAgIDwvU3R5bGU+CiAgICAgICAgPC9MYXllcj4KICAgICAgICA8L0NPTlRFTlQ+CiAgICAgICAgIiIiCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldFRpbGVTZXREZXNjcmlwdGlvbihmaWxlTmFtZUlkLCBsYXRNaW5YLCBsYXRNaW5ZLCBsYXRNYXhYLCBsYXRNYXhZLCBwcm9qTWluWCwgcHJvak1pblksIHByb2pNYXhYLCBwcm9qTWF4WSk6CiAgICAgICAgIyA8Qm91bmRpbmdCb3ggU1JTPSJFUFNHOjQzMjYiIG1pbng9XCIiIiIgKyBzdHIobGF0TWluWCkgKyAiIiJcIiBtaW55PVwiIiIiICsgc3RyKGxhdE1pblkpICsgIiIiXCIgbWF4eD1cIiIiIiArIHN0cihsYXRNYXhYKSArICIiIlwiIG1heHk9XCIiIiIgKyBzdHIobGF0TWF4WSkgKyAiIiJcIi8+CiAgICAgICAgcmV0dXJuICIiIjw/eG1sIHZlcnNpb249XCIxLjBcIiBlbmNvZGluZz1cIlVURi04XCI/PgogICAgICAgIDxDT05URU5UPgogICAgICAgICAgPFRpbGVTZXQ+CiAgICAgICAgICAgIDxTUlM+RVBTRzo0MzI2PC9TUlM+CiAgICAgICAgICAgIDxCb3VuZGluZ0JveCBTUlM9IkVQU0c6NDMyNiIgbWlueD0iLTE4MC4wIiBtaW55PSItOTAuMCIgbWF4eD0iMC4wIiBtYXh5PSI5MC4wIi8+CiAgICAgICAgPFJlc29sdXRpb25zPjAuNzAzMTI1IDAuMzUxNTYyNSAwLjE3NTc4MTI1IDAuMDg3ODkwNjI1IDAuMDQzOTQ1MzEyNSAwLjAyMTk3MjY1NjI1IDAuMDEwOTg2MzI4MTI1IDAuMDA1NDkzMTY0MDYyNSAwLjAwMjc0NjU4MjAzMTI1IDAuMDAxMzczMjkxMDE1NjI1IDYuODY2NDU1MDc4MTI1RS00IDMuNDMzMjI3NTM5MDYyNUUtNCAxLjcxNjYxMzc2OTUzMTI1RS00IDguNTgzMDY4ODQ3NjU2MjVFLTUgNC4yOTE1MzQ0MjM4MjgxMjVFLTUgMi4xNDU3NjcyMTE5MTQwNjI1RS01IDEuMDcyODgzNjA1OTU3MDMxMkUtNSA1LjM2NDQxODAyOTc4NTE1NkUtNiAyLjY4MjIwOTAxNDg5MjU3OEUtNiAxLjM0MTEwNDUwNzQ0NjI4OUUtNiA2LjcwNTUyMjUzNzIzMTQ0NUUtNyAzLjM1Mjc2MTI2ODYxNTcyMjdFLTcgPC9SZXNvbHV0aW9ucz4KICAgICAgICAgICAgPFdpZHRoPjI1NjwvV2lkdGg+CiAgICAgICAgICAgIDxIZWlnaHQ+MjU2PC9IZWlnaHQ+CiAgICAgICAgICAgIDxGb3JtYXQ+aW1hZ2UvcG5nPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxMYXllcnM+R0g6IiIiICsgZmlsZU5hbWVJZCArICIiIjwvTGF5ZXJzPgogICAgICAgICAgICA8U3R5bGVzLz4KICAgICAgICAgIDwvVGlsZVNldD4KICAgICAgICAgIDxUaWxlU2V0PgogICAgICAgICAgICA8U1JTPkVQU0c6OTAwOTEzPC9TUlM+CiAgICAgICAgICAgIDxCb3VuZGluZ0JveCBTUlM9IkVQU0c6OTAwOTEzIiBtaW54PSItMi4wMDM3NTA4MzRFNyIgbWlueT0iLTIuMDAzNzUwODM0RTciIG1heHg9IjIuMDAzNzUwODM0RTciIG1heHk9IjIuMDAzNzUwODM0RTciLz4KICAgICAgICA8UmVzb2x1dGlvbnM+MTU2NTQzLjAzMzkwNjI1IDc4MjcxLjUxNjk1MzEyNSAzOTEzNS43NTg0NzY1NjI1IDE5NTY3Ljg3OTIzODI4MTI1IDk3ODMuOTM5NjE5MTQwNjI1IDQ4OTEuOTY5ODA5NTcwMzEyNSAyNDQ1Ljk4NDkwNDc4NTE1NjIgMTIyMi45OTI0NTIzOTI1NzgxIDYxMS40OTYyMjYxOTYyODkxIDMwNS43NDgxMTMwOTgxNDQ1MyAxNTIuODc0MDU2NTQ5MDcyMjYgNzYuNDM3MDI4Mjc0NTM2MTMgMzguMjE4NTE0MTM3MjY4MDY2IDE5LjEwOTI1NzA2ODYzNDAzMyA5LjU1NDYyODUzNDMxNzAxNyA0Ljc3NzMxNDI2NzE1ODUwOCAyLjM4ODY1NzEzMzU3OTI1NCAxLjE5NDMyODU2Njc4OTYyNyAwLjU5NzE2NDI4MzM5NDgxMzUgMC4yOTg1ODIxNDE2OTc0MDY3NyAwLjE0OTI5MTA3MDg0ODcwMzM4IDAuMDc0NjQ1NTM1NDI0MzUxNjkgMC4wMzczMjI3Njc3MTIxNzU4NDYgMC4wMTg2NjEzODM4NTYwODc5MjMgMC4wMDkzMzA2OTE5MjgwNDM5NjEgMC4wMDQ2NjUzNDU5NjQwMjE5ODEgMC4wMDIzMzI2NzI5ODIwMTA5OTA0IDAuMDAxMTY2MzM2NDkxMDA1NDk1MiA1LjgzMTY4MjQ1NTAyNzQ3NkUtNCAyLjkxNTg0MTIyNzUxMzczOEUtNCAxLjQ1NzkyMDYxMzc1Njg2OUUtNCA8L1Jlc29sdXRpb25zPgogICAgICAgICAgICA8V2lkdGg+MjU2PC9XaWR0aD4KICAgICAgICAgICAgPEhlaWdodD4yNTY8L0hlaWdodD4KICAgICAgICAgICAgPEZvcm1hdD5pbWFnZS9wbmc8L0Zvcm1hdD4KICAgICAgICAgICAgPExheWVycz5HSDoiIiIgKyBmaWxlTmFtZUlkICsgIiIiPC9MYXllcnM+CiAgICAgICAgICAgIDxTdHlsZXMvPgogICAgICAgICAgPC9UaWxlU2V0PgogICAgICAgICAgPC9DT05URU5UPgogICAgICAgICIiIgogICAgICAgICMgPEJvdW5kaW5nQm94IFNSUz0iRVBTRzo5MDA5MTMiIG1pbng9XCIiIiIgKyBzdHIocHJvak1pblgpICsgIiIiXCIgbWlueT1cIiIiIiArIHN0cihwcm9qTWluWSkgKyAiIiJcIiBtYXh4PVwiIiIiICsgc3RyKHByb2pNYXhYKSArICIiIlwiIG1heHk9XCIiIiIgKyBzdHIocHJvak1heFkpICsgIiIiXCIvPgoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRBbGxMYXllcnMoY29udGVudCwgbGF5ZXJBdHRyPScxJyk6CiAgICAgICAgI0ZJWE1FIHNob3VsZCB1c2UgdGhlIHN0eWxlIG5hbWUgdG8gaWRlbnRpZnkgdGhlIGxheWVyIGF0dHJpYnV0ZXMKICAgICAgICBkb2MgPSB4bWx0b2RpY3QucGFyc2UoY29udGVudCkKICAgICAgICBhbGxMYXllcnMgPSBbXQogICAgICAgIHRyeToKICAgICAgICAgICAgbGF5ZXJEZWZpbml0aW9ucyA9IGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10KICAgICAgICAgICAgaWYgbGF5ZXJEZWZpbml0aW9ucyBpcyBub3QgTm9uZSBhbmQgaXNpbnN0YW5jZShsYXllckRlZmluaXRpb25zLCBsaXN0KSBhbmQgbGVuKGxheWVyRGVmaW5pdGlvbnMpOgogICAgICAgICAgICAgICAgYWxsTGF5ZXJzID0gW2N1ckxheWVyWyJOYW1lIl0gZm9yIGN1ckxheWVyIGluIGxheWVyRGVmaW5pdGlvbnNdCiAgICAgICAgICAgIGVsaWYgbGF5ZXJEZWZpbml0aW9ucyBpcyBub3QgTm9uZSBhbmQgaXNpbnN0YW5jZShkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddLCBjb2xsZWN0aW9ucy5PcmRlcmVkRGljdCkgYW5kIGxlbihsYXllckRlZmluaXRpb25zKToKICAgICAgICAgICAgICAgIGFsbExheWVycyA9IFtsYXllckRlZmluaXRpb25zWyJOYW1lIl1dCiAgICAgICAgZXhjZXB0IEtleUVycm9yIGFzIGU6CiAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4gYWxsTGF5ZXJzCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldE9wZXJhdGlvbnNMaXN0Rm9yQ3VzdG9tTGF5ZXIoZG9jTGF5ZXIpOgogICAgICAgICNGSVhNRSBOw6NvIGRldmVyaWEgbW9kaWZpY2FyIG8gaW5wdXQgbnVtYSBmdW5jYW8gZGUgZ2V0CiAgICAgICAgI0ZJWE1FIGNvZGlnbyBkdXBsaWNhZG8KICAgICAgICBpZiBub3QgIk9wZXJhdGlvbiIgaW4gZG9jTGF5ZXI6CiAgICAgICAgICAgIGRvY0xheWVyWyJPcGVyYXRpb24iXSA9IFtdCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKGRvY0xheWVyWyJPcGVyYXRpb24iXSwgY29sbGVjdGlvbnMuT3JkZXJlZERpY3QpOgogICAgICAgICAgICBkb2NMYXllclsiT3BlcmF0aW9uIl0gPSBbZG9jTGF5ZXJbIk9wZXJhdGlvbiJdXQoKICAgICAgICBpZiBsZW4oZG9jTGF5ZXJbIk9wZXJhdGlvbiJdKSA9PSAwOgogICAgICAgICAgICByZXR1cm4gW10KICAgICAgICBlbGlmIGlzaW5zdGFuY2UoZG9jTGF5ZXJbIk9wZXJhdGlvbiJdLCBzdHIpOgogICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oanNvbi5kdW1wcyhkb2NMYXllcikpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIFt7J3R5cGUnOiBvcGVyYXRpb25bIkB0eXBlIl0sICdhdHRyaWJ1dGUnOiBvcGVyYXRpb25bIiN0ZXh0Il19IGZvciBvcGVyYXRpb24gaW4gZG9jTGF5ZXJbJ09wZXJhdGlvbiddXQoKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0QWxsQ3VzdG9tTGF5ZXJzKGNvbnRlbnQsIGxheWVyQXR0cj0nMScpOgogICAgICAgIGRvYyA9IHhtbHRvZGljdC5wYXJzZShjb250ZW50KQogICAgICAgIGFsbEN1c3RvbUxheWVycyA9IFtdCiAgICAgICAgaWYgJ0N1c3RvbUxheWVyJyAgaW4gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXToKICAgICAgICAgICAgbGF5ZXJEZWZpbml0aW9ucyA9IGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bJ0N1c3RvbUxheWVyJ10KCiAgICAgICAgICAgIGlmIGxheWVyRGVmaW5pdGlvbnMgaXMgbm90IE5vbmUgYW5kIGlzaW5zdGFuY2UobGF5ZXJEZWZpbml0aW9ucywgY29sbGVjdGlvbnMuT3JkZXJlZERpY3QpOgogICAgICAgICAgICAgICAgbGF5ZXJEZWZpbml0aW9ucyA9IFtsYXllckRlZmluaXRpb25zXQogICAgICAgICAgICBpZiBsYXllckRlZmluaXRpb25zIGlzIG5vdCBOb25lIGFuZCBpc2luc3RhbmNlKGxheWVyRGVmaW5pdGlvbnMsIGxpc3QpIGFuZCBsZW4obGF5ZXJEZWZpbml0aW9ucykgPiAwOgogICAgICAgICAgICAgICAgZm9yIGN1ckxheWVyIGluIGxheWVyRGVmaW5pdGlvbnM6CiAgICAgICAgICAgICAgICAgICAgZm9yIG9wZXJhdGlvbiBpbiBXTVNDYXBhYmlsaXRpZXMuZ2V0T3BlcmF0aW9uc0xpc3RGb3JDdXN0b21MYXllcihjdXJMYXllcik6CiAgICAgICAgICAgICAgICAgICAgICAgIGFsbEN1c3RvbUxheWVycy5hcHBlbmQoY3VyTGF5ZXJbIk5hbWUiXSArICI7IiArIG9wZXJhdGlvblsnYXR0cmlidXRlJ10pCiAgICAgICAgICAgICAgICAgICAgICAgICNhbGxDdXN0b21MYXllcnMuYXBwZW5kKGN1ckxheWVyWyJOYW1lIl0gKyAiOiIgKyBvcGVyYXRpb25bJ2F0dHJpYnV0ZSddICsgIjoiICsgb3BlcmF0aW9uWyd0eXBlJ10pCiAgICAgICAgcmV0dXJuIGFsbEN1c3RvbUxheWVycwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRDdXJyZW50Q2FwYWJpbGl0aWVzRG9jKGRpcmVjdG9yeSk6CiAgICAgICAgY2FwYWJpbGl0aWVzUGF0aCA9IG9zLnBhdGguam9pbihkaXJlY3RvcnksICJnZXRDYXBhYmlsaXRpZXMueG1sIikKICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShjYXBhYmlsaXRpZXNQYXRoKToKICAgICAgICAgICAgd2l0aCBpby5vcGVuKGNhcGFiaWxpdGllc1BhdGgsIG1vZGU9InIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBjYXBhYmlsaXRpZXNGaWxlOgogICAgICAgICAgICAgICAgY2FwYWJpbGl0aWVzQ29udGVudCA9IGNhcGFiaWxpdGllc0ZpbGUucmVhZCgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgY2FwYWJpbGl0aWVzQ29udGVudCA9IFdNU0NhcGFiaWxpdGllcy5nZXREZWZhdWx0Q2FwYWJpbGl0aWVzKCkKICAgICAgICBkb2MgPSB4bWx0b2RpY3QucGFyc2UoY2FwYWJpbGl0aWVzQ29udGVudCkKICAgICAgICByZXR1cm4gZG9jCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHNhdmVDdXJyZW50Q2FwYWJpbGl0aWVzKGRpcmVjdG9yeSwgZG9jKToKICAgICAgICBjYXBhYmlsaXRpZXNQYXRoID0gb3MucGF0aC5qb2luKGRpcmVjdG9yeSwgImdldENhcGFiaWxpdGllcy54bWwiKQogICAgICAgIHdpdGggaW8ub3BlbihjYXBhYmlsaXRpZXNQYXRoLCBtb2RlPSJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgY2FwYWJpbGl0aWVzRmlsZToKICAgICAgICAgICAgY2FwYWJpbGl0aWVzRmlsZS53cml0ZSh4bWx0b2RpY3QudW5wYXJzZShkb2MsIHByZXR0eT1UcnVlKSkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0Q3VzdG9tTGF5ZXJEZWZhdWx0RGVmaW5pdGlvbihsYXllck5hbWUpOgogICAgICAgIGxheWVyTmFtZSA9IFVUSUxTLm5vcm1hbGl6ZU5hbWUobGF5ZXJOYW1lKQogICAgICAgIHJldHVybiB4bWx0b2RpY3QucGFyc2UoIiIiPD94bWwgdmVyc2lvbj1cIjEuMFwiIGVuY29kaW5nPVwiVVRGLThcIj8+CiAgICAgICAgICAgIDxDT05URU5UPgogICAgICAgICAgICAgICAgPE5hbWU+R0g6IiIiICsgbGF5ZXJOYW1lICsgIiIiPC9OYW1lPgogICAgICAgICAgICAgICAgPFRpdGxlPiIiIitsYXllck5hbWUgKyIiIjwvVGl0bGU+CiAgICAgICAgICAgIDwvQ09OVEVOVD4iIiIpWyJDT05URU5UIl0KCiAgICAjY3VzdG9tRG9jIMOpIHVtIERpY3QgdmluZG8gZG8geG1sdG9kaWN0LiBsYXllckF0dHIgZSBvcGVyYXRpb24gc8OjbyBzdHJpbmdzCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgYWRkT3BlcmF0aW9uKGN1c3RvbURvYywgbGF5ZXJBdHRyLCBvcGVyYXRpb24pOgogICAgICAgIGxheWVyQXR0ciA9IFVUSUxTLm5vcm1hbGl6ZU5hbWUobGF5ZXJBdHRyKQogICAgICAgIGlmIG5vdCAiT3BlcmF0aW9uIiBpbiBjdXN0b21Eb2M6CiAgICAgICAgICAgIGN1c3RvbURvY1siT3BlcmF0aW9uIl0gPSBsaXN0KCkKICAgICAgICBpZiBpc2luc3RhbmNlKGN1c3RvbURvY1siT3BlcmF0aW9uIl0sIGNvbGxlY3Rpb25zLk9yZGVyZWREaWN0KToKICAgICAgICAgICAgY3VzdG9tRG9jWyJPcGVyYXRpb24iXSA9IFtjdXN0b21Eb2NbIk9wZXJhdGlvbiJdXQoKICAgICAgICBmb3VuZCA9IEZhbHNlCiAgICAgICAgZm9yIGN1ck9wZXJhdGlvbkRpY3QgaW4gY3VzdG9tRG9jWyJPcGVyYXRpb24iXToKICAgICAgICAgICAgaWYgbm90IGZvdW5kIGFuZCAnQHR5cGUnIGluIGN1ck9wZXJhdGlvbkRpY3QgYW5kIGN1ck9wZXJhdGlvbkRpY3RbJ0B0eXBlJ10gPT0gb3BlcmF0aW9uIGFuZCBjdXJPcGVyYXRpb25EaWN0WycjdGV4dCddID09IGxheWVyQXR0cjoKICAgICAgICAgICAgICAgIGZvdW5kID0gVHJ1ZQogICAgICAgIGlmIG5vdCBmb3VuZDoKICAgICAgICAgICAgY3VzdG9tRG9jWydPcGVyYXRpb24nXS5hcHBlbmQoeG1sdG9kaWN0LnBhcnNlKCIiIjw/eG1sIHZlcnNpb249XCIxLjBcIiBlbmNvZGluZz1cIlVURi04XCI/PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPENPTlRFTlQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8T3BlcmF0aW9uIHR5cGU9XCIiIiIgKyBvcGVyYXRpb24gKyAiIiJcIj4iIiIgKyBsYXllckF0dHIgKyAiIiI8L09wZXJhdGlvbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvQ09OVEVOVD4iIiIpWyJDT05URU5UIl1bIk9wZXJhdGlvbiJdKQogICAgICAgIHJldHVybiBjdXN0b21Eb2MKCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHVwZGF0ZUN1c3RvbVhNTChkaXJlY3RvcnksIGxheWVyVGl0bGUsIGxheWVyQXR0ciwgb3BlcmF0aW9uKToKICAgICAgICBkb2MgPSBXTVNDYXBhYmlsaXRpZXMuZ2V0Q3VycmVudENhcGFiaWxpdGllc0RvYyhkaXJlY3RvcnkpCiAgICAgICAgZmlsZW5hbWUgPSBVVElMUy5ub3JtYWxpemVOYW1lKGxheWVyVGl0bGUpICAjIGxheWVyIE5hbWUgbm8gcWdpcwoKICAgICAgICBpZiAnQ3VzdG9tTGF5ZXInIGluIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ106CiAgICAgICAgICAgIGlmIHR5cGUoZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsiQ3VzdG9tTGF5ZXIiXSkgaXMgY29sbGVjdGlvbnMuT3JkZXJlZERpY3Q6CiAgICAgICAgICAgICAgICBjdXJMYXllciA9IGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bIkN1c3RvbUxheWVyIl0KICAgICAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bIkN1c3RvbUxheWVyIl0gPSBbY3VyTGF5ZXJdCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsnQ3VzdG9tTGF5ZXInXSA9IFtdCgogICAgICAgIGN1ckxheWVyRGVmaW5pdGlvbiA9IE5vbmUKICAgICAgICBpZiAnQ3VzdG9tTGF5ZXInIGluIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ106CiAgICAgICAgICAgIGZvciBpTGF5ZXIgaW4gcmFuZ2UobGVuKGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bIkN1c3RvbUxheWVyIl0pIC0gMSwgLTEsIC0xKToKICAgICAgICAgICAgICAgIGN1ckxheWVyID0gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsiQ3VzdG9tTGF5ZXIiXVtpTGF5ZXJdCiAgICAgICAgICAgICAgICBpZiAiTmFtZSIgaW4gY3VyTGF5ZXIgYW5kIGZpbGVuYW1lIGluIGN1ckxheWVyWyJOYW1lIl06CiAgICAgICAgICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsiQ3VzdG9tTGF5ZXIiXS5wb3AoaUxheWVyKQogICAgICAgICAgICAgICAgICAgIGN1ckxheWVyRGVmaW5pdGlvbiA9IGN1ckxheWVyCiAgICAgICAgICAgICAgICAgICAgI1RPRE8gdmVyaWZpY2FyIHNlIG7Do28gcmVzdGFyYW0gb3V0cm9zIGNvbSBtZXNtbyBub21lLgogICAgICAgIGlmIGN1ckxheWVyRGVmaW5pdGlvbiBpcyBOb25lOgogICAgICAgICAgICBjdXJMYXllckRlZmluaXRpb24gPSBXTVNDYXBhYmlsaXRpZXMuZ2V0Q3VzdG9tTGF5ZXJEZWZhdWx0RGVmaW5pdGlvbihmaWxlbmFtZSkKICAgICAgICBXTVNDYXBhYmlsaXRpZXMuYWRkT3BlcmF0aW9uKGN1ckxheWVyRGVmaW5pdGlvbiwgbGF5ZXJBdHRyLCBvcGVyYXRpb24pCiAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsiQ3VzdG9tTGF5ZXIiXS5hcHBlbmQoY3VyTGF5ZXJEZWZpbml0aW9uKQogICAgICAgIFdNU0NhcGFiaWxpdGllcy5zYXZlQ3VycmVudENhcGFiaWxpdGllcyhkaXJlY3RvcnksIGRvYykKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgc2V0Q2FwYWJpbGl0aWVzRGVmYXVsdE1heFpvb20oZGlyZWN0b3J5KToKICAgICAgICBkb2MgPSBXTVNDYXBhYmlsaXRpZXMuZ2V0Q3VycmVudENhcGFiaWxpdGllc0RvYyhkaXJlY3RvcnkpCgogICAgICAgIGlmICdMYXllcicgaW4gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXToKICAgICAgICAgICAgaWYgdHlwZShkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddKSBpcyBjb2xsZWN0aW9ucy5PcmRlcmVkRGljdDoKICAgICAgICAgICAgICAgIGN1ckxheWVyID0gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXQogICAgICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXSA9IFtjdXJMYXllcl0KCiAgICAgICAgaWYgJ0xheWVyJyBpbiBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddOgogICAgICAgICAgICBmb3IgaUxheWVyIGluIHJhbmdlKGxlbihkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddKSAtIDEsIC0xLCAtMSk6CiAgICAgICAgICAgICAgICBjdXJMYXllciA9IGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ11baUxheWVyXQogICAgICAgICAgICAgICAgaWYgIktleXdvcmRMaXN0IiBpbiBjdXJMYXllciBhbmQgdHlwZShjdXJMYXllclsnS2V5d29yZExpc3QnXSkgaXMgY29sbGVjdGlvbnMuT3JkZXJlZERpY3QgYW5kICgiS2V5d29yZCIgaW4gY3VyTGF5ZXJbJ0tleXdvcmRMaXN0J10pIGFuZCBjdXJMYXllclsnS2V5d29yZExpc3QnXVsnS2V5d29yZCddID09ICdHSVRIVUInOgogICAgICAgICAgICAgICAgICAgIGN1ckxheWVyWydLZXl3b3JkTGlzdCddWydLZXl3b3JkJ10gPSBXTVNDYXBhYmlsaXRpZXMuZ2V0TWFwS2V5d29yZChGYWxzZSwgOCkKICAgICAgICBXTVNDYXBhYmlsaXRpZXMuc2F2ZUN1cnJlbnRDYXBhYmlsaXRpZXMoZGlyZWN0b3J5LCBkb2MpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHVwZGF0ZVhNTChkaXJlY3RvcnksIGxheWVyRXh0ZW50cywgbGF5ZXJNZXJjYXRvckV4dGVudHMsIGlzU2hhcGVmaWxlLCBsYXllclRpdGxlLCBsYXllckF0dHIsIG1heFpvb20sIGRvd25sb2FkTGluayk6CiAgICAgICAgZG9jID0gV01TQ2FwYWJpbGl0aWVzLmdldEN1cnJlbnRDYXBhYmlsaXRpZXNEb2MoZGlyZWN0b3J5KQoKICAgICAgICBmaWxlbmFtZSA9IFVUSUxTLm5vcm1hbGl6ZU5hbWUobGF5ZXJUaXRsZSkgI2xheWVyIE5hbWUgbm8gcWdpcwoKICAgICAgICBhc3NlcnQgaXNpbnN0YW5jZShsYXllckV4dGVudHMsIFdNU0JCb3gpIGFuZCBpc2luc3RhbmNlKGxheWVyTWVyY2F0b3JFeHRlbnRzLCBXTVNCQm94KQoKICAgICAgICAjICNleHRlbnRzLCBwcm9qZWN0aW9uCiAgICAgICAgIyBwcm9qTWF4WCA9IGxheWVyLmV4dGVudCgpLnhNYXhpbXVtKCkKICAgICAgICBwcm9qTWF4WCA9IGxheWVyRXh0ZW50cy54TWF4aW11bSgpCiAgICAgICAgIyBwcm9qTWluWCA9IGxheWVyLmV4dGVudCgpLnhNaW5pbXVtKCkKICAgICAgICBwcm9qTWluWCA9IGxheWVyRXh0ZW50cy54TWluaW11bSgpCiAgICAgICAgIyBwcm9qTWF4WSA9IGxheWVyLmV4dGVudCgpLnlNYXhpbXVtKCkKICAgICAgICBwcm9qTWF4WSA9IGxheWVyRXh0ZW50cy55TWF4aW11bSgpCiAgICAgICAgIyBwcm9qTWluWSA9IGxheWVyLmV4dGVudCgpLnlNaW5pbXVtKCkKICAgICAgICBwcm9qTWluWSA9IGxheWVyRXh0ZW50cy55TWluaW11bSgpCiAgICAgICAgIyBsbEV4dGVudCA9IFVUSUxTLmdldE1hcEV4dGVudChsYXllciwgUWdzQ29vcmRpbmF0ZVJlZmVyZW5jZVN5c3RlbSgnRVBTRzo0MzI2JykpCiAgICAgICAgIyBsYXRNYXhYID0gbGxFeHRlbnQueE1heGltdW0oKQogICAgICAgIGxhdE1heFggPSBsYXllck1lcmNhdG9yRXh0ZW50cy54TWF4aW11bSgpCiAgICAgICAgIyBsYXRNaW5YID0gbGxFeHRlbnQueE1pbmltdW0oKQogICAgICAgIGxhdE1pblggPSBsYXllck1lcmNhdG9yRXh0ZW50cy54TWluaW11bSgpCiAgICAgICAgIyBsYXRNYXhZID0gbGxFeHRlbnQueU1heGltdW0oKQogICAgICAgIGxhdE1heFkgPSBsYXllck1lcmNhdG9yRXh0ZW50cy55TWF4aW11bSgpCiAgICAgICAgIyBsYXRNaW5ZID0gbGxFeHRlbnQueU1pbmltdW0oKQogICAgICAgIGxhdE1pblkgPSBsYXllck1lcmNhdG9yRXh0ZW50cy55TWluaW11bSgpCiAgICAgICAgI2lzU2hhcGVmaWxlID0gKGlzaW5zdGFuY2UobGF5ZXIsIFFnc1ZlY3RvckxheWVyKSkKCgogICAgICAgIGlmICdMYXllcicgaW4gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXToKICAgICAgICAgICAgaWYgdHlwZShkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddKSBpcyBjb2xsZWN0aW9ucy5PcmRlcmVkRGljdDoKICAgICAgICAgICAgICAgIGN1ckxheWVyID0gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXQogICAgICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXSA9IFtjdXJMYXllcl0KCiAgICAgICAgaWYgJ0xheWVyJyBpbiBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddOgogICAgICAgICAgICBmb3IgaUxheWVyIGluIHJhbmdlKGxlbihkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddKSAtIDEsIC0xLCAtMSk6CiAgICAgICAgICAgICAgICBjdXJMYXllciA9IGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ11baUxheWVyXQogICAgICAgICAgICAgICAgaWYgIk5hbWUiIGluIGN1ckxheWVyIGFuZCBjdXJMYXllclsiTmFtZSJdID09ICJHSDoiICsgZmlsZW5hbWU6CiAgICAgICAgICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXS5wb3AoaUxheWVyKQoKICAgICAgICAjRklYTUUgT25lIGF0dHJpYnV0ZSBvbmx5LiAoSXMgYWx3YXlzIG92ZXJ3cml0aW5nKQogICAgICAgIG5ld0xheWVyRGVzY3JpcHRpb24gPSB4bWx0b2RpY3QucGFyc2UoCiAgICAgICAgICAgIFdNU0NhcGFiaWxpdGllcy5nZXRNYXBEZXNjcmlwdGlvbihmaWxlbmFtZSwgbGF5ZXJBdHRyLCBsYXRNaW5YLCBsYXRNaW5ZLCBsYXRNYXhYLCBsYXRNYXhZLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvak1pblgsIHByb2pNaW5ZLCBwcm9qTWF4WCwgcHJvak1heFksIG1heFpvb20sIGlzU2hhcGVmaWxlLCBkb3dubG9hZExpbmspKVsnQ09OVEVOVCddCiAgICAgICAgaWYgJ0xheWVyJyBpbiBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddOgogICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddLmFwcGVuZChuZXdMYXllckRlc2NyaXB0aW9uWydMYXllciddKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ10gPSBuZXdMYXllckRlc2NyaXB0aW9uCgogICAgICAgIG5ld1RpbGVTZXREZXNjcmlwdGlvbiA9IHhtbHRvZGljdC5wYXJzZSgKICAgICAgICAgICAgV01TQ2FwYWJpbGl0aWVzLmdldFRpbGVTZXREZXNjcmlwdGlvbihmaWxlbmFtZSwgbGF0TWluWCwgbGF0TWluWSwgbGF0TWF4WCwgbGF0TWF4WSwgcHJvak1pblgsIHByb2pNaW5ZLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2pNYXhYLCBwcm9qTWF4WSkpWydDT05URU5UJ10KCiAgICAgICAgaWYgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXSBpcyBub3QgTm9uZSBhbmQgJ1RpbGVTZXQnIGluIFwKICAgICAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ106CiAgICAgICAgICAgIGlmIHR5cGUoZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsKICAgICAgICAgICAgICAgICAgICAgICAgJ1RpbGVTZXQnXSkgaXMgY29sbGVjdGlvbnMuT3JkZXJlZERpY3Q6CiAgICAgICAgICAgICAgICBjdXJUaWxlU2V0ID0gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsnVGlsZVNldCddCiAgICAgICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWydUaWxlU2V0J10gPSBbCiAgICAgICAgICAgICAgICAgICAgY3VyVGlsZVNldF0gICMgVHJhbnNmb3JtcyBpbnRvIGEgbGlzdAoKICAgICAgICBpZiBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddIGlzIG5vdCBOb25lIGFuZCAnVGlsZVNldCcgaW4gXAogICAgICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXToKICAgICAgICAgICAgZm9yIGlUaWxlU2V0IGluIHJhbmdlKAogICAgICAgICAgICAgICAgICAgIGxlbihkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWydUaWxlU2V0J10pIC0gMSwKICAgICAgICAgICAgICAgICAgICAtMSwgLTEpOgogICAgICAgICAgICAgICAgY3VyVGlsZVNldCA9IGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bJ1RpbGVTZXQnXVtpVGlsZVNldF0KICAgICAgICAgICAgICAgIGlmICJMYXllcnMiIGluIGN1clRpbGVTZXQgYW5kIGN1clRpbGVTZXRbIkxheWVycyJdID09ICJHSDoiICsgZmlsZW5hbWU6CiAgICAgICAgICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsnVGlsZVNldCddLnBvcChpVGlsZVNldCkKICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsnVGlsZVNldCddICs9IG5ld1RpbGVTZXREZXNjcmlwdGlvblsKICAgICAgICAgICAgICAgICdUaWxlU2V0J10gICMgRG9pcyBlbGVtZW50b3MgYyBtZXNtYSBjaGF2ZSByZXByZXNlbnRhIGNvbSBsaXN0YQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ10gPSBuZXdUaWxlU2V0RGVzY3JpcHRpb24KICAgICAgICBXTVNDYXBhYmlsaXRpZXMuc2F2ZUN1cnJlbnRDYXBhYmlsaXRpZXMoZGlyZWN0b3J5LCBkb2MpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHdyaXRlX2Rlc2NyaXB0aW9uKGRpcmVjdG9yeSwgbGF5ZXJUaXRsZSwgbGF5ZXJBdHRyLCBjZWxsVHlwZU5hbWUsIG51bGxWYWx1ZSwgb3BlcmF0aW9uKToKICAgICAgICBsYXllclRpdGxlID0gVVRJTFMubm9ybWFsaXplTmFtZShsYXllclRpdGxlKQogICAgICAgIGNlbGxUeXBlTmFtZSA9IFVUSUxTLm5vcm1hbGl6ZU5hbWUoY2VsbFR5cGVOYW1lKQogICAgICAgIGZpbGVjc3YgPSAiZGVzY3JpcHRpb24uY3N2IgogICAgICAgIGNzdlBhdGggPSBvcy5wYXRoLmpvaW4oZGlyZWN0b3J5LCBmaWxlY3N2KQogICAgICAgIGpzb25QYXRoID0gb3MucGF0aC5qb2luKGRpcmVjdG9yeSwgImRlc2NyaXB0aW9uLmpzb24iKQogICAgICAgIGlmIG9zLnBhdGguaXNmaWxlKGNzdlBhdGgpOgogICAgICAgICAgICBjc3ZGaWxlID0gb3Blbihjc3ZQYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgY3N2RmlsZSA9IGlvLlN0cmluZ0lPKCJLZXkqLCBjZWxsLCBudWxsLCBvcGVyYXRpb24sIGF0dHIsXG4tOTk5OSwgXCJcIiwgLTEsIFwiXCIsIG5lbmh1bWEsICIpCgogICAgICAgIGNzdl9yZWFkZXIgPSBjc3YuRGljdFJlYWRlcihjc3ZGaWxlLCBkZWxpbWl0ZXI9JywnKQogICAgICAgIGxpbmVfY291bnQgPSAwCiAgICAgICAgZWxlbWVudHMgPSBbY2VsbFR5cGVOYW1lLCBzdHIobnVsbFZhbHVlKSwgb3BlcmF0aW9uLCBsYXllckF0dHJdCiAgICAgICAgZm9yIHJvdyBpbiBjc3ZfcmVhZGVyOgogICAgICAgICAgICBjdXJFbnRyeSA9IHsKICAgICAgICAgICAgICAgICdjZWxsVHlwZSc6IHJvd1snIGNlbGwnXS5zdHJpcCgpLAogICAgICAgICAgICAgICAgJ251bGxWYWx1ZSc6IHJvd1snIG51bGwnXS5zdHJpcCgpLAogICAgICAgICAgICAgICAgJ29wZXJhdGlvbic6IHJvd1snIG9wZXJhdGlvbiddLnN0cmlwKCksCiAgICAgICAgICAgICAgICAnYXR0cmlidXRlJzogcm93WycgYXR0ciddLnN0cmlwKCkKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiBsaW5lX2NvdW50ID4gMCBhbmQgY3VyRW50cnlbJ29wZXJhdGlvbiddICE9IG9wZXJhdGlvbiBhbmQgY3VyRW50cnlbJ2F0dHJpYnV0ZSddICE9IGxheWVyQXR0cjoKICAgICAgICAgICAgICAgICMgS2V5ICosIGNlbGwsIG51bGwsIG9wZXJhdGlvbiwgYXR0ciwKICAgICAgICAgICAgICAgIGVsZW1lbnRzLmFwcGVuZChjdXJFbnRyeVsnY2VsbFR5cGUnXSkKICAgICAgICAgICAgICAgIGVsZW1lbnRzLmFwcGVuZChjdXJFbnRyeVsnbnVsbFZhbHVlJ10pCiAgICAgICAgICAgICAgICBlbGVtZW50cy5hcHBlbmQoY3VyRW50cnlbJ29wZXJhdGlvbiddKQogICAgICAgICAgICAgICAgZWxlbWVudHMuYXBwZW5kKGN1ckVudHJ5WydhdHRyaWJ1dGUnXSkKICAgICAgICAgICAgbGluZV9jb3VudCArPSAxCiAgICAgICAgd2l0aCBvcGVuKGpzb25QYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGpzb25GaWxlOgogICAgICAgICAgICBqc29uRmlsZS53cml0ZShqc29uLmR1bXBzKGVsZW1lbnRzKSkKICAgICAgICBjc3ZGaWxlLmNsb3NlKCkKCmNsYXNzIFdNU0JCb3goKToKICAgIHhNYXggPSBOb25lCiAgICBkZWYgeE1heGltdW0oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYueE1heAoKICAgIHhNaW4gPSBOb25lCiAgICBkZWYgeE1pbmltdW0oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYueE1pbgoKICAgIHlNYXggPSBOb25lCiAgICBkZWYgeU1heGltdW0oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYueU1heAoKICAgIHlNaW4gPSBOb25lCiAgICBkZWYgeU1pbmltdW0oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYueU1pbgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB4TWF4LCB4TWluLCB5TWF4LCB5TWluKToKICAgICAgICBzZWxmLnhNYXggPSB4TWF4CiAgICAgICAgc2VsZi54TWluID0geE1pbgogICAgICAgIHNlbGYueU1heCA9IHlNYXgKICAgICAgICBzZWxmLnlNaW4gPSB5TWluCgoKZGVmIGNoZWNrR2l0RXhlY3V0YWJsZShnaXRFeGUpOgogICAgaWYgbm90IGdpdEV4ZSBvciBub3Qgb3MucGF0aC5pc2ZpbGUoZ2l0RXhlKToKICAgICAgICBRTWVzc2FnZUJveC5lcnJvcigiU2VsZWN0IHlvdXIgZ2l0IGV4ZWN1dGFibGUgcHJvZ3JhbS5cbiIgKyBzdHIoCiAgICAgICAgICAgIGdpdEV4ZSkgKyAiXG5JdCBjYW4gYmUgZG93bmxvYWRhYmxlIGF0OiBodHRwczovL2dpdC1zY20uY29tL2Rvd25sb2FkcyIpCiAgICAgICAgZXhpdCgxKQoKZGVmIHdyaXRlTGVnZW5kSnNvbihtYXBEaXIsIGxlZ2VuZE9iaik6CiAgICBjb250ZW50ID0gW10KICAgIGZvciBsZWdlbmQgaW4gbGVnZW5kT2JqOgogICAgICAgIGNvbnRlbnQuYXBwZW5kKHsiY29sb3IiOiBbbGVnZW5kLnJlZCwgbGVnZW5kLmdyZWVuLCBsZWdlbmQuYmx1ZV0sICJ0aXRsZSI6IGxlZ2VuZC5jYXRlZ29yeU5hbWV9KQogICAganNvbkZpbGUgPSBQYXRoKG9zLnBhdGguam9pbihtYXBEaXIsICJsZWdlbmQuanNvbiIpKQogICAganNvbkZpbGUud3JpdGVfdGV4dChqc29uLmR1bXBzKGNvbnRlbnQpLCBlbmNvZGluZz0idXRmLTgiKQoKZGVmIGdldExlZ2VuZEZyb21QYXRoKHNsZFBhdGgpOgogICAgcmV0dXJuIHJlYWRMZWdlbmQoc2xkUGF0aCkKCmRlZiBwdWJsaXNoTWFwcyhnaXRFeGUsIGdoVXNlciwgZ2hQYXNzd29yZCwgbXVzdEFza1VzZXIsIGdpdFJlcG9zaXRvcnksIG91dHB1dERpciwgaW5wdXRfZmlsZSwgbGF5ZXJBdHRyLCBvcGVyYXRpb24sIG1heF96b29tLCBkb3dubG9hZExpbmssIGNlbGxUeXBlLCBudWxsVmFsdWUsIG9wZW5JbkJyb3dzZXIsIGxlZ2VuZE9iaiwgZmlsZW5hbWVUaXRsZSk6CiAgICBnaXRFeGUgPSBnaXRFeGUgaWYgb3MucGF0aC5pc2ZpbGUoZ2l0RXhlKSBlbHNlIFVUSUxTLndoaWNoKCJnaXQuZXhlIikgICMgRGFuaWxvIHRlc3RhciBxbmQgbsOjbyBhY2hhIG8gZ2l0LmV4ZQogICAgZm91bmRHaXQgPSAnJwogICAgZ2l0RXhlID0gR2l0SHViLmZpbmRHaXRFeGUoZ2l0RXhlLCBmb3VuZEdpdCwgbXVzdEFza1VzZXIpCiAgICBjaGVja0dpdEV4ZWN1dGFibGUoZ2l0RXhlKQogICAgRmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJHaXQgZXhlY3V0YWJsZSBwYXRoIGZvdW5kOiAiICsgZ2l0RXhlKQogICAgZ2hVc2VyLCBnaFBhc3N3b3JkID0gR2l0SHViLmdldEdpdENyZWRlbnRpYWxzKGdoVXNlciwgZ2hQYXNzd29yZCwgbXVzdEFza1VzZXIpCiAgICBpZiBnaFVzZXIgaXMgTm9uZSBvciBnaFBhc3N3b3JkIGlzIE5vbmU6CiAgICAgICAgUU1lc3NhZ2VCb3guZXJyb3IoIkVycm9yOiBHaXRodWIgY3JlZGVudGlhbHMgZmFpbGVkIHRvIGF1dGhlbnRpY2F0ZS4iKQogICAgICAgIGV4aXQoMSkKICAgIEZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiQXV0aGVudGljYXRpb24gQ29uZmlybWVkOiAiICsgZ2l0RXhlKQoKICAgIGlmIG5vdCBHaXRIdWIuZXhpc3RzUmVwb3NpdG9yeShnaFVzZXIsIGdpdFJlcG9zaXRvcnkpIGFuZCBub3QgR2l0SHViLmNyZWF0ZVJlcG8oZ2l0UmVwb3NpdG9yeSwgZ2hVc2VyLCBnaFBhc3N3b3JkLCBGZWVkYmFjaygpKToKICAgICAgICBRTWVzc2FnZUJveC5lcnJvcigKICAgICAgICAgICAgIkVycm9yOiBGYWlsZWQgdG8gY3JlYXRlIHRoZSByZXBvc2l0b3J5ICIgKyBnaXRSZXBvc2l0b3J5ICsgIi5cblBsZWFzZSBjcmVhdGUgYSBvbmUgYXQ6IGh0dHBzOi8vZ2l0aHViLmNvbS9uZXciKQogICAgICAgIGV4aXQoMSkKCiAgICBHaXRIdWIucHJlcGFyZUVudmlyb25tZW50KGdpdEV4ZSkKICAgIGlmIG5vdCBHaXRIdWIuaXNPcHRpb25zT2sob3V0cHV0RGlyLCBnaFVzZXIsIGdpdFJlcG9zaXRvcnksIEZlZWRiYWNrKCksIGdoUGFzc3dvcmQsIG11c3RBc2tVc2VyKToKICAgICAgICBRTWVzc2FnZUJveC5lcnJvcigiRXJyb3I6IENhbmNlbGluZyB0aGUgZXhlY3V0aW9uLCBwbGVhc2Ugc2VsZWN0IGFub3RoZXIgb3V0cHV0IGZvbGRlci4iKQogICAgICAgIGV4aXQoMSkKCiAgICAjIGZpbGVOYW1lID0gb3MucGF0aC5iYXNlbmFtZShpbnB1dF9maWxlKQogICAgIyBmaWxlTmFtZVdpdGhvdXRFeHQgPSBvcy5wYXRoLnNwbGl0ZXh0KGZpbGVOYW1lKVswXQogICAgbGF5ZXJUaXRsZSA9IFVUSUxTLm5vcm1hbGl6ZU5hbWUoZmlsZW5hbWVUaXRsZSkKICAgIG1hcERpciA9IG9zLnBhdGguam9pbihvdXRwdXREaXIsIGxheWVyVGl0bGUsIGxheWVyQXR0ciwgb3BlcmF0aW9uKQogICAgZGVzY3JpcHRpb25EaXIgPSBvcy5wYXRoLmpvaW4ob3V0cHV0RGlyLCBsYXllclRpdGxlLCBsYXllckF0dHIpCgogICAgZ2VuZXJhdGVUaWxlRm9yTWFwKGlucHV0X2ZpbGUsIG1hcERpciwgbWF4X3pvb20sIHJlc3VtZT1GYWxzZSwgbGVnZW5kT2JqPWxlZ2VuZE9iaikgI3Byb2Nlc3NhciBvcyB0aWxlcwogICAgV01TQ2FwYWJpbGl0aWVzLndyaXRlX2Rlc2NyaXB0aW9uKGRlc2NyaXB0aW9uRGlyLCBsYXllclRpdGxlLCBsYXllckF0dHIsIGNlbGxUeXBlLCBudWxsVmFsdWUsIG9wZXJhdGlvbikKICAgIHdyaXRlTGVnZW5kSnNvbihtYXBEaXIsIGxlZ2VuZE9iaikKICAgIGxheWVyRXh0ZW50cyA9IFdNU0JCb3goKkdEQUxfVVRJTFMuZ2V0RXh0ZW50KGlucHV0X2ZpbGUpKQogICAgbGF5ZXJNZXJjYXRvckV4dGVudHMgPSBXTVNCQm94KCpHREFMX1VUSUxTLmdldEV4dGVudChpbnB1dF9maWxlLCA0MzI2KSkKICAgIFdNU0NhcGFiaWxpdGllcy51cGRhdGVYTUwob3V0cHV0RGlyLCBsYXllckV4dGVudHMsIGxheWVyTWVyY2F0b3JFeHRlbnRzLCBGYWxzZSwgbGF5ZXJUaXRsZSwgbGF5ZXJBdHRyLCBtYXhfem9vbSwgZG93bmxvYWRMaW5rKQogICAgR2l0SHViLnB1Ymxpc2hUaWxlc1RvR2l0SHViKG91dHB1dERpciwgZ2hVc2VyLCBnaXRSZXBvc2l0b3J5LCBGZWVkYmFjaygpLCB2ZXJzaW9uLCBnaFBhc3N3b3JkKQogICAgaWYgb3BlbkluQnJvd3NlcjoKICAgICAgICBzdG9yZVVybCA9IEdpdEh1Yi5nZXRHaXRVcmwoZ2hVc2VyLCBnaXRSZXBvc2l0b3J5KQogICAgICAgIGN1ck1hcHNVcmwgPSAiaHR0cHM6Ly9tYXBzLmNzci51Zm1nLmJyL2NhbGN1bGF0b3IvP3F1ZXJ5aWQ9MTUyJnN0b3JldXJsPSIgKyBzdG9yZVVybCArICIvJnJlbW90ZW1hcD0iICsgIkdIOiIgKyBsYXllclRpdGxlICsgIjsiICsgbGF5ZXJBdHRyCiAgICAgICAgd2ViYnJvd3Nlci5vcGVuX25ldyhjdXJNYXBzVXJsKQogICAgIyAjR2VyYSBUaHVtYm5haWw/CgpjdXJVc2VyID0gTm9uZQpnaFBhc3N3b3JkID0gTm9uZQptdXN0QXNrVXNlciA9IEZhbHNlCmdpdEV4ZSA9ICcnCmxheWVyQXR0ciA9ICcxJwpvcGVyYXRpb24gPSAncmdiYScKZG93bmxvYWRMaW5rID0gTm9uZQpjZWxsVHlwZSA9ICdpbnQzMicKbnVsbFZhbHVlID0gLTEyOApvcGVuSW5Ccm93c2VyID0gVHJ1ZQoKCmNsYXNzIERpbmFtaWNhQ2xhc3M6CiAgICBpbnB1dHMgPSBOb25lCmRpbmFtaWNhID0gRGluYW1pY2FDbGFzcygpCmRpbmFtaWNhLmlucHV0cyA9IHsidjEiOiA0LjAsICJzMSI6ICJDOi9Vc2Vycy9EYW5pbG8vQXBwRGF0YS9Mb2NhbC9UZW1wL0VHTzk2RDcudG1wX1RFTVBcXEVHT1RtcF8zNl8udGlmIiwgInMyIjogIk1hcHBpYV9EaW5hbWljYTIiLCAiczMiOiAiQzovVXNlcnMvRGFuaWxvL0FwcERhdGEvTG9jYWwvVGVtcC90ZXN0ZTIiLCAiczQiOiAib3V0cm8yIiwgInQxIjogW1siQ2F0ZWdvcnkiLCAiRnJvbSIsICJUbyIsICJDYXRlZ29yeV9OYW1lIiwgInJlZCIsICJncmVlbiIsICJibHVlIl0sIFsxLjAsICIwLjExNjYiLCAiMC4zNTQ4IiwgIjAuMTE2NiBcdTIwMTMgMC4zNTQ4IiwgMC4wLCAwLjAsIDI1NS4wXSwgWzIuMCwgIjAuMzU0OSIsICIwLjU4NjgiLCAiMC4zNTQ5IFx1MjAxMyAwLjU4NjgiLCAwLjAsIDEwNy4wLCAyNTUuMF0sIFszLjAsICIwLjU4NjkiLCAiMC43NzgzIiwgIjAuNTg2OSBcdTIwMTMgMC43NzgzIiwgMC4wLCAyMTguMCwgMjU1LjBdLCBbNC4wLCAiMC43Nzg0IiwgIjAuOTAwNiIsICIwLjc3ODQgXHUyMDEzIDAuOTAwNiIsIDcxLjAsIDI1NS4wLCAxODQuMF0sIFs1LjAsICIwLjkwMDciLCAiMC45NjAwIiwgIjAuOTAwNyBcdTIwMTMgMC45NjAwIiwgMTgyLjAsIDI1NS4wLCA3My4wXSwgWzYuMCwgIjAuOTYwMSIsICIwLjk5NDAiLCAiMC45NjAxIFx1MjAxMyAwLjk5NDAiLCAyNTUuMCwgMjIwLjAsIDAuMF0sIFs3LjAsICIwLjk5NDEiLCAiMS4wIiwgIjAuOTk0MSBcdTIwMTMgMS4wIiwgMjU1LjAsIDEwOS4wLCAwLjBdXX0KCgppZiBpc0RpbmFtaWNhIG9yIFRydWU6CiAgICBwcmludChqc29uLmR1bXBzKGRpbmFtaWNhLmlucHV0cykpCiAgICBtYXhfem9vbSA9IGludChyb3VuZChkaW5hbWljYS5pbnB1dHNbInYxIl0pKSAgIyA3CiAgICBnaXRSZXBvc2l0b3J5ID0gZGluYW1pY2EuaW5wdXRzWyJzMiJdICAjICdNYXBwaWFfRXhhbXBsZV9wNicKICAgIG91dHB1dERpciA9IGRpbmFtaWNhLmlucHV0c1siczMiXSArICJcXCIgICMgJ0M6XFxVc2Vyc1xcRGFuaWxvXFxBcHBEYXRhXFxMb2NhbFxcVGVtcFxcb3V0cHV0RGlyXFwnCiAgICAjc2xkUGF0aCA9IGRpbmFtaWNhLmlucHV0c1siczQiXSAgIyAnSTpcXERhbmlsb1xcVHJhbXBvXFxkYXRhX2RpclxcZGF0YVxcbGF1cmVsXFxsYW5kX3VzZV8xOTkyXzIwMTVcXGxhbmRfdXNlXzE5OTJfMjAxNV83LnNsZCcKICAgIHJlYWxGaWxlTmFtZSA9IGRpbmFtaWNhLmlucHV0c1siczQiXQogICAgaW5wdXRfZmlsZSA9IGRpbmFtaWNhLmlucHV0c1siczEiXSAgIyAiRjpcXERhbmlsb1xcVHJhbXBvXFxkYXRhX2RpclxcZGF0YVxcdGVzdGVcXGl5aWVsZF9ydWJiZXIyLnRpZiIgI2l5aWVsZF9ydWJiZXIudGlmIiAjIkY6XFxEYW5pbG9cXFRyYW1wb1xcZGF0YV9kaXJcXGRhdGFcXHRlc3RlXFxieWllbGRfcnViYmVyLnRpZiIgIyJGOlxcRGFuaWxvXFxUcmFtcG9cXGRhdGFfZGlyXFxkYXRhXFxyZW1hbmVzY2VudGVzX2Zsb3Jlc3RhaXNfZGVzbWF0YW1lbnRvXFxicmFzaWxcXHBlcmRhX2NvYmVydHVyYV92ZWdldGFsX2Fub19oYW5zZW5cXGxvc3N5ZWFyLnZydCIjIkY6XFxEYW5pbG9cXFRyYW1wb1xcZGF0YV9kaXJcXGRhdGFcXHJlbWFuZXNjZW50ZXNfZmxvcmVzdGFpc19kZXNtYXRhbWVudG9cXGJyYXNpbFxccGVyZGFfY29iZXJ0dXJhX3ZlZ2V0YWxfYW5vX2hhbnNlblxcbG9zc3llYXIudGlmIiAjIkY6XFxEYW5pbG9cXFRyYW1wb1xcZGF0YV9kaXJcXGRhdGFcXHJlbWFuZXNjZW50ZXNfZmxvcmVzdGFpc19kZXNtYXRhbWVudG9cXGJyYXNpbFxccHJvZGVzXFxwcm9kZXMudnJ0IiAjIkY6XFxEYW5pbG9cXFRyYW1wb1xcZGF0YV9kaXJcXGRhdGFcXHJlbWFuZXNjZW50ZXNfZmxvcmVzdGFpc19kZXNtYXRhbWVudG9cXGJyYXNpbFxccGVyZGFfY29iZXJ0dXJhX3ZlZ2V0YWxfYW5vX2hhbnNlblxcbG9zc3llYXIudGlmIgogICAgY3N2SW5wdXQgPSBkaW5hbWljYS5pbnB1dHNbJ3QxJ10KICAgIGxlZ2VuZE9iaiA9IHByZXBhcmVMZWdlbmQoY3N2SW5wdXQpCiAgICBwcmludCgiaXNEaW5hbWljYSIpCmVsc2U6CiAgICBnaXRSZXBvc2l0b3J5ID0gJ01hcHBpYV9FeGFtcGxlX3A2JwogICAgbWF4X3pvb20gPSA2CiAgICBvdXRwdXREaXIgPSAnQzpcXFVzZXJzXFxEYW5pbG9cXEFwcERhdGFcXExvY2FsXFxUZW1wXFxvdXRwdXREaXJcXCcKICAgIGlucHV0X2ZpbGUgPSAiRjpcXERhbmlsb1xcVHJhbXBvXFxkYXRhX2RpclxcZGF0YVxcdGVzdGVcXGl5aWVsZF9ydWJiZXIyLnRpZiIgICMgaXlpZWxkX3J1YmJlci50aWYiICMiRjpcXERhbmlsb1xcVHJhbXBvXFxkYXRhX2RpclxcZGF0YVxcdGVzdGVcXGJ5aWVsZF9ydWJiZXIudGlmIiAjIkY6XFxEYW5pbG9cXFRyYW1wb1xcZGF0YV9kaXJcXGRhdGFcXHJlbWFuZXNjZW50ZXNfZmxvcmVzdGFpc19kZXNtYXRhbWVudG9cXGJyYXNpbFxccGVyZGFfY29iZXJ0dXJhX3ZlZ2V0YWxfYW5vX2hhbnNlblxcbG9zc3llYXIudnJ0IiMiRjpcXERhbmlsb1xcVHJhbXBvXFxkYXRhX2RpclxcZGF0YVxccmVtYW5lc2NlbnRlc19mbG9yZXN0YWlzX2Rlc21hdGFtZW50b1xcYnJhc2lsXFxwZXJkYV9jb2JlcnR1cmFfdmVnZXRhbF9hbm9faGFuc2VuXFxsb3NzeWVhci50aWYiICMiRjpcXERhbmlsb1xcVHJhbXBvXFxkYXRhX2RpclxcZGF0YVxccmVtYW5lc2NlbnRlc19mbG9yZXN0YWlzX2Rlc21hdGFtZW50b1xcYnJhc2lsXFxwcm9kZXNcXHByb2Rlcy52cnQiICMiRjpcXERhbmlsb1xcVHJhbXBvXFxkYXRhX2RpclxcZGF0YVxccmVtYW5lc2NlbnRlc19mbG9yZXN0YWlzX2Rlc21hdGFtZW50b1xcYnJhc2lsXFxwZXJkYV9jb2JlcnR1cmFfdmVnZXRhbF9hbm9faGFuc2VuXFxsb3NzeWVhci50aWYiCiAgICBzbGRQYXRoID0gJ0k6XFxEYW5pbG9cXFRyYW1wb1xcZGF0YV9kaXJcXGRhdGFcXGxhdXJlbFxcbGFuZF91c2VfMTk5Ml8yMDE1XFxsYW5kX3VzZV8xOTkyXzIwMTVfNy5zbGQnCiAgICBsZWdlbmRPYmogPSBnZXRMZWdlbmRGcm9tUGF0aChzbGRQYXRoKQogICAgcmVhbEZpbGVOYW1lID0gJ2xhbmRfdXNlXzE5OTJfMjAxNV83JwogICAgcHJpbnQoImlzTm90RGluYW1pY2EiKQoKCiMgaWYgX19uYW1lX18gPT0gJ19fbWFpbl9fJzoKIyByZWFsRmlsZU5hbWUKcHVibGlzaE1hcHMoZ2l0RXhlLCBjdXJVc2VyLCBnaFBhc3N3b3JkLCBtdXN0QXNrVXNlciwgZ2l0UmVwb3NpdG9yeSwgb3V0cHV0RGlyLCBpbnB1dF9maWxlLCBsYXllckF0dHIsIG9wZXJhdGlvbiwgbWF4X3pvb20sIGRvd25sb2FkTGluaywgY2VsbFR5cGUsIG51bGxWYWx1ZSwgb3BlbkluQnJvd3NlciwgbGVnZW5kT2JqLCByZWFsRmlsZU5hbWUpCgp0cnk6CiAgICBkaW5hbWljYS5vdXRwdXRzWydvdXQnXSA9IDEKZXhjZXB0OgogICAgcGFzcw==&quot;</inputport>
        <outputport name="result" id="v13" />
        <functor name="NumberString">
            <property key="dff.functor.alias" value="numberString2728" />
            <inputport name="value" peerid="v15" />
            <inputport name="valueNumber">1</inputport>
        </functor>
        <functor name="NumberString">
            <property key="dff.functor.alias" value="numberString2729" />
            <inputport name="value" peerid="v14" />
            <inputport name="valueNumber">2</inputport>
        </functor>
        <functor name="NumberValue">
            <property key="dff.functor.alias" value="numberValue2731" />
            <inputport name="value" peerid="v2" />
            <inputport name="valueNumber">1</inputport>
        </functor>
        <functor name="NumberString">
            <property key="dff.functor.alias" value="numberString2733" />
            <inputport name="value" peerid="v19" />
            <inputport name="valueNumber">3</inputport>
        </functor>
        <functor name="NumberTable">
            <property key="dff.functor.alias" value="numberTable2737" />
            <inputport name="table" peerid="v16" />
            <inputport name="tableNumber">1</inputport>
        </functor>
        <functor name="NumberString">
            <property key="dff.functor.alias" value="numberString2743" />
            <inputport name="value" peerid="v4" />
            <inputport name="valueNumber">4</inputport>
        </functor>
    </containerfunctor>
    <containerfunctor name="Group">
        <property key="dff.functor.alias" value="group2736" />
        <inputport name="sequenceInput">.none</inputport>
        <functor name="String">
            <property key="dff.functor.alias" value="gitRepository" />
            <property key="dff.functor.comment" value="Value or constant representing string." />
            <property key="submodel.in.constant.advanced" value="yes" />
            <property key="submodel.in.constant.description" value="Value or constant representing string." />
            <property key="submodel.in.constant.name" value="gitRepositoryName" />
            <property key="submodel.in.constant.optional" value="yes" />
            <property key="submodel.in.constant.order" value="5" />
            <inputport name="constant">$&quot;(Mappia_Dinamica)&quot;</inputport>
            <outputport name="object" id="v14" />
        </functor>
        <functor name="String">
            <property key="dff.functor.alias" value="input_file" />
            <inputport name="constant" peerid="v12" />
            <outputport name="object" id="v15" />
        </functor>
        <functor name="Table">
            <property key="dff.functor.alias" value="sldCsv" />
            <inputport name="constant" peerid="v5" />
            <outputport name="object" id="v16" />
        </functor>
    </containerfunctor>
    <containerfunctor name="Group">
        <property key="dff.functor.alias" value="verifyInputs" />
        <inputport name="sequenceInput">.none</inputport>
        <functor name="Table">
            <property key="dff.functor.alias" value="Raster Palette Csv" />
            <property key="dff.functor.comment" value='A CSV with the columns:&#x0A;&quot;Category*, From, To, Category_Name, red, green, blue, &quot;' />
            <property key="dff.functor.extendedcomment" value="EX:&#x0A;Category*, From, To, Category_Name, red, green, blue,&#x0A;0, -99, -99, Non-forest, 178, 178, 178,&#x0A;1, 0, 1.0, Forest, 0, 0, 255,&#x0A;2, 1.01, 2.00, River, 51, 194, 255," />
            <property key="submodel.in.constant.advanced" value="yes" />
            <property key="submodel.in.constant.description" value='A CSV with the columns:&#x0A;&quot;Category*, From, To, Category_Name, red, green, blue, &quot;' />
            <property key="submodel.in.constant.name" value="rasterPaletteCsv" />
            <property key="submodel.in.constant.optional" value="yes" />
            <property key="submodel.in.constant.order" value="3" />
            <inputport name="constant">[&#x0A;    &quot;Category*&quot;, &quot;From&quot;, &quot;To&quot;, &quot;Category_Name#str&quot;, &quot;red&quot;, &quot;green&quot;, &quot;blue&quot;, &#x0A;]</inputport>
            <outputport name="object" id="v17" />
        </functor>
        <functor name="ExtractStructNumber">
            <property key="dff.functor.alias" value="isCsvValid" />
            <inputport name="struct" peerid="v22" />
            <inputport name="name">$&quot;(result)&quot;</inputport>
            <outputport name="number" id="v18" />
        </functor>
        <functor name="String">
            <property key="dff.functor.alias" value="outputDir" />
            <property key="dff.functor.comment" value="A Directory EMPTY or With a repository already.&#x0A;The directory to save the publishing tiles.&#x0A;* Only use the same directory when using the same &apos;GitRepository&apos;.&#x0A;* On new repository please use a empty folder." />
            <property key="submodel.in.constant.advanced" value="no" />
            <property key="submodel.in.constant.description" value="A Directory EMPTY or With a repository already.&#x0A;The directory to save the publishing tiles.&#x0A;* Only use the same directory when using the same &apos;GitRepository&apos;.&#x0A;* On new repository please use a empty folder." />
            <property key="submodel.in.constant.name" value="outputDir" />
            <property key="submodel.in.constant.optional" value="no" />
            <property key="submodel.in.constant.order" value="2" />
            <outputport name="object" id="v19" />
        </functor>
        <functor name="ExtractStructNumber">
            <property key="dff.functor.alias" value="extractStructNumber3616" />
            <inputport name="struct" peerid="v23" />
            <inputport name="name">$&quot;(isdir)&quot;</inputport>
            <outputport name="number" id="v20" />
        </functor>
        <functor name="ExtractStructNumber">
            <property key="dff.functor.alias" value="isEmpty" />
            <inputport name="struct" peerid="v22" />
            <inputport name="name">$&quot;(isempty)&quot;</inputport>
            <outputport name="number" id="v21" />
        </functor>
        <containerfunctor name="CalculatePythonExpression">
            <property key="dff.container.collapsed" value="no" />
            <property key="dff.functor.alias" value="calculatePythonExpression3614" />
            <inputport name="expression">&quot;aW1wb3J0IGpzb24KY3N2TGVnZW5kID0gZGluYW1pY2EuaW5wdXRzWyJ0MSJdCgpoZWFkID0gY3N2TGVnZW5kWzBdCnByaW50KGhlYWQpCnJlc3VsdCA9IE5vbmUKIydDYXRlZ29yeScsICdGcm9tJywgJ1RvJywgJ0NhdGVnb3J5X05hbWUnLCAncmVkJywgJ2dyZWVuJywgJ2JsdWUnCmlmICJDYXRlZ29yeSIgbm90IGluIGhlYWQgb3IgIkZyb20iIG5vdCBpbiBoZWFkIG9yICJUbyIgbm90IGluIGhlYWQgb3IgIkNhdGVnb3J5X05hbWUiIG5vdCBpbiBoZWFkIG9yICJyZWQiIG5vdCBpbiBoZWFkIG9yICJncmVlbiIgbm90IGluIGhlYWQgb3IgImJsdWUiIG5vdCBpbiBoZWFkOgoJcHJpbnQoIkVycm9yLCBpbiBSYXN0ZXIgUGFsZXR0ZSBDU1YuIFRoZSB0YWJsZSBtdXN0IGhhdmUgZXhhY3RseSB0aGUgZm9ybWF0IG9mLCBjb2x1bW5zOlxuXG4nQ2F0ZWdvcnkqLCBGcm9tLCBUbywgQ2F0ZWdvcnlfTmFtZSwgcmVkLCBncmVlbiwgYmx1ZSciKQoJcHJpbnQoIllvdSBjYW4gbGVhdmUgaXQgZW1wdHkgdG8gY3JlYXRlIGl0IGF1dG9tYXRpY2FsbHkiKQoJcmVzdWx0ID0gMAplbHNlOgoJcmVzdWx0ID0gMQoJCmRpbmFtaWNhLm91dHB1dHNbJ3Jlc3VsdCddID0gcmVzdWx0CmRpbmFtaWNhLm91dHB1dHNbJ2lzZW1wdHknXSA9IDAgaWYgbGVuKGNzdkxlZ2VuZCkgPiAxIGVsc2UgMQ==&quot;</inputport>
            <outputport name="result" id="v22" />
            <functor name="NumberTable">
                <property key="dff.functor.alias" value="numberTable3615" />
                <inputport name="table" peerid="v17" />
                <inputport name="tableNumber">1</inputport>
            </functor>
        </containerfunctor>
        <containerfunctor name="CalculatePythonExpression">
            <property key="dff.container.collapsed" value="no" />
            <property key="dff.functor.alias" value="calculatePythonExpression4047" />
            <inputport name="expression">&quot;aW1wb3J0IG9zCnRyeToKCW9zLm1ha2VkaXJzKGRpbmFtaWNhLmlucHV0c1siczEiXSwgZXhpc3Rfb2s9VHJ1ZSkKZXhjZXB0OgoJcGFzcwpkaW5hbWljYS5vdXRwdXRzWydpc2RpciddID0gMSBpZiBvcy5wYXRoLmlzZGlyKGRpbmFtaWNhLmlucHV0c1siczEiXSkgZWxzZSAw&quot;</inputport>
            <outputport name="result" id="v23" />
            <functor name="NumberString">
                <property key="dff.functor.alias" value="numberString4049" />
                <inputport name="value" peerid="v19" />
                <inputport name="valueNumber">1</inputport>
            </functor>
        </containerfunctor>
        <containerfunctor name="IfNotThen">
            <property key="dff.functor.alias" value="ifNotThen3619" />
            <inputport name="condition" peerid="v20" />
            <functor name="Exit">
                <property key="dff.functor.alias" value="exit3618" />
                <inputport name="message">$&quot;(Please select a output directory that exists.)&quot;</inputport>
            </functor>
        </containerfunctor>
        <containerfunctor name="IfNotThen">
            <property key="dff.functor.alias" value="ifNotThen43513" />
            <inputport name="condition" peerid="v21" />
            <functor name="Table">
                <property key="dff.functor.alias" value="table41963" />
                <property key="viewer.object" value="yes" />
                <inputport name="constant" peerid="v17" />
                <outputport name="object" id="v24" />
            </functor>
            <containerfunctor name="IfNotThen">
                <property key="dff.functor.alias" value="ifNotThen3619" />
                <inputport name="condition" peerid="v18" />
                <functor name="Exit">
                    <property key="dff.functor.alias" value="exit3618" />
                    <inputport name="message">$&quot;(Error, in Raster Palette CSV. The table must have exactly the format of, columns:\n\n&apos;Category*, From, To, Category_Name, red, green, blue&apos;)&quot;</inputport>
                </functor>
            </containerfunctor>
        </containerfunctor>
    </containerfunctor>
    <containerfunctor name="IfThen">
        <property key="dff.functor.alias" value="ifThen143662" />
        <inputport name="condition" peerid="v21" />
        <functor name="CreateLegendFromQntEntry">
            <property key="dff.functor.alias" value="createLegendFromQntEntry138052" />
            <property key="submodel.in.maximumnumberofcategories.advanced" value="no" />
            <property key="submodel.in.maximumnumberofcategories.description" value="Maximum number of categories in the resulting categorization." />
            <property key="submodel.in.maximumnumberofcategories.name" value="maximumNumberOfCategories" />
            <property key="submodel.in.maximumnumberofcategories.optional" value="yes" />
            <property key="submodel.in.maximumnumberofcategories.order" value="7" />
            <property key="viewer.categoriesascsv" value="yes" />
            <property key="viewer.generatedcategories" value="yes" />
            <inputport name="inputMap" peerid="v3" />
            <inputport name="MaximumNumberOfCategories">8</inputport>
            <outputport name="categoriesAsCsv" id="v25" />
        </functor>
    </containerfunctor>
</script>
