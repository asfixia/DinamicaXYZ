<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<script>
    <property key="dff.charset" value="windows-1252" />
    <property key="dff.date" value="2020-Jul-20 20:45:48" />
    <property key="dff.version" value="5.1.0.20200628" />
    <property key="submodel.description" value="Pluguin to publish your maps online. (Experimental)&#x0A;windows only for now" />
    <property key="submodel.documentation" value="https://mappia.earth/mappia_publisher/" />
    <property key="submodel.group" value="Web" />
    <property key="submodel.import" value='CreateLegendFromQntEntry { { &quot;inputMap&quot; : Map, &quot;MaximumNumberOfCategories&quot; : PositiveIntegerValue } { } { &quot;categoriesAsCsv&quot; : Table, &quot;generatedCategories&quot; : Categorization } }' />
    <property key="submodel.largeicon" value="iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAHuklEQVR42rVXCVCU5xmGNk0iVmLwBooCixwL7P57sPe9/7H3fR+wB9dyLofVig4ahLCLmhAp5hKNxsQmsWiiBicSDjUHU0OTpk47aae2TUwnbSedSqaxU+n3o2t2WTZCMn4z3+z/v9//fu/zvcfzfpuUtPTxQG4pXyyxB4YU/ta3yBJ1edLKlSuT7udI31xSwFQ6W2TetiNslXMScTcOs9XuFpJQrsQ8zWGmyjHKkFtHhGZ/ZwFDjACV5O9tNC0tLVXpbz9tatkzIfe3X9M3dr5PEStViTZfvmbNeobM3Fe+a+AG7KqfNjTvfpMk0qDf1f6PJLaal2Te4AWRpWqco3FfLGJIuoXW6iGG3DIqNPm7soiMIvDdo9kUDo9n8u2lIcYRibPu2RIuelZkrZo0Bvf8BfMEr+Qx+YVLNf4QMP4K7Gw4AZ5XgY3PbSykbuBqykc5SkcNkD3IUtrdfL33FFdXMQFO+xJFpDWnZRAyxdaa1wVm//Gk5cvXcbTuaRqskfONvsvZhdDGxZnetOlhiSNwEnYGjuLJhovIItVF/Hf16tUrgCdOcXTOPfPDUMKW81F34xWW2rENX8vII5PB6S/ja5BIJSjDLKObiMT132o7P780Gy1vPiu21x6KGMcH7n7c1ZEK4GhdQzyd5zAeJtwYCEmT3Nf2EVWqVkR0SvlKt6Lyp0ORdxJfhQiM/suFTKk0IQBdQ+cY5mn5OIdIzIqWI+VNJwkQSxAlSgYn7Yad9SMyb+srQGcyh8zIi9YRGn0d+IzWAe8H/d3PzaSkpKQvCAB21l0isuEWtsrxThlqrom4GS5v6qPB+uqoT38IibUuXf3O3/l7np9hKW09K9LTV0fvhXlaDxdzUDP+TKBziGWY+TRDYTuore/440/yIVqc8XVZWTkCo28yUn5speMZlsrxOn4ypsYV5OrLW/HkZMqtjSyF45LIWnM4n8bvgp2NR/l6z2NstfN9ibX66TwymzznNXfju6nrc+g0zLgPEmtOEVloGS43BLveAom7NQ4A2DgISmd3tIzEU6Bcreddgcl7UmDynwfJOM5Wux5bl5u7Fl8vYsNOzNs6EClbCNa6uFr3mzx9xRlza/enQnPlGwp/kBfjGfC9JrDjZBwAqSPwWh7E5s8nIrbGOVC779hNrr7iKpEpVkWvg1O55d62gZgiKiBvosvM5z27B/8u97RMkHlyTXTFsJSWeteO/j+Dx4djSAfQ6NSdzE/Op0pEPF35IbJQPcpS2dsEJt9QNpFeyVDaXmUqbEfXZhevm8t0bgyAB+hycwcdNY0XC+QwSai4SEGMDrmvfUrmbRkhsrA5RtywsbiwOnzkZmGZ6G7FJM01FkdgmC6z1IJYXhKYfb8oYiKyCHKRpXogl8LF7tS0gYYaJ2mooa6YL/PK/a2DpXyZmCGzvM1QWHbhJHW7DOXj0QkrdQbGxPaaMwVMqdCy5fEPxbZAz10AoPafVVS2fwJiNji/BOdKyuzfHwFwuzOlpzDllr2AH67om3b9FnhvOLuUlh+tAwCMzdsmuVQgU4E8GwMh+Ny+ff+vMwoKVs2tAMIYtm3tuw7i/fiG7MI4ygThCMcAAJtRYaNf6qj70NzWc42psD6F50sMAF4cAJxKV7DUzh3GYNdnnq6n/wDK8TYfFLGlGqmr4Zc0RO/DWypX6zoNerzjDtMBABWhCIAiGh8CFXMO5MJAAY1fDRjwIA6GatVNQ1uxYUovfILSi5yFgthnUBixEvplD60nENYIjJ5ursHzgdRR3w/CN4i6m5+IxrZMbK+7iiPEX7IhLklkrjoA4voOiP/eMtR4JIfE1LMU9n0A4HmQH4w5MEyJA65teIESQsbAnF1w9mA36F7dxxyduz3iJXX11jdKuJgpxjuauo5TTKWjcp7TlrGUjm3VfS/8m6VyXqGjhiYg+8HdBmSXdtB6ZV8lNP7NvEUNI4131H4stdf/Hr8+xMZZ79kGLhyvRssyiRQCKKuX0YrmaUBEU4DBzkFilW2uIfWqV0Dd8OeLMB6Z/6OEETEkVFtxD8TlR8bmMpJ1S+hvOKfjMeNoXAdoiGGkqAzlwY76brw3EEgsiOt1n6A2qz6ldmHXFzJUcaxptu/C4MIgwsg0VtV6APDKzoV6UbJz+/4pwAPH2RrXFF1mqIrwAFbRcmwzTSCjhOCfgY1uJjql58Xm2Rtfz8zi48mx5xb8Bm6qv0ooKWMt2A1Nrd0XsIrge6mpqWnRcrGtZrxkO7/n21zseTE4O/P1V7PRo388HgQrpL9Vukt0mBZGiuMAlPDVfH1D568kttqjkRLEB9ti+wgo/2cpxr8B8Xwi0P+lhOHq+BsZuDZpAh2XYFfDa0mZmcuAKIXRqL+eyLj3eEtC45Hx1MShxIkZQnnxd4Pc0rXqwPZxma/tzCrQ05k79f9IBAD9uW1W9Uz53Lz2z7/GGPYBcJE1aghdUB8KIWcWzIdHsrIeVdVsuwD44Tfc3eYvF1Nqn3zxpxgAioPOxZTnlwnviBkEQqahsfMDpKvmX/cRwI173tSLt3BooARv3ScAE4v6u0ANwYP32oz3hHZW2K+/O2lh9J4AoBBqWBQAYqfpQaDw8hKo996zF9m/5D+M5DCqAcrnQPl88R0NzwDD45ReTB/Z8/9yI4/haFpiAAAAAABJRU5ErkJggg==" />
    <property key="submodel.name" value="MappiaPreviewMapOnline" />
    <property key="submodel.smallicon" value="iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAC4UlEQVR42mNgQANSxsZcbon5PsEFzZkeicXNtsEJpW5R2RHGDr4iDAQAo3tCQb9bfN5Ju+DECQ7hGdF8MjJCweUd2o6R6V2usTmn/bOq1uu5uXFj08zkGpff4RSVYWblF11sF5TUYBuYaO+VVJZhG5Ya7BSe0WPpE+3sGp1dZx+S0gRyJYpur5SyeSDNILZdcFIFyDUg2jetIsU1NneioWeoqEtEhoNncqGvlVugmG96+VqgGjawZhkZGU6nyLR266CEWsfQRHsr39g8C48IBfuQpCqftIqd1gFxTQ7hKRZBuY3pJu5hwUDvFPllVk4x9wvWAxvgEpXnbxMQbwxi2wQml/uklp6y9InKYdDWZrMLSS0HucY2KDHEJ638rGtMbgdYD9A1UeVd+QwQJydWu0ZmRVoHxFba+SeGm3qEVtgExOVbB8ZH24elVtoGxXtb+kdXmHuG17nF5vo6hqd1OYYmewfmNiwDGxCQVX3YOjAuHhYe5t6RWSDawj/KxTe94iowUFNBfEu/mHxYbDmEpRVHV0+4L66nx83gHJ3daBUcH2zlG1MOdFqSiUtgoU1AbJpVQHymXVhCvUmV32qTVs9Hxi2eT0yavBZaRcQ2A2Ms3SEstRtsnF96ZZBPSqUX2Bbf+EjP5KJr1v4x6Q4NDixADXeNutz+I2OzHs8bJkke6r6p5SVgA0S1tXkCc2oXAgOyxjYo2RsUfSY1vi3GLR7PYZqqNrf/n3xoHtwQ6+rQXZZ+EYbwdOCXWbMcmNJMwH4vCluDbCNI899/f/+DwNRD88FiJt0ef4w6XVeZdnlJgA3QBkYZMNHMtAtJcjNr9nkA02w7IfDv3OPL/n//9QNswNIz6/77zoqHG27Y5bYVkRyNjVl9MyqXWbaGfEf399uv78EG2E0M/I8m9wkjUxg1uZehGzDt8IL/80+s/G/e5/0PTW4vZrb6z8Bo1OlWCpS8j24QEv5l1OW+x6DdQwEAz35TFJ4jlw4AAAAASUVORK5CYII=" />
    <functor name="String">
        <property key="dff.functor.alias" value="expressionNotUsed" />
        <inputport name="constant" peerid="v7" />
    </functor>
    <functor name="LoadLookupTable">
        <property key="dff.functor.alias" value="loadTemporaryFilterTable" />
        <inputport name="filename" peerid="v9" />
        <inputport name="suffixDigits">0</inputport>
        <inputport name="step">.none</inputport>
        <inputport name="workdir">.none</inputport>
        <outputport name="table" id="v1" />
    </functor>
    <functor name="IntegerValue">
        <property key="dff.functor.alias" value="Max Zoom" />
        <property key="dff.functor.comment" value="Max zoom of details." />
        <property key="dff.functor.extendedcomment" value="The maximum detail level.&#x0A;* Each increased zoom double the publication time.&#x0A;* https://wiki.openstreetmap.org/wiki/Zoom_levels" />
        <property key="submodel.in.constant.advanced" value="yes" />
        <property key="submodel.in.constant.description" value="Max zoom of details." />
        <property key="submodel.in.constant.name" value="maxZoom" />
        <property key="submodel.in.constant.optional" value="yes" />
        <property key="submodel.in.constant.order" value="4" />
        <inputport name="constant">5</inputport>
        <outputport name="object" id="v2" />
    </functor>
    <functor name="Map">
        <property key="dff.functor.alias" value="Map To Preview" />
        <property key="dff.functor.comment" value="Map to display online." />
        <property key="submodel.in.constant.advanced" value="no" />
        <property key="submodel.in.constant.description" value="Map to display online." />
        <property key="submodel.in.constant.name" value="mapToPreview" />
        <property key="submodel.in.constant.optional" value="no" />
        <property key="submodel.in.constant.order" value="1" />
        <outputport name="object" id="v3" />
    </functor>
    <functor name="ExtractStructNumber">
        <property key="dff.functor.alias" value="extractStructNumber802" />
        <property key="submodel.out.number.description" value="Returns 1 when finish" />
        <property key="submodel.out.number.name" value="output" />
        <property key="submodel.out.number.order" value="1" />
        <inputport name="struct" peerid="v13" />
        <inputport name="name">$&quot;(out)&quot;</inputport>
    </functor>
    <functor name="String">
        <property key="dff.functor.alias" value="Map Filename Or Title" />
        <property key="dff.functor.comment" value="The title or path for the published map." />
        <property key="submodel.in.constant.advanced" value="no" />
        <property key="submodel.in.constant.description" value="The title or path for the published map." />
        <property key="submodel.in.constant.name" value="mapFilenameOrTitle" />
        <property key="submodel.in.constant.optional" value="yes" />
        <property key="submodel.in.constant.order" value="6" />
        <inputport name="constant">$&quot;(New Dinamica Online Example Map)&quot;</inputport>
        <outputport name="object" id="v4" />
    </functor>
    <functor name="TableJunction">
        <property key="dff.functor.alias" value="tableJunction41962" />
        <inputport name="possibleTable1" peerid="v24" />
        <inputport name="possibleTable2" peerid="v25" />
        <outputport name="table" id="v5" />
    </functor>
    <containerfunctor name="CalculateMap">
        <property key="dff.container.collapsed" value="no" />
        <property key="dff.functor.alias" value="calculateMap2703" />
        <inputport name="expression">[&#x0A;    if isNull(i1) then&#x0A;        null&#x0A;    else &#x0A;        t1[&gt;=i1] ? v1&#x0A;]</inputport>
        <inputport name="cellType">.uint8</inputport>
        <inputport name="nullValue">.default</inputport>
        <inputport name="resultIsSparse">.no</inputport>
        <inputport name="resultFormat">.none</inputport>
        <outputport name="result" id="v6" />
        <functor name="NumberMap">
            <property key="dff.functor.alias" value="numberMap2704" />
            <inputport name="map" peerid="v3" />
            <inputport name="mapNumber">1</inputport>
        </functor>
        <functor name="NumberTable">
            <property key="dff.functor.alias" value="numberTable2716" />
            <inputport name="table" peerid="v1" />
            <inputport name="tableNumber">1</inputport>
        </functor>
        <functor name="NumberValue">
            <property key="dff.functor.alias" value="numberValue36570" />
            <inputport name="value" peerid="v10" />
            <inputport name="valueNumber">1</inputport>
        </functor>
    </containerfunctor>
    <containerfunctor name="Group">
        <property key="dff.functor.alias" value="group2717" />
        <inputport name="sequenceInput">.none</inputport>
        <functor name="ExtractStructString">
            <property key="dff.functor.alias" value="extractStructString2706" />
            <inputport name="struct" peerid="v11" />
            <inputport name="name">$&quot;(exp)&quot;</inputport>
            <outputport name="string" id="v7" />
        </functor>
        <functor name="ExtractStructString">
            <property key="dff.functor.alias" value="extractStructString2706" />
            <inputport name="struct" peerid="v11" />
            <inputport name="name">$&quot;(csv)&quot;</inputport>
            <outputport name="string" id="v8" />
        </functor>
        <functor name="SaveTextFile">
            <property key="dff.functor.alias" value="saveTemporaryFilterTable" />
            <inputport name="text" peerid="v8" />
            <inputport name="filename" peerid="v9" />
            <inputport name="suffixDigits">2</inputport>
            <inputport name="step">.none</inputport>
            <inputport name="workdir">.none</inputport>
        </functor>
        <functor name="GenerateTemporaryFile">
            <property key="dff.functor.alias" value="generateTemporaryFile2708" />
            <inputport name="extension">$&quot;(csv)&quot;</inputport>
            <inputport name="createFile">.no</inputport>
            <outputport name="filename" id="v9" />
        </functor>
        <functor name="ExtractStructNumber">
            <property key="dff.functor.alias" value="maxValue" />
            <property key="dff.functor.comment" value="Last else" />
            <inputport name="struct" peerid="v11" />
            <inputport name="name">$&quot;(max)&quot;</inputport>
            <outputport name="number" id="v10" />
        </functor>
        <containerfunctor name="CalculatePythonExpression">
            <property key="dff.container.collapsed" value="no" />
            <property key="dff.functor.alias" value="calculatePythonExpression2698" />
            <inputport name="expression">&quot;aW1wb3J0IGpzb24KY3N2TGVnZW5kID0gZGluYW1pY2EuaW5wdXRzWyJ0MSJdCgpnZW5Dc3YgPSBbJ0NhdGVnb3J5KiwgVG8sJ10KaGVhZCA9IGNzdkxlZ2VuZFswXQpyZXN1bHQgPSBbXQppRWxtID0gMApmb3IgZWxtIGluIGNzdkxlZ2VuZFsxOl06CgljdXJMaW5lID0gJycKCWlmIGxlbihyZXN1bHQpID09IDA6CgkJY3VyTGluZSA9ICdpZiBpMSA8PSAnICsgc3RyKGVsbVtoZWFkLmluZGV4KCdUbycpXSkgKyAnIHRoZW4gJyArIHN0cihpRWxtKQoJZWxpZiBpRWxtICsgMiA9PSBsZW4oY3N2TGVnZW5kKTogIyArMiDDqSBwcSB0aXJhIG8gaGVhZCBkbyBjc3YKCQljdXJMaW5lID0gJ2Vsc2UgJyArIHN0cihpRWxtKQoJZWxzZToKCQljdXJMaW5lID0gJyBlbHNlIGlmIGkxIDw9ICcgKyBzdHIoZWxtW2hlYWQuaW5kZXgoJ1RvJyldKSArICcgdGhlbiAnICsgc3RyKGlFbG0pCglyZXN1bHQuYXBwZW5kKGN1ckxpbmUpCglnZW5Dc3YuYXBwZW5kKHN0cihlbG1baGVhZC5pbmRleCgnVG8nKV0pICsgIiwgIiArIHN0cihpRWxtKSkKCWlFbG0gPSBpRWxtICsgMQpwcmludChqc29uLmR1bXBzKGNzdkxlZ2VuZCkpCnByaW50KCItLS0tLS0tLS0tLS0tLSIpCnByaW50KCdcbicuam9pbihyZXN1bHQpKQppRWxtID0gaUVsbSAtIDEKZGluYW1pY2Eub3V0cHV0c1snbWF4J10gPSBpRWxtCmRpbmFtaWNhLm91dHB1dHNbJ2V4cCddID0gJ1xuJy5qb2luKHJlc3VsdCkKZGluYW1pY2Eub3V0cHV0c1snY3N2J10gPSAnXG4nLmpvaW4oZ2VuQ3N2KQ==&quot;</inputport>
            <outputport name="result" id="v11" />
            <functor name="NumberTable">
                <property key="dff.functor.alias" value="numberTable2699" />
                <inputport name="table" peerid="v5" />
                <inputport name="tableNumber">1</inputport>
            </functor>
            <functor name="NumberString">
                <property key="dff.functor.alias" value="numberString2709" />
                <inputport name="value" peerid="v9" />
                <inputport name="valueNumber">1</inputport>
            </functor>
        </containerfunctor>
    </containerfunctor>
    <containerfunctor name="Group">
        <property key="dff.functor.alias" value="group2723" />
        <inputport name="sequenceInput">.none</inputport>
        <functor name="SaveMap">
            <property key="dff.functor.alias" value="saveMap2720" />
            <inputport name="map" peerid="v6" />
            <inputport name="filename" peerid="v12" />
            <inputport name="suffixDigits">2</inputport>
            <inputport name="step">.none</inputport>
            <inputport name="useCompression">.yes</inputport>
            <inputport name="workdir">.none</inputport>
            <inputport name="ignoreCostlySparseCategories">.yes</inputport>
        </functor>
        <functor name="GenerateTemporaryFile">
            <property key="dff.functor.alias" value="mapToPublish" />
            <inputport name="extension">$&quot;(tif)&quot;</inputport>
            <inputport name="createFile">.no</inputport>
            <outputport name="filename" id="v12" />
        </functor>
    </containerfunctor>
    <containerfunctor name="CalculatePythonExpression">
        <property key="dff.container.collapsed" value="no" />
        <property key="dff.functor.alias" value="calculatePythonExpression2724" />
        <inputport name="expression">&quot;IyEvdXNyL2Jpbi9weXRob24KIyAtKi0gY29kaW5nOiB1dGYtOCAtKi0KCiMgI0hhY2sgcGFyYSBjb3JyaWdpciBvIHByb2JsZW1hIGNvbSBvIGRlZmF1bHRlbmNvZGluZywgZGVzc2EgbWFuZWlyYSBmdW5jaW9uYSBlbSBxdWFscXVlciBjb21wdXRhZG9yIHF1ZSBwb3NzdWEgbyBlbmNvZGluZyAndXRmLTgnLgojIGltcG9ydCBzeXMKIyByZWxvYWQoc3lzKQojIHN5cy5zZXRkZWZhdWx0ZW5jb2RpbmcoInV0Zi04IikKCnZlcnNpb24gPSAnMC4xJwoKaW1wb3J0IG9zCmltcG9ydCBqc29uCmZyb20gcGF0aGxpYiBpbXBvcnQgUGF0aAppbXBvcnQgd2ViYnJvd3NlcgojIGltcG9ydCBzeXMKIyBpbXBvcnQgaW1wb3J0bGliCiMgIyBpbXBvcnRsaWIucmVsb2FkKHN5cykKIyAjIHN5cy5zZXRkZWZhdWx0ZW5jb2RpbmcoJ1VURjgnKQoKCmlzRGluYW1pY2EgPSBGYWxzZQp0cnk6CiAgICBkaW5hbWljYS5wYWNrYWdlKCJvcyIpCiAgICBpc0RpbmFtaWNhID0gVHJ1ZQpleGNlcHQ6CiAgICBpc0RpbmFtaWNhID0gRmFsc2UKCgp0cnk6CiAgICBmcm9tIG9zZ2VvIGltcG9ydCBvZ3IsIG9zciwgZ2RhbApleGNlcHQ6CiAgICBpbXBvcnQgdGVtcGZpbGUKICAgIGltcG9ydCBzaHV0aWwKCiAgICBpZiBpc0RpbmFtaWNhOgogICAgICAgIHByaW50KCJJbnN0YWxsaW5nIHB5dGhvbiBHREFMIikKICAgICAgICBkaW5hbWljYS5wYWNrYWdlKCJ3aGVlbD09MC4zMy42IiwgTm9uZSwgIndoZWVsIikKICAgICAgICBkaW5hbWljYS5wYWNrYWdlKCJ3Z2V0PT0zLjIiLCBOb25lLCAid2dldCIpCiAgICAgICAgZGlyZWN0b3J5ID0gdGVtcGZpbGUubWtkdGVtcCgpCiAgICAgICAgZ2RhbENvbXBpbGVkRmlsZSA9IG9zLnBhdGguam9pbihkaXJlY3RvcnksICdHREFMLTIuNC4xLWNwMzctY3AzN20td2luX2FtZDY0LndobCcpCiAgICAgICAgd2dldC5kb3dubG9hZCgiaHR0cHM6Ly9naXRodWIuY29tL2FzZml4aWEvcmFzdGVyc3RhdHNfd2hlZWwvcmF3L21hc3Rlci9HREFMLTIuNC4xLWNwMzctY3AzN20td2luX2FtZDY0LndobCIsIGdkYWxDb21waWxlZEZpbGUpCiAgICAgICAgZGluYW1pY2EucGFja2FnZSgiZ2RhbCIsIGdkYWxDb21waWxlZEZpbGUpCiAgICAgICAgb3MucmVtb3ZlKGdkYWxDb21waWxlZEZpbGUpCgpvcy5lbnZpcm9uWydHSVRfUFlUSE9OX1JFRlJFU0gnXSA9ICdxdWlldCcKaWYgaXNEaW5hbWljYToKICAgIGRpbmFtaWNhLnBhY2thZ2UoInJlcXVlc3RzIikKICAgIGRpbmFtaWNhLnBhY2thZ2UoIkdpdFB5dGhvbiIsIE5vbmUsICJnaXQiKQogICAgZGluYW1pY2EucGFja2FnZSgieG1sdG9kaWN0IikKICAgIGRpbmFtaWNhLnBhY2thZ2UoIlBpbGxvdyIsIE5vbmUsICJQSUwiKQoKdHJ5OgogICAgaW1wb3J0IFFNZXNzYWdlQm94CmV4Y2VwdDoKICAgIHBhc3MKCmltcG9ydCB0aHJlYWRpbmcsIHRpbWUsIGN0eXBlcywgY3R5cGVzLndpbnR5cGVzLCBtYXRoCgoKY2xhc3MgUU1lc3NhZ2VCb3goKToKICAgIG1lc3NhZ2VCb3ggPSBjdHlwZXMud2luZGxsLnVzZXIzMi5NZXNzYWdlQm94VwogICAgI3NldFRpbWVyID0gY3R5cGVzLndpbmRsbC51c2VyMzIuU2V0VGltZXJXICMoTlVMTCwgTlVMTCwgaW50KHRpbWVvdXQgKiAxMDAwKSwgTlVMTCkKICAgIElEQUJPUlQgPSAzICNUaGUgQWJvcnQgYnV0dG9uIHdhcyBzZWxlY3RlZC4KICAgIElEQ09OVElOVUUgPSAxMSAjVGhlIENvbnRpbnVlIGJ1dHRvbiB3YXMgc2VsZWN0ZWQuCiAgICBJRFJFVFJZID0gNCAjVGhlIFJldHJ5IGJ1dHRvbiB3YXMgc2VsZWN0ZWQuCiAgICBJRFRSWUFHQUlOID0gMTAgI1RoZSBUcnkgQWdhaW4gYnV0dG9uIHdhcyBzZWxlY3RlZC4KICAgIElEWUVTID0gNiAjVGhlIFllcyBidXR0b24gd2FzIHNlbGVjdGVkLgogICAgWWVzID0gNgogICAgSUROTyA9IDcgI1RoZSBObyBidXR0b24gd2FzIHNlbGVjdGVkLgogICAgTm8gPSA3CiAgICBJRENBTkNFTCA9IDIgI1RoZSBDYW5jZWwgYnV0dG9uIHdhcyBzZWxlY3RlZC4KICAgIENhbmNlbCA9IDIKICAgIElESUdOT1JFID0gNSAjVGhlIElnbm9yZSBidXR0b24gd2FzIHNlbGVjdGVkLgogICAgRGlzY2FyZCA9IDUKICAgIEluZm9ybWF0aW9uID0gNDAKICAgIElET0sgPSAxICNUaGUgT0sgYnV0dG9uIHdhcyBzZWxlY3RlZC4KICAgIE9rID0gMQoKICAgIFRPUF9NT1NUID0gMHg0MDAwMAogICAgTUJfT0sgPSAweDAKICAgIE1CX09LQ1hMID0gMHgwMQogICAgTUJfWUVTTk9DWEwgPSAweDAzCiAgICBNQl9ZRVNOTyA9IDB4MDQKICAgIE1CX0hFTFAgPSAweDQwMDAKICAgIElDT05fRVhMQUlNID0gMHgzMAogICAgSUNPTl9JTkZPID0gMHg0MAogICAgSUNPTl9TVE9QID0gMHgxMAoKICAgIFdNX0NMT1NFID0gMHgwMDEwCgogICAgbWVzc2FnZSA9IE5vbmUKICAgIHRpdGxlID0gTm9uZQogICAgdGltZW91dCA9IDEKICAgIGNhbGxiYWNrID0gTm9uZQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBmaW5kX21lc3NhZ2Vib3godGl0bGUsIHRocmVhZGlkLCBwcm9jZXNzaWQpOgogICAgICAgIGh3bmQgPSBjdHlwZXMud2luZGxsLnVzZXIzMi5GaW5kV2luZG93VyhOb25lLCB0aXRsZSkKICAgICAgICBpZiBod25kOgogICAgICAgICAgICBwID0gY3R5cGVzLndpbnR5cGVzLkRXT1JEKCkKICAgICAgICAgICAgdCA9IGN0eXBlcy53aW5kbGwudXNlcjMyLkdldFdpbmRvd1RocmVhZFByb2Nlc3NJZChod25kLCBjdHlwZXMuYnlyZWYocCkpCiAgICAgICAgICAgIGlmIHAudmFsdWUgPT0gcHJvY2Vzc2lkIGFuZCB0ID09IHRocmVhZGlkOgogICAgICAgICAgICAgICAgcmV0dXJuIGh3bmQKICAgICAgICByZXR1cm4gMAoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBzZXRDYWxsYmFjayhjYWxsYmFjayk6CiAgICAgICAgUU1lc3NhZ2VCb3guY2FsbGJhY2sgPSBjYWxsYmFjawoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBzZXRUZXh0KG1lc3NhZ2UpOgogICAgICAgIFFNZXNzYWdlQm94Lm1lc3NhZ2UgPSBtZXNzYWdlCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHNldFdpbmRvd1RpdGxlKHRpdGxlKToKICAgICAgICBRTWVzc2FnZUJveC50aXRsZSA9IHRpdGxlCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHNldEljb24oaWNvbik6CiAgICAgICAgcGFzcwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBzZXRTdGFuZGFyZEJ1dHRvbnMoYnV0dG9ucyk6CiAgICAgICAgcGFzcwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBleGVjXygpOgogICAgICAgIHRocmVhZGlkID0gY3R5cGVzLndpbmRsbC5rZXJuZWwzMi5HZXRDdXJyZW50VGhyZWFkSWQoKQogICAgICAgIHByb2Nlc3NpZCA9IGN0eXBlcy53aW5kbGwua2VybmVsMzIuR2V0Q3VycmVudFByb2Nlc3NJZCgpCiAgICAgICAgYWJvcnQgPSB0aHJlYWRpbmcuRXZlbnQoKQogICAgICAgIHQgPSB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1RTWVzc2FnZUJveC5jYWxsYmFja0hhbmRsZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJncz0oYWJvcnQsIHRocmVhZGlkLCBwcm9jZXNzaWQsIFFNZXNzYWdlQm94LnRpdGxlLCBRTWVzc2FnZUJveC50aW1lb3V0LCBRTWVzc2FnZUJveC5jYWxsYmFjaykpCiAgICAgICAgdC5zdGFydCgpCiAgICAgICAgcmV0dXJuIFFNZXNzYWdlQm94LnF1ZXN0aW9uKE5vbmUsIFFNZXNzYWdlQm94LnRpdGxlLCBRTWVzc2FnZUJveC5tZXNzYWdlKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBxdWVzdGlvbihuc2VpLCB0aXRsZSwgbXNnLCBkZWZhdWx0QnV0dG9uPU5vbmUsIGJ1dHRvbnM9Tm9uZSk6CiAgICAgICAgcmV0dXJuIFFNZXNzYWdlQm94Lm1lc3NhZ2VCb3goTm9uZSwgbXNnLCB0aXRsZSwgMykKCiAgICAjZGFuaWxvIGNhbGxiYWNrIHJldHVybiBUcnVlIHRvIHJ1biBhZ2FpbiBGYWxzZSB0byBzdG9wCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgY2FsbGJhY2tIYW5kbGVyKGFib3J0LCB0aHJlYWRpZCwgcHJvY2Vzc2lkLCB0aXRsZSwgY2FsbGJhY2tEZWxheSwgY2FsbGJhY2tGbik6CiAgICAgICAgIyBnaXZlIHdpbmRvd3Mgc29tZSB0aW1lIHRvIGNyZWF0ZSB0aGUgbWVzc2FnZSBib3gKICAgICAgICB0aW1lLnNsZWVwKG1heChjYWxsYmFja0RlbGF5LCAwLjIpKQogICAgICAgIGN1cnJlbnRUaW1lID0gbWF4KGNhbGxiYWNrRGVsYXksIDAuMikKICAgICAgICBjbGFzcyBidG5XcmFwcGVyOgogICAgICAgICAgICBtdXN0Q2xvc2UgPSBGYWxzZQogICAgICAgICAgICBkZWYgZG9uZShzZWxmLCBzdGF0ZSk6CiAgICAgICAgICAgICAgICBzZWxmLm11c3RDbG9zZSA9IFRydWUKICAgICAgICBjdXJCdG4gPSBidG5XcmFwcGVyKCkKICAgICAgICB3aGlsZSBub3QgY3VyQnRuLm11c3RDbG9zZSBhbmQgbm90IGFib3J0LmlzU2V0KCkgYW5kIGNhbGxiYWNrRm4oY3VyQnRuLCBjdXJyZW50VGltZSk6CiAgICAgICAgICAgIHRpbWUuc2xlZXAoY2FsbGJhY2tEZWxheSkKICAgICAgICAgICAgY3VycmVudFRpbWUgPSBjdXJyZW50VGltZSArIGNhbGxiYWNrRGVsYXkKICAgICAgICBod25kID0gUU1lc3NhZ2VCb3guZmluZF9tZXNzYWdlYm94KHRpdGxlLCB0aHJlYWRpZCwgcHJvY2Vzc2lkKQogICAgICAgIGlmIG5vdCBhYm9ydC5pc1NldCgpIGFuZCBod25kOgogICAgICAgICAgICBjdHlwZXMud2luZGxsLnVzZXIzMi5Qb3N0TWVzc2FnZVcoaHduZCwgUU1lc3NhZ2VCb3guV01fQ0xPU0UsIDAsIDApCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGVycm9yKG1zZywgZGVmYXVsdEJ1dHRvbj1Ob25lLCBidXR0b25zPU5vbmUpOgogICAgICAgIHJldHVybiBRTWVzc2FnZUJveC5tZXNzYWdlQm94KE5vbmUsIG1zZywgIkVycm9yIiwgMikKCgoKCgoKCmNsYXNzIEZlZWRiYWNrKCk6CiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgcHVzaENvbnNvbGVJbmZvKG1lc3NhZ2UpOgogICAgICAgIHByaW50KG1lc3NhZ2UpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHNldFByb2dyZXNzKHBlcmNlbnRhZ2UpOgogICAgICAgIHByaW50KCJQcm9ncmVzczogIiArIHN0cihwZXJjZW50YWdlKSkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgc2V0UHJvZ3Jlc3NUZXh0KG1lc3NhZ2UpOgogICAgICAgIHByaW50KG1lc3NhZ2UpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGlzQ2FuY2VsZWQoKToKICAgICAgICByZXR1cm4gRmFsc2UKCgoKCnRyeToKICAgIGZyb20gY29sb3JpemVfcmdiIGltcG9ydCBhcHBseUxlZ2VuZENzdiwgYXBwbHlMZWdlbmQsIHJlYWRMZWdlbmQsIHByZXBhcmVMZWdlbmQKZXhjZXB0OgogICAgcGFzcyAjTm90IGluIERpbmFtaWNhIENvZGUKCiMgdHJ5OgojICAgICBkaW5hbWljYS5wYWNrYWdlKCJQeVBORyIsIE5vbmUsICJwbmciKQojIGV4Y2VwdDoKIyAgICAgcGFzcwojCiMgaW1wb3J0IHBuZwojCiMgcyA9IFsnMTEwMDEwMDEwMDExJywKIyAgICAgICcxMDEwMTEwMTAxMDAnLAojICAgICAgJzExMDAxMDExMDEwMScsCiMgICAgICAnMTAwMDEwMDEwMDExJ10KIyBzID0gW1tpbnQoYykgZm9yIGMgaW4gcm93XSBmb3Igcm93IGluIHNdCiMKIyBwYWxldHRlPVsoMHg1NSwweDU1LDB4NTUpLCAoMHhmZiwweDk5LDB4OTkpXQojIHcgPSBwbmcuV3JpdGVyKGxlbihzWzBdKSwgbGVuKHMpLCBwYWxldHRlPXBhbGV0dGUsIGJpdGRlcHRoPTEpCiMgZiA9IG9wZW4oJ3BuZy5wbmcnLCAnd2InKQojIHcud3JpdGUoZiwgcykKCgpmcm9tIFBJTCBpbXBvcnQgSW1hZ2UKaW1wb3J0IGNzdgoKCgpjbGFzcyBMZWdlbmRFbnRyeToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjYXRlZ29yeSwgZnJvbVZhbHVlLCB0b1ZhbHVlLCBjYXRlZ29yeU5hbWUsIHJlZCwgZ3JlZW4sIGJsdWUpOgogICAgICAgIHNlbGYuY2F0ZWdvcnkgPSBpbnQoY2F0ZWdvcnkpCiAgICAgICAgc2VsZi5mcm9tVmFsdWUgPSBmbG9hdChmcm9tVmFsdWUpCiAgICAgICAgc2VsZi50b1ZhbHVlID0gZmxvYXQodG9WYWx1ZSkKICAgICAgICBzZWxmLmNhdGVnb3J5TmFtZSA9IGNhdGVnb3J5TmFtZQogICAgICAgIHNlbGYucmVkID0gaW50KHJlZCkKICAgICAgICBzZWxmLmdyZWVuID0gaW50KGdyZWVuKQogICAgICAgIHNlbGYuYmx1ZSA9IGludChibHVlKQoKICAgIGRlZiBnZXRSR0JBKHNlbGYpOgogICAgICAgIHJldHVybiAoc2VsZi5yZWQsIHNlbGYuZ3JlZW4sIHNlbGYuYmx1ZSwgMjU1KQoKZGVmIGFwcGx5TGVnZW5kKHBuZ1BhdGgsIGxlZ2VuZE9iaik6CiAgICB3aXRoIEltYWdlLm9wZW4ocG5nUGF0aCkgYXMgaW06CiAgICAgICAgaW0uY29udmVydCgnUkdCQScpCiAgICAgICAgYmFja2dyb3VuZCA9IEltYWdlLm5ldygiUkdCQSIsICgyNTYsIDI1NiksICgwLCAwLCAwLCAyNTUpKQogICAgICAgIHBpeGRhdGEgPSBpbS5sb2FkKCkKICAgICAgICB0b0RhdGEgPSBiYWNrZ3JvdW5kLmxvYWQoKQoKICAgICAgICB3aWR0aCA9IDI1NgogICAgICAgIGhlaWdodCA9IDI1NgogICAgICAgIGZvciB5IGluIHJhbmdlKGhlaWdodCk6CiAgICAgICAgICAgIGZvciB4IGluIHJhbmdlKHdpZHRoKToKICAgICAgICAgICAgICAgIGN1clZhbHVlID0gcGl4ZGF0YVt4LCB5XVswXSAjKyBwaXhkYXRhW3gsIHldWzFdCiAgICAgICAgICAgICAgICBpZiBwaXhkYXRhW3gsIHldID09ICgwLCAwKToKICAgICAgICAgICAgICAgICAgICB0b0RhdGFbeCwgeV0gPSAoMCwgMCwgMCwgMCkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgdG9EYXRhW3gsIHldID0gZ2V0TGVnZW5kRm9yVmFsdWUoY3VyVmFsdWUsIGxlZ2VuZE9iaikuZ2V0UkdCQSgpCiAgICAgICAgYmFja2dyb3VuZC5zYXZlKHBuZ1BhdGgsICJQTkciKQoKZGVmIHJlYWRMZWdlbmQoY3N2UGF0aCk6CiAgICByZXR1cm4gcHJlcGFyZUxlZ2VuZChbYSBmb3IgYSBpbiBjc3YucmVhZGVyKG9wZW4oY3N2UGF0aCwgInIiLCBlbmNvZGluZz0idXRmLTgiKSwgZXNjYXBlY2hhcj0nXFwnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBza2lwaW5pdGlhbHNwYWNlPUZhbHNlLCBkZWxpbWl0ZXI9JywnLCBxdW90aW5nPWNzdi5RVU9URV9OT05FKV0pCgpkZWYgYXBwbHlMZWdlbmRDc3YocG5nUGF0aCwgbGVnZW5kUGF0aCk6CiAgICByZXR1cm4gYXBwbHlMZWdlbmQocG5nUGF0aCwgcmVhZExlZ2VuZChsZWdlbmRQYXRoKSkKCmRlZiBwcmVwYXJlTGVnZW5kKGNzdkxlZ2VuZCk6CiAgICByZXN1bHQgPSBbXQogICAgaSA9IDAKICAgIGhlYWRUbXAgPSBjc3ZMZWdlbmQucG9wKDApCiAgICBpZiBub3QgKGxlbihoZWFkVG1wKSA+PSA3IGFuZCAnY2F0ZWdvcnknIGluIGhlYWRUbXBbMF0ubG93ZXIoKSBhbmQgJ2Zyb20nIGluIGhlYWRUbXBbMV0ubG93ZXIoKSBhbmQgJ3RvJyBpbiBoZWFkVG1wWzJdLmxvd2VyKCkKICAgICAgICAgICAgYW5kICdjYXRlZ29yeV9uYW1lJyBpbiBoZWFkVG1wWzNdLmxvd2VyKCkgYW5kICdyZWQnIGluIGhlYWRUbXBbNF0ubG93ZXIoKSBhbmQgJ2dyZWVuJyBpbiBoZWFkVG1wWzVdLmxvd2VyKCkKICAgICAgICAgICAgYW5kICdibHVlJyBpbiBoZWFkVG1wWzZdLmxvd2VyKCkpOgogICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiVGhlIENTViBTdHlsZSBpcyBpbnZhbGlkIHBsZWFzZSBjb25maXJtIHRoZSBGaWVsZHM6ICdDYXRlZ29yeSonLCAnIEZyb20nLCAnIFRvJywgJyBDYXRlZ29yeV9OYW1lJywgJyByZWQnLCAnIGdyZWVuJywgJyBibHVlJyIpCiAgICBmb3IgZWxtIGluIGNzdkxlZ2VuZDoKICAgICAgICByZXN1bHQuYXBwZW5kKExlZ2VuZEVudHJ5KGVsbVswXSwgZWxtWzFdLCBlbG1bMl0sIGVsbVszXSwgZWxtWzRdLCBlbG1bNV0sIGVsbVs2XSkpCiAgICByZXR1cm4gcmVzdWx0CgojQ2F0ZWdvcnkqLCBGcm9tLCBUbywgQ2F0ZWdvcnlfTmFtZSwgcmVkLCBncmVlbiwgYmx1ZSwKZGVmIGdldExlZ2VuZEZvclZhbHVlKHZhbHVlLCBsZWdlbmQpOgogICAgcmV0dXJuIFtsIGZvciBsIGluIGxlZ2VuZCBpZiBsLmNhdGVnb3J5ID09IHZhbHVlXVswXQoKIyAjICMgIyBkaWFsZWN0ID0gY3N2LkRpYWxlY3QoKQojICMgIyAjIGRpYWxlY3Quc2tpcGluaXRpYWxzcGFjZSA9IFRydWUKIyAjICMgIyBkaWFsZWN0LmRlbGltaXRlciA9ICcsJwojICMgIyAjIGRpYWxlY3QucXVvdGluZyA9ICciJwojICMgIyAjIGRpYWxlY3QuZXNjYXBlY2hhciA9ICdcXCcKIyAjIGFwcGx5TGVnZW5kKHBuZ1BhdGgsIHByZXBhcmVMZWdlbmQoY3N2LkRpY3RSZWFkZXIob3BlbignSTpcXERhbmlsb1xcVHJhbXBvXFxkYXRhX2RpclxcZGF0YVxcbGF1cmVsXFxsYW5kX3VzZV8xOTkyXzIwMTVcXGxhbmRfdXNlXzE5OTJfMjAxNV83LnNsZCcsICJyIiwgZW5jb2Rpbmc9InV0Zi04IiksIGVzY2FwZWNoYXI9J1xcJywgc2tpcGluaXRpYWxzcGFjZT1GYWxzZSwgZGVsaW1pdGVyPScsJywgcXVvdGluZz1jc3YuUVVPVEVfTk9ORSkpKQojIHNsZFBhdGggPSAnSTpcXERhbmlsb1xcVHJhbXBvXFxkYXRhX2RpclxcZGF0YVxcbGF1cmVsXFxsYW5kX3VzZV8xOTkyXzIwMTVcXGxhbmRfdXNlXzE5OTJfMjAxNV83LnNsZCcKIyBwbmdQYXRoID0gIkM6XFxVc2Vyc1xcRGFuaWxvXFxBcHBEYXRhXFxMb2NhbFxcVGVtcFxcb3V0cHV0RGlyXFxpeWllbGRfcnViYmVyMlxcMVxccmdiYVxcNFxcMDAwNV8wMDA3LnBuZyIKIyBhcHBseUxlZ2VuZENzdihwbmdQYXRoLCBzbGRQYXRoKQoKCnRyeToKICAgIGZyb20gVVRJTFMgaW1wb3J0IFVUSUxTCmV4Y2VwdDoKICAgIHBhc3MgI05vdCBpbiBEaW5hbWljYSBDb2RlCgppbXBvcnQgcmUKaW1wb3J0IHRpbWUKaW1wb3J0IG1hdGgKaW1wb3J0IG9zCmltcG9ydCB1bmljb2RlZGF0YQppbXBvcnQgdGVtcGZpbGUKZnJvbSBodHRwIGltcG9ydCBIVFRQU3RhdHVzCmZyb20gdXJsbGliLnBhcnNlIGltcG9ydCB1cmxlbmNvZGUKaW1wb3J0IHJlcXVlc3RzCmZyb20geG1sLnNheC5zYXh1dGlscyBpbXBvcnQgZXNjYXBlCmZyb20gemlwZmlsZSBpbXBvcnQgWmlwRmlsZQoKaXNEaW5hbWljYSA9IEZhbHNlCnRyeToKICAgIGRpbmFtaWNhLnBhY2thZ2UoIm9zIikKICAgIGlzRGluYW1pY2EgPSBUcnVlCmV4Y2VwdDoKICAgIGlzRGluYW1pY2EgPSBGYWxzZQoKdHJ5OgogICAgZnJvbSBRTWVzc2FnZUJveCBpbXBvcnQgUU1lc3NhZ2VCb3gKZXhjZXB0OgogICAgcGFzcyAjTm90IGluIERpbmFtaWNhIENvZGUKCnRyeToKICAgIGZyb20gcWdpcy5QeVF0LlF0V2lkZ2V0cyBpbXBvcnQgUU1lc3NhZ2VCb3gKICAgIGZyb20gcWdpcy5QeVF0LlF0Q29yZSBpbXBvcnQgUVRpbWVyCiAgICBmcm9tIHFnaXMuY29yZSBpbXBvcnQgKFFnc1Byb2plY3QsIFFnc0Nvb3JkaW5hdGVUcmFuc2Zvcm0sIFFnc01lc3NhZ2VMb2csIFFnc1ZlY3RvckxheWVyLCBRZ3NSYXN0ZXJMYXllcikKZXhjZXB0OgogICAgcGFzcyAjTm90IGluIFFHSVMKCmltcG9ydCByYW5kb20KaW1wb3J0IHN0cmluZwoKY2xhc3MgVVRJTFM6CgogICAgI0RhbmlsbyBvIHppcCBwcmVjaXNhIGRlbGV0YXIgZHBzCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgemlwRmlsZXMoZGlyLCBwYXR0ZXJuKToKICAgICAgICBjdXJUbXBGaWxlID0gdGVtcGZpbGUuTmFtZWRUZW1wb3JhcnlGaWxlKHN1ZmZpeD0nLnppcCcsIGRlbGV0ZT1GYWxzZSkKICAgICAgICBjb21wUGF0dGVybiA9IHJlLmNvbXBpbGUocGF0dGVybikKICAgICAgICAjIGNyZWF0ZSBhIFppcEZpbGUgb2JqZWN0CiAgICAgICAgd2l0aCBaaXBGaWxlKGN1clRtcEZpbGUsICd3JykgYXMgemlwT2JqOgogICAgICAgICAgICAjIEl0ZXJhdGUgb3ZlciBhbGwgdGhlIGZpbGVzIGluIGRpcmVjdG9yeQogICAgICAgICAgICBmb3IgZm9sZGVyTmFtZSwgc3ViZm9sZGVycywgZmlsZW5hbWVzIGluIG9zLndhbGsoZGlyKToKICAgICAgICAgICAgICAgIGZvciBmaWxlbmFtZSBpbiBmaWxlbmFtZXM6CiAgICAgICAgICAgICAgICAgICAgaWYgbm90IGNvbXBQYXR0ZXJuLm1hdGNoKGZpbGVuYW1lKToKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAjIGNyZWF0ZSBjb21wbGV0ZSBmaWxlcGF0aCBvZiBmaWxlIGluIGRpcmVjdG9yeQogICAgICAgICAgICAgICAgICAgIGZpbGVQYXRoID0gb3MucGF0aC5qb2luKGZvbGRlck5hbWUsIGZpbGVuYW1lKQogICAgICAgICAgICAgICAgICAgICMgQWRkIGZpbGUgdG8gemlwCiAgICAgICAgICAgICAgICAgICAgemlwT2JqLndyaXRlKGZpbGVQYXRoLCBvcy5wYXRoLmJhc2VuYW1lKGZpbGVQYXRoKSkKICAgICAgICAgICAgcmV0dXJuIGN1clRtcEZpbGUKICAgICAgICByZXR1cm4gTm9uZQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRGaWxlU2l6ZShkaXIsIHBhdHRlcm4pOgogICAgICAgIHRvdGFsID0gMAogICAgICAgIGNvbXBQYXR0ZXJuID0gcmUuY29tcGlsZShwYXR0ZXJuKQogICAgICAgIGZvciBmb2xkZXJOYW1lLCBzdWJmb2xkZXJzLCBmaWxlbmFtZXMgaW4gb3Mud2FsayhkaXIpOgogICAgICAgICAgICBmb3IgZmlsZW5hbWUgaW4gZmlsZW5hbWVzOgogICAgICAgICAgICAgICAgaWYgbm90IGNvbXBQYXR0ZXJuLm1hdGNoKGZpbGVuYW1lKToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgZmlsZVBhdGggPSBvcy5wYXRoLmpvaW4oZm9sZGVyTmFtZSwgZmlsZW5hbWUpCiAgICAgICAgICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShmaWxlUGF0aCk6CiAgICAgICAgICAgICAgICAgICAgdG90YWwgPSB0b3RhbCArIG9zLnBhdGguZ2V0c2l6ZShmaWxlUGF0aCkKICAgICAgICByZXR1cm4gdG90YWwKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgY2hlY2tGb3JDYW5jZWxlZChmZWVkYmFjaywgbXNnPSdDYW5jZWxsaW5nJyk6CiAgICAgICAgaWYgZmVlZGJhY2suaXNDYW5jZWxlZCgpOgogICAgICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8obXNnKQogICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oIlVzZXIgY2FuY2VsZWQgdGhlIHBsdWdpbiBleGVjdXRpb24uIikKCiAgICAjRGFuaWxvIC8vRGFuaWxvIHJldHVybiBhICBUZW1wb3JhcnlGaWxlIHdoZW4gd29ya3MKICAgICNEYW5pbG8gbyB6aXAgcHJlY2lzYSBkZWxldGFyCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2VuZXJhdGVaaXBMYXllcihsYXllcik6CiAgICAgICAgcHJpbnQoIkdlbmVyYXRpbmcgemlwIGZvciAiICsgbGF5ZXIubmFtZSgpICsgIiBsYXllci4iKQogICAgICAgIHNvdXJjZVVyaSA9IGxheWVyLmRhdGFQcm92aWRlcigpLmRhdGFTb3VyY2VVcmkoKQogICAgICAgIGFic29sdXRlUGF0aCA9IE5vbmUKICAgICAgICBpZiBpc2luc3RhbmNlKGxheWVyLCBRZ3NSYXN0ZXJMYXllcik6CiAgICAgICAgICAgIGlmICcudGlmZicgaW4gc291cmNlVXJpOgogICAgICAgICAgICAgICAgYWJzb2x1dGVQYXRoID0gc291cmNlVXJpWzooc291cmNlVXJpLmluZGV4KCIudGlmZiIpICsgNSldCiAgICAgICAgICAgIGVsaWYgJy50aWYnIGluIHNvdXJjZVVyaToKICAgICAgICAgICAgICAgIGFic29sdXRlUGF0aCA9IHNvdXJjZVVyaVs6KHNvdXJjZVVyaS5pbmRleCgiLnRpZiIpICsgNCldCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwcmludCgiT25seSB0aWZmIGFuZCB0aWYgaXMgYWxsb3dhYmxlIHRvIGRvd25sb2FkLiIpCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKGxheWVyLCBRZ3NWZWN0b3JMYXllcik6CiAgICAgICAgICAgIGlmICcuc2hwJyBpbiBzb3VyY2VVcmk6CiAgICAgICAgICAgICAgICBhYnNvbHV0ZVBhdGggPSBzb3VyY2VVcmlbOihzb3VyY2VVcmkuaW5kZXgoIi5zaHAiKSArIDQpXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcHJpbnQoIk9ubHkgc2hwIGZpbGUgaXMgYWxsb3dhYmxlIHRvIGRvd25sb2FkLiIpCiAgICAgICAgaWYgYWJzb2x1dGVQYXRoIGlzIG5vdCBOb25lOgogICAgICAgICAgICBmaWxlTmFtZSA9IG9zLnBhdGguYmFzZW5hbWUoYWJzb2x1dGVQYXRoKQogICAgICAgICAgICBmaWxlTmFtZVdpdGhvdXRFeHQgPSBvcy5wYXRoLnNwbGl0ZXh0KGZpbGVOYW1lKVswXQogICAgICAgICAgICBkaXJOYW1lID0gb3MucGF0aC5kaXJuYW1lKGFic29sdXRlUGF0aCkKICAgICAgICAgICAgemlwRmlsZSA9IFVUSUxTLnppcEZpbGVzKGRpck5hbWUgKyBvcy5wYXRoLnNlcCwgZmlsZU5hbWVXaXRob3V0RXh0ICsgIioiKQogICAgICAgICAgICB6aXBGaWxlLmNsb3NlKCkKICAgICAgICAgICAgaWYgb3MucGF0aC5nZXRzaXplKHppcEZpbGUubmFtZSkgPiAyZTk6CiAgICAgICAgICAgICAgICBwcmludCgiVGhlIG1hcCBmaWxlc2l6ZSBpcyBncmVhdGVyIHRoYW4gdGhlIEdpdEh1YiAyR2IgbGltaXQuIChhbGwgZmlsZXMgaW4gdGhpcyBmb2xkZXIgc3RhcnRpbmcgd2l0aCAiICsgZmlsZU5hbWVXaXRob3V0RXh0ICsgIiB3ZXJlIGluY2x1ZGVkLiIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByZXR1cm4gemlwRmlsZQogICAgICAgIHJldHVybiBOb25lCgoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBydW5Mb25nVGFzayhmdW5jdGlvbiwgZmVlZGJhY2ssIHdhaXRNZXNzYWdlPSJQbGVhc2UgV2FpdCIsIHNlY29uZHNSZXBvcnQ9NjAsICphcmdzLCAqKmt3QXJncyk6CiAgICAgICAgZnJvbSBjb25jdXJyZW50IGltcG9ydCBmdXR1cmVzCiAgICAgICAgIyBmZWVkYmFjay5zZXRQcm9ncmVzcygxKQogICAgICAgIHN0ZXBUaW1lciA9IDAuNQogICAgICAgIHRvdGFsVGltZSA9IDAKICAgICAgICB3aXRoIGZ1dHVyZXMuVGhyZWFkUG9vbEV4ZWN1dG9yKG1heF93b3JrZXJzPTEpIGFzIGV4ZWN1dG9yOgogICAgICAgICAgICBqb2IgPSBleGVjdXRvci5zdWJtaXQoZnVuY3Rpb24sICphcmdzLCAqKmt3QXJncykKICAgICAgICAgICAgZWxhcHNlZFRpbWUgPSAwCiAgICAgICAgICAgIHdoaWxlIGpvYi5kb25lKCkgPT0gRmFsc2U6CiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKHN0ZXBUaW1lcikKICAgICAgICAgICAgICAgIGVsYXBzZWRUaW1lID0gZWxhcHNlZFRpbWUgKyBzdGVwVGltZXIKICAgICAgICAgICAgICAgIHRvdGFsVGltZSA9IHRvdGFsVGltZSArIHN0ZXBUaW1lcgogICAgICAgICAgICAgICAgaWYgZWxhcHNlZFRpbWUgPiBzZWNvbmRzUmVwb3J0OgogICAgICAgICAgICAgICAgICAgIGNhbmNlbE1zZyA9ICJcbkNhbmNlbGxpbmcsIHBsZWFzZSB3YWl0IHRoZSBjdXJyZW50IHN0ZXAgdG8gZmluaXNoIGdyYWNlZnVsbHkuIiBpZiBmZWVkYmFjay5pc0NhbmNlbGVkKCkgZWxzZSAnJwogICAgICAgICAgICAgICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiRWxhcHNlZCAiICsgc3RyKHJvdW5kKHRvdGFsVGltZSkpICsgInM6ICIgKyB3YWl0TWVzc2FnZSArIGNhbmNlbE1zZykKICAgICAgICAgICAgICAgICAgICBlbGFwc2VkVGltZSA9IDAKICAgICAgICAgICAgICAgICMgaWYgY2FuQ2FuY2VsTm93IGFuZCBmZWVkYmFjay5pc0NhbmNlbGVkKCk6CiAgICAgICAgICAgICAgICAjICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkpvYiBzdGFydGluZyB0byBjYW5jZWwuIikKICAgICAgICAgICAgICAgICMgICAgIGpvYi5jYW5jZWwoKQogICAgICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkVsYXBzZWQgIiArIHN0cihyb3VuZCh0b3RhbFRpbWUpKSArICJzIG9uIHRoaXMgc3RlcC4iKQogICAgICAgICAgICAjIFVUSUxTLmNoZWNrRm9yQ2FuY2VsZWQoZmVlZGJhY2spCiAgICAgICAgICAgIHJldHVybiBqb2IucmVzdWx0KCkKCiAgICAiIiIKICAgIFVzZSBzYWZlciBuYW1lcy4KICAgICIiIgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIG5vcm1hbGl6ZU5hbWUobmFtZSwgaXNGaWxlbmFtZT1UcnVlLCBlc2NhcGVYbWw9VHJ1ZSwgcmVtb3ZlQWNjZW50cz1UcnVlKToKICAgICAgICBub3JtYWxpemVkID0gbmFtZQogICAgICAgIGlmIGVzY2FwZVhtbDoKICAgICAgICAgICAgbm9ybWFsaXplZCA9IFVUSUxTLmVzY2FwZVhtbChub3JtYWxpemVkKQogICAgICAgIGlmIHJlbW92ZUFjY2VudHM6CiAgICAgICAgICAgIG5vcm1hbGl6ZWQgPSBVVElMUy5zdHJpcF9hY2NlbnRzKG5vcm1hbGl6ZWQpCiAgICAgICAgaWYgaXNGaWxlbmFtZToKICAgICAgICAgICAgbm9ybWFsaXplZCA9IFVUSUxTLmVzY2FwZUZpbGVuYW1lKG5vcm1hbGl6ZWQpCiAgICAgICAgcmV0dXJuIG5vcm1hbGl6ZWQubG93ZXIoKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBlc2NhcGVGaWxlbmFtZShjb250ZW50KToKICAgICAgICByZXR1cm4gcmUuc3ViKHIiXFciLCAiXyIsIGNvbnRlbnQpCgogICAgI2h0dHBzOi8vcHluYXRpdmUuY29tL3B5dGhvbi1nZW5lcmF0ZS1yYW5kb20tc3RyaW5nLwogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHJhbmRvbVN0cmluZyhzdHJpbmdMZW5ndGg9MjcpOgogICAgICAgICIiIkdlbmVyYXRlIGEgcmFuZG9tIHN0cmluZyBvZiBmaXhlZCBsZW5ndGggIiIiCiAgICAgICAgbGV0dGVycyA9IHN0cmluZy5hc2NpaV9sb3dlcmNhc2UKICAgICAgICByZXR1cm4gJycuam9pbihyYW5kb20uY2hvaWNlKGxldHRlcnMpIGZvciBpIGluIHJhbmdlKHN0cmluZ0xlbmd0aCkpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHNlbmRSZXBvcnQoZGljdFBhcmFtKToKICAgICAgICByZXEgPSByZXF1ZXN0cy5nZXQodXJsPSdodHRwOi8vY3NyLnVmbWcuYnIvaW1hZ2VyeS9zYXZlX3JlcG9ydHMucGhwPycgKyB1cmxlbmNvZGUoZGljdFBhcmFtKSkKICAgICAgICBpZiByZXEuc3RhdHVzX2NvZGUgPT0gSFRUUFN0YXR1cy5PSzoKICAgICAgICAgICAgcmV0dXJuIHJlcS50ZXh0CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuICcnCgogICAgI1JldHVybiB0aGUgbWFwIGV4dGVudHMgaW4gdGhlIGdpdmVuIHByb2plY3Rpb24KICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRNYXBFeHRlbnQobGF5ZXIsIHByb2plY3Rpb24pOgogICAgICAgIG1hcEV4dGVudCA9IGxheWVyLmV4dGVudCgpCiAgICAgICAgcHJvamVjdGlvbi52YWxpZGF0ZSgpCiAgICAgICAgbGF5ZXIuY3JzKCkudmFsaWRhdGUoKQogICAgICAgIHNyY190b19wcm9qID0gUWdzQ29vcmRpbmF0ZVRyYW5zZm9ybShsYXllci5jcnMoKSwgcHJvamVjdGlvbiwgUWdzUHJvamVjdC5pbnN0YW5jZSgpLnRyYW5zZm9ybUNvbnRleHQoKSBpZiBnZXRhdHRyKGxheWVyLCAidHJhbnNmb3JtQ29udGV4dCIsIE5vbmUpIGlzIE5vbmUgZWxzZSBsYXllci50cmFuc2Zvcm1Db250ZXh0KCkpCiAgICAgICAgcmV0dXJuIHNyY190b19wcm9qLnRyYW5zZm9ybUJvdW5kaW5nQm94KG1hcEV4dGVudCkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZXNjYXBlWG1sKGNvbnRlbnQpOgogICAgICAgIHJldHVybiBlc2NhcGUoY29udGVudCkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgc3RyaXBfYWNjZW50cyhzKToKICAgICAgIHJldHVybiAnJy5qb2luKGMgZm9yIGMgaW4gdW5pY29kZWRhdGEubm9ybWFsaXplKCdORkQnLCBzKQogICAgICAgICAgICAgICAgICAgICAgaWYgdW5pY29kZWRhdGEuY2F0ZWdvcnkoYykgIT0gJ01uJykKCiAgICAjIFRNUyBmdW5jdGlvbnMgdGFrZW4gZnJvbSBodHRwczovL2FsYXN0YWlyYS53b3JkcHJlc3MuY29tLzIwMTEvMDcvMDYvY29udmVydGluZy10bXMtdGlsZS1jb29yZGluYXRlcy10by1nb29nbGViaW5nb3NtLXRpbGUtY29vcmRpbmF0ZXMvICNzcGVsbG9rCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgdG1zKHl0aWxlLCB6b29tKToKICAgICAgICBuID0gMi4wICoqIHpvb20KICAgICAgICB5dGlsZSA9IG4gLSB5dGlsZSAtIDEKICAgICAgICByZXR1cm4gaW50KHl0aWxlKQoKICAgICMgTWF0aCBmdW5jdGlvbnMgdGFrZW4gZnJvbSBodHRwczovL3dpa2kub3BlbnN0cmVldG1hcC5vcmcvd2lraS9TbGlwcHlfbWFwX3RpbGVuYW1lcyAjc3BlbGxvawogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGRlZzJudW0obGF0X2RlZywgbG9uX2RlZywgem9vbSk6CiAgICAgICAgUWdzTWVzc2FnZUxvZy5sb2dNZXNzYWdlKCIgZSAiLmpvaW4oW3N0cihsYXRfZGVnKSwgc3RyKGxvbl9kZWcpLCBzdHIoem9vbSldKSwgdGFnPSJQcm9jZXNzaW5nIikKICAgICAgICBsYXRfcmFkID0gbWF0aC5yYWRpYW5zKGxhdF9kZWcpCiAgICAgICAgbiA9IDIuMCAqKiB6b29tCiAgICAgICAgeHRpbGUgPSBpbnQoKGxvbl9kZWcgKyAxODAuMCkgLyAzNjAuMCAqIG4pCiAgICAgICAgeXRpbGUgPSBpbnQoKDEuMCAtIG1hdGguYXNpbmgobWF0aC50YW4obGF0X3JhZCkpIC8gbWF0aC5waSkgLyAyLjAgKiBuKQogICAgICAgIHJldHVybiAoeHRpbGUsIHl0aWxlKQoKICAgICMgTWF0aCBmdW5jdGlvbnMgdGFrZW4gZnJvbSBodHRwczovL3dpa2kub3BlbnN0cmVldG1hcC5vcmcvd2lraS9TbGlwcHlfbWFwX3RpbGVuYW1lcyAjc3BlbGxvawogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIG51bTJkZWcoeHRpbGUsIHl0aWxlLCB6b29tKToKICAgICAgICBuID0gMi4wICoqIHpvb20KICAgICAgICBsb25fZGVnID0geHRpbGUgLyBuICogMzYwLjAgLSAxODAuMAogICAgICAgIGxhdF9yYWQgPSBtYXRoLmF0YW4obWF0aC5zaW5oKG1hdGgucGkgKiAoMSAtIDIgKiB5dGlsZSAvIG4pKSkKICAgICAgICBsYXRfZGVnID0gbWF0aC5kZWdyZWVzKGxhdF9yYWQpCiAgICAgICAgcmV0dXJuIChsYXRfZGVnLCBsb25fZGVnKQoKICAgICMgVGhpcyBmdW5jdGlvbiBnZXRzIGEgc3lzdGVtIHZhcmlhYmxlCiAgICAjIGl0IHdhcyBuZWNlc3NhcnkgdG8gdXNlIHRoaXMgaW5zdGVhZCBvZiBvcy5lbnZpcm9uWyJQQVRIIl0gYmVjYXVzZSBRR0lTIG92ZXJ3cml0ZXMgdGhlIHBhdGggdmFyaWFibGUKICAgICMgdGhlIHdpbjMyIGxpYnJhcmllcyBhcHBlYXIgbm90IHRvIGJlIHBhcnQgb2YgdGhlIHN0YW5kYXJkIHB5dGhvbiBpbnN0YWxsLCBidXQgdGhleSBhcmUgaW5jbHVkZWQgaW4gdGhlCiAgICAjIHB5dGhvbiB2ZXJzaW9uIHRoYXQgY29tZXMgd2l0aCBRR0lTCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0ZW52X3N5c3RlbSh2YXJuYW1lLCBkZWZhdWx0PScnKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGltcG9ydCBvcwogICAgICAgICAgICBpbXBvcnQgd2luMzJhcGkKICAgICAgICAgICAgaW1wb3J0IHdpbjMyY29uCiAgICAgICAgICAgIHYgPSBkZWZhdWx0CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJrZXkgPSB3aW4zMmFwaS5SZWdPcGVuS2V5KHdpbjMyY29uLkhLRVlfTE9DQUxfTUFDSElORSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdTWVNURU1cXEN1cnJlbnRDb250cm9sU2V0XFxDb250cm9sXFxTZXNzaW9uIE1hbmFnZXJcXEVudmlyb25tZW50JykKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICB2ID0gc3RyKHdpbjMyYXBpLlJlZ1F1ZXJ5VmFsdWVFeChya2V5LCB2YXJuYW1lKVswXSkKICAgICAgICAgICAgICAgICAgICB2ID0gd2luMzJhcGkuRXhwYW5kRW52aXJvbm1lbnRTdHJpbmdzKHYpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAgICAgd2luMzJhcGkuUmVnQ2xvc2VLZXkocmtleSkKICAgICAgICAgICAgcmV0dXJuIHYKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHJldHVybiAnJwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBpc19leGUoZnBhdGgpOgogICAgICAgIHJldHVybiBvcy5wYXRoLmlzZmlsZShmcGF0aCkgYW5kIG9zLmFjY2VzcyhmcGF0aCwgb3MuWF9PSykKCiAgICAjIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzM3NzAxNy90ZXN0LWlmLWV4ZWN1dGFibGUtZXhpc3RzLWluLXB5dGhvbi8xMjYxMTUyMwogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHdoaWNoKHByb2dyYW0pOgogICAgICAgIGZwYXRoLCBmbmFtZSA9IG9zLnBhdGguc3BsaXQocHJvZ3JhbSkKICAgICAgICBpZiBmcGF0aDoKICAgICAgICAgICAgaWYgVVRJTFMuaXNfZXhlKHByb2dyYW0pOgogICAgICAgICAgICAgICAgcmV0dXJuIHByb2dyYW0KICAgICAgICBlbHNlOgogICAgICAgICAgICBmb3IgcGF0aCBpbiBvcy5lbnZpcm9uWyJQQVRIIl0uc3BsaXQob3MucGF0aHNlcCk6CiAgICAgICAgICAgICAgICBleGVfZmlsZSA9IG9zLnBhdGguam9pbihwYXRoLCBwcm9ncmFtKQogICAgICAgICAgICAgICAgaWYgVVRJTFMuaXNfZXhlKGV4ZV9maWxlKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhlX2ZpbGUKICAgICAgICAgICAgZm9yIHBhdGggaW4gVVRJTFMuZ2V0ZW52X3N5c3RlbSgiUEFUSCIpLnNwbGl0KG9zLnBhdGhzZXApOgogICAgICAgICAgICAgICAgZXhlX2ZpbGUgPSBvcy5wYXRoLmpvaW4ocGF0aCwgcHJvZ3JhbSkKICAgICAgICAgICAgICAgIGlmIFVUSUxTLmlzX2V4ZShleGVfZmlsZSk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4ZV9maWxlCgogICAgICAgIHJldHVybiBOb25lCgpjbGFzcyBVc2VySW50ZXJydXB0ZWQoRXhjZXB0aW9uKToKICAgIHBhc3MKCiMgY2xhc3MgVGltZWRNZXNzYWdlQm94KFFNZXNzYWdlQm94KToKIyAgICAgZGVmIF9faW5pdF9fKHNlbGYsIHRpbWVvdXQsIG1lc3NhZ2UsIGNhbGxiYWNrKToKIyAgICAgICAgIHN1cGVyKFRpbWVkTWVzc2FnZUJveCwgc2VsZikuX19pbml0X18oKQojICAgICAgICAgc2VsZi50aW1lb3V0ID0gdGltZW91dAojICAgICAgICAgc2VsZi5jYWxsYmFjayA9IGNhbGxiYWNrCiMKIyAgICAgZGVmIGludGVydmFsQ2FsbGJhY2soc2VsZik6CiMgICAgICAgICBzZWxmLmNhbGxiYWNrKCkKIyAgICAgICAgIFFUaW1lcigpLnNpbmdsZVNob3Qoc2VsZi50aW1lb3V0KjEwMDAsIHNlbGYuaW50ZXJ2YWxDYWxsYmFjaykKIwojICAgICBkZWYgc2hvd0V2ZW50KHNlbGYsIGV2ZW50KToKIyAgICAgICAgIFFUaW1lcigpLnNpbmdsZVNob3Qoc2VsZi50aW1lb3V0KjEwMDAsIHNlbGYuaW50ZXJ2YWxDYWxsYmFjaykKIyAgICAgICAgIHN1cGVyKFRpbWVkTWVzc2FnZUJveCwgc2VsZikuc2hvd0V2ZW50KGV2ZW50KQoKCnRyeToKICAgIGZyb20gR2l0SHViIGltcG9ydCBHaXRIdWIKZXhjZXB0OgogICAgcGFzcyAjTm90IGluIERpbmFtaWNhIENvZGUKCmltcG9ydCByZQppbXBvcnQgb3MKaW1wb3J0IHJhbmRvbQppbXBvcnQgd2ViYnJvd3NlcgppbXBvcnQgcmVxdWVzdHMKaW1wb3J0IHRpbWUKaW1wb3J0IGpzb24KaW1wb3J0IGdsb2IKaW1wb3J0IHRlbXBmaWxlCmltcG9ydCBwbGF0Zm9ybQppbXBvcnQgc3VicHJvY2Vzcwpmcm9tIGh0dHAgaW1wb3J0IEhUVFBTdGF0dXMKZnJvbSByZXF1ZXN0cyBpbXBvcnQgcmVxdWVzdApmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZQpmcm9tIHRpbWUgaW1wb3J0IHNsZWVwCgoKCmlzRGluYW1pY2EgPSBGYWxzZQp0cnk6CiAgICBkaW5hbWljYS5wYWNrYWdlKCJvcyIpCiAgICBpc0RpbmFtaWNhID0gVHJ1ZQpleGNlcHQ6CiAgICBpc0RpbmFtaWNhID0gRmFsc2UKCnRyeToKICAgIGZyb20gVVRJTFMgaW1wb3J0IFVUSUxTCiAgICBmcm9tIFFNZXNzYWdlQm94IGltcG9ydCBRTWVzc2FnZUJveApleGNlcHQ6CiAgICBwYXNzICNOb3QgaW4gRGluYW1pY2EgQ29kZQoKdHJ5OgogICAgZnJvbSBxZ2lzLlB5UXQuUXRXaWRnZXRzIGltcG9ydCBRTWVzc2FnZUJveApleGNlcHQ6CiAgICBwYXNzICNOb3QgaW4gUUdJUwoKY2xhc3MgR2l0SHViOgoKICAgIG9yaWdpbk5hbWUgPSAibWFwcGlhIgogICAgcmVsZWFzZU5hbWUgPSAiTWFwX0Rvd25sb2FkIgogICAgZ2l0aHViQXBpID0gJ2h0dHBzOi8vYXBpLmdpdGh1Yi5jb20vJwoKICAgIHBlcnNvbmFsX3Rva2VuID0gJycKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgdGVzdExvZ2luKHVzZXIsIHRva2VuKToKICAgICAgICByZXR1cm4gcmVxdWVzdHMuZ2V0KHVybD1HaXRIdWIuZ2l0aHViQXBpICsgJ3VzZXInLCBhdXRoPSh1c2VyLCB0b2tlbikpLnN0YXR1c19jb2RlID09IDIwMAoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBwcmVwYXJlRW52aXJvbm1lbnQoZ2l0RXhlY3V0YWJsZSk6CiAgICAgICAgaWYgbm90IGdpdEV4ZWN1dGFibGU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGdpdFByb2dyYW1Gb2xkZXIgPSBvcy5wYXRoLmRpcm5hbWUoZ2l0RXhlY3V0YWJsZSkKICAgICAgICAjZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKGdpdFByb2dyYW1Gb2xkZXIpICNjaW56YSBlc2NvbmRpZG8KICAgICAgICAjZmVlZGJhY2suc2V0UHJvZ3Jlc3NUZXh0KGdpdEV4ZWN1dGFibGUpICNwcmV0bwogICAgICAgIG9zLmVudmlyb25bJ0dJVF9QWVRIT05fR0lUX0VYRUNVVEFCTEUnXSA9IGdpdEV4ZWN1dGFibGUKICAgICAgICAjaW5pdGlhbFBhdGggPSBvcy5lbnZpcm9uWydQQVRIJ10KICAgICAgICBvcy5lbnZpcm9uWydHSVRfUFlUSE9OX1JFRlJFU0gnXSA9ICdxdWlldCcKICAgICAgICBpbXBvcnQgZ2l0CiAgICAgICAgZ2l0LnJlZnJlc2goZ2l0RXhlY3V0YWJsZSkKICAgICAgICB0cnk6CiAgICAgICAgICAgIG9zLmVudmlyb25bJ1BBVEgnXS5zcGxpdChvcy5wYXRoc2VwKS5pbmRleChnaXRQcm9ncmFtRm9sZGVyKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgb3MuZW52aXJvblsiUEFUSCJdID0gZ2l0UHJvZ3JhbUZvbGRlciArIG9zLnBhdGhzZXAgKyBvcy5lbnZpcm9uWyJQQVRIIl0KCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgaW5zdGFsbF9naXQobXVzdEFza1VzZXIpOgogICAgICAgIGRlZiB1c2VyQ29uZmlybWVkKCk6CiAgICAgICAgICAgIHJldHVybiBRTWVzc2FnZUJveC5ZZXMgPT0gUU1lc3NhZ2VCb3gucXVlc3Rpb24oTm9uZSwgIlJlcXVpcmVkIEdJVCBleGVjdXRhYmxlIHdhcyBub3QgZm91bmQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJDbGljayAnWUVTJyB0byBzdGFydCBkb3dubG9hZCBhbmQgY29udGludWUsIG90aGVyd2lzZSBwbGVhc2Ugc2VsZWN0IHRoZSBleGVjdXRhYmxlIG1hbnVhbGx5LiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdEJ1dHRvbj1RTWVzc2FnZUJveC5ZZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9ucz0oUU1lc3NhZ2VCb3guWWVzIHwgUU1lc3NhZ2VCb3guTm8gfCBRTWVzc2FnZUJveC5DYW5jZWwpKQoKICAgICAgICBpZiBub3QgKCJXaW5kb3dzIiBpbiBwbGF0Zm9ybS5zeXN0ZW0oKSBvciAiQ1lHV0lOX05UIiBpbiBwbGF0Zm9ybS5zeXN0ZW0oKSk6CiAgICAgICAgICAgIFFNZXNzYWdlQm94LnF1ZXN0aW9uKE5vbmUsICJGYWlsZWQgdG8gZmluZCBHSVQgZXhlY3V0YWJsZSIsICJQbGVhc2UgaW5zdGFsbCBnaXQgaW4geW91ciBzeXN0ZW0gYW5kIGZpbGwgdGhlIHBhcmFtZXRlciBHSVQgZXhlY3V0YWJsZSBwYXRoLiIpCiAgICAgICAgaWYgKG5vdCBtdXN0QXNrVXNlciBvciB1c2VyQ29uZmlybWVkKCkpID09IEZhbHNlOgogICAgICAgICAgICByZXR1cm4gJycKCiAgICAgICAgZGVmIGRvd25sb2FkX2ZpbGUodXJsLCB0b0Rpcik6CiAgICAgICAgICAgIGxvY2FsX2ZpbGVuYW1lID0gb3MucGF0aC5qb2luKHRvRGlyLCB1cmwuc3BsaXQoJy8nKVstMV0pCiAgICAgICAgICAgICMgTk9URSB0aGUgc3RyZWFtPVRydWUgcGFyYW1ldGVyIGJlbG93CiAgICAgICAgICAgIHdpdGggcmVxdWVzdHMuZ2V0KHVybCwgc3RyZWFtPVRydWUpIGFzIHI6CiAgICAgICAgICAgICAgICByLnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICAgICAgICAgICAgd2l0aCBvcGVuKGxvY2FsX2ZpbGVuYW1lLCAnd2InKSBhcyBmOgogICAgICAgICAgICAgICAgICAgIGZvciBjaHVuayBpbiByLml0ZXJfY29udGVudChjaHVua19zaXplPTgxOTIpOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBjaHVuazogICMgZmlsdGVyIG91dCBrZWVwLWFsaXZlIG5ldyBjaHVua3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYud3JpdGUoY2h1bmspCiAgICAgICAgICAgIHJldHVybiBsb2NhbF9maWxlbmFtZQoKICAgICAgICB0bXBEaXIgPSB0ZW1wZmlsZS5ta2R0ZW1wKCkKICAgICAgICBnaXRVcmwgPSAiaHR0cHM6Ly9naXRodWIuY29tL2dpdC1mb3Itd2luZG93cy9naXQvcmVsZWFzZXMvZG93bmxvYWQvdjIuMjUuMS53aW5kb3dzLjEvUG9ydGFibGVHaXQtMi4yNS4xLTY0LWJpdC43ei5leGUiCiAgICAgICAgIyBRTWVzc2FnZUJveC5pbmZvcm1hdGlvbihOb25lLCAiU3RhcnRpbmcgR0lUIGRvd25sb2FkIiwgIlRoaXMgc3RlcCB3aWxsIHRha2Ugc29tZSB0aW1lLCBpdCBkZXBlbmRzIG9uIHlvdXIgaW50ZXJuZXQgc3BlZWQuXG5DbGljayAnT0snIHRvIGNvbnRpbnVlLiIsIGRlZmF1bHRCdXR0b249UU1lc3NhZ2VCb3guT2ssIGJ1dHRvbnM9UU1lc3NhZ2VCb3guT2spCiAgICAgICAgc2VsZkV4dHJhY3RvciA9IGRvd25sb2FkX2ZpbGUoZ2l0VXJsLCB0bXBEaXIpCiAgICAgICAgcG9ydGFibGVHaXQgPSBvcy5wYXRoLmpvaW4odG1wRGlyLCAicG9ydGFibGVnaXQiKQogICAgICAgIGlmIChub3Qgb3MucGF0aC5pc2ZpbGUoc2VsZkV4dHJhY3RvcikpOgogICAgICAgICAgICByZXR1cm4gJycKICAgICAgICBzdWJwcm9jZXNzLmNoZWNrX291dHB1dChbc2VsZkV4dHJhY3RvciwgJy1vJywgcG9ydGFibGVHaXQsICIteSJdKQogICAgICAgIHJldHVybiBvcy5wYXRoLmpvaW4ocG9ydGFibGVHaXQsICdtaW5ndzY0JywgJ2JpbicsICdnaXQuZXhlJykKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0R2l0RXhlKCk6CiAgICAgICAgZ2l0RXhlID0gJycKICAgICAgICB0cnk6CiAgICAgICAgICAgIGdpdEV4ZSA9IG9zLmVudmlyb25bJ0dJVF9QWVRIT05fR0lUX0VYRUNVVEFCTEUnXQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwogICAgICAgIHJldHVybiBnaXRFeGUKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0UmVwb3NpdG9yeVNpemUodXNlciwgcmVwb3NpdG9yeSwgcGFzc3dvcmQpOgogICAgICAgIHJlc3BvbnNlID0gR2l0SHViLl9yZXF1ZXN0KCdHRVQnLCAnaHR0cHM6Ly9hcGkuZ2l0aHViLmNvbS9yZXBvcy8nICsgdXNlciArICIvIiArIHJlcG9zaXRvcnksIHRva2VuPXBhc3N3b3JkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM9eydDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbid9KQogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICAgICAgcmV0dXJuIGpzb24ubG9hZHMocmVzcG9uc2UuY29udGVudClbJ3NpemUnXQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcHJpbnQoIkZhaWxlZCB0byBnZXQgdGhlIHJlcG9zaXRvcnkgc2l6ZSwgaWdub3JpbmcgaXQuIikKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICByZXR1cm4gTm9uZQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRHaXRVcmwoZ2l0aHViVXNlciwgZ2l0aHViUmVwb3NpdG9yeSk6CiAgICAgICAgcmV0dXJuICJodHRwczovL2dpdGh1Yi5jb20vIiArIGdpdGh1YlVzZXIgKyAiLyIgKyBnaXRodWJSZXBvc2l0b3J5ICsgIi8iCgogICAgI05vIHBhc3N3b3JkIHRvIGFsbG93IHVzaW5nIGNvbmZpZ3VyZWQgU1NIS2V5LgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldEdpdFBhc3NVcmwodXNlciwgcmVwb3NpdG9yeSwgcGFzc3dvcmQpOgogICAgICAgIGlmIHBhc3N3b3JkIGlzIE5vbmUgb3Igbm90IHBhc3N3b3JkOgogICAgICAgICAgICByZXR1cm4gR2l0SHViLmdldEdpdFVybCh1c2VyLCByZXBvc2l0b3J5KQogICAgICAgIHJldHVybiAiaHR0cHM6Ly8iICsgdXNlciArICI6IiArIHBhc3N3b3JkICsgIkBnaXRodWIuY29tLyIgKyB1c2VyICsgIi8iICsgcmVwb3NpdG9yeSArICIvIgoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBsc3JlbW90ZSh1cmwpOgogICAgICAgIGltcG9ydCBnaXQKICAgICAgICByZW1vdGVfcmVmcyA9IHt9CiAgICAgICAgZyA9IGdpdC5jbWQuR2l0KCkKICAgICAgICBmb3IgcmVmIGluIGcubHNfcmVtb3RlKHVybCkuc3BsaXQoJ1xuJyk6CiAgICAgICAgICAgIGhhc2hfcmVmX2xpc3QgPSByZWYuc3BsaXQoJ1x0JykKICAgICAgICAgICAgcmVtb3RlX3JlZnNbaGFzaF9yZWZfbGlzdFsxXV0gPSBoYXNoX3JlZl9saXN0WzBdCiAgICAgICAgcmV0dXJuIHJlbW90ZV9yZWZzCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGV4aXN0c1JlcG9zaXRvcnkodXNlciwgcmVwb3NpdG9yeSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICAjZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJVUkw6ICIgKyBHaXRIdWIuZ2V0R2l0VXJsKHVzZXIsIHJlcG9zaXRvcnkpKQogICAgICAgICAgICByZXNwID0gcmVxdWVzdHMuZ2V0KEdpdEh1Yi5nZXRHaXRVcmwodXNlciwgcmVwb3NpdG9yeSkpCiAgICAgICAgICAgIGlmIHJlc3Auc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAjcmVzdWx0ID0gR2l0SHViLmxzcmVtb3RlKEdpdEh1Yi5nZXRHaXRVcmwodXNlciwgcmVwb3NpdG9yeSkpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgY29uZmlnVXNlcihyZXBvLCB1c2VyKToKICAgICAgICByZXBvLmdpdC5jb25maWcoInVzZXIuZW1haWwiLCB1c2VyKQogICAgICAgIHJlcG8uZ2l0LmNvbmZpZygidXNlci5uYW1lIiwgdXNlcikKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0UmVwb3NpdG9yeShmb2xkZXIsIHVzZXIsIHJlcG9zaXRvcnksIHBhc3N3b3JkLCBmZWVkYmFjayk6CiAgICAgICAgZnJvbSBnaXQgaW1wb3J0IFJlcG8KICAgICAgICBmcm9tIGdpdCBpbXBvcnQgSW52YWxpZEdpdFJlcG9zaXRvcnlFcnJvcgoKICAgICAgICAjICNOw6NvIGVzdMOhIGZ1bmNpb25hbmRvIGEgdmFsaWRhw6fDo28gI0ZJWE1FIFJlcG9zaXRvcnkgY3JlYXRpb24gdmVyaWZpY2F0aW9uIGlzIG5vdCB3b3JraW5nIChNb2RpZnkgdGhlIGNyZWF0ZSBSZXBvIGZ1bmN0aW9uIHRvIHZlcmlmeSB0aGUgY3JlYXRpb24pCiAgICAgICAgIyAjZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKHVzZXIgKyAnIGF0ICcgKyByZXBvc2l0b3J5KQogICAgICAgICMgaWYgbm90IEdpdEh1Yi5leGlzdHNSZXBvc2l0b3J5KHVzZXIsIHJlcG9zaXRvcnkpOgogICAgICAgICMgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiVGhlIHJlcG9zaXRvcnkgIiArIHJlcG9zaXRvcnkgKyAiIGRvZXNuJ3QgZXhpc3RzLlxuUGxlYXNlIGNyZWF0ZSBhIG5ldyBvbmUgYXQgaHR0cHM6Ly9naXRodWIuY29tL25ldyAuIikKICAgICAgICAjICAgICByZXR1cm4gTm9uZQoKICAgICAgICAjQ3JpYSBvdSBwZWdhIG8gcmVwb3NpdMOzcmlvIGF0dWFsLgogICAgICAgIHJlcG8gPSBOb25lCiAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGZvbGRlcikgb3IgKG9zLnBhdGguZXhpc3RzKGZvbGRlcikgYW5kIG5vdCBvcy5saXN0ZGlyKGZvbGRlcikpOgogICAgICAgICAgICByZXBvU2l6ZSA9IEdpdEh1Yi5nZXRSZXBvc2l0b3J5U2l6ZSh1c2VyLCByZXBvc2l0b3J5LCBwYXNzd29yZCkKICAgICAgICAgICAgaWYgcmVwb1NpemUgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICByZXBvU2l6ZSA9IHN0cihyZXBvU2l6ZSkgKyAiKGtiKSIKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJlcG9TaXplID0gJycKICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJDbG9uaW5nIGdpdCByZXBvc2l0b3J5OiAiICsgR2l0SHViLmdldEdpdFVybCh1c2VyLCByZXBvc2l0b3J5KSArICJcblBsZWFzZSB3YWl0LCBpdCB3aWxsIGRvd25sb2FkIGFsbCBtYXBzIGluIHlvdXIgcmVwb3NpdG9yeS4gIiArIHJlcG9TaXplKQogICAgICAgICAgICByZXBvID0gR2l0SW50ZXJhY3RpdmUuY2xvbmVSZXBvKHVzZXIsIHJlcG9zaXRvcnksIGZvbGRlciwgZmVlZGJhY2spI1JlcG8uY2xvbmVfZnJvbShHaXRIdWIuZ2V0R2l0VXJsKHVzZXIsIHJlcG9zaXRvcnkpLCBmb2xkZXIsIHJlY3Vyc2l2ZT1UcnVlLCBwcm9ncmVzcz1HaXRIdWIuZ2V0R2l0UHJvZ3Jlc3NSZXBvcnQoZmVlZGJhY2spKQogICAgICAgICAgICBhc3NlcnQgKG9zLnBhdGguZXhpc3RzKGZvbGRlcikpCiAgICAgICAgICAgIGFzc2VydChyZXBvKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJlcG8gPSBSZXBvKGZvbGRlcikKICAgICAgICAgICAgICAgIHJlcG9VcmwgPSByZXBvLmdpdC5yZW1vdGUoIi12IikKICAgICAgICAgICAgICAgIGV4cGVjdGVkVXJsID0gR2l0SHViLmdldEdpdFVybCh1c2VyLCByZXBvc2l0b3J5KQogICAgICAgICAgICAgICAgaWYgcmVwb1VybCBhbmQgbm90IChleHBlY3RlZFVybCBpbiByZS5jb21waWxlKCJbXFxuXFx0IF0iKS5zcGxpdChyZXBvVXJsKSk6CiAgICAgICAgICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJZb3VyIHJlbW90ZSBVUkwgIiArIHJlcG9VcmwgKyAiIGRvZXMgbm90IG1hdGNoIHRoZSBleHBlY3RlZCB1cmwgIiArIGV4cGVjdGVkVXJsKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICBleGNlcHQgSW52YWxpZEdpdFJlcG9zaXRvcnlFcnJvciBhcyBlOgogICAgICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJUaGUgZGVzdGluYXRpb24gZm9sZGVyIG11c3QgYmUgYSByZXBvc2l0b3J5IG9yIGFuIGVtcHR5IGZvbGRlci4gUmVhc29uOiAiICsgc3RyKGUpKQogICAgICAgICAgICAgICAgI3JlcG8gPSBSZXBvLmluaXQoZm9sZGVyLCBiYXJlPUZhbHNlKQogICAgICAgIHJldHVybiByZXBvCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGlzT3B0aW9uc09rKGZvbGRlciwgdXNlciwgcmVwb3NpdG9yeSwgZmVlZGJhY2ssIGdoUGFzc3dvcmQ9Tm9uZSwgbXVzdEFza1VzZXI9RmFsc2UpOgogICAgICAgIHRyeSA6CiAgICAgICAgICAgICNDcmlhIG91IHBlZ2EgbyByZXBvc2l0w7NyaW8gYXR1YWwuCiAgICAgICAgICAgIHJlcG8gPSBHaXRIdWIuZ2V0UmVwb3NpdG9yeShmb2xkZXIsIHVzZXIsIHJlcG9zaXRvcnksIGdoUGFzc3dvcmQsIGZlZWRiYWNrKQogICAgICAgICAgICBpZiBub3QgcmVwbzoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICBHaXRIdWIuY29uZmlnVXNlcihyZXBvLCB1c2VyKQogICAgICAgICAgICBpZiByZXBvLmdpdC5zdGF0dXMoIi0tcG9yY2VsYWluIik6CiAgICAgICAgICAgICAgICByZXNwb25zZSA9IG5vdCBtdXN0QXNrVXNlciBvciBRTWVzc2FnZUJveC5xdWVzdGlvbihOb25lLCAiTG9jYWwgcmVwb3NpdG9yeSBpcyBub3QgY2xlYW4uIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJUaGUgZm9sZGVyIGhhdmUgbG9jYWwgY2hhbmdlcywgd2UgbmVlZCB0byBmaXggdG8gY29udGludWUuXG5DbGljayAnRElTQ0FSRCcgdG8gZGlzY2FyZCBjaGFuZ2VzLCAnWUVTJyB0byBjb21taXQgY2hhbmdlcywgb3RoZXJ3aXNlIGNsaWNrICdDQU5DRUwnIHRvIGNhbmNlbCBhbmQgcmVzb2x2ZSBtYW51YWxseS4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9ucz0oUU1lc3NhZ2VCb3guRGlzY2FyZCB8IFFNZXNzYWdlQm94LlllcyB8IFFNZXNzYWdlQm94LkNhbmNlbCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0QnV0dG9uPVFNZXNzYWdlQm94LkRpc2NhcmQpCiAgICAgICAgICAgICAgICBpZiBub3QgbXVzdEFza1VzZXIgb3IgcmVzcG9uc2UgPT0gUU1lc3NhZ2VCb3guWWVzOgogICAgICAgICAgICAgICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiUHVsbGluZyByZW1vdGUgcmVwb3NpdG9yeSBjaGFuZ2VzIHRvIHlvdXIgZGlyZWN0b3J5LiIpCiAgICAgICAgICAgICAgICAgICAgR2l0SHViLnRyeVB1bGxSZXBvc2l0b3J5KHJlcG8sIHVzZXIsIHJlcG9zaXRvcnksIGZlZWRiYWNrKSAgIyBEYW5pbG8KICAgICAgICAgICAgICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkFkZGluZyBhbGwgZmlsZXMgaW4gZm9sZGVyIikKICAgICAgICAgICAgICAgICAgICBHaXRIdWIuYWRkRmlsZXMocmVwbywgdXNlciwgcmVwb3NpdG9yeSwgZmVlZGJhY2spCiAgICAgICAgICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJBZGRpbmcgYWxsIGZpbGVzIGluIGZvbGRlciIpCiAgICAgICAgICAgICAgICAgICAgR2l0SHViLmdpdENvbW1pdChyZXBvLCBtc2c9IlFHSVMgLSBBZGRpbmcgYWxsIGZpbGVzIGluIGZvbGRlciAiICsgZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIiVkLyVtLyVZICVIOiVNOiVTIiksIGZlZWRiYWNrPWZlZWRiYWNrKQogICAgICAgICAgICAgICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiUUdJUyAtIFNlbmRpbmcgY2hhbmdlcyB0byBHaXRodWIiKQogICAgICAgICAgICAgICAgICAgICMgdHJ5OgogICAgICAgICAgICAgICAgICAgICMgICAgIFVUSUxTLnJ1bkxvbmdUYXNrKHJlcG8uZ2l0LnB1bGwsIGZlZWRiYWNrLCAnUGVhc2Ugd2FpdCwgcHVsbGluZyBjaGFuZ2VzLicsIDMwKQogICAgICAgICAgICAgICAgICAgICMgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICMgICAgIHBhc3MKICAgICAgICAgICAgICAgICAgICBHaXRIdWIucHVzaENoYW5nZXMocmVwbywgdXNlciwgcmVwb3NpdG9yeSwgZ2hQYXNzd29yZCwgZmVlZGJhY2spCiAgICAgICAgICAgICAgICBlbGlmIHJlc3BvbnNlID09IFFNZXNzYWdlQm94LkRpc2NhcmQ6CiAgICAgICAgICAgICAgICAgICAgcmVwby5naXQuY2xlYW4oIi1kZiIpCiAgICAgICAgICAgICAgICAgICAgcmVwby5naXQuY2hlY2tvdXQoJy0tJywgJy4nKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkVycm9yOiBMb2NhbCByZXBvc2l0b3J5IGlzIG5vdCBjbGVhbi5cblBsZWFzZSBjb21taXQgdGhlIGNoYW5nZXMgbWFkZSB0byBsb2NhbCByZXBvc2l0b3J5IGJlZm9yZSBydW4uXG5Vc2U6IGdpdCBhZGQgKiBhbmQgZ2l0IGNvbW1pdCAtbSBcIk1TR1wiIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBHaXRIdWIudHJ5UHVsbFJlcG9zaXRvcnkocmVwbywgdXNlciwgcmVwb3NpdG9yeSwgZmVlZGJhY2spCiAgICAgICAgICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJHaXQ6IENoZWNraW5nIG91dCBjaGFuZ2VzLiIpCiAgICAgICAgICAgICAgICAgICAgcmVwby5naXQuY2hlY2tvdXQoJy0tJywgJy4nKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGV4OgogICAgICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkNhbmNlbGVkIGR1ZSB0bzogezB9Ii5mb3JtYXQoZXgpKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZmluZEdpdEV4ZShnaXRFeGUsIGZvdW5kX2dpdCwgbXVzdEFza1VzZXIpOgogICAgICAgIGlmIChub3QgZ2l0RXhlIG9yIG5vdCBvcy5wYXRoLmlzZmlsZShnaXRFeGUpKSBhbmQgKG5vdCAnR0lUX1BZVEhPTl9HSVRfRVhFQ1VUQUJMRScgaW4gb3MuZW52aXJvbiBvciBub3Qgb3MucGF0aC5pc2ZpbGUob3MuZW52aXJvblsnR0lUX1BZVEhPTl9HSVRfRVhFQ1VUQUJMRSddKSkgYW5kIChub3QgZm91bmRfZ2l0IG9yIG9zLnBhdGguaXNmaWxlKGZvdW5kX2dpdCkpOgogICAgICAgICAgICBnaXRFeGUgPSBHaXRIdWIuaW5zdGFsbF9naXQobXVzdEFza1VzZXIpCiAgICAgICAgcmV0dXJuIGdpdEV4ZQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiB0cnlQdWxsUmVwb3NpdG9yeShyZXBvLCB1c2VyLCByZXBvc2l0b3J5LCBmZWVkYmFjayk6CiAgICAgICAgR2l0SHViLmNvbmZpZ1VzZXIocmVwbywgdXNlcikKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiR2l0OiBQdWxsaW5nIHJlbW90ZSByZXBvc2l0b3J5IGN1cnJlbnQgc3RhdGUuIikKICAgICAgICAgICAgIyBVVElMUy5ydW5Mb25nVGFzayhyZXBvLmdpdC5wdWxsLCBmZWVkYmFjaywgJ1BlYXNlIHdhaXQsIHB1bGxpbmcgY2hhbmdlcy4nLCAzMCwgIiAtcyByZWN1cnNpdmUgLVggb3VycyAiICsgR2l0SHViLmdldEdpdFVybCh1c2VyLCByZXBvc2l0b3J5KSArICJtYXN0ZXIiKQogICAgICAgICAgICBVVElMUy5ydW5Mb25nVGFzayhyZXBvLmdpdC5wdWxsLCBmZWVkYmFjaywgJ1BlYXNlIHdhaXQsIHB1bGxpbmcgY2hhbmdlcy4nLCAzMCwgIi1zIiwgInJlY3Vyc2l2ZSIsICItWCIsICJvdXJzIiwgR2l0SHViLmdldEdpdFVybCh1c2VyLCByZXBvc2l0b3J5KSwgIm1hc3RlciIpCiAgICAgICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiQmVmb3JlIGZldGNoIGNoYW5nZXMuIikKICAgICAgICAgICAgVVRJTFMucnVuTG9uZ1Rhc2socmVwby5naXQuZmV0Y2gsIGZlZWRiYWNrLCAnUGxlYXNlIHdhaXQsIGZldGNoaW5nIGNoYW5nZXMuJywgMzAsIEdpdEh1Yi5nZXRHaXRVcmwodXNlciwgcmVwb3NpdG9yeSksICJtYXN0ZXIiKQogICAgICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkdpdDogRG9pbmcgY2hlY2tvdXQuIikKICAgICAgICAgICAgVVRJTFMucnVuTG9uZ1Rhc2socmVwby5naXQuY2hlY2tvdXQsIGZlZWRiYWNrLCAnUGxlYXNlIHdhaXQsIGRvaW5nIGNoZWNrb3V0JywgMzAsICItLW91cnMiKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBjcmVhdGVSZXBvKGdoUmVwb3NpdG9yeSwgZ2hVc2VyLCBnaFBhc3MsIGZlZWRiYWNrKToKICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAnbmFtZSc6IGdoUmVwb3NpdG9yeSwKICAgICAgICAgICAgJ2Rlc2NyaXB0aW9uJzogJ1JlcG9zaXRvcnkgY29pbnRhaW5pbmcgbWFwcyBvZiB0aGUgbWFwcGlhIHB1Ymxpc2hlci4nLAogICAgICAgICAgICAnYnJhbmNoJzogJ21hc3RlcicsCiAgICAgICAgICAgICdhdXRvX2luaXQnOiAndHJ1ZScKICAgICAgICB9CiAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJDcmVhdGluZyB0aGUgbmV3IHJlcG9zaXRvcnk6ICIgKyBnaFJlcG9zaXRvcnkpCiAgICAgICAgcmVzcCA9IHJlcXVlc3RzLnBvc3QoR2l0SHViLmdpdGh1YkFwaSArICd1c2VyL3JlcG9zJywgYXV0aD0oZ2hVc2VyLCBnaFBhc3MpLCBkYXRhPWpzb24uZHVtcHMocGF5bG9hZCkpCiAgICAgICAgaWYgcmVzcC5zdGF0dXNfY29kZSA9PSAyMDE6CiAgICAgICAgICAgIHNsZWVwKDEpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHJ1bkxvbmdUYXNrKGZ1bmN0aW9uLCBmZWVkYmFjaywgd2FpdE1lc3NhZ2U9IlBsZWFzZSBXYWl0Iiwgc2Vjb25kc1JlcG9ydD02MCwgKmFyZ3MsICoqa3dBcmdzKToKICAgICAgICBmcm9tIGNvbmN1cnJlbnQgaW1wb3J0IGZ1dHVyZXMKICAgICAgICAjIGZlZWRiYWNrLnNldFByb2dyZXNzKDEpCiAgICAgICAgc3RlcFRpbWVyID0gMC41CiAgICAgICAgdG90YWxUaW1lID0gMAogICAgICAgIHdpdGggZnV0dXJlcy5UaHJlYWRQb29sRXhlY3V0b3IobWF4X3dvcmtlcnM9MSkgYXMgZXhlY3V0b3I6CiAgICAgICAgICAgIGpvYiA9IGV4ZWN1dG9yLnN1Ym1pdChmdW5jdGlvbiwgKmFyZ3MsICoqa3dBcmdzKQogICAgICAgICAgICBlbGFwc2VkVGltZSA9IDAKICAgICAgICAgICAgd2hpbGUgam9iLmRvbmUoKSA9PSBGYWxzZToKICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoc3RlcFRpbWVyKQogICAgICAgICAgICAgICAgZWxhcHNlZFRpbWUgPSBlbGFwc2VkVGltZSArIHN0ZXBUaW1lcgogICAgICAgICAgICAgICAgdG90YWxUaW1lID0gdG90YWxUaW1lICsgc3RlcFRpbWVyCiAgICAgICAgICAgICAgICBpZiBlbGFwc2VkVGltZSA+IHNlY29uZHNSZXBvcnQ6CiAgICAgICAgICAgICAgICAgICAgY2FuY2VsTXNnID0gIlxuQ2FuY2VsbGluZywgcGxlYXNlIHdhaXQgdGhlIGN1cnJlbnQgc3RlcCB0byBmaW5pc2ggZ3JhY2VmdWxseS4iIGlmIGZlZWRiYWNrLmlzQ2FuY2VsZWQoKSBlbHNlICcnCiAgICAgICAgICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJFbGFwc2VkICIgKyBzdHIocm91bmQodG90YWxUaW1lKSkgKyAiczogIiArIHdhaXRNZXNzYWdlICsgY2FuY2VsTXNnKQogICAgICAgICAgICAgICAgICAgIGVsYXBzZWRUaW1lID0gMAogICAgICAgICAgICAgICAgIyBpZiBjYW5DYW5jZWxOb3cgYW5kIGZlZWRiYWNrLmlzQ2FuY2VsZWQoKToKICAgICAgICAgICAgICAgICMgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiSm9iIHN0YXJ0aW5nIHRvIGNhbmNlbC4iKQogICAgICAgICAgICAgICAgIyAgICAgam9iLmNhbmNlbCgpCiAgICAgICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiRWxhcHNlZCAiICsgc3RyKHJvdW5kKHRvdGFsVGltZSkpICsgInMgb24gdGhpcyBzdGVwLiIpCiAgICAgICAgICAgICMgVVRJTFMuY2hlY2tGb3JDYW5jZWxlZChmZWVkYmFjaykKICAgICAgICAgICAgcmV0dXJuIGpvYi5yZXN1bHQoKQoKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0R2l0Q3JlZGVudGlhbHMoY3VyVXNlciwgY3VyUGFzcywgbXVzdEFza1VzZXIpOgogICAgICAgIHN0YXRlID0gVVRJTFMucmFuZG9tU3RyaW5nKCkKICAgICAgICBpZiAobm90IGN1clVzZXIpOgogICAgICAgICAgICBjdXJVc2VyID0gJycKICAgICAgICBpZiAoY3VyUGFzcyBpcyBOb25lIG9yIG5vdCBjdXJQYXNzIG9yIG5vdCBjdXJVc2VyKSBvciAoR2l0SHViLnRlc3RMb2dpbihjdXJVc2VyLCBjdXJQYXNzKSA9PSBGYWxzZSBhbmQgKG11c3RBc2tVc2VyIG9yIFFNZXNzYWdlQm94LnF1ZXN0aW9uKAogICAgICAgICAgICAgICAgTm9uZSwgIkNyZWRlbnRpYWxzIHJlcXVpcmVkIiwgIlBsZWFzZSBpbmZvcm0geW91ciBjcmVkZW50aWFscywgY291bGQgd2Ugb3BlbiBsb2dpbiBsaW5rIGZvciB5b3U/IikgPT0gUU1lc3NhZ2VCb3guWWVzKSk6CiAgICAgICAgICAgIHVybCA9ICdodHRwczovL2dpdGh1Yi5jb20vbG9naW4vb2F1dGgvYXV0aG9yaXplP3JlZGlyZWN0X3VyaT1odHRwczovL2Nzci51Zm1nLmJyL2ltYWdlcnkvZ2V0X2tleS5waHAmY2xpZW50X2lkPTEwYjI4YTM4OGIwZTY2ZTg3Y2VlJmxvZ2luPScgKyBjdXJVc2VyICsgJyZzY29wZT1yZWFkOnVzZXIlMjByZXBvJnN0YXRlPScgKyBzdGF0ZQogICAgICAgICAgICBjcmVkZW50aWFscyA9IHsKICAgICAgICAgICAgICAgICd2YWx1ZSc6IE5vbmUKICAgICAgICAgICAgfQogICAgICAgICAgICBHaXRIdWIuZ2V0Q3JlZGVudGlhbHMoc3RhdGUpCiAgICAgICAgICAgIHdlYmJyb3dzZXIub3Blbih1cmwsIDEpCiAgICAgICAgICAgIGlzRmlyc3RPcGVuID0gVHJ1ZQogICAgICAgICAgICBkZWYgY2hlY2tMb2dpblZhbGlkYXRpb24oYnRuLCB0aW1lU3BlbnQpOgogICAgICAgICAgICAgICAgY3JlZGVudGlhbHNbJ3ZhbHVlJ10gPSBjcmVkZW50aWFsc1sndmFsdWUnXSBvciBHaXRIdWIuZ2V0Q3JlZGVudGlhbHMoc3RhdGUpCiAgICAgICAgICAgICAgICBpZiBjcmVkZW50aWFsc1sndmFsdWUnXSBhbmQgbm90IG11c3RBc2tVc2VyOgogICAgICAgICAgICAgICAgICAgIGJ0bi5kb25lKDApCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICB3aGlsZSBub3QgY3JlZGVudGlhbHNbJ3ZhbHVlJ106CiAgICAgICAgICAgICAgICBzbGVlcCgxKQogICAgICAgICAgICAgICAgYXV4TXNnID0gJycgaWYgaXNGaXJzdE9wZW4gZWxzZSAnXG5cbldhaXRpbmcgdmFsaWRhdGlvbiwgcmUtb3Blbm5pbmcgdGhlIGF1dGhvcml6YXRpb24gZ2l0aHViIHBhZ2UuXG5QbGVhc2UgbG9naW4gb24gYSBHaXRodWIgYWNjb3VudCB0byBjb250aW51ZS4nCiAgICAgICAgICAgICAgICBpc0ZpcnN0T3BlbiA9IEZhbHNlCiAgICAgICAgICAgICAgICByZXNwb25zZSA9IEN1c3RvbU1lc3NhZ2VCb3guc2hvd1dpdGhDYWxsYmFjaygyMDAwLAogICAgICAgICAgICAgICAgICAgICAgIlN0ZXBzIHRvIGNvbmZpcm0geW91ciBjcmVkZW50aWFsczpcbjEpIEVudGVyIGNyZWRlbnRpYWxzXG4yKSBjbGljayB0byAnYXV0aG9yaXplIE1hcHBpYScgXG4zKSBXYWl0IGFuZCBDbGljayAnWUVTJyB0byBjb25maXJtLlxuIE9yICdOTycgdG8gY2FuY2VsLlxuT3Blbm5pbmcgdGhlIGdpdGh1YiBhdXRoZW50aWNhdGlvbiBsaW5rIGluIGJyb3dzZXIuIiArIGF1eE1zZywKICAgICAgICAgICAgICAgICAgICAgICJQbGVhc2UgY29uZmlybSBjcmVkZW50aWFscyBhdCBHaXRodWIgc2l0ZSB0byBjb250aW51ZSIsIGNoZWNrTG9naW5WYWxpZGF0aW9uLCBidXR0b25zPVFNZXNzYWdlQm94LlllcyB8IFFNZXNzYWdlQm94Lk5vKQogICAgICAgICAgICAgICAgY3JlZGVudGlhbHNbJ3ZhbHVlJ10gPSBjcmVkZW50aWFsc1sndmFsdWUnXSBvciBHaXRIdWIuZ2V0Q3JlZGVudGlhbHMoc3RhdGUpCiAgICAgICAgICAgICAgICBpZiByZXNwb25zZSA9PSBRTWVzc2FnZUJveC5ZZXMgYW5kIG5vdCBjcmVkZW50aWFsc1sndmFsdWUnXToKICAgICAgICAgICAgICAgICAgICB3ZWJicm93c2VyLm9wZW4odXJsLCAyKQogICAgICAgICAgICAgICAgZWxpZiByZXNwb25zZSAhPSBRTWVzc2FnZUJveC5ZZXMgYW5kIG5vdCBjcmVkZW50aWFsc1sndmFsdWUnXToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKE5vbmUsIE5vbmUpCiAgICAgICAgICAgIHJldHVybiAoY3JlZGVudGlhbHNbJ3ZhbHVlJ11bJ3VzZXInXSwgY3JlZGVudGlhbHNbJ3ZhbHVlJ11bJ3Rva2VuJ10pCiAgICAgICAgcmV0dXJuIChjdXJVc2VyLCBjdXJQYXNzKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBhZGRGaWxlcyhyZXBvLCB1c2VyLCByZXBvc2l0b3J5LCBmZWVkYmFjayk6CiAgICAgICAgcmV0dXJuIEdpdEludGVyYWN0aXZlLmFkZEZpbGVzKHJlcG8sIHVzZXIsIHJlcG9zaXRvcnksIGZlZWRiYWNrKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnaXRDb21taXQocmVwbywgbXNnLCBmZWVkYmFjayk6CiAgICAgICAgcmV0dXJuIEdpdEludGVyYWN0aXZlLmdpdENvbW1pdChyZXBvLCBtc2csIGZlZWRiYWNrKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBwdXNoQ2hhbmdlcyhyZXBvLCB1c2VyLCByZXBvc2l0b3J5LCBwYXNzd29yZCwgZmVlZGJhY2spOgogICAgICAgIHJldHVybiBHaXRJbnRlcmFjdGl2ZS5wdXNoQ2hhbmdlcyhyZXBvLCB1c2VyLCByZXBvc2l0b3J5LCBwYXNzd29yZCwgZmVlZGJhY2spCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHB1Ymxpc2hUaWxlc1RvR2l0SHViKGZvbGRlciwgdXNlciwgcmVwb3NpdG9yeSwgZmVlZGJhY2ssIHZlcnNpb24sIHBhc3N3b3JkPU5vbmUpOgogICAgICAgIGltcG9ydCBnaXQKICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oJ0dpdGh1YiBmb3VuZCBjb21taXRpbmcgdG8geW91ciBhY2NvdW50LicpCgogICAgICAgIHJlcG8gPSBHaXRIdWIuZ2V0UmVwb3NpdG9yeShmb2xkZXIsIHVzZXIsIHJlcG9zaXRvcnksIHBhc3N3b3JkLCBmZWVkYmFjaykKCiAgICAgICAgbm93ID0gZGF0ZXRpbWUubm93KCkKICAgICAgICAjIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzY1NjUzNTcvZ2l0LXB1c2gtcmVxdWlyZXMtdXNlcm5hbWUtYW5kLXBhc3N3b3JkCiAgICAgICAgcmVwby5naXQuY29uZmlnKCJjcmVkZW50aWFsLmhlbHBlciIsICIgIiwgInN0b3JlIikKICAgICAgICBHaXRIdWIudHJ5UHVsbFJlcG9zaXRvcnkocmVwbywgdXNlciwgcmVwb3NpdG9yeSwgZmVlZGJhY2spICNEYW5pbG8KICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oJ0dpdDogQWRkIGFsbCBnZW5lcmF0ZWQgdGlsZXMgdG8geW91ciByZXBvc2l0b3J5LicpCiAgICAgICAgR2l0SHViLmFkZEZpbGVzKHJlcG8sIHVzZXIsIHJlcG9zaXRvcnksIGZlZWRiYWNrKQogICAgICAgICNmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkdpdDogTWVyZ2luLiIpCiAgICAgICAgI3JlcG8uZ2l0Lm1lcmdlKCItcyByZWN1cnNpdmUiLCAiLVggb3VycyIpCiAgICAgICAgI2ZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiR2l0OiBQdXNoaW5nIGNoYW5nZXMuIikKICAgICAgICAjcmVwby5naXQucHVzaChHaXRIdWIuZ2V0R2l0VXJsKHVzZXIsIHJlcG9zaXRvcnkpLCAibWFzdGVyOnJlZnMvaGVhZHMvbWFzdGVyIikKICAgICAgICBpZiByZXBvLmluZGV4LmRpZmYoTm9uZSkgb3IgcmVwby51bnRyYWNrZWRfZmlsZXM6CiAgICAgICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiTm8gY2hhbmdlcywgbm90aGluZyB0byBjb21taXQuIikKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkdpdDogQ29tbWl0dGluZyBjaGFuZ2VzLiAtLS0tLS0tLS0tLS0tMiIpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBHaXRIdWIuZ2l0Q29tbWl0KHJlcG8sICJRR0lTIC0gIiArIG5vdy5zdHJmdGltZSgiJWQvJW0vJVkgJUg6JU06JVMiKSArICIgdmVyc2lvbjogIiArIHZlcnNpb24sIGZlZWRiYWNrKQogICAgICAgIGV4Y2VwdCBnaXQuZXhjLkdpdENvbW1hbmRFcnJvciBhcyBlOgogICAgICAgICAgICBwcmludCgiV2FybmluZzogcmVhc29uICIgKyBzdHIoZSkpCiAgICAgICAgIyBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkNSRUFUSU5HIFRBRyIpCiAgICAgICAgIyB0YWcgPSBub3cuc3RyZnRpbWUoIiVZJW0lZC0lSCVNJVMiKQogICAgICAgICMgbmV3X3RhZyA9IHJlcG8uY3JlYXRlX3RhZyh0YWcsIG1lc3NhZ2U9J0F1dG9tYXRpYyB0YWcgInswfSInLmZvcm1hdCh0YWcpKQogICAgICAgICMgcmVwby5yZW1vdGVzW29yaWdpbk5hbWVdLnB1c2gobmV3X3RhZykKICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkdpdDogUHVzaGluZyBtb2RpZmljYXRpb25zIHRvIHJlbW90ZSByZXBvc2l0b3J5LiIpCiAgICAgICAgR2l0SHViLnB1c2hDaGFuZ2VzKHJlcG8sIHVzZXIsIHJlcG9zaXRvcnksIHBhc3N3b3JkLCBmZWVkYmFjaykKICAgICAgICByZXR1cm4gTm9uZQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRDcmVkZW50aWFscyhzZWNyZXQpOgogICAgICAgICNEYW5pbG8gI0ZJWE1FIGNvbG9jYXIgVU5JUVVFIG5vIEJECiAgICAgICAgcmVzcCA9IHJlcXVlc3RzLmdldCgnaHR0cHM6Ly9jc3IudWZtZy5ici9pbWFnZXJ5L3ZlcmlmeV9rZXkucGhwP3N0YXRlPScgKyBzZWNyZXQpCiAgICAgICAgaWYgcmVzcC5zdGF0dXNfY29kZSA9PSAyMDA6CiAgICAgICAgICAgIHJldHVybiBqc29uLmxvYWRzKHJlc3AudGV4dCkKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICMgQHN0YXRpY21ldGhvZAogICAgIyBkZWYgZ2V0QWNjZXNzVG9rZW4oY3VyVXNlciwgY3VyUGFzcyk6CiAgICAjICAgICBkZWYgaXNOb3RUb2tlbihjb250ZW50KToKICAgICMgICAgICAgICByZXR1cm4gbm90IHJlLm1hdGNoKHInXlthLXowLTldezQwfSQnLCBjb250ZW50KQogICAgIyAgICAgIyBkZWYgY3JlYXRlVG9rZW5Gcm9tUGFzcyh1c2VyLCBwYXNzd29yZCk6CiAgICAjICAgICAjICAgICBwYXJhbXMgPSB7CiAgICAjICAgICAjICAgICAgICAgInNjb3BlcyI6IFsicmVwbyIsICJ3cml0ZTpvcmciXSwKICAgICMgICAgICMgICAgICAgICAibm90ZSI6ICJNYXBwaWEgQWNjZXNzICgiICsgc3RyKHJhbmRvbS51bmlmb3JtKDAsIDEpICogMTAwMDAwKSArICIpIgogICAgIyAgICAgIyAgICAgfQogICAgIyAgICAgIyAgICAgcmVzcCA9IHJlcXVlc3RzLnBvc3QodXJsPUdpdEh1Yi5naXRodWJBcGkgKyAnYXV0aG9yaXphdGlvbnMnLCBoZWFkZXJzPXsnY29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nfSwgYXV0aD0odXNlciwgcGFzc3dvcmQpLCBkYXRhPWpzb24uZHVtcHMocGFyYW1zKSkKICAgICMgICAgICMgICAgIGlmIHJlc3Auc3RhdHVzX2NvZGUgPT0gSFRUUFN0YXR1cy5DUkVBVEVEOgogICAgIyAgICAgIyAgICAgICAgIHJldHVybiBqc29uLmxvYWRzKHJlc3AudGV4dClbInRva2VuIl0KICAgICMgICAgICMgICAgIGVsaWYgcmVzcC5zdGF0dXNfY29kZSA9PSBIVFRQU3RhdHVzLlVOUFJPQ0VTU0FCTEVfRU5USVRZOgogICAgIyAgICAgIyAgICAgICAgICNkZXZlcmlhIHRlbnRhciBtYWlzIHVtYSB2ZXoKICAgICMgICAgICMgICAgICAgICByZXR1cm4gTm9uZQogICAgIyAgICAgIyAgICAgZWxpZiByZXNwLnN0YXR1c19jb2RlID09IEhUVFBTdGF0dXMuVU5BVVRIT1JJWkVEOgogICAgIyAgICAgIyAgICAgICAgIFFNZXNzYWdlQm94Lndhcm5pbmcoTm9uZSwgIk1hcHBpYSBQdWJsaXNoZXIgRXJyb3IiLCAiRmFpbGVkIHRvIGxvZ2luLCBwbGVhc2UgY2hlY2sgaWYgdGhlIGVudGVyZWQgdXNlcm5hbWUvcGFzc3dvcmQgaXMgdmFsaWQgYXQgKGh0dHBzOi8vZ2l0aHViLmNvbS9sb2dpbikiKQogICAgIyAgICAgIyAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiRXJyb3I6IEZhaWxlZCB0byBsb2dpbiwgcGxlYXNlIFZlcmlmeSB0aGUgZW50ZXJlZCB1c2VybmFtZS9wYXNzd29yZC4iKQogICAgIyAgICAgIyAgICAgZWxzZToKICAgICMgICAgICMgICAgICAgICBRTWVzc2FnZUJveC53YXJuaW5nKE5vbmUsICJNYXBwaWEgUHVibGlzaGVyIEVycm9yIiwgIkZhaWxlZCB0byBjcmVhdGUgYSBuZXcgdG9rZW4uIFJlc3BvbnNlIGNvZGU6ICIgKyBzdHIocmVzcC5zdGF0dXNfY29kZSkgKyAiIENvbnRlbnQ6ICIgKyBzdHIocmVzcC50ZXh0KSkKICAgICMgICAgICMgICAgICAgICByYWlzZSBFeGNlcHRpb24oIkVycm9yOiBGYWlsZWQgdG8gY3JlYXRlIHRva2VuLiBSZXNwb25zZSBjb2RlOiAiICsgc3RyKHJlc3Auc3RhdHVzX2NvZGUpICsgIiBDb250ZW50OiAiICsgc3RyKHJlc3AudGV4dCkpCiAgICAjICAgICBmb3VuZFRva2VuID0gTm9uZQogICAgIyAgICAgaWYgbm90IEdpdEh1Yi50ZXN0TG9naW4oY3VyVXNlciwgY3VyUGFzcyk6CiAgICAjICAgICAgICAgUU1lc3NhZ2VCb3gud2FybmluZyhOb25lLCAiTWFwcGlhIFB1Ymxpc2hlciBFcnJvciIsCiAgICAjICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiRmFpbGVkIHRvIGxvZ2luLCBwbGVhc2UgY2hlY2sgaWYgdGhlIGVudGVyZWQgdXNlcm5hbWUvcGFzc3dvcmQgaXMgdmFsaWQgYXQgKGh0dHBzOi8vZ2l0aHViLmNvbS9sb2dpbikiKQogICAgIyAgICAgICAgIEV4Y2VwdGlvbigiRXJyb3I6IEZhaWxlZCB0byBsb2dpbi4iKQogICAgIyAgICAgICAgIGZvdW5kVG9rZW4gPSBOb25lCiAgICAjICAgICBlbGlmIG5vdCBpc05vdFRva2VuKGN1clBhc3MpIGFuZCBHaXRIdWIudGVzdExvZ2luKGN1clVzZXIsIGN1clBhc3MpOgogICAgIyAgICAgICAgIGZvdW5kVG9rZW4gPSBjdXJQYXNzCiAgICAjICAgICBlbGlmIEdpdEh1Yi5wZXJzb25hbF90b2tlbiBhbmQgbm90IGlzTm90VG9rZW4oR2l0SHViLnBlcnNvbmFsX3Rva2VuKSBhbmQgR2l0SHViLnRlc3RMb2dpbihjdXJVc2VyLCBHaXRIdWIucGVyc29uYWxfdG9rZW4pOgogICAgIyAgICAgICAgIGZvdW5kVG9rZW4gPSBHaXRIdWIucGVyc29uYWxfdG9rZW4KICAgICMgICAgICMgZWxpZiBRTWVzc2FnZUJveC5xdWVzdGlvbihOb25lLCAiS2V5IHJlcXVpcmVkIGluc3RlYWQgb2YgcGFzc3dvcmQuIiwgIldhbnQgdGhlIG1hcHBpYSB0byBhdXRvbWF0aWNhbGx5IGNyZWF0ZSBhIGtleSBmb3IgeW91PyBPdGhlcndpc2UgcGxlYXNlIGFjY2VzcyB0aGUgbGluazogaHR0cHM6Ly9naXRodWIuY29tL3NldHRpbmdzL3Rva2VucyB0byBjcmVhdGUgdGhlIGtleS4iLCBkZWZhdWx0QnV0dG9uPVFNZXNzYWdlQm94LlllcykgPT0gUU1lc3NhZ2VCb3guWWVzOgogICAgIyAgICAgIyAgICAgcmV0cmllcyA9IDEKICAgICMgICAgICMgICAgIHRva2VuID0gTm9uZQogICAgIyAgICAgIyAgICAgd2hpbGUgdG9rZW4gaXMgTm9uZSBhbmQgcmV0cmllcyA8PSA1OgogICAgIyAgICAgIyAgICAgICAgIHRva2VuID0gY3JlYXRlVG9rZW5Gcm9tUGFzcyhjdXJVc2VyLCBjdXJQYXNzKQogICAgIyAgICAgIyAgICAgICAgIHJldHJpZXMgPSByZXRyaWVzICsgMQogICAgIyAgICAgIyAgICAgaWYgdG9rZW4gaXMgTm9uZToKICAgICMgICAgICMgICAgICAgICBpZiBRTWVzc2FnZUJveC5xdWVzdGlvbihOb25lLCAiVGhlIHRva2VuIGNyZWF0aW9uIGhhdmUgZmFpbGVkLiBXYW50IHRvIG9wZW4gdGhlIGNyZWF0aW9uIGxpbms/IiwgZGVmYXVsdEJ1dHRvbj1RTWVzc2FnZUJveC5ZZXMpID09IFFNZXNzYWdlQm94LlllczoKICAgICMgICAgICMgICAgICAgICAgICAgd2ViYnJvd3Nlci5vcGVuX25ldygnaHR0cHM6Ly9naXRodWIuY29tL3NldHRpbmdzL3Rva2VucycpCiAgICAjICAgICAjICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJFcnJvcjogU29tZXRoaW5nIGdvZXMgd3JvbmcgY3JlYXRpbmcgdGhlIHRva2VuLiBPcGVuaW5nIHRoZSBicm93c2VyLCBwbGVhc2UgY3JlYXRlIHlvdXIgdG9rZW4gbWFudWFsbHkgYXQgaHR0cHM6Ly9naXRodWIuY29tL3NldHRpbmdzL3Rva2VucyBhbmQgZW5hYmxlIGVuYWJsZSB0aGUgc2NvcGUgZ3JvdXAgJ3JlcG8nLiBQbGVhc2UgY29weSB0aGUgcmVzdWx0aW5nIHRleHQuIikKICAgICMgICAgICMgICAgIEdpdEh1Yi5wZXJzb25hbF90b2tlbiA9IHRva2VuCiAgICAjICAgICAjICAgICBRTWVzc2FnZUJveC53YXJuaW5nKE5vbmUsICJJbmZvcm1hdGlvbiIsICJDcmVhdGVkIHRoZSBmb2xsb3dpbmcgdG9rZW4sIHBsZWFzZSBjb3B5IGl0IHRvIHVzZSBsYXRlciAnIiArIHRva2VuICsgIicuIikKICAgICMgICAgICMgICAgIGZvdW5kVG9rZW4gPSB0b2tlbgogICAgIyAgICAgZWxzZToKICAgICMgICAgICAgICBmb3VuZFRva2VuID0gTm9uZQogICAgIyAgICAgcmV0dXJuIGZvdW5kVG9rZW4KCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIF9yZXF1ZXN0KCphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgd2l0aF9hdXRoID0ga3dhcmdzLnBvcCgid2l0aF9hdXRoIiwgVHJ1ZSkKICAgICAgICB0b2tlbiA9IGt3YXJncy5wb3AoInRva2VuIiwgJycpCiAgICAgICAgaWYgbm90IHRva2VuOgogICAgICAgICAgICB0b2tlbiA9IG9zLmVudmlyb24uZ2V0KCJHSVRIVUJfVE9LRU4iLCBOb25lKQogICAgICAgIGlmIHRva2VuIGFuZCB3aXRoX2F1dGg6CiAgICAgICAgICAgIGt3YXJnc1siYXV0aCJdID0gKHRva2VuLCAneC1vYXV0aC1iYXNpYycpCiAgICAgICAgZm9yIF8gaW4gcmFuZ2UoMyk6CiAgICAgICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdCgqYXJncywgKiprd2FyZ3MpCiAgICAgICAgICAgIGlzX3RyYXZpcyA9IG9zLmdldGVudigiVFJBVklTIiwgTm9uZSkgaXMgbm90IE5vbmUKICAgICAgICAgICAgaWYgaXNfdHJhdmlzIGFuZCA0MDAgPD0gcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPCA1MDA6CiAgICAgICAgICAgICAgICBwcmludCgiUmV0cnlpbmcgaW4gMXMgKCVzIENsaWVudCBFcnJvcjogJXMgZm9yIHVybDogJXMpIiAlICgKICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5zdGF0dXNfY29kZSwgcmVzcG9uc2UucmVhc29uLCByZXNwb25zZS51cmwpKQogICAgICAgICAgICAgICAgdGltZS5zbGVlcCgxKQogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgYnJlYWsKICAgICAgICByZXR1cm4gcmVzcG9uc2UKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgX3JlY3Vyc2l2ZV9naF9nZXQoaHJlZiwgaXRlbXMsIHBhc3N3b3JkPU5vbmUpOgogICAgICAgICIiIlJlY3Vyc2l2ZWx5IGdldCBsaXN0IG9mIEdpdEh1YiBvYmplY3RzLgoKICAgICAgICBTZWUgaHR0cHM6Ly9kZXZlbG9wZXIuZ2l0aHViLmNvbS92My9ndWlkZXMvdHJhdmVyc2luZy13aXRoLXBhZ2luYXRpb24vCiAgICAgICAgIiIiCiAgICAgICAgcmVzcG9uc2UgPSBHaXRIdWIuX3JlcXVlc3QoJ0dFVCcsIGhyZWYsIHRva2VuPXBhc3N3b3JkKQogICAgICAgIHJlc3BvbnNlLnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICAgIGl0ZW1zLmV4dGVuZChyZXNwb25zZS5qc29uKCkpCiAgICAgICAgaWYgImxpbmsiIG5vdCBpbiByZXNwb25zZS5oZWFkZXJzOgogICAgICAgICAgICByZXR1cm4KICAgICAgICAjIGxpbmtzID0gbGlua19oZWFkZXIucGFyc2UocmVzcG9uc2UuaGVhZGVyc1sibGluayJdKQogICAgICAgICMgcmVscyA9IHtsaW5rLnJlbDogbGluay5ocmVmIGZvciBsaW5rIGluIGxpbmtzLmxpbmtzfQogICAgICAgICMgaWYgIm5leHQiIGluIHJlbHM6CiAgICAgICAgIyAgICAgZ2hSZWxlYXNlLl9yZWN1cnNpdmVfZ2hfZ2V0KHJlbHNbIm5leHQiXSwgaXRlbXMpCgogICAgI1JldHVybiBhIGxpc3Qgb2YgYXNzZXRzIGluIGNvbW1pdCAncmVsZWFzZU5hbWUnIHdpdGhpbiB0aGlzIHJlcG9zaXRvcnkuCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0QXNzZXRzKHVzZXIsIHJlcG9zaXRvcnksIHBhc3N3b3JkLCB0YWdOYW1lKToKICAgICAgICByZWxlYXNlID0gR2l0SHViLmdldFJlbGVhc2UodXNlciwgcmVwb3NpdG9yeSwgcGFzc3dvcmQsIHRhZ05hbWUpCiAgICAgICAgaWYgbm90IHJlbGVhc2U6CiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbignUmVsZWFzZSB3aXRoIHRhZ19uYW1lIHswfSBub3QgZm91bmQnLmZvcm1hdCh0YWdOYW1lKSkKICAgICAgICBhc3NldHMgPSBbXQogICAgICAgIEdpdEh1Yi5fcmVjdXJzaXZlX2doX2dldChHaXRIdWIuZ2l0aHViQXBpICsgJ3JlcG9zL3swfS9yZWxlYXNlcy97MX0vYXNzZXRzJy5mb3JtYXQoCiAgICAgICAgICAgIHVzZXIgKyAiLyIgKyByZXBvc2l0b3J5LCByZWxlYXNlWyJpZCJdKSwgYXNzZXRzLCBwYXNzd29yZCkKICAgICAgICByZXR1cm4gYXNzZXRzCgogICAgI0lmIGV4aXN0cyBnZXQgdGhlIHJlbGVhc2Ugd2l0aCBuYW1lICdyZWxlYXNlTmFtZScuCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0UmVsZWFzZSh1c2VyLCByZXBvc2l0b3J5LCBwYXNzd29yZCwgdGFnTmFtZSk6CiAgICAgICAgZGVmIF9nZXRSZWxlYXNlKGhyZWYsIHBhc3N3b3JkLCB0YWdOYW1lKToKICAgICAgICAgICAgcmVsZWFzZVJlc3AgPSBHaXRIdWIuX3JlcXVlc3QoJ0dFVCcsIGhyZWYsIHRva2VuPXBhc3N3b3JkKQogICAgICAgICAgICByZWxlYXNlUmVzcC5yYWlzZV9mb3Jfc3RhdHVzKCkKICAgICAgICAgICAgcmVzdWx0ID0gTm9uZQogICAgICAgICAgICBmb3IgY3VyUmVzcCBpbiByZWxlYXNlUmVzcC5qc29uKCk6CiAgICAgICAgICAgICAgICBpZiAoY3VyUmVzcCBhbmQgKGN1clJlc3BbJ3RhZ19uYW1lJ10gPT0gdGFnTmFtZSkpOgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGN1clJlc3AKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBpZiByZXN1bHQgaXMgTm9uZSBhbmQgJ2xpbmsnIGluIHJlbGVhc2VSZXNwLmhlYWRlcnM6CiAgICAgICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oIlBsZWFzZSByZXBvcnQ6IG5vdCBpbXBsZW1lbnRlZCB5ZXQuIiArIGpzb24uZHVtcHMocmVsZWFzZVJlc3AuaGVhZGVyc1sibGluayJdKSkKICAgICAgICAjIGlmICdsaW5rJyBpbiByZWxlYXNlUmVzcC5oZWFkZXJzOiAjRGFuaWxvIHByZWNpc2EgaW1wbGVtZW50YXIgYWluZGEKICAgICAgICAjYWRkIHJlc3AgdG8gY3VyUmVzcC4KICAgICAgICAjICAgICAjIGxpbmtzID0gbGlua19oZWFkZXIucGFyc2UocmVzcG9uc2UuaGVhZGVyc1sibGluayJdKQogICAgICAgICMgICAgICMgcmVscyA9IHtsaW5rLnJlbDogbGluay5ocmVmIGZvciBsaW5rIGluIGxpbmtzLmxpbmtzfQogICAgICAgICMgICAgICMgaWYgIm5leHQiIGluIHJlbHM6CiAgICAgICAgIyAgICAgIyAgICAgZ2hSZWxlYXNlLl9yZWN1cnNpdmVfZ2hfZ2V0KHJlbHNbIm5leHQiXSwgaXRlbXMsIHRva2VuKQogICAgICAgICMgICAgICMgRGFuaWxvIHByZWNpc28gZmF6ZXIgbyBwYXJzZQogICAgICAgICAgICByZXR1cm4gcmVzdWx0CiAgICAgICAgcmV0dXJuIF9nZXRSZWxlYXNlKEdpdEh1Yi5naXRodWJBcGkgKyAncmVwb3MvJyArIHVzZXIgKyAiLyIgKyByZXBvc2l0b3J5ICsgIi9yZWxlYXNlcyIsIHBhc3N3b3JkLCB0YWdOYW1lKQoKICAgICNDcmVhdGUgdGhlIGRvd25sb2FkIHRhZyBvciByZXBvcnQgYSBlcnJvci4KICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBjcmVhdGVEb3dubG9hZFRhZyh1c2VyLCByZXBvc2l0b3J5LCBwYXNzd29yZCwgZmVlZGJhY2spOgogICAgICAgIGRhdGEgPSB7CiAgICAgICAgICAgICd0YWdfbmFtZSc6IEdpdEh1Yi5yZWxlYXNlTmFtZSwKICAgICAgICAgICAgJ25hbWUnOiBHaXRIdWIucmVsZWFzZU5hbWUsCiAgICAgICAgICAgICdib2R5JzogR2l0SHViLnJlbGVhc2VOYW1lLAogICAgICAgICAgICAnZHJhZnQnOiBGYWxzZSwKICAgICAgICAgICAgJ3ByZXJlbGVhc2UnOiBGYWxzZQogICAgICAgIH0KICAgICAgICByZXNwb25zZSA9IEdpdEh1Yi5fcmVxdWVzdCgnUE9TVCcsIEdpdEh1Yi5naXRodWJBcGkgKyAncmVwb3MvJyArIHVzZXIgKyAiLyIgKyByZXBvc2l0b3J5ICsgIi9yZWxlYXNlcyIsIHRva2VuPXBhc3N3b3JkLCBkYXRhPWpzb24uZHVtcHMoZGF0YSksIGhlYWRlcnM9eydDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbid9KQogICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXNfY29kZSA9PSA0MjIpIGFuZCBHaXRIdWIuZ2V0UmVsZWFzZSh1c2VyLCByZXBvc2l0b3J5LCBwYXNzd29yZCwgR2l0SHViLnJlbGVhc2VOYW1lKSBpcyBub3QgTm9uZTogI3ZvdSBjb25zaWRlcmFyIHEgamEgZXN0w6EgY3JpYWRvCiAgICAgICAgICAgIHBhc3MKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXNwb25zZS5yYWlzZV9mb3Jfc3RhdHVzKCkKCiAgICAjVHJ5IHRvIGFkZCB0aGUgJ3VwbG9hZEZpbGUnIGFzIGEgbGF5ZXIgYXNzZXQuCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgYWRkUmVsZWFzZUZpbGUodXNlciwgcGFzc3dvcmQsIHJlcG9zaXRvcnksIG1heFJldHJ5LCBmb3JjZVVwZGF0ZUZpbGUsIHVwbG9hZEZpbGUsIGxheWVyLCBmZWVkYmFjayk6CiAgICAgICAgaWYgdXBsb2FkRmlsZSBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIHJlbGVhc2VSZWYgPSBHaXRIdWIuZ2V0UmVsZWFzZSh1c2VyLCByZXBvc2l0b3J5LCBwYXNzd29yZCwgR2l0SHViLnJlbGVhc2VOYW1lKQoKICAgICAgICBpZiByZWxlYXNlUmVmIGlzIE5vbmUgb3IgcmVsZWFzZVJlZlsndXBsb2FkX3VybCddIGlzIE5vbmU6CiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiUmVsZWFzZSAnIiArIEdpdEh1Yi5yZWxlYXNlTmFtZSArICInIHdhcyBub3QgZm91bmQiKQogICAgICAgIGFzc2V0cyA9IEdpdEh1Yi5nZXRBc3NldHModXNlciwgcmVwb3NpdG9yeSwgcGFzc3dvcmQsIEdpdEh1Yi5yZWxlYXNlTmFtZSkKICAgICAgICB1cGxvYWRVcmwgPSByZWxlYXNlUmVmWyd1cGxvYWRfdXJsJ10KICAgICAgICBpZiAieyIgaW4gdXBsb2FkVXJsOgogICAgICAgICAgICB1cGxvYWRVcmwgPSB1cGxvYWRVcmxbOnVwbG9hZFVybC5pbmRleCgieyIpXQogICAgICAgIGJhc2VuYW1lID0gVVRJTFMubm9ybWFsaXplTmFtZShvcy5wYXRoLmJhc2VuYW1lKGxheWVyLm5hbWUoKSkpICsgc3RyKG9zLnBhdGguc3BsaXRleHQodXBsb2FkRmlsZSlbMV0pCiAgICAgICAgI0V4YW1wbGU6ICMnaHR0cHM6Ly9naXRodWIuY29tL2FzZml4aWEvTWFwcGlhX0V4YW1wbGVfdC9yZWxlYXNlcy9kb3dubG9hZC9NYXBfRG93bmxvYWQvZGlzdGFuY2VfdG9fZGVmb3Jlc3RlZC50aWYnCiAgICAgICAgZmlsZURvd25sb2FkUGF0aCA9ICdodHRwczovL2dpdGh1Yi5jb20vJyArIHVzZXIgKyAiLyIgKyByZXBvc2l0b3J5ICsgIi9yZWxlYXNlcy9kb3dubG9hZC8iICsgR2l0SHViLnJlbGVhc2VOYW1lICsgIi8iICsgYmFzZW5hbWUKCiAgICAgICAgZm9yIGFzc2V0IGluIGFzc2V0czoKICAgICAgICAgICAgaWYgYXNzZXRbIm5hbWUiXSA9PSBiYXNlbmFtZToKICAgICAgICAgICAgICAgICMgU2VlIGh0dHBzOi8vZGV2ZWxvcGVyLmdpdGh1Yi5jb20vdjMvcmVwb3MvcmVsZWFzZXMvI3Jlc3BvbnNlLWZvci11cHN0cmVhbS1mYWlsdXJlICAjIG5vcWE6IEU1MDEKICAgICAgICAgICAgICAgIGlmIGFzc2V0WyJzdGF0ZSJdID09ICJuZXciIG9yIGFzc2V0WyJzdGF0ZSJdID09ICJ1cGxvYWRlZCI6ICNvdmVycmlkZSB0aGUgb2xkIGZpbGUgaWYgbGFzdCB1cGxvYWQgZmFpbGVkIG9yIHVwZGF0ZSBpZiAnZm9yY2VVcGRhdGVGaWxlJyBpcyB0cnVlLgogICAgICAgICAgICAgICAgICAgIGlmIGFzc2V0WyJzdGF0ZSJdID09ICJ1cGxvYWRlZCIgYW5kIG5vdCBmb3JjZVVwZGF0ZUZpbGU6CiAgICAgICAgICAgICAgICAgICAgICAgIGZlZWRiYWNrLnNldFByb2dyZXNzVGV4dCgiRmlsZSAlcyBhbHJlYWR5IHVwbG9hZGVkLiIgJSBhc3NldFsnbmFtZSddKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmlsZURvd25sb2FkUGF0aAogICAgICAgICAgICAgICAgICAgIGlmIGFzc2V0WyJzdGF0ZSJdID09ICJuZXciOgogICAgICAgICAgICAgICAgICAgICAgICBmZWVkYmFjay5zZXRQcm9ncmVzc1RleHQoIiAgZGVsZXRpbmcgJXMgKGludmFsaWQgYXNzZXQgIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAid2l0aCBzdGF0ZSBzZXQgdG8gJ25ldycpIiAlIGFzc2V0WyduYW1lJ10pCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgZmVlZGJhY2suc2V0UHJvZ3Jlc3NUZXh0KCJVcGRhdGluZyBmaWxlICVzLiIgJSBhc3NldFsnbmFtZSddKQogICAgICAgICAgICAgICAgICAgIHVybCA9ICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEdpdEh1Yi5naXRodWJBcGkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgJ3JlcG9zL3swfS9yZWxlYXNlcy9hc3NldHMvezF9Jy5mb3JtYXQodXNlciArICIvIiArIHJlcG9zaXRvcnksIGFzc2V0WydpZCddKQogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICByZXNwb25zZSA9IEdpdEh1Yi5fcmVxdWVzdCgnREVMRVRFJywgdXJsLCB0b2tlbj1wYXNzd29yZCkKICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5yYWlzZV9mb3Jfc3RhdHVzKCkKCiAgICAgICAgZmlsZV9zaXplID0gb3MucGF0aC5nZXRzaXplKHVwbG9hZEZpbGUpCiAgICAgICAgZmVlZGJhY2suc2V0UHJvZ3Jlc3NUZXh0KCIgIFVwbG9hZGluZyAlcyBvZiBzaXplICVzIChNQikiICUgKGJhc2VuYW1lLCBzdHIoZmlsZV9zaXplIC8gMTBlNSkpKQoKICAgICAgICB1cmwgPSAnezB9P25hbWU9ezF9Jy5mb3JtYXQodXBsb2FkVXJsLCBiYXNlbmFtZSkKCiAgICAgICAgIyBBdHRlbXB0IHVwbG9hZAogICAgICAgIHdpdGggb3Blbih1cGxvYWRGaWxlLCAncmInKSBhcyBmOgogICAgICAgICAgICB3aXRoIHByb2dyZXNzX3JlcG9ydGVyX2NscygKICAgICAgICAgICAgICAgICAgICBsYWJlbD1iYXNlbmFtZSwgbGVuZ3RoPWZpbGVfc2l6ZSwgZmVlZGJhY2s9ZmVlZGJhY2spIGFzIHJlcG9ydGVyOgogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSBHaXRIdWIuX3JlcXVlc3QoCiAgICAgICAgICAgICAgICAgICAgJ1BPU1QnLCB1cmwsIGhlYWRlcnM9eydDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJ30sCiAgICAgICAgICAgICAgICAgICAgZGF0YT1fUHJvZ3Jlc3NGaWxlUmVhZGVyKGYsIHJlcG9ydGVyKSwgdG9rZW49cGFzc3dvcmQpCiAgICAgICAgICAgICAgICBkYXRhID0gcmVzcG9uc2UuanNvbigpCgogICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDUwMiBhbmQgbWF4UmV0cnkgPiAxOgogICAgICAgICAgICBmZWVkYmFjay5zZXRQcm9ncmVzc1RleHQoIlJldHJ5aW5nICh1cGxvYWQgZmFpbGVkIHdpdGggc3RhdHVzX2NvZGU9NTAyKSIpCiAgICAgICAgICAgIHJldHVybiBHaXRIdWIuYWRkUmVsZWFzZUZpbGUodXNlciwgcGFzc3dvcmQsIHJlcG9zaXRvcnksIG1heFJldHJ5IC0gMSwgZm9yY2VVcGRhdGVGaWxlLCB1cGxvYWRGaWxlLCBsYXllciwgZmVlZGJhY2spCiAgICAgICAgZWxpZiByZXNwb25zZS5zdGF0dXNfY29kZSA9PSA1MDIgYW5kIG1heFJldHJ5IDw9IDE6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmVzcG9uc2UucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgICAgcmV0dXJuIGZpbGVEb3dubG9hZFBhdGgKCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyBBVVggQ0xBU1MgIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKCmNsYXNzIHByb2dyZXNzX3JlcG9ydGVyX2NscyhvYmplY3QpOgogICAgcmVwb3J0UHJvZ3Jlc3MgPSBGYWxzZQoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBsYWJlbD0nJywgbGVuZ3RoPTAsIGZlZWRiYWNrPU5vbmUpOgogICAgICAgIHNlbGYubGFiZWwgPSBsYWJlbAogICAgICAgIHNlbGYubGVuZ3RoID0gbGVuZ3RoCiAgICAgICAgc2VsZi50b3RhbCA9IDAKICAgICAgICBzZWxmLmxhc3RSZXBvcnQgPSAwCiAgICAgICAgc2VsZi5mZWVkYmFjayA9IGZlZWRiYWNrCgogICAgZGVmIHVwZGF0ZShzZWxmLCBjaHVua19zaXplKToKICAgICAgICBzZWxmLnRvdGFsID0gc2VsZi50b3RhbCArIGNodW5rX3NpemUKICAgICAgICBpZiBzZWxmLmZlZWRiYWNrIGlzIG5vdCBOb25lIGFuZCBzZWxmLnRvdGFsID4gKHNlbGYubGFzdFJlcG9ydCArIChzZWxmLmxlbmd0aCAqIDAuMSkpOgogICAgICAgICAgICBzZWxmLmZlZWRiYWNrLnNldFByb2dyZXNzVGV4dCgnVG90YWw6ICcgKyBzdHIoc2VsZi50b3RhbCAvIDEwMDApICsgIiAoa2IpIikKICAgICAgICAgICAgc2VsZi5sYXN0UmVwb3J0ID0gc2VsZi50b3RhbAogICAgICAgIHBhc3MKCiAgICBkZWYgX19lbnRlcl9fKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmCgogICAgZGVmIF9fZXhpdF9fKHNlbGYsIGV4Y190eXBlLCBleGNfdmFsdWUsIHRiKToKICAgICAgICBwYXNzCgojV3JhcHBlciB1c2VkIHRvIGNhcHR1cmUgRmlsZSBJTyByZWFkIHByb2dyZXNzLgpjbGFzcyBfUHJvZ3Jlc3NGaWxlUmVhZGVyKG9iamVjdCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgc3RyZWFtLCByZXBvcnRlcik6CiAgICAgICAgc2VsZi5fc3RyZWFtID0gc3RyZWFtCiAgICAgICAgc2VsZi5fcmVwb3J0ZXIgPSByZXBvcnRlcgoKICAgIGRlZiByZWFkKHNlbGYsIF9zaXplKToKICAgICAgICBfY2h1bmsgPSBzZWxmLl9zdHJlYW0ucmVhZChfc2l6ZSkKICAgICAgICBzZWxmLl9yZXBvcnRlci51cGRhdGUobGVuKF9jaHVuaykpCiAgICAgICAgcmV0dXJuIF9jaHVuawoKICAgIGRlZiBfX2dldGF0dHJfXyhzZWxmLCBhdHRyKToKICAgICAgICByZXR1cm4gZ2V0YXR0cihzZWxmLl9zdHJlYW0sIGF0dHIpCgpjbGFzcyBDdXN0b21NZXNzYWdlQm94KFFNZXNzYWdlQm94KToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCAqX19hcmdzKToKICAgICAgICBRTWVzc2FnZUJveC5fX2luaXRfXyhzZWxmKQogICAgICAgIHNlbGYudGltZW91dCA9IDAKICAgICAgICBzZWxmLmNhbGxiYWNrID0gTm9uZQogICAgICAgIHNlbGYuY3VycmVudFRpbWUgPSAwCgogICAgZGVmIHNob3dFdmVudChzZWxmLCBRU2hvd0V2ZW50KToKICAgICAgICBzZWxmLmN1cnJlbnRUaW1lID0gMAogICAgICAgIGlmIHNlbGYuYXV0b2Nsb3NlOgogICAgICAgICAgICBzZWxmLnN0YXJ0VGltZXIoc2VsZi50aW1lb3V0KQoKICAgIGRlZiB0aW1lckV2ZW50KHNlbGYsIGV2ZW50KToKICAgICAgICAjIHRyeToKICAgICAgICBpZiBzZWxmLmlzSGlkZGVuKCk6CiAgICAgICAgICAgIHNlbGYua2lsbFRpbWVyKGV2ZW50LnRpbWVySWQoKSkKICAgICAgICAgICAgc2VsZi5kZWxldGVMYXllcigpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5jdXJyZW50VGltZSArPSAxCiAgICAgICAgICAgIHNlbGYuY2FsbGJhY2soc2VsZiwgc2VsZi5jdXJyZW50VGltZSkKICAgICAgICAjIGV4Y2VwdDoKICAgICAgICAjICAgICBzZWxmLnF1aXQoKQogICAgICAgICMgaWYgc2VsZi5jdXJyZW50VGltZSA+PSBzZWxmLnRpbWVvdXQ6CiAgICAgICAgIyAgICAgc2VsZi5kb25lKDApCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHNob3dXaXRoQ2FsbGJhY2sodGltZW91dE1zQ2FsbGJhY2ssIG1lc3NhZ2UsIHRpdGxlLCBjYWxsYmFjaywgaWNvbj1RTWVzc2FnZUJveC5JbmZvcm1hdGlvbiwgYnV0dG9ucz1RTWVzc2FnZUJveC5Payk6CiAgICAgICAgdyA9IEN1c3RvbU1lc3NhZ2VCb3goKQogICAgICAgIHcuYXV0b2Nsb3NlID0gVHJ1ZQogICAgICAgIHcuY2FsbGJhY2sgPSBjYWxsYmFjawogICAgICAgIHRyeToKICAgICAgICAgICAgdy5zZXRDYWxsYmFjayhjYWxsYmFjaykKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKICAgICAgICB3LnRpbWVvdXQgPSB0aW1lb3V0TXNDYWxsYmFjawogICAgICAgIHcuc2V0VGV4dChtZXNzYWdlKQogICAgICAgIHcuc2V0V2luZG93VGl0bGUodGl0bGUpCiAgICAgICAgdy5zZXRJY29uKGljb24pCiAgICAgICAgdy5zZXRTdGFuZGFyZEJ1dHRvbnMoYnV0dG9ucykKICAgICAgICByZXR1cm4gdy5leGVjXygpCgpjbGFzcyBHaXRJbnRlcmFjdGl2ZSgpIDoKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgY2xvbmVSZXBvKHVzZXIsIHJlcG9zaXRvcnksIGZvbGRlciwgZmVlZGJhY2spOgogICAgICAgIGZyb20gZ2l0IGltcG9ydCBSZXBvCiAgICAgICAgcmV0dXJuIFVUSUxTLnJ1bkxvbmdUYXNrKFJlcG8uY2xvbmVfZnJvbSwgZmVlZGJhY2ssIHdhaXRNZXNzYWdlPSJQbGVhc2Ugd2FpdCB0byBjb21wbGV0ZSB0aGUgZG93bmxvYWQuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWNvbmRzUmVwb3J0PTE1LCB1cmw9R2l0SHViLmdldEdpdFVybCh1c2VyLCByZXBvc2l0b3J5KSwgdG9fcGF0aD1mb2xkZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjdXJzaXZlPVRydWUpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHB1c2hDaGFuZ2VzKHJlcG8sIHVzZXIsIHJlcG9zaXRvcnksIHBhc3N3b3JkLCBmZWVkYmFjayk6CiAgICAgICAgcmV0dXJuIFVUSUxTLnJ1bkxvbmdUYXNrKHJlcG8uZ2l0LnB1c2gsIGZlZWRiYWNrLCAnUGxlYXNlIHdhaXQsIHVwbG9hZGluZyBjaGFuZ2VzLicsIDMwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBHaXRIdWIuZ2V0R2l0UGFzc1VybCh1c2VyLCByZXBvc2l0b3J5LCBwYXNzd29yZCksICJtYXN0ZXI6cmVmcy9oZWFkcy9tYXN0ZXIiKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnaXRDb21taXQocmVwbywgbXNnLCBmZWVkYmFjayk6CiAgICAgICAgcmV0dXJuIFVUSUxTLnJ1bkxvbmdUYXNrKHJlcG8uZ2l0LmNvbW1pdCwgZmVlZGJhY2ssICdQbGVhc2Ugd2FpdCwgdXBsb2FkaW5nIGNoYW5nZXMuJywgMzAsIG09bXNnKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBhZGRGaWxlcyhyZXBvLCB1c2VyLCByZXBvc2l0b3J5LCBmZWVkYmFjayk6CiAgICAgICAgb3JpZ2luTmFtZSA9ICJtYXBwaWEiCiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXBvLmdpdC5yZW1vdGUoImFkZCIsIG9yaWdpbk5hbWUsIEdpdEh1Yi5nZXRHaXRVcmwodXNlciwgcmVwb3NpdG9yeSkpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICByZXBvLmdpdC5yZW1vdGUoInNldC11cmwiLCBvcmlnaW5OYW1lLCBHaXRIdWIuZ2V0R2l0VXJsKHVzZXIsIHJlcG9zaXRvcnkpKQogICAgICAgIHJldHVybiBVVElMUy5ydW5Mb25nVGFzayhyZXBvLmdpdC5hZGQsIGZlZWRiYWNrLCB3YWl0TWVzc2FnZT0nUGxlYXNlIHdhaXQsIGlkZW50aWZ5aW5nIGNoYW5nZXMgb24geW91ciByZXBvc2l0b3J5LicsIHNlY29uZHNSZXBvcnQ9MzAsIGFsbD1UcnVlKSAjIEFkaWNpb25hIHRvZG9zIGFycXVpdm9zCgoKdHJ5OgogICAgZnJvbSBGZWVkYmFjayBpbXBvcnQgRmVlZGJhY2sKZXhjZXB0OgogICAgcGFzcyAjTm90IGluIERpbmFtaWNhIENvZGUKCmNsYXNzIEZlZWRiYWNrKCk6CiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgcHVzaENvbnNvbGVJbmZvKG1lc3NhZ2UpOgogICAgICAgIHByaW50KG1lc3NhZ2UpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHNldFByb2dyZXNzKHBlcmNlbnRhZ2UpOgogICAgICAgIHByaW50KCJQcm9ncmVzczogIiArIHN0cihwZXJjZW50YWdlKSkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgc2V0UHJvZ3Jlc3NUZXh0KG1lc3NhZ2UpOgogICAgICAgIHByaW50KG1lc3NhZ2UpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGlzQ2FuY2VsZWQoKToKICAgICAgICByZXR1cm4gRmFsc2UKCgoKCgp0cnk6CiAgICBmcm9tIGdkYWwydGlsZXNfbG9jYWwgaW1wb3J0IGdlbmVyYXRlVGlsZUZvck1hcApleGNlcHQ6CiAgICBwYXNzICNOb3QgaW4gRGluYW1pY2EgQ29kZQoKIyEvdXNyL2Jpbi9lbnYgcHl0aG9uCiMgLSotIGNvZGluZzogdXRmLTggLSotCiMgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiMgICRJZCQKIwojIFByb2plY3Q6ICBHb29nbGUgU3VtbWVyIG9mIENvZGUgMjAwNywgMjAwOCAoaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9zb2MvKQojIFN1cHBvcnQ6ICBCUkdNIChodHRwOi8vd3d3LmJyZ20uZnIpCiMgUHVycG9zZTogIENvbnZlcnQgYSByYXN0ZXIgaW50byBUTVMgKFRpbGUgTWFwIFNlcnZpY2UpIHRpbGVzIGluIGEgZGlyZWN0b3J5LgojICAgICAgICAgICAtIGdlbmVyYXRlIEdvb2dsZSBFYXJ0aCBtZXRhZGF0YSAoS01MIFN1cGVyT3ZlcmxheSkKIyAgICAgICAgICAgLSBnZW5lcmF0ZSBzaW1wbGUgSFRNTCB2aWV3ZXIgYmFzZWQgb24gR29vZ2xlIE1hcHMgYW5kIE9wZW5MYXllcnMKIyAgICAgICAgICAgLSBzdXBwb3J0IG9mIGdsb2JhbCB0aWxlcyAoU3BoZXJpY2FsIE1lcmNhdG9yKSBmb3IgY29tcGF0aWJpbGl0eQojICAgICAgICAgICAgICAgd2l0aCBpbnRlcmFjdGl2ZSB3ZWIgbWFwcyBhIGxhIEdvb2dsZSBNYXBzCiMgQXV0aG9yOiAgIEtsb2thbiBQZXRyIFByaWRhbCwga2xva2FuIGF0IGtsb2thbiBkb3QgY3oKIyBXZWI6ICAgICAgaHR0cDovL3d3dy5rbG9rYW4uY3ovcHJvamVjdHMvZ2RhbDJ0aWxlcy8KIyBHVUk6ICAgICAgaHR0cDovL3d3dy5tYXB0aWxlci5vcmcvCiMKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwojIENvcHlyaWdodCAoYykgMjAwOCwgS2xva2FuIFBldHIgUHJpZGFsCiMgQ29weXJpZ2h0IChjKSAyMDEwLTIwMTMsIEV2ZW4gUm91YXVsdCA8ZXZlbiBkb3Qgcm91YXVsdCBhdCBtaW5lcy1wYXJpcyBkb3Qgb3JnPgojCiMgIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCiMgIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksCiMgIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24KIyAgdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsCiMgIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZQojICBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgojCiMgIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCiMgIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgojCiMgIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiMgIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAojICBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTAojICBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgojICBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORwojICBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSCiMgIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KIyAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKCgoKaW1wb3J0IG1hdGgKZnJvbSBtdWx0aXByb2Nlc3NpbmcgaW1wb3J0IFBpcGUsIFBvb2wsIFByb2Nlc3MsIE1hbmFnZXIKaW1wb3J0IG9zCmltcG9ydCB0ZW1wZmlsZQppbXBvcnQgc2h1dGlsCmltcG9ydCBzeXMKaW1wb3J0IHRpbWUKZnJvbSB1dWlkIGltcG9ydCB1dWlkNApmcm9tIHhtbC5ldHJlZSBpbXBvcnQgRWxlbWVudFRyZWUKCmZyb20gb3NnZW8gaW1wb3J0IGdkYWwKZnJvbSBvc2dlbyBpbXBvcnQgb3NyCgp0cnk6CiAgICBmcm9tIGNvbG9yaXplX3JnYiBpbXBvcnQgYXBwbHlMZWdlbmQKZXhjZXB0OgogICAgcGFzcyAjTm90IGluIERpbmFtaWNhIENvZGUKCnRyeToKICAgIGZyb20gUElMIGltcG9ydCBJbWFnZQogICAgaW1wb3J0IG51bXB5CiAgICBpbXBvcnQgb3NnZW8uZ2RhbF9hcnJheSBhcyBnZGFsYXJyYXkKZXhjZXB0IEV4Y2VwdGlvbjoKICAgICMgJ2FudGlhbGlhcycgcmVzYW1wbGluZyBpcyBub3QgYXZhaWxhYmxlCiAgICBwYXNzCgpfX3ZlcnNpb25fXyA9ICIkSWQkIgoKcmVzYW1wbGluZ19saXN0ID0gKCdhdmVyYWdlJywgJ25lYXInLCAnYmlsaW5lYXInLCAnY3ViaWMnLCAnY3ViaWNzcGxpbmUnLCAnbGFuY3pvcycsICAnYW50aWFsaWFzJykKcHJvZmlsZV9saXN0ID0gKCdtZXJjYXRvcicsICdnZW9kZXRpYycsICdyYXN0ZXInKQp3ZWJ2aWV3ZXJfbGlzdCA9ICgnYWxsJywgJ2dvb2dsZScsICdvcGVubGF5ZXJzJywgJ2xlYWZsZXQnLCAnbm9uZScpCgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQoKX19kb2NfX2dsb2JhbG1hcHRpbGVzID0gIiIiCmdsb2JhbG1hcHRpbGVzLnB5CgpHbG9iYWwgTWFwIFRpbGVzIGFzIGRlZmluZWQgaW4gVGlsZSBNYXAgU2VydmljZSAoVE1TKSBQcm9maWxlcwo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQoKRnVuY3Rpb25zIG5lY2Vzc2FyeSBmb3IgZ2VuZXJhdGlvbiBvZiBnbG9iYWwgdGlsZXMgdXNlZCBvbiB0aGUgd2ViLgpJdCBjb250YWlucyBjbGFzc2VzIGltcGxlbWVudGluZyBjb29yZGluYXRlIGNvbnZlcnNpb25zIGZvcjoKCiAgLSBHbG9iYWxNZXJjYXRvciAoYmFzZWQgb24gRVBTRzozODU3KQogICAgICAgZm9yIEdvb2dsZSBNYXBzLCBZYWhvbyBNYXBzLCBCaW5nIE1hcHMgY29tcGF0aWJsZSB0aWxlcwogIC0gR2xvYmFsR2VvZGV0aWMgKGJhc2VkIG9uIEVQU0c6NDMyNikKICAgICAgIGZvciBPcGVuTGF5ZXJzIEJhc2UgTWFwIGFuZCBHb29nbGUgRWFydGggY29tcGF0aWJsZSB0aWxlcwoKTW9yZSBpbmZvIGF0OgoKaHR0cDovL3dpa2kub3NnZW8ub3JnL3dpa2kvVGlsZV9NYXBfU2VydmljZV9TcGVjaWZpY2F0aW9uCmh0dHA6Ly93aWtpLm9zZ2VvLm9yZy93aWtpL1dNU19UaWxpbmdfQ2xpZW50X1JlY29tbWVuZGF0aW9uCmh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9iYjI1OTY4OS5hc3B4Cmh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vYXBpcy9tYXBzL2RvY3VtZW50YXRpb24vb3ZlcmxheXMuaHRtbCNHb29nbGVfTWFwc19Db29yZGluYXRlcwoKQ3JlYXRlZCBieSBLbG9rYW4gUGV0ciBQcmlkYWwgb24gMjAwOC0wNy0wMy4KR29vZ2xlIFN1bW1lciBvZiBDb2RlIDIwMDgsIHByb2plY3QgR0RBTDJUaWxlcyBmb3IgT1NHRU8uCgpJbiBjYXNlIHlvdSB1c2UgdGhpcyBjbGFzcyBpbiB5b3VyIHByb2R1Y3QsIHRyYW5zbGF0ZSBpdCB0byBhbm90aGVyIGxhbmd1YWdlCm9yIGZpbmQgaXQgdXNlZnVsIGZvciB5b3VyIHByb2plY3QgcGxlYXNlIGxldCBtZSBrbm93LgpNeSBlbWFpbDoga2xva2FuIGF0IGtsb2thbiBkb3QgY3ouCkkgd291bGQgbGlrZSB0byBrbm93IHdoZXJlIGl0IHdhcyB1c2VkLgoKQ2xhc3MgaXMgYXZhaWxhYmxlIHVuZGVyIHRoZSBvcGVuLXNvdXJjZSBHREFMIGxpY2Vuc2UgKHd3dy5nZGFsLm9yZykuCiIiIgoKTUFYWk9PTUxFVkVMID0gMzIKCgpjbGFzcyBHbG9iYWxNZXJjYXRvcihvYmplY3QpOgogICAgciIiIgogICAgVE1TIEdsb2JhbCBNZXJjYXRvciBQcm9maWxlCiAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgICBGdW5jdGlvbnMgbmVjZXNzYXJ5IGZvciBnZW5lcmF0aW9uIG9mIHRpbGVzIGluIFNwaGVyaWNhbCBNZXJjYXRvciBwcm9qZWN0aW9uLAogICAgRVBTRzozODU3LgoKICAgIFN1Y2ggdGlsZXMgYXJlIGNvbXBhdGlibGUgd2l0aCBHb29nbGUgTWFwcywgQmluZyBNYXBzLCBZYWhvbyBNYXBzLAogICAgVUsgT3JkbmFuY2UgU3VydmV5IE9wZW5TcGFjZSBBUEksIC4uLgogICAgYW5kIHlvdSBjYW4gb3ZlcmxheSB0aGVtIG9uIHRvcCBvZiBiYXNlIG1hcHMgb2YgdGhvc2Ugd2ViIG1hcHBpbmcgYXBwbGljYXRpb25zLgoKICAgIFBpeGVsIGFuZCB0aWxlIGNvb3JkaW5hdGVzIGFyZSBpbiBUTVMgbm90YXRpb24gKG9yaWdpbiBbMCwwXSBpbiBib3R0b20tbGVmdCkuCgogICAgV2hhdCBjb29yZGluYXRlIGNvbnZlcnNpb25zIGRvIHdlIG5lZWQgZm9yIFRNUyBHbG9iYWwgTWVyY2F0b3IgdGlsZXM6OgoKICAgICAgICAgTGF0TG9uICAgICAgPC0+ICAgICAgIE1ldGVycyAgICAgIDwtPiAgICAgUGl4ZWxzICAgIDwtPiAgICAgICBUaWxlCgogICAgIFdHUzg0IGNvb3JkaW5hdGVzICAgU3BoZXJpY2FsIE1lcmNhdG9yICBQaXhlbHMgaW4gcHlyYW1pZCAgVGlsZXMgaW4gcHlyYW1pZAogICAgICAgICBsYXQvbG9uICAgICAgICAgICAgWFkgaW4gbWV0ZXJzICAgICBYWSBwaXhlbHMgWiB6b29tICAgICAgWFlaIGZyb20gVE1TCiAgICAgICAgRVBTRzo0MzI2ICAgICAgICAgICBFUFNHOjM4NwogICAgICAgICAuLS0tLS4gICAgICAgICAgICAgIC0tLS0tLS0tLSAgICAgICAgICAgICAgIC0tICAgICAgICAgICAgICAgIFRNUwogICAgICAgIC8gICAgICBcICAgICA8LT4gICAgIHwgICAgICAgfCAgICAgPC0+ICAgICAvLS0tLS8gICAgPC0+ICAgICAgR29vZ2xlCiAgICAgICAgXCAgICAgIC8gICAgICAgICAgICAgfCAgICAgICB8ICAgICAgICAgICAvLS0tLS0tLS0vICAgICAgICAgIFF1YWRUcmVlCiAgICAgICAgIC0tLS0tICAgICAgICAgICAgICAgLS0tLS0tLS0tICAgICAgICAgLy0tLS0tLS0tLS0tLS8KICAgICAgIEtNTCwgcHVibGljICAgICAgICAgV2ViTWFwU2VydmljZSAgICAgICAgIFdlYiBDbGllbnRzICAgICAgVGlsZU1hcFNlcnZpY2UKCiAgICBXaGF0IGlzIHRoZSBjb29yZGluYXRlIGV4dGVudCBvZiBFYXJ0aCBpbiBFUFNHOjM4NTc/CgogICAgICBbLTIwMDM3NTA4LjM0Mjc4OTI0NCwgLTIwMDM3NTA4LjM0Mjc4OTI0NCwgMjAwMzc1MDguMzQyNzg5MjQ0LCAyMDAzNzUwOC4zNDI3ODkyNDRdCiAgICAgIENvbnN0YW50IDIwMDM3NTA4LjM0Mjc4OTI0NCBjb21lcyBmcm9tIHRoZSBjaXJjdW1mZXJlbmNlIG9mIHRoZSBFYXJ0aCBpbiBtZXRlcnMsCiAgICAgIHdoaWNoIGlzIDQwIHRob3VzYW5kIGtpbG9tZXRlcnMsIHRoZSBjb29yZGluYXRlIG9yaWdpbiBpcyBpbiB0aGUgbWlkZGxlIG9mIGV4dGVudC4KICAgICAgSW4gZmFjdCB5b3UgY2FuIGNhbGN1bGF0ZSB0aGUgY29uc3RhbnQgYXM6IDIgKiBtYXRoLnBpICogNjM3ODEzNyAvIDIuMAogICAgICAkIGVjaG8gMTgwIDg1IHwgZ2RhbHRyYW5zZm9ybSAtc19zcnMgRVBTRzo0MzI2IC10X3NycyBFUFNHOjM4NTcKICAgICAgUG9sYXIgYXJlYXMgd2l0aCBhYnMobGF0aXR1ZGUpIGJpZ2dlciB0aGVuIDg1LjA1MTEyODc4IGFyZSBjbGlwcGVkIG9mZi4KCiAgICBXaGF0IGFyZSB6b29tIGxldmVsIGNvbnN0YW50cyAocGl4ZWxzL21ldGVyKSBmb3IgcHlyYW1pZCB3aXRoIEVQU0c6Mzg1Nz8KCiAgICAgIHdob2xlIHJlZ2lvbiBpcyBvbiB0b3Agb2YgcHlyYW1pZCAoem9vbT0wKSBjb3ZlcmVkIGJ5IDI1NngyNTYgcGl4ZWxzIHRpbGUsCiAgICAgIGV2ZXJ5IGxvd2VyIHpvb20gbGV2ZWwgcmVzb2x1dGlvbiBpcyBhbHdheXMgZGl2aWRlZCBieSB0d28KICAgICAgaW5pdGlhbFJlc29sdXRpb24gPSAyMDAzNzUwOC4zNDI3ODkyNDQgKiAyIC8gMjU2ID0gMTU2NTQzLjAzMzkyODA0MDYyCgogICAgV2hhdCBpcyB0aGUgZGlmZmVyZW5jZSBiZXR3ZWVuIFRNUyBhbmQgR29vZ2xlIE1hcHMvUXVhZFRyZWUgdGlsZSBuYW1lIGNvbnZlbnRpb24/CgogICAgICBUaGUgdGlsZSByYXN0ZXIgaXRzZWxmIGlzIHRoZSBzYW1lIChlcXVhbCBleHRlbnQsIHByb2plY3Rpb24sIHBpeGVsIHNpemUpLAogICAgICB0aGVyZSBpcyBqdXN0IGRpZmZlcmVudCBpZGVudGlmaWNhdGlvbiBvZiB0aGUgc2FtZSByYXN0ZXIgdGlsZS4KICAgICAgVGlsZXMgaW4gVE1TIGFyZSBjb3VudGVkIGZyb20gWzAsMF0gaW4gdGhlIGJvdHRvbS1sZWZ0IGNvcm5lciwgaWQgaXMgWFlaLgogICAgICBHb29nbGUgcGxhY2VkIHRoZSBvcmlnaW4gWzAsMF0gdG8gdGhlIHRvcC1sZWZ0IGNvcm5lciwgcmVmZXJlbmNlIGlzIFhZWi4KICAgICAgTWljcm9zb2Z0IGlzIHJlZmVyZW5jaW5nIHRpbGVzIGJ5IGEgUXVhZFRyZWUgbmFtZSwgZGVmaW5lZCBvbiB0aGUgd2Vic2l0ZToKICAgICAgaHR0cDovL21zZG4yLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9iYjI1OTY4OS5hc3B4CgogICAgVGhlIGxhdC9sb24gY29vcmRpbmF0ZXMgYXJlIHVzaW5nIFdHUzg0IGRhdHVtLCB5ZXM/CgogICAgICBZZXMsIGFsbCBsYXQvbG9uIHdlIGFyZSBtZW50aW9uaW5nIHNob3VsZCB1c2UgV0dTODQgR2VvZGV0aWMgRGF0dW0uCiAgICAgIFdlbGwsIHRoZSB3ZWIgY2xpZW50cyBsaWtlIEdvb2dsZSBNYXBzIGFyZSBwcm9qZWN0aW5nIHRob3NlIGNvb3JkaW5hdGVzIGJ5CiAgICAgIFNwaGVyaWNhbCBNZXJjYXRvciwgc28gaW4gZmFjdCBsYXQvbG9uIGNvb3JkaW5hdGVzIG9uIHNwaGVyZSBhcmUgdHJlYXRlZCBhcyBpZgogICAgICB0aGUgd2VyZSBvbiB0aGUgV0dTODQgZWxsaXBzb2lkLgoKICAgICAgRnJvbSBNU0ROIGRvY3VtZW50YXRpb246CiAgICAgIFRvIHNpbXBsaWZ5IHRoZSBjYWxjdWxhdGlvbnMsIHdlIHVzZSB0aGUgc3BoZXJpY2FsIGZvcm0gb2YgcHJvamVjdGlvbiwgbm90CiAgICAgIHRoZSBlbGxpcHNvaWRhbCBmb3JtLiBTaW5jZSB0aGUgcHJvamVjdGlvbiBpcyB1c2VkIG9ubHkgZm9yIG1hcCBkaXNwbGF5LAogICAgICBhbmQgbm90IGZvciBkaXNwbGF5aW5nIG51bWVyaWMgY29vcmRpbmF0ZXMsIHdlIGRvbid0IG5lZWQgdGhlIGV4dHJhIHByZWNpc2lvbgogICAgICBvZiBhbiBlbGxpcHNvaWRhbCBwcm9qZWN0aW9uLiBUaGUgc3BoZXJpY2FsIHByb2plY3Rpb24gY2F1c2VzIGFwcHJveGltYXRlbHkKICAgICAgMC4zMyBwZXJjZW50IHNjYWxlIGRpc3RvcnRpb24gaW4gdGhlIFkgZGlyZWN0aW9uLCB3aGljaCBpcyBub3QgdmlzdWFsbHkKICAgICAgbm90aWNlYWJsZS4KCiAgICBIb3cgZG8gSSBjcmVhdGUgYSByYXN0ZXIgaW4gRVBTRzozODU3IGFuZCBjb252ZXJ0IGNvb3JkaW5hdGVzIHdpdGggUFJPSi40PwoKICAgICAgWW91IGNhbiB1c2Ugc3RhbmRhcmQgR0lTIHRvb2xzIGxpa2UgZ2RhbHdhcnAsIGNzMmNzIG9yIGdkYWx0cmFuc2Zvcm0uCiAgICAgIEFsbCBvZiB0aGUgdG9vbHMgc3VwcG9ydHMgLXRfc3JzICdlcHNnOjM4NTcnLgoKICAgICAgRm9yIG90aGVyIEdJUyBwcm9ncmFtcyBjaGVjayB0aGUgZXhhY3QgZGVmaW5pdGlvbiBvZiB0aGUgcHJvamVjdGlvbjoKICAgICAgTW9yZSBpbmZvIGF0IGh0dHA6Ly9zcGF0aWFscmVmZXJlbmNlLm9yZy9yZWYvdXNlci9nb29nbGUtcHJvamVjdGlvbi8KICAgICAgVGhlIHNhbWUgcHJvamVjdGlvbiBpcyBkZXNpZ25hdGVkIGFzIEVQU0c6Mzg1Ny4gV0tUIGRlZmluaXRpb24gaXMgaW4gdGhlCiAgICAgIG9mZmljaWFsIEVQU0cgZGF0YWJhc2UuCgogICAgICBQcm9qNCBUZXh0OgogICAgICAgICtwcm9qPW1lcmMgK2E9NjM3ODEzNyArYj02Mzc4MTM3ICtsYXRfdHM9MC4wICtsb25fMD0wLjAgK3hfMD0wLjAgK3lfMD0wCiAgICAgICAgK2s9MS4wICt1bml0cz1tICtuYWRncmlkcz1AbnVsbCArbm9fZGVmcwoKICAgICAgSHVtYW4gcmVhZGFibGUgV0tUIGZvcm1hdCBvZiBFUFNHOjM4NTc6CiAgICAgICAgIFBST0pDU1siR29vZ2xlIE1hcHMgR2xvYmFsIE1lcmNhdG9yIiwKICAgICAgICAgICAgIEdFT0dDU1siV0dTIDg0IiwKICAgICAgICAgICAgICAgICBEQVRVTVsiV0dTXzE5ODQiLAogICAgICAgICAgICAgICAgICAgICBTUEhFUk9JRFsiV0dTIDg0Iiw2Mzc4MTM3LDI5OC4yNTcyMjM1NjMsCiAgICAgICAgICAgICAgICAgICAgICAgICBBVVRIT1JJVFlbIkVQU0ciLCI3MDMwIl1dLAogICAgICAgICAgICAgICAgICAgICBBVVRIT1JJVFlbIkVQU0ciLCI2MzI2Il1dLAogICAgICAgICAgICAgICAgIFBSSU1FTVsiR3JlZW53aWNoIiwwXSwKICAgICAgICAgICAgICAgICBVTklUWyJkZWdyZWUiLDAuMDE3NDUzMjkyNTE5OTQzM10sCiAgICAgICAgICAgICAgICAgQVVUSE9SSVRZWyJFUFNHIiwiNDMyNiJdXSwKICAgICAgICAgICAgIFBST0pFQ1RJT05bIk1lcmNhdG9yXzFTUCJdLAogICAgICAgICAgICAgUEFSQU1FVEVSWyJjZW50cmFsX21lcmlkaWFuIiwwXSwKICAgICAgICAgICAgIFBBUkFNRVRFUlsic2NhbGVfZmFjdG9yIiwxXSwKICAgICAgICAgICAgIFBBUkFNRVRFUlsiZmFsc2VfZWFzdGluZyIsMF0sCiAgICAgICAgICAgICBQQVJBTUVURVJbImZhbHNlX25vcnRoaW5nIiwwXSwKICAgICAgICAgICAgIFVOSVRbIm1ldHJlIiwxLAogICAgICAgICAgICAgICAgIEFVVEhPUklUWVsiRVBTRyIsIjkwMDEiXV1dCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZiwgdGlsZVNpemU9MjU2KToKICAgICAgICAiSW5pdGlhbGl6ZSB0aGUgVE1TIEdsb2JhbCBNZXJjYXRvciBweXJhbWlkIgogICAgICAgIHNlbGYudGlsZVNpemUgPSB0aWxlU2l6ZQogICAgICAgIHNlbGYuaW5pdGlhbFJlc29sdXRpb24gPSAyICogbWF0aC5waSAqIDYzNzgxMzcgLyBzZWxmLnRpbGVTaXplCiAgICAgICAgIyAxNTY1NDMuMDMzOTI4MDQwNjIgZm9yIHRpbGVTaXplIDI1NiBwaXhlbHMKICAgICAgICBzZWxmLm9yaWdpblNoaWZ0ID0gMiAqIG1hdGgucGkgKiA2Mzc4MTM3IC8gMi4wCiAgICAgICAgIyAyMDAzNzUwOC4zNDI3ODkyNDQKCiAgICBkZWYgTGF0TG9uVG9NZXRlcnMoc2VsZiwgbGF0LCBsb24pOgogICAgICAgICJDb252ZXJ0cyBnaXZlbiBsYXQvbG9uIGluIFdHUzg0IERhdHVtIHRvIFhZIGluIFNwaGVyaWNhbCBNZXJjYXRvciBFUFNHOjM4NTciCgogICAgICAgIG14ID0gbG9uICogc2VsZi5vcmlnaW5TaGlmdCAvIDE4MC4wCiAgICAgICAgbXkgPSBtYXRoLmxvZyhtYXRoLnRhbigoOTAgKyBsYXQpICogbWF0aC5waSAvIDM2MC4wKSkgLyAobWF0aC5waSAvIDE4MC4wKQoKICAgICAgICBteSA9IG15ICogc2VsZi5vcmlnaW5TaGlmdCAvIDE4MC4wCiAgICAgICAgcmV0dXJuIG14LCBteQoKICAgIGRlZiBNZXRlcnNUb0xhdExvbihzZWxmLCBteCwgbXkpOgogICAgICAgICJDb252ZXJ0cyBYWSBwb2ludCBmcm9tIFNwaGVyaWNhbCBNZXJjYXRvciBFUFNHOjM4NTcgdG8gbGF0L2xvbiBpbiBXR1M4NCBEYXR1bSIKCiAgICAgICAgbG9uID0gKG14IC8gc2VsZi5vcmlnaW5TaGlmdCkgKiAxODAuMAogICAgICAgIGxhdCA9IChteSAvIHNlbGYub3JpZ2luU2hpZnQpICogMTgwLjAKCiAgICAgICAgbGF0ID0gMTgwIC8gbWF0aC5waSAqICgyICogbWF0aC5hdGFuKG1hdGguZXhwKGxhdCAqIG1hdGgucGkgLyAxODAuMCkpIC0gbWF0aC5waSAvIDIuMCkKICAgICAgICByZXR1cm4gbGF0LCBsb24KCiAgICBkZWYgUGl4ZWxzVG9NZXRlcnMoc2VsZiwgcHgsIHB5LCB6b29tKToKICAgICAgICAiQ29udmVydHMgcGl4ZWwgY29vcmRpbmF0ZXMgaW4gZ2l2ZW4gem9vbSBsZXZlbCBvZiBweXJhbWlkIHRvIEVQU0c6Mzg1NyIKCiAgICAgICAgcmVzID0gc2VsZi5SZXNvbHV0aW9uKHpvb20pCiAgICAgICAgbXggPSBweCAqIHJlcyAtIHNlbGYub3JpZ2luU2hpZnQKICAgICAgICBteSA9IHB5ICogcmVzIC0gc2VsZi5vcmlnaW5TaGlmdAogICAgICAgIHJldHVybiBteCwgbXkKCiAgICBkZWYgTWV0ZXJzVG9QaXhlbHMoc2VsZiwgbXgsIG15LCB6b29tKToKICAgICAgICAiQ29udmVydHMgRVBTRzozODU3IHRvIHB5cmFtaWQgcGl4ZWwgY29vcmRpbmF0ZXMgaW4gZ2l2ZW4gem9vbSBsZXZlbCIKCiAgICAgICAgcmVzID0gc2VsZi5SZXNvbHV0aW9uKHpvb20pCiAgICAgICAgcHggPSAobXggKyBzZWxmLm9yaWdpblNoaWZ0KSAvIHJlcwogICAgICAgIHB5ID0gKG15ICsgc2VsZi5vcmlnaW5TaGlmdCkgLyByZXMKICAgICAgICByZXR1cm4gcHgsIHB5CgogICAgZGVmIFBpeGVsc1RvVGlsZShzZWxmLCBweCwgcHkpOgogICAgICAgICJSZXR1cm5zIGEgdGlsZSBjb3ZlcmluZyByZWdpb24gaW4gZ2l2ZW4gcGl4ZWwgY29vcmRpbmF0ZXMiCgogICAgICAgIHR4ID0gaW50KG1hdGguY2VpbChweCAvIGZsb2F0KHNlbGYudGlsZVNpemUpKSAtIDEpCiAgICAgICAgdHkgPSBpbnQobWF0aC5jZWlsKHB5IC8gZmxvYXQoc2VsZi50aWxlU2l6ZSkpIC0gMSkKICAgICAgICByZXR1cm4gdHgsIHR5CgogICAgZGVmIFBpeGVsc1RvUmFzdGVyKHNlbGYsIHB4LCBweSwgem9vbSk6CiAgICAgICAgIk1vdmUgdGhlIG9yaWdpbiBvZiBwaXhlbCBjb29yZGluYXRlcyB0byB0b3AtbGVmdCBjb3JuZXIiCgogICAgICAgIG1hcFNpemUgPSBzZWxmLnRpbGVTaXplIDw8IHpvb20KICAgICAgICByZXR1cm4gcHgsIG1hcFNpemUgLSBweQoKICAgIGRlZiBNZXRlcnNUb1RpbGUoc2VsZiwgbXgsIG15LCB6b29tKToKICAgICAgICAiUmV0dXJucyB0aWxlIGZvciBnaXZlbiBtZXJjYXRvciBjb29yZGluYXRlcyIKCiAgICAgICAgcHgsIHB5ID0gc2VsZi5NZXRlcnNUb1BpeGVscyhteCwgbXksIHpvb20pCiAgICAgICAgcmV0dXJuIHNlbGYuUGl4ZWxzVG9UaWxlKHB4LCBweSkKCiAgICBkZWYgVGlsZUJvdW5kcyhzZWxmLCB0eCwgdHksIHpvb20pOgogICAgICAgICJSZXR1cm5zIGJvdW5kcyBvZiB0aGUgZ2l2ZW4gdGlsZSBpbiBFUFNHOjM4NTcgY29vcmRpbmF0ZXMiCgogICAgICAgIG1pbngsIG1pbnkgPSBzZWxmLlBpeGVsc1RvTWV0ZXJzKHR4KnNlbGYudGlsZVNpemUsIHR5KnNlbGYudGlsZVNpemUsIHpvb20pCiAgICAgICAgbWF4eCwgbWF4eSA9IHNlbGYuUGl4ZWxzVG9NZXRlcnMoKHR4KzEpKnNlbGYudGlsZVNpemUsICh0eSsxKSpzZWxmLnRpbGVTaXplLCB6b29tKQogICAgICAgIHJldHVybiAobWlueCwgbWlueSwgbWF4eCwgbWF4eSkKCiAgICBkZWYgVGlsZUxhdExvbkJvdW5kcyhzZWxmLCB0eCwgdHksIHpvb20pOgogICAgICAgICJSZXR1cm5zIGJvdW5kcyBvZiB0aGUgZ2l2ZW4gdGlsZSBpbiBsYXRpdHVkZS9sb25naXR1ZGUgdXNpbmcgV0dTODQgZGF0dW0iCgogICAgICAgIGJvdW5kcyA9IHNlbGYuVGlsZUJvdW5kcyh0eCwgdHksIHpvb20pCiAgICAgICAgbWluTGF0LCBtaW5Mb24gPSBzZWxmLk1ldGVyc1RvTGF0TG9uKGJvdW5kc1swXSwgYm91bmRzWzFdKQogICAgICAgIG1heExhdCwgbWF4TG9uID0gc2VsZi5NZXRlcnNUb0xhdExvbihib3VuZHNbMl0sIGJvdW5kc1szXSkKCiAgICAgICAgcmV0dXJuIChtaW5MYXQsIG1pbkxvbiwgbWF4TGF0LCBtYXhMb24pCgogICAgZGVmIFJlc29sdXRpb24oc2VsZiwgem9vbSk6CiAgICAgICAgIlJlc29sdXRpb24gKG1ldGVycy9waXhlbCkgZm9yIGdpdmVuIHpvb20gbGV2ZWwgKG1lYXN1cmVkIGF0IEVxdWF0b3IpIgoKICAgICAgICAjIHJldHVybiAoMiAqIG1hdGgucGkgKiA2Mzc4MTM3KSAvIChzZWxmLnRpbGVTaXplICogMioqem9vbSkKICAgICAgICByZXR1cm4gc2VsZi5pbml0aWFsUmVzb2x1dGlvbiAvICgyKip6b29tKQoKICAgIGRlZiBab29tRm9yUGl4ZWxTaXplKHNlbGYsIHBpeGVsU2l6ZSk6CiAgICAgICAgIk1heGltYWwgc2NhbGVkb3duIHpvb20gb2YgdGhlIHB5cmFtaWQgY2xvc2VzdCB0byB0aGUgcGl4ZWxTaXplLiIKCiAgICAgICAgZm9yIGkgaW4gcmFuZ2UoTUFYWk9PTUxFVkVMKToKICAgICAgICAgICAgaWYgcGl4ZWxTaXplID4gc2VsZi5SZXNvbHV0aW9uKGkpOgogICAgICAgICAgICAgICAgaWYgaSAhPSAtMToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaS0xCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJldHVybiAwICAgICMgV2UgZG9uJ3Qgd2FudCB0byBzY2FsZSB1cAoKICAgIGRlZiBHb29nbGVUaWxlKHNlbGYsIHR4LCB0eSwgem9vbSk6CiAgICAgICAgIkNvbnZlcnRzIFRNUyB0aWxlIGNvb3JkaW5hdGVzIHRvIEdvb2dsZSBUaWxlIGNvb3JkaW5hdGVzIgoKICAgICAgICAjIGNvb3JkaW5hdGUgb3JpZ2luIGlzIG1vdmVkIGZyb20gYm90dG9tLWxlZnQgdG8gdG9wLWxlZnQgY29ybmVyIG9mIHRoZSBleHRlbnQKICAgICAgICByZXR1cm4gdHgsICgyKip6b29tIC0gMSkgLSB0eQoKICAgIGRlZiBRdWFkVHJlZShzZWxmLCB0eCwgdHksIHpvb20pOgogICAgICAgICJDb252ZXJ0cyBUTVMgdGlsZSBjb29yZGluYXRlcyB0byBNaWNyb3NvZnQgUXVhZFRyZWUiCgogICAgICAgIHF1YWRLZXkgPSAiIgogICAgICAgIHR5ID0gKDIqKnpvb20gLSAxKSAtIHR5CiAgICAgICAgZm9yIGkgaW4gcmFuZ2Uoem9vbSwgMCwgLTEpOgogICAgICAgICAgICBkaWdpdCA9IDAKICAgICAgICAgICAgbWFzayA9IDEgPDwgKGktMSkKICAgICAgICAgICAgaWYgKHR4ICYgbWFzaykgIT0gMDoKICAgICAgICAgICAgICAgIGRpZ2l0ICs9IDEKICAgICAgICAgICAgaWYgKHR5ICYgbWFzaykgIT0gMDoKICAgICAgICAgICAgICAgIGRpZ2l0ICs9IDIKICAgICAgICAgICAgcXVhZEtleSArPSBzdHIoZGlnaXQpCgogICAgICAgIHJldHVybiBxdWFkS2V5CgoKY2xhc3MgR2xvYmFsR2VvZGV0aWMob2JqZWN0KToKICAgIHIiIiIKICAgIFRNUyBHbG9iYWwgR2VvZGV0aWMgUHJvZmlsZQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgogICAgRnVuY3Rpb25zIG5lY2Vzc2FyeSBmb3IgZ2VuZXJhdGlvbiBvZiBnbG9iYWwgdGlsZXMgaW4gUGxhdGUgQ2FycmUgcHJvamVjdGlvbiwKICAgIEVQU0c6NDMyNiwgInVucHJvamVjdGVkIHByb2ZpbGUiLgoKICAgIFN1Y2ggdGlsZXMgYXJlIGNvbXBhdGlibGUgd2l0aCBHb29nbGUgRWFydGggKGFzIGFueSBvdGhlciBFUFNHOjQzMjYgcmFzdGVycykKICAgIGFuZCB5b3UgY2FuIG92ZXJsYXkgdGhlIHRpbGVzIG9uIHRvcCBvZiBPcGVuTGF5ZXJzIGJhc2UgbWFwLgoKICAgIFBpeGVsIGFuZCB0aWxlIGNvb3JkaW5hdGVzIGFyZSBpbiBUTVMgbm90YXRpb24gKG9yaWdpbiBbMCwwXSBpbiBib3R0b20tbGVmdCkuCgogICAgV2hhdCBjb29yZGluYXRlIGNvbnZlcnNpb25zIGRvIHdlIG5lZWQgZm9yIFRNUyBHbG9iYWwgR2VvZGV0aWMgdGlsZXM/CgogICAgICBHbG9iYWwgR2VvZGV0aWMgdGlsZXMgYXJlIHVzaW5nIGdlb2RldGljIGNvb3JkaW5hdGVzIChsYXRpdHVkZSxsb25naXR1ZGUpCiAgICAgIGRpcmVjdGx5IGFzIHBsYW5hciBjb29yZGluYXRlcyBYWSAoaXQgaXMgYWxzbyBjYWxsZWQgVW5wcm9qZWN0ZWQgb3IgUGxhdGUKICAgICAgQ2FycmUpLiBXZSBuZWVkIG9ubHkgc2NhbGluZyB0byBwaXhlbCBweXJhbWlkIGFuZCBjdXR0aW5nIHRvIHRpbGVzLgogICAgICBQeXJhbWlkIGhhcyBvbiB0b3AgbGV2ZWwgdHdvIHRpbGVzLCBzbyBpdCBpcyBub3Qgc3F1YXJlIGJ1dCByZWN0YW5nbGUuCiAgICAgIEFyZWEgWy0xODAsLTkwLDE4MCw5MF0gaXMgc2NhbGVkIHRvIDUxMngyNTYgcGl4ZWxzLgogICAgICBUTVMgaGFzIGNvb3JkaW5hdGUgb3JpZ2luIChmb3IgcGl4ZWxzIGFuZCB0aWxlcykgaW4gYm90dG9tLWxlZnQgY29ybmVyLgogICAgICBSYXN0ZXJzIGFyZSBpbiBFUFNHOjQzMjYgYW5kIHRoZXJlZm9yZSBhcmUgY29tcGF0aWJsZSB3aXRoIEdvb2dsZSBFYXJ0aC4KCiAgICAgICAgIExhdExvbiAgICAgIDwtPiAgICAgIFBpeGVscyAgICAgIDwtPiAgICAgVGlsZXMKCiAgICAgV0dTODQgY29vcmRpbmF0ZXMgICBQaXhlbHMgaW4gcHlyYW1pZCAgVGlsZXMgaW4gcHlyYW1pZAogICAgICAgICBsYXQvbG9uICAgICAgICAgWFkgcGl4ZWxzIFogem9vbSAgICAgIFhZWiBmcm9tIFRNUwogICAgICAgIEVQU0c6NDMyNgogICAgICAgICAuLS0tLS4gICAgICAgICAgICAgICAgLS0tLQogICAgICAgIC8gICAgICBcICAgICA8LT4gICAgLy0tLS0tLS0tLyAgICA8LT4gICAgICBUTVMKICAgICAgICBcICAgICAgLyAgICAgICAgIC8tLS0tLS0tLS0tLS0tLS8KICAgICAgICAgLS0tLS0gICAgICAgIC8tLS0tLS0tLS0tLS0tLS0tLS0tLS8KICAgICAgIFdNUywgS01MICAgIFdlYiBDbGllbnRzLCBHb29nbGUgRWFydGggIFRpbGVNYXBTZXJ2aWNlCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZiwgdG1zY29tcGF0aWJsZSwgdGlsZVNpemU9MjU2KToKICAgICAgICBzZWxmLnRpbGVTaXplID0gdGlsZVNpemUKICAgICAgICBpZiB0bXNjb21wYXRpYmxlIGlzIG5vdCBOb25lOgogICAgICAgICAgICAjIERlZmF1bHRzIHRoZSByZXNvbHV0aW9uIGZhY3RvciB0byAwLjcwMzEyNSAoMiB0aWxlcyBAIGxldmVsIDApCiAgICAgICAgICAgICMgQWRoZXJzIHRvIE9TR2VvIFRNUyBzcGVjCiAgICAgICAgICAgICMgaHR0cDovL3dpa2kub3NnZW8ub3JnL3dpa2kvVGlsZV9NYXBfU2VydmljZV9TcGVjaWZpY2F0aW9uI2dsb2JhbC1nZW9kZXRpYwogICAgICAgICAgICBzZWxmLnJlc0ZhY3QgPSAxODAuMCAvIHNlbGYudGlsZVNpemUKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIERlZmF1bHRzIHRoZSByZXNvbHV0aW9uIGZhY3RvciB0byAxLjQwNjI1ICgxIHRpbGUgQCBsZXZlbCAwKQogICAgICAgICAgICAjIEFkaGVyZXMgT3BlbkxheWVycywgTWFwUHJveHksIGV0YyBkZWZhdWx0IHJlc29sdXRpb24gZm9yIFdNVFMKICAgICAgICAgICAgc2VsZi5yZXNGYWN0ID0gMzYwLjAgLyBzZWxmLnRpbGVTaXplCgogICAgZGVmIExvbkxhdFRvUGl4ZWxzKHNlbGYsIGxvbiwgbGF0LCB6b29tKToKICAgICAgICAiQ29udmVydHMgbG9uL2xhdCB0byBwaXhlbCBjb29yZGluYXRlcyBpbiBnaXZlbiB6b29tIG9mIHRoZSBFUFNHOjQzMjYgcHlyYW1pZCIKCiAgICAgICAgcmVzID0gc2VsZi5yZXNGYWN0IC8gMioqem9vbQogICAgICAgIHB4ID0gKDE4MCArIGxvbikgLyByZXMKICAgICAgICBweSA9ICg5MCArIGxhdCkgLyByZXMKICAgICAgICByZXR1cm4gcHgsIHB5CgogICAgZGVmIFBpeGVsc1RvVGlsZShzZWxmLCBweCwgcHkpOgogICAgICAgICJSZXR1cm5zIGNvb3JkaW5hdGVzIG9mIHRoZSB0aWxlIGNvdmVyaW5nIHJlZ2lvbiBpbiBwaXhlbCBjb29yZGluYXRlcyIKCiAgICAgICAgdHggPSBpbnQobWF0aC5jZWlsKHB4IC8gZmxvYXQoc2VsZi50aWxlU2l6ZSkpIC0gMSkKICAgICAgICB0eSA9IGludChtYXRoLmNlaWwocHkgLyBmbG9hdChzZWxmLnRpbGVTaXplKSkgLSAxKQogICAgICAgIHJldHVybiB0eCwgdHkKCiAgICBkZWYgTG9uTGF0VG9UaWxlKHNlbGYsIGxvbiwgbGF0LCB6b29tKToKICAgICAgICAiUmV0dXJucyB0aGUgdGlsZSBmb3Igem9vbSB3aGljaCBjb3ZlcnMgZ2l2ZW4gbG9uL2xhdCBjb29yZGluYXRlcyIKCiAgICAgICAgcHgsIHB5ID0gc2VsZi5Mb25MYXRUb1BpeGVscyhsb24sIGxhdCwgem9vbSkKICAgICAgICByZXR1cm4gc2VsZi5QaXhlbHNUb1RpbGUocHgsIHB5KQoKICAgIGRlZiBSZXNvbHV0aW9uKHNlbGYsIHpvb20pOgogICAgICAgICJSZXNvbHV0aW9uIChhcmMvcGl4ZWwpIGZvciBnaXZlbiB6b29tIGxldmVsIChtZWFzdXJlZCBhdCBFcXVhdG9yKSIKCiAgICAgICAgcmV0dXJuIHNlbGYucmVzRmFjdCAvIDIqKnpvb20KCiAgICBkZWYgWm9vbUZvclBpeGVsU2l6ZShzZWxmLCBwaXhlbFNpemUpOgogICAgICAgICJNYXhpbWFsIHNjYWxlZG93biB6b29tIG9mIHRoZSBweXJhbWlkIGNsb3Nlc3QgdG8gdGhlIHBpeGVsU2l6ZS4iCgogICAgICAgIGZvciBpIGluIHJhbmdlKE1BWFpPT01MRVZFTCk6CiAgICAgICAgICAgIGlmIHBpeGVsU2l6ZSA+IHNlbGYuUmVzb2x1dGlvbihpKToKICAgICAgICAgICAgICAgIGlmIGkgIT0gMDoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaS0xCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJldHVybiAwICAgICMgV2UgZG9uJ3Qgd2FudCB0byBzY2FsZSB1cAoKICAgIGRlZiBUaWxlQm91bmRzKHNlbGYsIHR4LCB0eSwgem9vbSk6CiAgICAgICAgIlJldHVybnMgYm91bmRzIG9mIHRoZSBnaXZlbiB0aWxlIgogICAgICAgIHJlcyA9IHNlbGYucmVzRmFjdCAvIDIqKnpvb20KICAgICAgICByZXR1cm4gKAogICAgICAgICAgICB0eCpzZWxmLnRpbGVTaXplKnJlcyAtIDE4MCwKICAgICAgICAgICAgdHkqc2VsZi50aWxlU2l6ZSpyZXMgLSA5MCwKICAgICAgICAgICAgKHR4KzEpKnNlbGYudGlsZVNpemUqcmVzIC0gMTgwLAogICAgICAgICAgICAodHkrMSkqc2VsZi50aWxlU2l6ZSpyZXMgLSA5MAogICAgICAgICkKCiAgICBkZWYgVGlsZUxhdExvbkJvdW5kcyhzZWxmLCB0eCwgdHksIHpvb20pOgogICAgICAgICJSZXR1cm5zIGJvdW5kcyBvZiB0aGUgZ2l2ZW4gdGlsZSBpbiB0aGUgU1dORSBmb3JtIgogICAgICAgIGIgPSBzZWxmLlRpbGVCb3VuZHModHgsIHR5LCB6b29tKQogICAgICAgIHJldHVybiAoYlsxXSwgYlswXSwgYlszXSwgYlsyXSkKCgpjbGFzcyBab29taWZ5KG9iamVjdCk6CiAgICAiIiIKICAgIFRpbGVzIGNvbXBhdGlibGUgd2l0aCB0aGUgWm9vbWlmeSB2aWV3ZXIKICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICIiIgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB3aWR0aCwgaGVpZ2h0LCB0aWxlc2l6ZT0yNTYsIHRpbGVmb3JtYXQ9J2pwZycpOgogICAgICAgICIiIkluaXRpYWxpemF0aW9uIG9mIHRoZSBab29taWZ5IHRpbGUgdHJlZSIiIgoKICAgICAgICBzZWxmLnRpbGVzaXplID0gdGlsZXNpemUKICAgICAgICBzZWxmLnRpbGVmb3JtYXQgPSB0aWxlZm9ybWF0CiAgICAgICAgaW1hZ2VzaXplID0gKHdpZHRoLCBoZWlnaHQpCiAgICAgICAgdGlsZXMgPSAobWF0aC5jZWlsKHdpZHRoIC8gdGlsZXNpemUpLCBtYXRoLmNlaWwoaGVpZ2h0IC8gdGlsZXNpemUpKQoKICAgICAgICAjIFNpemUgKGluIHRpbGVzKSBmb3IgZWFjaCB0aWVyIG9mIHB5cmFtaWQuCiAgICAgICAgc2VsZi50aWVyU2l6ZUluVGlsZXMgPSBbXQogICAgICAgIHNlbGYudGllclNpemVJblRpbGVzLmFwcGVuZCh0aWxlcykKCiAgICAgICAgIyBJbWFnZSBzaXplIGluIHBpeGVscyBmb3IgZWFjaCBweXJhbWlkIHRpZXJzZWxmCiAgICAgICAgc2VsZi50aWVySW1hZ2VTaXplID0gW10KICAgICAgICBzZWxmLnRpZXJJbWFnZVNpemUuYXBwZW5kKGltYWdlc2l6ZSkKCiAgICAgICAgd2hpbGUgKGltYWdlc2l6ZVswXSA+IHRpbGVzaXplIG9yIGltYWdlc2l6ZVsxXSA+IHRpbGVzaXplKToKICAgICAgICAgICAgaW1hZ2VzaXplID0gKG1hdGguZmxvb3IoaW1hZ2VzaXplWzBdIC8gMiksIG1hdGguZmxvb3IoaW1hZ2VzaXplWzFdIC8gMikpCiAgICAgICAgICAgIHRpbGVzID0gKG1hdGguY2VpbChpbWFnZXNpemVbMF0gLyB0aWxlc2l6ZSksIG1hdGguY2VpbChpbWFnZXNpemVbMV0gLyB0aWxlc2l6ZSkpCiAgICAgICAgICAgIHNlbGYudGllclNpemVJblRpbGVzLmFwcGVuZCh0aWxlcykKICAgICAgICAgICAgc2VsZi50aWVySW1hZ2VTaXplLmFwcGVuZChpbWFnZXNpemUpCgogICAgICAgIHNlbGYudGllclNpemVJblRpbGVzLnJldmVyc2UoKQogICAgICAgIHNlbGYudGllckltYWdlU2l6ZS5yZXZlcnNlKCkKCiAgICAgICAgIyBEZXB0aCBvZiB0aGUgWm9vbWlmeSBweXJhbWlkLCBudW1iZXIgb2YgdGllcnMgKHpvb20gbGV2ZWxzKQogICAgICAgIHNlbGYubnVtYmVyT2ZUaWVycyA9IGxlbihzZWxmLnRpZXJTaXplSW5UaWxlcykKCiAgICAgICAgIyBOdW1iZXIgb2YgdGlsZXMgdXAgdG8gdGhlIGdpdmVuIHRpZXIgb2YgcHlyYW1pZC4KICAgICAgICBzZWxmLnRpbGVDb3VudFVwVG9UaWVyID0gW10KICAgICAgICBzZWxmLnRpbGVDb3VudFVwVG9UaWVyWzBdID0gMAogICAgICAgIGZvciBpIGluIHJhbmdlKDEsIHNlbGYubnVtYmVyT2ZUaWVycysxKToKICAgICAgICAgICAgc2VsZi50aWxlQ291bnRVcFRvVGllci5hcHBlbmQoCiAgICAgICAgICAgICAgICBzZWxmLnRpZXJTaXplSW5UaWxlc1tpLTFdWzBdICogc2VsZi50aWVyU2l6ZUluVGlsZXNbaS0xXVsxXSArCiAgICAgICAgICAgICAgICBzZWxmLnRpbGVDb3VudFVwVG9UaWVyW2ktMV0KICAgICAgICAgICAgKQoKICAgIGRlZiB0aWxlZmlsZW5hbWUoc2VsZiwgeCwgeSwgeik6CiAgICAgICAgIiIiUmV0dXJucyBmaWxlbmFtZSBmb3IgdGlsZSB3aXRoIGdpdmVuIGNvb3JkaW5hdGVzIiIiCgogICAgICAgIHRpbGVJbmRleCA9IHggKyB5ICogc2VsZi50aWVyU2l6ZUluVGlsZXNbel1bMF0gKyBzZWxmLnRpbGVDb3VudFVwVG9UaWVyW3pdCiAgICAgICAgcmV0dXJuIG9zLnBhdGguam9pbigiVGlsZUdyb3VwJS4wZiIgJSBtYXRoLmZsb29yKHRpbGVJbmRleCAvIDI1NiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiJXMtJXMtJXMuJXMiICUgKHosIHgsIHksIHNlbGYudGlsZWZvcm1hdCkpCgoKY2xhc3MgR0RBTEVycm9yKEV4Y2VwdGlvbik6CiAgICBwYXNzCgoKZGVmIGV4aXRfd2l0aF9lcnJvcihtZXNzYWdlLCBkZXRhaWxzPSIiKToKICAgICMgTWVzc2FnZSBwcmludGluZyBhbmQgZXhpdCBjb2RlIGtlcHQgZnJvbSB0aGUgd2F5IGl0IHdvcmtlZCB1c2luZyB0aGUgT3B0aW9uUGFyc2VyIChpbiBjYXNlCiAgICAjIHNvbWVvbmUgcGFyc2VzIHRoZSBlcnJvciBvdXRwdXQpCiAgICBzeXMuc3RkZXJyLndyaXRlKCJVc2FnZTogZ2RhbDJ0aWxlc19sb2NhbC5weSBbb3B0aW9uc10gaW5wdXRfZmlsZSBbb3V0cHV0XVxuXG4iKQogICAgc3lzLnN0ZGVyci53cml0ZSgiZ2RhbDJ0aWxlc19sb2NhbC5weTogZXJyb3I6ICVzXG4iICUgbWVzc2FnZSkKICAgIGlmIGRldGFpbHM6CiAgICAgICAgc3lzLnN0ZGVyci53cml0ZSgiXG5cbiVzXG4iICUgZGV0YWlscykKCiAgICBzeXMuZXhpdCgyKQoKCmRlZiBnZW5lcmF0ZV9rbWwodHgsIHR5LCB0eiwgdGlsZWV4dCwgdGlsZXNpemUsIHRpbGVzd25lLCBvcHRpb25zLCBjaGlsZHJlbj1Ob25lLCAqKmFyZ3MpOgogICAgIiIiCiAgICBUZW1wbGF0ZSBmb3IgdGhlIEtNTC4gUmV0dXJucyBmaWxsZWQgc3RyaW5nLgogICAgIiIiCiAgICBpZiBub3QgY2hpbGRyZW46CiAgICAgICAgY2hpbGRyZW4gPSBbXQoKICAgIGFyZ3NbJ3R4J10sIGFyZ3NbJ3R5J10sIGFyZ3NbJ3R6J10gPSB0eCwgdHksIHR6CiAgICBhcmdzWyd0aWxlZm9ybWF0J10gPSB0aWxlZXh0CiAgICBpZiAndGlsZXNpemUnIG5vdCBpbiBhcmdzOgogICAgICAgIGFyZ3NbJ3RpbGVzaXplJ10gPSB0aWxlc2l6ZQoKICAgIGlmICdtaW5sb2RwaXhlbHMnIG5vdCBpbiBhcmdzOgogICAgICAgIGFyZ3NbJ21pbmxvZHBpeGVscyddID0gaW50KGFyZ3NbJ3RpbGVzaXplJ10gLyAyKQogICAgaWYgJ21heGxvZHBpeGVscycgbm90IGluIGFyZ3M6CiAgICAgICAgYXJnc1snbWF4bG9kcGl4ZWxzJ10gPSBpbnQoYXJnc1sndGlsZXNpemUnXSAqIDgpCiAgICBpZiBjaGlsZHJlbiA9PSBbXToKICAgICAgICBhcmdzWydtYXhsb2RwaXhlbHMnXSA9IC0xCgogICAgaWYgdHggaXMgTm9uZToKICAgICAgICB0aWxla21sID0gRmFsc2UKICAgICAgICBhcmdzWyd0aXRsZSddID0gb3B0aW9ucy50aXRsZQogICAgZWxzZToKICAgICAgICB0aWxla21sID0gVHJ1ZQogICAgICAgIGFyZ3NbJ3RpdGxlJ10gPSAiJWQvJWQvJWQua21sIiAlICh0eiwgdHgsIHR5KQogICAgICAgIGFyZ3NbJ3NvdXRoJ10sIGFyZ3NbJ3dlc3QnXSwgYXJnc1snbm9ydGgnXSwgYXJnc1snZWFzdCddID0gdGlsZXN3bmUodHgsIHR5LCB0eikKCiAgICBpZiB0eCA9PSAwOgogICAgICAgIGFyZ3NbJ2RyYXdPcmRlciddID0gMiAqIHR6ICsgMQogICAgZWxpZiB0eCBpcyBub3QgTm9uZToKICAgICAgICBhcmdzWydkcmF3T3JkZXInXSA9IDIgKiB0egogICAgZWxzZToKICAgICAgICBhcmdzWydkcmF3T3JkZXInXSA9IDAKCiAgICB1cmwgPSBvcHRpb25zLnVybAogICAgaWYgbm90IHVybDoKICAgICAgICBpZiB0aWxla21sOgogICAgICAgICAgICB1cmwgPSAiLi4vLi4vIgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHVybCA9ICIiCgogICAgcyA9ICIiIjw/eG1sIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9InV0Zi04Ij8+CjxrbWwgeG1sbnM9Imh0dHA6Ly93d3cub3Blbmdpcy5uZXQva21sLzIuMiI+CiAgPERvY3VtZW50PgogICAgPG5hbWU+JSh0aXRsZSlzPC9uYW1lPgogICAgPGRlc2NyaXB0aW9uPjwvZGVzY3JpcHRpb24+CiAgICA8U3R5bGU+CiAgICAgIDxMaXN0U3R5bGUgaWQ9ImhpZGVDaGlsZHJlbiI+CiAgICAgICAgPGxpc3RJdGVtVHlwZT5jaGVja0hpZGVDaGlsZHJlbjwvbGlzdEl0ZW1UeXBlPgogICAgICA8L0xpc3RTdHlsZT4KICAgIDwvU3R5bGU+IiIiICUgYXJncwogICAgaWYgdGlsZWttbDoKICAgICAgICBzICs9ICIiIgogICAgPFJlZ2lvbj4KICAgICAgPExhdExvbkFsdEJveD4KICAgICAgICA8bm9ydGg+JShub3J0aCkuMTRmPC9ub3J0aD4KICAgICAgICA8c291dGg+JShzb3V0aCkuMTRmPC9zb3V0aD4KICAgICAgICA8ZWFzdD4lKGVhc3QpLjE0ZjwvZWFzdD4KICAgICAgICA8d2VzdD4lKHdlc3QpLjE0Zjwvd2VzdD4KICAgICAgPC9MYXRMb25BbHRCb3g+CiAgICAgIDxMb2Q+CiAgICAgICAgPG1pbkxvZFBpeGVscz4lKG1pbmxvZHBpeGVscylkPC9taW5Mb2RQaXhlbHM+CiAgICAgICAgPG1heExvZFBpeGVscz4lKG1heGxvZHBpeGVscylkPC9tYXhMb2RQaXhlbHM+CiAgICAgIDwvTG9kPgogICAgPC9SZWdpb24+CiAgICA8R3JvdW5kT3ZlcmxheT4KICAgICAgPGRyYXdPcmRlcj4lKGRyYXdPcmRlcilkPC9kcmF3T3JkZXI+CiAgICAgIDxJY29uPgogICAgICAgIDxocmVmPiUodHkpZC4lKHRpbGVmb3JtYXQpczwvaHJlZj4KICAgICAgPC9JY29uPgogICAgICA8TGF0TG9uQm94PgogICAgICAgIDxub3J0aD4lKG5vcnRoKS4xNGY8L25vcnRoPgogICAgICAgIDxzb3V0aD4lKHNvdXRoKS4xNGY8L3NvdXRoPgogICAgICAgIDxlYXN0PiUoZWFzdCkuMTRmPC9lYXN0PgogICAgICAgIDx3ZXN0PiUod2VzdCkuMTRmPC93ZXN0PgogICAgICA8L0xhdExvbkJveD4KICAgIDwvR3JvdW5kT3ZlcmxheT4KIiIiICUgYXJncwoKICAgIGZvciBjeCwgY3ksIGN6IGluIGNoaWxkcmVuOgogICAgICAgIGNzb3V0aCwgY3dlc3QsIGNub3J0aCwgY2Vhc3QgPSB0aWxlc3duZShjeCwgY3ksIGN6KQogICAgICAgIHMgKz0gIiIiCiAgICA8TmV0d29ya0xpbms+CiAgICAgIDxuYW1lPiVkLyVkLyVkLiVzPC9uYW1lPgogICAgICA8UmVnaW9uPgogICAgICAgIDxMYXRMb25BbHRCb3g+CiAgICAgICAgICA8bm9ydGg+JS4xNGY8L25vcnRoPgogICAgICAgICAgPHNvdXRoPiUuMTRmPC9zb3V0aD4KICAgICAgICAgIDxlYXN0PiUuMTRmPC9lYXN0PgogICAgICAgICAgPHdlc3Q+JS4xNGY8L3dlc3Q+CiAgICAgICAgPC9MYXRMb25BbHRCb3g+CiAgICAgICAgPExvZD4KICAgICAgICAgIDxtaW5Mb2RQaXhlbHM+JWQ8L21pbkxvZFBpeGVscz4KICAgICAgICAgIDxtYXhMb2RQaXhlbHM+LTE8L21heExvZFBpeGVscz4KICAgICAgICA8L0xvZD4KICAgICAgPC9SZWdpb24+CiAgICAgIDxMaW5rPgogICAgICAgIDxocmVmPiVzJWQvJWQvJWQua21sPC9ocmVmPgogICAgICAgIDx2aWV3UmVmcmVzaE1vZGU+b25SZWdpb248L3ZpZXdSZWZyZXNoTW9kZT4KICAgICAgICA8dmlld0Zvcm1hdC8+CiAgICAgIDwvTGluaz4KICAgIDwvTmV0d29ya0xpbms+CiAgICAgICAgIiIiICUgKGN6LCBjeCwgY3ksIGFyZ3NbJ3RpbGVmb3JtYXQnXSwgY25vcnRoLCBjc291dGgsIGNlYXN0LCBjd2VzdCwKICAgICAgICAgICAgICAgYXJnc1snbWlubG9kcGl4ZWxzJ10sIHVybCwgY3osIGN4LCBjeSkKCiAgICBzICs9ICIiIiAgICAgIDwvRG9jdW1lbnQ+Cjwva21sPgogICAgIiIiCiAgICByZXR1cm4gcwoKCmRlZiBzY2FsZV9xdWVyeV90b190aWxlKGRzcXVlcnksIGRzdGlsZSwgdGlsZWRyaXZlciwgb3B0aW9ucywgdGlsZWZpbGVuYW1lPScnKToKICAgICIiIlNjYWxlcyBkb3duIHF1ZXJ5IGRhdGFzZXQgdG8gdGhlIHRpbGUgZGF0YXNldCIiIgoKICAgIHF1ZXJ5c2l6ZSA9IGRzcXVlcnkuUmFzdGVyWFNpemUKICAgIHRpbGVzaXplID0gZHN0aWxlLlJhc3RlclhTaXplCiAgICB0aWxlYmFuZHMgPSBkc3RpbGUuUmFzdGVyQ291bnQKCiAgICBpZiBvcHRpb25zLnJlc2FtcGxpbmcgPT0gJ2F2ZXJhZ2UnOgoKICAgICAgICAjIEZ1bmN0aW9uOiBnZGFsLlJlZ2VuZXJhdGVPdmVydmlldygpCiAgICAgICAgZm9yIGkgaW4gcmFuZ2UoMSwgdGlsZWJhbmRzKzEpOgogICAgICAgICAgICAjIEJsYWNrIGJvcmRlciBhcm91bmQgTk9EQVRBCiAgICAgICAgICAgIHJlcyA9IGdkYWwuUmVnZW5lcmF0ZU92ZXJ2aWV3KGRzcXVlcnkuR2V0UmFzdGVyQmFuZChpKSwgZHN0aWxlLkdldFJhc3RlckJhbmQoaSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhdmVyYWdlJykKICAgICAgICAgICAgaWYgcmVzICE9IDA6CiAgICAgICAgICAgICAgICBleGl0X3dpdGhfZXJyb3IoIlJlZ2VuZXJhdGVPdmVydmlldygpIGZhaWxlZCBvbiAlcywgZXJyb3IgJWQiICUgKAogICAgICAgICAgICAgICAgICAgIHRpbGVmaWxlbmFtZSwgcmVzKSkKCiAgICBlbGlmIG9wdGlvbnMucmVzYW1wbGluZyA9PSAnYW50aWFsaWFzJzoKCiAgICAgICAgIyBTY2FsaW5nIGJ5IFBJTCAoUHl0aG9uIEltYWdpbmcgTGlicmFyeSkgLSBpbXByb3ZlZCBMYW5jem9zCiAgICAgICAgYXJyYXkgPSBudW1weS56ZXJvcygocXVlcnlzaXplLCBxdWVyeXNpemUsIHRpbGViYW5kcyksIG51bXB5LnVpbnQ4KQogICAgICAgIGZvciBpIGluIHJhbmdlKHRpbGViYW5kcyk6CiAgICAgICAgICAgIGFycmF5WzosIDosIGldID0gZ2RhbGFycmF5LkJhbmRSZWFkQXNBcnJheShkc3F1ZXJ5LkdldFJhc3RlckJhbmQoaSsxKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAsIDAsIHF1ZXJ5c2l6ZSwgcXVlcnlzaXplKQogICAgICAgIGltID0gSW1hZ2UuZnJvbWFycmF5KGFycmF5LCAnUkdCQScpICAgICAjIEFsd2F5cyBmb3VyIGJhbmRzCiAgICAgICAgaW0xID0gaW0ucmVzaXplKCh0aWxlc2l6ZSwgdGlsZXNpemUpLCBJbWFnZS5BTlRJQUxJQVMpCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHModGlsZWZpbGVuYW1lKToKICAgICAgICAgICAgaW0wID0gSW1hZ2Uub3Blbih0aWxlZmlsZW5hbWUpCiAgICAgICAgICAgIGltMSA9IEltYWdlLmNvbXBvc2l0ZShpbTEsIGltMCwgaW0xKQogICAgICAgIGltMS5zYXZlKHRpbGVmaWxlbmFtZSwgdGlsZWRyaXZlcikKCiAgICBlbHNlOgoKICAgICAgICBpZiBvcHRpb25zLnJlc2FtcGxpbmcgPT0gJ25lYXInOgogICAgICAgICAgICBnZGFsX3Jlc2FtcGxpbmcgPSBnZGFsLkdSQV9OZWFyZXN0TmVpZ2hib3VyCgogICAgICAgIGVsaWYgb3B0aW9ucy5yZXNhbXBsaW5nID09ICdiaWxpbmVhcic6CiAgICAgICAgICAgIGdkYWxfcmVzYW1wbGluZyA9IGdkYWwuR1JBX0JpbGluZWFyCgogICAgICAgIGVsaWYgb3B0aW9ucy5yZXNhbXBsaW5nID09ICdjdWJpYyc6CiAgICAgICAgICAgIGdkYWxfcmVzYW1wbGluZyA9IGdkYWwuR1JBX0N1YmljCgogICAgICAgIGVsaWYgb3B0aW9ucy5yZXNhbXBsaW5nID09ICdjdWJpY3NwbGluZSc6CiAgICAgICAgICAgIGdkYWxfcmVzYW1wbGluZyA9IGdkYWwuR1JBX0N1YmljU3BsaW5lCgogICAgICAgIGVsaWYgb3B0aW9ucy5yZXNhbXBsaW5nID09ICdsYW5jem9zJzoKICAgICAgICAgICAgZ2RhbF9yZXNhbXBsaW5nID0gZ2RhbC5HUkFfTGFuY3pvcwoKICAgICAgICAjIE90aGVyIGFsZ29yaXRobXMgYXJlIGltcGxlbWVudGVkIGJ5IGdkYWwuUmVwcm9qZWN0SW1hZ2UoKS4KICAgICAgICBkc3F1ZXJ5LlNldEdlb1RyYW5zZm9ybSgoMC4wLCB0aWxlc2l6ZSAvIGZsb2F0KHF1ZXJ5c2l6ZSksIDAuMCwgMC4wLCAwLjAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbGVzaXplIC8gZmxvYXQocXVlcnlzaXplKSkpCiAgICAgICAgZHN0aWxlLlNldEdlb1RyYW5zZm9ybSgoMC4wLCAxLjAsIDAuMCwgMC4wLCAwLjAsIDEuMCkpCgogICAgICAgIHJlcyA9IGdkYWwuUmVwcm9qZWN0SW1hZ2UoZHNxdWVyeSwgZHN0aWxlLCBOb25lLCBOb25lLCBnZGFsX3Jlc2FtcGxpbmcpCiAgICAgICAgaWYgcmVzICE9IDA6CiAgICAgICAgICAgIGV4aXRfd2l0aF9lcnJvcigiUmVwcm9qZWN0SW1hZ2UoKSBmYWlsZWQgb24gJXMsIGVycm9yICVkIiAlICh0aWxlZmlsZW5hbWUsIHJlcykpCgoKZGVmIHNldHVwX25vX2RhdGFfdmFsdWVzKGlucHV0X2RhdGFzZXQsIG9wdGlvbnMpOgogICAgIiIiCiAgICBFeHRyYWN0IHRoZSBOT0RBVEEgdmFsdWVzIGZyb20gdGhlIGRhdGFzZXQgb3IgdXNlIHRoZSBwYXNzZWQgYXJndW1lbnRzIGFzIG92ZXJyaWRlIGlmIGFueQogICAgIiIiCiAgICBpbl9ub2RhdGEgPSBbXQogICAgaWYgb3B0aW9ucy5zcmNub2RhdGE6CiAgICAgICAgbmRzID0gbGlzdChtYXAoZmxvYXQsIG9wdGlvbnMuc3Jjbm9kYXRhLnNwbGl0KCcsJykpKQogICAgICAgIGlmIGxlbihuZHMpIDwgaW5wdXRfZGF0YXNldC5SYXN0ZXJDb3VudDoKICAgICAgICAgICAgaW5fbm9kYXRhID0gKG5kcyAqIGlucHV0X2RhdGFzZXQuUmFzdGVyQ291bnQpWzppbnB1dF9kYXRhc2V0LlJhc3RlckNvdW50XQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGluX25vZGF0YSA9IG5kcwogICAgZWxzZToKICAgICAgICBmb3IgaSBpbiByYW5nZSgxLCBpbnB1dF9kYXRhc2V0LlJhc3RlckNvdW50KzEpOgogICAgICAgICAgICByYXN0ZXJfbm9fZGF0YSA9IGlucHV0X2RhdGFzZXQuR2V0UmFzdGVyQmFuZChpKS5HZXROb0RhdGFWYWx1ZSgpCiAgICAgICAgICAgIGlmIHJhc3Rlcl9ub19kYXRhIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgaW5fbm9kYXRhLmFwcGVuZChyYXN0ZXJfbm9fZGF0YSkKCiAgICBpZiBvcHRpb25zLnZlcmJvc2U6CiAgICAgICAgcHJpbnQoIk5PREFUQTogJXMiICUgaW5fbm9kYXRhKQoKICAgIHJldHVybiBpbl9ub2RhdGEKCgpkZWYgc2V0dXBfaW5wdXRfc3JzKGlucHV0X2RhdGFzZXQsIG9wdGlvbnMpOgogICAgIiIiCiAgICBEZXRlcm1pbmVzIGFuZCByZXR1cm5zIHRoZSBJbnB1dCBTcGF0aWFsIFJlZmVyZW5jZSBTeXN0ZW0gKFNSUykgYXMgYW4gb3NyIG9iamVjdCBhbmQgYXMgYQogICAgV0tUIHJlcHJlc2VudGF0aW9uCgogICAgVXNlcyBpbiBwcmlvcml0eSB0aGUgb25lIHBhc3NlZCBpbiB0aGUgY29tbWFuZCBsaW5lIGFyZ3VtZW50cy4gSWYgTm9uZSwgdHJpZXMgdG8gZXh0cmFjdCB0aGVtCiAgICBmcm9tIHRoZSBpbnB1dCBkYXRhc2V0CiAgICAiIiIKCiAgICBpbnB1dF9zcnMgPSBOb25lCiAgICBpbnB1dF9zcnNfd2t0ID0gTm9uZQoKICAgIGlmIG9wdGlvbnMuc19zcnM6CiAgICAgICAgaW5wdXRfc3JzID0gb3NyLlNwYXRpYWxSZWZlcmVuY2UoKQogICAgICAgIGlucHV0X3Nycy5TZXRGcm9tVXNlcklucHV0KG9wdGlvbnMuc19zcnMpCiAgICAgICAgaW5wdXRfc3JzX3drdCA9IGlucHV0X3Nycy5FeHBvcnRUb1drdCgpCiAgICBlbHNlOgogICAgICAgIGlucHV0X3Nyc193a3QgPSBpbnB1dF9kYXRhc2V0LkdldFByb2plY3Rpb24oKQogICAgICAgIGlmIG5vdCBpbnB1dF9zcnNfd2t0IGFuZCBpbnB1dF9kYXRhc2V0LkdldEdDUENvdW50KCkgIT0gMDoKICAgICAgICAgICAgaW5wdXRfc3JzX3drdCA9IGlucHV0X2RhdGFzZXQuR2V0R0NQUHJvamVjdGlvbigpCiAgICAgICAgaWYgaW5wdXRfc3JzX3drdDoKICAgICAgICAgICAgaW5wdXRfc3JzID0gb3NyLlNwYXRpYWxSZWZlcmVuY2UoKQogICAgICAgICAgICBpbnB1dF9zcnMuSW1wb3J0RnJvbVdrdChpbnB1dF9zcnNfd2t0KQoKICAgIHJldHVybiBpbnB1dF9zcnMsIGlucHV0X3Nyc193a3QKCgpkZWYgc2V0dXBfb3V0cHV0X3NycyhpbnB1dF9zcnMsIG9wdGlvbnMpOgogICAgIiIiCiAgICBTZXR1cCB0aGUgZGVzaXJlZCBTUlMgKGJhc2VkIG9uIG9wdGlvbnMpCiAgICAiIiIKICAgIG91dHB1dF9zcnMgPSBvc3IuU3BhdGlhbFJlZmVyZW5jZSgpCgogICAgaWYgb3B0aW9ucy5wcm9maWxlID09ICdtZXJjYXRvcic6CiAgICAgICAgb3V0cHV0X3Nycy5JbXBvcnRGcm9tRVBTRygzODU3KQogICAgZWxpZiBvcHRpb25zLnByb2ZpbGUgPT0gJ2dlb2RldGljJzoKICAgICAgICBvdXRwdXRfc3JzLkltcG9ydEZyb21FUFNHKDQzMjYpCiAgICBlbHNlOgogICAgICAgIG91dHB1dF9zcnMgPSBpbnB1dF9zcnMKCiAgICByZXR1cm4gb3V0cHV0X3NycwoKCmRlZiBoYXNfZ2VvcmVmZXJlbmNlKGRhdGFzZXQpOgogICAgcmV0dXJuIChkYXRhc2V0LkdldEdlb1RyYW5zZm9ybSgpICE9ICgwLjAsIDEuMCwgMC4wLCAwLjAsIDAuMCwgMS4wKSBvcgogICAgICAgICAgICBkYXRhc2V0LkdldEdDUENvdW50KCkgIT0gMCkKCgpkZWYgcmVwcm9qZWN0X2RhdGFzZXQoZnJvbV9kYXRhc2V0LCBmcm9tX3NycywgdG9fc3JzLCBvcHRpb25zPU5vbmUpOgogICAgIiIiCiAgICBSZXR1cm5zIHRoZSBpbnB1dCBkYXRhc2V0IGluIHRoZSBleHBlY3RlZCAiZGVzdGluYXRpb24iIFNSUy4KICAgIElmIHRoZSBkYXRhc2V0IGlzIGFscmVhZHkgaW4gdGhlIGNvcnJlY3QgU1JTLCByZXR1cm5zIGl0IHVubW9kaWZpZWQKICAgICIiIgogICAgaWYgbm90IGZyb21fc3JzIG9yIG5vdCB0b19zcnM6CiAgICAgICAgcmFpc2UgR0RBTEVycm9yKCJmcm9tIGFuZCB0byBTUlMgbXVzdCBiZSBkZWZpbmVkIHRvIHJlcHJvamVjdCB0aGUgZGF0YXNldCIpCgogICAgaWYgKGZyb21fc3JzLkV4cG9ydFRvUHJvajQoKSAhPSB0b19zcnMuRXhwb3J0VG9Qcm9qNCgpKSBvciAoZnJvbV9kYXRhc2V0LkdldEdDUENvdW50KCkgIT0gMCk6CiAgICAgICAgdG9fZGF0YXNldCA9IGdkYWwuQXV0b0NyZWF0ZVdhcnBlZFZSVChmcm9tX2RhdGFzZXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tX3Nycy5FeHBvcnRUb1drdCgpLCB0b19zcnMuRXhwb3J0VG9Xa3QoKSkKCiAgICAgICAgaWYgb3B0aW9ucyBhbmQgb3B0aW9ucy52ZXJib3NlOgogICAgICAgICAgICBwcmludCgiV2FycGluZyBvZiB0aGUgcmFzdGVyIGJ5IEF1dG9DcmVhdGVXYXJwZWRWUlQgKHJlc3VsdCBzYXZlZCBpbnRvICd0aWxlcy52cnQnKSIpCiAgICAgICAgICAgIHRvX2RhdGFzZXQuR2V0RHJpdmVyKCkuQ3JlYXRlQ29weSgidGlsZXMudnJ0IiwgdG9fZGF0YXNldCkKCiAgICAgICAgcmV0dXJuIHRvX2RhdGFzZXQKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIGZyb21fZGF0YXNldAoKCmRlZiBhZGRfZ2RhbF93YXJwX29wdGlvbnNfdG9fc3RyaW5nKHZydF9zdHJpbmcsIHdhcnBfb3B0aW9ucyk6CiAgICBpZiBub3Qgd2FycF9vcHRpb25zOgogICAgICAgIHJldHVybiB2cnRfc3RyaW5nCgogICAgdnJ0X3Jvb3QgPSBFbGVtZW50VHJlZS5mcm9tc3RyaW5nKHZydF9zdHJpbmcpCiAgICBvcHRpb25zID0gdnJ0X3Jvb3QuZmluZCgiR0RBTFdhcnBPcHRpb25zIikKCiAgICBpZiBvcHRpb25zIGlzIE5vbmU6CiAgICAgICAgcmV0dXJuIHZydF9zdHJpbmcKCiAgICBmb3Iga2V5LCB2YWx1ZSBpbiB3YXJwX29wdGlvbnMuaXRlbXMoKToKICAgICAgICB0YiA9IEVsZW1lbnRUcmVlLlRyZWVCdWlsZGVyKCkKICAgICAgICB0Yi5zdGFydCgiT3B0aW9uIiwgeyJuYW1lIjoga2V5fSkKICAgICAgICB0Yi5kYXRhKHZhbHVlKQogICAgICAgIHRiLmVuZCgiT3B0aW9uIikKICAgICAgICBlbGVtID0gdGIuY2xvc2UoKQogICAgICAgIG9wdGlvbnMuaW5zZXJ0KDAsIGVsZW0pCgogICAgcmV0dXJuIEVsZW1lbnRUcmVlLnRvc3RyaW5nKHZydF9yb290KS5kZWNvZGUoKQoKCmRlZiB1cGRhdGVfbm9fZGF0YV92YWx1ZXMod2FycGVkX3ZydF9kYXRhc2V0LCBub2RhdGFfdmFsdWVzLCBvcHRpb25zPU5vbmUpOgogICAgIiIiCiAgICBUYWtlcyBhbiBhcnJheSBvZiBOT0RBVEEgdmFsdWVzIGFuZCBmb3JjZXMgdGhlbSBvbiB0aGUgV2FycGVkVlJUIGZpbGUgZGF0YXNldCBwYXNzZWQKICAgICIiIgogICAgIyBUT0RPOiBnYmF0YWlsbGUgLSBTZWVtcyB0aGF0IEkgZm9yZ290IHRlc3RzIHRoZXJlCiAgICBpZiBub2RhdGFfdmFsdWVzICE9IFtdOgogICAgICAgIHRlbXBfZmlsZSA9IGdldHRlbXBmaWxlbmFtZSgnLWdkYWwydGlsZXMudnJ0JykKICAgICAgICB3YXJwZWRfdnJ0X2RhdGFzZXQuR2V0RHJpdmVyKCkuQ3JlYXRlQ29weSh0ZW1wX2ZpbGUsIHdhcnBlZF92cnRfZGF0YXNldCkKICAgICAgICB3aXRoIG9wZW4odGVtcF9maWxlLCAncicpIGFzIGY6CiAgICAgICAgICAgIHZydF9zdHJpbmcgPSBmLnJlYWQoKQoKICAgICAgICB2cnRfc3RyaW5nID0gYWRkX2dkYWxfd2FycF9vcHRpb25zX3RvX3N0cmluZygKICAgICAgICAgICAgdnJ0X3N0cmluZywgeyJJTklUX0RFU1QiOiAiTk9fREFUQSIsICJVTklGSUVEX1NSQ19OT0RBVEEiOiAiWUVTIn0pCgojIFRPRE86IGdiYXRhaWxsZSAtIGNoZWNrIHRoZSBuZWVkIGZvciB0aGlzIHJlcGxhY2VtZW50LiBTZWVtcyB0byB3b3JrIHdpdGhvdXQKIyAgICAgICAgICMgcmVwbGFjZSBCYW5kTWFwcGluZyB0YWcgZm9yIE5PREFUQSBiYW5kcy4uLi4KIyAgICAgICAgIGZvciBpIGluIHJhbmdlKGxlbihub2RhdGFfdmFsdWVzKSk6CiMgICAgICAgICAgICAgcyA9IHMucmVwbGFjZSgKIyAgICAgICAgICAgICAgICAgJzxCYW5kTWFwcGluZyBzcmM9IiVpIiBkc3Q9IiVpIi8+JyAlICgoaSsxKSwgKGkrMSkpLAojICAgICAgICAgICAgICAgICAiIiIKIyA8QmFuZE1hcHBpbmcgc3JjPSIlaSIgZHN0PSIlaSI+CiMgPFNyY05vRGF0YVJlYWw+JWk8L1NyY05vRGF0YVJlYWw+CiMgPFNyY05vRGF0YUltYWc+MDwvU3JjTm9EYXRhSW1hZz4KIyA8RHN0Tm9EYXRhUmVhbD4laTwvRHN0Tm9EYXRhUmVhbD4KIyA8RHN0Tm9EYXRhSW1hZz4wPC9Ec3ROb0RhdGFJbWFnPgojIDwvQmFuZE1hcHBpbmc+CiMgICAgICAgICAgICAgICAgICIiIiAlICgoaSsxKSwgKGkrMSksIG5vZGF0YV92YWx1ZXNbaV0sIG5vZGF0YV92YWx1ZXNbaV0pKQoKICAgICAgICAjIHNhdmUgdGhlIGNvcnJlY3RlZCBWUlQKICAgICAgICB3aXRoIG9wZW4odGVtcF9maWxlLCAndycpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUodnJ0X3N0cmluZykKCiAgICAgICAgY29ycmVjdGVkX2RhdGFzZXQgPSBnZGFsLk9wZW4odGVtcF9maWxlKQogICAgICAgIG9zLnVubGluayh0ZW1wX2ZpbGUpCgogICAgICAgICMgc2V0IE5PREFUQV9WQUxVRSBtZXRhZGF0YQogICAgICAgIGNvcnJlY3RlZF9kYXRhc2V0LlNldE1ldGFkYXRhSXRlbSgKICAgICAgICAgICAgJ05PREFUQV9WQUxVRVMnLCAnICcuam9pbihbc3RyKGkpIGZvciBpIGluIG5vZGF0YV92YWx1ZXNdKSkKCiAgICAgICAgaWYgb3B0aW9ucyBhbmQgb3B0aW9ucy52ZXJib3NlOgogICAgICAgICAgICBwcmludCgiTW9kaWZpZWQgd2FycGluZyByZXN1bHQgc2F2ZWQgaW50byAndGlsZXMxLnZydCciKQogICAgICAgICAgICAjIFRPRE86IGdiYXRhaWxsZSAtIHRlc3QgcmVwbGFjaW5nIHRoYXQgd2l0aCBhIGdkYWwgd3JpdGUgb2YgdGhlIGRhdGFzZXQgKG1vcmUKICAgICAgICAgICAgIyBhY2N1cmF0ZWx5IHdoYXQncyB1c2VkLCBldmVuIGlmIHNob3VsZCBiZSB0aGUgc2FtZQogICAgICAgICAgICB3aXRoIG9wZW4oInRpbGVzMS52cnQiLCAidyIpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlKHZydF9zdHJpbmcpCgogICAgICAgIHJldHVybiBjb3JyZWN0ZWRfZGF0YXNldAoKCmRlZiBhZGRfYWxwaGFfYmFuZF90b19zdHJpbmdfdnJ0KHZydF9zdHJpbmcpOgogICAgIyBUT0RPOiBnYmF0YWlsbGUgLSBPbGQgY29kZSBzcGVhayBvZiB0aGlzIGJlaW5nIGVxdWl2YWxlbnQgdG8gZ2RhbHdhcnAgLWRzdGFscGhhCiAgICAjIFRvIGJlIGNoZWNrZWQKCiAgICB2cnRfcm9vdCA9IEVsZW1lbnRUcmVlLmZyb21zdHJpbmcodnJ0X3N0cmluZykKCiAgICBpbmRleCA9IDAKICAgIG5iX2JhbmRzID0gMAogICAgZm9yIHN1YmVsZW0gaW4gbGlzdCh2cnRfcm9vdCk6CiAgICAgICAgaWYgc3ViZWxlbS50YWcgPT0gIlZSVFJhc3RlckJhbmQiOgogICAgICAgICAgICBuYl9iYW5kcyArPSAxCiAgICAgICAgICAgIGNvbG9yX25vZGUgPSBzdWJlbGVtLmZpbmQoIi4vQ29sb3JJbnRlcnAiKQogICAgICAgICAgICBpZiBjb2xvcl9ub2RlIGlzIG5vdCBOb25lIGFuZCBjb2xvcl9ub2RlLnRleHQgPT0gIkFscGhhIjoKICAgICAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiQWxwaGEgYmFuZCBhbHJlYWR5IHByZXNlbnQiKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIG5iX2JhbmRzOgogICAgICAgICAgICAgICAgIyBUaGlzIG1lYW5zIHRoYXQgd2UgYXJlIG9uZSBlbGVtZW50IGFmdGVyIHRoZSBCYW5kIGRlZmluaXRpb25zCiAgICAgICAgICAgICAgICBicmVhawoKICAgICAgICBpbmRleCArPSAxCgogICAgdGIgPSBFbGVtZW50VHJlZS5UcmVlQnVpbGRlcigpCiAgICB0Yi5zdGFydCgiVlJUUmFzdGVyQmFuZCIsCiAgICAgICAgICAgICB7J2RhdGFUeXBlJzogIkJ5dGUiLCAiYmFuZCI6IHN0cihuYl9iYW5kcyArIDEpLCAic3ViQ2xhc3MiOiAiVlJUV2FycGVkUmFzdGVyQmFuZCJ9KQogICAgdGIuc3RhcnQoIkNvbG9ySW50ZXJwIiwge30pCiAgICB0Yi5kYXRhKCJBbHBoYSIpCiAgICB0Yi5lbmQoIkNvbG9ySW50ZXJwIikKICAgIHRiLmVuZCgiVlJUUmFzdGVyQmFuZCIpCiAgICBlbGVtID0gdGIuY2xvc2UoKQoKICAgIHZydF9yb290Lmluc2VydChpbmRleCwgZWxlbSkKCiAgICB3YXJwX29wdGlvbnMgPSB2cnRfcm9vdC5maW5kKCIuLy9HREFMV2FycE9wdGlvbnMiKQogICAgdGIgPSBFbGVtZW50VHJlZS5UcmVlQnVpbGRlcigpCiAgICB0Yi5zdGFydCgiRHN0QWxwaGFCYW5kIiwge30pCiAgICB0Yi5kYXRhKHN0cihuYl9iYW5kcyArIDEpKQogICAgdGIuZW5kKCJEc3RBbHBoYUJhbmQiKQogICAgZWxlbSA9IHRiLmNsb3NlKCkKICAgIHdhcnBfb3B0aW9ucy5hcHBlbmQoZWxlbSkKCiAgICAjIFRPRE86IGdiYXRhaWxsZSAtIHRoaXMgaXMgYSBHREFMV2FycE9wdGlvbnMuIFdoeSBwdXQgaXQgaW4gYSBzcGVjaWZpYyBwbGFjZT8KICAgIHRiID0gRWxlbWVudFRyZWUuVHJlZUJ1aWxkZXIoKQogICAgdGIuc3RhcnQoIk9wdGlvbiIsIHsibmFtZSI6ICJJTklUX0RFU1QifSkKICAgIHRiLmRhdGEoIjAiKQogICAgdGIuZW5kKCJPcHRpb24iKQogICAgZWxlbSA9IHRiLmNsb3NlKCkKICAgIHdhcnBfb3B0aW9ucy5hcHBlbmQoZWxlbSkKCiAgICByZXR1cm4gRWxlbWVudFRyZWUudG9zdHJpbmcodnJ0X3Jvb3QpLmRlY29kZSgpCgoKZGVmIHVwZGF0ZV9hbHBoYV92YWx1ZV9mb3Jfbm9uX2FscGhhX2lucHV0cyh3YXJwZWRfdnJ0X2RhdGFzZXQsIG9wdGlvbnM9Tm9uZSk6CiAgICAiIiIKICAgIEhhbmRsZXMgZGF0YXNldCB3aXRoIDEgb3IgMyBiYW5kcywgaS5lLiB3aXRob3V0IGFscGhhIGNoYW5uZWwsIGluIHRoZSBjYXNlIHRoZSBub2RhdGEgdmFsdWUgaGFzCiAgICBub3QgYmVlbiBmb3JjZWQgYnkgb3B0aW9ucwogICAgIiIiCiAgICBpZiB3YXJwZWRfdnJ0X2RhdGFzZXQuUmFzdGVyQ291bnQgaW4gWzEsIDNdOgogICAgICAgIHRlbXBmaWxlbmFtZSA9IGdldHRlbXBmaWxlbmFtZSgnLWdkYWwydGlsZXMudnJ0JykKICAgICAgICB3YXJwZWRfdnJ0X2RhdGFzZXQuR2V0RHJpdmVyKCkuQ3JlYXRlQ29weSh0ZW1wZmlsZW5hbWUsIHdhcnBlZF92cnRfZGF0YXNldCkKICAgICAgICB3aXRoIG9wZW4odGVtcGZpbGVuYW1lKSBhcyBmOgogICAgICAgICAgICBvcmlnX2RhdGEgPSBmLnJlYWQoKQogICAgICAgIGFscGhhX2RhdGEgPSBhZGRfYWxwaGFfYmFuZF90b19zdHJpbmdfdnJ0KG9yaWdfZGF0YSkKICAgICAgICB3aXRoIG9wZW4odGVtcGZpbGVuYW1lLCAndycpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoYWxwaGFfZGF0YSkKCiAgICAgICAgd2FycGVkX3ZydF9kYXRhc2V0ID0gZ2RhbC5PcGVuKHRlbXBmaWxlbmFtZSkKICAgICAgICBvcy51bmxpbmsodGVtcGZpbGVuYW1lKQoKICAgICAgICBpZiBvcHRpb25zIGFuZCBvcHRpb25zLnZlcmJvc2U6CiAgICAgICAgICAgIHByaW50KCJNb2RpZmllZCAtZHN0YWxwaGEgd2FycGluZyByZXN1bHQgc2F2ZWQgaW50byAndGlsZXMxLnZydCciKQogICAgICAgICAgICAjIFRPRE86IGdiYXRhaWxsZSAtIHRlc3QgcmVwbGFjaW5nIHRoYXQgd2l0aCBhIGdkYWwgd3JpdGUgb2YgdGhlIGRhdGFzZXQgKG1vcmUKICAgICAgICAgICAgIyBhY2N1cmF0ZWx5IHdoYXQncyB1c2VkLCBldmVuIGlmIHNob3VsZCBiZSB0aGUgc2FtZQogICAgICAgICAgICB3aXRoIG9wZW4oInRpbGVzMS52cnQiLCAidyIpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlKGFscGhhX2RhdGEpCgogICAgcmV0dXJuIHdhcnBlZF92cnRfZGF0YXNldAoKCmRlZiBuYl9kYXRhX2JhbmRzKGRhdGFzZXQpOgogICAgIiIiCiAgICBSZXR1cm4gdGhlIG51bWJlciBvZiBkYXRhIChub24tYWxwaGEpIGJhbmRzIG9mIGEgZ2RhbCBkYXRhc2V0CiAgICAiIiIKICAgIGFscGhhYmFuZCA9IGRhdGFzZXQuR2V0UmFzdGVyQmFuZCgxKS5HZXRNYXNrQmFuZCgpCiAgICBpZiAoKGFscGhhYmFuZC5HZXRNYXNrRmxhZ3MoKSAmIGdkYWwuR01GX0FMUEhBKSBvcgogICAgICAgICAgICBkYXRhc2V0LlJhc3RlckNvdW50ID09IDQgb3IKICAgICAgICAgICAgZGF0YXNldC5SYXN0ZXJDb3VudCA9PSAyKToKICAgICAgICByZXR1cm4gZGF0YXNldC5SYXN0ZXJDb3VudCAtIDEKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuIGRhdGFzZXQuUmFzdGVyQ291bnQKCgpkZWYgZ2V0dGVtcGZpbGVuYW1lKHN1ZmZpeCk6CiAgICAiIiJSZXR1cm5zIGEgdGVtcG9yYXJ5IGZpbGVuYW1lIiIiCiAgICBpZiAnXycgaW4gb3MuZW52aXJvbjoKICAgICAgICAjIHRlbXBmaWxlLm1rdGVtcCgpIGNyYXNoZXMgb24gc29tZSBXaW5lIHZlcnNpb25zICh0aGUgb25lIG9mIFVidW50dSAxMi4wNCBwYXJ0aWN1bGFybHkpCiAgICAgICAgaWYgb3MuZW52aXJvblsnXyddLmZpbmQoJ3dpbmUnKSA+PSAwOgogICAgICAgICAgICB0bXBkaXIgPSAnLicKICAgICAgICAgICAgaWYgJ1RNUCcgaW4gb3MuZW52aXJvbjoKICAgICAgICAgICAgICAgIHRtcGRpciA9IG9zLmVudmlyb25bJ1RNUCddCiAgICAgICAgICAgIGltcG9ydCB0aW1lCiAgICAgICAgICAgIGltcG9ydCByYW5kb20KICAgICAgICAgICAgcmFuZG9tLnNlZWQodGltZS50aW1lKCkpCiAgICAgICAgICAgIHJhbmRvbV9wYXJ0ID0gJ2ZpbGUlZCcgJSByYW5kb20ucmFuZGludCgwLCAxMDAwMDAwMDAwKQogICAgICAgICAgICByZXR1cm4gb3MucGF0aC5qb2luKHRtcGRpciwgcmFuZG9tX3BhcnQgKyBzdWZmaXgpCgogICAgcmV0dXJuIHRlbXBmaWxlLm1rdGVtcChzdWZmaXgpCgoKZGVmIGNyZWF0ZV9iYXNlX3RpbGUodGlsZV9qb2JfaW5mbywgdGlsZV9kZXRhaWwsIG9wdGlvbnMsIHF1ZXVlPU5vbmUpOgogICAgZ2RhbC5BbGxSZWdpc3RlcigpCgogICAgZGF0YUJhbmRzQ291bnQgPSB0aWxlX2pvYl9pbmZvLm5iX2RhdGFfYmFuZHMKICAgIG91dHB1dCA9IHRpbGVfam9iX2luZm8ub3V0cHV0X2ZpbGVfcGF0aAogICAgdGlsZWV4dCA9IHRpbGVfam9iX2luZm8udGlsZV9leHRlbnNpb24KICAgIHRpbGVzaXplID0gdGlsZV9qb2JfaW5mby50aWxlX3NpemUKICAgIG9wdGlvbnMgPSB0aWxlX2pvYl9pbmZvLm9wdGlvbnMKCiAgICB0aWxlYmFuZHMgPSBkYXRhQmFuZHNDb3VudCArIDEKICAgIGRzID0gZ2RhbC5PcGVuKHRpbGVfam9iX2luZm8uc3JjX2ZpbGUsIGdkYWwuR0FfUmVhZE9ubHkpCiAgICBtZW1fZHJ2ID0gZ2RhbC5HZXREcml2ZXJCeU5hbWUoJ01FTScpCiAgICBvdXRfZHJ2ID0gZ2RhbC5HZXREcml2ZXJCeU5hbWUodGlsZV9qb2JfaW5mby50aWxlX2RyaXZlcikKICAgIGFscGhhYmFuZCA9IGRzLkdldFJhc3RlckJhbmQoMSkuR2V0TWFza0JhbmQoKQoKICAgIHR4ID0gdGlsZV9kZXRhaWwudHgKICAgIHR5ID0gdGlsZV9kZXRhaWwudHkKICAgIHR6ID0gdGlsZV9kZXRhaWwudHoKICAgIHJ4ID0gdGlsZV9kZXRhaWwucngKICAgIHJ5ID0gdGlsZV9kZXRhaWwucnkKICAgIHJ4c2l6ZSA9IHRpbGVfZGV0YWlsLnJ4c2l6ZQogICAgcnlzaXplID0gdGlsZV9kZXRhaWwucnlzaXplCiAgICB3eCA9IHRpbGVfZGV0YWlsLnd4CiAgICB3eSA9IHRpbGVfZGV0YWlsLnd5CiAgICB3eHNpemUgPSB0aWxlX2RldGFpbC53eHNpemUKICAgIHd5c2l6ZSA9IHRpbGVfZGV0YWlsLnd5c2l6ZQogICAgcXVlcnlzaXplID0gdGlsZV9kZXRhaWwucXVlcnlzaXplCgogICAgIyBUaWxlIGRhdGFzZXQgaW4gbWVtb3J5CiAgICB0aWxlZmlsZW5hbWUgPSBvcy5wYXRoLmpvaW4oCiAgICAgICAgb3V0cHV0LCBzdHIodHopLCAnezA6MDRkfScuZm9ybWF0KHR4KSArICJfIiArICd7MDowNGR9Jy5mb3JtYXQodHkpICsgIi4iICsgdGlsZWV4dCkKICAgIGRzdGlsZSA9IG1lbV9kcnYuQ3JlYXRlKCcnLCB0aWxlc2l6ZSwgdGlsZXNpemUsIHRpbGViYW5kcykKCiAgICBkYXRhID0gYWxwaGEgPSBOb25lCgogICAgaWYgb3B0aW9ucy52ZXJib3NlOgogICAgICAgIHByaW50KCJcdFJlYWRSYXN0ZXIgRXh0ZW50OiAiLAogICAgICAgICAgICAgIChyeCwgcnksIHJ4c2l6ZSwgcnlzaXplKSwgKHd4LCB3eSwgd3hzaXplLCB3eXNpemUpKQoKICAgICMgUXVlcnkgaXMgaW4gJ25lYXJlc3QgbmVpZ2hib3VyJyBidXQgY2FuIGJlIGJpZ2dlciBpbiB0aGVuIHRoZSB0aWxlc2l6ZQogICAgIyBXZSBzY2FsZSBkb3duIHRoZSBxdWVyeSB0byB0aGUgdGlsZXNpemUgYnkgc3VwcGxpZWQgYWxnb3JpdGhtLgoKICAgIGlmIHJ4c2l6ZSAhPSAwIGFuZCByeXNpemUgIT0gMCBhbmQgd3hzaXplICE9IDAgYW5kIHd5c2l6ZSAhPSAwOgogICAgICAgIGRhdGEgPSBkcy5SZWFkUmFzdGVyKHJ4LCByeSwgcnhzaXplLCByeXNpemUsIHd4c2l6ZSwgd3lzaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhbmRfbGlzdD1saXN0KHJhbmdlKDEsIGRhdGFCYW5kc0NvdW50KzEpKSkKICAgICAgICBhbHBoYSA9IGFscGhhYmFuZC5SZWFkUmFzdGVyKHJ4LCByeSwgcnhzaXplLCByeXNpemUsIHd4c2l6ZSwgd3lzaXplKQoKICAgICMgVGhlIHRpbGUgaW4gbWVtb3J5IGlzIGEgdHJhbnNwYXJlbnQgZmlsZSBieSBkZWZhdWx0LiBXcml0ZSBwaXhlbCB2YWx1ZXMgaW50byBpdCBpZgogICAgIyBhbnkKICAgIGlmIGRhdGE6CiAgICAgICAgaWYgdGlsZXNpemUgPT0gcXVlcnlzaXplOgogICAgICAgICAgICAjIFVzZSB0aGUgUmVhZFJhc3RlciByZXN1bHQgZGlyZWN0bHkgaW4gdGlsZXMgKCduZWFyZXN0IG5laWdoYm91cicgcXVlcnkpCiAgICAgICAgICAgIGRzdGlsZS5Xcml0ZVJhc3Rlcih3eCwgd3ksIHd4c2l6ZSwgd3lzaXplLCBkYXRhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFuZF9saXN0PWxpc3QocmFuZ2UoMSwgZGF0YUJhbmRzQ291bnQrMSkpKQogICAgICAgICAgICBkc3RpbGUuV3JpdGVSYXN0ZXIod3gsIHd5LCB3eHNpemUsIHd5c2l6ZSwgYWxwaGEsIGJhbmRfbGlzdD1bdGlsZWJhbmRzXSkKCiAgICAgICAgICAgICMgTm90ZTogRm9yIHNvdXJjZSBkcml2ZXJzIGJhc2VkIG9uIFdhdmVMZXQgY29tcHJlc3Npb24gKEpQRUcyMDAwLCBFQ1csCiAgICAgICAgICAgICMgTXJTSUQpIHRoZSBSZWFkUmFzdGVyIGZ1bmN0aW9uIHJldHVybnMgaGlnaC1xdWFsaXR5IHJhc3RlciAobm90IHVnbHkKICAgICAgICAgICAgIyBuZWFyZXN0IG5laWdoYm91cikKICAgICAgICAgICAgIyBUT0RPOiBVc2UgZGlyZWN0bHkgJ25lYXInIGZvciBXYXZlTGV0IGZpbGVzCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBCaWcgUmVhZFJhc3RlciBxdWVyeSBpbiBtZW1vcnkgc2NhbGVkIHRvIHRoZSB0aWxlc2l6ZSAtIGFsbCBidXQgJ25lYXInCiAgICAgICAgICAgICMgYWxnbwogICAgICAgICAgICBkc3F1ZXJ5ID0gbWVtX2Rydi5DcmVhdGUoJycsIHF1ZXJ5c2l6ZSwgcXVlcnlzaXplLCB0aWxlYmFuZHMpCiAgICAgICAgICAgICMgVE9ETzogZmlsbCB0aGUgbnVsbCB2YWx1ZSBpbiBjYXNlIGEgdGlsZSB3aXRob3V0IGFscGhhIGlzIHByb2R1Y2VkIChub3cKICAgICAgICAgICAgIyBvbmx5IHBuZyB0aWxlcyBhcmUgc3VwcG9ydGVkKQogICAgICAgICAgICBkc3F1ZXJ5LldyaXRlUmFzdGVyKHd4LCB3eSwgd3hzaXplLCB3eXNpemUsIGRhdGEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFuZF9saXN0PWxpc3QocmFuZ2UoMSwgZGF0YUJhbmRzQ291bnQrMSkpKQogICAgICAgICAgICBkc3F1ZXJ5LldyaXRlUmFzdGVyKHd4LCB3eSwgd3hzaXplLCB3eXNpemUsIGFscGhhLCBiYW5kX2xpc3Q9W3RpbGViYW5kc10pCgogICAgICAgICAgICBzY2FsZV9xdWVyeV90b190aWxlKGRzcXVlcnksIGRzdGlsZSwgdGlsZV9qb2JfaW5mby50aWxlX2RyaXZlciwgb3B0aW9ucywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aWxlZmlsZW5hbWU9dGlsZWZpbGVuYW1lKQogICAgICAgICAgICBkZWwgZHNxdWVyeQoKICAgICMgRm9yY2UgZnJlZWluZyB0aGUgbWVtb3J5IHRvIG1ha2Ugc3VyZSB0aGUgQysrIGRlc3RydWN0b3IgaXMgY2FsbGVkIGFuZCB0aGUgbWVtb3J5IGFzIHdlbGwgYXMKICAgICMgdGhlIGZpbGUgbG9ja3MgYXJlIHJlbGVhc2VkCiAgICBkZWwgZHMKICAgIGRlbCBkYXRhCgogICAgaWYgb3B0aW9ucy5yZXNhbXBsaW5nICE9ICdhbnRpYWxpYXMnOgogICAgICAgICMgV3JpdGUgYSBjb3B5IG9mIHRpbGUgdG8gcG5nL2pwZwogICAgICAgIG91dF9kcnYuQ3JlYXRlQ29weSh0aWxlZmlsZW5hbWUsIGRzdGlsZSwgc3RyaWN0PTApCgogICAgZGVsIGRzdGlsZQoKICAgIG9wdGlvbnMuZ2VuZXJhdGVkRmlsZXMuYXBwZW5kKHRpbGVmaWxlbmFtZSkKICAgICMgYXBwbHlMZWdlbmQodGlsZWZpbGVuYW1lLCBvcHRpb25zLmxlZ2VuZE9iaikKCiAgICAjICMgQ3JlYXRlIGEgS01MIGZpbGUgZm9yIHRoaXMgdGlsZS4KICAgICMgaWYgdGlsZV9qb2JfaW5mby5rbWw6CiAgICAjICAgICBrbWxmaWxlbmFtZSA9IG9zLnBhdGguam9pbihvdXRwdXQsIHN0cih0eiksIHN0cih0eCksICclZC5rbWwnICUgdHkpCiAgICAjICAgICBpZiBub3Qgb3B0aW9ucy5yZXN1bWUgb3Igbm90IG9zLnBhdGguZXhpc3RzKGttbGZpbGVuYW1lKToKICAgICMgICAgICAgICB3aXRoIG9wZW4oa21sZmlsZW5hbWUsICd3YicpIGFzIGY6CiAgICAjICAgICAgICAgICAgIGYud3JpdGUoZ2VuZXJhdGVfa21sKAogICAgIyAgICAgICAgICAgICAgICAgdHgsIHR5LCB0eiwgdGlsZV9qb2JfaW5mby50aWxlX2V4dGVuc2lvbiwgdGlsZV9qb2JfaW5mby50aWxlX3NpemUsCiAgICAjICAgICAgICAgICAgICAgICB0aWxlX2pvYl9pbmZvLnRpbGVfc3duZSwgdGlsZV9qb2JfaW5mby5vcHRpb25zCiAgICAjICAgICAgICAgICAgICkuZW5jb2RlKCd1dGYtOCcpKQoKICAgIGlmIHF1ZXVlOgogICAgICAgIHF1ZXVlLnB1dCgidGlsZSAlcyAlcyAlcyIgJSAodHgsIHR5LCB0eikpCgoKZGVmIGNyZWF0ZV9vdmVydmlld190aWxlcyh0aWxlX2pvYl9pbmZvLCBvdXRwdXRfZm9sZGVyLCBvcHRpb25zKToKICAgICIiIkdlbmVyYXRpb24gb2YgdGhlIG92ZXJ2aWV3IHRpbGVzIChoaWdoZXIgaW4gdGhlIHB5cmFtaWQpIGJhc2VkIG9uIGV4aXN0aW5nIHRpbGVzIiIiCiAgICBtZW1fZHJpdmVyID0gZ2RhbC5HZXREcml2ZXJCeU5hbWUoJ01FTScpCiAgICB0aWxlX2RyaXZlciA9IHRpbGVfam9iX2luZm8udGlsZV9kcml2ZXIKICAgIG91dF9kcml2ZXIgPSBnZGFsLkdldERyaXZlckJ5TmFtZSh0aWxlX2RyaXZlcikKCiAgICB0aWxlYmFuZHMgPSB0aWxlX2pvYl9pbmZvLm5iX2RhdGFfYmFuZHMgKyAxCgogICAgIyBVc2FnZSBvZiBleGlzdGluZyB0aWxlczogZnJvbSA0IHVuZGVybHlpbmcgdGlsZXMgZ2VuZXJhdGUgb25lIGFzIG92ZXJ2aWV3LgoKICAgIHRjb3VudCA9IDAKICAgIGZvciB0eiBpbiByYW5nZSh0aWxlX2pvYl9pbmZvLnRtYXh6IC0gMSwgdGlsZV9qb2JfaW5mby50bWlueiAtIDEsIC0xKToKICAgICAgICB0bWlueCwgdG1pbnksIHRtYXh4LCB0bWF4eSA9IHRpbGVfam9iX2luZm8udG1pbm1heFt0el0KICAgICAgICB0Y291bnQgKz0gKDEgKyBhYnModG1heHgtdG1pbngpKSAqICgxICsgYWJzKHRtYXh5LXRtaW55KSkKCiAgICB0aSA9IDAKCiAgICBpZiB0Y291bnQgPT0gMDoKICAgICAgICByZXR1cm4KCiAgICBpZiBub3Qgb3B0aW9ucy5xdWlldDoKICAgICAgICBwcmludCgiR2VuZXJhdGluZyBPdmVydmlldyBUaWxlczoiKQoKICAgIHByb2dyZXNzX2JhciA9IFByb2dyZXNzQmFyKHRjb3VudCkKICAgIHByb2dyZXNzX2Jhci5zdGFydCgpCgogICAgZm9yIHR6IGluIHJhbmdlKHRpbGVfam9iX2luZm8udG1heHogLSAxLCB0aWxlX2pvYl9pbmZvLnRtaW56IC0gMSwgLTEpOgogICAgICAgIHRtaW54LCB0bWlueSwgdG1heHgsIHRtYXh5ID0gdGlsZV9qb2JfaW5mby50bWlubWF4W3R6XQogICAgICAgIGZvciB0eSBpbiByYW5nZSh0bWF4eSwgdG1pbnkgLSAxLCAtMSk6CiAgICAgICAgICAgIGZvciB0eCBpbiByYW5nZSh0bWlueCwgdG1heHggKyAxKToKCiAgICAgICAgICAgICAgICB0aSArPSAxCiAgICAgICAgICAgICAgICB5dGlsZSA9IEdEQUwyVGlsZXMuZ2V0WXRpbGUodHksIHR6LCBvcHRpb25zKQogICAgICAgICAgICAgICAgdGlsZWZpbGVuYW1lID0gb3MucGF0aC5qb2luKG91dHB1dF9mb2xkZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyKHR6KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjc3RyKHR4KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIiVzLiVzIiAlICh5dGlsZSwgdGlsZV9qb2JfaW5mby50aWxlX2V4dGVuc2lvbikpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3swOjA0ZH0nLmZvcm1hdCh0eCkgKyAiXyIgKyAnezA6MDRkfScuZm9ybWF0KHl0aWxlKSArICIuIiArIHRpbGVfam9iX2luZm8udGlsZV9leHRlbnNpb24pCgogICAgICAgICAgICAgICAgaWYgb3B0aW9ucy52ZXJib3NlOgogICAgICAgICAgICAgICAgICAgIHByaW50KHRpLCAnLycsIHRjb3VudCwgdGlsZWZpbGVuYW1lKQoKICAgICAgICAgICAgICAgIGlmIG9wdGlvbnMucmVzdW1lIGFuZCBvcy5wYXRoLmV4aXN0cyh0aWxlZmlsZW5hbWUpOgogICAgICAgICAgICAgICAgICAgIGlmIG9wdGlvbnMudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQoIlRpbGUgZ2VuZXJhdGlvbiBza2lwcGVkIGJlY2F1c2Ugb2YgLS1yZXN1bWUiKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzX2Jhci5sb2dfcHJvZ3Jlc3MoKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgIyBDcmVhdGUgZGlyZWN0b3JpZXMgZm9yIHRoZSB0aWxlCiAgICAgICAgICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMob3MucGF0aC5kaXJuYW1lKHRpbGVmaWxlbmFtZSkpOgogICAgICAgICAgICAgICAgICAgIG9zLm1ha2VkaXJzKG9zLnBhdGguZGlybmFtZSh0aWxlZmlsZW5hbWUpKQoKICAgICAgICAgICAgICAgIGRzcXVlcnkgPSBtZW1fZHJpdmVyLkNyZWF0ZSgnJywgMiAqIHRpbGVfam9iX2luZm8udGlsZV9zaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDIgKiB0aWxlX2pvYl9pbmZvLnRpbGVfc2l6ZSwgdGlsZWJhbmRzKQogICAgICAgICAgICAgICAgIyBUT0RPOiBmaWxsIHRoZSBudWxsIHZhbHVlCiAgICAgICAgICAgICAgICBkc3RpbGUgPSBtZW1fZHJpdmVyLkNyZWF0ZSgnJywgdGlsZV9qb2JfaW5mby50aWxlX3NpemUsIHRpbGVfam9iX2luZm8udGlsZV9zaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGlsZWJhbmRzKQoKICAgICAgICAgICAgICAgICMgVE9ETzogSW1wbGVtZW50IG1vcmUgY2xldmVyIHdhbGtpbmcgb24gdGhlIHRpbGVzIHdpdGggY2FjaGUgZnVuY3Rpb25hbGl0eQogICAgICAgICAgICAgICAgIyBwcm9iYWJseSB3YWxrIHNob3VsZCBzdGFydCB3aXRoIHJlYWRpbmcgb2YgZm91ciB0aWxlcyBmcm9tIHRvcCBsZWZ0IGNvcm5lcgogICAgICAgICAgICAgICAgIyBIaWxiZXJ0IGN1cnZlCgogICAgICAgICAgICAgICAgY2hpbGRyZW4gPSBbXQogICAgICAgICAgICAgICAgIyBSZWFkIHRoZSB0aWxlcyBhbmQgd3JpdGUgdGhlbSB0byBxdWVyeSB3aW5kb3cKICAgICAgICAgICAgICAgIGZvciB5IGluIHJhbmdlKDIgKiB0eSwgMiAqIHR5ICsgMik6CiAgICAgICAgICAgICAgICAgICAgZm9yIHggaW4gcmFuZ2UoMiAqIHR4LCAyICogdHggKyAyKToKICAgICAgICAgICAgICAgICAgICAgICAgbWlueCwgbWlueSwgbWF4eCwgbWF4eSA9IHRpbGVfam9iX2luZm8udG1pbm1heFt0eiArIDFdCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHggPj0gbWlueCBhbmQgeCA8PSBtYXh4IGFuZCB5ID49IG1pbnkgYW5kIHkgPD0gbWF4eToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHl0aWxlMiA9IEdEQUwyVGlsZXMuZ2V0WXRpbGUoeSwgdHorMSwgb3B0aW9ucykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRzcXVlcnl0aWxlID0gZ2RhbC5PcGVuKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9zLnBhdGguam9pbihvdXRwdXRfZm9sZGVyLCBzdHIodHogKyAxKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3swOjA0ZH0nLmZvcm1hdCh4KSArICJfIiArICd7MDowNGR9Jy5mb3JtYXQoeXRpbGUyKSArICIuIiArIHRpbGVfam9iX2luZm8udGlsZV9leHRlbnNpb24pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjc3RyKHgpLCAiJXMuJXMiICUgKHl0aWxlMiwgdGlsZV9qb2JfaW5mby50aWxlX2V4dGVuc2lvbikpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdkYWwuR0FfUmVhZE9ubHkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHkgPT0gMCBhbmQgeSA9PSAxKSBvciAodHkgIT0gMCBhbmQgKHkgJSAoMiAqIHR5KSkgIT0gMCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGlsZXBvc3kgPSAwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbGVwb3N5ID0gdGlsZV9qb2JfaW5mby50aWxlX3NpemUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHR4OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbGVwb3N4ID0geCAlICgyICogdHgpICogdGlsZV9qb2JfaW5mby50aWxlX3NpemUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsaWYgdHggPT0gMCBhbmQgeCA9PSAxOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbGVwb3N4ID0gdGlsZV9qb2JfaW5mby50aWxlX3NpemUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGlsZXBvc3ggPSAwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkc3F1ZXJ5LldyaXRlUmFzdGVyKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbGVwb3N4LCB0aWxlcG9zeSwgdGlsZV9qb2JfaW5mby50aWxlX3NpemUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGlsZV9qb2JfaW5mby50aWxlX3NpemUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHNxdWVyeXRpbGUuUmVhZFJhc3RlcigwLCAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGlsZV9qb2JfaW5mby50aWxlX3NpemUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aWxlX2pvYl9pbmZvLnRpbGVfc2l6ZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFuZF9saXN0PWxpc3QocmFuZ2UoMSwgdGlsZWJhbmRzICsgMSkpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW4uYXBwZW5kKFt4LCB5LCB0eiArIDFdKQoKICAgICAgICAgICAgICAgIHNjYWxlX3F1ZXJ5X3RvX3RpbGUoZHNxdWVyeSwgZHN0aWxlLCB0aWxlX2RyaXZlciwgb3B0aW9ucywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGlsZWZpbGVuYW1lPXRpbGVmaWxlbmFtZSkKICAgICAgICAgICAgICAgICMgV3JpdGUgYSBjb3B5IG9mIHRpbGUgdG8gcG5nL2pwZwogICAgICAgICAgICAgICAgaWYgb3B0aW9ucy5yZXNhbXBsaW5nICE9ICdhbnRpYWxpYXMnOgogICAgICAgICAgICAgICAgICAgICMgV3JpdGUgYSBjb3B5IG9mIHRpbGUgdG8gcG5nL2pwZwogICAgICAgICAgICAgICAgICAgIG91dF9kcml2ZXIuQ3JlYXRlQ29weSh0aWxlZmlsZW5hbWUsIGRzdGlsZSwgc3RyaWN0PTApCgogICAgICAgICAgICAgICAgZGVsIGRzdGlsZQoKICAgICAgICAgICAgICAgIG9wdGlvbnMuZ2VuZXJhdGVkRmlsZXMuYXBwZW5kKHRpbGVmaWxlbmFtZSkKICAgICAgICAgICAgICAgICMgYXBwbHlMZWdlbmQodGlsZWZpbGVuYW1lLCBvcHRpb25zLmxlZ2VuZE9iaikKCiAgICAgICAgICAgICAgICBpZiBvcHRpb25zLnZlcmJvc2U6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQoIlx0YnVpbGQgZnJvbSB6b29tIiwgdHogKyAxLAogICAgICAgICAgICAgICAgICAgICAgICAgICIgdGlsZXM6IiwgKDIgKiB0eCwgMiAqIHR5KSwgKDIgKiB0eCArIDEsIDIgKiB0eSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgKDIgKiB0eCwgMiAqIHR5ICsgMSksICgyICogdHggKyAxLCAyICogdHkgKyAxKSkKCiAgICAgICAgICAgICAgICAjICMgQ3JlYXRlIGEgS01MIGZpbGUgZm9yIHRoaXMgdGlsZS4KICAgICAgICAgICAgICAgICMgaWYgdGlsZV9qb2JfaW5mby5rbWw6CiAgICAgICAgICAgICAgICAjICAgICB3aXRoIG9wZW4ob3MucGF0aC5qb2luKAogICAgICAgICAgICAgICAgIyAgICAgICAgIG91dHB1dF9mb2xkZXIsCiAgICAgICAgICAgICAgICAjICAgICAgICAgJyVkLyVkLyVkLmttbCcgJSAodHosIHR4LCB0eSkKICAgICAgICAgICAgICAgICMgICAgICksICd3YicpIGFzIGY6CiAgICAgICAgICAgICAgICAjICAgICAgICAgZi53cml0ZShnZW5lcmF0ZV9rbWwoCiAgICAgICAgICAgICAgICAjICAgICAgICAgICAgIHR4LCB0eSwgdHosIHRpbGVfam9iX2luZm8udGlsZV9leHRlbnNpb24sIHRpbGVfam9iX2luZm8udGlsZV9zaXplLAogICAgICAgICAgICAgICAgIyAgICAgICAgICAgICBnZXRfdGlsZV9zd25lKHRpbGVfam9iX2luZm8sIG9wdGlvbnMpLCBvcHRpb25zLCBjaGlsZHJlbgogICAgICAgICAgICAgICAgIyAgICAgICAgICkuZW5jb2RlKCd1dGYtOCcpKQoKICAgICAgICAgICAgICAgIGlmIG5vdCBvcHRpb25zLnZlcmJvc2UgYW5kIG5vdCBvcHRpb25zLnF1aWV0OgogICAgICAgICAgICAgICAgICAgIHByb2dyZXNzX2Jhci5sb2dfcHJvZ3Jlc3MoKQoKCmRlZiBvcHRwYXJzZV9pbml0KCk6CiAgICAiIiJQcmVwYXJlIHRoZSBvcHRpb24gcGFyc2VyIGZvciBpbnB1dCAoYXJndikiIiIKCiAgICBmcm9tIG9wdHBhcnNlIGltcG9ydCBPcHRpb25QYXJzZXIsIE9wdGlvbkdyb3VwCiAgICB1c2FnZSA9ICJVc2FnZTogJXByb2cgW29wdGlvbnNdIGlucHV0X2ZpbGUgW291dHB1dF0iCiAgICBwID0gT3B0aW9uUGFyc2VyKHVzYWdlLCB2ZXJzaW9uPSIlcHJvZyAiICsgX192ZXJzaW9uX18pCiAgICBwLmFkZF9vcHRpb24oIi1wIiwgIi0tcHJvZmlsZSIsIGRlc3Q9J3Byb2ZpbGUnLAogICAgICAgICAgICAgICAgIHR5cGU9J2Nob2ljZScsIGNob2ljZXM9cHJvZmlsZV9saXN0LAogICAgICAgICAgICAgICAgIGhlbHA9KCJUaWxlIGN1dHRpbmcgcHJvZmlsZSAoJXMpIC0gZGVmYXVsdCAnbWVyY2F0b3InICIKICAgICAgICAgICAgICAgICAgICAgICAiKEdvb2dsZSBNYXBzIGNvbXBhdGlibGUpIiAlICIsIi5qb2luKHByb2ZpbGVfbGlzdCkpKQogICAgcC5hZGRfb3B0aW9uKCItciIsICItLXJlc2FtcGxpbmciLCBkZXN0PSJyZXNhbXBsaW5nIiwKICAgICAgICAgICAgICAgICB0eXBlPSdjaG9pY2UnLCBjaG9pY2VzPXJlc2FtcGxpbmdfbGlzdCwKICAgICAgICAgICAgICAgICBoZWxwPSJSZXNhbXBsaW5nIG1ldGhvZCAoJXMpIC0gZGVmYXVsdCAnYXZlcmFnZSciICUgIiwiLmpvaW4ocmVzYW1wbGluZ19saXN0KSkKICAgIHAuYWRkX29wdGlvbigiLXMiLCAiLS1zX3NycyIsIGRlc3Q9InNfc3JzIiwgbWV0YXZhcj0iU1JTIiwKICAgICAgICAgICAgICAgICBoZWxwPSJUaGUgc3BhdGlhbCByZWZlcmVuY2Ugc3lzdGVtIHVzZWQgZm9yIHRoZSBzb3VyY2UgaW5wdXQgZGF0YSIpCiAgICBwLmFkZF9vcHRpb24oIi16IiwgIi0tem9vbSIsIGRlc3Q9Inpvb20iLAogICAgICAgICAgICAgICAgIGhlbHA9Ilpvb20gbGV2ZWxzIHRvIHJlbmRlciAoZm9ybWF0OicyLTUnIG9yICcxMCcpLiIpCiAgICBwLmFkZF9vcHRpb24oIi1lIiwgIi0tcmVzdW1lIiwgZGVzdD0icmVzdW1lIiwgYWN0aW9uPSJzdG9yZV90cnVlIiwKICAgICAgICAgICAgICAgICBoZWxwPSJSZXN1bWUgbW9kZS4gR2VuZXJhdGUgb25seSBtaXNzaW5nIGZpbGVzLiIpCiAgICBwLmFkZF9vcHRpb24oIi1hIiwgIi0tc3Jjbm9kYXRhIiwgZGVzdD0ic3Jjbm9kYXRhIiwgbWV0YXZhcj0iTk9EQVRBIiwKICAgICAgICAgICAgICAgICBoZWxwPSJOT0RBVEEgdHJhbnNwYXJlbmN5IHZhbHVlIHRvIGFzc2lnbiB0byB0aGUgaW5wdXQgZGF0YSIpCiAgICBwLmFkZF9vcHRpb24oIi1kIiwgIi0tdG1zY29tcGF0aWJsZSIsIGRlc3Q9InRtc2NvbXBhdGlibGUiLCBhY3Rpb249InN0b3JlX3RydWUiLAogICAgICAgICAgICAgICAgIGhlbHA9KCJXaGVuIHVzaW5nIHRoZSBnZW9kZXRpYyBwcm9maWxlLCBzcGVjaWZpZXMgdGhlIGJhc2UgcmVzb2x1dGlvbiAiCiAgICAgICAgICAgICAgICAgICAgICAgImFzIDAuNzAzMTI1IG9yIDIgdGlsZXMgYXQgem9vbSBsZXZlbCAwLiIpKQogICAgcC5hZGRfb3B0aW9uKCIteCIsICItLXh5eiIsIAogICAgICAgICAgICAgICAgIGFjdGlvbj0nc3RvcmVfdHJ1ZScsIGRlc3Q9J3h5eicsCiAgICAgICAgICAgICAgICAgaGVscD0iVXNlIFhZWiB0aWxlIG51bWJlcmluZyBpbnN0ZWFkIG9mIFRNUyIpCiAgICBwLmFkZF9vcHRpb24oIi12IiwgIi0tdmVyYm9zZSIsCiAgICAgICAgICAgICAgICAgYWN0aW9uPSJzdG9yZV90cnVlIiwgZGVzdD0idmVyYm9zZSIsCiAgICAgICAgICAgICAgICAgaGVscD0iUHJpbnQgc3RhdHVzIG1lc3NhZ2VzIHRvIHN0ZG91dCIpCiAgICBwLmFkZF9vcHRpb24oIi1xIiwgIi0tcXVpZXQiLAogICAgICAgICAgICAgICAgIGFjdGlvbj0ic3RvcmVfdHJ1ZSIsIGRlc3Q9InF1aWV0IiwKICAgICAgICAgICAgICAgICBoZWxwPSJEaXNhYmxlIG1lc3NhZ2VzIGFuZCBzdGF0dXMgdG8gc3Rkb3V0IikKICAgIHAuYWRkX29wdGlvbigiLS1wcm9jZXNzZXMiLAogICAgICAgICAgICAgICAgIGRlc3Q9Im5iX3Byb2Nlc3NlcyIsCiAgICAgICAgICAgICAgICAgdHlwZT0naW50JywKICAgICAgICAgICAgICAgICBoZWxwPSJOdW1iZXIgb2YgcHJvY2Vzc2VzIHRvIHVzZSBmb3IgdGlsaW5nIikKCiAgICAjIEtNTCBvcHRpb25zCiAgICBnID0gT3B0aW9uR3JvdXAocCwgIktNTCAoR29vZ2xlIEVhcnRoKSBvcHRpb25zIiwKICAgICAgICAgICAgICAgICAgICAiT3B0aW9ucyBmb3IgZ2VuZXJhdGVkIEdvb2dsZSBFYXJ0aCBTdXBlck92ZXJsYXkgbWV0YWRhdGEiKQogICAgZy5hZGRfb3B0aW9uKCItayIsICItLWZvcmNlLWttbCIsIGRlc3Q9J2ttbCcsIGFjdGlvbj0ic3RvcmVfdHJ1ZSIsCiAgICAgICAgICAgICAgICAgaGVscD0oIkdlbmVyYXRlIEtNTCBmb3IgR29vZ2xlIEVhcnRoIC0gZGVmYXVsdCBmb3IgJ2dlb2RldGljJyBwcm9maWxlIGFuZCAiCiAgICAgICAgICAgICAgICAgICAgICAgIidyYXN0ZXInIGluIEVQU0c6NDMyNi4gRm9yIGEgZGF0YXNldCB3aXRoIGRpZmZlcmVudCBwcm9qZWN0aW9uIHVzZSAiCiAgICAgICAgICAgICAgICAgICAgICAgIndpdGggY2F1dGlvbiEiKSkKICAgIGcuYWRkX29wdGlvbigiLW4iLCAiLS1uby1rbWwiLCBkZXN0PSdrbWwnLCBhY3Rpb249InN0b3JlX2ZhbHNlIiwKICAgICAgICAgICAgICAgICBoZWxwPSJBdm9pZCBhdXRvbWF0aWMgZ2VuZXJhdGlvbiBvZiBLTUwgZmlsZXMgZm9yIEVQU0c6NDMyNiIpCiAgICBnLmFkZF9vcHRpb24oIi11IiwgIi0tdXJsIiwgZGVzdD0ndXJsJywKICAgICAgICAgICAgICAgICBoZWxwPSJVUkwgYWRkcmVzcyB3aGVyZSB0aGUgZ2VuZXJhdGVkIHRpbGVzIGFyZSBnb2luZyB0byBiZSBwdWJsaXNoZWQiKQogICAgcC5hZGRfb3B0aW9uX2dyb3VwKGcpCgogICAgIyBIVE1MIG9wdGlvbnMKICAgIGcgPSBPcHRpb25Hcm91cChwLCAiV2ViIHZpZXdlciBvcHRpb25zIiwKICAgICAgICAgICAgICAgICAgICAiT3B0aW9ucyBmb3IgZ2VuZXJhdGVkIEhUTUwgdmlld2VycyBhIGxhIEdvb2dsZSBNYXBzIikKICAgIGcuYWRkX29wdGlvbigiLXciLCAiLS13ZWJ2aWV3ZXIiLCBkZXN0PSd3ZWJ2aWV3ZXInLCB0eXBlPSdjaG9pY2UnLCBjaG9pY2VzPXdlYnZpZXdlcl9saXN0LAogICAgICAgICAgICAgICAgIGhlbHA9IldlYiB2aWV3ZXIgdG8gZ2VuZXJhdGUgKCVzKSAtIGRlZmF1bHQgJ2FsbCciICUgIiwiLmpvaW4od2Vidmlld2VyX2xpc3QpKQogICAgZy5hZGRfb3B0aW9uKCItdCIsICItLXRpdGxlIiwgZGVzdD0ndGl0bGUnLAogICAgICAgICAgICAgICAgIGhlbHA9IlRpdGxlIG9mIHRoZSBtYXAiKQogICAgZy5hZGRfb3B0aW9uKCItYyIsICItLWNvcHlyaWdodCIsIGRlc3Q9J2NvcHlyaWdodCcsCiAgICAgICAgICAgICAgICAgaGVscD0iQ29weXJpZ2h0IGZvciB0aGUgbWFwIikKICAgIGcuYWRkX29wdGlvbigiLWciLCAiLS1nb29nbGVrZXkiLCBkZXN0PSdnb29nbGVrZXknLAogICAgICAgICAgICAgICAgIGhlbHA9Ikdvb2dsZSBNYXBzIEFQSSBrZXkgZnJvbSBodHRwOi8vY29kZS5nb29nbGUuY29tL2FwaXMvbWFwcy9zaWdudXAuaHRtbCIpCiAgICBnLmFkZF9vcHRpb24oIi1iIiwgIi0tYmluZ2tleSIsIGRlc3Q9J2JpbmdrZXknLAogICAgICAgICAgICAgICAgIGhlbHA9IkJpbmcgTWFwcyBBUEkga2V5IGZyb20gaHR0cHM6Ly93d3cuYmluZ21hcHNwb3J0YWwuY29tLyIpCiAgICBwLmFkZF9vcHRpb25fZ3JvdXAoZykKCiAgICBwLnNldF9kZWZhdWx0cyh2ZXJib3NlPUZhbHNlLCBwcm9maWxlPSJtZXJjYXRvciIsIGttbD1GYWxzZSwgdXJsPScnLCB6b29tPScwLTInLCB4eXo9VHJ1ZSwKICAgICAgICAgICAgICAgICAgIHdlYnZpZXdlcj0nbm9uZScsIGNvcHlyaWdodD0nJywgcmVzYW1wbGluZz0nbmVhcicsIHJlc3VtZT1GYWxzZSwKICAgICAgICAgICAgICAgICAgIGdvb2dsZWtleT0nSU5TRVJUX1lPVVJfS0VZX0hFUkUnLCBiaW5na2V5PSdJTlNFUlRfWU9VUl9LRVlfSEVSRScsCiAgICAgICAgICAgICAgICAgICBwcm9jZXNzZXM9MSkKCiAgICByZXR1cm4gcAoKCmRlZiBwcm9jZXNzX2FyZ3MoYXJndik6CiAgICBwYXJzZXIgPSBvcHRwYXJzZV9pbml0KCkKICAgIG9wdGlvbnMsIGFyZ3MgPSBwYXJzZXIucGFyc2VfYXJncyhhcmdzPWFyZ3YpCgogICAgIyBBcmdzIHNob3VsZCBiZSBlaXRoZXIgYW4gaW5wdXQgZmlsZSBPUiBhbiBpbnB1dCBmaWxlIGFuZCBhbiBvdXRwdXQgZm9sZGVyCiAgICBpZiAobGVuKGFyZ3MpID09IDApOgogICAgICAgIGV4aXRfd2l0aF9lcnJvcigiWW91IG5lZWQgdG8gc3BlY2lmeSBhdCBsZWFzdCBhbiBpbnB1dCBmaWxlIGFzIGFyZ3VtZW50IHRvIHRoZSBzY3JpcHQiKQogICAgaWYgKGxlbihhcmdzKSA+IDIpOgogICAgICAgIGV4aXRfd2l0aF9lcnJvcigiUHJvY2Vzc2luZyBvZiBzZXZlcmFsIGlucHV0IGZpbGVzIGlzIG5vdCBzdXBwb3J0ZWQuIiwKICAgICAgICAgICAgICAgICAgICAgICAgIlBsZWFzZSBmaXJzdCB1c2UgYSB0b29sIGxpa2UgZ2RhbF92cnRtZXJnZS5weSBvciBnZGFsX21lcmdlLnB5IG9uIHRoZSAiCiAgICAgICAgICAgICAgICAgICAgICAgICJmaWxlczogZ2RhbF92cnRtZXJnZS5weSAtbyBtZXJnZWQudnJ0ICVzIiAlICIgIi5qb2luKGFyZ3MpKQoKICAgIGlucHV0X2ZpbGUgPSBhcmdzWzBdCiAgICBpZiBub3Qgb3MucGF0aC5pc2ZpbGUoaW5wdXRfZmlsZSk6CiAgICAgICAgZXhpdF93aXRoX2Vycm9yKCJUaGUgcHJvdmlkZWQgaW5wdXQgZmlsZSAlcyBkb2VzIG5vdCBleGlzdCBvciBpcyBub3QgYSBmaWxlIiAlIGlucHV0X2ZpbGUpCgogICAgaWYgbGVuKGFyZ3MpID09IDI6CiAgICAgICAgb3V0cHV0X2ZvbGRlciA9IGFyZ3NbMV0KICAgIGVsc2U6CiAgICAgICAgb3V0cHV0X2ZvbGRlciA9IG9zLnBhdGguYmFzZW5hbWUoaW5wdXRfZmlsZSkKCiAgICBvcHRpb25zID0gb3B0aW9uc19wb3N0X3Byb2Nlc3Npbmcob3B0aW9ucywgaW5wdXRfZmlsZSwgb3V0cHV0X2ZvbGRlcikKCiAgICByZXR1cm4gaW5wdXRfZmlsZSwgb3V0cHV0X2ZvbGRlciwgb3B0aW9ucwoKCmRlZiBvcHRpb25zX3Bvc3RfcHJvY2Vzc2luZyhvcHRpb25zLCBpbnB1dF9maWxlLCBvdXRwdXRfZm9sZGVyKToKICAgIGlmIG5vdCBvcHRpb25zLnRpdGxlOgogICAgICAgIG9wdGlvbnMudGl0bGUgPSBvcy5wYXRoLmJhc2VuYW1lKGlucHV0X2ZpbGUpCgogICAgaWYgb3B0aW9ucy51cmwgYW5kIG5vdCBvcHRpb25zLnVybC5lbmRzd2l0aCgnLycpOgogICAgICAgIG9wdGlvbnMudXJsICs9ICcvJwogICAgaWYgb3B0aW9ucy51cmw6CiAgICAgICAgb3V0X3BhdGggPSBvdXRwdXRfZm9sZGVyCiAgICAgICAgaWYgb3V0X3BhdGguZW5kc3dpdGgoIi8iKToKICAgICAgICAgICAgb3V0X3BhdGggPSBvdXRfcGF0aFs6LTFdCiAgICAgICAgb3B0aW9ucy51cmwgKz0gb3MucGF0aC5iYXNlbmFtZShvdXRfcGF0aCkgKyAnLycKCiAgICAjIFN1cHBvcnRlZCBvcHRpb25zCiAgICBpZiBvcHRpb25zLnJlc2FtcGxpbmcgPT0gJ2F2ZXJhZ2UnOgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgZ2RhbC5SZWdlbmVyYXRlT3ZlcnZpZXc6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgZXhpdF93aXRoX2Vycm9yKCInYXZlcmFnZScgcmVzYW1wbGluZyBhbGdvcml0aG0gaXMgbm90IGF2YWlsYWJsZS4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIlBsZWFzZSB1c2UgLXIgJ25lYXInIGFyZ3VtZW50IG9yIHVwZ3JhZGUgdG8gbmV3ZXIgdmVyc2lvbiBvZiBHREFMLiIpCgogICAgZWxpZiBvcHRpb25zLnJlc2FtcGxpbmcgPT0gJ2FudGlhbGlhcyc6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBudW1weTogICAgICMgcHlsaW50OmRpc2FibGU9VzAxMjUKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBleGl0X3dpdGhfZXJyb3IoIidhbnRpYWxpYXMnIHJlc2FtcGxpbmcgYWxnb3JpdGhtIGlzIG5vdCBhdmFpbGFibGUuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJJbnN0YWxsIFBJTCAoUHl0aG9uIEltYWdpbmcgTGlicmFyeSkgYW5kIG51bXB5LiIpCgogICAgdHJ5OgogICAgICAgIG9zLnBhdGguYmFzZW5hbWUoaW5wdXRfZmlsZSkuZW5jb2RlKCdhc2NpaScpCiAgICBleGNlcHQgVW5pY29kZUVuY29kZUVycm9yOgogICAgICAgIGZ1bGxfYXNjaWkgPSBGYWxzZQogICAgZWxzZToKICAgICAgICBmdWxsX2FzY2lpID0gVHJ1ZQoKICAgICMgTENfQ1RZUEUgY2hlY2sKICAgIGlmIG5vdCBmdWxsX2FzY2lpIGFuZCAnVVRGLTgnIG5vdCBpbiBvcy5lbnZpcm9uLmdldCgiTENfQ1RZUEUiLCAiIik6CiAgICAgICAgaWYgbm90IG9wdGlvbnMucXVpZXQ6CiAgICAgICAgICAgIHByaW50KCJcbldBUk5JTkc6ICIKICAgICAgICAgICAgICAgICAgIllvdSBhcmUgcnVubmluZyBnZGFsMnRpbGVzX2xvY2FsLnB5IHdpdGggYSBMQ19DVFlQRSBlbnZpcm9ubWVudCB2YXJpYWJsZSB0aGF0IGlzICIKICAgICAgICAgICAgICAgICAgIm5vdCBVVEYtOCBjb21wYXRpYmxlLCBhbmQgeW91ciBpbnB1dCBmaWxlIGNvbnRhaW5zIG5vbi1hc2NpaSBjaGFyYWN0ZXJzLiAiCiAgICAgICAgICAgICAgICAgICJUaGUgZ2VuZXJhdGVkIHNhbXBsZSBnb29nbGVtYXBzLCBvcGVubGF5ZXJzIG9yICIKICAgICAgICAgICAgICAgICAgImxlYWZsZXQgZmlsZXMgbWlnaHQgY29udGFpbiBzb21lIGludmFsaWQgY2hhcmFjdGVycyBhcyBhIHJlc3VsdFxuIikKCiAgICAjIE91dHB1dCB0aGUgcmVzdWx0cwogICAgaWYgb3B0aW9ucy52ZXJib3NlOgogICAgICAgIHByaW50KCJPcHRpb25zOiIsIG9wdGlvbnMpCiAgICAgICAgcHJpbnQoIklucHV0OiIsIGlucHV0X2ZpbGUpCiAgICAgICAgcHJpbnQoIk91dHB1dDoiLCBvdXRwdXRfZm9sZGVyKQogICAgICAgIHByaW50KCJDYWNoZTogJXMgTUIiICUgKGdkYWwuR2V0Q2FjaGVNYXgoKSAvIDEwMjQgLyAxMDI0KSkKICAgICAgICBwcmludCgnJykKCiAgICByZXR1cm4gb3B0aW9ucwoKCmNsYXNzIFRpbGVEZXRhaWwob2JqZWN0KToKICAgIHR4ID0gMAogICAgdHkgPSAwCiAgICB0eiA9IDAKICAgIHJ4ID0gMAogICAgcnkgPSAwCiAgICByeHNpemUgPSAwCiAgICByeXNpemUgPSAwCiAgICB3eCA9IDAKICAgIHd5ID0gMAogICAgd3hzaXplID0gMAogICAgd3lzaXplID0gMAogICAgcXVlcnlzaXplID0gMAoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCAqKmt3YXJncyk6CiAgICAgICAgZm9yIGtleSBpbiBrd2FyZ3M6CiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwga2V5KToKICAgICAgICAgICAgICAgIHNldGF0dHIoc2VsZiwga2V5LCBrd2FyZ3Nba2V5XSkKCiAgICBkZWYgX191bmljb2RlX18oc2VsZik6CiAgICAgICAgcmV0dXJuICJUaWxlRGV0YWlsICVzXG4lc1xuJXNcbiIgJSAoc2VsZi50eCwgc2VsZi50eSwgc2VsZi50eikKCiAgICBkZWYgX19zdHJfXyhzZWxmKToKICAgICAgICByZXR1cm4gIlRpbGVEZXRhaWwgJXNcbiVzXG4lc1xuIiAlIChzZWxmLnR4LCBzZWxmLnR5LCBzZWxmLnR6KQoKICAgIGRlZiBfX3JlcHJfXyhzZWxmKToKICAgICAgICByZXR1cm4gIlRpbGVEZXRhaWwgJXNcbiVzXG4lc1xuIiAlIChzZWxmLnR4LCBzZWxmLnR5LCBzZWxmLnR6KQoKCmNsYXNzIFRpbGVKb2JJbmZvKG9iamVjdCk6CiAgICAiIiIKICAgIFBsYWluIG9iamVjdCB0byBob2xkIHRpbGUgam9iIGNvbmZpZ3VyYXRpb24gZm9yIGEgZGF0YXNldAogICAgIiIiCiAgICBzcmNfZmlsZSA9ICIiCiAgICBuYl9kYXRhX2JhbmRzID0gMAogICAgb3V0cHV0X2ZpbGVfcGF0aCA9ICIiCiAgICB0aWxlX2V4dGVuc2lvbiA9ICIiCiAgICB0aWxlX3NpemUgPSAwCiAgICB0aWxlX2RyaXZlciA9IE5vbmUKICAgIGttbCA9IEZhbHNlCiAgICB0bWlubWF4ID0gW10KICAgIHRtaW56ID0gMAogICAgdG1heHogPSAwCiAgICBpbl9zcnNfd2t0ID0gMAogICAgb3V0X2dlb190cmFucyA9IFtdCiAgICBvbWlueSA9IDAKICAgIGlzX2Vwc2dfNDMyNiA9IEZhbHNlCiAgICBvcHRpb25zID0gTm9uZQoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCAqKmt3YXJncyk6CiAgICAgICAgZm9yIGtleSBpbiBrd2FyZ3M6CiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwga2V5KToKICAgICAgICAgICAgICAgIHNldGF0dHIoc2VsZiwga2V5LCBrd2FyZ3Nba2V5XSkKCiAgICBkZWYgX191bmljb2RlX18oc2VsZik6CiAgICAgICAgcmV0dXJuICJUaWxlSm9iSW5mbyAlc1xuIiAlIChzZWxmLnNyY19maWxlKQoKICAgIGRlZiBfX3N0cl9fKHNlbGYpOgogICAgICAgIHJldHVybiAiVGlsZUpvYkluZm8gJXNcbiIgJSAoc2VsZi5zcmNfZmlsZSkKCiAgICBkZWYgX19yZXByX18oc2VsZik6CiAgICAgICAgcmV0dXJuICJUaWxlSm9iSW5mbyAlc1xuIiAlIChzZWxmLnNyY19maWxlKQoKCmNsYXNzIEdkYWwyVGlsZXNFcnJvcihFeGNlcHRpb24pOgogICAgcGFzcwoKCmNsYXNzIEdEQUwyVGlsZXMob2JqZWN0KToKCiAgICBkZWYgX19pbml0X18oc2VsZiwgaW5wdXRfZmlsZSwgb3V0cHV0X2ZvbGRlciwgb3B0aW9ucyk6CiAgICAgICAgIiIiQ29uc3RydWN0b3IgZnVuY3Rpb24gLSBpbml0aWFsaXphdGlvbiIiIgogICAgICAgIHNlbGYub3V0X2RydiA9IE5vbmUKICAgICAgICBzZWxmLm1lbV9kcnYgPSBOb25lCiAgICAgICAgc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldCA9IE5vbmUKICAgICAgICBzZWxmLm91dF9zcnMgPSBOb25lCiAgICAgICAgc2VsZi5uYXRpdmV6b29tID0gTm9uZQogICAgICAgIHNlbGYudG1pbm1heCA9IE5vbmUKICAgICAgICBzZWxmLnRzaXplID0gTm9uZQogICAgICAgIHNlbGYubWVyY2F0b3IgPSBOb25lCiAgICAgICAgc2VsZi5nZW9kZXRpYyA9IE5vbmUKICAgICAgICBzZWxmLmFscGhhYmFuZCA9IE5vbmUKICAgICAgICBzZWxmLmRhdGFCYW5kc0NvdW50ID0gTm9uZQogICAgICAgIHNlbGYub3V0X2d0ID0gTm9uZQogICAgICAgIHNlbGYudGlsZXN3bmUgPSBOb25lCiAgICAgICAgc2VsZi5zd25lID0gTm9uZQogICAgICAgIHNlbGYub21pbnggPSBOb25lCiAgICAgICAgc2VsZi5vbWF4eCA9IE5vbmUKICAgICAgICBzZWxmLm9tYXh5ID0gTm9uZQogICAgICAgIHNlbGYub21pbnkgPSBOb25lCgogICAgICAgIHNlbGYuaW5wdXRfZmlsZSA9IE5vbmUKICAgICAgICBzZWxmLm91dHB1dF9mb2xkZXIgPSBOb25lCgogICAgICAgICMgVGlsZSBmb3JtYXQKICAgICAgICBzZWxmLnRpbGVzaXplID0gMjU2CiAgICAgICAgc2VsZi50aWxlZHJpdmVyID0gJ1BORycKICAgICAgICBzZWxmLnRpbGVleHQgPSAncG5nJwogICAgICAgIHNlbGYudG1wX2RpciA9IHRlbXBmaWxlLm1rZHRlbXAoKQogICAgICAgIHNlbGYudG1wX3ZydF9maWxlbmFtZSA9IG9zLnBhdGguam9pbihzZWxmLnRtcF9kaXIsIHN0cih1dWlkNCgpKSArICcudnJ0JykKCiAgICAgICAgIyBTaG91bGQgd2UgcmVhZCBiaWdnZXIgd2luZG93IG9mIHRoZSBpbnB1dCByYXN0ZXIgYW5kIHNjYWxlIGl0IGRvd24/CiAgICAgICAgIyBOb3RlOiBNb2RpZmllZCBsYXRlciBieSBvcGVuX2lucHV0KCkKICAgICAgICAjIE5vdCBmb3IgJ25lYXInIHJlc2FtcGxpbmcKICAgICAgICAjIE5vdCBmb3IgV2F2ZWxldCBiYXNlZCBkcml2ZXJzIChKUEVHMjAwMCwgRUNXLCBNclNJRCkKICAgICAgICAjIE5vdCBmb3IgJ3Jhc3RlcicgcHJvZmlsZQogICAgICAgIHNlbGYuc2NhbGVkcXVlcnkgPSBUcnVlCiAgICAgICAgIyBIb3cgYmlnIHNob3VsZCBiZSBxdWVyeSB3aW5kb3cgYmUgZm9yIHNjYWxpbmcgZG93bgogICAgICAgICMgTGF0ZXIgb24gcmVzZXQgYWNjb3JkaW5nIHRoZSBjaG9zZW4gcmVzYW1wbGluZyBhbGdvcmlnaHRtCiAgICAgICAgc2VsZi5xdWVyeXNpemUgPSA0ICogc2VsZi50aWxlc2l6ZQoKICAgICAgICAjIFNob3VsZCB3ZSB1c2UgUmVhZCBvbiB0aGUgaW5wdXQgZmlsZSBmb3IgZ2VuZXJhdGluZyBvdmVydmlldyB0aWxlcz8KICAgICAgICAjIE5vdGU6IE1vZGlmaWVkIGxhdGVyIGJ5IG9wZW5faW5wdXQoKQogICAgICAgICMgT3RoZXJ3aXNlIHRoZSBvdmVydmlldyB0aWxlcyBhcmUgZ2VuZXJhdGVkIGZyb20gZXhpc3RpbmcgdW5kZXJseWluZyB0aWxlcwogICAgICAgIHNlbGYub3ZlcnZpZXdxdWVyeSA9IEZhbHNlCgogICAgICAgIHNlbGYuaW5wdXRfZmlsZSA9IGlucHV0X2ZpbGUKICAgICAgICBzZWxmLm91dHB1dF9mb2xkZXIgPSBvdXRwdXRfZm9sZGVyCiAgICAgICAgc2VsZi5vcHRpb25zID0gb3B0aW9ucwoKICAgICAgICBpZiBzZWxmLm9wdGlvbnMucmVzYW1wbGluZyA9PSAnbmVhcic6CiAgICAgICAgICAgIHNlbGYucXVlcnlzaXplID0gc2VsZi50aWxlc2l6ZQoKICAgICAgICBlbGlmIHNlbGYub3B0aW9ucy5yZXNhbXBsaW5nID09ICdiaWxpbmVhcic6CiAgICAgICAgICAgIHNlbGYucXVlcnlzaXplID0gc2VsZi50aWxlc2l6ZSAqIDIKCiAgICAgICAgIyBVc2VyIHNwZWNpZmllZCB6b29tIGxldmVscwogICAgICAgIHNlbGYudG1pbnogPSBOb25lCiAgICAgICAgc2VsZi50bWF4eiA9IE5vbmUKICAgICAgICBpZiBzZWxmLm9wdGlvbnMuem9vbToKICAgICAgICAgICAgbWlubWF4ID0gc2VsZi5vcHRpb25zLnpvb20uc3BsaXQoJy0nLCAxKQogICAgICAgICAgICBtaW5tYXguZXh0ZW5kKFsnJ10pCiAgICAgICAgICAgIHpvb21fbWluLCB6b29tX21heCA9IG1pbm1heFs6Ml0KICAgICAgICAgICAgc2VsZi50bWlueiA9IGludCh6b29tX21pbikKICAgICAgICAgICAgaWYgem9vbV9tYXg6CiAgICAgICAgICAgICAgICBzZWxmLnRtYXh6ID0gaW50KHpvb21fbWF4KQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi50bWF4eiA9IGludCh6b29tX21pbikKCiAgICAgICAgIyBLTUwgZ2VuZXJhdGlvbgogICAgICAgIHNlbGYua21sID0gc2VsZi5vcHRpb25zLmttbAoKICAgICMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgZGVmIG9wZW5faW5wdXQoc2VsZik6CiAgICAgICAgIiIiSW5pdGlhbGl6YXRpb24gb2YgdGhlIGlucHV0IHJhc3RlciwgcmVwcm9qZWN0aW9uIGlmIG5lY2Vzc2FyeSIiIgogICAgICAgIGdkYWwuQWxsUmVnaXN0ZXIoKQoKICAgICAgICBzZWxmLm91dF9kcnYgPSBnZGFsLkdldERyaXZlckJ5TmFtZShzZWxmLnRpbGVkcml2ZXIpCiAgICAgICAgc2VsZi5tZW1fZHJ2ID0gZ2RhbC5HZXREcml2ZXJCeU5hbWUoJ01FTScpCgogICAgICAgIGlmIG5vdCBzZWxmLm91dF9kcnY6CiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiVGhlICclcycgZHJpdmVyIHdhcyBub3QgZm91bmQsIGlzIGl0IGF2YWlsYWJsZSBpbiB0aGlzIEdEQUwgYnVpbGQ/IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudGlsZWRyaXZlcikKICAgICAgICBpZiBub3Qgc2VsZi5tZW1fZHJ2OgogICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oIlRoZSAnTUVNJyBkcml2ZXIgd2FzIG5vdCBmb3VuZCwgaXMgaXQgYXZhaWxhYmxlIGluIHRoaXMgR0RBTCBidWlsZD8iKQoKICAgICAgICAjIE9wZW4gdGhlIGlucHV0IGZpbGUKCiAgICAgICAgaWYgc2VsZi5pbnB1dF9maWxlOgogICAgICAgICAgICBpbnB1dF9kYXRhc2V0ID0gZ2RhbC5PcGVuKHNlbGYuaW5wdXRfZmlsZSwgZ2RhbC5HQV9SZWFkT25seSkKICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oIk5vIGlucHV0IGZpbGUgd2FzIHNwZWNpZmllZCIpCgogICAgICAgIGlmIHNlbGYub3B0aW9ucy52ZXJib3NlOgogICAgICAgICAgICBwcmludCgiSW5wdXQgZmlsZToiLAogICAgICAgICAgICAgICAgICAiKCAlc1AgeCAlc0wgLSAlcyBiYW5kcykiICUgKGlucHV0X2RhdGFzZXQuUmFzdGVyWFNpemUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXRfZGF0YXNldC5SYXN0ZXJZU2l6ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnB1dF9kYXRhc2V0LlJhc3RlckNvdW50KSkKCiAgICAgICAgaWYgbm90IGlucHV0X2RhdGFzZXQ6CiAgICAgICAgICAgICMgTm90ZTogR0RBTCBwcmludHMgdGhlIEVSUk9SIG1lc3NhZ2UgdG9vCiAgICAgICAgICAgIGV4aXRfd2l0aF9lcnJvcigiSXQgaXMgbm90IHBvc3NpYmxlIHRvIG9wZW4gdGhlIGlucHV0IGZpbGUgJyVzJy4iICUgc2VsZi5pbnB1dF9maWxlKQoKICAgICAgICAjIFJlYWQgbWV0YWRhdGEgZnJvbSB0aGUgaW5wdXQgZmlsZQogICAgICAgIGlmIGlucHV0X2RhdGFzZXQuUmFzdGVyQ291bnQgPT0gMDoKICAgICAgICAgICAgZXhpdF93aXRoX2Vycm9yKCJJbnB1dCBmaWxlICclcycgaGFzIG5vIHJhc3RlciBiYW5kIiAlIHNlbGYuaW5wdXRfZmlsZSkKCiAgICAgICAgaWYgaW5wdXRfZGF0YXNldC5HZXRSYXN0ZXJCYW5kKDEpLkdldFJhc3RlckNvbG9yVGFibGUoKToKICAgICAgICAgICAgZXhpdF93aXRoX2Vycm9yKAogICAgICAgICAgICAgICAgIlBsZWFzZSBjb252ZXJ0IHRoaXMgZmlsZSB0byBSR0IvUkdCQSBhbmQgcnVuIGdkYWwydGlsZXMgb24gdGhlIHJlc3VsdC4iLAogICAgICAgICAgICAgICAgIkZyb20gcGFsZXR0ZWQgZmlsZSB5b3UgY2FuIGNyZWF0ZSBSR0JBIGZpbGUgKHRlbXAudnJ0KSBieTpcbiIKICAgICAgICAgICAgICAgICJnZGFsX3RyYW5zbGF0ZSAtb2YgdnJ0IC1leHBhbmQgcmdiYSAlcyB0ZW1wLnZydFxuIgogICAgICAgICAgICAgICAgInRoZW4gcnVuOlxuIgogICAgICAgICAgICAgICAgImdkYWwydGlsZXMgdGVtcC52cnQiICUgc2VsZi5pbnB1dF9maWxlCiAgICAgICAgICAgICkKCiAgICAgICAgaW5fbm9kYXRhID0gc2V0dXBfbm9fZGF0YV92YWx1ZXMoaW5wdXRfZGF0YXNldCwgc2VsZi5vcHRpb25zKQoKICAgICAgICBpZiBzZWxmLm9wdGlvbnMudmVyYm9zZToKICAgICAgICAgICAgcHJpbnQoIlByZXByb2Nlc3NlZCBmaWxlOiIsCiAgICAgICAgICAgICAgICAgICIoICVzUCB4ICVzTCAtICVzIGJhbmRzKSIgJSAoaW5wdXRfZGF0YXNldC5SYXN0ZXJYU2l6ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnB1dF9kYXRhc2V0LlJhc3RlcllTaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0X2RhdGFzZXQuUmFzdGVyQ291bnQpKQoKICAgICAgICBpbl9zcnMsIHNlbGYuaW5fc3JzX3drdCA9IHNldHVwX2lucHV0X3NycyhpbnB1dF9kYXRhc2V0LCBzZWxmLm9wdGlvbnMpCgogICAgICAgIHNlbGYub3V0X3NycyA9IHNldHVwX291dHB1dF9zcnMoaW5fc3JzLCBzZWxmLm9wdGlvbnMpCgogICAgICAgICMgSWYgaW5wdXQgYW5kIG91dHB1dCByZWZlcmVuY2Ugc3lzdGVtcyBhcmUgZGlmZmVyZW50LCB3ZSByZXByb2plY3QgdGhlIGlucHV0IGRhdGFzZXQgaW50bwogICAgICAgICMgdGhlIG91dHB1dCByZWZlcmVuY2Ugc3lzdGVtIGZvciBlYXNpZXIgbWFuaXB1bGF0aW9uCgogICAgICAgIHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQgPSBOb25lCgogICAgICAgIGlmIHNlbGYub3B0aW9ucy5wcm9maWxlIGluICgnbWVyY2F0b3InLCAnZ2VvZGV0aWMnKToKCiAgICAgICAgICAgIGlmIG5vdCBpbl9zcnM6CiAgICAgICAgICAgICAgICBleGl0X3dpdGhfZXJyb3IoCiAgICAgICAgICAgICAgICAgICAgIklucHV0IGZpbGUgaGFzIHVua25vd24gU1JTLiIsCiAgICAgICAgICAgICAgICAgICAgIlVzZSAtLXNfc3JzIEVTUEc6eHl6IChvciBzaW1pbGFyKSB0byBwcm92aWRlIHNvdXJjZSByZWZlcmVuY2Ugc3lzdGVtLiIpCgogICAgICAgICAgICBpZiBub3QgaGFzX2dlb3JlZmVyZW5jZShpbnB1dF9kYXRhc2V0KToKICAgICAgICAgICAgICAgIGV4aXRfd2l0aF9lcnJvcigKICAgICAgICAgICAgICAgICAgICAiVGhlcmUgaXMgbm8gZ2VvcmVmZXJlbmNlIC0gbmVpdGhlciBhZmZpbmUgdHJhbnNmb3JtYXRpb24gKHdvcmxkZmlsZSkgIgogICAgICAgICAgICAgICAgICAgICJub3IgR0NQcy4gWW91IGNhbiBnZW5lcmF0ZSBvbmx5ICdyYXN0ZXInIHByb2ZpbGUgdGlsZXMuIiwKICAgICAgICAgICAgICAgICAgICAiRWl0aGVyIGdkYWwydGlsZXMgd2l0aCBwYXJhbWV0ZXIgLXAgJ3Jhc3Rlcicgb3IgdXNlIGFub3RoZXIgR0lTICIKICAgICAgICAgICAgICAgICAgICAic29mdHdhcmUgZm9yIGdlb3JlZmVyZW5jZSBlLmcuIGdkYWxfdHJhbnNmb3JtIC1nY3AgLyAtYV91bGxyIC8gLWFfc3JzIgogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgaWYgKChpbl9zcnMuRXhwb3J0VG9Qcm9qNCgpICE9IHNlbGYub3V0X3Nycy5FeHBvcnRUb1Byb2o0KCkpIG9yCiAgICAgICAgICAgICAgICAgICAgKGlucHV0X2RhdGFzZXQuR2V0R0NQQ291bnQoKSAhPSAwKSk6CiAgICAgICAgICAgICAgICBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0ID0gcmVwcm9qZWN0X2RhdGFzZXQoCiAgICAgICAgICAgICAgICAgICAgaW5wdXRfZGF0YXNldCwgaW5fc3JzLCBzZWxmLm91dF9zcnMpCgogICAgICAgICAgICAgICAgaWYgaW5fbm9kYXRhOgogICAgICAgICAgICAgICAgICAgIHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQgPSB1cGRhdGVfbm9fZGF0YV92YWx1ZXMoCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQsIGluX25vZGF0YSwgb3B0aW9ucz1zZWxmLm9wdGlvbnMpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQgPSB1cGRhdGVfYWxwaGFfdmFsdWVfZm9yX25vbl9hbHBoYV9pbnB1dHMoCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQsIG9wdGlvbnM9c2VsZi5vcHRpb25zKQoKICAgICAgICAgICAgaWYgc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldCBhbmQgc2VsZi5vcHRpb25zLnZlcmJvc2U6CiAgICAgICAgICAgICAgICBwcmludCgiUHJvamVjdGVkIGZpbGU6IiwgInRpbGVzLnZydCIsICIoICVzUCB4ICVzTCAtICVzIGJhbmRzKSIgJSAoCiAgICAgICAgICAgICAgICAgICAgc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldC5SYXN0ZXJYU2l6ZSwKICAgICAgICAgICAgICAgICAgICBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0LlJhc3RlcllTaXplLAogICAgICAgICAgICAgICAgICAgIHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQuUmFzdGVyQ291bnQpKQoKICAgICAgICBpZiBub3Qgc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldDoKICAgICAgICAgICAgc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldCA9IGlucHV0X2RhdGFzZXQKCiAgICAgICAgI1NhbHZhIG8gYXJxdWl2byByZXByb2pldGFkbwogICAgICAgIHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQuR2V0RHJpdmVyKCkuQ3JlYXRlQ29weShzZWxmLnRtcF92cnRfZmlsZW5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQpCgogICAgICAgICMgR2V0IGFscGhhIGJhbmQgKGVpdGhlciBkaXJlY3RseSBvciBmcm9tIE5PREFUQSB2YWx1ZSkKICAgICAgICBzZWxmLmFscGhhYmFuZCA9IHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQuR2V0UmFzdGVyQmFuZCgxKS5HZXRNYXNrQmFuZCgpCiAgICAgICAgc2VsZi5kYXRhQmFuZHNDb3VudCA9IG5iX2RhdGFfYmFuZHMoc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldCkKCiAgICAgICAgIyBLTUwgdGVzdAogICAgICAgIHNlbGYuaXNlcHNnNDMyNiA9IEZhbHNlCiAgICAgICAgc3JzNDMyNiA9IG9zci5TcGF0aWFsUmVmZXJlbmNlKCkKICAgICAgICBzcnM0MzI2LkltcG9ydEZyb21FUFNHKDQzMjYpCiAgICAgICAgaWYgc2VsZi5vdXRfc3JzIGFuZCBzcnM0MzI2LkV4cG9ydFRvUHJvajQoKSA9PSBzZWxmLm91dF9zcnMuRXhwb3J0VG9Qcm9qNCgpOgogICAgICAgICAgICBzZWxmLmttbCA9IFRydWUKICAgICAgICAgICAgc2VsZi5pc2Vwc2c0MzI2ID0gVHJ1ZQogICAgICAgICAgICBpZiBzZWxmLm9wdGlvbnMudmVyYm9zZToKICAgICAgICAgICAgICAgIHByaW50KCJLTUwgYXV0b3Rlc3QgT0shIikKCiAgICAgICAgIyBSZWFkIHRoZSBnZW9yZWZlcmVuY2UKICAgICAgICBzZWxmLm91dF9ndCA9IHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQuR2V0R2VvVHJhbnNmb3JtKCkKCiAgICAgICAgIyBUZXN0IHRoZSBzaXplIG9mIHRoZSBwaXhlbAoKICAgICAgICAjIFJlcG9ydCBlcnJvciBpbiBjYXNlIHJvdGF0aW9uL3NrZXcgaXMgaW4gZ2VvdHJhbnNmb3JtIChwb3NzaWJsZSBvbmx5IGluICdyYXN0ZXInIHByb2ZpbGUpCiAgICAgICAgaWYgKHNlbGYub3V0X2d0WzJdLCBzZWxmLm91dF9ndFs0XSkgIT0gKDAsIDApOgogICAgICAgICAgICBleGl0X3dpdGhfZXJyb3IoIkdlb3JlZmVyZW5jZSBvZiB0aGUgcmFzdGVyIGNvbnRhaW5zIHJvdGF0aW9uIG9yIHNrZXcuICIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJTdWNoIHJhc3RlciBpcyBub3Qgc3VwcG9ydGVkLiBQbGVhc2UgdXNlIGdkYWx3YXJwIGZpcnN0LiIpCgogICAgICAgICMgSGVyZSB3ZSBleHBlY3Q6IHBpeGVsIGlzIHNxdWFyZSwgbm8gcm90YXRpb24gb24gdGhlIHJhc3RlcgoKICAgICAgICAjIE91dHB1dCBCb3VuZHMgLSBjb29yZGluYXRlcyBpbiB0aGUgb3V0cHV0IFNSUwogICAgICAgIHNlbGYub21pbnggPSBzZWxmLm91dF9ndFswXQogICAgICAgIHNlbGYub21heHggPSBzZWxmLm91dF9ndFswXSArIHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQuUmFzdGVyWFNpemUgKiBzZWxmLm91dF9ndFsxXQogICAgICAgIHNlbGYub21heHkgPSBzZWxmLm91dF9ndFszXQogICAgICAgIHNlbGYub21pbnkgPSBzZWxmLm91dF9ndFszXSAtIHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQuUmFzdGVyWVNpemUgKiBzZWxmLm91dF9ndFsxXQogICAgICAgICMgTm90ZTogbWF5YmUgcm91bmQoeCwgMTQpIHRvIGF2b2lkIHRoZSBnZGFsX3RyYW5zbGF0ZSBiZWhhdmlvdXIsIHdoZW4gMCBiZWNvbWVzIC0xZS0xNQoKICAgICAgICBpZiBzZWxmLm9wdGlvbnMudmVyYm9zZToKICAgICAgICAgICAgcHJpbnQoIkJvdW5kcyAob3V0cHV0IHNycyk6Iiwgcm91bmQoc2VsZi5vbWlueCwgMTMpLCBzZWxmLm9taW55LCBzZWxmLm9tYXh4LCBzZWxmLm9tYXh5KQoKICAgICAgICAjIENhbGN1bGF0aW5nIHJhbmdlcyBmb3IgdGlsZXMgaW4gZGlmZmVyZW50IHpvb20gbGV2ZWxzCiAgICAgICAgaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ21lcmNhdG9yJzoKCiAgICAgICAgICAgIHNlbGYubWVyY2F0b3IgPSBHbG9iYWxNZXJjYXRvcigpCgogICAgICAgICAgICAjIEZ1bmN0aW9uIHdoaWNoIGdlbmVyYXRlcyBTV05FIGluIExhdExvbmcgZm9yIGdpdmVuIHRpbGUKICAgICAgICAgICAgc2VsZi50aWxlc3duZSA9IHNlbGYubWVyY2F0b3IuVGlsZUxhdExvbkJvdW5kcwoKICAgICAgICAgICAgIyBHZW5lcmF0ZSB0YWJsZSB3aXRoIG1pbiBtYXggdGlsZSBjb29yZGluYXRlcyBmb3IgYWxsIHpvb21sZXZlbHMKICAgICAgICAgICAgc2VsZi50bWlubWF4ID0gbGlzdChyYW5nZSgwLCAzMikpCiAgICAgICAgICAgIGZvciB0eiBpbiByYW5nZSgwLCAzMik6CiAgICAgICAgICAgICAgICB0bWlueCwgdG1pbnkgPSBzZWxmLm1lcmNhdG9yLk1ldGVyc1RvVGlsZShzZWxmLm9taW54LCBzZWxmLm9taW55LCB0eikKICAgICAgICAgICAgICAgIHRtYXh4LCB0bWF4eSA9IHNlbGYubWVyY2F0b3IuTWV0ZXJzVG9UaWxlKHNlbGYub21heHgsIHNlbGYub21heHksIHR6KQogICAgICAgICAgICAgICAgIyBjcm9wIHRpbGVzIGV4dGVuZGluZyB3b3JsZCBsaW1pdHMgKCstMTgwLCstOTApCiAgICAgICAgICAgICAgICB0bWlueCwgdG1pbnkgPSBtYXgoMCwgdG1pbngpLCBtYXgoMCwgdG1pbnkpCiAgICAgICAgICAgICAgICB0bWF4eCwgdG1heHkgPSBtaW4oMioqdHotMSwgdG1heHgpLCBtaW4oMioqdHotMSwgdG1heHkpCiAgICAgICAgICAgICAgICBzZWxmLnRtaW5tYXhbdHpdID0gKHRtaW54LCB0bWlueSwgdG1heHgsIHRtYXh5KQoKICAgICAgICAgICAgIyBUT0RPOiBNYXBzIGNyb3NzaW5nIDE4MEUgKEFsYXNrYT8pCgogICAgICAgICAgICAjIEdldCB0aGUgbWluaW1hbCB6b29tIGxldmVsIChtYXAgY292ZXJzIGFyZWEgZXF1aXZhbGVudCB0byBvbmUgdGlsZSkKICAgICAgICAgICAgaWYgc2VsZi50bWlueiBpcyBOb25lOgogICAgICAgICAgICAgICAgc2VsZi50bWlueiA9IHNlbGYubWVyY2F0b3IuWm9vbUZvclBpeGVsU2l6ZSgKICAgICAgICAgICAgICAgICAgICBzZWxmLm91dF9ndFsxXSAqCiAgICAgICAgICAgICAgICAgICAgbWF4KHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQuUmFzdGVyWFNpemUsCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQuUmFzdGVyWVNpemUpIC8KICAgICAgICAgICAgICAgICAgICBmbG9hdChzZWxmLnRpbGVzaXplKSkKCiAgICAgICAgICAgICMgR2V0IHRoZSBtYXhpbWFsIHpvb20gbGV2ZWwKICAgICAgICAgICAgIyAoY2xvc2VzdCBwb3NzaWJsZSB6b29tIGxldmVsIHVwIG9uIHRoZSByZXNvbHV0aW9uIG9mIHJhc3RlcikKICAgICAgICAgICAgaWYgc2VsZi50bWF4eiBpcyBOb25lOgogICAgICAgICAgICAgICAgc2VsZi50bWF4eiA9IHNlbGYubWVyY2F0b3IuWm9vbUZvclBpeGVsU2l6ZShzZWxmLm91dF9ndFsxXSkKCiAgICAgICAgICAgIGlmIHNlbGYub3B0aW9ucy52ZXJib3NlOgogICAgICAgICAgICAgICAgcHJpbnQoIkJvdW5kcyAobGF0bG9uZyk6IiwKICAgICAgICAgICAgICAgICAgICAgIHNlbGYubWVyY2F0b3IuTWV0ZXJzVG9MYXRMb24oc2VsZi5vbWlueCwgc2VsZi5vbWlueSksCiAgICAgICAgICAgICAgICAgICAgICBzZWxmLm1lcmNhdG9yLk1ldGVyc1RvTGF0TG9uKHNlbGYub21heHgsIHNlbGYub21heHkpKQogICAgICAgICAgICAgICAgcHJpbnQoJ01pblpvb21MZXZlbDonLCBzZWxmLnRtaW56KQogICAgICAgICAgICAgICAgcHJpbnQoIk1heFpvb21MZXZlbDoiLAogICAgICAgICAgICAgICAgICAgICAgc2VsZi50bWF4eiwKICAgICAgICAgICAgICAgICAgICAgICIoIiwKICAgICAgICAgICAgICAgICAgICAgIHNlbGYubWVyY2F0b3IuUmVzb2x1dGlvbihzZWxmLnRtYXh6KSwKICAgICAgICAgICAgICAgICAgICAgICIpIikKCiAgICAgICAgaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ2dlb2RldGljJzoKCiAgICAgICAgICAgIHNlbGYuZ2VvZGV0aWMgPSBHbG9iYWxHZW9kZXRpYyhzZWxmLm9wdGlvbnMudG1zY29tcGF0aWJsZSkKCiAgICAgICAgICAgICMgRnVuY3Rpb24gd2hpY2ggZ2VuZXJhdGVzIFNXTkUgaW4gTGF0TG9uZyBmb3IgZ2l2ZW4gdGlsZQogICAgICAgICAgICBzZWxmLnRpbGVzd25lID0gc2VsZi5nZW9kZXRpYy5UaWxlTGF0TG9uQm91bmRzCgogICAgICAgICAgICAjIEdlbmVyYXRlIHRhYmxlIHdpdGggbWluIG1heCB0aWxlIGNvb3JkaW5hdGVzIGZvciBhbGwgem9vbWxldmVscwogICAgICAgICAgICBzZWxmLnRtaW5tYXggPSBsaXN0KHJhbmdlKDAsIDMyKSkKICAgICAgICAgICAgZm9yIHR6IGluIHJhbmdlKDAsIDMyKToKICAgICAgICAgICAgICAgIHRtaW54LCB0bWlueSA9IHNlbGYuZ2VvZGV0aWMuTG9uTGF0VG9UaWxlKHNlbGYub21pbngsIHNlbGYub21pbnksIHR6KQogICAgICAgICAgICAgICAgdG1heHgsIHRtYXh5ID0gc2VsZi5nZW9kZXRpYy5Mb25MYXRUb1RpbGUoc2VsZi5vbWF4eCwgc2VsZi5vbWF4eSwgdHopCiAgICAgICAgICAgICAgICAjIGNyb3AgdGlsZXMgZXh0ZW5kaW5nIHdvcmxkIGxpbWl0cyAoKy0xODAsKy05MCkKICAgICAgICAgICAgICAgIHRtaW54LCB0bWlueSA9IG1heCgwLCB0bWlueCksIG1heCgwLCB0bWlueSkKICAgICAgICAgICAgICAgIHRtYXh4LCB0bWF4eSA9IG1pbigyKioodHorMSktMSwgdG1heHgpLCBtaW4oMioqdHotMSwgdG1heHkpCiAgICAgICAgICAgICAgICBzZWxmLnRtaW5tYXhbdHpdID0gKHRtaW54LCB0bWlueSwgdG1heHgsIHRtYXh5KQoKICAgICAgICAgICAgIyBUT0RPOiBNYXBzIGNyb3NzaW5nIDE4MEUgKEFsYXNrYT8pCgogICAgICAgICAgICAjIEdldCB0aGUgbWF4aW1hbCB6b29tIGxldmVsCiAgICAgICAgICAgICMgKGNsb3Nlc3QgcG9zc2libGUgem9vbSBsZXZlbCB1cCBvbiB0aGUgcmVzb2x1dGlvbiBvZiByYXN0ZXIpCiAgICAgICAgICAgIGlmIHNlbGYudG1pbnogaXMgTm9uZToKICAgICAgICAgICAgICAgIHNlbGYudG1pbnogPSBzZWxmLmdlb2RldGljLlpvb21Gb3JQaXhlbFNpemUoCiAgICAgICAgICAgICAgICAgICAgc2VsZi5vdXRfZ3RbMV0gKgogICAgICAgICAgICAgICAgICAgIG1heChzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0LlJhc3RlclhTaXplLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0LlJhc3RlcllTaXplKSAvCiAgICAgICAgICAgICAgICAgICAgZmxvYXQoc2VsZi50aWxlc2l6ZSkpCgogICAgICAgICAgICAjIEdldCB0aGUgbWF4aW1hbCB6b29tIGxldmVsCiAgICAgICAgICAgICMgKGNsb3Nlc3QgcG9zc2libGUgem9vbSBsZXZlbCB1cCBvbiB0aGUgcmVzb2x1dGlvbiBvZiByYXN0ZXIpCiAgICAgICAgICAgIGlmIHNlbGYudG1heHogaXMgTm9uZToKICAgICAgICAgICAgICAgIHNlbGYudG1heHogPSBzZWxmLmdlb2RldGljLlpvb21Gb3JQaXhlbFNpemUoc2VsZi5vdXRfZ3RbMV0pCgogICAgICAgICAgICBpZiBzZWxmLm9wdGlvbnMudmVyYm9zZToKICAgICAgICAgICAgICAgIHByaW50KCJCb3VuZHMgKGxhdGxvbmcpOiIsIHNlbGYub21pbngsIHNlbGYub21pbnksIHNlbGYub21heHgsIHNlbGYub21heHkpCgogICAgICAgIGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdyYXN0ZXInOgoKICAgICAgICAgICAgZGVmIGxvZzIoeCk6CiAgICAgICAgICAgICAgICByZXR1cm4gbWF0aC5sb2cxMCh4KSAvIG1hdGgubG9nMTAoMikKCiAgICAgICAgICAgIHNlbGYubmF0aXZlem9vbSA9IGludCgKICAgICAgICAgICAgICAgIG1heChtYXRoLmNlaWwobG9nMihzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0LlJhc3RlclhTaXplL2Zsb2F0KHNlbGYudGlsZXNpemUpKSksCiAgICAgICAgICAgICAgICAgICAgbWF0aC5jZWlsKGxvZzIoc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldC5SYXN0ZXJZU2l6ZS9mbG9hdChzZWxmLnRpbGVzaXplKSkpKSkKCiAgICAgICAgICAgIGlmIHNlbGYub3B0aW9ucy52ZXJib3NlOgogICAgICAgICAgICAgICAgcHJpbnQoIk5hdGl2ZSB6b29tIG9mIHRoZSByYXN0ZXI6Iiwgc2VsZi5uYXRpdmV6b29tKQoKICAgICAgICAgICAgIyBHZXQgdGhlIG1pbmltYWwgem9vbSBsZXZlbCAod2hvbGUgcmFzdGVyIGluIG9uZSB0aWxlKQogICAgICAgICAgICBpZiBzZWxmLnRtaW56IGlzIE5vbmU6CiAgICAgICAgICAgICAgICBzZWxmLnRtaW56ID0gMAoKICAgICAgICAgICAgIyBHZXQgdGhlIG1heGltYWwgem9vbSBsZXZlbCAobmF0aXZlIHJlc29sdXRpb24gb2YgdGhlIHJhc3RlcikKICAgICAgICAgICAgaWYgc2VsZi50bWF4eiBpcyBOb25lOgogICAgICAgICAgICAgICAgc2VsZi50bWF4eiA9IHNlbGYubmF0aXZlem9vbQoKICAgICAgICAgICAgIyBHZW5lcmF0ZSB0YWJsZSB3aXRoIG1pbiBtYXggdGlsZSBjb29yZGluYXRlcyBmb3IgYWxsIHpvb21sZXZlbHMKICAgICAgICAgICAgc2VsZi50bWlubWF4ID0gbGlzdChyYW5nZSgwLCBzZWxmLnRtYXh6KzEpKQogICAgICAgICAgICBzZWxmLnRzaXplID0gbGlzdChyYW5nZSgwLCBzZWxmLnRtYXh6KzEpKQogICAgICAgICAgICBmb3IgdHogaW4gcmFuZ2UoMCwgc2VsZi50bWF4eisxKToKICAgICAgICAgICAgICAgIHRzaXplID0gMi4wKiooc2VsZi5uYXRpdmV6b29tLXR6KSpzZWxmLnRpbGVzaXplCiAgICAgICAgICAgICAgICB0bWlueCwgdG1pbnkgPSAwLCAwCiAgICAgICAgICAgICAgICB0bWF4eCA9IGludChtYXRoLmNlaWwoc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldC5SYXN0ZXJYU2l6ZSAvIHRzaXplKSkgLSAxCiAgICAgICAgICAgICAgICB0bWF4eSA9IGludChtYXRoLmNlaWwoc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldC5SYXN0ZXJZU2l6ZSAvIHRzaXplKSkgLSAxCiAgICAgICAgICAgICAgICBzZWxmLnRzaXplW3R6XSA9IG1hdGguY2VpbCh0c2l6ZSkKICAgICAgICAgICAgICAgIHNlbGYudG1pbm1heFt0el0gPSAodG1pbngsIHRtaW55LCB0bWF4eCwgdG1heHkpCgogICAgICAgICAgICAjIEZ1bmN0aW9uIHdoaWNoIGdlbmVyYXRlcyBTV05FIGluIExhdExvbmcgZm9yIGdpdmVuIHRpbGUKICAgICAgICAgICAgaWYgc2VsZi5rbWwgYW5kIHNlbGYuaW5fc3JzX3drdDoKICAgICAgICAgICAgICAgIGN0ID0gb3NyLkNvb3JkaW5hdGVUcmFuc2Zvcm1hdGlvbihpbl9zcnMsIHNyczQzMjYpCgogICAgICAgICAgICAgICAgZGVmIHJhc3RlcnRpbGVzd25lKHgsIHksIHopOgogICAgICAgICAgICAgICAgICAgIHBpeGVsc2l6ZXggPSAoMioqKHNlbGYudG1heHoteikgKiBzZWxmLm91dF9ndFsxXSkgICAgICAgIyBYLXBpeGVsIHNpemUgaW4gbGV2ZWwKICAgICAgICAgICAgICAgICAgICB3ZXN0ID0gc2VsZi5vdXRfZ3RbMF0gKyB4KnNlbGYudGlsZXNpemUqcGl4ZWxzaXpleAogICAgICAgICAgICAgICAgICAgIGVhc3QgPSB3ZXN0ICsgc2VsZi50aWxlc2l6ZSpwaXhlbHNpemV4CiAgICAgICAgICAgICAgICAgICAgc291dGggPSBzZWxmLm9taW55ICsgeSpzZWxmLnRpbGVzaXplKnBpeGVsc2l6ZXgKICAgICAgICAgICAgICAgICAgICBub3J0aCA9IHNvdXRoICsgc2VsZi50aWxlc2l6ZSpwaXhlbHNpemV4CiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuaXNlcHNnNDMyNjoKICAgICAgICAgICAgICAgICAgICAgICAgIyBUcmFuc2Zvcm1hdGlvbiB0byBFUFNHOjQzMjYgKFdHUzg0IGRhdHVtKQogICAgICAgICAgICAgICAgICAgICAgICB3ZXN0LCBzb3V0aCA9IGN0LlRyYW5zZm9ybVBvaW50KHdlc3QsIHNvdXRoKVs6Ml0KICAgICAgICAgICAgICAgICAgICAgICAgZWFzdCwgbm9ydGggPSBjdC5UcmFuc2Zvcm1Qb2ludChlYXN0LCBub3J0aClbOjJdCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNvdXRoLCB3ZXN0LCBub3J0aCwgZWFzdAoKICAgICAgICAgICAgICAgIHNlbGYudGlsZXN3bmUgPSByYXN0ZXJ0aWxlc3duZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi50aWxlc3duZSA9IGxhbWJkYSB4LCB5LCB6OiAoMCwgMCwgMCwgMCkgICAjIG5vcWEKCiAgICBkZWYgZ2VuZXJhdGVfbWV0YWRhdGEoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgR2VuZXJhdGlvbiBvZiBtYWluIG1ldGFkYXRhIGZpbGVzIGFuZCBIVE1MIHZpZXdlcnMgKG1ldGFkYXRhIHJlbGF0ZWQgdG8gcGFydGljdWxhcgogICAgICAgIHRpbGVzIGFyZSBnZW5lcmF0ZWQgZHVyaW5nIHRoZSB0aWxlIHByb2Nlc3NpbmcpLgogICAgICAgICIiIgoKICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoc2VsZi5vdXRwdXRfZm9sZGVyKToKICAgICAgICAgICAgb3MubWFrZWRpcnMoc2VsZi5vdXRwdXRfZm9sZGVyKQoKICAgICAgICBpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAnbWVyY2F0b3InOgoKICAgICAgICAgICAgc291dGgsIHdlc3QgPSBzZWxmLm1lcmNhdG9yLk1ldGVyc1RvTGF0TG9uKHNlbGYub21pbngsIHNlbGYub21pbnkpCiAgICAgICAgICAgIG5vcnRoLCBlYXN0ID0gc2VsZi5tZXJjYXRvci5NZXRlcnNUb0xhdExvbihzZWxmLm9tYXh4LCBzZWxmLm9tYXh5KQogICAgICAgICAgICBzb3V0aCwgd2VzdCA9IG1heCgtODUuMDUxMTI4NzgsIHNvdXRoKSwgbWF4KC0xODAuMCwgd2VzdCkKICAgICAgICAgICAgbm9ydGgsIGVhc3QgPSBtaW4oODUuMDUxMTI4NzgsIG5vcnRoKSwgbWluKDE4MC4wLCBlYXN0KQogICAgICAgICAgICBzZWxmLnN3bmUgPSAoc291dGgsIHdlc3QsIG5vcnRoLCBlYXN0KQoKICAgICAgICAgICAgIyBHZW5lcmF0ZSBnb29nbGVtYXBzLmh0bWwKICAgICAgICAgICAgaWYgc2VsZi5vcHRpb25zLndlYnZpZXdlciBpbiAoJ2FsbCcsICdnb29nbGUnKSBhbmQgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ21lcmNhdG9yJzoKICAgICAgICAgICAgICAgIGlmIChub3Qgc2VsZi5vcHRpb25zLnJlc3VtZSBvciBub3QKICAgICAgICAgICAgICAgICAgICAgICAgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKHNlbGYub3V0cHV0X2ZvbGRlciwgJ2dvb2dsZW1hcHMuaHRtbCcpKSk6CiAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKG9zLnBhdGguam9pbihzZWxmLm91dHB1dF9mb2xkZXIsICdnb29nbGVtYXBzLmh0bWwnKSwgJ3diJykgYXMgZjoKICAgICAgICAgICAgICAgICAgICAgICAgZi53cml0ZShzZWxmLmdlbmVyYXRlX2dvb2dsZW1hcHMoKS5lbmNvZGUoJ3V0Zi04JykpCgogICAgICAgICAgICAjIEdlbmVyYXRlIG9wZW5sYXllcnMuaHRtbAogICAgICAgICAgICBpZiBzZWxmLm9wdGlvbnMud2Vidmlld2VyIGluICgnYWxsJywgJ29wZW5sYXllcnMnKToKICAgICAgICAgICAgICAgIGlmIChub3Qgc2VsZi5vcHRpb25zLnJlc3VtZSBvciBub3QKICAgICAgICAgICAgICAgICAgICAgICAgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKHNlbGYub3V0cHV0X2ZvbGRlciwgJ29wZW5sYXllcnMuaHRtbCcpKSk6CiAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKG9zLnBhdGguam9pbihzZWxmLm91dHB1dF9mb2xkZXIsICdvcGVubGF5ZXJzLmh0bWwnKSwgJ3diJykgYXMgZjoKICAgICAgICAgICAgICAgICAgICAgICAgZi53cml0ZShzZWxmLmdlbmVyYXRlX29wZW5sYXllcnMoKS5lbmNvZGUoJ3V0Zi04JykpCgogICAgICAgICAgICAjIEdlbmVyYXRlIGxlYWZsZXQuaHRtbAogICAgICAgICAgICBpZiBzZWxmLm9wdGlvbnMud2Vidmlld2VyIGluICgnYWxsJywgJ2xlYWZsZXQnKToKICAgICAgICAgICAgICAgIGlmIChub3Qgc2VsZi5vcHRpb25zLnJlc3VtZSBvciBub3QKICAgICAgICAgICAgICAgICAgICAgICAgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKHNlbGYub3V0cHV0X2ZvbGRlciwgJ2xlYWZsZXQuaHRtbCcpKSk6CiAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKG9zLnBhdGguam9pbihzZWxmLm91dHB1dF9mb2xkZXIsICdsZWFmbGV0Lmh0bWwnKSwgJ3diJykgYXMgZjoKICAgICAgICAgICAgICAgICAgICAgICAgZi53cml0ZShzZWxmLmdlbmVyYXRlX2xlYWZsZXQoKS5lbmNvZGUoJ3V0Zi04JykpCgogICAgICAgIGVsaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ2dlb2RldGljJzoKCiAgICAgICAgICAgIHdlc3QsIHNvdXRoID0gc2VsZi5vbWlueCwgc2VsZi5vbWlueQogICAgICAgICAgICBlYXN0LCBub3J0aCA9IHNlbGYub21heHgsIHNlbGYub21heHkKICAgICAgICAgICAgc291dGgsIHdlc3QgPSBtYXgoLTkwLjAsIHNvdXRoKSwgbWF4KC0xODAuMCwgd2VzdCkKICAgICAgICAgICAgbm9ydGgsIGVhc3QgPSBtaW4oOTAuMCwgbm9ydGgpLCBtaW4oMTgwLjAsIGVhc3QpCiAgICAgICAgICAgIHNlbGYuc3duZSA9IChzb3V0aCwgd2VzdCwgbm9ydGgsIGVhc3QpCgogICAgICAgICAgICAjIEdlbmVyYXRlIG9wZW5sYXllcnMuaHRtbAogICAgICAgICAgICBpZiBzZWxmLm9wdGlvbnMud2Vidmlld2VyIGluICgnYWxsJywgJ29wZW5sYXllcnMnKToKICAgICAgICAgICAgICAgIGlmIChub3Qgc2VsZi5vcHRpb25zLnJlc3VtZSBvciBub3QKICAgICAgICAgICAgICAgICAgICAgICAgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKHNlbGYub3V0cHV0X2ZvbGRlciwgJ29wZW5sYXllcnMuaHRtbCcpKSk6CiAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKG9zLnBhdGguam9pbihzZWxmLm91dHB1dF9mb2xkZXIsICdvcGVubGF5ZXJzLmh0bWwnKSwgJ3diJykgYXMgZjoKICAgICAgICAgICAgICAgICAgICAgICAgZi53cml0ZShzZWxmLmdlbmVyYXRlX29wZW5sYXllcnMoKS5lbmNvZGUoJ3V0Zi04JykpCgogICAgICAgIGVsaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ3Jhc3Rlcic6CgogICAgICAgICAgICB3ZXN0LCBzb3V0aCA9IHNlbGYub21pbngsIHNlbGYub21pbnkKICAgICAgICAgICAgZWFzdCwgbm9ydGggPSBzZWxmLm9tYXh4LCBzZWxmLm9tYXh5CgogICAgICAgICAgICBzZWxmLnN3bmUgPSAoc291dGgsIHdlc3QsIG5vcnRoLCBlYXN0KQoKICAgICAgICAgICAgIyBHZW5lcmF0ZSBvcGVubGF5ZXJzLmh0bWwKICAgICAgICAgICAgaWYgc2VsZi5vcHRpb25zLndlYnZpZXdlciBpbiAoJ2FsbCcsICdvcGVubGF5ZXJzJyk6CiAgICAgICAgICAgICAgICBpZiAobm90IHNlbGYub3B0aW9ucy5yZXN1bWUgb3Igbm90CiAgICAgICAgICAgICAgICAgICAgICAgIG9zLnBhdGguZXhpc3RzKG9zLnBhdGguam9pbihzZWxmLm91dHB1dF9mb2xkZXIsICdvcGVubGF5ZXJzLmh0bWwnKSkpOgogICAgICAgICAgICAgICAgICAgIHdpdGggb3Blbihvcy5wYXRoLmpvaW4oc2VsZi5vdXRwdXRfZm9sZGVyLCAnb3BlbmxheWVycy5odG1sJyksICd3YicpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgICAgIGYud3JpdGUoc2VsZi5nZW5lcmF0ZV9vcGVubGF5ZXJzKCkuZW5jb2RlKCd1dGYtOCcpKQoKICAgICAgICAjIEdlbmVyYXRlIHRpbGVtYXByZXNvdXJjZS54bWwuCiAgICAgICAgaWYgbm90IHNlbGYub3B0aW9ucy5yZXN1bWUgb3Igbm90IG9zLnBhdGguZXhpc3RzKG9zLnBhdGguam9pbihzZWxmLm91dHB1dF9mb2xkZXIsICd0aWxlbWFwcmVzb3VyY2UueG1sJykpOgogICAgICAgICAgICB3aXRoIG9wZW4ob3MucGF0aC5qb2luKHNlbGYub3V0cHV0X2ZvbGRlciwgJ3RpbGVtYXByZXNvdXJjZS54bWwnKSwgJ3diJykgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGUoc2VsZi5nZW5lcmF0ZV90aWxlbWFwcmVzb3VyY2UoKS5lbmNvZGUoJ3V0Zi04JykpCgogICAgICAgIGlmIHNlbGYua21sOgogICAgICAgICAgICAjIFRPRE86IE1heWJlIHByb2JsZW0gZm9yIG5vdCBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCB0bWluegogICAgICAgICAgICAjIFRoZSByb290IEtNTCBzaG91bGQgY29udGFpbiBsaW5rcyB0byBhbGwgdGlsZXMgaW4gdGhlIHRtaW56IGxldmVsCiAgICAgICAgICAgIGNoaWxkcmVuID0gW10KICAgICAgICAgICAgeG1pbiwgeW1pbiwgeG1heCwgeW1heCA9IHNlbGYudG1pbm1heFtzZWxmLnRtaW56XQogICAgICAgICAgICBmb3IgeCBpbiByYW5nZSh4bWluLCB4bWF4KzEpOgogICAgICAgICAgICAgICAgZm9yIHkgaW4gcmFuZ2UoeW1pbiwgeW1heCsxKToKICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbi5hcHBlbmQoW3gsIHksIHNlbGYudG1pbnpdKQogICAgICAgICAgICAjIEdlbmVyYXRlIFJvb3QgS01MCiAgICAgICAgICAgIGlmIHNlbGYua21sOgogICAgICAgICAgICAgICAgaWYgKG5vdCBzZWxmLm9wdGlvbnMucmVzdW1lIG9yIG5vdAogICAgICAgICAgICAgICAgICAgICAgICBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4oc2VsZi5vdXRwdXRfZm9sZGVyLCAnZG9jLmttbCcpKSk6CiAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKG9zLnBhdGguam9pbihzZWxmLm91dHB1dF9mb2xkZXIsICdkb2Mua21sJyksICd3YicpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgICAgIGYud3JpdGUoZ2VuZXJhdGVfa21sKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgTm9uZSwgTm9uZSwgTm9uZSwgc2VsZi50aWxlZXh0LCBzZWxmLnRpbGVzaXplLCBzZWxmLnRpbGVzd25lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5vcHRpb25zLCBjaGlsZHJlbgogICAgICAgICAgICAgICAgICAgICAgICApLmVuY29kZSgndXRmLTgnKSkKCiAgICBkZWYgZ2VuZXJhdGVfYmFzZV90aWxlcyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBHZW5lcmF0aW9uIG9mIHRoZSBiYXNlIHRpbGVzICh0aGUgbG93ZXN0IGluIHRoZSBweXJhbWlkKSBkaXJlY3RseSBmcm9tIHRoZSBpbnB1dCByYXN0ZXIKICAgICAgICAiIiIKCiAgICAgICAgaWYgbm90IHNlbGYub3B0aW9ucy5xdWlldDoKICAgICAgICAgICAgcHJpbnQoIkdlbmVyYXRpbmcgQmFzZSBUaWxlczoiKQoKICAgICAgICBpZiBzZWxmLm9wdGlvbnMudmVyYm9zZToKICAgICAgICAgICAgcHJpbnQoJycpCiAgICAgICAgICAgIHByaW50KCJUaWxlcyBnZW5lcmF0ZWQgZnJvbSB0aGUgbWF4IHpvb20gbGV2ZWw6IikKICAgICAgICAgICAgcHJpbnQoIi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0iKQogICAgICAgICAgICBwcmludCgnJykKCiAgICAgICAgIyBTZXQgdGhlIGJvdW5kcwogICAgICAgIHRtaW54LCB0bWlueSwgdG1heHgsIHRtYXh5ID0gc2VsZi50bWlubWF4W3NlbGYudG1heHpdCgogICAgICAgIGRzID0gc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldAogICAgICAgIHRpbGViYW5kcyA9IHNlbGYuZGF0YUJhbmRzQ291bnQgKyAxCiAgICAgICAgcXVlcnlzaXplID0gc2VsZi5xdWVyeXNpemUKCiAgICAgICAgaWYgc2VsZi5vcHRpb25zLnZlcmJvc2U6CiAgICAgICAgICAgIHByaW50KCJkYXRhQmFuZHNDb3VudDogIiwgc2VsZi5kYXRhQmFuZHNDb3VudCkKICAgICAgICAgICAgcHJpbnQoInRpbGViYW5kczogIiwgdGlsZWJhbmRzKQoKICAgICAgICB0Y291bnQgPSAoMSthYnModG1heHgtdG1pbngpKSAqICgxK2Ficyh0bWF4eS10bWlueSkpCiAgICAgICAgdGkgPSAwCgogICAgICAgIHRpbGVfZGV0YWlscyA9IFtdCgogICAgICAgIHR6ID0gc2VsZi50bWF4egogICAgICAgIGZvciB0eSBpbiByYW5nZSh0bWF4eSwgdG1pbnktMSwgLTEpOgogICAgICAgICAgICBmb3IgdHggaW4gcmFuZ2UodG1pbngsIHRtYXh4KzEpOgoKICAgICAgICAgICAgICAgIHRpICs9IDEKICAgICAgICAgICAgICAgIHl0aWxlID0gR0RBTDJUaWxlcy5nZXRZdGlsZSh0eSwgdHosIHNlbGYub3B0aW9ucykKICAgICAgICAgICAgICAgIHRpbGVmaWxlbmFtZSA9IG9zLnBhdGguam9pbigKICAgICAgICAgICAgICAgICAgICBzZWxmLm91dHB1dF9mb2xkZXIsIHN0cih0eiksICd7MDowNGR9Jy5mb3JtYXQodHgpICsgIl8iICsgJ3swOjA0ZH0nLmZvcm1hdCh5dGlsZSkgKyAiLiIgKyBzZWxmLnRpbGVleHQpCiAgICAgICAgICAgICAgICBpZiBzZWxmLm9wdGlvbnMudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICBwcmludCh0aSwgJy8nLCB0Y291bnQsIHRpbGVmaWxlbmFtZSkKCiAgICAgICAgICAgICAgICBpZiBzZWxmLm9wdGlvbnMucmVzdW1lIGFuZCBvcy5wYXRoLmV4aXN0cyh0aWxlZmlsZW5hbWUpOgogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYub3B0aW9ucy52ZXJib3NlOgogICAgICAgICAgICAgICAgICAgICAgICBwcmludCgiVGlsZSBnZW5lcmF0aW9uIHNraXBwZWQgYmVjYXVzZSBvZiAtLXJlc3VtZSIpCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICAgICAjIENyZWF0ZSBkaXJlY3RvcmllcyBmb3IgdGhlIHRpbGUKICAgICAgICAgICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmRpcm5hbWUodGlsZWZpbGVuYW1lKSk6CiAgICAgICAgICAgICAgICAgICAgb3MubWFrZWRpcnMob3MucGF0aC5kaXJuYW1lKHRpbGVmaWxlbmFtZSkpCgogICAgICAgICAgICAgICAgaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ21lcmNhdG9yJzoKICAgICAgICAgICAgICAgICAgICAjIFRpbGUgYm91bmRzIGluIEVQU0c6Mzg1NwogICAgICAgICAgICAgICAgICAgIGIgPSBzZWxmLm1lcmNhdG9yLlRpbGVCb3VuZHModHgsIHR5LCB0eikKICAgICAgICAgICAgICAgIGVsaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ2dlb2RldGljJzoKICAgICAgICAgICAgICAgICAgICBiID0gc2VsZi5nZW9kZXRpYy5UaWxlQm91bmRzKHR4LCB0eSwgdHopCgogICAgICAgICAgICAgICAgIyBEb24ndCBzY2FsZSB1cCBieSBuZWFyZXN0IG5laWdoYm91ciwgYmV0dGVyIGNoYW5nZSB0aGUgcXVlcnlzaXplCiAgICAgICAgICAgICAgICAjIHRvIHRoZSBuYXRpdmUgcmVzb2x1dGlvbiAoYW5kIHJldHVybiBzbWFsbGVyIHF1ZXJ5IHRpbGUpIGZvciBzY2FsaW5nCgogICAgICAgICAgICAgICAgaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgaW4gKCdtZXJjYXRvcicsICdnZW9kZXRpYycpOgogICAgICAgICAgICAgICAgICAgIHJiLCB3YiA9IHNlbGYuZ2VvX3F1ZXJ5KGRzLCBiWzBdLCBiWzNdLCBiWzJdLCBiWzFdKQoKICAgICAgICAgICAgICAgICAgICAjIFBpeGVsIHNpemUgaW4gdGhlIHJhc3RlciBjb3ZlcmluZyBxdWVyeSBnZW8gZXh0ZW50CiAgICAgICAgICAgICAgICAgICAgbmF0aXZlc2l6ZSA9IHdiWzBdICsgd2JbMl0KICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLm9wdGlvbnMudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQoIlx0TmF0aXZlIEV4dGVudCAocXVlcnlzaXplIiwgbmF0aXZlc2l6ZSwgIik6ICIsIHJiLCB3YikKCiAgICAgICAgICAgICAgICAgICAgIyBUaWxlIGJvdW5kcyBpbiByYXN0ZXIgY29vcmRpbmF0ZXMgZm9yIFJlYWRSYXN0ZXIgcXVlcnkKICAgICAgICAgICAgICAgICAgICByYiwgd2IgPSBzZWxmLmdlb19xdWVyeShkcywgYlswXSwgYlszXSwgYlsyXSwgYlsxXSwgcXVlcnlzaXplPXF1ZXJ5c2l6ZSkKCiAgICAgICAgICAgICAgICAgICAgcngsIHJ5LCByeHNpemUsIHJ5c2l6ZSA9IHJiCiAgICAgICAgICAgICAgICAgICAgd3gsIHd5LCB3eHNpemUsIHd5c2l6ZSA9IHdiCgogICAgICAgICAgICAgICAgZWxzZTogICAgICMgJ3Jhc3RlcicgcHJvZmlsZToKCiAgICAgICAgICAgICAgICAgICAgdHNpemUgPSBpbnQoc2VsZi50c2l6ZVt0el0pICAgIyB0aWxlc2l6ZSBpbiByYXN0ZXIgY29vcmRpbmF0ZXMgZm9yIGFjdHVhbCB6b29tCiAgICAgICAgICAgICAgICAgICAgeHNpemUgPSBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0LlJhc3RlclhTaXplICAgICAjIHNpemUgb2YgdGhlIHJhc3RlciBpbiBwaXhlbHMKICAgICAgICAgICAgICAgICAgICB5c2l6ZSA9IHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQuUmFzdGVyWVNpemUKICAgICAgICAgICAgICAgICAgICBpZiB0eiA+PSBzZWxmLm5hdGl2ZXpvb206CiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXJ5c2l6ZSA9IHNlbGYudGlsZXNpemUKCiAgICAgICAgICAgICAgICAgICAgcnggPSAodHgpICogdHNpemUKICAgICAgICAgICAgICAgICAgICByeHNpemUgPSAwCiAgICAgICAgICAgICAgICAgICAgaWYgdHggPT0gdG1heHg6CiAgICAgICAgICAgICAgICAgICAgICAgIHJ4c2l6ZSA9IHhzaXplICUgdHNpemUKICAgICAgICAgICAgICAgICAgICBpZiByeHNpemUgPT0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgcnhzaXplID0gdHNpemUKCiAgICAgICAgICAgICAgICAgICAgcnlzaXplID0gMAogICAgICAgICAgICAgICAgICAgIGlmIHR5ID09IHRtYXh5OgogICAgICAgICAgICAgICAgICAgICAgICByeXNpemUgPSB5c2l6ZSAlIHRzaXplCiAgICAgICAgICAgICAgICAgICAgaWYgcnlzaXplID09IDA6CiAgICAgICAgICAgICAgICAgICAgICAgIHJ5c2l6ZSA9IHRzaXplCiAgICAgICAgICAgICAgICAgICAgcnkgPSB5c2l6ZSAtICh0eSAqIHRzaXplKSAtIHJ5c2l6ZQoKICAgICAgICAgICAgICAgICAgICB3eCwgd3kgPSAwLCAwCiAgICAgICAgICAgICAgICAgICAgd3hzaXplID0gaW50KHJ4c2l6ZS9mbG9hdCh0c2l6ZSkgKiBzZWxmLnRpbGVzaXplKQogICAgICAgICAgICAgICAgICAgIHd5c2l6ZSA9IGludChyeXNpemUvZmxvYXQodHNpemUpICogc2VsZi50aWxlc2l6ZSkKICAgICAgICAgICAgICAgICAgICBpZiB3eXNpemUgIT0gc2VsZi50aWxlc2l6ZToKICAgICAgICAgICAgICAgICAgICAgICAgd3kgPSBzZWxmLnRpbGVzaXplIC0gd3lzaXplCgogICAgICAgICAgICAgICAgIyBSZWFkIHRoZSBzb3VyY2UgcmFzdGVyIGlmIGFueXRoaW5nIGlzIGdvaW5nIGluc2lkZSB0aGUgdGlsZSBhcyBwZXIgdGhlIGNvbXB1dGVkCiAgICAgICAgICAgICAgICAjIGdlb19xdWVyeQogICAgICAgICAgICAgICAgdGlsZV9kZXRhaWxzLmFwcGVuZCgKICAgICAgICAgICAgICAgICAgICBUaWxlRGV0YWlsKAogICAgICAgICAgICAgICAgICAgICAgICB0eD10eCwgdHk9eXRpbGUsIHR6PXR6LCByeD1yeCwgcnk9cnksIHJ4c2l6ZT1yeHNpemUsIHJ5c2l6ZT1yeXNpemUsIHd4PXd4LAogICAgICAgICAgICAgICAgICAgICAgICB3eT13eSwgd3hzaXplPXd4c2l6ZSwgd3lzaXplPXd5c2l6ZSwgcXVlcnlzaXplPXF1ZXJ5c2l6ZSwKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICApCgogICAgICAgIGNvbmYgPSBUaWxlSm9iSW5mbygKICAgICAgICAgICAgc3JjX2ZpbGU9c2VsZi50bXBfdnJ0X2ZpbGVuYW1lLAogICAgICAgICAgICBuYl9kYXRhX2JhbmRzPXNlbGYuZGF0YUJhbmRzQ291bnQsCiAgICAgICAgICAgIG91dHB1dF9maWxlX3BhdGg9c2VsZi5vdXRwdXRfZm9sZGVyLAogICAgICAgICAgICB0aWxlX2V4dGVuc2lvbj1zZWxmLnRpbGVleHQsCiAgICAgICAgICAgIHRpbGVfZHJpdmVyPXNlbGYudGlsZWRyaXZlciwKICAgICAgICAgICAgdGlsZV9zaXplPXNlbGYudGlsZXNpemUsCiAgICAgICAgICAgIGttbD1zZWxmLmttbCwKICAgICAgICAgICAgdG1pbm1heD1zZWxmLnRtaW5tYXgsCiAgICAgICAgICAgIHRtaW56PXNlbGYudG1pbnosCiAgICAgICAgICAgIHRtYXh6PXNlbGYudG1heHosCiAgICAgICAgICAgIGluX3Nyc193a3Q9c2VsZi5pbl9zcnNfd2t0LAogICAgICAgICAgICBvdXRfZ2VvX3RyYW5zPXNlbGYub3V0X2d0LAogICAgICAgICAgICBvbWlueT1zZWxmLm9taW55LAogICAgICAgICAgICBpc19lcHNnXzQzMjY9c2VsZi5pc2Vwc2c0MzI2LAogICAgICAgICAgICBvcHRpb25zPXNlbGYub3B0aW9ucywKICAgICAgICApCgogICAgICAgIHJldHVybiBjb25mLCB0aWxlX2RldGFpbHMKCiAgICBkZWYgZ2VvX3F1ZXJ5KHNlbGYsIGRzLCB1bHgsIHVseSwgbHJ4LCBscnksIHF1ZXJ5c2l6ZT0wKToKICAgICAgICAiIiIKICAgICAgICBGb3IgZ2l2ZW4gZGF0YXNldCBhbmQgcXVlcnkgaW4gY2FydG9ncmFwaGljIGNvb3JkaW5hdGVzIHJldHVybnMgcGFyYW1ldGVycyBmb3IgUmVhZFJhc3RlcigpCiAgICAgICAgaW4gcmFzdGVyIGNvb3JkaW5hdGVzIGFuZCB4L3kgc2hpZnRzIChmb3IgYm9yZGVyIHRpbGVzKS4gSWYgdGhlIHF1ZXJ5c2l6ZSBpcyBub3QgZ2l2ZW4sIHRoZQogICAgICAgIGV4dGVudCBpcyByZXR1cm5lZCBpbiB0aGUgbmF0aXZlIHJlc29sdXRpb24gb2YgZGF0YXNldCBkcy4KCiAgICAgICAgcmFpc2VzIEdkYWwyVGlsZXNFcnJvciBpZiB0aGUgZGF0YXNldCBkb2VzIG5vdCBjb250YWluIGFueXRoaW5nIGluc2lkZSB0aGlzIGdlb19xdWVyeQogICAgICAgICIiIgogICAgICAgIGdlb3RyYW4gPSBkcy5HZXRHZW9UcmFuc2Zvcm0oKQogICAgICAgIHJ4ID0gaW50KCh1bHggLSBnZW90cmFuWzBdKSAvIGdlb3RyYW5bMV0gKyAwLjAwMSkKICAgICAgICByeSA9IGludCgodWx5IC0gZ2VvdHJhblszXSkgLyBnZW90cmFuWzVdICsgMC4wMDEpCiAgICAgICAgcnhzaXplID0gaW50KChscnggLSB1bHgpIC8gZ2VvdHJhblsxXSArIDAuNSkKICAgICAgICByeXNpemUgPSBpbnQoKGxyeSAtIHVseSkgLyBnZW90cmFuWzVdICsgMC41KQoKICAgICAgICBpZiBub3QgcXVlcnlzaXplOgogICAgICAgICAgICB3eHNpemUsIHd5c2l6ZSA9IHJ4c2l6ZSwgcnlzaXplCiAgICAgICAgZWxzZToKICAgICAgICAgICAgd3hzaXplLCB3eXNpemUgPSBxdWVyeXNpemUsIHF1ZXJ5c2l6ZQoKICAgICAgICAjIENvb3JkaW5hdGVzIHNob3VsZCBub3QgZ28gb3V0IG9mIHRoZSBib3VuZHMgb2YgdGhlIHJhc3RlcgogICAgICAgIHd4ID0gMAogICAgICAgIGlmIHJ4IDwgMDoKICAgICAgICAgICAgcnhzaGlmdCA9IGFicyhyeCkKICAgICAgICAgICAgd3ggPSBpbnQod3hzaXplICogKGZsb2F0KHJ4c2hpZnQpIC8gcnhzaXplKSkKICAgICAgICAgICAgd3hzaXplID0gd3hzaXplIC0gd3gKICAgICAgICAgICAgcnhzaXplID0gcnhzaXplIC0gaW50KHJ4c2l6ZSAqIChmbG9hdChyeHNoaWZ0KSAvIHJ4c2l6ZSkpCiAgICAgICAgICAgIHJ4ID0gMAogICAgICAgIGlmIHJ4K3J4c2l6ZSA+IGRzLlJhc3RlclhTaXplOgogICAgICAgICAgICB3eHNpemUgPSBpbnQod3hzaXplICogKGZsb2F0KGRzLlJhc3RlclhTaXplIC0gcngpIC8gcnhzaXplKSkKICAgICAgICAgICAgcnhzaXplID0gZHMuUmFzdGVyWFNpemUgLSByeAoKICAgICAgICB3eSA9IDAKICAgICAgICBpZiByeSA8IDA6CiAgICAgICAgICAgIHJ5c2hpZnQgPSBhYnMocnkpCiAgICAgICAgICAgIHd5ID0gaW50KHd5c2l6ZSAqIChmbG9hdChyeXNoaWZ0KSAvIHJ5c2l6ZSkpCiAgICAgICAgICAgIHd5c2l6ZSA9IHd5c2l6ZSAtIHd5CiAgICAgICAgICAgIHJ5c2l6ZSA9IHJ5c2l6ZSAtIGludChyeXNpemUgKiAoZmxvYXQocnlzaGlmdCkgLyByeXNpemUpKQogICAgICAgICAgICByeSA9IDAKICAgICAgICBpZiByeStyeXNpemUgPiBkcy5SYXN0ZXJZU2l6ZToKICAgICAgICAgICAgd3lzaXplID0gaW50KHd5c2l6ZSAqIChmbG9hdChkcy5SYXN0ZXJZU2l6ZSAtIHJ5KSAvIHJ5c2l6ZSkpCiAgICAgICAgICAgIHJ5c2l6ZSA9IGRzLlJhc3RlcllTaXplIC0gcnkKCiAgICAgICAgcmV0dXJuIChyeCwgcnksIHJ4c2l6ZSwgcnlzaXplKSwgKHd4LCB3eSwgd3hzaXplLCB3eXNpemUpCgogICAgZGVmIGdlbmVyYXRlX3RpbGVtYXByZXNvdXJjZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBUZW1wbGF0ZSBmb3IgdGlsZW1hcHJlc291cmNlLnhtbC4gUmV0dXJucyBmaWxsZWQgc3RyaW5nLiBFeHBlY3RlZCB2YXJpYWJsZXM6CiAgICAgICAgICB0aXRsZSwgbm9ydGgsIHNvdXRoLCBlYXN0LCB3ZXN0LCBpc2Vwc2c0MzI2LCBwcm9qZWN0aW9uLCBwdWJsaXNodXJsLAogICAgICAgICAgem9vbXBpeGVscywgdGlsZXNpemUsIHRpbGVmb3JtYXQsIHByb2ZpbGUKICAgICAgICAiIiIKCiAgICAgICAgYXJncyA9IHt9CiAgICAgICAgYXJnc1sndGl0bGUnXSA9IHNlbGYub3B0aW9ucy50aXRsZQogICAgICAgIGFyZ3NbJ3NvdXRoJ10sIGFyZ3NbJ3dlc3QnXSwgYXJnc1snbm9ydGgnXSwgYXJnc1snZWFzdCddID0gc2VsZi5zd25lCiAgICAgICAgYXJnc1sndGlsZXNpemUnXSA9IHNlbGYudGlsZXNpemUKICAgICAgICBhcmdzWyd0aWxlZm9ybWF0J10gPSBzZWxmLnRpbGVleHQKICAgICAgICBhcmdzWydwdWJsaXNodXJsJ10gPSBzZWxmLm9wdGlvbnMudXJsCiAgICAgICAgYXJnc1sncHJvZmlsZSddID0gc2VsZi5vcHRpb25zLnByb2ZpbGUKCiAgICAgICAgaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ21lcmNhdG9yJzoKICAgICAgICAgICAgYXJnc1snc3JzJ10gPSAiRVBTRzozODU3IgogICAgICAgIGVsaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ2dlb2RldGljJzoKICAgICAgICAgICAgYXJnc1snc3JzJ10gPSAiRVBTRzo0MzI2IgogICAgICAgIGVsaWYgc2VsZi5vcHRpb25zLnNfc3JzOgogICAgICAgICAgICBhcmdzWydzcnMnXSA9IHNlbGYub3B0aW9ucy5zX3NycwogICAgICAgIGVsaWYgc2VsZi5vdXRfc3JzOgogICAgICAgICAgICBhcmdzWydzcnMnXSA9IHNlbGYub3V0X3Nycy5FeHBvcnRUb1drdCgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgYXJnc1snc3JzJ10gPSAiIgoKICAgICAgICBzID0gIiIiPD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KICAgIDxUaWxlTWFwIHZlcnNpb249IjEuMC4wIiB0aWxlbWFwc2VydmljZT0iaHR0cDovL3Rtcy5vc2dlby5vcmcvMS4wLjAiPgogICAgICA8VGl0bGU+JSh0aXRsZSlzPC9UaXRsZT4KICAgICAgPEFic3RyYWN0PjwvQWJzdHJhY3Q+CiAgICAgIDxTUlM+JShzcnMpczwvU1JTPgogICAgICA8Qm91bmRpbmdCb3ggbWlueD0iJSh3ZXN0KS4xNGYiIG1pbnk9IiUoc291dGgpLjE0ZiIgbWF4eD0iJShlYXN0KS4xNGYiIG1heHk9IiUobm9ydGgpLjE0ZiIvPgogICAgICA8T3JpZ2luIHg9IiUod2VzdCkuMTRmIiB5PSIlKHNvdXRoKS4xNGYiLz4KICAgICAgPFRpbGVGb3JtYXQgd2lkdGg9IiUodGlsZXNpemUpZCIgaGVpZ2h0PSIlKHRpbGVzaXplKWQiIG1pbWUtdHlwZT0iaW1hZ2UvJSh0aWxlZm9ybWF0KXMiIGV4dGVuc2lvbj0iJSh0aWxlZm9ybWF0KXMiLz4KICAgICAgPFRpbGVTZXRzIHByb2ZpbGU9IiUocHJvZmlsZSlzIj4KIiIiICUgYXJncyAgICAjIG5vcWEKICAgICAgICBmb3IgeiBpbiByYW5nZShzZWxmLnRtaW56LCBzZWxmLnRtYXh6KzEpOgogICAgICAgICAgICBpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAncmFzdGVyJzoKICAgICAgICAgICAgICAgIHMgKz0gIiIiICAgICAgICA8VGlsZVNldCBocmVmPSIlcyVkIiB1bml0cy1wZXItcGl4ZWw9IiUuMTRmIiBvcmRlcj0iJWQiLz5cbiIiIiAlICgKICAgICAgICAgICAgICAgICAgICBhcmdzWydwdWJsaXNodXJsJ10sIHosICgyKiooc2VsZi5uYXRpdmV6b29tLXopICogc2VsZi5vdXRfZ3RbMV0pLCB6KQogICAgICAgICAgICBlbGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdtZXJjYXRvcic6CiAgICAgICAgICAgICAgICBzICs9ICIiIiAgICAgICAgPFRpbGVTZXQgaHJlZj0iJXMlZCIgdW5pdHMtcGVyLXBpeGVsPSIlLjE0ZiIgb3JkZXI9IiVkIi8+XG4iIiIgJSAoCiAgICAgICAgICAgICAgICAgICAgYXJnc1sncHVibGlzaHVybCddLCB6LCAxNTY1NDMuMDMzOS8yKip6LCB6KQogICAgICAgICAgICBlbGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdnZW9kZXRpYyc6CiAgICAgICAgICAgICAgICBzICs9ICIiIiAgICAgICAgPFRpbGVTZXQgaHJlZj0iJXMlZCIgdW5pdHMtcGVyLXBpeGVsPSIlLjE0ZiIgb3JkZXI9IiVkIi8+XG4iIiIgJSAoCiAgICAgICAgICAgICAgICAgICAgYXJnc1sncHVibGlzaHVybCddLCB6LCAwLjcwMzEyNS8yKip6LCB6KQogICAgICAgIHMgKz0gIiIiICAgICAgPC9UaWxlU2V0cz4KICAgIDwvVGlsZU1hcD4KICAgICIiIgogICAgICAgIHJldHVybiBzCgogICAgZGVmIGdlbmVyYXRlX2dvb2dsZW1hcHMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgVGVtcGxhdGUgZm9yIGdvb2dsZW1hcHMuaHRtbCBpbXBsZW1lbnRpbmcgT3ZlcmxheSBvZiB0aWxlcyBmb3IgJ21lcmNhdG9yJyBwcm9maWxlLgogICAgICAgIEl0IHJldHVybnMgZmlsbGVkIHN0cmluZy4gRXhwZWN0ZWQgdmFyaWFibGVzOgogICAgICAgIHRpdGxlLCBnb29nbGVtYXBza2V5LCBub3J0aCwgc291dGgsIGVhc3QsIHdlc3QsIG1pbnpvb20sIG1heHpvb20sIHRpbGVzaXplLCB0aWxlZm9ybWF0LAogICAgICAgIHB1Ymxpc2h1cmwKICAgICAgICAiIiIKICAgICAgICBhcmdzID0ge30KICAgICAgICBhcmdzWyd0aXRsZSddID0gc2VsZi5vcHRpb25zLnRpdGxlCiAgICAgICAgYXJnc1snZ29vZ2xlbWFwc2tleSddID0gc2VsZi5vcHRpb25zLmdvb2dsZWtleQogICAgICAgIGFyZ3NbJ3NvdXRoJ10sIGFyZ3NbJ3dlc3QnXSwgYXJnc1snbm9ydGgnXSwgYXJnc1snZWFzdCddID0gc2VsZi5zd25lCiAgICAgICAgYXJnc1snbWluem9vbSddID0gc2VsZi50bWluegogICAgICAgIGFyZ3NbJ21heHpvb20nXSA9IHNlbGYudG1heHoKICAgICAgICBhcmdzWyd0aWxlc2l6ZSddID0gc2VsZi50aWxlc2l6ZQogICAgICAgIGFyZ3NbJ3RpbGVmb3JtYXQnXSA9IHNlbGYudGlsZWV4dAogICAgICAgIGFyZ3NbJ3B1Ymxpc2h1cmwnXSA9IHNlbGYub3B0aW9ucy51cmwKICAgICAgICBhcmdzWydjb3B5cmlnaHQnXSA9IHNlbGYub3B0aW9ucy5jb3B5cmlnaHQKCiAgICAgICAgcyA9IHIiIiI8IURPQ1RZUEUgaHRtbCBQVUJMSUMgIi0vL1czQy8vRFREIFhIVE1MIDEuMCBTdHJpY3QvL0VOIiAiaHR0cDovL3d3dy53My5vcmcvVFIveGh0bWwxL0RURC94aHRtbDEtc3RyaWN0LmR0ZCI+CiAgICAgICAgICAgIDxodG1sIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiB4bWxuczp2PSJ1cm46c2NoZW1hcy1taWNyb3NvZnQtY29tOnZtbCI+CiAgICAgICAgICAgICAgPGhlYWQ+CiAgICAgICAgICAgICAgICA8dGl0bGU+JSh0aXRsZSlzPC90aXRsZT4KICAgICAgICAgICAgICAgIDxtZXRhIGh0dHAtZXF1aXY9ImNvbnRlbnQtdHlwZSIgY29udGVudD0idGV4dC9odG1sOyBjaGFyc2V0PXV0Zi04Ii8+CiAgICAgICAgICAgICAgICA8bWV0YSBodHRwLWVxdWl2PSdpbWFnZXRvb2xiYXInIGNvbnRlbnQ9J25vJy8+CiAgICAgICAgICAgICAgICA8c3R5bGUgdHlwZT0idGV4dC9jc3MiPiB2XDoqIHtiZWhhdmlvcjp1cmwoI2RlZmF1bHQjVk1MKTt9CiAgICAgICAgICAgICAgICAgICAgaHRtbCwgYm9keSB7IG92ZXJmbG93OiBoaWRkZW47IHBhZGRpbmc6IDA7IGhlaWdodDogMTAwJSU7IHdpZHRoOiAxMDAlJTsgZm9udC1mYW1pbHk6ICdMdWNpZGEgR3JhbmRlJyxHZW5ldmEsQXJpYWwsVmVyZGFuYSxzYW5zLXNlcmlmOyB9CiAgICAgICAgICAgICAgICAgICAgYm9keSB7IG1hcmdpbjogMTBweDsgYmFja2dyb3VuZDogI2ZmZjsgfQogICAgICAgICAgICAgICAgICAgIGgxIHsgbWFyZ2luOiAwOyBwYWRkaW5nOiA2cHg7IGJvcmRlcjowOyBmb250LXNpemU6IDIwcHQ7IH0KICAgICAgICAgICAgICAgICAgICAjaGVhZGVyIHsgaGVpZ2h0OiA0M3B4OyBwYWRkaW5nOiAwOyBiYWNrZ3JvdW5kLWNvbG9yOiAjZWVlOyBib3JkZXI6IDFweCBzb2xpZCAjODg4OyB9CiAgICAgICAgICAgICAgI3N1YmhlYWRlciB7IGhlaWdodDogMTJweDsgdGV4dC1hbGlnbjogcmlnaHQ7IGZvbnQtc2l6ZTogMTBweDsgY29sb3I6ICM1NTU7fQogICAgICAgICAgICAgICNtYXAgeyBoZWlnaHQ6IDk1JSU7IGJvcmRlcjogMXB4IHNvbGlkICM4ODg7IH0KICAgICAgICAgIDwvc3R5bGU+CiAgICAgICAgICA8c2NyaXB0IHNyYz0naHR0cDovL21hcHMuZ29vZ2xlLmNvbS9tYXBzP2ZpbGU9YXBpJmFtcDt2PTImYW1wO2tleT0lKGdvb2dsZW1hcHNrZXkpcyc+PC9zY3JpcHQ+CiAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgLy88IVtDREFUQVsKCiAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICogQ29uc3RhbnRzIGZvciBnaXZlbiBtYXAKICAgICAgICAgICAgICAgICAqIFRPRE86IHJlYWQgaXQgZnJvbSB0aWxlbWFwcmVzb3VyY2UueG1sCiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICB2YXIgbWFwQm91bmRzID0gbmV3IEdMYXRMbmdCb3VuZHMobmV3IEdMYXRMbmcoJShzb3V0aClzLCAlKHdlc3QpcyksIG5ldyBHTGF0TG5nKCUobm9ydGgpcywgJShlYXN0KXMpKTsKICAgICAgICAgICAgICAgIHZhciBtYXBNaW5ab29tID0gJShtaW56b29tKXM7CiAgICAgICAgICAgICAgICB2YXIgbWFwTWF4Wm9vbSA9ICUobWF4em9vbSlzOwoKICAgICAgICAgICAgICAgIHZhciBvcGFjaXR5ID0gMC43NTsKICAgICAgICAgICAgICAgIHZhciBtYXA7CiAgICAgICAgICAgICAgICB2YXIgaHlicmlkT3ZlcmxheTsKCiAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICogQ3JlYXRlIGEgQ3VzdG9tIE9wYWNpdHkgR0NvbnRyb2wKICAgICAgICAgICAgICAgICAqIGh0dHA6Ly93d3cubWFwdGlsZXIub3JnL2dvb2dsZS1tYXBzLW92ZXJsYXktb3BhY2l0eS1jb250cm9sLwogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgdmFyIENUcmFuc3BhcmVuY3lMRU5HVEggPSA1ODsKICAgICAgICAgICAgICAgIC8vIG1heGltdW0gd2lkdGggdGhhdCB0aGUga25vYiBjYW4gbW92ZSAoc2xpZGUgd2lkdGggbWludXMga25vYiB3aWR0aCkKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBDVHJhbnNwYXJlbmN5Q29udHJvbCggb3ZlcmxheSApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm92ZXJsYXkgPSBvdmVybGF5OwogICAgICAgICAgICAgICAgICAgIHRoaXMub3BhY2l0eSA9IG92ZXJsYXkuZ2V0VGlsZUxheWVyKCkuZ2V0T3BhY2l0eSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgQ1RyYW5zcGFyZW5jeUNvbnRyb2wucHJvdG90eXBlID0gbmV3IEdDb250cm9sKCk7CgogICAgICAgICAgICAgICAgLy8gVGhpcyBmdW5jdGlvbiBwb3NpdGlvbnMgdGhlIHNsaWRlciB0byBtYXRjaCB0aGUgc3BlY2lmaWVkIG9wYWNpdHkKICAgICAgICAgICAgICAgIENUcmFuc3BhcmVuY3lDb250cm9sLnByb3RvdHlwZS5zZXRTbGlkZXIgPSBmdW5jdGlvbihwb3MpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGVmdCA9IE1hdGgucm91bmQoKENUcmFuc3BhcmVuY3lMRU5HVEgqcG9zKSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zbGlkZS5sZWZ0ID0gbGVmdDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmtub2Iuc3R5bGUubGVmdCA9IGxlZnQrInB4IjsKICAgICAgICAgICAgICAgICAgICB0aGlzLmtub2Iuc3R5bGUudG9wID0gIjBweCI7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVGhpcyBmdW5jdGlvbiByZWFkcyB0aGUgc2xpZGVyIGFuZCBzZXRzIHRoZSBvdmVybGF5IG9wYWNpdHkgbGV2ZWwKICAgICAgICAgICAgICAgIENUcmFuc3BhcmVuY3lDb250cm9sLnByb3RvdHlwZS5zZXRPcGFjaXR5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gc2V0IHRoZSBnbG9iYWwgdmFyaWFibGUKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5ID0gdGhpcy5zbGlkZS5sZWZ0L0NUcmFuc3BhcmVuY3lMRU5HVEg7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYXAuY2xlYXJPdmVybGF5cygpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWFwLmFkZE92ZXJsYXkodGhpcy5vdmVybGF5LCB7IHpQcmlvcml0eTogMCB9KTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5tYXAuZ2V0Q3VycmVudE1hcFR5cGUoKSA9PSBHX0hZQlJJRF9NQVApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tYXAuYWRkT3ZlcmxheShoeWJyaWRPdmVybGF5KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVGhpcyBnZXRzIGNhbGxlZCBieSB0aGUgQVBJIHdoZW4gYWRkQ29udHJvbChuZXcgQ1RyYW5zcGFyZW5jeUNvbnRyb2woKSkKICAgICAgICAgICAgICAgIENUcmFuc3BhcmVuY3lDb250cm9sLnByb3RvdHlwZS5pbml0aWFsaXplID0gZnVuY3Rpb24obWFwKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRoYXQ9dGhpczsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1hcCA9IG1hcDsKCiAgICAgICAgICAgICAgICAgICAgLy8gSXMgdGhpcyBNU0lFLCBpZiBzbyB3ZSBuZWVkIHRvIHVzZSBBbHBoYUltYWdlTG9hZGVyCiAgICAgICAgICAgICAgICAgICAgdmFyIGFnZW50ID0gbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgIGlmICgoYWdlbnQuaW5kZXhPZigibXNpZSIpID4gLTEpICYmIChhZ2VudC5pbmRleE9mKCJvcGVyYSIpIDwgMSkpe3RoaXMuaWUgPSB0cnVlfSBlbHNlIHt0aGlzLmllID0gZmFsc2V9CgogICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSB0aGUgYmFja2dyb3VuZCBncmFwaGljIGFzIGEgPGRpdj4gY29udGFpbmluZyBhbiBpbWFnZQogICAgICAgICAgICAgICAgICAgIHZhciBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgICAgICAgICBjb250YWluZXIuc3R5bGUud2lkdGg9IjcwcHgiOwogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5zdHlsZS5oZWlnaHQ9IjIxcHgiOwoKICAgICAgICAgICAgICAgICAgICAvLyBIYW5kbGUgdHJhbnNwYXJlbnQgUE5HIGZpbGVzIGluIE1TSUUKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pZSkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGxvYWRlciA9ICJmaWx0ZXI6cHJvZ2lkOkRYSW1hZ2VUcmFuc2Zvcm0uTWljcm9zb2Z0LkFscGhhSW1hZ2VMb2FkZXIoc3JjPSdodHRwOi8vd3d3Lm1hcHRpbGVyLm9yZy9pbWcvb3BhY2l0eS1zbGlkZXIucG5nJywgc2l6aW5nTWV0aG9kPSdjcm9wJyk7IjsKICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5pbm5lckhUTUwgPSAnPGRpdiBzdHlsZT0iaGVpZ2h0OjIxcHg7IHdpZHRoOjcwcHg7ICcgK2xvYWRlcisgJyIgPjwvZGl2Pic7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5pbm5lckhUTUwgPSAnPGRpdiBzdHlsZT0iaGVpZ2h0OjIxcHg7IHdpZHRoOjcwcHg7IGJhY2tncm91bmQtaW1hZ2U6IHVybChodHRwOi8vd3d3Lm1hcHRpbGVyLm9yZy9pbWcvb3BhY2l0eS1zbGlkZXIucG5nKSIgPjwvZGl2Pic7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBjcmVhdGUgdGhlIGtub2IgYXMgYSBHRHJhZ2dhYmxlT2JqZWN0CiAgICAgICAgICAgICAgICAgICAgLy8gSGFuZGxlIHRyYW5zcGFyZW50IFBORyBmaWxlcyBpbiBNU0lFCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaWUpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2FkZXIgPSAicHJvZ2lkOkRYSW1hZ2VUcmFuc2Zvcm0uTWljcm9zb2Z0LkFscGhhSW1hZ2VMb2FkZXIoc3JjPSdodHRwOi8vd3d3Lm1hcHRpbGVyLm9yZy9pbWcvb3BhY2l0eS1zbGlkZXIucG5nJywgc2l6aW5nTWV0aG9kPSdjcm9wJyk7IjsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMua25vYiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5rbm9iLnN0eWxlLmhlaWdodD0iMjFweCI7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmtub2Iuc3R5bGUud2lkdGg9IjEzcHgiOwogICAgICAgICAgICAgICAgICB0aGlzLmtub2Iuc3R5bGUub3ZlcmZsb3c9ImhpZGRlbiI7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmtub2JfaW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmtub2JfaW1nLnN0eWxlLmhlaWdodD0iMjFweCI7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmtub2JfaW1nLnN0eWxlLndpZHRoPSI4M3B4IjsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMua25vYl9pbWcuc3R5bGUuZmlsdGVyPWxvYWRlcjsKICAgICAgICAgICAgICAgICAgdGhpcy5rbm9iX2ltZy5zdHlsZS5wb3NpdGlvbj0icmVsYXRpdmUiOwogICAgICAgICAgICAgICAgICB0aGlzLmtub2JfaW1nLnN0eWxlLmxlZnQ9Ii03MHB4IjsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMua25vYi5hcHBlbmRDaGlsZCh0aGlzLmtub2JfaW1nKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdGhpcy5rbm9iID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmtub2Iuc3R5bGUuaGVpZ2h0PSIyMXB4IjsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMua25vYi5zdHlsZS53aWR0aD0iMTNweCI7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmtub2Iuc3R5bGUuYmFja2dyb3VuZEltYWdlPSJ1cmwoaHR0cDovL3d3dy5tYXB0aWxlci5vcmcvaW1nL29wYWNpdHktc2xpZGVyLnBuZykiOwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5rbm9iLnN0eWxlLmJhY2tncm91bmRQb3NpdGlvbj0iLTcwcHggMHB4IjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKHRoaXMua25vYik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zbGlkZT1uZXcgR0RyYWdnYWJsZU9iamVjdCh0aGlzLmtub2IsIHtjb250YWluZXI6Y29udGFpbmVyfSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zbGlkZS5zZXREcmFnZ2FibGVDdXJzb3IoJ3BvaW50ZXInKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNsaWRlLnNldERyYWdnaW5nQ3Vyc29yKCdwb2ludGVyJyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBjb250YWluZXI7CgogICAgICAgICAgICAgICAgICAgIC8vIGF0dGFjaCB0aGUgY29udHJvbCB0byB0aGUgbWFwCiAgICAgICAgICAgICAgICAgICAgbWFwLmdldENvbnRhaW5lcigpLmFwcGVuZENoaWxkKGNvbnRhaW5lcik7CgogICAgICAgICAgICAgICAgICAgIC8vIGluaXQgc2xpZGVyCiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRTbGlkZXIodGhpcy5vcGFjaXR5KTsKCiAgICAgICAgICAgICAgICAgICAgLy8gTGlzdGVuIGZvciB0aGUgc2xpZGVyIGJlaW5nIG1vdmVkIGFuZCBzZXQgdGhlIG9wYWNpdHkKICAgICAgICAgICAgICAgICAgICBHRXZlbnQuYWRkTGlzdGVuZXIodGhpcy5zbGlkZSwgImRyYWdlbmQiLCBmdW5jdGlvbigpIHt0aGF0LnNldE9wYWNpdHkoKX0pOwogICAgICAgICAgICAgICAgICAgIC8vR0V2ZW50LmFkZExpc3RlbmVyKHRoaXMuY29udGFpbmVyLCAiY2xpY2siLCBmdW5jdGlvbiggeCwgeSApIHsgYWxlcnQoeCwgeSkgfSk7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBjb250YWluZXI7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIC8vIFNldCB0aGUgZGVmYXVsdCBwb3NpdGlvbiBmb3IgdGhlIGNvbnRyb2wKICAgICAgICAgICAgICAgICAgQ1RyYW5zcGFyZW5jeUNvbnRyb2wucHJvdG90eXBlLmdldERlZmF1bHRQb3NpdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgR0NvbnRyb2xQb3NpdGlvbihHX0FOQ0hPUl9UT1BfUklHSFQsIG5ldyBHU2l6ZSg3LCA0NykpOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLyoKICAgICAgICAgICAgICAgICAqIEZ1bGwtc2NyZWVuIFdpbmRvdyBSZXNpemUKICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGdldFdpbmRvd0hlaWdodCgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5pbm5lckhlaWdodCkgcmV0dXJuIHNlbGYuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0KQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodDsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuYm9keSkgcmV0dXJuIGRvY3VtZW50LmJvZHkuY2xpZW50SGVpZ2h0OwogICAgICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGdldFdpbmRvd1dpZHRoKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLmlubmVyV2lkdGgpIHJldHVybiBzZWxmLmlubmVyV2lkdGg7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50V2lkdGgpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50V2lkdGg7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LmJvZHkpIHJldHVybiBkb2N1bWVudC5ib2R5LmNsaWVudFdpZHRoOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHJlc2l6ZSgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbWFwID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm1hcCIpOwogICAgICAgICAgICAgICAgICAgIHZhciBoZWFkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiaGVhZGVyIik7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN1YmhlYWRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzdWJoZWFkZXIiKTsKICAgICAgICAgICAgICAgICAgICBtYXAuc3R5bGUuaGVpZ2h0ID0gKGdldFdpbmRvd0hlaWdodCgpLTgwKSArICJweCI7CiAgICAgICAgICAgICAgICAgICAgbWFwLnN0eWxlLndpZHRoID0gKGdldFdpbmRvd1dpZHRoKCktMjApICsgInB4IjsKICAgICAgICAgICAgICAgICAgICBoZWFkZXIuc3R5bGUud2lkdGggPSAoZ2V0V2luZG93V2lkdGgoKS0yMCkgKyAicHgiOwogICAgICAgICAgICAgICAgICAgIHN1YmhlYWRlci5zdHlsZS53aWR0aCA9IChnZXRXaW5kb3dXaWR0aCgpLTIwKSArICJweCI7CiAgICAgICAgICAgICAgICAgICAgLy8gbWFwLmNoZWNrUmVzaXplKCk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgICAgKiBNYWluIGxvYWQgZnVuY3Rpb246CiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBsb2FkKCkgewoKICAgICAgICAgICAgICAgICAgIGlmIChHQnJvd3NlcklzQ29tcGF0aWJsZSgpKSB7CgogICAgICAgICAgICAgICAgICAgICAgLy8gQnVnIGluIHRoZSBHb29nbGUgTWFwczogQ29weXJpZ2h0IGZvciBPdmVybGF5IGlzIG5vdCBjb3JyZWN0bHkgZGlzcGxheWVkCiAgICAgICAgICAgICAgICAgICAgICB2YXIgZ2NyID0gR01hcFR5cGUucHJvdG90eXBlLmdldENvcHlyaWdodHM7CiAgICAgICAgICAgICAgICAgICAgICBHTWFwVHlwZS5wcm90b3R5cGUuZ2V0Q29weXJpZ2h0cyA9IGZ1bmN0aW9uKGJvdW5kcyx6b29tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsiJShjb3B5cmlnaHQpcyJdLmNvbmNhdChnY3IuY2FsbCh0aGlzLGJvdW5kcyx6b29tKSk7CiAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgbWFwID0gbmV3IEdNYXAyKCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibWFwIiksIHsgYmFja2dyb3VuZENvbG9yOiAnI2ZmZicgfSApOwoKICAgICAgICAgICAgICAgICAgICAgIG1hcC5hZGRNYXBUeXBlKEdfUEhZU0lDQUxfTUFQKTsKICAgICAgICAgICAgICAgICAgICAgIG1hcC5zZXRNYXBUeXBlKEdfUEhZU0lDQUxfTUFQKTsKCiAgICAgICAgICAgICAgICAgICAgICBtYXAuc2V0Q2VudGVyKCBtYXBCb3VuZHMuZ2V0Q2VudGVyKCksIG1hcC5nZXRCb3VuZHNab29tTGV2ZWwoIG1hcEJvdW5kcyApKTsKCiAgICAgICAgICAgICAgICAgICAgICBoeWJyaWRPdmVybGF5ID0gbmV3IEdUaWxlTGF5ZXJPdmVybGF5KCBHX0hZQlJJRF9NQVAuZ2V0VGlsZUxheWVycygpWzFdICk7CiAgICAgICAgICAgICAgICAgICAgICBHRXZlbnQuYWRkTGlzdGVuZXIobWFwLCAibWFwdHlwZWNoYW5nZWQiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hcC5nZXRDdXJyZW50TWFwVHlwZSgpID09IEdfSFlCUklEX01BUCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwLmFkZE92ZXJsYXkoaHlicmlkT3ZlcmxheSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcC5yZW1vdmVPdmVybGF5KGh5YnJpZE92ZXJsYXkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9ICk7CgogICAgICAgICAgICAgICAgICAgICAgdmFyIHRpbGVsYXllciA9IG5ldyBHVGlsZUxheWVyKEdDb3B5cmlnaHRDb2xsZWN0aW9uKCcnKSwgbWFwTWluWm9vbSwgbWFwTWF4Wm9vbSk7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgbWVyY2F0b3IgPSBuZXcgR01lcmNhdG9yUHJvamVjdGlvbihtYXBNYXhab29tKzEpOwogICAgICAgICAgICAgICAgICAgICAgdGlsZWxheWVyLmdldFRpbGVVcmwgPSBmdW5jdGlvbih0aWxlLHpvb20pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHpvb20gPCBtYXBNaW5ab29tKSB8fCAoem9vbSA+IG1hcE1heFpvb20pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAiaHR0cDovL3d3dy5tYXB0aWxlci5vcmcvaW1nL25vbmUucG5nIjsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHltYXggPSAxIDw8IHpvb207CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHkgPSB5bWF4IC0gdGlsZS55IC0xOwogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0aWxlQm91bmRzID0gbmV3IEdMYXRMbmdCb3VuZHMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lcmNhdG9yLmZyb21QaXhlbFRvTGF0TG5nKCBuZXcgR1BvaW50KCAodGlsZS54KSoyNTYsICh0aWxlLnkrMSkqMjU2ICkgLCB6b29tICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lcmNhdG9yLmZyb21QaXhlbFRvTGF0TG5nKCBuZXcgR1BvaW50KCAodGlsZS54KzEpKjI1NiwgKHRpbGUueSkqMjU2ICkgLCB6b29tICkKICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXBCb3VuZHMuaW50ZXJzZWN0cyh0aWxlQm91bmRzKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gem9vbSsiLyIrdGlsZS54KyIvIit5KyIucG5nIjsKICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gImh0dHA6Ly93d3cubWFwdGlsZXIub3JnL2ltZy9ub25lLnBuZyI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgLy8gSUUgNy06IHN1cHBvcnQgZm9yIFBORyBhbHBoYSBjaGFubmVsCiAgICAgICAgICAgICAgICAgICAgICAvLyBVbmZvcnR1bmF0ZWx5LCB0aGUgb3BhY2l0eSBmb3Igd2hvbGUgb3ZlcmxheSBpcyB0aGVuIG5vdCBjaGFuZ2VhYmxlLCBlaXRoZXIgb3IuLi4KICAgICAgICAgICAgICAgICAgICAgIHRpbGVsYXllci5pc1BuZyA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZTt9OwogICAgICAgICAgICAgICAgICAgICAgdGlsZWxheWVyLmdldE9wYWNpdHkgPSBmdW5jdGlvbigpIHsgcmV0dXJuIG9wYWNpdHk7IH0KCiAgICAgICAgICAgICAgICAgICAgICBvdmVybGF5ID0gbmV3IEdUaWxlTGF5ZXJPdmVybGF5KCB0aWxlbGF5ZXIgKTsKICAgICAgICAgICAgICAgICAgICAgIG1hcC5hZGRPdmVybGF5KG92ZXJsYXkpOwoKICAgICAgICAgICAgICAgICAgICAgIG1hcC5hZGRDb250cm9sKG5ldyBHTGFyZ2VNYXBDb250cm9sKCkpOwogICAgICAgICAgICAgICAgICAgICAgbWFwLmFkZENvbnRyb2wobmV3IEdIaWVyYXJjaGljYWxNYXBUeXBlQ29udHJvbCgpKTsKICAgICAgICAgICAgICAgICAgICAgIG1hcC5hZGRDb250cm9sKG5ldyBDVHJhbnNwYXJlbmN5Q29udHJvbCggb3ZlcmxheSApKTsKICAgICAgICAiIiIgJSBhcmdzICAgICMgbm9xYQogICAgICAgIGlmIHNlbGYua21sOgogICAgICAgICAgICBzICs9ICIiIgogICAgICAgICAgICAgICAgICAgICAgbWFwLmFkZE1hcFR5cGUoR19TQVRFTExJVEVfM0RfTUFQKTsKICAgICAgICAgICAgICAgICAgICAgIG1hcC5nZXRFYXJ0aEluc3RhbmNlKGdldEVhcnRoSW5zdGFuY2VDQik7CiAgICAgICAgIiIiCiAgICAgICAgcyArPSAiIiIKCiAgICAgICAgICAgICAgICAgICAgICBtYXAuZW5hYmxlQ29udGludW91c1pvb20oKTsKICAgICAgICAgICAgICAgICAgICAgIG1hcC5lbmFibGVTY3JvbGxXaGVlbFpvb20oKTsKCiAgICAgICAgICAgICAgICAgICAgICBtYXAuc2V0TWFwVHlwZShHX0hZQlJJRF9NQVApOwogICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgcmVzaXplKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgIiIiCiAgICAgICAgaWYgc2VsZi5rbWw6CiAgICAgICAgICAgIHMgKz0gIiIiCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBnZXRFYXJ0aEluc3RhbmNlQ0Iob2JqZWN0KSB7CiAgICAgICAgICAgICAgICAgICB2YXIgZ2UgPSBvYmplY3Q7CgogICAgICAgICAgICAgICAgICAgaWYgKGdlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgdmFyIHVybCA9IGRvY3VtZW50LmxvY2F0aW9uLnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICAgICAgICAgdXJsID0gdXJsLnN1YnN0cigwLHVybC5sYXN0SW5kZXhPZignLycpKSsnL2RvYy5rbWwnOwogICAgICAgICAgICAgICAgICAgICAgIHZhciBsaW5rID0gZ2UuY3JlYXRlTGluaygiIik7CiAgICAgICAgICAgICAgICAgICAgICAgaWYgKCIlKHB1Ymxpc2h1cmwpcyIpIHsgbGluay5zZXRIcmVmKCIlKHB1Ymxpc2h1cmwpcy9kb2Mua21sIikgfQogICAgICAgICAgICAgICAgICAgICAgIGVsc2UgeyBsaW5rLnNldEhyZWYodXJsKSB9OwogICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXR3b3JrTGluayA9IGdlLmNyZWF0ZU5ldHdvcmtMaW5rKCIiKTsKICAgICAgICAgICAgICAgICAgICAgICBuZXR3b3JrTGluay5zZXROYW1lKCJUTVMgTWFwIE92ZXJsYXkiKTsKICAgICAgICAgICAgICAgICAgICAgICBuZXR3b3JrTGluay5zZXRGbHlUb1ZpZXcodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgbmV0d29ya0xpbmsuc2V0TGluayhsaW5rKTsKICAgICAgICAgICAgICAgICAgICAgICBnZS5nZXRGZWF0dXJlcygpLmFwcGVuZENoaWxkKG5ldHdvcmtMaW5rKTsKICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgLy8gYWxlcnQoIllvdSBzaG91bGQgb3BlbiBhIEtNTCBpbiBHb29nbGUgRWFydGgiKTsKICAgICAgICAgICAgICAgICAgICAgICAvLyBhZGQgZGl2IHdpdGggdGhlIGxpbmsgdG8gZ2VuZXJhdGVkIEtNTC4uLiAtIG1heWJlIEphdmFTY3JpcHQgcmVkaXJlY3QgdG8gdGhlIFVSTCBvZiBLTUw/CiAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgIiIiICUgYXJncyAgICAjIG5vcWEKICAgICAgICBzICs9ICIiIgogICAgICAgICAgICAgICAgb25yZXNpemU9ZnVuY3Rpb24oKXsgcmVzaXplKCk7IH07CgogICAgICAgICAgICAgICAgLy9dXT4KICAgICAgICAgICAgICAgIDwvc2NyaXB0PgogICAgICAgICAgICAgIDwvaGVhZD4KICAgICAgICAgICAgICA8Ym9keSBvbmxvYWQ9ImxvYWQoKSI+CiAgICAgICAgICAgICAgICAgIDxkaXYgaWQ9ImhlYWRlciI+PGgxPiUodGl0bGUpczwvaDE+PC9kaXY+CiAgICAgICAgICAgICAgICAgIDxkaXYgaWQ9InN1YmhlYWRlciI+R2VuZXJhdGVkIGJ5IDxhIGhyZWY9Imh0dHA6Ly93d3cua2xva2FuLmN6L3Byb2plY3RzL2dkYWwydGlsZXMvIj5HREFMMlRpbGVzPC9hPiwgQ29weXJpZ2h0ICZjb3B5OyAyMDA4IDxhIGhyZWY9Imh0dHA6Ly93d3cua2xva2FuLmN6LyI+S2xva2FuIFBldHIgUHJpZGFsPC9hPiwgIDxhIGhyZWY9Imh0dHA6Ly93d3cuZ2RhbC5vcmcvIj5HREFMPC9hPiAmYW1wOyA8YSBocmVmPSJodHRwOi8vd3d3Lm9zZ2VvLm9yZy8iPk9TR2VvPC9hPiA8YSBocmVmPSJodHRwOi8vY29kZS5nb29nbGUuY29tL3NvYy8iPkdTb0M8L2E+CiAgICAgICAgICAgIDwhLS0gUExFQVNFLCBMRVQgVEhJUyBOT1RFIEFCT1VUIEFVVEhPUiBBTkQgUFJPSkVDVCBTT01FV0hFUkUgT04gWU9VUiBXRUJTSVRFLCBPUiBBVCBMRUFTVCBJTiBUSEUgQ09NTUVOVCBJTiBIVE1MLiBUSEFOSyBZT1UgLS0+CiAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgPGRpdiBpZD0ibWFwIj48L2Rpdj4KICAgICAgICAgICAgICA8L2JvZHk+CiAgICAgICAgICAgIDwvaHRtbD4KICAgICAgICAiIiIgJSBhcmdzICAgICMgbm9xYQoKICAgICAgICByZXR1cm4gcwoKICAgIGRlZiBnZW5lcmF0ZV9sZWFmbGV0KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFRlbXBsYXRlIGZvciBsZWFmbGV0Lmh0bWwgaW1wbGVtZW50aW5nIG92ZXJsYXkgb2YgdGlsZXMgZm9yICdtZXJjYXRvcicgcHJvZmlsZS4KICAgICAgICBJdCByZXR1cm5zIGZpbGxlZCBzdHJpbmcuIEV4cGVjdGVkIHZhcmlhYmxlczoKICAgICAgICB0aXRsZSwgbm9ydGgsIHNvdXRoLCBlYXN0LCB3ZXN0LCBtaW56b29tLCBtYXh6b29tLCB0aWxlc2l6ZSwgdGlsZWZvcm1hdCwgcHVibGlzaHVybAogICAgICAgICIiIgoKICAgICAgICBhcmdzID0ge30KICAgICAgICBhcmdzWyd0aXRsZSddID0gc2VsZi5vcHRpb25zLnRpdGxlLnJlcGxhY2UoJyInLCAnXFwiJykKICAgICAgICBhcmdzWydodG1sdGl0bGUnXSA9IHNlbGYub3B0aW9ucy50aXRsZQogICAgICAgIGFyZ3NbJ3NvdXRoJ10sIGFyZ3NbJ3dlc3QnXSwgYXJnc1snbm9ydGgnXSwgYXJnc1snZWFzdCddID0gc2VsZi5zd25lCiAgICAgICAgYXJnc1snY2VudGVybG9uJ10gPSAoYXJnc1snbm9ydGgnXSArIGFyZ3NbJ3NvdXRoJ10pIC8gMi4KICAgICAgICBhcmdzWydjZW50ZXJsYXQnXSA9IChhcmdzWyd3ZXN0J10gKyBhcmdzWydlYXN0J10pIC8gMi4KICAgICAgICBhcmdzWydtaW56b29tJ10gPSBzZWxmLnRtaW56CiAgICAgICAgYXJnc1snbWF4em9vbSddID0gc2VsZi50bWF4egogICAgICAgIGFyZ3NbJ2JlZ2luem9vbSddID0gc2VsZi50bWF4egogICAgICAgIGFyZ3NbJ3RpbGVzaXplJ10gPSBzZWxmLnRpbGVzaXplICAjIG5vdCB1c2VkCiAgICAgICAgYXJnc1sndGlsZWZvcm1hdCddID0gc2VsZi50aWxlZXh0CiAgICAgICAgYXJnc1sncHVibGlzaHVybCddID0gc2VsZi5vcHRpb25zLnVybCAgIyBub3QgdXNlZAogICAgICAgIGFyZ3NbJ2NvcHlyaWdodCddID0gc2VsZi5vcHRpb25zLmNvcHlyaWdodC5yZXBsYWNlKCciJywgJ1xcIicpCgogICAgICAgIHMgPSAiIiI8IURPQ1RZUEUgaHRtbD4KICAgICAgICA8aHRtbCBsYW5nPSJlbiI+CiAgICAgICAgICA8aGVhZD4KICAgICAgICAgICAgPG1ldGEgY2hhcnNldD0idXRmLTgiPgogICAgICAgICAgICA8bWV0YSBuYW1lPSd2aWV3cG9ydCcgY29udGVudD0nd2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEuMCwgbWF4aW11bS1zY2FsZT0xLjAsIHVzZXItc2NhbGFibGU9bm8nIC8+CiAgICAgICAgICAgIDx0aXRsZT4lKGh0bWx0aXRsZSlzPC90aXRsZT4KCiAgICAgICAgICAgIDwhLS0gTGVhZmxldCAtLT4KICAgICAgICAgICAgPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSJodHRwOi8vY2RuLmxlYWZsZXRqcy5jb20vbGVhZmxldC0wLjcuNS9sZWFmbGV0LmNzcyIgLz4KICAgICAgICAgICAgPHNjcmlwdCBzcmM9Imh0dHA6Ly9jZG4ubGVhZmxldGpzLmNvbS9sZWFmbGV0LTAuNy41L2xlYWZsZXQuanMiPjwvc2NyaXB0PgoKICAgICAgICAgICAgPHN0eWxlPgogICAgICAgICAgICAgICAgYm9keSB7IG1hcmdpbjowOyBwYWRkaW5nOjA7IH0KICAgICAgICAgICAgICAgIGJvZHksIHRhYmxlLCB0ciwgdGQsIHRoLCBkaXYsIGgxLCBoMiwgaW5wdXQgeyBmb250LWZhbWlseTogIkNhbGlicmkiLCAiVHJlYnVjaGV0IE1TIiwgIlVidW50dSIsIFNlcmlmOyBmb250LXNpemU6IDExcHQ7IH0KICAgICAgICAgICAgICAgICNtYXAgeyBwb3NpdGlvbjphYnNvbHV0ZTsgdG9wOjA7IGJvdHRvbTowOyB3aWR0aDoxMDAlJTsgfSAvKiBmdWxsIHNpemUgKi8KICAgICAgICAgICAgICAgIC5jdGwgewogICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6IDJweCAxMHB4IDJweCAxMHB4OwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IHdoaXRlOwogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6IHJnYmEoMjU1LDI1NSwyNTUsMC45KTsKICAgICAgICAgICAgICAgICAgICBib3gtc2hhZG93OiAwIDAgMTVweCByZ2JhKDAsMCwwLDAuMik7CiAgICAgICAgICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNXB4OwogICAgICAgICAgICAgICAgICAgIHRleHQtYWxpZ246IHJpZ2h0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLnRpdGxlIHsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDE4cHQ7CiAgICAgICAgICAgICAgICAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAuc3JjIHsKICAgICAgICAgICAgICAgICAgICBmb250LXNpemU6IDEwcHQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICA8L3N0eWxlPgoKICAgICAgICA8L2hlYWQ+CiAgICAgICAgPGJvZHk+CgogICAgICAgIDxkaXYgaWQ9Im1hcCI+PC9kaXY+CgogICAgICAgIDxzY3JpcHQ+CiAgICAgICAgLyogKioqKiBMZWFmbGV0ICoqKiogKi8KCiAgICAgICAgLy8gQmFzZSBsYXllcnMKICAgICAgICAvLyAgLi4gT3BlblN0cmVldE1hcAogICAgICAgIHZhciBvc20gPSBMLnRpbGVMYXllcignaHR0cDovL3tzfS50aWxlLm9zbS5vcmcve3p9L3t4fS97eX0ucG5nJywge2F0dHJpYnV0aW9uOiAnJmNvcHk7IDxhIGhyZWY9Imh0dHA6Ly9vc20ub3JnL2NvcHlyaWdodCI+T3BlblN0cmVldE1hcDwvYT4gY29udHJpYnV0b3JzJ30pOwoKICAgICAgICAvLyAgLi4gQ2FydG9EQiBQb3NpdHJvbgogICAgICAgIHZhciBjYXJ0b2RiID0gTC50aWxlTGF5ZXIoJ2h0dHA6Ly97c30uYmFzZW1hcHMuY2FydG9jZG4uY29tL2xpZ2h0X2FsbC97en0ve3h9L3t5fS5wbmcnLCB7YXR0cmlidXRpb246ICcmY29weTsgPGEgaHJlZj0iaHR0cDovL3d3dy5vcGVuc3RyZWV0bWFwLm9yZy9jb3B5cmlnaHQiPk9wZW5TdHJlZXRNYXA8L2E+IGNvbnRyaWJ1dG9ycywgJmNvcHk7IDxhIGhyZWY9Imh0dHA6Ly9jYXJ0b2RiLmNvbS9hdHRyaWJ1dGlvbnMiPkNhcnRvREI8L2E+J30pOwoKICAgICAgICAvLyAgLi4gT1NNIFRvbmVyCiAgICAgICAgdmFyIHRvbmVyID0gTC50aWxlTGF5ZXIoJ2h0dHA6Ly97c30udGlsZS5zdGFtZW4uY29tL3RvbmVyL3t6fS97eH0ve3l9LnBuZycsIHthdHRyaWJ1dGlvbjogJ01hcCB0aWxlcyBieSA8YSBocmVmPSJodHRwOi8vc3RhbWVuLmNvbSI+U3RhbWVuIERlc2lnbjwvYT4sIHVuZGVyIDxhIGhyZWY9Imh0dHA6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LzMuMCI+Q0MgQlkgMy4wPC9hPi4gRGF0YSBieSA8YSBocmVmPSJodHRwOi8vb3BlbnN0cmVldG1hcC5vcmciPk9wZW5TdHJlZXRNYXA8L2E+LCB1bmRlciA8YSBocmVmPSJodHRwOi8vd3d3Lm9wZW5zdHJlZXRtYXAub3JnL2NvcHlyaWdodCI+T0RiTDwvYT4uJ30pOwoKICAgICAgICAvLyAgLi4gV2hpdGUgYmFja2dyb3VuZAogICAgICAgIHZhciB3aGl0ZSA9IEwudGlsZUxheWVyKCJkYXRhOmltYWdlL3BuZztiYXNlNjQsaVZCT1J3MEtHZ29BQUFBTlNVaEVVZ0FBQVFBQUFBRUFBUU1BQUFCbXZEb2xBQUFBQTFCTVZFWC8vLytueEJ2SUFBQUFIMGxFUVZRWUdlM0JBUTBBQUFEQ0lQdW5mZzQzWUFBQUFBQUFBQUFBNXdJaEFBQUI5YUs5QkFBQUFBQkpSVTVFcmtKZ2dnPT0iKTsKCiAgICAgICAgLy8gT3ZlcmxheSBsYXllcnMgKFRNUykKICAgICAgICB2YXIgbHlyID0gTC50aWxlTGF5ZXIoJy4ve3p9L3t4fS97eX0uJSh0aWxlZm9ybWF0KXMnLCB7dG1zOiB0cnVlLCBvcGFjaXR5OiAwLjcsIGF0dHJpYnV0aW9uOiAiJShjb3B5cmlnaHQpcyJ9KTsKCiAgICAgICAgLy8gTWFwCiAgICAgICAgdmFyIG1hcCA9IEwubWFwKCdtYXAnLCB7CiAgICAgICAgICAgIGNlbnRlcjogWyUoY2VudGVybG9uKXMsICUoY2VudGVybGF0KXNdLAogICAgICAgICAgICB6b29tOiAlKGJlZ2luem9vbSlzLAogICAgICAgICAgICBtaW5ab29tOiAlKG1pbnpvb20pcywKICAgICAgICAgICAgbWF4Wm9vbTogJShtYXh6b29tKXMsCiAgICAgICAgICAgIGxheWVyczogW29zbV0KICAgICAgICB9KTsKCiAgICAgICAgdmFyIGJhc2VtYXBzID0geyJPcGVuU3RyZWV0TWFwIjogb3NtLCAiQ2FydG9EQiBQb3NpdHJvbiI6IGNhcnRvZGIsICJTdGFtZW4gVG9uZXIiOiB0b25lciwgIldpdGhvdXQgYmFja2dyb3VuZCI6IHdoaXRlfQogICAgICAgIHZhciBvdmVybGF5bWFwcyA9IHsiTGF5ZXIiOiBseXJ9CgogICAgICAgIC8vIFRpdGxlCiAgICAgICAgdmFyIHRpdGxlID0gTC5jb250cm9sKCk7CiAgICAgICAgdGl0bGUub25BZGQgPSBmdW5jdGlvbihtYXApIHsKICAgICAgICAgICAgdGhpcy5fZGl2ID0gTC5Eb21VdGlsLmNyZWF0ZSgnZGl2JywgJ2N0bCB0aXRsZScpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZSgpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fZGl2OwogICAgICAgIH07CiAgICAgICAgdGl0bGUudXBkYXRlID0gZnVuY3Rpb24ocHJvcHMpIHsKICAgICAgICAgICAgdGhpcy5fZGl2LmlubmVySFRNTCA9ICIlKHRpdGxlKXMiOwogICAgICAgIH07CiAgICAgICAgdGl0bGUuYWRkVG8obWFwKTsKCiAgICAgICAgLy8gTm90ZQogICAgICAgIHZhciBzcmMgPSAnR2VuZXJhdGVkIGJ5IDxhIGhyZWY9Imh0dHA6Ly93d3cua2xva2FuLmN6L3Byb2plY3RzL2dkYWwydGlsZXMvIj5HREFMMlRpbGVzPC9hPiwgQ29weXJpZ2h0ICZjb3B5OyAyMDA4IDxhIGhyZWY9Imh0dHA6Ly93d3cua2xva2FuLmN6LyI+S2xva2FuIFBldHIgUHJpZGFsPC9hPiwgIDxhIGhyZWY9Imh0dHA6Ly93d3cuZ2RhbC5vcmcvIj5HREFMPC9hPiAmYW1wOyA8YSBocmVmPSJodHRwOi8vd3d3Lm9zZ2VvLm9yZy8iPk9TR2VvPC9hPiA8YSBocmVmPSJodHRwOi8vY29kZS5nb29nbGUuY29tL3NvYy8iPkdTb0M8L2E+JzsKICAgICAgICB2YXIgdGl0bGUgPSBMLmNvbnRyb2woe3Bvc2l0aW9uOiAnYm90dG9tbGVmdCd9KTsKICAgICAgICB0aXRsZS5vbkFkZCA9IGZ1bmN0aW9uKG1hcCkgewogICAgICAgICAgICB0aGlzLl9kaXYgPSBMLkRvbVV0aWwuY3JlYXRlKCdkaXYnLCAnY3RsIHNyYycpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZSgpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fZGl2OwogICAgICAgIH07CiAgICAgICAgdGl0bGUudXBkYXRlID0gZnVuY3Rpb24ocHJvcHMpIHsKICAgICAgICAgICAgdGhpcy5fZGl2LmlubmVySFRNTCA9IHNyYzsKICAgICAgICB9OwogICAgICAgIHRpdGxlLmFkZFRvKG1hcCk7CgoKICAgICAgICAvLyBBZGQgYmFzZSBsYXllcnMKICAgICAgICBMLmNvbnRyb2wubGF5ZXJzKGJhc2VtYXBzLCBvdmVybGF5bWFwcywge2NvbGxhcHNlZDogZmFsc2V9KS5hZGRUbyhtYXApOwoKICAgICAgICAvLyBGaXQgdG8gb3ZlcmxheSBib3VuZHMgKFNXIGFuZCBORSBwb2ludHMgd2l0aCAobGF0LCBsb24pKQogICAgICAgIG1hcC5maXRCb3VuZHMoW1slKHNvdXRoKXMsICUoZWFzdClzXSwgWyUobm9ydGgpcywgJSh3ZXN0KXNdXSk7CgogICAgICAgIDwvc2NyaXB0PgoKICAgICAgICA8L2JvZHk+CiAgICAgICAgPC9odG1sPgoKICAgICAgICAiIiIgJSBhcmdzICAgICMgbm9xYQoKICAgICAgICByZXR1cm4gcwoKICAgIGRlZiBnZW5lcmF0ZV9vcGVubGF5ZXJzKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFRlbXBsYXRlIGZvciBvcGVubGF5ZXJzLmh0bWwgaW1wbGVtZW50aW5nIG92ZXJsYXkgb2YgYXZhaWxhYmxlIFNwaGVyaWNhbCBNZXJjYXRvciBsYXllcnMuCgogICAgICAgIEl0IHJldHVybnMgZmlsbGVkIHN0cmluZy4gRXhwZWN0ZWQgdmFyaWFibGVzOgogICAgICAgIHRpdGxlLCBiaW5na2V5LCBub3J0aCwgc291dGgsIGVhc3QsIHdlc3QsIG1pbnpvb20sIG1heHpvb20sIHRpbGVzaXplLCB0aWxlZm9ybWF0LCBwdWJsaXNodXJsCiAgICAgICAgIiIiCgogICAgICAgIGFyZ3MgPSB7fQogICAgICAgIGFyZ3NbJ3RpdGxlJ10gPSBzZWxmLm9wdGlvbnMudGl0bGUKICAgICAgICBhcmdzWydiaW5na2V5J10gPSBzZWxmLm9wdGlvbnMuYmluZ2tleQogICAgICAgIGFyZ3NbJ3NvdXRoJ10sIGFyZ3NbJ3dlc3QnXSwgYXJnc1snbm9ydGgnXSwgYXJnc1snZWFzdCddID0gc2VsZi5zd25lCiAgICAgICAgYXJnc1snbWluem9vbSddID0gc2VsZi50bWluegogICAgICAgIGFyZ3NbJ21heHpvb20nXSA9IHNlbGYudG1heHoKICAgICAgICBhcmdzWyd0aWxlc2l6ZSddID0gc2VsZi50aWxlc2l6ZQogICAgICAgIGFyZ3NbJ3RpbGVmb3JtYXQnXSA9IHNlbGYudGlsZWV4dAogICAgICAgIGFyZ3NbJ3B1Ymxpc2h1cmwnXSA9IHNlbGYub3B0aW9ucy51cmwKICAgICAgICBhcmdzWydjb3B5cmlnaHQnXSA9IHNlbGYub3B0aW9ucy5jb3B5cmlnaHQKICAgICAgICBpZiBzZWxmLm9wdGlvbnMudG1zY29tcGF0aWJsZToKICAgICAgICAgICAgYXJnc1sndG1zb2Zmc2V0J10gPSAiLTEiCiAgICAgICAgZWxzZToKICAgICAgICAgICAgYXJnc1sndG1zb2Zmc2V0J10gPSAiIgogICAgICAgIGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdyYXN0ZXInOgogICAgICAgICAgICBhcmdzWydyYXN0ZXJ6b29tbGV2ZWxzJ10gPSBzZWxmLnRtYXh6KzEKICAgICAgICAgICAgYXJnc1sncmFzdGVybWF4cmVzb2x1dGlvbiddID0gMioqKHNlbGYubmF0aXZlem9vbSkgKiBzZWxmLm91dF9ndFsxXQoKICAgICAgICBzID0gciIiIjwhRE9DVFlQRSBodG1sIFBVQkxJQyAiLS8vVzNDLy9EVEQgWEhUTUwgMS4wIFN0cmljdC8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9UUi94aHRtbDEvRFREL3hodG1sMS1zdHJpY3QuZHRkIj4KICAgICAgICA8aHRtbCB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIKICAgICAgICAgIDxoZWFkPgogICAgICAgICAgICA8dGl0bGU+JSh0aXRsZSlzPC90aXRsZT4KICAgICAgICAgICAgPG1ldGEgaHR0cC1lcXVpdj0naW1hZ2V0b29sYmFyJyBjb250ZW50PSdubycvPgogICAgICAgICAgICA8c3R5bGUgdHlwZT0idGV4dC9jc3MiPiB2XDoqIHtiZWhhdmlvcjp1cmwoI2RlZmF1bHQjVk1MKTt9CiAgICAgICAgICAgICAgICBodG1sLCBib2R5IHsgb3ZlcmZsb3c6IGhpZGRlbjsgcGFkZGluZzogMDsgaGVpZ2h0OiAxMDAlJTsgd2lkdGg6IDEwMCUlOyBmb250LWZhbWlseTogJ0x1Y2lkYSBHcmFuZGUnLEdlbmV2YSxBcmlhbCxWZXJkYW5hLHNhbnMtc2VyaWY7IH0KICAgICAgICAgICAgICAgIGJvZHkgeyBtYXJnaW46IDEwcHg7IGJhY2tncm91bmQ6ICNmZmY7IH0KICAgICAgICAgICAgICAgIGgxIHsgbWFyZ2luOiAwOyBwYWRkaW5nOiA2cHg7IGJvcmRlcjowOyBmb250LXNpemU6IDIwcHQ7IH0KICAgICAgICAgICAgI2hlYWRlciB7IGhlaWdodDogNDNweDsgcGFkZGluZzogMDsgYmFja2dyb3VuZC1jb2xvcjogI2VlZTsgYm9yZGVyOiAxcHggc29saWQgIzg4ODsgfQogICAgICAgICAgICAjc3ViaGVhZGVyIHsgaGVpZ2h0OiAxMnB4OyB0ZXh0LWFsaWduOiByaWdodDsgZm9udC1zaXplOiAxMHB4OyBjb2xvcjogIzU1NTt9CiAgICAgICAgICAgICNtYXAgeyBoZWlnaHQ6IDk1JSU7IGJvcmRlcjogMXB4IHNvbGlkICM4ODg7IH0KICAgICAgICAgICAgLm9sSW1hZ2VMb2FkRXJyb3IgeyBkaXNwbGF5OiBub25lOyB9CiAgICAgICAgICAgIC5vbENvbnRyb2xMYXllclN3aXRjaGVyIC5sYXllcnNEaXYgeyBib3JkZXItcmFkaXVzOiAxMHB4IDAgMCAxMHB4OyB9CiAgICAgICAgPC9zdHlsZT4iIiIgJSBhcmdzICAgICMgbm9xYQoKICAgICAgICBpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAnbWVyY2F0b3InOgogICAgICAgICAgICBzICs9ICIiIgogICAgICAgICAgICA8c2NyaXB0IHNyYz0naHR0cDovL21hcHMuZ29vZ2xlLmNvbS9tYXBzL2FwaS9qcz9zZW5zb3I9ZmFsc2Umdj0zLjcnPjwvc2NyaXB0PgogICAgICAgICAgICAiIiIgJSBhcmdzCgogICAgICAgIHMgKz0gIiIiCiAgICAgICAgICAgIDxzY3JpcHQgc3JjPSJodHRwOi8vd3d3Lm9wZW5sYXllcnMub3JnL2FwaS8yLjEyL09wZW5MYXllcnMuanMiPjwvc2NyaXB0PgogICAgICAgICAgICA8c2NyaXB0PgogICAgICAgICAgICAgIHZhciBtYXA7CiAgICAgICAgICAgICAgdmFyIG1hcEJvdW5kcyA9IG5ldyBPcGVuTGF5ZXJzLkJvdW5kcyggJSh3ZXN0KXMsICUoc291dGgpcywgJShlYXN0KXMsICUobm9ydGgpcyk7CiAgICAgICAgICAgICAgdmFyIG1hcE1pblpvb20gPSAlKG1pbnpvb20pczsKICAgICAgICAgICAgICB2YXIgbWFwTWF4Wm9vbSA9ICUobWF4em9vbSlzOwogICAgICAgICAgICAgIHZhciBlbXB0eVRpbGVVUkwgPSAiaHR0cDovL3d3dy5tYXB0aWxlci5vcmcvaW1nL25vbmUucG5nIjsKICAgICAgICAgICAgICBPcGVuTGF5ZXJzLklNQUdFX1JFTE9BRF9BVFRFTVBUUyA9IDM7CgogICAgICAgICAgICAgIGZ1bmN0aW9uIGluaXQoKXsiIiIgJSBhcmdzCgogICAgICAgIGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdtZXJjYXRvcic6CiAgICAgICAgICAgIHMgKz0gIiIiCiAgICAgICAgICAgICAgICAgIHZhciBvcHRpb25zID0gewogICAgICAgICAgICAgICAgICAgICAgZGl2OiAibWFwIiwKICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xzOiBbXSwKICAgICAgICAgICAgICAgICAgICAgIHByb2plY3Rpb246ICJFUFNHOjM4NTciLAogICAgICAgICAgICAgICAgICAgICAgZGlzcGxheVByb2plY3Rpb246IG5ldyBPcGVuTGF5ZXJzLlByb2plY3Rpb24oIkVQU0c6NDMyNiIpLAogICAgICAgICAgICAgICAgICAgICAgbnVtWm9vbUxldmVsczogMjAKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgbWFwID0gbmV3IE9wZW5MYXllcnMuTWFwKG9wdGlvbnMpOwoKICAgICAgICAgICAgICAgICAgLy8gQ3JlYXRlIEdvb2dsZSBNZXJjYXRvciBsYXllcnMKICAgICAgICAgICAgICAgICAgdmFyIGdtYXAgPSBuZXcgT3BlbkxheWVycy5MYXllci5Hb29nbGUoIkdvb2dsZSBTdHJlZXRzIiwKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogZ29vZ2xlLm1hcHMuTWFwVHlwZUlkLlJPQURNQVAsCiAgICAgICAgICAgICAgICAgICAgICBzcGhlcmljYWxNZXJjYXRvcjogdHJ1ZQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgdmFyIGdzYXQgPSBuZXcgT3BlbkxheWVycy5MYXllci5Hb29nbGUoIkdvb2dsZSBTYXRlbGxpdGUiLAogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBnb29nbGUubWFwcy5NYXBUeXBlSWQuU0FURUxMSVRFLAogICAgICAgICAgICAgICAgICAgICAgc3BoZXJpY2FsTWVyY2F0b3I6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHZhciBnaHliID0gbmV3IE9wZW5MYXllcnMuTGF5ZXIuR29vZ2xlKCJHb29nbGUgSHlicmlkIiwKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogZ29vZ2xlLm1hcHMuTWFwVHlwZUlkLkhZQlJJRCwKICAgICAgICAgICAgICAgICAgICAgIHNwaGVyaWNhbE1lcmNhdG9yOiB0cnVlCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB2YXIgZ3RlciA9IG5ldyBPcGVuTGF5ZXJzLkxheWVyLkdvb2dsZSgiR29vZ2xlIFRlcnJhaW4iLAogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBnb29nbGUubWFwcy5NYXBUeXBlSWQuVEVSUkFJTiwKICAgICAgICAgICAgICAgICAgICAgIHNwaGVyaWNhbE1lcmNhdG9yOiB0cnVlCiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgLy8gQ3JlYXRlIEJpbmcgbGF5ZXJzCiAgICAgICAgICAgICAgICAgIHZhciBicm9hZCA9IG5ldyBPcGVuTGF5ZXJzLkxheWVyLkJpbmcoewogICAgICAgICAgICAgICAgICAgICAgbmFtZTogIkJpbmcgUm9hZHMiLAogICAgICAgICAgICAgICAgICAgICAga2V5OiAiJShiaW5na2V5KXMiLAogICAgICAgICAgICAgICAgICAgICAgdHlwZTogIlJvYWQiLAogICAgICAgICAgICAgICAgICAgICAgc3BoZXJpY2FsTWVyY2F0b3I6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHZhciBiYWVyID0gbmV3IE9wZW5MYXllcnMuTGF5ZXIuQmluZyh7CiAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAiQmluZyBBZXJpYWwiLAogICAgICAgICAgICAgICAgICAgICAga2V5OiAiJShiaW5na2V5KXMiLAogICAgICAgICAgICAgICAgICAgICAgdHlwZTogIkFlcmlhbCIsCiAgICAgICAgICAgICAgICAgICAgICBzcGhlcmljYWxNZXJjYXRvcjogdHJ1ZQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgdmFyIGJoeWIgPSBuZXcgT3BlbkxheWVycy5MYXllci5CaW5nKHsKICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICJCaW5nIEh5YnJpZCIsCiAgICAgICAgICAgICAgICAgICAgICBrZXk6ICIlKGJpbmdrZXkpcyIsCiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAiQWVyaWFsV2l0aExhYmVscyIsCiAgICAgICAgICAgICAgICAgICAgICBzcGhlcmljYWxNZXJjYXRvcjogdHJ1ZQogICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBPU00gbGF5ZXIKICAgICAgICAgICAgICAgICAgdmFyIG9zbSA9IG5ldyBPcGVuTGF5ZXJzLkxheWVyLk9TTSgiT3BlblN0cmVldE1hcCIpOwoKICAgICAgICAgICIiIiAlIGFyZ3MgICAgIyBub3FhCgkJICAKICAgICAgICAgICAgaWYgc2VsZi5vcHRpb25zLnh5ejoKICAgICAgICAgICAgICAgIHMgKz0gIiIiCQkgIAogICAgICAgICAgICAgICAgICAvLyBjcmVhdGUgVE1TIE92ZXJsYXkgbGF5ZXIKICAgICAgICAgICAgICAgICAgIHZhciB0bXNvdmVybGF5ID0gbmV3IE9wZW5MYXllcnMuTGF5ZXIuWFlaKCJYWVogT3ZlcmxheSIsCiAgICAgICAgICAgICAgICAgICAgICAiJHt6fS8ke3h9LyR7eX0ucG5nIiwgewogICAgICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbkVmZmVjdDogJ3Jlc2l6ZScsCiAgICAgICAgICAgICAgICAgICAgICBpc0Jhc2VMYXllcjogZmFsc2UKICAgICAgICAgICAgICAgICAgfSk7CgkJCQkgIAoJCSAgICAgICAgIiIiICUgYXJncyAgICAjIG5vcWEKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHMgKz0gIiIiCQkgIAogICAgICAgICAgICAgICAgICAvLyBjcmVhdGUgVE1TIE92ZXJsYXkgbGF5ZXIKICAgICAgICAgICAgICAgICAgIHZhciB0bXNvdmVybGF5ID0gbmV3IE9wZW5MYXllcnMuTGF5ZXIuVE1TKCJUTVMgT3ZlcmxheSIsICIiLAogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlVmVyc2lvbjogJy4nLAogICAgICAgICAgICAgICAgICAgICAgbGF5ZXJuYW1lOiAnLicsCiAgICAgICAgICAgICAgICAgICAgICBhbHBoYTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICclKHRpbGVmb3JtYXQpcycsCiAgICAgICAgICAgICAgICAgICAgICBpc0Jhc2VMYXllcjogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICBnZXRVUkw6IGdldFVSTAogICAgICAgICAgICAgICAgICB9KTsKCQkJCSAgCgkJICAgICAgICAiIiIgJSBhcmdzICAgICMgbm9xYQkJICAKCQkgIAogICAgICAgICAgICBzICs9ICIiIiAgCiAgICAgICAgICAgICAgICAgIGlmIChPcGVuTGF5ZXJzLlV0aWwuYWxwaGFIYWNrKCkgPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgIHRtc292ZXJsYXkuc2V0T3BhY2l0eSgwLjcpOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBtYXAuYWRkTGF5ZXJzKFtnbWFwLCBnc2F0LCBnaHliLCBndGVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicm9hZCwgYmFlciwgYmh5YiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3NtLCB0bXNvdmVybGF5XSk7CgogICAgICAgICAgICAgICAgICB2YXIgc3dpdGNoZXJDb250cm9sID0gbmV3IE9wZW5MYXllcnMuQ29udHJvbC5MYXllclN3aXRjaGVyKCk7CiAgICAgICAgICAgICAgICAgIG1hcC5hZGRDb250cm9sKHN3aXRjaGVyQ29udHJvbCk7CiAgICAgICAgICAgICAgICAgIHN3aXRjaGVyQ29udHJvbC5tYXhpbWl6ZUNvbnRyb2woKTsKCiAgICAgICAgICAgICAgICAgIG1hcC56b29tVG9FeHRlbnQobWFwQm91bmRzLnRyYW5zZm9ybShtYXAuZGlzcGxheVByb2plY3Rpb24sIG1hcC5wcm9qZWN0aW9uKSk7CiAgICAgICAgICAiIiIgJSBhcmdzICAgICMgbm9xYQoKICAgICAgICBlbGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdnZW9kZXRpYyc6CiAgICAgICAgICAgIHMgKz0gIiIiCiAgICAgICAgICAgICAgICAgIHZhciBvcHRpb25zID0gewogICAgICAgICAgICAgICAgICAgICAgZGl2OiAibWFwIiwKICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xzOiBbXSwKICAgICAgICAgICAgICAgICAgICAgIHByb2plY3Rpb246ICJFUFNHOjQzMjYiCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIG1hcCA9IG5ldyBPcGVuTGF5ZXJzLk1hcChvcHRpb25zKTsKCiAgICAgICAgICAgICAgICAgIHZhciB3bXMgPSBuZXcgT3BlbkxheWVycy5MYXllci5XTVMoIlZNYXAwIiwKICAgICAgICAgICAgICAgICAgICAgICJodHRwOi8vdGlsZWNhY2hlLm9zZ2VvLm9yZy93bXMtYy9CYXNpYy5weT8iLAogICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgIGxheWVyczogJ2Jhc2ljJywKICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXQ6ICdpbWFnZS9wbmcnCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIHZhciB0bXNvdmVybGF5ID0gbmV3IE9wZW5MYXllcnMuTGF5ZXIuVE1TKCJUTVMgT3ZlcmxheSIsICIiLAogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlVmVyc2lvbjogJy4nLAogICAgICAgICAgICAgICAgICAgICAgbGF5ZXJuYW1lOiAnLicsCiAgICAgICAgICAgICAgICAgICAgICBhbHBoYTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICclKHRpbGVmb3JtYXQpcycsCiAgICAgICAgICAgICAgICAgICAgICBpc0Jhc2VMYXllcjogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICBnZXRVUkw6IGdldFVSTAogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgaWYgKE9wZW5MYXllcnMuVXRpbC5hbHBoYUhhY2soKSA9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgdG1zb3ZlcmxheS5zZXRPcGFjaXR5KDAuNyk7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIG1hcC5hZGRMYXllcnMoW3dtcyx0bXNvdmVybGF5XSk7CgogICAgICAgICAgICAgICAgICB2YXIgc3dpdGNoZXJDb250cm9sID0gbmV3IE9wZW5MYXllcnMuQ29udHJvbC5MYXllclN3aXRjaGVyKCk7CiAgICAgICAgICAgICAgICAgIG1hcC5hZGRDb250cm9sKHN3aXRjaGVyQ29udHJvbCk7CiAgICAgICAgICAgICAgICAgIHN3aXRjaGVyQ29udHJvbC5tYXhpbWl6ZUNvbnRyb2woKTsKCiAgICAgICAgICAgICAgICAgIG1hcC56b29tVG9FeHRlbnQobWFwQm91bmRzKTsKICAgICAgICAgICAiIiIgJSBhcmdzICAgIyBub3FhCgogICAgICAgIGVsaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ3Jhc3Rlcic6CiAgICAgICAgICAgIHMgKz0gIiIiCiAgICAgICAgICAgICAgICAgIHZhciBvcHRpb25zID0gewogICAgICAgICAgICAgICAgICAgICAgZGl2OiAibWFwIiwKICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xzOiBbXSwKICAgICAgICAgICAgICAgICAgICAgIG1heEV4dGVudDogbmV3IE9wZW5MYXllcnMuQm91bmRzKCUod2VzdClzLCAlKHNvdXRoKXMsICUoZWFzdClzLCAlKG5vcnRoKXMpLAogICAgICAgICAgICAgICAgICAgICAgbWF4UmVzb2x1dGlvbjogJShyYXN0ZXJtYXhyZXNvbHV0aW9uKWYsCiAgICAgICAgICAgICAgICAgICAgICBudW1ab29tTGV2ZWxzOiAlKHJhc3Rlcnpvb21sZXZlbHMpZAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBtYXAgPSBuZXcgT3BlbkxheWVycy5NYXAob3B0aW9ucyk7CgogICAgICAgICAgICAgICAgICB2YXIgbGF5ZXIgPSBuZXcgT3BlbkxheWVycy5MYXllci5UTVMoIlRNUyBMYXllciIsICIiLAogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlVmVyc2lvbjogJy4nLAogICAgICAgICAgICAgICAgICAgICAgbGF5ZXJuYW1lOiAnLicsCiAgICAgICAgICAgICAgICAgICAgICBhbHBoYTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICclKHRpbGVmb3JtYXQpcycsCiAgICAgICAgICAgICAgICAgICAgICBnZXRVUkw6IGdldFVSTAogICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgIG1hcC5hZGRMYXllcihsYXllcik7CiAgICAgICAgICAgICAgICAgIG1hcC56b29tVG9FeHRlbnQobWFwQm91bmRzKTsKICAgICAgICAiIiIgJSBhcmdzICAgICMgbm9xYQoKICAgICAgICBzICs9ICIiIgogICAgICAgICAgICAgICAgICBtYXAuYWRkQ29udHJvbHMoW25ldyBPcGVuTGF5ZXJzLkNvbnRyb2wuUGFuWm9vbUJhcigpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBPcGVuTGF5ZXJzLkNvbnRyb2wuTmF2aWdhdGlvbigpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBPcGVuTGF5ZXJzLkNvbnRyb2wuTW91c2VQb3NpdGlvbigpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBPcGVuTGF5ZXJzLkNvbnRyb2wuQXJnUGFyc2VyKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3IE9wZW5MYXllcnMuQ29udHJvbC5BdHRyaWJ1dGlvbigpXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICIiIiAlIGFyZ3MKCiAgICAgICAgaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ21lcmNhdG9yJyBhbmQgc2VsZi5vcHRpb25zLnh5eiBpcyBOb25lOgogICAgICAgICAgICBzICs9ICIiIgogICAgICAgICAgICAgIGZ1bmN0aW9uIGdldFVSTChib3VuZHMpIHsKICAgICAgICAgICAgICAgICAgYm91bmRzID0gdGhpcy5hZGp1c3RCb3VuZHMoYm91bmRzKTsKICAgICAgICAgICAgICAgICAgdmFyIHJlcyA9IHRoaXMuZ2V0U2VydmVyUmVzb2x1dGlvbigpOwogICAgICAgICAgICAgICAgICB2YXIgeCA9IE1hdGgucm91bmQoKGJvdW5kcy5sZWZ0IC0gdGhpcy50aWxlT3JpZ2luLmxvbikgLyAocmVzICogdGhpcy50aWxlU2l6ZS53KSk7CiAgICAgICAgICAgICAgICAgIHZhciB5ID0gTWF0aC5yb3VuZCgoYm91bmRzLmJvdHRvbSAtIHRoaXMudGlsZU9yaWdpbi5sYXQpIC8gKHJlcyAqIHRoaXMudGlsZVNpemUuaCkpOwogICAgICAgICAgICAgICAgICB2YXIgeiA9IHRoaXMuZ2V0U2VydmVyWm9vbSgpOwogICAgICAgICAgICAgICAgICBpZiAodGhpcy5tYXAuYmFzZUxheWVyLkNMQVNTX05BTUUgPT09ICdPcGVuTGF5ZXJzLkxheWVyLkJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICB6Kz0xOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBwYXRoID0gdGhpcy5zZXJ2aWNlVmVyc2lvbiArICIvIiArIHRoaXMubGF5ZXJuYW1lICsgIi8iICsgeiArICIvIiArIHggKyAiLyIgKyB5ICsgIi4iICsgdGhpcy50eXBlOwogICAgICAgICAgICAgICAgICB2YXIgdXJsID0gdGhpcy51cmw7CiAgICAgICAgICAgICAgICAgIGlmIChPcGVuTGF5ZXJzLlV0aWwuaXNBcnJheSh1cmwpKSB7CiAgICAgICAgICAgICAgICAgICAgICB1cmwgPSB0aGlzLnNlbGVjdFVybChwYXRoLCB1cmwpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChtYXBCb3VuZHMuaW50ZXJzZWN0c0JvdW5kcyhib3VuZHMpICYmICh6ID49IG1hcE1pblpvb20pICYmICh6IDw9IG1hcE1heFpvb20pKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXJsICsgcGF0aDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlbXB0eVRpbGVVUkw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICIiIiAlIGFyZ3MgICAgIyBub3FhCgogICAgICAgIGVsaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ2dlb2RldGljJzoKICAgICAgICAgICAgcyArPSAiIiIKICAgICAgICAgICAgICBmdW5jdGlvbiBnZXRVUkwoYm91bmRzKSB7CiAgICAgICAgICAgICAgICAgIGJvdW5kcyA9IHRoaXMuYWRqdXN0Qm91bmRzKGJvdW5kcyk7CiAgICAgICAgICAgICAgICAgIHZhciByZXMgPSB0aGlzLmdldFNlcnZlclJlc29sdXRpb24oKTsKICAgICAgICAgICAgICAgICAgdmFyIHggPSBNYXRoLnJvdW5kKChib3VuZHMubGVmdCAtIHRoaXMudGlsZU9yaWdpbi5sb24pIC8gKHJlcyAqIHRoaXMudGlsZVNpemUudykpOwogICAgICAgICAgICAgICAgICB2YXIgeSA9IE1hdGgucm91bmQoKGJvdW5kcy5ib3R0b20gLSB0aGlzLnRpbGVPcmlnaW4ubGF0KSAvIChyZXMgKiB0aGlzLnRpbGVTaXplLmgpKTsKICAgICAgICAgICAgICAgICAgdmFyIHogPSB0aGlzLmdldFNlcnZlclpvb20oKSUodG1zb2Zmc2V0KXM7CiAgICAgICAgICAgICAgICAgIHZhciBwYXRoID0gdGhpcy5zZXJ2aWNlVmVyc2lvbiArICIvIiArIHRoaXMubGF5ZXJuYW1lICsgIi8iICsgeiArICIvIiArIHggKyAiLyIgKyB5ICsgIi4iICsgdGhpcy50eXBlOwogICAgICAgICAgICAgICAgICB2YXIgdXJsID0gdGhpcy51cmw7CiAgICAgICAgICAgICAgICAgIGlmIChPcGVuTGF5ZXJzLlV0aWwuaXNBcnJheSh1cmwpKSB7CiAgICAgICAgICAgICAgICAgICAgICB1cmwgPSB0aGlzLnNlbGVjdFVybChwYXRoLCB1cmwpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChtYXBCb3VuZHMuaW50ZXJzZWN0c0JvdW5kcyhib3VuZHMpICYmICh6ID49IG1hcE1pblpvb20pICYmICh6IDw9IG1hcE1heFpvb20pKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXJsICsgcGF0aDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlbXB0eVRpbGVVUkw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICIiIiAlIGFyZ3MgICAgIyBub3FhCgogICAgICAgIGVsaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ3Jhc3Rlcic6CiAgICAgICAgICAgIHMgKz0gIiIiCiAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0VVJMKGJvdW5kcykgewogICAgICAgICAgICAgICAgICBib3VuZHMgPSB0aGlzLmFkanVzdEJvdW5kcyhib3VuZHMpOwogICAgICAgICAgICAgICAgICB2YXIgcmVzID0gdGhpcy5nZXRTZXJ2ZXJSZXNvbHV0aW9uKCk7CiAgICAgICAgICAgICAgICAgIHZhciB4ID0gTWF0aC5yb3VuZCgoYm91bmRzLmxlZnQgLSB0aGlzLnRpbGVPcmlnaW4ubG9uKSAvIChyZXMgKiB0aGlzLnRpbGVTaXplLncpKTsKICAgICAgICAgICAgICAgICAgdmFyIHkgPSBNYXRoLnJvdW5kKChib3VuZHMuYm90dG9tIC0gdGhpcy50aWxlT3JpZ2luLmxhdCkgLyAocmVzICogdGhpcy50aWxlU2l6ZS5oKSk7CiAgICAgICAgICAgICAgICAgIHZhciB6ID0gdGhpcy5nZXRTZXJ2ZXJab29tKCk7CiAgICAgICAgICAgICAgICAgIHZhciBwYXRoID0gdGhpcy5zZXJ2aWNlVmVyc2lvbiArICIvIiArIHRoaXMubGF5ZXJuYW1lICsgIi8iICsgeiArICIvIiArIHggKyAiLyIgKyB5ICsgIi4iICsgdGhpcy50eXBlOwogICAgICAgICAgICAgICAgICB2YXIgdXJsID0gdGhpcy51cmw7CiAgICAgICAgICAgICAgICAgIGlmIChPcGVuTGF5ZXJzLlV0aWwuaXNBcnJheSh1cmwpKSB7CiAgICAgICAgICAgICAgICAgICAgICB1cmwgPSB0aGlzLnNlbGVjdFVybChwYXRoLCB1cmwpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChtYXBCb3VuZHMuaW50ZXJzZWN0c0JvdW5kcyhib3VuZHMpICYmICh6ID49IG1hcE1pblpvb20pICYmICh6IDw9IG1hcE1heFpvb20pKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXJsICsgcGF0aDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlbXB0eVRpbGVVUkw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICIiIiAlIGFyZ3MgICAgIyBub3FhCgogICAgICAgIHMgKz0gIiIiCiAgICAgICAgICAgZnVuY3Rpb24gZ2V0V2luZG93SGVpZ2h0KCkgewogICAgICAgICAgICAgICAgaWYgKHNlbGYuaW5uZXJIZWlnaHQpIHJldHVybiBzZWxmLmlubmVySGVpZ2h0OwogICAgICAgICAgICAgICAgICAgIGlmIChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LmJvZHkpIHJldHVybiBkb2N1bWVudC5ib2R5LmNsaWVudEhlaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0V2luZG93V2lkdGgoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYuaW5uZXJXaWR0aCkgcmV0dXJuIHNlbGYuaW5uZXJXaWR0aDsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aDsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuYm9keSkgcmV0dXJuIGRvY3VtZW50LmJvZHkuY2xpZW50V2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHJlc2l6ZSgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbWFwID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm1hcCIpOwogICAgICAgICAgICAgICAgICAgIHZhciBoZWFkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiaGVhZGVyIik7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN1YmhlYWRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzdWJoZWFkZXIiKTsKICAgICAgICAgICAgICAgICAgICBtYXAuc3R5bGUuaGVpZ2h0ID0gKGdldFdpbmRvd0hlaWdodCgpLTgwKSArICJweCI7CiAgICAgICAgICAgICAgICAgICAgbWFwLnN0eWxlLndpZHRoID0gKGdldFdpbmRvd1dpZHRoKCktMjApICsgInB4IjsKICAgICAgICAgICAgICAgICAgICBoZWFkZXIuc3R5bGUud2lkdGggPSAoZ2V0V2luZG93V2lkdGgoKS0yMCkgKyAicHgiOwogICAgICAgICAgICAgICAgICAgIHN1YmhlYWRlci5zdHlsZS53aWR0aCA9IChnZXRXaW5kb3dXaWR0aCgpLTIwKSArICJweCI7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hcC51cGRhdGVTaXplKSB7IG1hcC51cGRhdGVTaXplKCk7IH07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgb25yZXNpemU9ZnVuY3Rpb24oKXsgcmVzaXplKCk7IH07CgogICAgICAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgICAgPC9oZWFkPgogICAgICAgICAgICAgIDxib2R5IG9ubG9hZD0iaW5pdCgpIj4KICAgICAgICAgICAgICAgIDxkaXYgaWQ9ImhlYWRlciI+PGgxPiUodGl0bGUpczwvaDE+PC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGlkPSJzdWJoZWFkZXIiPkdlbmVyYXRlZCBieSA8YSBocmVmPSJodHRwOi8vd3d3Lmtsb2thbi5jei9wcm9qZWN0cy9nZGFsMnRpbGVzLyI+R0RBTDJUaWxlczwvYT4sIENvcHlyaWdodCAmY29weTsgMjAwOCA8YSBocmVmPSJodHRwOi8vd3d3Lmtsb2thbi5jei8iPktsb2thbiBQZXRyIFByaWRhbDwvYT4sICA8YSBocmVmPSJodHRwOi8vd3d3LmdkYWwub3JnLyI+R0RBTDwvYT4gJmFtcDsgPGEgaHJlZj0iaHR0cDovL3d3dy5vc2dlby5vcmcvIj5PU0dlbzwvYT4gPGEgaHJlZj0iaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9zb2MvIj5HU29DPC9hPgogICAgICAgICAgICAgICAgPCEtLSBQTEVBU0UsIExFVCBUSElTIE5PVEUgQUJPVVQgQVVUSE9SIEFORCBQUk9KRUNUIFNPTUVXSEVSRSBPTiBZT1VSIFdFQlNJVEUsIE9SIEFUIExFQVNUIElOIFRIRSBDT01NRU5UIElOIEhUTUwuIFRIQU5LIFlPVSAtLT4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBpZD0ibWFwIj48L2Rpdj4KICAgICAgICAgICAgICAgIDxzY3JpcHQgdHlwZT0idGV4dC9qYXZhc2NyaXB0IiA+cmVzaXplKCk8L3NjcmlwdD4KICAgICAgICAgICAgICA8L2JvZHk+CiAgICAgICAgICAgIDwvaHRtbD4iIiIgJSBhcmdzICAgIyBub3FhCgogICAgICAgIHJldHVybiBzCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldFl0aWxlKHR5LCB0eiwgb3B0aW9ucyk6CiAgICAgICAgIiIiCiAgICAgICAgQ2FsY3VsYXRlcyB0aGUgeS10aWxlIG51bWJlciBiYXNlZCBvbiB3aGV0aGVyIFhZWiBvciBUTVMgKGRlZmF1bHQpIHN5c3RlbSBpcyB1c2VkCiAgICAgICAgOnBhcmFtIHR5OiBUaGUgeS10aWxlIG51bWJlcgogICAgICAgIDpyZXR1cm46IFRoZSB0cmFuc2Zvcm1lZCB0aWxlIG51bWJlcgogICAgICAgICIiIgogICAgICAgIGlmIG9wdGlvbnMueHl6OgogICAgICAgICAgICByZXR1cm4gKDIqKnR6IC0gMSkgLSB0eSAgIyBDb252ZXJ0IGZyb20gVE1TIHRvIFhZWiBudW1iZXJpbmcgc3lzdGVtCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHR5CgoKZGVmIHdvcmtlcl90aWxlX2RldGFpbHMoaW5wdXRfZmlsZSwgb3V0cHV0X2ZvbGRlciwgb3B0aW9ucywgc2VuZF9waXBlPU5vbmUpOgogICAgdHJ5OgogICAgICAgIGdkYWwydGlsZXMgPSBHREFMMlRpbGVzKGlucHV0X2ZpbGUsIG91dHB1dF9mb2xkZXIsIG9wdGlvbnMpCiAgICAgICAgZ2RhbDJ0aWxlcy5vcGVuX2lucHV0KCkKICAgICAgICBnZGFsMnRpbGVzLmdlbmVyYXRlX21ldGFkYXRhKCkKICAgICAgICB0aWxlX2pvYl9pbmZvLCB0aWxlX2RldGFpbHMgPSBnZGFsMnRpbGVzLmdlbmVyYXRlX2Jhc2VfdGlsZXMoKQogICAgICAgIHJldHVybl9kYXRhID0gKHRpbGVfam9iX2luZm8sIHRpbGVfZGV0YWlscykKICAgICAgICBpZiBzZW5kX3BpcGU6CiAgICAgICAgICAgIHNlbmRfcGlwZS5zZW5kKHJldHVybl9kYXRhKQoKICAgICAgICByZXR1cm4gcmV0dXJuX2RhdGEKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludCgid29ya2VyX3RpbGVfZGV0YWlscyBmYWlsZWQgIiwgc3RyKGUpKQoKCmRlZiBwcm9ncmVzc19wcmludGVyX3RocmVhZChxdWV1ZSwgbmJfam9icyk6CiAgICBwYiA9IFByb2dyZXNzQmFyKG5iX2pvYnMpCiAgICBwYi5zdGFydCgpCiAgICBmb3IgXyBpbiByYW5nZShuYl9qb2JzKToKICAgICAgICBxdWV1ZS5nZXQoKQogICAgICAgIHBiLmxvZ19wcm9ncmVzcygpCiAgICAgICAgcXVldWUudGFza19kb25lKCkKCgpjbGFzcyBQcm9ncmVzc0JhcihvYmplY3QpOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB0b3RhbF9pdGVtcyk6CiAgICAgICAgc2VsZi50b3RhbF9pdGVtcyA9IHRvdGFsX2l0ZW1zCiAgICAgICAgc2VsZi5uYl9pdGVtc19kb25lID0gMAogICAgICAgIHNlbGYuY3VycmVudF9wcm9ncmVzcyA9IDAKICAgICAgICBzZWxmLlNURVAgPSAyLjUKCiAgICBkZWYgc3RhcnQoc2VsZik6CiAgICAgICAgc3lzLnN0ZG91dC53cml0ZSgiMCIpCgogICAgZGVmIGxvZ19wcm9ncmVzcyhzZWxmLCBuYl9pdGVtcz0xKToKICAgICAgICBzZWxmLm5iX2l0ZW1zX2RvbmUgKz0gbmJfaXRlbXMKICAgICAgICBwcm9ncmVzcyA9IGZsb2F0KHNlbGYubmJfaXRlbXNfZG9uZSkgLyBzZWxmLnRvdGFsX2l0ZW1zICogMTAwCiAgICAgICAgaWYgcHJvZ3Jlc3MgPj0gc2VsZi5jdXJyZW50X3Byb2dyZXNzICsgc2VsZi5TVEVQOgogICAgICAgICAgICBkb25lID0gRmFsc2UKICAgICAgICAgICAgd2hpbGUgbm90IGRvbmU6CiAgICAgICAgICAgICAgICBpZiBzZWxmLmN1cnJlbnRfcHJvZ3Jlc3MgKyBzZWxmLlNURVAgPD0gcHJvZ3Jlc3M6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3Byb2dyZXNzICs9IHNlbGYuU1RFUAogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuY3VycmVudF9wcm9ncmVzcyAlIDEwID09IDA6CiAgICAgICAgICAgICAgICAgICAgICAgIHN5cy5zdGRvdXQud3JpdGUoc3RyKGludChzZWxmLmN1cnJlbnRfcHJvZ3Jlc3MpKSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5jdXJyZW50X3Byb2dyZXNzID09IDEwMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN5cy5zdGRvdXQud3JpdGUoIlxuIikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBzeXMuc3Rkb3V0LndyaXRlKCIuIikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgZG9uZSA9IFRydWUKICAgICAgICBzeXMuc3Rkb3V0LmZsdXNoKCkKCgpkZWYgZ2V0X3RpbGVfc3duZSh0aWxlX2pvYl9pbmZvLCBvcHRpb25zKToKICAgIGlmIG9wdGlvbnMucHJvZmlsZSA9PSAnbWVyY2F0b3InOgogICAgICAgIG1lcmNhdG9yID0gR2xvYmFsTWVyY2F0b3IoKQogICAgICAgIHRpbGVfc3duZSA9IG1lcmNhdG9yLlRpbGVMYXRMb25Cb3VuZHMKICAgIGVsaWYgb3B0aW9ucy5wcm9maWxlID09ICdnZW9kZXRpYyc6CiAgICAgICAgZ2VvZGV0aWMgPSBHbG9iYWxHZW9kZXRpYyhvcHRpb25zLnRtc2NvbXBhdGlibGUpCiAgICAgICAgdGlsZV9zd25lID0gZ2VvZGV0aWMuVGlsZUxhdExvbkJvdW5kcwogICAgZWxpZiBvcHRpb25zLnByb2ZpbGUgPT0gJ3Jhc3Rlcic6CiAgICAgICAgc3JzNDMyNiA9IG9zci5TcGF0aWFsUmVmZXJlbmNlKCkKICAgICAgICBzcnM0MzI2LkltcG9ydEZyb21FUFNHKDQzMjYpCiAgICAgICAgaWYgdGlsZV9qb2JfaW5mby5rbWwgYW5kIHRpbGVfam9iX2luZm8uaW5fc3JzX3drdDoKICAgICAgICAgICAgaW5fc3JzID0gb3NyLlNwYXRpYWxSZWZlcmVuY2UoKQogICAgICAgICAgICBpbl9zcnMuSW1wb3J0RnJvbVdrdCh0aWxlX2pvYl9pbmZvLmluX3Nyc193a3QpCiAgICAgICAgICAgIGN0ID0gb3NyLkNvb3JkaW5hdGVUcmFuc2Zvcm1hdGlvbihpbl9zcnMsIHNyczQzMjYpCgogICAgICAgICAgICBkZWYgcmFzdGVydGlsZXN3bmUoeCwgeSwgeik6CiAgICAgICAgICAgICAgICBwaXhlbHNpemV4ID0gKDIgKiogKHRpbGVfam9iX2luZm8udG1heHogLSB6KSAqIHRpbGVfam9iX2luZm8ub3V0X2dlb190cmFuc1sxXSkKICAgICAgICAgICAgICAgIHdlc3QgPSB0aWxlX2pvYl9pbmZvLm91dF9nZW9fdHJhbnNbMF0gKyB4ICogdGlsZV9qb2JfaW5mby50aWxlc2l6ZSAqIHBpeGVsc2l6ZXgKICAgICAgICAgICAgICAgIGVhc3QgPSB3ZXN0ICsgdGlsZV9qb2JfaW5mby50aWxlc2l6ZSAqIHBpeGVsc2l6ZXgKICAgICAgICAgICAgICAgIHNvdXRoID0gdGlsZV9qb2JfaW5mby5vbWlueSArIHkgKiB0aWxlX2pvYl9pbmZvLnRpbGVzaXplICogcGl4ZWxzaXpleAogICAgICAgICAgICAgICAgbm9ydGggPSBzb3V0aCArIHRpbGVfam9iX2luZm8udGlsZXNpemUgKiBwaXhlbHNpemV4CiAgICAgICAgICAgICAgICBpZiBub3QgdGlsZV9qb2JfaW5mby5pc19lcHNnXzQzMjY6CiAgICAgICAgICAgICAgICAgICAgIyBUcmFuc2Zvcm1hdGlvbiB0byBFUFNHOjQzMjYgKFdHUzg0IGRhdHVtKQogICAgICAgICAgICAgICAgICAgIHdlc3QsIHNvdXRoID0gY3QuVHJhbnNmb3JtUG9pbnQod2VzdCwgc291dGgpWzoyXQogICAgICAgICAgICAgICAgICAgIGVhc3QsIG5vcnRoID0gY3QuVHJhbnNmb3JtUG9pbnQoZWFzdCwgbm9ydGgpWzoyXQogICAgICAgICAgICAgICAgcmV0dXJuIHNvdXRoLCB3ZXN0LCBub3J0aCwgZWFzdAoKICAgICAgICAgICAgdGlsZV9zd25lID0gcmFzdGVydGlsZXN3bmUKICAgICAgICBlbHNlOgogICAgICAgICAgICB0aWxlX3N3bmUgPSBsYW1iZGEgeCwgeSwgejogKDAsIDAsIDAsIDApICAgIyBub3FhCiAgICBlbHNlOgogICAgICAgIHRpbGVfc3duZSA9IGxhbWJkYSB4LCB5LCB6OiAoMCwgMCwgMCwgMCkgICAjIG5vcWEKCiAgICByZXR1cm4gdGlsZV9zd25lCgoKZGVmIHNpbmdsZV90aHJlYWRlZF90aWxpbmcoaW5wdXRfZmlsZSwgb3V0cHV0X2ZvbGRlciwgb3B0aW9ucyk6CiAgICAiIiIKICAgIEtlZXAgYSBzaW5nbGUgdGhyZWFkZWQgdmVyc2lvbiB0aGF0IHN0YXlzIGNsZWFyIG9mIG11bHRpcHJvY2Vzc2luZywgZm9yIHBsYXRmb3JtcyB0aGF0IHdvdWxkIG5vdAogICAgc3VwcG9ydCBpdAogICAgIiIiCiAgICBpZiBvcHRpb25zLnZlcmJvc2U6CiAgICAgICAgcHJpbnQoIkJlZ2luIHRpbGVzIGRldGFpbHMgY2FsYyIpCiAgICBjb25mLCB0aWxlX2RldGFpbHMgPSB3b3JrZXJfdGlsZV9kZXRhaWxzKGlucHV0X2ZpbGUsIG91dHB1dF9mb2xkZXIsIG9wdGlvbnMpCgogICAgaWYgb3B0aW9ucy52ZXJib3NlOgogICAgICAgIHByaW50KCJUaWxlcyBkZXRhaWxzIGNhbGMgY29tcGxldGUuIikKCiAgICBpZiBub3Qgb3B0aW9ucy52ZXJib3NlIGFuZCBub3Qgb3B0aW9ucy5xdWlldDoKICAgICAgICBwcm9ncmVzc19iYXIgPSBQcm9ncmVzc0JhcihsZW4odGlsZV9kZXRhaWxzKSkKICAgICAgICBwcm9ncmVzc19iYXIuc3RhcnQoKQoKICAgIGZvciB0aWxlX2RldGFpbCBpbiB0aWxlX2RldGFpbHM6CiAgICAgICAgY3JlYXRlX2Jhc2VfdGlsZShjb25mLCB0aWxlX2RldGFpbCwgb3B0aW9ucykKCiAgICAgICAgaWYgbm90IG9wdGlvbnMudmVyYm9zZSBhbmQgbm90IG9wdGlvbnMucXVpZXQ6CiAgICAgICAgICAgIHByb2dyZXNzX2Jhci5sb2dfcHJvZ3Jlc3MoKQoKICAgIGNyZWF0ZV9vdmVydmlld190aWxlcyhjb25mLCBvdXRwdXRfZm9sZGVyLCBvcHRpb25zKQoKICAgIHNodXRpbC5ybXRyZWUob3MucGF0aC5kaXJuYW1lKGNvbmYuc3JjX2ZpbGUpKQoKCmRlZiBtdWx0aV90aHJlYWRlZF90aWxpbmcoaW5wdXRfZmlsZSwgb3V0cHV0X2ZvbGRlciwgb3B0aW9ucyk6CiAgICBuYl9wcm9jZXNzZXMgPSBvcHRpb25zLm5iX3Byb2Nlc3NlcyBvciAxCiAgICAoY29uZl9yZWNlaXZlciwgY29uZl9zZW5kZXIpID0gUGlwZShGYWxzZSkKCiAgICBpZiBvcHRpb25zLnZlcmJvc2U6CiAgICAgICAgcHJpbnQoIkJlZ2luIHRpbGVzIGRldGFpbHMgY2FsYyIpCiAgICBwID0gUHJvY2Vzcyh0YXJnZXQ9d29ya2VyX3RpbGVfZGV0YWlscywKICAgICAgICAgICAgICAgIGFyZ3M9W2lucHV0X2ZpbGUsIG91dHB1dF9mb2xkZXIsIG9wdGlvbnNdLAogICAgICAgICAgICAgICAga3dhcmdzPXsic2VuZF9waXBlIjogY29uZl9zZW5kZXJ9KQogICAgcC5zdGFydCgpCiAgICAjIE1ha2Ugc3VyZSB0byBjb25zdW1lIHRoZSBxdWV1ZSBiZWZvcmUgam9pbmluZy4gSWYgdGhlIHBheWxvYWQgaXMgdG9vIGJpZywgaXQgd29uJ3QgYmUgcHV0IGluCiAgICAjIG9uZSBnbyBpbiB0aGUgcXVldWUgYW5kIHRoZXJlZm9yZSB0aGUgc2VuZGluZyBwcm9jZXNzIHdpbGwgbmV2ZXIgZmluaXNoLCB3YWl0aW5nIGZvciBzcGFjZSBpbgogICAgIyB0aGUgcXVldWUgdG8gc2VuZCBkYXRhCiAgICBjb25mLCB0aWxlX2RldGFpbHMgPSBjb25mX3JlY2VpdmVyLnJlY3YoKQogICAgcC5qb2luKCkKICAgIGlmIG9wdGlvbnMudmVyYm9zZToKICAgICAgICBwcmludCgiVGlsZXMgZGV0YWlscyBjYWxjIGNvbXBsZXRlLiIpCiAgICAjIEhhdmUgdG8gY3JlYXRlIHRoZSBRdWV1ZSB0aHJvdWdoIGEgbXVsdGlwcm9jZXNzaW5nLk1hbmFnZXIgdG8gZ2V0IGEgUXVldWUgUHJveHksCiAgICAjIG90aGVyd2lzZSB5b3UgY2FuJ3QgcGFzcyBpdCBhcyBhIHBhcmFtIGluIHRoZSBtZXRob2QgaW52b2tlZCBieSB0aGUgcG9vbC4uLgogICAgbWFuYWdlciA9IE1hbmFnZXIoKQogICAgcXVldWUgPSBtYW5hZ2VyLlF1ZXVlKCkKICAgIHBvb2wgPSBQb29sKHByb2Nlc3Nlcz1uYl9wcm9jZXNzZXMpCiAgICAjIFRPRE86IGdiYXRhaWxsZSAtIGNoZWNrIHRoZSBjb25mcyBmb3Igd2hpY2ggZWFjaCBlbGVtZW50IGlzIGFuIGFycmF5Li4uIG9uZSB1c2VsZXNzIGxldmVsPwogICAgIyBUT0RPOiBnYmF0YWlsbGUgLSBhc3NpZ24gYW4gSUQgdG8gZWFjaCBqb2IgZm9yIHByaW50IGluIHZlcmJvc2UgbW9kZSAiUmVhZFJhc3RlciBFeHRlbnQgLi4uIgogICAgIyBUT0RPOiBnYmF0YWlsbGUgLSBjaGVjayBtZW1vcnkgZm9vdHByaW50IGFuZCB0aW1lIG9uIGJpZyBpbWFnZS4gYXJlIHRoZXkgb3BlbmVkIHggdGltZXMKICAgIGZvciB0aWxlX2RldGFpbCBpbiB0aWxlX2RldGFpbHM6CiAgICAgICAgcG9vbC5hcHBseV9hc3luYyhjcmVhdGVfYmFzZV90aWxlLCAoY29uZiwgdGlsZV9kZXRhaWwsIG9wdGlvbnMpLCB7InF1ZXVlIjogcXVldWV9KQoKICAgIGlmIG5vdCBvcHRpb25zLnZlcmJvc2UgYW5kIG5vdCBvcHRpb25zLnF1aWV0OgogICAgICAgIHAgPSBQcm9jZXNzKHRhcmdldD1wcm9ncmVzc19wcmludGVyX3RocmVhZCwgYXJncz1bcXVldWUsIGxlbih0aWxlX2RldGFpbHMpXSkKICAgICAgICBwLnN0YXJ0KCkKCiAgICBwb29sLmNsb3NlKCkKICAgIHBvb2wuam9pbigpICAgICAjIEpvYnMgZmluaXNoZWQKICAgIGlmIG5vdCBvcHRpb25zLnZlcmJvc2UgYW5kIG5vdCBvcHRpb25zLnF1aWV0OgogICAgICAgIHAuam9pbigpICAgICAgICAjIFRyYWNlcyBkb25lCgogICAgY3JlYXRlX292ZXJ2aWV3X3RpbGVzKGNvbmYsIG91dHB1dF9mb2xkZXIsIG9wdGlvbnMpCgogICAgc2h1dGlsLnJtdHJlZShvcy5wYXRoLmRpcm5hbWUoY29uZi5zcmNfZmlsZSkpCgoKIyBkZWYgbWFpbigpOgojICAgICAjIFRPRE86IGdiYXRhaWxsZSAtIHVzZSBta2R0ZW1wIHRvIHdvcmsgaW4gYSB0ZW1wIGRpcmVjdG9yeQojICAgICAjIFRPRE86IGdiYXRhaWxsZSAtIGRlYnVnIGludGVybWVkaWF0ZSB0aWxlcy52cnQgbm90IHByb2R1Y2VkIGFueW1vcmU/CiMgICAgICMgVE9ETzogZ2JhdGFpbGxlIC0gUmVmYWN0b3IgZ2VuZXJhdGUgb3ZlcnZpZXcgdGlsZXMgdG8gbm90IGRlcGVuZCBvbiBzZWxmIHZhcmlhYmxlcwojICAgICBhcmd2ID0gZ2RhbC5HZW5lcmFsQ21kTGluZVByb2Nlc3NvcihzeXMuYXJndikKIyAgICAgaW5wdXRfZmlsZSwgb3V0cHV0X2ZvbGRlciwgb3B0aW9ucyA9IHByb2Nlc3NfYXJncyhhcmd2WzE6XSkKIyAgICAgbmJfcHJvY2Vzc2VzID0gb3B0aW9ucy5uYl9wcm9jZXNzZXMgb3IgMQojCiMgICAgIGlmIG5iX3Byb2Nlc3NlcyA9PSAxOgojICAgICAgICAgc2luZ2xlX3RocmVhZGVkX3RpbGluZyhpbnB1dF9maWxlLCBvdXRwdXRfZm9sZGVyLCBvcHRpb25zKQojICAgICBlbHNlOgojICAgICAgICAgbXVsdGlfdGhyZWFkZWRfdGlsaW5nKGlucHV0X2ZpbGUsIG91dHB1dF9mb2xkZXIsIG9wdGlvbnMpCiMKIyBpZiBfX25hbWVfXyA9PSAnX19tYWluX18nOgojICAgICAjIHN0YXJ0X3RpbWUgPSB0aW1lLnRpbWUoKQojICAgICBtYWluKCkKIyAgICAgIyBwcmludCgiLS0tICVzIHNlY29uZHMgLS0tIiAlICh0aW1lLnRpbWUoKSAtIHN0YXJ0X3RpbWUpKQoKI2dkYWxfdHJhbnNsYXRlIC1vZiB2cnQgLWV4cGFuZCByZ2JhIEY6XERhbmlsb1xUcmFtcG9cZGF0YV9kaXJcZGF0YVxyZW1hbmVzY2VudGVzX2Zsb3Jlc3RhaXNfZGVzbWF0YW1lbnRvXGJyYXNpbFxwcm9kZXNccHJvZGVzLnRpZiBwcm9kZXMudnJ0CiMgaW5wdXRfZmlsZSA9ICJGOlxcRGFuaWxvXFxUcmFtcG9cXGRhdGFfZGlyXFxkYXRhXFxyZW1hbmVzY2VudGVzX2Zsb3Jlc3RhaXNfZGVzbWF0YW1lbnRvXFxicmFzaWxcXHByb2Rlc1xccHJvZGVzLnZydCIgIyJGOlxcRGFuaWxvXFxUcmFtcG9cXGRhdGFfZGlyXFxkYXRhXFxyZW1hbmVzY2VudGVzX2Zsb3Jlc3RhaXNfZGVzbWF0YW1lbnRvXFxicmFzaWxcXHBlcmRhX2NvYmVydHVyYV92ZWdldGFsX2Fub19oYW5zZW5cXGxvc3N5ZWFyLnRpZiIKIyBvdXRwdXRfZm9sZGVyID0gIkY6XFxEYW5pbG9cXFRlbXBcXHJlc3VsdFxccHJvZGVzX3B1Ymxpc2hcXCIKI2dlbmVyYXRlVGlsZUZvck1hcChpbnB1dF9maWxlLCBvdXRwdXRfZm9sZGVyKQoKY2xhc3MgT3B0aW9uczoKICAgIHByb2ZpbGUgPSAibWVyY2F0b3IiCiAgICByZXNhbXBsaW5nID0gJ25lYXInCiAgICBzX3NycyA9IE5vbmUKICAgIHpvb209ICcwLTInCiAgICByZXN1bWUgPSBGYWxzZQogICAgc3Jjbm9kYXRhID0gJycKICAgIHRtc2NvbXBhdGlibGUgPSBGYWxzZQogICAgeHl6ID0gVHJ1ZQogICAgdmVyYm9zZSA9IEZhbHNlCiAgICBxdWlldCA9IFRydWUKICAgIG5iX3Byb2Nlc3NlcyA9IDEKICAgIGttbCA9IEZhbHNlCiAgICB1cmwgPSAnJwogICAgd2Vidmlld2VyID0nbm9uZScKICAgIHRpdGxlID0gJycKICAgIGNvcHlyaWdodCA9ICcnCiAgICBnb29nbGVrZXkgPSAnJwogICAgYmluZ2tleSA9ICcnCiAgICBsZWdlbmRPYmogPSBOb25lCiAgICBnZW5lcmF0ZWRGaWxlcyA9IFtdCgpkZWYgZ2VuZXJhdGVUaWxlRm9yTWFwKGlucHV0X2ZpbGUsIG91dHB1dF9mb2xkZXIsIG1heFpvb20sIHJlc3VtZSwgbGVnZW5kT2JqKToKICAgIG9wdGlvbnMgPSBPcHRpb25zKCkKICAgIG9wdGlvbnMudmVyYm9zZSA9IEZhbHNlCiAgICBvcHRpb25zLnJlc2FtcGxpbmcgPSAnbmVhcicKICAgIG9wdGlvbnMuem9vbSA9ICcwLScgKyBzdHIobWF4Wm9vbSkKICAgIG9wdGlvbnMucmVzdW1lID0gcmVzdW1lCiAgICBvcHRpb25zLmxlZ2VuZE9iaiA9IGxlZ2VuZE9iagogICAgc2luZ2xlX3RocmVhZGVkX3RpbGluZyhpbnB1dF9maWxlLCBvdXRwdXRfZm9sZGVyLCBvcHRpb25zKQogICAgZm9yIGZpbGVuYW1lIGluIG9wdGlvbnMuZ2VuZXJhdGVkRmlsZXM6CiAgICAgICAgYXBwbHlMZWdlbmQoZmlsZW5hbWUsIG9wdGlvbnMubGVnZW5kT2JqKQogICAgI211bHRpX3RocmVhZGVkX3RpbGluZyhpbnB1dF9maWxlLCBvdXRwdXRfZm9sZGVyLCBvcHRpb25zKQoKCnRyeToKICAgIGZyb20gV01TQ2FwYWJpbGl0aWVzIGltcG9ydCBXTVNDYXBhYmlsaXRpZXMKICAgIGZyb20gV01TQ2FwYWJpbGl0aWVzIGltcG9ydCBXTVNCQm94CmV4Y2VwdDoKICAgIHBhc3MgI05vdCBpbiBEaW5hbWljYSBDb2RlCgojIS91c3IvYmluL2VudiBweXRob24KIyAtKi0gY29kaW5nOiB1dGYtOCAtKi0KCgppc0RpbmFtaWNhID0gRmFsc2UKdHJ5OgogICAgZGluYW1pY2EucGFja2FnZSgib3MiKQogICAgaXNEaW5hbWljYSA9IFRydWUKZXhjZXB0OgogICAgaXNEaW5hbWljYSA9IEZhbHNlCgppZiBub3QgaXNEaW5hbWljYToKICAgIHRyeToKICAgICAgICBmcm9tIC5VVElMUyBpbXBvcnQgVVRJTFMKICAgICAgICBmcm9tIC4gaW1wb3J0IHhtbHRvZGljdAogICAgZXhjZXB0OgogICAgICAgIHBhc3MgI05vdCBpbiBRR0lTCgogICAgdHJ5OgogICAgICAgIGZyb20gVVRJTFMgaW1wb3J0IFVUSUxTCiAgICAgICAgZnJvbSB4bWx0b2RpY3QgaW1wb3J0IHhtbHRvZGljdAogICAgZXhjZXB0OgogICAgICAgIHBhc3MgI05vdCBpbiBEaW5hbWljYSBDb2RlCgpmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBPcmRlcmVkRGljdAppbXBvcnQgY29sbGVjdGlvbnMKZnJvbSBwYXRobGliIGltcG9ydCBQYXRoCmltcG9ydCBqc29uCmltcG9ydCBvcwppbXBvcnQgaW8KaW1wb3J0IGNzdgppbXBvcnQgcmUKCiMgdHJ5OgojICAgICBmcm9tIHFnaXMuY29yZSBpbXBvcnQgKFFnc0Nvb3JkaW5hdGVSZWZlcmVuY2VTeXN0ZW0sIFFnc1Byb2plY3QsIFFnc1BvaW50WFksIFFnc0Nvb3JkaW5hdGVUcmFuc2Zvcm0sIFFnc1ZlY3RvckxheWVyKQojIGV4Y2VwdDoKIyAgICAgcGFzcwoKY2xhc3MgV01TQ2FwYWJpbGl0aWVzOgoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXREZWZhdWx0Q2FwYWJpbGl0aWVzKCk6CiAgICAgICAgcmV0dXJuICcnJzw/eG1sIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9IlVURi04Ij8+PCFET0NUWVBFIFdNVF9NU19DYXBhYmlsaXRpZXMgU1lTVEVNICJodHRwOi8vbWFwcy5jc3IudWZtZy5icjo4MC9nZW9zZXJ2ZXIvc2NoZW1hcy93bXMvMS4xLjEvV01TX01TX0NhcGFiaWxpdGllcy5kdGQiWwogICAgPCFFTEVNRU5UIFZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzIChUaWxlU2V0KikgPgogICAgPCFFTEVNRU5UIFRpbGVTZXQgKFNSUywgQm91bmRpbmdCb3g/LCBSZXNvbHV0aW9ucywgV2lkdGgsIEhlaWdodCwgRm9ybWF0LCBMYXllcnMqLCBTdHlsZXMqKSA+CiAgICA8IUVMRU1FTlQgUmVzb2x1dGlvbnMgKCNQQ0RBVEEpID4KICAgIDwhRUxFTUVOVCBXaWR0aCAoI1BDREFUQSkgPgogICAgPCFFTEVNRU5UIEhlaWdodCAoI1BDREFUQSkgPgogICAgPCFFTEVNRU5UIExheWVycyAoI1BDREFUQSkgPgogICAgPCFFTEVNRU5UIFN0eWxlcyAoI1BDREFUQSkgPgogICAgXT4KICAgIDxXTVRfTVNfQ2FwYWJpbGl0aWVzIHZlcnNpb249IjEuMS4xIiB1cGRhdGVTZXF1ZW5jZT0iNjMyNTgiPgogICAgICA8U2VydmljZT4KICAgICAgICA8TmFtZT5PR0M6V01TPC9OYW1lPgogICAgICAgIDxUaXRsZT5DU1IgV2ViIE1hcCBTZXJ2aWNlPC9UaXRsZT4KICAgICAgICA8QWJzdHJhY3Q+Q29tcGxpYW50IFdNUyBSZXNwb25zZTwvQWJzdHJhY3Q+CiAgICAgICAgPEtleXdvcmRMaXN0PgogICAgICAgICAgPEtleXdvcmQ+V0ZTPC9LZXl3b3JkPgogICAgICAgICAgPEtleXdvcmQ+V01TPC9LZXl3b3JkPgogICAgICAgICAgPEtleXdvcmQ+R0VPU0VSVkVSPC9LZXl3b3JkPgogICAgICAgIDwvS2V5d29yZExpc3Q+CiAgICAgICAgPE9ubGluZVJlc291cmNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazp0eXBlPSJzaW1wbGUiIHhsaW5rOmhyZWY9Imh0dHA6Ly9nZW9zZXJ2ZXIuc291cmNlZm9yZ2UubmV0L2h0bWwvaW5kZXgucGhwIi8+CiAgICAgICAgPENvbnRhY3RJbmZvcm1hdGlvbj4KICAgICAgICAgIDxDb250YWN0UGVyc29uUHJpbWFyeT4KICAgICAgICAgICAgPENvbnRhY3RQZXJzb24+R0lUSFVCIG93bmVyPC9Db250YWN0UGVyc29uPgogICAgICAgICAgICA8Q29udGFjdE9yZ2FuaXphdGlvbj5HSVRIVUIgb3duZXI8L0NvbnRhY3RPcmdhbml6YXRpb24+CiAgICAgICAgICA8L0NvbnRhY3RQZXJzb25QcmltYXJ5PgogICAgICAgICAgPENvbnRhY3RQb3NpdGlvbj5DaGllZiBnZW9ncmFwaGVyPC9Db250YWN0UG9zaXRpb24+CiAgICAgICAgICA8Q29udGFjdEFkZHJlc3M+CiAgICAgICAgICAgIDxBZGRyZXNzVHlwZT5Xb3JrPC9BZGRyZXNzVHlwZT4KICAgICAgICAgICAgPEFkZHJlc3MvPgogICAgICAgICAgICA8Q2l0eT5BbGV4YW5kcmlhPC9DaXR5PgogICAgICAgICAgICA8U3RhdGVPclByb3ZpbmNlLz4KICAgICAgICAgICAgPFBvc3RDb2RlLz4KICAgICAgICAgICAgPENvdW50cnk+RWd5cHQ8L0NvdW50cnk+CiAgICAgICAgICA8L0NvbnRhY3RBZGRyZXNzPgogICAgICAgICAgPENvbnRhY3RWb2ljZVRlbGVwaG9uZS8+CiAgICAgICAgICA8Q29udGFjdEZhY3NpbWlsZVRlbGVwaG9uZS8+CiAgICAgICAgICA8Q29udGFjdEVsZWN0cm9uaWNNYWlsQWRkcmVzcz5jbGF1ZGl1cy5wdG9sb21hZXVzQGdtYWlsLmNvbTwvQ29udGFjdEVsZWN0cm9uaWNNYWlsQWRkcmVzcz4KICAgICAgICA8L0NvbnRhY3RJbmZvcm1hdGlvbj4KICAgICAgICA8RmVlcz5OT05FPC9GZWVzPgogICAgICAgIDxBY2Nlc3NDb25zdHJhaW50cz5OT05FPC9BY2Nlc3NDb25zdHJhaW50cz4KICAgICAgPC9TZXJ2aWNlPgogICAgICA8Q2FwYWJpbGl0eT4KICAgICAgICA8UmVxdWVzdD4KICAgICAgICAgIDxHZXRDYXBhYmlsaXRpZXM+CiAgICAgICAgICAgIDxGb3JtYXQ+YXBwbGljYXRpb24vdm5kLm9nYy53bXNfeG1sPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxEQ1BUeXBlPgogICAgICAgICAgICAgIDxIVFRQPgogICAgICAgICAgICAgICAgPEdldD4KICAgICAgICAgICAgICAgICAgPE9ubGluZVJlc291cmNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazp0eXBlPSJzaW1wbGUiIHhsaW5rOmhyZWY9Imh0dHA6Ly9tYXBzLmNzci51Zm1nLmJyOjgwL2dlb3NlcnZlci93bXM/U0VSVklDRT1XTVMmYW1wOyIvPgogICAgICAgICAgICAgICAgPC9HZXQ+CiAgICAgICAgICAgICAgICA8UG9zdD4KICAgICAgICAgICAgICAgICAgPE9ubGluZVJlc291cmNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazp0eXBlPSJzaW1wbGUiIHhsaW5rOmhyZWY9Imh0dHA6Ly9tYXBzLmNzci51Zm1nLmJyOjgwL2dlb3NlcnZlci93bXM/U0VSVklDRT1XTVMmYW1wOyIvPgogICAgICAgICAgICAgICAgPC9Qb3N0PgogICAgICAgICAgICAgIDwvSFRUUD4KICAgICAgICAgICAgPC9EQ1BUeXBlPgogICAgICAgICAgPC9HZXRDYXBhYmlsaXRpZXM+CiAgICAgICAgICA8R2V0TWFwPgogICAgICAgICAgICA8Rm9ybWF0PmltYWdlL3BuZzwvRm9ybWF0PgogICAgICAgICAgICA8RENQVHlwZT4KICAgICAgICAgICAgICA8SFRUUD4KICAgICAgICAgICAgICAgIDxHZXQ+CiAgICAgICAgICAgICAgICAgIDxPbmxpbmVSZXNvdXJjZSB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeGxpbms6dHlwZT0ic2ltcGxlIiB4bGluazpocmVmPSJodHRwOi8vbWFwcy5jc3IudWZtZy5icjo4MC9nZW9zZXJ2ZXIvd21zP1NFUlZJQ0U9V01TJmFtcDsiLz4KICAgICAgICAgICAgICAgIDwvR2V0PgogICAgICAgICAgICAgIDwvSFRUUD4KICAgICAgICAgICAgPC9EQ1BUeXBlPgogICAgICAgICAgPC9HZXRNYXA+CiAgICAgICAgICA8R2V0RmVhdHVyZUluZm8+CiAgICAgICAgICAgIDxGb3JtYXQ+dGV4dC9wbGFpbjwvRm9ybWF0PgogICAgICAgICAgICA8Rm9ybWF0PmFwcGxpY2F0aW9uL3ZuZC5vZ2MuZ21sPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxGb3JtYXQ+YXBwbGljYXRpb24vdm5kLm9nYy5nbWwvMy4xLjE8L0Zvcm1hdD4KICAgICAgICAgICAgPEZvcm1hdD50ZXh0L2h0bWw8L0Zvcm1hdD4KICAgICAgICAgICAgPEZvcm1hdD5hcHBsaWNhdGlvbi9qc29uPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxEQ1BUeXBlPgogICAgICAgICAgICAgIDxIVFRQPgogICAgICAgICAgICAgICAgPEdldD4KICAgICAgICAgICAgICAgICAgPE9ubGluZVJlc291cmNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazp0eXBlPSJzaW1wbGUiIHhsaW5rOmhyZWY9Imh0dHA6Ly9tYXBzLmNzci51Zm1nLmJyOjgwL2dlb3NlcnZlci93bXM/U0VSVklDRT1XTVMmYW1wOyIvPgogICAgICAgICAgICAgICAgPC9HZXQ+CiAgICAgICAgICAgICAgICA8UG9zdD4KICAgICAgICAgICAgICAgICAgPE9ubGluZVJlc291cmNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazp0eXBlPSJzaW1wbGUiIHhsaW5rOmhyZWY9Imh0dHA6Ly9tYXBzLmNzci51Zm1nLmJyOjgwL2dlb3NlcnZlci93bXM/U0VSVklDRT1XTVMmYW1wOyIvPgogICAgICAgICAgICAgICAgPC9Qb3N0PgogICAgICAgICAgICAgIDwvSFRUUD4KICAgICAgICAgICAgPC9EQ1BUeXBlPgogICAgICAgICAgPC9HZXRGZWF0dXJlSW5mbz4KICAgICAgICAgIDxEZXNjcmliZUxheWVyPgogICAgICAgICAgICA8Rm9ybWF0PmFwcGxpY2F0aW9uL3ZuZC5vZ2Mud21zX3htbDwvRm9ybWF0PgogICAgICAgICAgICA8RENQVHlwZT4KICAgICAgICAgICAgICA8SFRUUD4KICAgICAgICAgICAgICAgIDxHZXQ+CiAgICAgICAgICAgICAgICAgIDxPbmxpbmVSZXNvdXJjZSB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeGxpbms6dHlwZT0ic2ltcGxlIiB4bGluazpocmVmPSJodHRwOi8vbWFwcy5jc3IudWZtZy5icjo4MC9nZW9zZXJ2ZXIvd21zP1NFUlZJQ0U9V01TJmFtcDsiLz4KICAgICAgICAgICAgICAgIDwvR2V0PgogICAgICAgICAgICAgIDwvSFRUUD4KICAgICAgICAgICAgPC9EQ1BUeXBlPgogICAgICAgICAgPC9EZXNjcmliZUxheWVyPgogICAgICAgICAgPEdldExlZ2VuZEdyYXBoaWM+CiAgICAgICAgICAgIDxGb3JtYXQ+aW1hZ2UvcG5nPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxEQ1BUeXBlPgogICAgICAgICAgICAgIDxIVFRQPgogICAgICAgICAgICAgICAgPEdldD4KICAgICAgICAgICAgICAgICAgPE9ubGluZVJlc291cmNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazp0eXBlPSJzaW1wbGUiIHhsaW5rOmhyZWY9Imh0dHA6Ly9tYXBzLmNzci51Zm1nLmJyOjgwL2dlb3NlcnZlci93bXM/U0VSVklDRT1XTVMmYW1wOyIvPgogICAgICAgICAgICAgICAgPC9HZXQ+CiAgICAgICAgICAgICAgPC9IVFRQPgogICAgICAgICAgICA8L0RDUFR5cGU+CiAgICAgICAgICA8L0dldExlZ2VuZEdyYXBoaWM+CiAgICAgICAgICA8R2V0U3R5bGVzPgogICAgICAgICAgICA8Rm9ybWF0PmFwcGxpY2F0aW9uL3ZuZC5vZ2Muc2xkK3htbDwvRm9ybWF0PgogICAgICAgICAgICA8RENQVHlwZT4KICAgICAgICAgICAgICA8SFRUUD4KICAgICAgICAgICAgICAgIDxHZXQ+CiAgICAgICAgICAgICAgICAgIDxPbmxpbmVSZXNvdXJjZSB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeGxpbms6dHlwZT0ic2ltcGxlIiB4bGluazpocmVmPSJodHRwOi8vbWFwcy5jc3IudWZtZy5icjo4MC9nZW9zZXJ2ZXIvd21zP1NFUlZJQ0U9V01TJmFtcDsiLz4KICAgICAgICAgICAgICAgIDwvR2V0PgogICAgICAgICAgICAgIDwvSFRUUD4KICAgICAgICAgICAgPC9EQ1BUeXBlPgogICAgICAgICAgPC9HZXRTdHlsZXM+CiAgICAgICAgPC9SZXF1ZXN0PgogICAgICAgIDxFeGNlcHRpb24+CiAgICAgICAgICA8Rm9ybWF0PmFwcGxpY2F0aW9uL3ZuZC5vZ2Muc2VfeG1sPC9Gb3JtYXQ+CiAgICAgICAgICA8Rm9ybWF0PmFwcGxpY2F0aW9uL3ZuZC5vZ2Muc2VfaW5pbWFnZTwvRm9ybWF0PgogICAgICAgIDwvRXhjZXB0aW9uPgogICAgICAgIDxWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcz4KICAgICAgICAgIDxub3RlbXB0eT48L25vdGVtcHR5PgogICAgICAgIDwvVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXM+CiAgICAgICAgPFVzZXJEZWZpbmVkU3ltYm9saXphdGlvbiBTdXBwb3J0U0xEPSIxIiBVc2VyTGF5ZXI9IjEiIFVzZXJTdHlsZT0iMSIgUmVtb3RlV0ZTPSIxIi8+CiAgICAgICAgPExheWVyIHF1ZXJ5YWJsZT0iMCIgb3BhcXVlPSIwIiBub1N1YnNldHM9IjAiPgogICAgICAgICAgPFRpdGxlPk1hcFNlcnZlciB2aWEgR0l0SHViPC9UaXRsZT4KICAgICAgICAgIDxBYnN0cmFjdD5HaXRIdWIgV01TPC9BYnN0cmFjdD4KICAgICAgICAgIDwhLS1BbGwgc3VwcG9ydGVkIEVQU0cgcHJvamVjdGlvbnM6LS0+CiAgICAgICAgICA8U1JTPkVQU0c6Mzg1NzwvU1JTPgogICAgICAgICAgPFNSUz5FUFNHOjQzMjY8L1NSUz4KICAgICAgICAgIDxTUlM+RVBTRzo5MDA5MTM8L1NSUz4KICAgICAgICAgIDxTUlM+RVBTRzo0MjMwMzwvU1JTPgogICAgICAgICAgPExhdExvbkJvdW5kaW5nQm94IG1pbng9Ii0xODAuMDAwMDQwNzQxOTk5OTgiIG1pbnk9Ii05MC4wIiBtYXh4PSIxODAuMDAwMDAwMDAwMDAwMSIgbWF4eT0iOTAuMCIvPgogICAgICAgIDwvTGF5ZXI+CiAgICAgIDwvQ2FwYWJpbGl0eT4KICAgIDwvV01UX01TX0NhcGFiaWxpdGllcz4nJycKCiAgICAjIEBzdGF0aWNtZXRob2QKICAgICMgZGVmIGNvbnZlcnRDb29yZGluYXRlUHJvaihjcnNQcm9qLCBmcm9tWCwgZnJvbVksIG91dHB1dFByb2plY3RlZCk6CiAgICAjCiAgICAjICAgICByZWdleCA9IHIiXlsgXSpQUk9KQ1MiCiAgICAjICAgICBpc1Byb2plY3RlZCA9IHJlLm1hdGNoKHJlZ2V4LCBjcnNQcm9qKQogICAgIwogICAgIyAgICAgaWYgKGlzUHJvamVjdGVkIGFuZCBvdXRwdXRQcm9qZWN0ZWQpIG9yICggbm90IGlzUHJvamVjdGVkIGFuZCAgbm90IG91dHB1dFByb2plY3RlZCk6CiAgICAjICAgICAgICAgcmV0dXJuIChmcm9tWCwgZnJvbVkpCiAgICAjICAgICBlbHNlOgogICAgIyAgICAgICAgIGZQcm9qID0gUWdzQ29vcmRpbmF0ZVJlZmVyZW5jZVN5c3RlbSgpCiAgICAjICAgICAgICAgZlByb2ouY3JlYXRlRnJvbVdrdChjcnNQcm9qKQogICAgIyAgICAgICAgIHRQcm9qID0gUWdzQ29vcmRpbmF0ZVJlZmVyZW5jZVN5c3RlbSgpCiAgICAjICAgICAgICAgdFByb2ouY3JlYXRlRnJvbVByb2o0KCIrcHJvaj1tZXJjICthPTYzNzgxMzcgK2I9NjM3ODEzNyArbGF0X3RzPTAuMCArbG9uXzA9MC4wICt4XzA9MC4wICt5XzA9MCAraz0xLjAgK3VuaXRzPW0gK25hZGdyaWRzPUBudWxsICt3a3RleHQgICtub19kZWZzIiBpZiBvdXRwdXRQcm9qZWN0ZWQgZWxzZSAiK3Byb2o9bG9uZ2xhdCArZGF0dW09V0dTODQgK25vX2RlZnMgIikKICAgICMgICAgICAgICBuZXdDb29yZCA9IFFnc0Nvb3JkaW5hdGVUcmFuc2Zvcm0oZlByb2osIHRQcm9qLCBRZ3NQcm9qZWN0Lmluc3RhbmNlKCkpLnRyYW5zZm9ybShRZ3NQb2ludFhZKGZyb21YLCBmcm9tWSksIFRydWUpCiAgICAjICAgICByZXR1cm4gKG5ld0Nvb3JkLngsIG5ld0Nvb3JkLnkpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldE1hcEtleXdvcmQoaXNTaGFwZWZpbGUsIG1heFpvb20sIGRsTGluaz1Ob25lKToKICAgICAgICBpZiBkbExpbmsgaXMgTm9uZSBvciBsZW4oZGxMaW5rKSA9PSAwOgogICAgICAgICAgICBkbExpbmsgPSAnZGlzYWJsZWRvd25sb2FkJwogICAgICAgIGVsaWYgJzonIGluIGRsTGluazoKICAgICAgICAgICAgZGxMaW5rID0gZGxMaW5rWyhkbExpbmsuaW5kZXgoJzonKSArIDEpOl0KICAgICAgICBlbGlmICfLuCcgaW4gZGxMaW5rOgogICAgICAgICAgICBkbExpbmsgPSBkbExpbmtbKGRsTGluay5pbmRleCgny7gnKSArIDEpOl0KICAgICAgICByZXR1cm4gImdyb3Vwy7giICsgKCdzaHAnIGlmIGlzU2hhcGVmaWxlIGVsc2UgJ3RpZicpICsgIsu4y7jLuCIgKyBkbExpbmsgKyAiy7hub3RMaXN0aW5ny7jLuG1heFpvb23LuCIgKyBzdHIobWF4Wm9vbSkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0TWFwRGVzY3JpcHRpb24obGF5ZXJOYW1lSUQsIGxheWVyQXR0ciwgbGF0TWluWCwgbGF0TWluWSwgbGF0TWF4WCwgbGF0TWF4WSwgcHJvak1pblgsIHByb2pNaW5ZLCBwcm9qTWF4WCwgcHJvak1heFksIG1heFpvb20sIGlzU2hhcGVmaWxlLCBkTGluayk6CiAgICAgICAgbGF5ZXJBdHRyID0gVVRJTFMubm9ybWFsaXplTmFtZShsYXllckF0dHIpCiAgICAgICAgbGF5ZXJOYW1lSUQgPSBVVElMUy5ub3JtYWxpemVOYW1lKGxheWVyTmFtZUlEKQogICAgICAgICMgSW52ZXJ0aSBvIG1pbngvbWlueSBlIG1heFgvbWF4WSBkbyBlcHNnIDQzMjYgcHEgZXN0YXZhIHRyb2NhbmRvIG5vIGdlb3NlcnZlciwgbWFzIG4gc2VpIHBxIGlzc28gYWNvbnRlY2UuCiAgICAgICAgcmV0dXJuICIiIjxDT05URU5UPgogICAgICAgICAgPExheWVyIHF1ZXJ5YWJsZT0iMSIgb3BhcXVlPSIwIj4KICAgICAgICAgIDxOYW1lPkdIOiIiIiArIGxheWVyTmFtZUlEICsgIiIiPC9OYW1lPgogICAgICAgICAgPFRpdGxlPiIiIiArIGxheWVyTmFtZUlEICsgIiIiPC9UaXRsZT4KICAgICAgICAgIDxBYnN0cmFjdD5HSDoiIiIgKyBsYXllck5hbWVJRCArICIiIiBBQlNUUkFDVDwvQWJzdHJhY3Q+CiAgICAgICAgICA8S2V5d29yZExpc3Q+CiAgICAgICAgICAgIDxLZXl3b3JkPiIiIiArIFdNU0NhcGFiaWxpdGllcy5nZXRNYXBLZXl3b3JkKGlzU2hhcGVmaWxlLCBtYXhab29tLCBkTGluaykgKyAiIiI8L0tleXdvcmQ+CiAgICAgICAgICA8L0tleXdvcmRMaXN0PgogICAgICAgICAgPFNSUz5FUFNHOjQzMjY8L1NSUz4KICAgICAgICAgIDxMYXRMb25Cb3VuZGluZ0JveCBtaW54PVwiIiIiICsgc3RyKGxhdE1pblgpICsgIiIiXCIgbWlueT1cIiIiIiArIHN0cihsYXRNaW5ZKSArICIiIlwiIG1heHg9XCIiIiIgKyBzdHIoCiAgICAgICAgICAgIGxhdE1heFgpICsgIiIiXCIgbWF4eT1cIiIiIiArIHN0cihsYXRNYXhZKSArICIiIlwiLz4KICAgICAgICAgIDxCb3VuZGluZ0JveCBTUlM9IkVQU0c6NDMyNiIgbWlueD1cIiIiIiArIHN0cihwcm9qTWluWCkgKyAiIiJcIiBtaW55PVwiIiIiICsgc3RyKAogICAgICAgICAgICBwcm9qTWluWSkgKyAiIiJcIiBtYXh4PVwiIiIiICsgc3RyKHByb2pNYXhYKSArICIiIlwiIG1heHk9XCIiIiIgKyBzdHIocHJvak1heFkpICsgIiIiXCIvPgogICAgICAgICAgPFN0eWxlPgogICAgICAgICAgIDxOYW1lPiIiIiArIGxheWVyQXR0ciArICIiIjwvTmFtZT4KICAgICAgICAgICA8VGl0bGU+IiIiICsgbGF5ZXJBdHRyICsgIiIiPC9UaXRsZT4KICAgICAgICAgICA8QWJzdHJhY3QvPgogICAgICAgICAgIDxMZWdlbmRVUkwgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIj4KICAgICAgICAgICA8Rm9ybWF0PmltYWdlL3BuZzwvRm9ybWF0PgogICAgICAgICAgIDxPbmxpbmVSZXNvdXJjZSB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeGxpbms6dHlwZT0ic2ltcGxlIiB4bGluazpocmVmPSJodHRwczovL21hcHMuY3NyLnVmbWcuYnI6NDQzL2dlb3NlcnZlci93bXM/cmVxdWVzdD1HZXRMZWdlbmRHcmFwaGljJmFtcDtmb3JtYXQ9aW1hZ2UlMkZwbmcmYW1wO3dpZHRoPTIwJmFtcDtoZWlnaHQ9MjAmYW1wO2xheWVyPSIiIiArIGxheWVyTmFtZUlEICsgIiIiXCIvPgogICAgICAgICAgIDwvTGVnZW5kVVJMPgogICAgICAgICAgPC9TdHlsZT4KICAgICAgICA8L0xheWVyPgogICAgICAgIDwvQ09OVEVOVD4KICAgICAgICAiIiIKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0VGlsZVNldERlc2NyaXB0aW9uKGZpbGVOYW1lSWQsIGxhdE1pblgsIGxhdE1pblksIGxhdE1heFgsIGxhdE1heFksIHByb2pNaW5YLCBwcm9qTWluWSwgcHJvak1heFgsIHByb2pNYXhZKToKICAgICAgICAjIDxCb3VuZGluZ0JveCBTUlM9IkVQU0c6NDMyNiIgbWlueD1cIiIiIiArIHN0cihsYXRNaW5YKSArICIiIlwiIG1pbnk9XCIiIiIgKyBzdHIobGF0TWluWSkgKyAiIiJcIiBtYXh4PVwiIiIiICsgc3RyKGxhdE1heFgpICsgIiIiXCIgbWF4eT1cIiIiIiArIHN0cihsYXRNYXhZKSArICIiIlwiLz4KICAgICAgICByZXR1cm4gIiIiPD94bWwgdmVyc2lvbj1cIjEuMFwiIGVuY29kaW5nPVwiVVRGLThcIj8+CiAgICAgICAgPENPTlRFTlQ+CiAgICAgICAgICA8VGlsZVNldD4KICAgICAgICAgICAgPFNSUz5FUFNHOjQzMjY8L1NSUz4KICAgICAgICAgICAgPEJvdW5kaW5nQm94IFNSUz0iRVBTRzo0MzI2IiBtaW54PSItMTgwLjAiIG1pbnk9Ii05MC4wIiBtYXh4PSIwLjAiIG1heHk9IjkwLjAiLz4KICAgICAgICA8UmVzb2x1dGlvbnM+MC43MDMxMjUgMC4zNTE1NjI1IDAuMTc1NzgxMjUgMC4wODc4OTA2MjUgMC4wNDM5NDUzMTI1IDAuMDIxOTcyNjU2MjUgMC4wMTA5ODYzMjgxMjUgMC4wMDU0OTMxNjQwNjI1IDAuMDAyNzQ2NTgyMDMxMjUgMC4wMDEzNzMyOTEwMTU2MjUgNi44NjY0NTUwNzgxMjVFLTQgMy40MzMyMjc1MzkwNjI1RS00IDEuNzE2NjEzNzY5NTMxMjVFLTQgOC41ODMwNjg4NDc2NTYyNUUtNSA0LjI5MTUzNDQyMzgyODEyNUUtNSAyLjE0NTc2NzIxMTkxNDA2MjVFLTUgMS4wNzI4ODM2MDU5NTcwMzEyRS01IDUuMzY0NDE4MDI5Nzg1MTU2RS02IDIuNjgyMjA5MDE0ODkyNTc4RS02IDEuMzQxMTA0NTA3NDQ2Mjg5RS02IDYuNzA1NTIyNTM3MjMxNDQ1RS03IDMuMzUyNzYxMjY4NjE1NzIyN0UtNyA8L1Jlc29sdXRpb25zPgogICAgICAgICAgICA8V2lkdGg+MjU2PC9XaWR0aD4KICAgICAgICAgICAgPEhlaWdodD4yNTY8L0hlaWdodD4KICAgICAgICAgICAgPEZvcm1hdD5pbWFnZS9wbmc8L0Zvcm1hdD4KICAgICAgICAgICAgPExheWVycz5HSDoiIiIgKyBmaWxlTmFtZUlkICsgIiIiPC9MYXllcnM+CiAgICAgICAgICAgIDxTdHlsZXMvPgogICAgICAgICAgPC9UaWxlU2V0PgogICAgICAgICAgPFRpbGVTZXQ+CiAgICAgICAgICAgIDxTUlM+RVBTRzo5MDA5MTM8L1NSUz4KICAgICAgICAgICAgPEJvdW5kaW5nQm94IFNSUz0iRVBTRzo5MDA5MTMiIG1pbng9Ii0yLjAwMzc1MDgzNEU3IiBtaW55PSItMi4wMDM3NTA4MzRFNyIgbWF4eD0iMi4wMDM3NTA4MzRFNyIgbWF4eT0iMi4wMDM3NTA4MzRFNyIvPgogICAgICAgIDxSZXNvbHV0aW9ucz4xNTY1NDMuMDMzOTA2MjUgNzgyNzEuNTE2OTUzMTI1IDM5MTM1Ljc1ODQ3NjU2MjUgMTk1NjcuODc5MjM4MjgxMjUgOTc4My45Mzk2MTkxNDA2MjUgNDg5MS45Njk4MDk1NzAzMTI1IDI0NDUuOTg0OTA0Nzg1MTU2MiAxMjIyLjk5MjQ1MjM5MjU3ODEgNjExLjQ5NjIyNjE5NjI4OTEgMzA1Ljc0ODExMzA5ODE0NDUzIDE1Mi44NzQwNTY1NDkwNzIyNiA3Ni40MzcwMjgyNzQ1MzYxMyAzOC4yMTg1MTQxMzcyNjgwNjYgMTkuMTA5MjU3MDY4NjM0MDMzIDkuNTU0NjI4NTM0MzE3MDE3IDQuNzc3MzE0MjY3MTU4NTA4IDIuMzg4NjU3MTMzNTc5MjU0IDEuMTk0MzI4NTY2Nzg5NjI3IDAuNTk3MTY0MjgzMzk0ODEzNSAwLjI5ODU4MjE0MTY5NzQwNjc3IDAuMTQ5MjkxMDcwODQ4NzAzMzggMC4wNzQ2NDU1MzU0MjQzNTE2OSAwLjAzNzMyMjc2NzcxMjE3NTg0NiAwLjAxODY2MTM4Mzg1NjA4NzkyMyAwLjAwOTMzMDY5MTkyODA0Mzk2MSAwLjAwNDY2NTM0NTk2NDAyMTk4MSAwLjAwMjMzMjY3Mjk4MjAxMDk5MDQgMC4wMDExNjYzMzY0OTEwMDU0OTUyIDUuODMxNjgyNDU1MDI3NDc2RS00IDIuOTE1ODQxMjI3NTEzNzM4RS00IDEuNDU3OTIwNjEzNzU2ODY5RS00IDwvUmVzb2x1dGlvbnM+CiAgICAgICAgICAgIDxXaWR0aD4yNTY8L1dpZHRoPgogICAgICAgICAgICA8SGVpZ2h0PjI1NjwvSGVpZ2h0PgogICAgICAgICAgICA8Rm9ybWF0PmltYWdlL3BuZzwvRm9ybWF0PgogICAgICAgICAgICA8TGF5ZXJzPkdIOiIiIiArIGZpbGVOYW1lSWQgKyAiIiI8L0xheWVycz4KICAgICAgICAgICAgPFN0eWxlcy8+CiAgICAgICAgICA8L1RpbGVTZXQ+CiAgICAgICAgICA8L0NPTlRFTlQ+CiAgICAgICAgIiIiCiAgICAgICAgIyA8Qm91bmRpbmdCb3ggU1JTPSJFUFNHOjkwMDkxMyIgbWlueD1cIiIiIiArIHN0cihwcm9qTWluWCkgKyAiIiJcIiBtaW55PVwiIiIiICsgc3RyKHByb2pNaW5ZKSArICIiIlwiIG1heHg9XCIiIiIgKyBzdHIocHJvak1heFgpICsgIiIiXCIgbWF4eT1cIiIiIiArIHN0cihwcm9qTWF4WSkgKyAiIiJcIi8+CgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldEFsbExheWVycyhjb250ZW50LCBsYXllckF0dHI9JzEnKToKICAgICAgICAjRklYTUUgc2hvdWxkIHVzZSB0aGUgc3R5bGUgbmFtZSB0byBpZGVudGlmeSB0aGUgbGF5ZXIgYXR0cmlidXRlcwogICAgICAgIGRvYyA9IHhtbHRvZGljdC5wYXJzZShjb250ZW50KQogICAgICAgIGFsbExheWVycyA9IFtdCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsYXllckRlZmluaXRpb25zID0gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXQogICAgICAgICAgICBpZiBsYXllckRlZmluaXRpb25zIGlzIG5vdCBOb25lIGFuZCBpc2luc3RhbmNlKGxheWVyRGVmaW5pdGlvbnMsIGxpc3QpIGFuZCBsZW4obGF5ZXJEZWZpbml0aW9ucyk6CiAgICAgICAgICAgICAgICBhbGxMYXllcnMgPSBbY3VyTGF5ZXJbIk5hbWUiXSBmb3IgY3VyTGF5ZXIgaW4gbGF5ZXJEZWZpbml0aW9uc10KICAgICAgICAgICAgZWxpZiBsYXllckRlZmluaXRpb25zIGlzIG5vdCBOb25lIGFuZCBpc2luc3RhbmNlKGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10sIGNvbGxlY3Rpb25zLk9yZGVyZWREaWN0KSBhbmQgbGVuKGxheWVyRGVmaW5pdGlvbnMpOgogICAgICAgICAgICAgICAgYWxsTGF5ZXJzID0gW2xheWVyRGVmaW5pdGlvbnNbIk5hbWUiXV0KICAgICAgICBleGNlcHQgS2V5RXJyb3IgYXMgZToKICAgICAgICAgICAgcGFzcwogICAgICAgIHJldHVybiBhbGxMYXllcnMKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0T3BlcmF0aW9uc0xpc3RGb3JDdXN0b21MYXllcihkb2NMYXllcik6CiAgICAgICAgI0ZJWE1FIE7Do28gZGV2ZXJpYSBtb2RpZmljYXIgbyBpbnB1dCBudW1hIGZ1bmNhbyBkZSBnZXQKICAgICAgICAjRklYTUUgY29kaWdvIGR1cGxpY2FkbwogICAgICAgIGlmIG5vdCAiT3BlcmF0aW9uIiBpbiBkb2NMYXllcjoKICAgICAgICAgICAgZG9jTGF5ZXJbIk9wZXJhdGlvbiJdID0gW10KICAgICAgICBlbGlmIGlzaW5zdGFuY2UoZG9jTGF5ZXJbIk9wZXJhdGlvbiJdLCBjb2xsZWN0aW9ucy5PcmRlcmVkRGljdCk6CiAgICAgICAgICAgIGRvY0xheWVyWyJPcGVyYXRpb24iXSA9IFtkb2NMYXllclsiT3BlcmF0aW9uIl1dCgogICAgICAgIGlmIGxlbihkb2NMYXllclsiT3BlcmF0aW9uIl0pID09IDA6CiAgICAgICAgICAgIHJldHVybiBbXQogICAgICAgIGVsaWYgaXNpbnN0YW5jZShkb2NMYXllclsiT3BlcmF0aW9uIl0sIHN0cik6CiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbihqc29uLmR1bXBzKGRvY0xheWVyKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gW3sndHlwZSc6IG9wZXJhdGlvblsiQHR5cGUiXSwgJ2F0dHJpYnV0ZSc6IG9wZXJhdGlvblsiI3RleHQiXX0gZm9yIG9wZXJhdGlvbiBpbiBkb2NMYXllclsnT3BlcmF0aW9uJ11dCgoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRBbGxDdXN0b21MYXllcnMoY29udGVudCwgbGF5ZXJBdHRyPScxJyk6CiAgICAgICAgZG9jID0geG1sdG9kaWN0LnBhcnNlKGNvbnRlbnQpCiAgICAgICAgYWxsQ3VzdG9tTGF5ZXJzID0gW10KICAgICAgICBpZiAnQ3VzdG9tTGF5ZXInICBpbiBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddOgogICAgICAgICAgICBsYXllckRlZmluaXRpb25zID0gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsnQ3VzdG9tTGF5ZXInXQoKICAgICAgICAgICAgaWYgbGF5ZXJEZWZpbml0aW9ucyBpcyBub3QgTm9uZSBhbmQgaXNpbnN0YW5jZShsYXllckRlZmluaXRpb25zLCBjb2xsZWN0aW9ucy5PcmRlcmVkRGljdCk6CiAgICAgICAgICAgICAgICBsYXllckRlZmluaXRpb25zID0gW2xheWVyRGVmaW5pdGlvbnNdCiAgICAgICAgICAgIGlmIGxheWVyRGVmaW5pdGlvbnMgaXMgbm90IE5vbmUgYW5kIGlzaW5zdGFuY2UobGF5ZXJEZWZpbml0aW9ucywgbGlzdCkgYW5kIGxlbihsYXllckRlZmluaXRpb25zKSA+IDA6CiAgICAgICAgICAgICAgICBmb3IgY3VyTGF5ZXIgaW4gbGF5ZXJEZWZpbml0aW9uczoKICAgICAgICAgICAgICAgICAgICBmb3Igb3BlcmF0aW9uIGluIFdNU0NhcGFiaWxpdGllcy5nZXRPcGVyYXRpb25zTGlzdEZvckN1c3RvbUxheWVyKGN1ckxheWVyKToKICAgICAgICAgICAgICAgICAgICAgICAgYWxsQ3VzdG9tTGF5ZXJzLmFwcGVuZChjdXJMYXllclsiTmFtZSJdICsgIjsiICsgb3BlcmF0aW9uWydhdHRyaWJ1dGUnXSkKICAgICAgICAgICAgICAgICAgICAgICAgI2FsbEN1c3RvbUxheWVycy5hcHBlbmQoY3VyTGF5ZXJbIk5hbWUiXSArICI6IiArIG9wZXJhdGlvblsnYXR0cmlidXRlJ10gKyAiOiIgKyBvcGVyYXRpb25bJ3R5cGUnXSkKICAgICAgICByZXR1cm4gYWxsQ3VzdG9tTGF5ZXJzCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldEN1cnJlbnRDYXBhYmlsaXRpZXNEb2MoZGlyZWN0b3J5KToKICAgICAgICBjYXBhYmlsaXRpZXNQYXRoID0gb3MucGF0aC5qb2luKGRpcmVjdG9yeSwgImdldENhcGFiaWxpdGllcy54bWwiKQogICAgICAgIGlmIG9zLnBhdGguaXNmaWxlKGNhcGFiaWxpdGllc1BhdGgpOgogICAgICAgICAgICB3aXRoIGlvLm9wZW4oY2FwYWJpbGl0aWVzUGF0aCwgbW9kZT0iciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGNhcGFiaWxpdGllc0ZpbGU6CiAgICAgICAgICAgICAgICBjYXBhYmlsaXRpZXNDb250ZW50ID0gY2FwYWJpbGl0aWVzRmlsZS5yZWFkKCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBjYXBhYmlsaXRpZXNDb250ZW50ID0gV01TQ2FwYWJpbGl0aWVzLmdldERlZmF1bHRDYXBhYmlsaXRpZXMoKQogICAgICAgIGRvYyA9IHhtbHRvZGljdC5wYXJzZShjYXBhYmlsaXRpZXNDb250ZW50KQogICAgICAgIHJldHVybiBkb2MKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgc2F2ZUN1cnJlbnRDYXBhYmlsaXRpZXMoZGlyZWN0b3J5LCBkb2MpOgogICAgICAgIGNhcGFiaWxpdGllc1BhdGggPSBvcy5wYXRoLmpvaW4oZGlyZWN0b3J5LCAiZ2V0Q2FwYWJpbGl0aWVzLnhtbCIpCiAgICAgICAgd2l0aCBpby5vcGVuKGNhcGFiaWxpdGllc1BhdGgsIG1vZGU9InciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBjYXBhYmlsaXRpZXNGaWxlOgogICAgICAgICAgICBjYXBhYmlsaXRpZXNGaWxlLndyaXRlKHhtbHRvZGljdC51bnBhcnNlKGRvYywgcHJldHR5PVRydWUpKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRDdXN0b21MYXllckRlZmF1bHREZWZpbml0aW9uKGxheWVyTmFtZSk6CiAgICAgICAgbGF5ZXJOYW1lID0gVVRJTFMubm9ybWFsaXplTmFtZShsYXllck5hbWUpCiAgICAgICAgcmV0dXJuIHhtbHRvZGljdC5wYXJzZSgiIiI8P3htbCB2ZXJzaW9uPVwiMS4wXCIgZW5jb2Rpbmc9XCJVVEYtOFwiPz4KICAgICAgICAgICAgPENPTlRFTlQ+CiAgICAgICAgICAgICAgICA8TmFtZT5HSDoiIiIgKyBsYXllck5hbWUgKyAiIiI8L05hbWU+CiAgICAgICAgICAgICAgICA8VGl0bGU+IiIiK2xheWVyTmFtZSArIiIiPC9UaXRsZT4KICAgICAgICAgICAgPC9DT05URU5UPiIiIilbIkNPTlRFTlQiXQoKICAgICNjdXN0b21Eb2Mgw6kgdW0gRGljdCB2aW5kbyBkbyB4bWx0b2RpY3QuIGxheWVyQXR0ciBlIG9wZXJhdGlvbiBzw6NvIHN0cmluZ3MKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBhZGRPcGVyYXRpb24oY3VzdG9tRG9jLCBsYXllckF0dHIsIG9wZXJhdGlvbik6CiAgICAgICAgbGF5ZXJBdHRyID0gVVRJTFMubm9ybWFsaXplTmFtZShsYXllckF0dHIpCiAgICAgICAgaWYgbm90ICJPcGVyYXRpb24iIGluIGN1c3RvbURvYzoKICAgICAgICAgICAgY3VzdG9tRG9jWyJPcGVyYXRpb24iXSA9IGxpc3QoKQogICAgICAgIGlmIGlzaW5zdGFuY2UoY3VzdG9tRG9jWyJPcGVyYXRpb24iXSwgY29sbGVjdGlvbnMuT3JkZXJlZERpY3QpOgogICAgICAgICAgICBjdXN0b21Eb2NbIk9wZXJhdGlvbiJdID0gW2N1c3RvbURvY1siT3BlcmF0aW9uIl1dCgogICAgICAgIGZvdW5kID0gRmFsc2UKICAgICAgICBmb3IgY3VyT3BlcmF0aW9uRGljdCBpbiBjdXN0b21Eb2NbIk9wZXJhdGlvbiJdOgogICAgICAgICAgICBpZiBub3QgZm91bmQgYW5kICdAdHlwZScgaW4gY3VyT3BlcmF0aW9uRGljdCBhbmQgY3VyT3BlcmF0aW9uRGljdFsnQHR5cGUnXSA9PSBvcGVyYXRpb24gYW5kIGN1ck9wZXJhdGlvbkRpY3RbJyN0ZXh0J10gPT0gbGF5ZXJBdHRyOgogICAgICAgICAgICAgICAgZm91bmQgPSBUcnVlCiAgICAgICAgaWYgbm90IGZvdW5kOgogICAgICAgICAgICBjdXN0b21Eb2NbJ09wZXJhdGlvbiddLmFwcGVuZCh4bWx0b2RpY3QucGFyc2UoIiIiPD94bWwgdmVyc2lvbj1cIjEuMFwiIGVuY29kaW5nPVwiVVRGLThcIj8+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8Q09OVEVOVD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxPcGVyYXRpb24gdHlwZT1cIiIiIiArIG9wZXJhdGlvbiArICIiIlwiPiIiIiArIGxheWVyQXR0ciArICIiIjwvT3BlcmF0aW9uPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9DT05URU5UPiIiIilbIkNPTlRFTlQiXVsiT3BlcmF0aW9uIl0pCiAgICAgICAgcmV0dXJuIGN1c3RvbURvYwoKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgdXBkYXRlQ3VzdG9tWE1MKGRpcmVjdG9yeSwgbGF5ZXJUaXRsZSwgbGF5ZXJBdHRyLCBvcGVyYXRpb24pOgogICAgICAgIGRvYyA9IFdNU0NhcGFiaWxpdGllcy5nZXRDdXJyZW50Q2FwYWJpbGl0aWVzRG9jKGRpcmVjdG9yeSkKICAgICAgICBmaWxlbmFtZSA9IFVUSUxTLm5vcm1hbGl6ZU5hbWUobGF5ZXJUaXRsZSkgICMgbGF5ZXIgTmFtZSBubyBxZ2lzCgogICAgICAgIGlmICdDdXN0b21MYXllcicgaW4gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXToKICAgICAgICAgICAgaWYgdHlwZShkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWyJDdXN0b21MYXllciJdKSBpcyBjb2xsZWN0aW9ucy5PcmRlcmVkRGljdDoKICAgICAgICAgICAgICAgIGN1ckxheWVyID0gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsiQ3VzdG9tTGF5ZXIiXQogICAgICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsiQ3VzdG9tTGF5ZXIiXSA9IFtjdXJMYXllcl0KICAgICAgICBlbHNlOgogICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWydDdXN0b21MYXllciddID0gW10KCiAgICAgICAgY3VyTGF5ZXJEZWZpbml0aW9uID0gTm9uZQogICAgICAgIGlmICdDdXN0b21MYXllcicgaW4gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXToKICAgICAgICAgICAgZm9yIGlMYXllciBpbiByYW5nZShsZW4oZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsiQ3VzdG9tTGF5ZXIiXSkgLSAxLCAtMSwgLTEpOgogICAgICAgICAgICAgICAgY3VyTGF5ZXIgPSBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWyJDdXN0b21MYXllciJdW2lMYXllcl0KICAgICAgICAgICAgICAgIGlmICJOYW1lIiBpbiBjdXJMYXllciBhbmQgZmlsZW5hbWUgaW4gY3VyTGF5ZXJbIk5hbWUiXToKICAgICAgICAgICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWyJDdXN0b21MYXllciJdLnBvcChpTGF5ZXIpCiAgICAgICAgICAgICAgICAgICAgY3VyTGF5ZXJEZWZpbml0aW9uID0gY3VyTGF5ZXIKICAgICAgICAgICAgICAgICAgICAjVE9ETyB2ZXJpZmljYXIgc2UgbsOjbyByZXN0YXJhbSBvdXRyb3MgY29tIG1lc21vIG5vbWUuCiAgICAgICAgaWYgY3VyTGF5ZXJEZWZpbml0aW9uIGlzIE5vbmU6CiAgICAgICAgICAgIGN1ckxheWVyRGVmaW5pdGlvbiA9IFdNU0NhcGFiaWxpdGllcy5nZXRDdXN0b21MYXllckRlZmF1bHREZWZpbml0aW9uKGZpbGVuYW1lKQogICAgICAgIFdNU0NhcGFiaWxpdGllcy5hZGRPcGVyYXRpb24oY3VyTGF5ZXJEZWZpbml0aW9uLCBsYXllckF0dHIsIG9wZXJhdGlvbikKICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWyJDdXN0b21MYXllciJdLmFwcGVuZChjdXJMYXllckRlZmluaXRpb24pCiAgICAgICAgV01TQ2FwYWJpbGl0aWVzLnNhdmVDdXJyZW50Q2FwYWJpbGl0aWVzKGRpcmVjdG9yeSwgZG9jKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBzZXRDYXBhYmlsaXRpZXNEZWZhdWx0TWF4Wm9vbShkaXJlY3RvcnkpOgogICAgICAgIGRvYyA9IFdNU0NhcGFiaWxpdGllcy5nZXRDdXJyZW50Q2FwYWJpbGl0aWVzRG9jKGRpcmVjdG9yeSkKCiAgICAgICAgaWYgJ0xheWVyJyBpbiBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddOgogICAgICAgICAgICBpZiB0eXBlKGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10pIGlzIGNvbGxlY3Rpb25zLk9yZGVyZWREaWN0OgogICAgICAgICAgICAgICAgY3VyTGF5ZXIgPSBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddCiAgICAgICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddID0gW2N1ckxheWVyXQoKICAgICAgICBpZiAnTGF5ZXInIGluIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ106CiAgICAgICAgICAgIGZvciBpTGF5ZXIgaW4gcmFuZ2UobGVuKGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10pIC0gMSwgLTEsIC0xKToKICAgICAgICAgICAgICAgIGN1ckxheWVyID0gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXVtpTGF5ZXJdCiAgICAgICAgICAgICAgICBpZiAiS2V5d29yZExpc3QiIGluIGN1ckxheWVyIGFuZCB0eXBlKGN1ckxheWVyWydLZXl3b3JkTGlzdCddKSBpcyBjb2xsZWN0aW9ucy5PcmRlcmVkRGljdCBhbmQgKCJLZXl3b3JkIiBpbiBjdXJMYXllclsnS2V5d29yZExpc3QnXSkgYW5kIGN1ckxheWVyWydLZXl3b3JkTGlzdCddWydLZXl3b3JkJ10gPT0gJ0dJVEhVQic6CiAgICAgICAgICAgICAgICAgICAgY3VyTGF5ZXJbJ0tleXdvcmRMaXN0J11bJ0tleXdvcmQnXSA9IFdNU0NhcGFiaWxpdGllcy5nZXRNYXBLZXl3b3JkKEZhbHNlLCA4KQogICAgICAgIFdNU0NhcGFiaWxpdGllcy5zYXZlQ3VycmVudENhcGFiaWxpdGllcyhkaXJlY3RvcnksIGRvYykKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgdXBkYXRlWE1MKGRpcmVjdG9yeSwgbGF5ZXJFeHRlbnRzLCBsYXllck1lcmNhdG9yRXh0ZW50cywgaXNTaGFwZWZpbGUsIGxheWVyVGl0bGUsIGxheWVyQXR0ciwgbWF4Wm9vbSwgZG93bmxvYWRMaW5rKToKICAgICAgICBkb2MgPSBXTVNDYXBhYmlsaXRpZXMuZ2V0Q3VycmVudENhcGFiaWxpdGllc0RvYyhkaXJlY3RvcnkpCgogICAgICAgIGZpbGVuYW1lID0gVVRJTFMubm9ybWFsaXplTmFtZShsYXllclRpdGxlKSAjbGF5ZXIgTmFtZSBubyBxZ2lzCgogICAgICAgIGFzc2VydCBpc2luc3RhbmNlKGxheWVyRXh0ZW50cywgV01TQkJveCkgYW5kIGlzaW5zdGFuY2UobGF5ZXJNZXJjYXRvckV4dGVudHMsIFdNU0JCb3gpCgogICAgICAgICMgI2V4dGVudHMsIHByb2plY3Rpb24KICAgICAgICAjIHByb2pNYXhYID0gbGF5ZXIuZXh0ZW50KCkueE1heGltdW0oKQogICAgICAgIHByb2pNYXhYID0gbGF5ZXJFeHRlbnRzLnhNYXhpbXVtKCkKICAgICAgICAjIHByb2pNaW5YID0gbGF5ZXIuZXh0ZW50KCkueE1pbmltdW0oKQogICAgICAgIHByb2pNaW5YID0gbGF5ZXJFeHRlbnRzLnhNaW5pbXVtKCkKICAgICAgICAjIHByb2pNYXhZID0gbGF5ZXIuZXh0ZW50KCkueU1heGltdW0oKQogICAgICAgIHByb2pNYXhZID0gbGF5ZXJFeHRlbnRzLnlNYXhpbXVtKCkKICAgICAgICAjIHByb2pNaW5ZID0gbGF5ZXIuZXh0ZW50KCkueU1pbmltdW0oKQogICAgICAgIHByb2pNaW5ZID0gbGF5ZXJFeHRlbnRzLnlNaW5pbXVtKCkKICAgICAgICAjIGxsRXh0ZW50ID0gVVRJTFMuZ2V0TWFwRXh0ZW50KGxheWVyLCBRZ3NDb29yZGluYXRlUmVmZXJlbmNlU3lzdGVtKCdFUFNHOjQzMjYnKSkKICAgICAgICAjIGxhdE1heFggPSBsbEV4dGVudC54TWF4aW11bSgpCiAgICAgICAgbGF0TWF4WCA9IGxheWVyTWVyY2F0b3JFeHRlbnRzLnhNYXhpbXVtKCkKICAgICAgICAjIGxhdE1pblggPSBsbEV4dGVudC54TWluaW11bSgpCiAgICAgICAgbGF0TWluWCA9IGxheWVyTWVyY2F0b3JFeHRlbnRzLnhNaW5pbXVtKCkKICAgICAgICAjIGxhdE1heFkgPSBsbEV4dGVudC55TWF4aW11bSgpCiAgICAgICAgbGF0TWF4WSA9IGxheWVyTWVyY2F0b3JFeHRlbnRzLnlNYXhpbXVtKCkKICAgICAgICAjIGxhdE1pblkgPSBsbEV4dGVudC55TWluaW11bSgpCiAgICAgICAgbGF0TWluWSA9IGxheWVyTWVyY2F0b3JFeHRlbnRzLnlNaW5pbXVtKCkKICAgICAgICAjaXNTaGFwZWZpbGUgPSAoaXNpbnN0YW5jZShsYXllciwgUWdzVmVjdG9yTGF5ZXIpKQoKCiAgICAgICAgaWYgJ0xheWVyJyBpbiBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddOgogICAgICAgICAgICBpZiB0eXBlKGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10pIGlzIGNvbGxlY3Rpb25zLk9yZGVyZWREaWN0OgogICAgICAgICAgICAgICAgY3VyTGF5ZXIgPSBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddCiAgICAgICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddID0gW2N1ckxheWVyXQoKICAgICAgICBpZiAnTGF5ZXInIGluIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ106CiAgICAgICAgICAgIGZvciBpTGF5ZXIgaW4gcmFuZ2UobGVuKGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10pIC0gMSwgLTEsIC0xKToKICAgICAgICAgICAgICAgIGN1ckxheWVyID0gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXVtpTGF5ZXJdCiAgICAgICAgICAgICAgICBpZiAiTmFtZSIgaW4gY3VyTGF5ZXIgYW5kIGN1ckxheWVyWyJOYW1lIl0gPT0gIkdIOiIgKyBmaWxlbmFtZToKICAgICAgICAgICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddLnBvcChpTGF5ZXIpCgogICAgICAgICNGSVhNRSBPbmUgYXR0cmlidXRlIG9ubHkuIChJcyBhbHdheXMgb3ZlcndyaXRpbmcpCiAgICAgICAgbmV3TGF5ZXJEZXNjcmlwdGlvbiA9IHhtbHRvZGljdC5wYXJzZSgKICAgICAgICAgICAgV01TQ2FwYWJpbGl0aWVzLmdldE1hcERlc2NyaXB0aW9uKGZpbGVuYW1lLCBsYXllckF0dHIsIGxhdE1pblgsIGxhdE1pblksIGxhdE1heFgsIGxhdE1heFksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9qTWluWCwgcHJvak1pblksIHByb2pNYXhYLCBwcm9qTWF4WSwgbWF4Wm9vbSwgaXNTaGFwZWZpbGUsIGRvd25sb2FkTGluaykpWydDT05URU5UJ10KICAgICAgICBpZiAnTGF5ZXInIGluIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ106CiAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10uYXBwZW5kKG5ld0xheWVyRGVzY3JpcHRpb25bJ0xheWVyJ10pCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXSA9IG5ld0xheWVyRGVzY3JpcHRpb24KCiAgICAgICAgbmV3VGlsZVNldERlc2NyaXB0aW9uID0geG1sdG9kaWN0LnBhcnNlKAogICAgICAgICAgICBXTVNDYXBhYmlsaXRpZXMuZ2V0VGlsZVNldERlc2NyaXB0aW9uKGZpbGVuYW1lLCBsYXRNaW5YLCBsYXRNaW5ZLCBsYXRNYXhYLCBsYXRNYXhZLCBwcm9qTWluWCwgcHJvak1pblksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvak1heFgsIHByb2pNYXhZKSlbJ0NPTlRFTlQnXQoKICAgICAgICBpZiBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddIGlzIG5vdCBOb25lIGFuZCAnVGlsZVNldCcgaW4gXAogICAgICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXToKICAgICAgICAgICAgaWYgdHlwZShkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWwogICAgICAgICAgICAgICAgICAgICAgICAnVGlsZVNldCddKSBpcyBjb2xsZWN0aW9ucy5PcmRlcmVkRGljdDoKICAgICAgICAgICAgICAgIGN1clRpbGVTZXQgPSBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWydUaWxlU2V0J10KICAgICAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bJ1RpbGVTZXQnXSA9IFsKICAgICAgICAgICAgICAgICAgICBjdXJUaWxlU2V0XSAgIyBUcmFuc2Zvcm1zIGludG8gYSBsaXN0CgogICAgICAgIGlmIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ10gaXMgbm90IE5vbmUgYW5kICdUaWxlU2V0JyBpbiBcCiAgICAgICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddOgogICAgICAgICAgICBmb3IgaVRpbGVTZXQgaW4gcmFuZ2UoCiAgICAgICAgICAgICAgICAgICAgbGVuKGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bJ1RpbGVTZXQnXSkgLSAxLAogICAgICAgICAgICAgICAgICAgIC0xLCAtMSk6CiAgICAgICAgICAgICAgICBjdXJUaWxlU2V0ID0gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsnVGlsZVNldCddW2lUaWxlU2V0XQogICAgICAgICAgICAgICAgaWYgIkxheWVycyIgaW4gY3VyVGlsZVNldCBhbmQgY3VyVGlsZVNldFsiTGF5ZXJzIl0gPT0gIkdIOiIgKyBmaWxlbmFtZToKICAgICAgICAgICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWydUaWxlU2V0J10ucG9wKGlUaWxlU2V0KQogICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWydUaWxlU2V0J10gKz0gbmV3VGlsZVNldERlc2NyaXB0aW9uWwogICAgICAgICAgICAgICAgJ1RpbGVTZXQnXSAgIyBEb2lzIGVsZW1lbnRvcyBjIG1lc21hIGNoYXZlIHJlcHJlc2VudGEgY29tIGxpc3RhCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXSA9IG5ld1RpbGVTZXREZXNjcmlwdGlvbgogICAgICAgIFdNU0NhcGFiaWxpdGllcy5zYXZlQ3VycmVudENhcGFiaWxpdGllcyhkaXJlY3RvcnksIGRvYykKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgd3JpdGVfZGVzY3JpcHRpb24oZGlyZWN0b3J5LCBsYXllclRpdGxlLCBsYXllckF0dHIsIGNlbGxUeXBlTmFtZSwgbnVsbFZhbHVlLCBvcGVyYXRpb24pOgogICAgICAgIGxheWVyVGl0bGUgPSBVVElMUy5ub3JtYWxpemVOYW1lKGxheWVyVGl0bGUpCiAgICAgICAgY2VsbFR5cGVOYW1lID0gVVRJTFMubm9ybWFsaXplTmFtZShjZWxsVHlwZU5hbWUpCiAgICAgICAgZmlsZWNzdiA9ICJkZXNjcmlwdGlvbi5jc3YiCiAgICAgICAgY3N2UGF0aCA9IG9zLnBhdGguam9pbihkaXJlY3RvcnksIGZpbGVjc3YpCiAgICAgICAganNvblBhdGggPSBvcy5wYXRoLmpvaW4oZGlyZWN0b3J5LCAiZGVzY3JpcHRpb24uanNvbiIpCiAgICAgICAgaWYgb3MucGF0aC5pc2ZpbGUoY3N2UGF0aCk6CiAgICAgICAgICAgIGNzdkZpbGUgPSBvcGVuKGNzdlBhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikKICAgICAgICBlbHNlOgogICAgICAgICAgICBjc3ZGaWxlID0gaW8uU3RyaW5nSU8oIktleSosIGNlbGwsIG51bGwsIG9wZXJhdGlvbiwgYXR0cixcbi05OTk5LCBcIlwiLCAtMSwgXCJcIiwgbmVuaHVtYSwgIikKCiAgICAgICAgY3N2X3JlYWRlciA9IGNzdi5EaWN0UmVhZGVyKGNzdkZpbGUsIGRlbGltaXRlcj0nLCcpCiAgICAgICAgbGluZV9jb3VudCA9IDAKICAgICAgICBlbGVtZW50cyA9IFtjZWxsVHlwZU5hbWUsIHN0cihudWxsVmFsdWUpLCBvcGVyYXRpb24sIGxheWVyQXR0cl0KICAgICAgICBmb3Igcm93IGluIGNzdl9yZWFkZXI6CiAgICAgICAgICAgIGN1ckVudHJ5ID0gewogICAgICAgICAgICAgICAgJ2NlbGxUeXBlJzogcm93WycgY2VsbCddLnN0cmlwKCksCiAgICAgICAgICAgICAgICAnbnVsbFZhbHVlJzogcm93WycgbnVsbCddLnN0cmlwKCksCiAgICAgICAgICAgICAgICAnb3BlcmF0aW9uJzogcm93Wycgb3BlcmF0aW9uJ10uc3RyaXAoKSwKICAgICAgICAgICAgICAgICdhdHRyaWJ1dGUnOiByb3dbJyBhdHRyJ10uc3RyaXAoKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIGxpbmVfY291bnQgPiAwIGFuZCBjdXJFbnRyeVsnb3BlcmF0aW9uJ10gIT0gb3BlcmF0aW9uIGFuZCBjdXJFbnRyeVsnYXR0cmlidXRlJ10gIT0gbGF5ZXJBdHRyOgogICAgICAgICAgICAgICAgIyBLZXkgKiwgY2VsbCwgbnVsbCwgb3BlcmF0aW9uLCBhdHRyLAogICAgICAgICAgICAgICAgZWxlbWVudHMuYXBwZW5kKGN1ckVudHJ5WydjZWxsVHlwZSddKQogICAgICAgICAgICAgICAgZWxlbWVudHMuYXBwZW5kKGN1ckVudHJ5WydudWxsVmFsdWUnXSkKICAgICAgICAgICAgICAgIGVsZW1lbnRzLmFwcGVuZChjdXJFbnRyeVsnb3BlcmF0aW9uJ10pCiAgICAgICAgICAgICAgICBlbGVtZW50cy5hcHBlbmQoY3VyRW50cnlbJ2F0dHJpYnV0ZSddKQogICAgICAgICAgICBsaW5lX2NvdW50ICs9IDEKICAgICAgICB3aXRoIG9wZW4oanNvblBhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMganNvbkZpbGU6CiAgICAgICAgICAgIGpzb25GaWxlLndyaXRlKGpzb24uZHVtcHMoZWxlbWVudHMpKQogICAgICAgIGNzdkZpbGUuY2xvc2UoKQoKY2xhc3MgV01TQkJveCgpOgogICAgeE1heCA9IE5vbmUKICAgIGRlZiB4TWF4aW11bShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi54TWF4CgogICAgeE1pbiA9IE5vbmUKICAgIGRlZiB4TWluaW11bShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi54TWluCgogICAgeU1heCA9IE5vbmUKICAgIGRlZiB5TWF4aW11bShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi55TWF4CgogICAgeU1pbiA9IE5vbmUKICAgIGRlZiB5TWluaW11bShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi55TWluCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHhNYXgsIHhNaW4sIHlNYXgsIHlNaW4pOgogICAgICAgIHNlbGYueE1heCA9IHhNYXgKICAgICAgICBzZWxmLnhNaW4gPSB4TWluCiAgICAgICAgc2VsZi55TWF4ID0geU1heAogICAgICAgIHNlbGYueU1pbiA9IHlNaW4KCgoKdHJ5OgogICAgZnJvbSBHREFMX1VUSUxTIGltcG9ydCBHREFMX1VUSUxTCmV4Y2VwdDoKICAgIHBhc3MgI05vdCBpbiBEaW5hbWljYSBDb2RlCgpmcm9tIG9zZ2VvIGltcG9ydCBnZGFsLG9ncixvc3IKCiNUaGFua3MgdG8gaHR0cHM6Ly9naXMuc3RhY2tleGNoYW5nZS5jb20vcXVlc3Rpb25zLzU3ODM0L2hvdy10by1nZXQtcmFzdGVyLWNvcm5lci1jb29yZGluYXRlcy11c2luZy1weXRob24tZ2RhbC1iaW5kaW5ncwpjbGFzcyBHREFMX1VUSUxTOgoKICAgICNEYW5pbG8gdmFpIDQgcG9udG9zIFtMZWZ0IEJvdHRvbSwgIExlZnQgVG9wLCBSaWdodCBCb3R0b20sIFJpZ2h0IFRvcF0KICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfZ2V0RXh0ZW50KGd0LGNvbHMscm93cyk6CiAgICAgICAgJycnIFJldHVybiBsaXN0IG9mIGNvcm5lciBjb29yZGluYXRlcyBmcm9tIGEgZ2VvdHJhbnNmb3JtCgogICAgICAgICAgICBAdHlwZSBndDogICBDe3R1cGxlL2xpc3R9CiAgICAgICAgICAgIEBwYXJhbSBndDogZ2VvdHJhbnNmb3JtCiAgICAgICAgICAgIEB0eXBlIGNvbHM6ICAgQ3tpbnR9CiAgICAgICAgICAgIEBwYXJhbSBjb2xzOiBudW1iZXIgb2YgY29sdW1ucyBpbiB0aGUgZGF0YXNldAogICAgICAgICAgICBAdHlwZSByb3dzOiAgIEN7aW50fQogICAgICAgICAgICBAcGFyYW0gcm93czogbnVtYmVyIG9mIHJvd3MgaW4gdGhlIGRhdGFzZXQKICAgICAgICAgICAgQHJ0eXBlOiAgICBDe1tmbG9hdCwuLi4sZmxvYXRdfQogICAgICAgICAgICBAcmV0dXJuOiAgIGNvb3JkaW5hdGVzIG9mIGVhY2ggY29ybmVyCiAgICAgICAgJycnCiAgICAgICAgZXh0PVtdCiAgICAgICAgeGFycj1bMCxjb2xzXQogICAgICAgIHlhcnI9WzAscm93c10KCiAgICAgICAgZm9yIHB4IGluIHhhcnI6CiAgICAgICAgICAgIGZvciBweSBpbiB5YXJyOgogICAgICAgICAgICAgICAgeD1ndFswXSsocHgqZ3RbMV0pKyhweSpndFsyXSkKICAgICAgICAgICAgICAgIHk9Z3RbM10rKHB4Kmd0WzRdKSsocHkqZ3RbNV0pCiAgICAgICAgICAgICAgICBleHQuYXBwZW5kKFt4LHldKQogICAgICAgICAgICAgICAgcHJpbnQoeCx5KQogICAgICAgICAgICB5YXJyLnJldmVyc2UoKQogICAgICAgIHJldHVybiBleHQKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgX3JlcHJvamVjdENvb3Jkcyhjb29yZHMsc3JjX3Nycyx0Z3Rfc3JzKToKICAgICAgICAnJycgUmVwcm9qZWN0IGEgbGlzdCBvZiB4LHkgY29vcmRpbmF0ZXMuCgogICAgICAgICAgICBAdHlwZSBnZW9tOiAgICAgQ3t0dXBsZS9saXN0fQogICAgICAgICAgICBAcGFyYW0gZ2VvbTogICAgTGlzdCBvZiBbW3gseV0sLi4uW3gseV1dIGNvb3JkaW5hdGVzCiAgICAgICAgICAgIEB0eXBlIHNyY19zcnM6ICBDe29zci5TcGF0aWFsUmVmZXJlbmNlfQogICAgICAgICAgICBAcGFyYW0gc3JjX3NyczogT1NSIFNwYXRpYWxSZWZlcmVuY2Ugb2JqZWN0CiAgICAgICAgICAgIEB0eXBlIHRndF9zcnM6ICBDe29zci5TcGF0aWFsUmVmZXJlbmNlfQogICAgICAgICAgICBAcGFyYW0gdGd0X3NyczogT1NSIFNwYXRpYWxSZWZlcmVuY2Ugb2JqZWN0CiAgICAgICAgICAgIEBydHlwZTogICAgICAgICBDe3R1cGxlL2xpc3R9CiAgICAgICAgICAgIEByZXR1cm46ICAgICAgICBMaXN0IG9mIHRyYW5zZm9ybWVkIFtbeCx5XSwuLi5beCx5XV0gY29vcmRpbmF0ZXMKICAgICAgICAnJycKICAgICAgICB0cmFuc19jb29yZHM9W10KICAgICAgICB0cmFuc2Zvcm0gPSBvc3IuQ29vcmRpbmF0ZVRyYW5zZm9ybWF0aW9uKCBzcmNfc3JzLCB0Z3Rfc3JzKQogICAgICAgIGZvciB4LHkgaW4gY29vcmRzOgogICAgICAgICAgICB4LHkseiA9IHRyYW5zZm9ybS5UcmFuc2Zvcm1Qb2ludCh4LHkpCiAgICAgICAgICAgIHRyYW5zX2Nvb3Jkcy5hcHBlbmQoW3gseV0pCiAgICAgICAgcmV0dXJuIHRyYW5zX2Nvb3JkcwoKICAgICNkYW5pbG8gc2UgbyBlcHNnQ29kZSDDqSBOb25lIHJldG9ybmEgbyBkbyBwcsOzcHJpbyBtYXBhIHNlbSBhbHRlcmFyLgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldEV4dGVudChyYXN0ZXJQYXRoLCBlcHNnQ29kZT1Ob25lKToKICAgICAgICBkcyA9IGdkYWwuT3BlbihyYXN0ZXJQYXRoLCBnZGFsLkdBX1JlYWRPbmx5KQogICAgICAgIHRyeToKICAgICAgICAgICAgZ3QgPSBkcy5HZXRHZW9UcmFuc2Zvcm0oKQogICAgICAgICAgICBjb2xzID0gZHMuUmFzdGVyWFNpemUKICAgICAgICAgICAgcm93cyA9IGRzLlJhc3RlcllTaXplCiAgICAgICAgICAgIGV4dCA9IEdEQUxfVVRJTFMuX2dldEV4dGVudChndCwgY29scywgcm93cykKICAgICAgICAgICAgaWYgZXBzZ0NvZGUgaXMgTm9uZToKICAgICAgICAgICAgICAgIHJldHVybiBHREFMX1VUSUxTLmdldEFycmF5RnJvbUV4dChleHQpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzcmNfc3JzPW9zci5TcGF0aWFsUmVmZXJlbmNlKCkKICAgICAgICAgICAgICAgIHNyY19zcnMuSW1wb3J0RnJvbVdrdChkcy5HZXRQcm9qZWN0aW9uKCkpCiAgICAgICAgICAgICAgICB0Z3Rfc3JzID0gb3NyLlNwYXRpYWxSZWZlcmVuY2UoKQogICAgICAgICAgICAgICAgdGd0X3Nycy5JbXBvcnRGcm9tRVBTRyhlcHNnQ29kZSkKICAgICAgICAgICAgICAgIHJldHVybiBHREFMX1VUSUxTLmdldEFycmF5RnJvbUV4dChHREFMX1VUSUxTLl9yZXByb2plY3RDb29yZHMoZXh0LHNyY19zcnMsdGd0X3NycykpCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgZHMgPSBOb25lCgogICAgI1JldG9ybmEgeE1heCwgeE1pbiwgeU1heCwgeU1pbiBkbyBleHRlbnRzLgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldEFycmF5RnJvbUV4dChleHQpOgogICAgICAgIG1heFBvaW50ID0gZXh0WzNdCiAgICAgICAgbWluUG9pbnQgPSBleHRbMV0KICAgICAgICByZXR1cm4gKG1heFBvaW50WzBdLCBtaW5Qb2ludFswXSwgbWF4UG9pbnRbMV0sIG1pblBvaW50WzFdKQoKICAgICMgQHN0YXRpY21ldGhvZAogICAgIyAjUGVnYSBhcyBpbmZvcm1hY29lcyBkZSBjZWx1bGEgZGlyZXRvIGRvIHJhc3RlciwgdXNhbmRvIG8gR0RBTC4KICAgICMgZGVmIGdldFJhc3RlckNlbGxJbmZvKG1hcERhdGFQYXRoKToKICAgICMgICAgICMgY2VsbEluZm8gPSBkaWN0KCkKICAgICMgICAgICMgIyBpZiBVdGlscy5pc1Jhc3RlckZpbGUoc2VsZi5fX21hcERhdGFQYXRoKSA6CiAgICAjICAgICAjIGhEYXRhc2V0ID0gZ2RhbC5PcGVuKG1hcERhdGFQYXRoLCBnZGFsLkdBX1JlYWRPbmx5KQogICAgIyAgICAgIyB0cnk6CiAgICAjICAgICAjICAgICBpZiBoRGF0YXNldCBpcyBub3QgTm9uZSBhbmQgaERhdGFzZXQuUmFzdGVyQ291bnQgPiAwIDoKICAgICMgICAgICMgICAgICAgICBjdXJCYW5kID0gaERhdGFzZXQuR2V0UmFzdGVyQmFuZCgxKQogICAgIyAgICAgIyAgICAgICAgIHVuaWNvZGUoZ2RhbC5HZXREYXRhVHlwZU5hbWUoY3VyQmFuZC5EYXRhVHlwZSkpCiAgICAjICAgICAjICAgICAgICAgY2VsbEluZm9bdSJOdWxsIENlbGwgVmFsdWUiXSA9IHVuaWNvZGUoY3VyQmFuZC5HZXROb0RhdGFWYWx1ZSgpKQogICAgIyAgICAgIyAgICAgICAgIGNlbGxJbmZvW3UiTnVtYmVyIG9mIExpbmVzIl0gPSB1bmljb2RlKGhEYXRhc2V0LlJhc3RlcllTaXplKQogICAgIyAgICAgIyAgICAgICAgIGNlbGxJbmZvW3UiTnVtYmVyIG9mIENvbHVtbnMiXSA9IHVuaWNvZGUoaERhdGFzZXQuUmFzdGVyWFNpemUpCiAgICAjICAgICAjICAgICAgICAgYWRmR2VvVHJhbnNmb3JtID0gaERhdGFzZXQuR2V0R2VvVHJhbnNmb3JtKGNhbl9yZXR1cm5fbnVsbCA9IFRydWUpCiAgICAjICAgICAjICAgICAgICAgaWYgYWRmR2VvVHJhbnNmb3JtIGlzIG5vdCBOb25lIDoKICAgICMgICAgICMgICAgICAgICAgICAgY2VsbEluZm9bdSJDZWxsIFdpZHRoIl0gPSB1bmljb2RlKGFkZkdlb1RyYW5zZm9ybVsxXSkKICAgICMgICAgICMgICAgICAgICAgICAgY2VsbEluZm9bdSJDZWxsIEhlaWdodCJdID0gdW5pY29kZShmYWJzKGFkZkdlb1RyYW5zZm9ybVs1XSkpCiAgICAjICAgICAjICAgICAgICAgY2VsbEluZm9bdSJOdW1iZXIgb2YgTGF5ZXJzIl0gPSB1bmljb2RlKGhEYXRhc2V0LlJhc3RlckNvdW50KQogICAgIyAgICAgIyBmaW5hbGx5OgogICAgIyAgICAgIyAgICAgaERhdGFzZXQgPSBOb25lCiAgICAjICAgICAjIHJldHVybiBjZWxsSW5mbwogICAgIyAgICAgcmV0dXJuICIiCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldENlbGxUeXBlKHJhc3RlclBhdGgpOgogICAgICAgIHVuaWNvZGUoZ2RhbC5HZXREYXRhVHlwZU5hbWUoY3VyQmFuZC5EYXRhVHlwZSkpCgoKCgoKdHJ5OgogICAgZnJvbSBXTVNDYXBhYmlsaXRpZXMgaW1wb3J0IFdNU0NhcGFiaWxpdGllcwpleGNlcHQ6CiAgICBwYXNzCgojIS91c3IvYmluL2VudiBweXRob24KIyAtKi0gY29kaW5nOiB1dGYtOCAtKi0KCgppc0RpbmFtaWNhID0gRmFsc2UKdHJ5OgogICAgZGluYW1pY2EucGFja2FnZSgib3MiKQogICAgaXNEaW5hbWljYSA9IFRydWUKZXhjZXB0OgogICAgaXNEaW5hbWljYSA9IEZhbHNlCgppZiBub3QgaXNEaW5hbWljYToKICAgIHRyeToKICAgICAgICBmcm9tIC5VVElMUyBpbXBvcnQgVVRJTFMKICAgICAgICBmcm9tIC4gaW1wb3J0IHhtbHRvZGljdAogICAgZXhjZXB0OgogICAgICAgIHBhc3MgI05vdCBpbiBRR0lTCgogICAgdHJ5OgogICAgICAgIGZyb20gVVRJTFMgaW1wb3J0IFVUSUxTCiAgICAgICAgZnJvbSB4bWx0b2RpY3QgaW1wb3J0IHhtbHRvZGljdAogICAgZXhjZXB0OgogICAgICAgIHBhc3MgI05vdCBpbiBEaW5hbWljYSBDb2RlCgpmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBPcmRlcmVkRGljdAppbXBvcnQgY29sbGVjdGlvbnMKZnJvbSBwYXRobGliIGltcG9ydCBQYXRoCmltcG9ydCBqc29uCmltcG9ydCBvcwppbXBvcnQgaW8KaW1wb3J0IGNzdgppbXBvcnQgcmUKCiMgdHJ5OgojICAgICBmcm9tIHFnaXMuY29yZSBpbXBvcnQgKFFnc0Nvb3JkaW5hdGVSZWZlcmVuY2VTeXN0ZW0sIFFnc1Byb2plY3QsIFFnc1BvaW50WFksIFFnc0Nvb3JkaW5hdGVUcmFuc2Zvcm0sIFFnc1ZlY3RvckxheWVyKQojIGV4Y2VwdDoKIyAgICAgcGFzcwoKY2xhc3MgV01TQ2FwYWJpbGl0aWVzOgoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXREZWZhdWx0Q2FwYWJpbGl0aWVzKCk6CiAgICAgICAgcmV0dXJuICcnJzw/eG1sIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9IlVURi04Ij8+PCFET0NUWVBFIFdNVF9NU19DYXBhYmlsaXRpZXMgU1lTVEVNICJodHRwOi8vbWFwcy5jc3IudWZtZy5icjo4MC9nZW9zZXJ2ZXIvc2NoZW1hcy93bXMvMS4xLjEvV01TX01TX0NhcGFiaWxpdGllcy5kdGQiWwogICAgPCFFTEVNRU5UIFZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzIChUaWxlU2V0KikgPgogICAgPCFFTEVNRU5UIFRpbGVTZXQgKFNSUywgQm91bmRpbmdCb3g/LCBSZXNvbHV0aW9ucywgV2lkdGgsIEhlaWdodCwgRm9ybWF0LCBMYXllcnMqLCBTdHlsZXMqKSA+CiAgICA8IUVMRU1FTlQgUmVzb2x1dGlvbnMgKCNQQ0RBVEEpID4KICAgIDwhRUxFTUVOVCBXaWR0aCAoI1BDREFUQSkgPgogICAgPCFFTEVNRU5UIEhlaWdodCAoI1BDREFUQSkgPgogICAgPCFFTEVNRU5UIExheWVycyAoI1BDREFUQSkgPgogICAgPCFFTEVNRU5UIFN0eWxlcyAoI1BDREFUQSkgPgogICAgXT4KICAgIDxXTVRfTVNfQ2FwYWJpbGl0aWVzIHZlcnNpb249IjEuMS4xIiB1cGRhdGVTZXF1ZW5jZT0iNjMyNTgiPgogICAgICA8U2VydmljZT4KICAgICAgICA8TmFtZT5PR0M6V01TPC9OYW1lPgogICAgICAgIDxUaXRsZT5DU1IgV2ViIE1hcCBTZXJ2aWNlPC9UaXRsZT4KICAgICAgICA8QWJzdHJhY3Q+Q29tcGxpYW50IFdNUyBSZXNwb25zZTwvQWJzdHJhY3Q+CiAgICAgICAgPEtleXdvcmRMaXN0PgogICAgICAgICAgPEtleXdvcmQ+V0ZTPC9LZXl3b3JkPgogICAgICAgICAgPEtleXdvcmQ+V01TPC9LZXl3b3JkPgogICAgICAgICAgPEtleXdvcmQ+R0VPU0VSVkVSPC9LZXl3b3JkPgogICAgICAgIDwvS2V5d29yZExpc3Q+CiAgICAgICAgPE9ubGluZVJlc291cmNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazp0eXBlPSJzaW1wbGUiIHhsaW5rOmhyZWY9Imh0dHA6Ly9nZW9zZXJ2ZXIuc291cmNlZm9yZ2UubmV0L2h0bWwvaW5kZXgucGhwIi8+CiAgICAgICAgPENvbnRhY3RJbmZvcm1hdGlvbj4KICAgICAgICAgIDxDb250YWN0UGVyc29uUHJpbWFyeT4KICAgICAgICAgICAgPENvbnRhY3RQZXJzb24+R0lUSFVCIG93bmVyPC9Db250YWN0UGVyc29uPgogICAgICAgICAgICA8Q29udGFjdE9yZ2FuaXphdGlvbj5HSVRIVUIgb3duZXI8L0NvbnRhY3RPcmdhbml6YXRpb24+CiAgICAgICAgICA8L0NvbnRhY3RQZXJzb25QcmltYXJ5PgogICAgICAgICAgPENvbnRhY3RQb3NpdGlvbj5DaGllZiBnZW9ncmFwaGVyPC9Db250YWN0UG9zaXRpb24+CiAgICAgICAgICA8Q29udGFjdEFkZHJlc3M+CiAgICAgICAgICAgIDxBZGRyZXNzVHlwZT5Xb3JrPC9BZGRyZXNzVHlwZT4KICAgICAgICAgICAgPEFkZHJlc3MvPgogICAgICAgICAgICA8Q2l0eT5BbGV4YW5kcmlhPC9DaXR5PgogICAgICAgICAgICA8U3RhdGVPclByb3ZpbmNlLz4KICAgICAgICAgICAgPFBvc3RDb2RlLz4KICAgICAgICAgICAgPENvdW50cnk+RWd5cHQ8L0NvdW50cnk+CiAgICAgICAgICA8L0NvbnRhY3RBZGRyZXNzPgogICAgICAgICAgPENvbnRhY3RWb2ljZVRlbGVwaG9uZS8+CiAgICAgICAgICA8Q29udGFjdEZhY3NpbWlsZVRlbGVwaG9uZS8+CiAgICAgICAgICA8Q29udGFjdEVsZWN0cm9uaWNNYWlsQWRkcmVzcz5jbGF1ZGl1cy5wdG9sb21hZXVzQGdtYWlsLmNvbTwvQ29udGFjdEVsZWN0cm9uaWNNYWlsQWRkcmVzcz4KICAgICAgICA8L0NvbnRhY3RJbmZvcm1hdGlvbj4KICAgICAgICA8RmVlcz5OT05FPC9GZWVzPgogICAgICAgIDxBY2Nlc3NDb25zdHJhaW50cz5OT05FPC9BY2Nlc3NDb25zdHJhaW50cz4KICAgICAgPC9TZXJ2aWNlPgogICAgICA8Q2FwYWJpbGl0eT4KICAgICAgICA8UmVxdWVzdD4KICAgICAgICAgIDxHZXRDYXBhYmlsaXRpZXM+CiAgICAgICAgICAgIDxGb3JtYXQ+YXBwbGljYXRpb24vdm5kLm9nYy53bXNfeG1sPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxEQ1BUeXBlPgogICAgICAgICAgICAgIDxIVFRQPgogICAgICAgICAgICAgICAgPEdldD4KICAgICAgICAgICAgICAgICAgPE9ubGluZVJlc291cmNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazp0eXBlPSJzaW1wbGUiIHhsaW5rOmhyZWY9Imh0dHA6Ly9tYXBzLmNzci51Zm1nLmJyOjgwL2dlb3NlcnZlci93bXM/U0VSVklDRT1XTVMmYW1wOyIvPgogICAgICAgICAgICAgICAgPC9HZXQ+CiAgICAgICAgICAgICAgICA8UG9zdD4KICAgICAgICAgICAgICAgICAgPE9ubGluZVJlc291cmNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazp0eXBlPSJzaW1wbGUiIHhsaW5rOmhyZWY9Imh0dHA6Ly9tYXBzLmNzci51Zm1nLmJyOjgwL2dlb3NlcnZlci93bXM/U0VSVklDRT1XTVMmYW1wOyIvPgogICAgICAgICAgICAgICAgPC9Qb3N0PgogICAgICAgICAgICAgIDwvSFRUUD4KICAgICAgICAgICAgPC9EQ1BUeXBlPgogICAgICAgICAgPC9HZXRDYXBhYmlsaXRpZXM+CiAgICAgICAgICA8R2V0TWFwPgogICAgICAgICAgICA8Rm9ybWF0PmltYWdlL3BuZzwvRm9ybWF0PgogICAgICAgICAgICA8RENQVHlwZT4KICAgICAgICAgICAgICA8SFRUUD4KICAgICAgICAgICAgICAgIDxHZXQ+CiAgICAgICAgICAgICAgICAgIDxPbmxpbmVSZXNvdXJjZSB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeGxpbms6dHlwZT0ic2ltcGxlIiB4bGluazpocmVmPSJodHRwOi8vbWFwcy5jc3IudWZtZy5icjo4MC9nZW9zZXJ2ZXIvd21zP1NFUlZJQ0U9V01TJmFtcDsiLz4KICAgICAgICAgICAgICAgIDwvR2V0PgogICAgICAgICAgICAgIDwvSFRUUD4KICAgICAgICAgICAgPC9EQ1BUeXBlPgogICAgICAgICAgPC9HZXRNYXA+CiAgICAgICAgICA8R2V0RmVhdHVyZUluZm8+CiAgICAgICAgICAgIDxGb3JtYXQ+dGV4dC9wbGFpbjwvRm9ybWF0PgogICAgICAgICAgICA8Rm9ybWF0PmFwcGxpY2F0aW9uL3ZuZC5vZ2MuZ21sPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxGb3JtYXQ+YXBwbGljYXRpb24vdm5kLm9nYy5nbWwvMy4xLjE8L0Zvcm1hdD4KICAgICAgICAgICAgPEZvcm1hdD50ZXh0L2h0bWw8L0Zvcm1hdD4KICAgICAgICAgICAgPEZvcm1hdD5hcHBsaWNhdGlvbi9qc29uPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxEQ1BUeXBlPgogICAgICAgICAgICAgIDxIVFRQPgogICAgICAgICAgICAgICAgPEdldD4KICAgICAgICAgICAgICAgICAgPE9ubGluZVJlc291cmNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazp0eXBlPSJzaW1wbGUiIHhsaW5rOmhyZWY9Imh0dHA6Ly9tYXBzLmNzci51Zm1nLmJyOjgwL2dlb3NlcnZlci93bXM/U0VSVklDRT1XTVMmYW1wOyIvPgogICAgICAgICAgICAgICAgPC9HZXQ+CiAgICAgICAgICAgICAgICA8UG9zdD4KICAgICAgICAgICAgICAgICAgPE9ubGluZVJlc291cmNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazp0eXBlPSJzaW1wbGUiIHhsaW5rOmhyZWY9Imh0dHA6Ly9tYXBzLmNzci51Zm1nLmJyOjgwL2dlb3NlcnZlci93bXM/U0VSVklDRT1XTVMmYW1wOyIvPgogICAgICAgICAgICAgICAgPC9Qb3N0PgogICAgICAgICAgICAgIDwvSFRUUD4KICAgICAgICAgICAgPC9EQ1BUeXBlPgogICAgICAgICAgPC9HZXRGZWF0dXJlSW5mbz4KICAgICAgICAgIDxEZXNjcmliZUxheWVyPgogICAgICAgICAgICA8Rm9ybWF0PmFwcGxpY2F0aW9uL3ZuZC5vZ2Mud21zX3htbDwvRm9ybWF0PgogICAgICAgICAgICA8RENQVHlwZT4KICAgICAgICAgICAgICA8SFRUUD4KICAgICAgICAgICAgICAgIDxHZXQ+CiAgICAgICAgICAgICAgICAgIDxPbmxpbmVSZXNvdXJjZSB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeGxpbms6dHlwZT0ic2ltcGxlIiB4bGluazpocmVmPSJodHRwOi8vbWFwcy5jc3IudWZtZy5icjo4MC9nZW9zZXJ2ZXIvd21zP1NFUlZJQ0U9V01TJmFtcDsiLz4KICAgICAgICAgICAgICAgIDwvR2V0PgogICAgICAgICAgICAgIDwvSFRUUD4KICAgICAgICAgICAgPC9EQ1BUeXBlPgogICAgICAgICAgPC9EZXNjcmliZUxheWVyPgogICAgICAgICAgPEdldExlZ2VuZEdyYXBoaWM+CiAgICAgICAgICAgIDxGb3JtYXQ+aW1hZ2UvcG5nPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxEQ1BUeXBlPgogICAgICAgICAgICAgIDxIVFRQPgogICAgICAgICAgICAgICAgPEdldD4KICAgICAgICAgICAgICAgICAgPE9ubGluZVJlc291cmNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazp0eXBlPSJzaW1wbGUiIHhsaW5rOmhyZWY9Imh0dHA6Ly9tYXBzLmNzci51Zm1nLmJyOjgwL2dlb3NlcnZlci93bXM/U0VSVklDRT1XTVMmYW1wOyIvPgogICAgICAgICAgICAgICAgPC9HZXQ+CiAgICAgICAgICAgICAgPC9IVFRQPgogICAgICAgICAgICA8L0RDUFR5cGU+CiAgICAgICAgICA8L0dldExlZ2VuZEdyYXBoaWM+CiAgICAgICAgICA8R2V0U3R5bGVzPgogICAgICAgICAgICA8Rm9ybWF0PmFwcGxpY2F0aW9uL3ZuZC5vZ2Muc2xkK3htbDwvRm9ybWF0PgogICAgICAgICAgICA8RENQVHlwZT4KICAgICAgICAgICAgICA8SFRUUD4KICAgICAgICAgICAgICAgIDxHZXQ+CiAgICAgICAgICAgICAgICAgIDxPbmxpbmVSZXNvdXJjZSB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeGxpbms6dHlwZT0ic2ltcGxlIiB4bGluazpocmVmPSJodHRwOi8vbWFwcy5jc3IudWZtZy5icjo4MC9nZW9zZXJ2ZXIvd21zP1NFUlZJQ0U9V01TJmFtcDsiLz4KICAgICAgICAgICAgICAgIDwvR2V0PgogICAgICAgICAgICAgIDwvSFRUUD4KICAgICAgICAgICAgPC9EQ1BUeXBlPgogICAgICAgICAgPC9HZXRTdHlsZXM+CiAgICAgICAgPC9SZXF1ZXN0PgogICAgICAgIDxFeGNlcHRpb24+CiAgICAgICAgICA8Rm9ybWF0PmFwcGxpY2F0aW9uL3ZuZC5vZ2Muc2VfeG1sPC9Gb3JtYXQ+CiAgICAgICAgICA8Rm9ybWF0PmFwcGxpY2F0aW9uL3ZuZC5vZ2Muc2VfaW5pbWFnZTwvRm9ybWF0PgogICAgICAgIDwvRXhjZXB0aW9uPgogICAgICAgIDxWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcz4KICAgICAgICAgIDxub3RlbXB0eT48L25vdGVtcHR5PgogICAgICAgIDwvVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXM+CiAgICAgICAgPFVzZXJEZWZpbmVkU3ltYm9saXphdGlvbiBTdXBwb3J0U0xEPSIxIiBVc2VyTGF5ZXI9IjEiIFVzZXJTdHlsZT0iMSIgUmVtb3RlV0ZTPSIxIi8+CiAgICAgICAgPExheWVyIHF1ZXJ5YWJsZT0iMCIgb3BhcXVlPSIwIiBub1N1YnNldHM9IjAiPgogICAgICAgICAgPFRpdGxlPk1hcFNlcnZlciB2aWEgR0l0SHViPC9UaXRsZT4KICAgICAgICAgIDxBYnN0cmFjdD5HaXRIdWIgV01TPC9BYnN0cmFjdD4KICAgICAgICAgIDwhLS1BbGwgc3VwcG9ydGVkIEVQU0cgcHJvamVjdGlvbnM6LS0+CiAgICAgICAgICA8U1JTPkVQU0c6Mzg1NzwvU1JTPgogICAgICAgICAgPFNSUz5FUFNHOjQzMjY8L1NSUz4KICAgICAgICAgIDxTUlM+RVBTRzo5MDA5MTM8L1NSUz4KICAgICAgICAgIDxTUlM+RVBTRzo0MjMwMzwvU1JTPgogICAgICAgICAgPExhdExvbkJvdW5kaW5nQm94IG1pbng9Ii0xODAuMDAwMDQwNzQxOTk5OTgiIG1pbnk9Ii05MC4wIiBtYXh4PSIxODAuMDAwMDAwMDAwMDAwMSIgbWF4eT0iOTAuMCIvPgogICAgICAgIDwvTGF5ZXI+CiAgICAgIDwvQ2FwYWJpbGl0eT4KICAgIDwvV01UX01TX0NhcGFiaWxpdGllcz4nJycKCiAgICAjIEBzdGF0aWNtZXRob2QKICAgICMgZGVmIGNvbnZlcnRDb29yZGluYXRlUHJvaihjcnNQcm9qLCBmcm9tWCwgZnJvbVksIG91dHB1dFByb2plY3RlZCk6CiAgICAjCiAgICAjICAgICByZWdleCA9IHIiXlsgXSpQUk9KQ1MiCiAgICAjICAgICBpc1Byb2plY3RlZCA9IHJlLm1hdGNoKHJlZ2V4LCBjcnNQcm9qKQogICAgIwogICAgIyAgICAgaWYgKGlzUHJvamVjdGVkIGFuZCBvdXRwdXRQcm9qZWN0ZWQpIG9yICggbm90IGlzUHJvamVjdGVkIGFuZCAgbm90IG91dHB1dFByb2plY3RlZCk6CiAgICAjICAgICAgICAgcmV0dXJuIChmcm9tWCwgZnJvbVkpCiAgICAjICAgICBlbHNlOgogICAgIyAgICAgICAgIGZQcm9qID0gUWdzQ29vcmRpbmF0ZVJlZmVyZW5jZVN5c3RlbSgpCiAgICAjICAgICAgICAgZlByb2ouY3JlYXRlRnJvbVdrdChjcnNQcm9qKQogICAgIyAgICAgICAgIHRQcm9qID0gUWdzQ29vcmRpbmF0ZVJlZmVyZW5jZVN5c3RlbSgpCiAgICAjICAgICAgICAgdFByb2ouY3JlYXRlRnJvbVByb2o0KCIrcHJvaj1tZXJjICthPTYzNzgxMzcgK2I9NjM3ODEzNyArbGF0X3RzPTAuMCArbG9uXzA9MC4wICt4XzA9MC4wICt5XzA9MCAraz0xLjAgK3VuaXRzPW0gK25hZGdyaWRzPUBudWxsICt3a3RleHQgICtub19kZWZzIiBpZiBvdXRwdXRQcm9qZWN0ZWQgZWxzZSAiK3Byb2o9bG9uZ2xhdCArZGF0dW09V0dTODQgK25vX2RlZnMgIikKICAgICMgICAgICAgICBuZXdDb29yZCA9IFFnc0Nvb3JkaW5hdGVUcmFuc2Zvcm0oZlByb2osIHRQcm9qLCBRZ3NQcm9qZWN0Lmluc3RhbmNlKCkpLnRyYW5zZm9ybShRZ3NQb2ludFhZKGZyb21YLCBmcm9tWSksIFRydWUpCiAgICAjICAgICByZXR1cm4gKG5ld0Nvb3JkLngsIG5ld0Nvb3JkLnkpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldE1hcEtleXdvcmQoaXNTaGFwZWZpbGUsIG1heFpvb20sIGRsTGluaz1Ob25lKToKICAgICAgICBpZiBkbExpbmsgaXMgTm9uZSBvciBsZW4oZGxMaW5rKSA9PSAwOgogICAgICAgICAgICBkbExpbmsgPSAnZGlzYWJsZWRvd25sb2FkJwogICAgICAgIGVsaWYgJzonIGluIGRsTGluazoKICAgICAgICAgICAgZGxMaW5rID0gZGxMaW5rWyhkbExpbmsuaW5kZXgoJzonKSArIDEpOl0KICAgICAgICBlbGlmICfLuCcgaW4gZGxMaW5rOgogICAgICAgICAgICBkbExpbmsgPSBkbExpbmtbKGRsTGluay5pbmRleCgny7gnKSArIDEpOl0KICAgICAgICByZXR1cm4gImdyb3Vwy7giICsgKCdzaHAnIGlmIGlzU2hhcGVmaWxlIGVsc2UgJ3RpZicpICsgIsu4y7jLuCIgKyBkbExpbmsgKyAiy7hub3RMaXN0aW5ny7jLuG1heFpvb23LuCIgKyBzdHIobWF4Wm9vbSkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0TWFwRGVzY3JpcHRpb24obGF5ZXJOYW1lSUQsIGxheWVyQXR0ciwgbGF0TWluWCwgbGF0TWluWSwgbGF0TWF4WCwgbGF0TWF4WSwgcHJvak1pblgsIHByb2pNaW5ZLCBwcm9qTWF4WCwgcHJvak1heFksIG1heFpvb20sIGlzU2hhcGVmaWxlLCBkTGluayk6CiAgICAgICAgbGF5ZXJBdHRyID0gVVRJTFMubm9ybWFsaXplTmFtZShsYXllckF0dHIpCiAgICAgICAgbGF5ZXJOYW1lSUQgPSBVVElMUy5ub3JtYWxpemVOYW1lKGxheWVyTmFtZUlEKQogICAgICAgICMgSW52ZXJ0aSBvIG1pbngvbWlueSBlIG1heFgvbWF4WSBkbyBlcHNnIDQzMjYgcHEgZXN0YXZhIHRyb2NhbmRvIG5vIGdlb3NlcnZlciwgbWFzIG4gc2VpIHBxIGlzc28gYWNvbnRlY2UuCiAgICAgICAgcmV0dXJuICIiIjxDT05URU5UPgogICAgICAgICAgPExheWVyIHF1ZXJ5YWJsZT0iMSIgb3BhcXVlPSIwIj4KICAgICAgICAgIDxOYW1lPkdIOiIiIiArIGxheWVyTmFtZUlEICsgIiIiPC9OYW1lPgogICAgICAgICAgPFRpdGxlPiIiIiArIGxheWVyTmFtZUlEICsgIiIiPC9UaXRsZT4KICAgICAgICAgIDxBYnN0cmFjdD5HSDoiIiIgKyBsYXllck5hbWVJRCArICIiIiBBQlNUUkFDVDwvQWJzdHJhY3Q+CiAgICAgICAgICA8S2V5d29yZExpc3Q+CiAgICAgICAgICAgIDxLZXl3b3JkPiIiIiArIFdNU0NhcGFiaWxpdGllcy5nZXRNYXBLZXl3b3JkKGlzU2hhcGVmaWxlLCBtYXhab29tLCBkTGluaykgKyAiIiI8L0tleXdvcmQ+CiAgICAgICAgICA8L0tleXdvcmRMaXN0PgogICAgICAgICAgPFNSUz5FUFNHOjQzMjY8L1NSUz4KICAgICAgICAgIDxMYXRMb25Cb3VuZGluZ0JveCBtaW54PVwiIiIiICsgc3RyKGxhdE1pblgpICsgIiIiXCIgbWlueT1cIiIiIiArIHN0cihsYXRNaW5ZKSArICIiIlwiIG1heHg9XCIiIiIgKyBzdHIoCiAgICAgICAgICAgIGxhdE1heFgpICsgIiIiXCIgbWF4eT1cIiIiIiArIHN0cihsYXRNYXhZKSArICIiIlwiLz4KICAgICAgICAgIDxCb3VuZGluZ0JveCBTUlM9IkVQU0c6NDMyNiIgbWlueD1cIiIiIiArIHN0cihwcm9qTWluWCkgKyAiIiJcIiBtaW55PVwiIiIiICsgc3RyKAogICAgICAgICAgICBwcm9qTWluWSkgKyAiIiJcIiBtYXh4PVwiIiIiICsgc3RyKHByb2pNYXhYKSArICIiIlwiIG1heHk9XCIiIiIgKyBzdHIocHJvak1heFkpICsgIiIiXCIvPgogICAgICAgICAgPFN0eWxlPgogICAgICAgICAgIDxOYW1lPiIiIiArIGxheWVyQXR0ciArICIiIjwvTmFtZT4KICAgICAgICAgICA8VGl0bGU+IiIiICsgbGF5ZXJBdHRyICsgIiIiPC9UaXRsZT4KICAgICAgICAgICA8QWJzdHJhY3QvPgogICAgICAgICAgIDxMZWdlbmRVUkwgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIj4KICAgICAgICAgICA8Rm9ybWF0PmltYWdlL3BuZzwvRm9ybWF0PgogICAgICAgICAgIDxPbmxpbmVSZXNvdXJjZSB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeGxpbms6dHlwZT0ic2ltcGxlIiB4bGluazpocmVmPSJodHRwczovL21hcHMuY3NyLnVmbWcuYnI6NDQzL2dlb3NlcnZlci93bXM/cmVxdWVzdD1HZXRMZWdlbmRHcmFwaGljJmFtcDtmb3JtYXQ9aW1hZ2UlMkZwbmcmYW1wO3dpZHRoPTIwJmFtcDtoZWlnaHQ9MjAmYW1wO2xheWVyPSIiIiArIGxheWVyTmFtZUlEICsgIiIiXCIvPgogICAgICAgICAgIDwvTGVnZW5kVVJMPgogICAgICAgICAgPC9TdHlsZT4KICAgICAgICA8L0xheWVyPgogICAgICAgIDwvQ09OVEVOVD4KICAgICAgICAiIiIKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0VGlsZVNldERlc2NyaXB0aW9uKGZpbGVOYW1lSWQsIGxhdE1pblgsIGxhdE1pblksIGxhdE1heFgsIGxhdE1heFksIHByb2pNaW5YLCBwcm9qTWluWSwgcHJvak1heFgsIHByb2pNYXhZKToKICAgICAgICAjIDxCb3VuZGluZ0JveCBTUlM9IkVQU0c6NDMyNiIgbWlueD1cIiIiIiArIHN0cihsYXRNaW5YKSArICIiIlwiIG1pbnk9XCIiIiIgKyBzdHIobGF0TWluWSkgKyAiIiJcIiBtYXh4PVwiIiIiICsgc3RyKGxhdE1heFgpICsgIiIiXCIgbWF4eT1cIiIiIiArIHN0cihsYXRNYXhZKSArICIiIlwiLz4KICAgICAgICByZXR1cm4gIiIiPD94bWwgdmVyc2lvbj1cIjEuMFwiIGVuY29kaW5nPVwiVVRGLThcIj8+CiAgICAgICAgPENPTlRFTlQ+CiAgICAgICAgICA8VGlsZVNldD4KICAgICAgICAgICAgPFNSUz5FUFNHOjQzMjY8L1NSUz4KICAgICAgICAgICAgPEJvdW5kaW5nQm94IFNSUz0iRVBTRzo0MzI2IiBtaW54PSItMTgwLjAiIG1pbnk9Ii05MC4wIiBtYXh4PSIwLjAiIG1heHk9IjkwLjAiLz4KICAgICAgICA8UmVzb2x1dGlvbnM+MC43MDMxMjUgMC4zNTE1NjI1IDAuMTc1NzgxMjUgMC4wODc4OTA2MjUgMC4wNDM5NDUzMTI1IDAuMDIxOTcyNjU2MjUgMC4wMTA5ODYzMjgxMjUgMC4wMDU0OTMxNjQwNjI1IDAuMDAyNzQ2NTgyMDMxMjUgMC4wMDEzNzMyOTEwMTU2MjUgNi44NjY0NTUwNzgxMjVFLTQgMy40MzMyMjc1MzkwNjI1RS00IDEuNzE2NjEzNzY5NTMxMjVFLTQgOC41ODMwNjg4NDc2NTYyNUUtNSA0LjI5MTUzNDQyMzgyODEyNUUtNSAyLjE0NTc2NzIxMTkxNDA2MjVFLTUgMS4wNzI4ODM2MDU5NTcwMzEyRS01IDUuMzY0NDE4MDI5Nzg1MTU2RS02IDIuNjgyMjA5MDE0ODkyNTc4RS02IDEuMzQxMTA0NTA3NDQ2Mjg5RS02IDYuNzA1NTIyNTM3MjMxNDQ1RS03IDMuMzUyNzYxMjY4NjE1NzIyN0UtNyA8L1Jlc29sdXRpb25zPgogICAgICAgICAgICA8V2lkdGg+MjU2PC9XaWR0aD4KICAgICAgICAgICAgPEhlaWdodD4yNTY8L0hlaWdodD4KICAgICAgICAgICAgPEZvcm1hdD5pbWFnZS9wbmc8L0Zvcm1hdD4KICAgICAgICAgICAgPExheWVycz5HSDoiIiIgKyBmaWxlTmFtZUlkICsgIiIiPC9MYXllcnM+CiAgICAgICAgICAgIDxTdHlsZXMvPgogICAgICAgICAgPC9UaWxlU2V0PgogICAgICAgICAgPFRpbGVTZXQ+CiAgICAgICAgICAgIDxTUlM+RVBTRzo5MDA5MTM8L1NSUz4KICAgICAgICAgICAgPEJvdW5kaW5nQm94IFNSUz0iRVBTRzo5MDA5MTMiIG1pbng9Ii0yLjAwMzc1MDgzNEU3IiBtaW55PSItMi4wMDM3NTA4MzRFNyIgbWF4eD0iMi4wMDM3NTA4MzRFNyIgbWF4eT0iMi4wMDM3NTA4MzRFNyIvPgogICAgICAgIDxSZXNvbHV0aW9ucz4xNTY1NDMuMDMzOTA2MjUgNzgyNzEuNTE2OTUzMTI1IDM5MTM1Ljc1ODQ3NjU2MjUgMTk1NjcuODc5MjM4MjgxMjUgOTc4My45Mzk2MTkxNDA2MjUgNDg5MS45Njk4MDk1NzAzMTI1IDI0NDUuOTg0OTA0Nzg1MTU2MiAxMjIyLjk5MjQ1MjM5MjU3ODEgNjExLjQ5NjIyNjE5NjI4OTEgMzA1Ljc0ODExMzA5ODE0NDUzIDE1Mi44NzQwNTY1NDkwNzIyNiA3Ni40MzcwMjgyNzQ1MzYxMyAzOC4yMTg1MTQxMzcyNjgwNjYgMTkuMTA5MjU3MDY4NjM0MDMzIDkuNTU0NjI4NTM0MzE3MDE3IDQuNzc3MzE0MjY3MTU4NTA4IDIuMzg4NjU3MTMzNTc5MjU0IDEuMTk0MzI4NTY2Nzg5NjI3IDAuNTk3MTY0MjgzMzk0ODEzNSAwLjI5ODU4MjE0MTY5NzQwNjc3IDAuMTQ5MjkxMDcwODQ4NzAzMzggMC4wNzQ2NDU1MzU0MjQzNTE2OSAwLjAzNzMyMjc2NzcxMjE3NTg0NiAwLjAxODY2MTM4Mzg1NjA4NzkyMyAwLjAwOTMzMDY5MTkyODA0Mzk2MSAwLjAwNDY2NTM0NTk2NDAyMTk4MSAwLjAwMjMzMjY3Mjk4MjAxMDk5MDQgMC4wMDExNjYzMzY0OTEwMDU0OTUyIDUuODMxNjgyNDU1MDI3NDc2RS00IDIuOTE1ODQxMjI3NTEzNzM4RS00IDEuNDU3OTIwNjEzNzU2ODY5RS00IDwvUmVzb2x1dGlvbnM+CiAgICAgICAgICAgIDxXaWR0aD4yNTY8L1dpZHRoPgogICAgICAgICAgICA8SGVpZ2h0PjI1NjwvSGVpZ2h0PgogICAgICAgICAgICA8Rm9ybWF0PmltYWdlL3BuZzwvRm9ybWF0PgogICAgICAgICAgICA8TGF5ZXJzPkdIOiIiIiArIGZpbGVOYW1lSWQgKyAiIiI8L0xheWVycz4KICAgICAgICAgICAgPFN0eWxlcy8+CiAgICAgICAgICA8L1RpbGVTZXQ+CiAgICAgICAgICA8L0NPTlRFTlQ+CiAgICAgICAgIiIiCiAgICAgICAgIyA8Qm91bmRpbmdCb3ggU1JTPSJFUFNHOjkwMDkxMyIgbWlueD1cIiIiIiArIHN0cihwcm9qTWluWCkgKyAiIiJcIiBtaW55PVwiIiIiICsgc3RyKHByb2pNaW5ZKSArICIiIlwiIG1heHg9XCIiIiIgKyBzdHIocHJvak1heFgpICsgIiIiXCIgbWF4eT1cIiIiIiArIHN0cihwcm9qTWF4WSkgKyAiIiJcIi8+CgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldEFsbExheWVycyhjb250ZW50LCBsYXllckF0dHI9JzEnKToKICAgICAgICAjRklYTUUgc2hvdWxkIHVzZSB0aGUgc3R5bGUgbmFtZSB0byBpZGVudGlmeSB0aGUgbGF5ZXIgYXR0cmlidXRlcwogICAgICAgIGRvYyA9IHhtbHRvZGljdC5wYXJzZShjb250ZW50KQogICAgICAgIGFsbExheWVycyA9IFtdCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsYXllckRlZmluaXRpb25zID0gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXQogICAgICAgICAgICBpZiBsYXllckRlZmluaXRpb25zIGlzIG5vdCBOb25lIGFuZCBpc2luc3RhbmNlKGxheWVyRGVmaW5pdGlvbnMsIGxpc3QpIGFuZCBsZW4obGF5ZXJEZWZpbml0aW9ucyk6CiAgICAgICAgICAgICAgICBhbGxMYXllcnMgPSBbY3VyTGF5ZXJbIk5hbWUiXSBmb3IgY3VyTGF5ZXIgaW4gbGF5ZXJEZWZpbml0aW9uc10KICAgICAgICAgICAgZWxpZiBsYXllckRlZmluaXRpb25zIGlzIG5vdCBOb25lIGFuZCBpc2luc3RhbmNlKGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10sIGNvbGxlY3Rpb25zLk9yZGVyZWREaWN0KSBhbmQgbGVuKGxheWVyRGVmaW5pdGlvbnMpOgogICAgICAgICAgICAgICAgYWxsTGF5ZXJzID0gW2xheWVyRGVmaW5pdGlvbnNbIk5hbWUiXV0KICAgICAgICBleGNlcHQgS2V5RXJyb3IgYXMgZToKICAgICAgICAgICAgcGFzcwogICAgICAgIHJldHVybiBhbGxMYXllcnMKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0T3BlcmF0aW9uc0xpc3RGb3JDdXN0b21MYXllcihkb2NMYXllcik6CiAgICAgICAgI0ZJWE1FIE7Do28gZGV2ZXJpYSBtb2RpZmljYXIgbyBpbnB1dCBudW1hIGZ1bmNhbyBkZSBnZXQKICAgICAgICAjRklYTUUgY29kaWdvIGR1cGxpY2FkbwogICAgICAgIGlmIG5vdCAiT3BlcmF0aW9uIiBpbiBkb2NMYXllcjoKICAgICAgICAgICAgZG9jTGF5ZXJbIk9wZXJhdGlvbiJdID0gW10KICAgICAgICBlbGlmIGlzaW5zdGFuY2UoZG9jTGF5ZXJbIk9wZXJhdGlvbiJdLCBjb2xsZWN0aW9ucy5PcmRlcmVkRGljdCk6CiAgICAgICAgICAgIGRvY0xheWVyWyJPcGVyYXRpb24iXSA9IFtkb2NMYXllclsiT3BlcmF0aW9uIl1dCgogICAgICAgIGlmIGxlbihkb2NMYXllclsiT3BlcmF0aW9uIl0pID09IDA6CiAgICAgICAgICAgIHJldHVybiBbXQogICAgICAgIGVsaWYgaXNpbnN0YW5jZShkb2NMYXllclsiT3BlcmF0aW9uIl0sIHN0cik6CiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbihqc29uLmR1bXBzKGRvY0xheWVyKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gW3sndHlwZSc6IG9wZXJhdGlvblsiQHR5cGUiXSwgJ2F0dHJpYnV0ZSc6IG9wZXJhdGlvblsiI3RleHQiXX0gZm9yIG9wZXJhdGlvbiBpbiBkb2NMYXllclsnT3BlcmF0aW9uJ11dCgoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRBbGxDdXN0b21MYXllcnMoY29udGVudCwgbGF5ZXJBdHRyPScxJyk6CiAgICAgICAgZG9jID0geG1sdG9kaWN0LnBhcnNlKGNvbnRlbnQpCiAgICAgICAgYWxsQ3VzdG9tTGF5ZXJzID0gW10KICAgICAgICBpZiAnQ3VzdG9tTGF5ZXInICBpbiBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddOgogICAgICAgICAgICBsYXllckRlZmluaXRpb25zID0gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsnQ3VzdG9tTGF5ZXInXQoKICAgICAgICAgICAgaWYgbGF5ZXJEZWZpbml0aW9ucyBpcyBub3QgTm9uZSBhbmQgaXNpbnN0YW5jZShsYXllckRlZmluaXRpb25zLCBjb2xsZWN0aW9ucy5PcmRlcmVkRGljdCk6CiAgICAgICAgICAgICAgICBsYXllckRlZmluaXRpb25zID0gW2xheWVyRGVmaW5pdGlvbnNdCiAgICAgICAgICAgIGlmIGxheWVyRGVmaW5pdGlvbnMgaXMgbm90IE5vbmUgYW5kIGlzaW5zdGFuY2UobGF5ZXJEZWZpbml0aW9ucywgbGlzdCkgYW5kIGxlbihsYXllckRlZmluaXRpb25zKSA+IDA6CiAgICAgICAgICAgICAgICBmb3IgY3VyTGF5ZXIgaW4gbGF5ZXJEZWZpbml0aW9uczoKICAgICAgICAgICAgICAgICAgICBmb3Igb3BlcmF0aW9uIGluIFdNU0NhcGFiaWxpdGllcy5nZXRPcGVyYXRpb25zTGlzdEZvckN1c3RvbUxheWVyKGN1ckxheWVyKToKICAgICAgICAgICAgICAgICAgICAgICAgYWxsQ3VzdG9tTGF5ZXJzLmFwcGVuZChjdXJMYXllclsiTmFtZSJdICsgIjsiICsgb3BlcmF0aW9uWydhdHRyaWJ1dGUnXSkKICAgICAgICAgICAgICAgICAgICAgICAgI2FsbEN1c3RvbUxheWVycy5hcHBlbmQoY3VyTGF5ZXJbIk5hbWUiXSArICI6IiArIG9wZXJhdGlvblsnYXR0cmlidXRlJ10gKyAiOiIgKyBvcGVyYXRpb25bJ3R5cGUnXSkKICAgICAgICByZXR1cm4gYWxsQ3VzdG9tTGF5ZXJzCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldEN1cnJlbnRDYXBhYmlsaXRpZXNEb2MoZGlyZWN0b3J5KToKICAgICAgICBjYXBhYmlsaXRpZXNQYXRoID0gb3MucGF0aC5qb2luKGRpcmVjdG9yeSwgImdldENhcGFiaWxpdGllcy54bWwiKQogICAgICAgIGlmIG9zLnBhdGguaXNmaWxlKGNhcGFiaWxpdGllc1BhdGgpOgogICAgICAgICAgICB3aXRoIGlvLm9wZW4oY2FwYWJpbGl0aWVzUGF0aCwgbW9kZT0iciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGNhcGFiaWxpdGllc0ZpbGU6CiAgICAgICAgICAgICAgICBjYXBhYmlsaXRpZXNDb250ZW50ID0gY2FwYWJpbGl0aWVzRmlsZS5yZWFkKCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBjYXBhYmlsaXRpZXNDb250ZW50ID0gV01TQ2FwYWJpbGl0aWVzLmdldERlZmF1bHRDYXBhYmlsaXRpZXMoKQogICAgICAgIGRvYyA9IHhtbHRvZGljdC5wYXJzZShjYXBhYmlsaXRpZXNDb250ZW50KQogICAgICAgIHJldHVybiBkb2MKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgc2F2ZUN1cnJlbnRDYXBhYmlsaXRpZXMoZGlyZWN0b3J5LCBkb2MpOgogICAgICAgIGNhcGFiaWxpdGllc1BhdGggPSBvcy5wYXRoLmpvaW4oZGlyZWN0b3J5LCAiZ2V0Q2FwYWJpbGl0aWVzLnhtbCIpCiAgICAgICAgd2l0aCBpby5vcGVuKGNhcGFiaWxpdGllc1BhdGgsIG1vZGU9InciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBjYXBhYmlsaXRpZXNGaWxlOgogICAgICAgICAgICBjYXBhYmlsaXRpZXNGaWxlLndyaXRlKHhtbHRvZGljdC51bnBhcnNlKGRvYywgcHJldHR5PVRydWUpKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRDdXN0b21MYXllckRlZmF1bHREZWZpbml0aW9uKGxheWVyTmFtZSk6CiAgICAgICAgbGF5ZXJOYW1lID0gVVRJTFMubm9ybWFsaXplTmFtZShsYXllck5hbWUpCiAgICAgICAgcmV0dXJuIHhtbHRvZGljdC5wYXJzZSgiIiI8P3htbCB2ZXJzaW9uPVwiMS4wXCIgZW5jb2Rpbmc9XCJVVEYtOFwiPz4KICAgICAgICAgICAgPENPTlRFTlQ+CiAgICAgICAgICAgICAgICA8TmFtZT5HSDoiIiIgKyBsYXllck5hbWUgKyAiIiI8L05hbWU+CiAgICAgICAgICAgICAgICA8VGl0bGU+IiIiK2xheWVyTmFtZSArIiIiPC9UaXRsZT4KICAgICAgICAgICAgPC9DT05URU5UPiIiIilbIkNPTlRFTlQiXQoKICAgICNjdXN0b21Eb2Mgw6kgdW0gRGljdCB2aW5kbyBkbyB4bWx0b2RpY3QuIGxheWVyQXR0ciBlIG9wZXJhdGlvbiBzw6NvIHN0cmluZ3MKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBhZGRPcGVyYXRpb24oY3VzdG9tRG9jLCBsYXllckF0dHIsIG9wZXJhdGlvbik6CiAgICAgICAgbGF5ZXJBdHRyID0gVVRJTFMubm9ybWFsaXplTmFtZShsYXllckF0dHIpCiAgICAgICAgaWYgbm90ICJPcGVyYXRpb24iIGluIGN1c3RvbURvYzoKICAgICAgICAgICAgY3VzdG9tRG9jWyJPcGVyYXRpb24iXSA9IGxpc3QoKQogICAgICAgIGlmIGlzaW5zdGFuY2UoY3VzdG9tRG9jWyJPcGVyYXRpb24iXSwgY29sbGVjdGlvbnMuT3JkZXJlZERpY3QpOgogICAgICAgICAgICBjdXN0b21Eb2NbIk9wZXJhdGlvbiJdID0gW2N1c3RvbURvY1siT3BlcmF0aW9uIl1dCgogICAgICAgIGZvdW5kID0gRmFsc2UKICAgICAgICBmb3IgY3VyT3BlcmF0aW9uRGljdCBpbiBjdXN0b21Eb2NbIk9wZXJhdGlvbiJdOgogICAgICAgICAgICBpZiBub3QgZm91bmQgYW5kICdAdHlwZScgaW4gY3VyT3BlcmF0aW9uRGljdCBhbmQgY3VyT3BlcmF0aW9uRGljdFsnQHR5cGUnXSA9PSBvcGVyYXRpb24gYW5kIGN1ck9wZXJhdGlvbkRpY3RbJyN0ZXh0J10gPT0gbGF5ZXJBdHRyOgogICAgICAgICAgICAgICAgZm91bmQgPSBUcnVlCiAgICAgICAgaWYgbm90IGZvdW5kOgogICAgICAgICAgICBjdXN0b21Eb2NbJ09wZXJhdGlvbiddLmFwcGVuZCh4bWx0b2RpY3QucGFyc2UoIiIiPD94bWwgdmVyc2lvbj1cIjEuMFwiIGVuY29kaW5nPVwiVVRGLThcIj8+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8Q09OVEVOVD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxPcGVyYXRpb24gdHlwZT1cIiIiIiArIG9wZXJhdGlvbiArICIiIlwiPiIiIiArIGxheWVyQXR0ciArICIiIjwvT3BlcmF0aW9uPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9DT05URU5UPiIiIilbIkNPTlRFTlQiXVsiT3BlcmF0aW9uIl0pCiAgICAgICAgcmV0dXJuIGN1c3RvbURvYwoKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgdXBkYXRlQ3VzdG9tWE1MKGRpcmVjdG9yeSwgbGF5ZXJUaXRsZSwgbGF5ZXJBdHRyLCBvcGVyYXRpb24pOgogICAgICAgIGRvYyA9IFdNU0NhcGFiaWxpdGllcy5nZXRDdXJyZW50Q2FwYWJpbGl0aWVzRG9jKGRpcmVjdG9yeSkKICAgICAgICBmaWxlbmFtZSA9IFVUSUxTLm5vcm1hbGl6ZU5hbWUobGF5ZXJUaXRsZSkgICMgbGF5ZXIgTmFtZSBubyBxZ2lzCgogICAgICAgIGlmICdDdXN0b21MYXllcicgaW4gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXToKICAgICAgICAgICAgaWYgdHlwZShkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWyJDdXN0b21MYXllciJdKSBpcyBjb2xsZWN0aW9ucy5PcmRlcmVkRGljdDoKICAgICAgICAgICAgICAgIGN1ckxheWVyID0gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsiQ3VzdG9tTGF5ZXIiXQogICAgICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsiQ3VzdG9tTGF5ZXIiXSA9IFtjdXJMYXllcl0KICAgICAgICBlbHNlOgogICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWydDdXN0b21MYXllciddID0gW10KCiAgICAgICAgY3VyTGF5ZXJEZWZpbml0aW9uID0gTm9uZQogICAgICAgIGlmICdDdXN0b21MYXllcicgaW4gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXToKICAgICAgICAgICAgZm9yIGlMYXllciBpbiByYW5nZShsZW4oZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsiQ3VzdG9tTGF5ZXIiXSkgLSAxLCAtMSwgLTEpOgogICAgICAgICAgICAgICAgY3VyTGF5ZXIgPSBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWyJDdXN0b21MYXllciJdW2lMYXllcl0KICAgICAgICAgICAgICAgIGlmICJOYW1lIiBpbiBjdXJMYXllciBhbmQgZmlsZW5hbWUgaW4gY3VyTGF5ZXJbIk5hbWUiXToKICAgICAgICAgICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWyJDdXN0b21MYXllciJdLnBvcChpTGF5ZXIpCiAgICAgICAgICAgICAgICAgICAgY3VyTGF5ZXJEZWZpbml0aW9uID0gY3VyTGF5ZXIKICAgICAgICAgICAgICAgICAgICAjVE9ETyB2ZXJpZmljYXIgc2UgbsOjbyByZXN0YXJhbSBvdXRyb3MgY29tIG1lc21vIG5vbWUuCiAgICAgICAgaWYgY3VyTGF5ZXJEZWZpbml0aW9uIGlzIE5vbmU6CiAgICAgICAgICAgIGN1ckxheWVyRGVmaW5pdGlvbiA9IFdNU0NhcGFiaWxpdGllcy5nZXRDdXN0b21MYXllckRlZmF1bHREZWZpbml0aW9uKGZpbGVuYW1lKQogICAgICAgIFdNU0NhcGFiaWxpdGllcy5hZGRPcGVyYXRpb24oY3VyTGF5ZXJEZWZpbml0aW9uLCBsYXllckF0dHIsIG9wZXJhdGlvbikKICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWyJDdXN0b21MYXllciJdLmFwcGVuZChjdXJMYXllckRlZmluaXRpb24pCiAgICAgICAgV01TQ2FwYWJpbGl0aWVzLnNhdmVDdXJyZW50Q2FwYWJpbGl0aWVzKGRpcmVjdG9yeSwgZG9jKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBzZXRDYXBhYmlsaXRpZXNEZWZhdWx0TWF4Wm9vbShkaXJlY3RvcnkpOgogICAgICAgIGRvYyA9IFdNU0NhcGFiaWxpdGllcy5nZXRDdXJyZW50Q2FwYWJpbGl0aWVzRG9jKGRpcmVjdG9yeSkKCiAgICAgICAgaWYgJ0xheWVyJyBpbiBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddOgogICAgICAgICAgICBpZiB0eXBlKGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10pIGlzIGNvbGxlY3Rpb25zLk9yZGVyZWREaWN0OgogICAgICAgICAgICAgICAgY3VyTGF5ZXIgPSBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddCiAgICAgICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddID0gW2N1ckxheWVyXQoKICAgICAgICBpZiAnTGF5ZXInIGluIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ106CiAgICAgICAgICAgIGZvciBpTGF5ZXIgaW4gcmFuZ2UobGVuKGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10pIC0gMSwgLTEsIC0xKToKICAgICAgICAgICAgICAgIGN1ckxheWVyID0gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXVtpTGF5ZXJdCiAgICAgICAgICAgICAgICBpZiAiS2V5d29yZExpc3QiIGluIGN1ckxheWVyIGFuZCB0eXBlKGN1ckxheWVyWydLZXl3b3JkTGlzdCddKSBpcyBjb2xsZWN0aW9ucy5PcmRlcmVkRGljdCBhbmQgKCJLZXl3b3JkIiBpbiBjdXJMYXllclsnS2V5d29yZExpc3QnXSkgYW5kIGN1ckxheWVyWydLZXl3b3JkTGlzdCddWydLZXl3b3JkJ10gPT0gJ0dJVEhVQic6CiAgICAgICAgICAgICAgICAgICAgY3VyTGF5ZXJbJ0tleXdvcmRMaXN0J11bJ0tleXdvcmQnXSA9IFdNU0NhcGFiaWxpdGllcy5nZXRNYXBLZXl3b3JkKEZhbHNlLCA4KQogICAgICAgIFdNU0NhcGFiaWxpdGllcy5zYXZlQ3VycmVudENhcGFiaWxpdGllcyhkaXJlY3RvcnksIGRvYykKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgdXBkYXRlWE1MKGRpcmVjdG9yeSwgbGF5ZXJFeHRlbnRzLCBsYXllck1lcmNhdG9yRXh0ZW50cywgaXNTaGFwZWZpbGUsIGxheWVyVGl0bGUsIGxheWVyQXR0ciwgbWF4Wm9vbSwgZG93bmxvYWRMaW5rKToKICAgICAgICBkb2MgPSBXTVNDYXBhYmlsaXRpZXMuZ2V0Q3VycmVudENhcGFiaWxpdGllc0RvYyhkaXJlY3RvcnkpCgogICAgICAgIGZpbGVuYW1lID0gVVRJTFMubm9ybWFsaXplTmFtZShsYXllclRpdGxlKSAjbGF5ZXIgTmFtZSBubyBxZ2lzCgogICAgICAgIGFzc2VydCBpc2luc3RhbmNlKGxheWVyRXh0ZW50cywgV01TQkJveCkgYW5kIGlzaW5zdGFuY2UobGF5ZXJNZXJjYXRvckV4dGVudHMsIFdNU0JCb3gpCgogICAgICAgICMgI2V4dGVudHMsIHByb2plY3Rpb24KICAgICAgICAjIHByb2pNYXhYID0gbGF5ZXIuZXh0ZW50KCkueE1heGltdW0oKQogICAgICAgIHByb2pNYXhYID0gbGF5ZXJFeHRlbnRzLnhNYXhpbXVtKCkKICAgICAgICAjIHByb2pNaW5YID0gbGF5ZXIuZXh0ZW50KCkueE1pbmltdW0oKQogICAgICAgIHByb2pNaW5YID0gbGF5ZXJFeHRlbnRzLnhNaW5pbXVtKCkKICAgICAgICAjIHByb2pNYXhZID0gbGF5ZXIuZXh0ZW50KCkueU1heGltdW0oKQogICAgICAgIHByb2pNYXhZID0gbGF5ZXJFeHRlbnRzLnlNYXhpbXVtKCkKICAgICAgICAjIHByb2pNaW5ZID0gbGF5ZXIuZXh0ZW50KCkueU1pbmltdW0oKQogICAgICAgIHByb2pNaW5ZID0gbGF5ZXJFeHRlbnRzLnlNaW5pbXVtKCkKICAgICAgICAjIGxsRXh0ZW50ID0gVVRJTFMuZ2V0TWFwRXh0ZW50KGxheWVyLCBRZ3NDb29yZGluYXRlUmVmZXJlbmNlU3lzdGVtKCdFUFNHOjQzMjYnKSkKICAgICAgICAjIGxhdE1heFggPSBsbEV4dGVudC54TWF4aW11bSgpCiAgICAgICAgbGF0TWF4WCA9IGxheWVyTWVyY2F0b3JFeHRlbnRzLnhNYXhpbXVtKCkKICAgICAgICAjIGxhdE1pblggPSBsbEV4dGVudC54TWluaW11bSgpCiAgICAgICAgbGF0TWluWCA9IGxheWVyTWVyY2F0b3JFeHRlbnRzLnhNaW5pbXVtKCkKICAgICAgICAjIGxhdE1heFkgPSBsbEV4dGVudC55TWF4aW11bSgpCiAgICAgICAgbGF0TWF4WSA9IGxheWVyTWVyY2F0b3JFeHRlbnRzLnlNYXhpbXVtKCkKICAgICAgICAjIGxhdE1pblkgPSBsbEV4dGVudC55TWluaW11bSgpCiAgICAgICAgbGF0TWluWSA9IGxheWVyTWVyY2F0b3JFeHRlbnRzLnlNaW5pbXVtKCkKICAgICAgICAjaXNTaGFwZWZpbGUgPSAoaXNpbnN0YW5jZShsYXllciwgUWdzVmVjdG9yTGF5ZXIpKQoKCiAgICAgICAgaWYgJ0xheWVyJyBpbiBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddOgogICAgICAgICAgICBpZiB0eXBlKGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10pIGlzIGNvbGxlY3Rpb25zLk9yZGVyZWREaWN0OgogICAgICAgICAgICAgICAgY3VyTGF5ZXIgPSBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddCiAgICAgICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddID0gW2N1ckxheWVyXQoKICAgICAgICBpZiAnTGF5ZXInIGluIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ106CiAgICAgICAgICAgIGZvciBpTGF5ZXIgaW4gcmFuZ2UobGVuKGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10pIC0gMSwgLTEsIC0xKToKICAgICAgICAgICAgICAgIGN1ckxheWVyID0gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXVtpTGF5ZXJdCiAgICAgICAgICAgICAgICBpZiAiTmFtZSIgaW4gY3VyTGF5ZXIgYW5kIGN1ckxheWVyWyJOYW1lIl0gPT0gIkdIOiIgKyBmaWxlbmFtZToKICAgICAgICAgICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddLnBvcChpTGF5ZXIpCgogICAgICAgICNGSVhNRSBPbmUgYXR0cmlidXRlIG9ubHkuIChJcyBhbHdheXMgb3ZlcndyaXRpbmcpCiAgICAgICAgbmV3TGF5ZXJEZXNjcmlwdGlvbiA9IHhtbHRvZGljdC5wYXJzZSgKICAgICAgICAgICAgV01TQ2FwYWJpbGl0aWVzLmdldE1hcERlc2NyaXB0aW9uKGZpbGVuYW1lLCBsYXllckF0dHIsIGxhdE1pblgsIGxhdE1pblksIGxhdE1heFgsIGxhdE1heFksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9qTWluWCwgcHJvak1pblksIHByb2pNYXhYLCBwcm9qTWF4WSwgbWF4Wm9vbSwgaXNTaGFwZWZpbGUsIGRvd25sb2FkTGluaykpWydDT05URU5UJ10KICAgICAgICBpZiAnTGF5ZXInIGluIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ106CiAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10uYXBwZW5kKG5ld0xheWVyRGVzY3JpcHRpb25bJ0xheWVyJ10pCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXSA9IG5ld0xheWVyRGVzY3JpcHRpb24KCiAgICAgICAgbmV3VGlsZVNldERlc2NyaXB0aW9uID0geG1sdG9kaWN0LnBhcnNlKAogICAgICAgICAgICBXTVNDYXBhYmlsaXRpZXMuZ2V0VGlsZVNldERlc2NyaXB0aW9uKGZpbGVuYW1lLCBsYXRNaW5YLCBsYXRNaW5ZLCBsYXRNYXhYLCBsYXRNYXhZLCBwcm9qTWluWCwgcHJvak1pblksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvak1heFgsIHByb2pNYXhZKSlbJ0NPTlRFTlQnXQoKICAgICAgICBpZiBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddIGlzIG5vdCBOb25lIGFuZCAnVGlsZVNldCcgaW4gXAogICAgICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXToKICAgICAgICAgICAgaWYgdHlwZShkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWwogICAgICAgICAgICAgICAgICAgICAgICAnVGlsZVNldCddKSBpcyBjb2xsZWN0aW9ucy5PcmRlcmVkRGljdDoKICAgICAgICAgICAgICAgIGN1clRpbGVTZXQgPSBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWydUaWxlU2V0J10KICAgICAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bJ1RpbGVTZXQnXSA9IFsKICAgICAgICAgICAgICAgICAgICBjdXJUaWxlU2V0XSAgIyBUcmFuc2Zvcm1zIGludG8gYSBsaXN0CgogICAgICAgIGlmIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ10gaXMgbm90IE5vbmUgYW5kICdUaWxlU2V0JyBpbiBcCiAgICAgICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddOgogICAgICAgICAgICBmb3IgaVRpbGVTZXQgaW4gcmFuZ2UoCiAgICAgICAgICAgICAgICAgICAgbGVuKGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bJ1RpbGVTZXQnXSkgLSAxLAogICAgICAgICAgICAgICAgICAgIC0xLCAtMSk6CiAgICAgICAgICAgICAgICBjdXJUaWxlU2V0ID0gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsnVGlsZVNldCddW2lUaWxlU2V0XQogICAgICAgICAgICAgICAgaWYgIkxheWVycyIgaW4gY3VyVGlsZVNldCBhbmQgY3VyVGlsZVNldFsiTGF5ZXJzIl0gPT0gIkdIOiIgKyBmaWxlbmFtZToKICAgICAgICAgICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWydUaWxlU2V0J10ucG9wKGlUaWxlU2V0KQogICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWydUaWxlU2V0J10gKz0gbmV3VGlsZVNldERlc2NyaXB0aW9uWwogICAgICAgICAgICAgICAgJ1RpbGVTZXQnXSAgIyBEb2lzIGVsZW1lbnRvcyBjIG1lc21hIGNoYXZlIHJlcHJlc2VudGEgY29tIGxpc3RhCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXSA9IG5ld1RpbGVTZXREZXNjcmlwdGlvbgogICAgICAgIFdNU0NhcGFiaWxpdGllcy5zYXZlQ3VycmVudENhcGFiaWxpdGllcyhkaXJlY3RvcnksIGRvYykKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgd3JpdGVfZGVzY3JpcHRpb24oZGlyZWN0b3J5LCBsYXllclRpdGxlLCBsYXllckF0dHIsIGNlbGxUeXBlTmFtZSwgbnVsbFZhbHVlLCBvcGVyYXRpb24pOgogICAgICAgIGxheWVyVGl0bGUgPSBVVElMUy5ub3JtYWxpemVOYW1lKGxheWVyVGl0bGUpCiAgICAgICAgY2VsbFR5cGVOYW1lID0gVVRJTFMubm9ybWFsaXplTmFtZShjZWxsVHlwZU5hbWUpCiAgICAgICAgZmlsZWNzdiA9ICJkZXNjcmlwdGlvbi5jc3YiCiAgICAgICAgY3N2UGF0aCA9IG9zLnBhdGguam9pbihkaXJlY3RvcnksIGZpbGVjc3YpCiAgICAgICAganNvblBhdGggPSBvcy5wYXRoLmpvaW4oZGlyZWN0b3J5LCAiZGVzY3JpcHRpb24uanNvbiIpCiAgICAgICAgaWYgb3MucGF0aC5pc2ZpbGUoY3N2UGF0aCk6CiAgICAgICAgICAgIGNzdkZpbGUgPSBvcGVuKGNzdlBhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikKICAgICAgICBlbHNlOgogICAgICAgICAgICBjc3ZGaWxlID0gaW8uU3RyaW5nSU8oIktleSosIGNlbGwsIG51bGwsIG9wZXJhdGlvbiwgYXR0cixcbi05OTk5LCBcIlwiLCAtMSwgXCJcIiwgbmVuaHVtYSwgIikKCiAgICAgICAgY3N2X3JlYWRlciA9IGNzdi5EaWN0UmVhZGVyKGNzdkZpbGUsIGRlbGltaXRlcj0nLCcpCiAgICAgICAgbGluZV9jb3VudCA9IDAKICAgICAgICBlbGVtZW50cyA9IFtjZWxsVHlwZU5hbWUsIHN0cihudWxsVmFsdWUpLCBvcGVyYXRpb24sIGxheWVyQXR0cl0KICAgICAgICBmb3Igcm93IGluIGNzdl9yZWFkZXI6CiAgICAgICAgICAgIGN1ckVudHJ5ID0gewogICAgICAgICAgICAgICAgJ2NlbGxUeXBlJzogcm93WycgY2VsbCddLnN0cmlwKCksCiAgICAgICAgICAgICAgICAnbnVsbFZhbHVlJzogcm93WycgbnVsbCddLnN0cmlwKCksCiAgICAgICAgICAgICAgICAnb3BlcmF0aW9uJzogcm93Wycgb3BlcmF0aW9uJ10uc3RyaXAoKSwKICAgICAgICAgICAgICAgICdhdHRyaWJ1dGUnOiByb3dbJyBhdHRyJ10uc3RyaXAoKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIGxpbmVfY291bnQgPiAwIGFuZCBjdXJFbnRyeVsnb3BlcmF0aW9uJ10gIT0gb3BlcmF0aW9uIGFuZCBjdXJFbnRyeVsnYXR0cmlidXRlJ10gIT0gbGF5ZXJBdHRyOgogICAgICAgICAgICAgICAgIyBLZXkgKiwgY2VsbCwgbnVsbCwgb3BlcmF0aW9uLCBhdHRyLAogICAgICAgICAgICAgICAgZWxlbWVudHMuYXBwZW5kKGN1ckVudHJ5WydjZWxsVHlwZSddKQogICAgICAgICAgICAgICAgZWxlbWVudHMuYXBwZW5kKGN1ckVudHJ5WydudWxsVmFsdWUnXSkKICAgICAgICAgICAgICAgIGVsZW1lbnRzLmFwcGVuZChjdXJFbnRyeVsnb3BlcmF0aW9uJ10pCiAgICAgICAgICAgICAgICBlbGVtZW50cy5hcHBlbmQoY3VyRW50cnlbJ2F0dHJpYnV0ZSddKQogICAgICAgICAgICBsaW5lX2NvdW50ICs9IDEKICAgICAgICB3aXRoIG9wZW4oanNvblBhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMganNvbkZpbGU6CiAgICAgICAgICAgIGpzb25GaWxlLndyaXRlKGpzb24uZHVtcHMoZWxlbWVudHMpKQogICAgICAgIGNzdkZpbGUuY2xvc2UoKQoKY2xhc3MgV01TQkJveCgpOgogICAgeE1heCA9IE5vbmUKICAgIGRlZiB4TWF4aW11bShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi54TWF4CgogICAgeE1pbiA9IE5vbmUKICAgIGRlZiB4TWluaW11bShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi54TWluCgogICAgeU1heCA9IE5vbmUKICAgIGRlZiB5TWF4aW11bShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi55TWF4CgogICAgeU1pbiA9IE5vbmUKICAgIGRlZiB5TWluaW11bShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi55TWluCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHhNYXgsIHhNaW4sIHlNYXgsIHlNaW4pOgogICAgICAgIHNlbGYueE1heCA9IHhNYXgKICAgICAgICBzZWxmLnhNaW4gPSB4TWluCiAgICAgICAgc2VsZi55TWF4ID0geU1heAogICAgICAgIHNlbGYueU1pbiA9IHlNaW4KCgpkZWYgY2hlY2tHaXRFeGVjdXRhYmxlKGdpdEV4ZSk6CiAgICBpZiBub3QgZ2l0RXhlIG9yIG5vdCBvcy5wYXRoLmlzZmlsZShnaXRFeGUpOgogICAgICAgIFFNZXNzYWdlQm94LmVycm9yKCJTZWxlY3QgeW91ciBnaXQgZXhlY3V0YWJsZSBwcm9ncmFtLlxuIiArIHN0cigKICAgICAgICAgICAgZ2l0RXhlKSArICJcbkl0IGNhbiBiZSBkb3dubG9hZGFibGUgYXQ6IGh0dHBzOi8vZ2l0LXNjbS5jb20vZG93bmxvYWRzIikKICAgICAgICBleGl0KDEpCgpkZWYgd3JpdGVMZWdlbmRKc29uKG1hcERpciwgbGVnZW5kT2JqKToKICAgIGNvbnRlbnQgPSBbXQogICAgZm9yIGxlZ2VuZCBpbiBsZWdlbmRPYmo6CiAgICAgICAgY29udGVudC5hcHBlbmQoeyJjb2xvciI6IFtsZWdlbmQucmVkLCBsZWdlbmQuZ3JlZW4sIGxlZ2VuZC5ibHVlXSwgInRpdGxlIjogbGVnZW5kLmNhdGVnb3J5TmFtZX0pCiAgICBqc29uRmlsZSA9IFBhdGgob3MucGF0aC5qb2luKG1hcERpciwgImxlZ2VuZC5qc29uIikpCiAgICBqc29uRmlsZS53cml0ZV90ZXh0KGpzb24uZHVtcHMoY29udGVudCksIGVuY29kaW5nPSJ1dGYtOCIpCgpkZWYgZ2V0TGVnZW5kRnJvbVBhdGgoc2xkUGF0aCk6CiAgICByZXR1cm4gcmVhZExlZ2VuZChzbGRQYXRoKQoKZGVmIHB1Ymxpc2hNYXBzKGdpdEV4ZSwgZ2hVc2VyLCBnaFBhc3N3b3JkLCBtdXN0QXNrVXNlciwgZ2l0UmVwb3NpdG9yeSwgb3V0cHV0RGlyLCBpbnB1dF9maWxlLCBsYXllckF0dHIsIG9wZXJhdGlvbiwgbWF4X3pvb20sIGRvd25sb2FkTGluaywgY2VsbFR5cGUsIG51bGxWYWx1ZSwgb3BlbkluQnJvd3NlciwgbGVnZW5kT2JqLCBmaWxlbmFtZVRpdGxlKToKICAgIGdpdEV4ZSA9IGdpdEV4ZSBpZiBvcy5wYXRoLmlzZmlsZShnaXRFeGUpIGVsc2UgVVRJTFMud2hpY2goImdpdC5leGUiKSAgIyBEYW5pbG8gdGVzdGFyIHFuZCBuw6NvIGFjaGEgbyBnaXQuZXhlCiAgICBmb3VuZEdpdCA9ICcnCiAgICBnaXRFeGUgPSBHaXRIdWIuZmluZEdpdEV4ZShnaXRFeGUsIGZvdW5kR2l0LCBtdXN0QXNrVXNlcikKICAgIGNoZWNrR2l0RXhlY3V0YWJsZShnaXRFeGUpCiAgICBGZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkdpdCBleGVjdXRhYmxlIHBhdGggZm91bmQ6ICIgKyBnaXRFeGUpCiAgICBnaFVzZXIsIGdoUGFzc3dvcmQgPSBHaXRIdWIuZ2V0R2l0Q3JlZGVudGlhbHMoZ2hVc2VyLCBnaFBhc3N3b3JkLCBtdXN0QXNrVXNlcikKICAgIGlmIGdoVXNlciBpcyBOb25lIG9yIGdoUGFzc3dvcmQgaXMgTm9uZToKICAgICAgICBRTWVzc2FnZUJveC5lcnJvcigiRXJyb3I6IEdpdGh1YiBjcmVkZW50aWFscyBmYWlsZWQgdG8gYXV0aGVudGljYXRlLiIpCiAgICAgICAgZXhpdCgxKQogICAgRmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJBdXRoZW50aWNhdGlvbiBDb25maXJtZWQ6ICIgKyBnaXRFeGUpCgogICAgaWYgbm90IEdpdEh1Yi5leGlzdHNSZXBvc2l0b3J5KGdoVXNlciwgZ2l0UmVwb3NpdG9yeSkgYW5kIG5vdCBHaXRIdWIuY3JlYXRlUmVwbyhnaXRSZXBvc2l0b3J5LCBnaFVzZXIsIGdoUGFzc3dvcmQsIEZlZWRiYWNrKCkpOgogICAgICAgIFFNZXNzYWdlQm94LmVycm9yKAogICAgICAgICAgICAiRXJyb3I6IEZhaWxlZCB0byBjcmVhdGUgdGhlIHJlcG9zaXRvcnkgIiArIGdpdFJlcG9zaXRvcnkgKyAiLlxuUGxlYXNlIGNyZWF0ZSBhIG9uZSBhdDogaHR0cHM6Ly9naXRodWIuY29tL25ldyIpCiAgICAgICAgZXhpdCgxKQoKICAgIEdpdEh1Yi5wcmVwYXJlRW52aXJvbm1lbnQoZ2l0RXhlKQogICAgaWYgbm90IEdpdEh1Yi5pc09wdGlvbnNPayhvdXRwdXREaXIsIGdoVXNlciwgZ2l0UmVwb3NpdG9yeSwgRmVlZGJhY2soKSwgZ2hQYXNzd29yZCwgbXVzdEFza1VzZXIpOgogICAgICAgIFFNZXNzYWdlQm94LmVycm9yKCJFcnJvcjogQ2FuY2VsaW5nIHRoZSBleGVjdXRpb24sIHBsZWFzZSBzZWxlY3QgYW5vdGhlciBvdXRwdXQgZm9sZGVyLiIpCiAgICAgICAgZXhpdCgxKQoKICAgICMgZmlsZU5hbWUgPSBvcy5wYXRoLmJhc2VuYW1lKGlucHV0X2ZpbGUpCiAgICAjIGZpbGVOYW1lV2l0aG91dEV4dCA9IG9zLnBhdGguc3BsaXRleHQoZmlsZU5hbWUpWzBdCiAgICBsYXllclRpdGxlID0gVVRJTFMubm9ybWFsaXplTmFtZShmaWxlbmFtZVRpdGxlKQogICAgbWFwRGlyID0gb3MucGF0aC5qb2luKG91dHB1dERpciwgbGF5ZXJUaXRsZSwgbGF5ZXJBdHRyLCBvcGVyYXRpb24pCiAgICBkZXNjcmlwdGlvbkRpciA9IG9zLnBhdGguam9pbihvdXRwdXREaXIsIGxheWVyVGl0bGUsIGxheWVyQXR0cikKCiAgICBnZW5lcmF0ZVRpbGVGb3JNYXAoaW5wdXRfZmlsZSwgbWFwRGlyLCBtYXhfem9vbSwgcmVzdW1lPUZhbHNlLCBsZWdlbmRPYmo9bGVnZW5kT2JqKSAjcHJvY2Vzc2FyIG9zIHRpbGVzCiAgICBXTVNDYXBhYmlsaXRpZXMud3JpdGVfZGVzY3JpcHRpb24oZGVzY3JpcHRpb25EaXIsIGxheWVyVGl0bGUsIGxheWVyQXR0ciwgY2VsbFR5cGUsIG51bGxWYWx1ZSwgb3BlcmF0aW9uKQogICAgd3JpdGVMZWdlbmRKc29uKG1hcERpciwgbGVnZW5kT2JqKQogICAgbGF5ZXJFeHRlbnRzID0gV01TQkJveCgqR0RBTF9VVElMUy5nZXRFeHRlbnQoaW5wdXRfZmlsZSkpCiAgICBsYXllck1lcmNhdG9yRXh0ZW50cyA9IFdNU0JCb3goKkdEQUxfVVRJTFMuZ2V0RXh0ZW50KGlucHV0X2ZpbGUsIDQzMjYpKQogICAgV01TQ2FwYWJpbGl0aWVzLnVwZGF0ZVhNTChvdXRwdXREaXIsIGxheWVyRXh0ZW50cywgbGF5ZXJNZXJjYXRvckV4dGVudHMsIEZhbHNlLCBsYXllclRpdGxlLCBsYXllckF0dHIsIG1heF96b29tLCBkb3dubG9hZExpbmspCiAgICBHaXRIdWIucHVibGlzaFRpbGVzVG9HaXRIdWIob3V0cHV0RGlyLCBnaFVzZXIsIGdpdFJlcG9zaXRvcnksIEZlZWRiYWNrKCksIHZlcnNpb24sIGdoUGFzc3dvcmQpCiAgICBpZiBvcGVuSW5Ccm93c2VyOgogICAgICAgIHN0b3JlVXJsID0gR2l0SHViLmdldEdpdFVybChnaFVzZXIsIGdpdFJlcG9zaXRvcnkpCiAgICAgICAgY3VyTWFwc1VybCA9ICJodHRwczovL21hcHMuY3NyLnVmbWcuYnIvY2FsY3VsYXRvci8/cXVlcnlpZD0xNTImc3RvcmV1cmw9IiArIHN0b3JlVXJsICsgIi8mcmVtb3RlbWFwPSIgKyAiR0g6IiArIGxheWVyVGl0bGUgKyAiOyIgKyBsYXllckF0dHIKICAgICAgICB3ZWJicm93c2VyLm9wZW5fbmV3KGN1ck1hcHNVcmwpCiAgICAjICNHZXJhIFRodW1ibmFpbD8KCmN1clVzZXIgPSBOb25lCmdoUGFzc3dvcmQgPSBOb25lCm11c3RBc2tVc2VyID0gRmFsc2UKZ2l0RXhlID0gJycKbGF5ZXJBdHRyID0gJzEnCm9wZXJhdGlvbiA9ICdyZ2JhJwpkb3dubG9hZExpbmsgPSBOb25lCmNlbGxUeXBlID0gJ2ludDMyJwpudWxsVmFsdWUgPSAtMTI4Cm9wZW5JbkJyb3dzZXIgPSBUcnVlCgoKaWYgaXNEaW5hbWljYToKICAgIHByaW50KGpzb24uZHVtcHMoZGluYW1pY2EuaW5wdXRzKSkKICAgIG1heF96b29tID0gaW50KHJvdW5kKGRpbmFtaWNhLmlucHV0c1sidjEiXSkpICAjIDcKICAgIGdpdFJlcG9zaXRvcnkgPSBkaW5hbWljYS5pbnB1dHNbInMyIl0gICMgJ01hcHBpYV9FeGFtcGxlX3A2JwogICAgb3V0cHV0RGlyID0gZGluYW1pY2EuaW5wdXRzWyJzMyJdICsgIlxcIiAgIyAnQzpcXFVzZXJzXFxEYW5pbG9cXEFwcERhdGFcXExvY2FsXFxUZW1wXFxvdXRwdXREaXJcXCcKICAgICNzbGRQYXRoID0gZGluYW1pY2EuaW5wdXRzWyJzNCJdICAjICdJOlxcRGFuaWxvXFxUcmFtcG9cXGRhdGFfZGlyXFxkYXRhXFxsYXVyZWxcXGxhbmRfdXNlXzE5OTJfMjAxNVxcbGFuZF91c2VfMTk5Ml8yMDE1Xzcuc2xkJwogICAgcmVhbEZpbGVOYW1lID0gZGluYW1pY2EuaW5wdXRzWyJzNCJdCiAgICBpbnB1dF9maWxlID0gZGluYW1pY2EuaW5wdXRzWyJzMSJdICAjICJGOlxcRGFuaWxvXFxUcmFtcG9cXGRhdGFfZGlyXFxkYXRhXFx0ZXN0ZVxcaXlpZWxkX3J1YmJlcjIudGlmIiAjaXlpZWxkX3J1YmJlci50aWYiICMiRjpcXERhbmlsb1xcVHJhbXBvXFxkYXRhX2RpclxcZGF0YVxcdGVzdGVcXGJ5aWVsZF9ydWJiZXIudGlmIiAjIkY6XFxEYW5pbG9cXFRyYW1wb1xcZGF0YV9kaXJcXGRhdGFcXHJlbWFuZXNjZW50ZXNfZmxvcmVzdGFpc19kZXNtYXRhbWVudG9cXGJyYXNpbFxccGVyZGFfY29iZXJ0dXJhX3ZlZ2V0YWxfYW5vX2hhbnNlblxcbG9zc3llYXIudnJ0IiMiRjpcXERhbmlsb1xcVHJhbXBvXFxkYXRhX2RpclxcZGF0YVxccmVtYW5lc2NlbnRlc19mbG9yZXN0YWlzX2Rlc21hdGFtZW50b1xcYnJhc2lsXFxwZXJkYV9jb2JlcnR1cmFfdmVnZXRhbF9hbm9faGFuc2VuXFxsb3NzeWVhci50aWYiICMiRjpcXERhbmlsb1xcVHJhbXBvXFxkYXRhX2RpclxcZGF0YVxccmVtYW5lc2NlbnRlc19mbG9yZXN0YWlzX2Rlc21hdGFtZW50b1xcYnJhc2lsXFxwcm9kZXNcXHByb2Rlcy52cnQiICMiRjpcXERhbmlsb1xcVHJhbXBvXFxkYXRhX2RpclxcZGF0YVxccmVtYW5lc2NlbnRlc19mbG9yZXN0YWlzX2Rlc21hdGFtZW50b1xcYnJhc2lsXFxwZXJkYV9jb2JlcnR1cmFfdmVnZXRhbF9hbm9faGFuc2VuXFxsb3NzeWVhci50aWYiCiAgICBjc3ZJbnB1dCA9IGRpbmFtaWNhLmlucHV0c1sndDEnXQogICAgbGVnZW5kT2JqID0gcHJlcGFyZUxlZ2VuZChjc3ZJbnB1dCkKICAgIHByaW50KCJpc0RpbmFtaWNhIikKZWxzZToKICAgIGdpdFJlcG9zaXRvcnkgPSAnTWFwcGlhX0V4YW1wbGVfcDYnCiAgICBtYXhfem9vbSA9IDYKICAgIG91dHB1dERpciA9ICdDOlxcVXNlcnNcXERhbmlsb1xcQXBwRGF0YVxcTG9jYWxcXFRlbXBcXG91dHB1dERpclxcJwogICAgaW5wdXRfZmlsZSA9ICJGOlxcRGFuaWxvXFxUcmFtcG9cXGRhdGFfZGlyXFxkYXRhXFx0ZXN0ZVxcaXlpZWxkX3J1YmJlcjIudGlmIiAgIyBpeWllbGRfcnViYmVyLnRpZiIgIyJGOlxcRGFuaWxvXFxUcmFtcG9cXGRhdGFfZGlyXFxkYXRhXFx0ZXN0ZVxcYnlpZWxkX3J1YmJlci50aWYiICMiRjpcXERhbmlsb1xcVHJhbXBvXFxkYXRhX2RpclxcZGF0YVxccmVtYW5lc2NlbnRlc19mbG9yZXN0YWlzX2Rlc21hdGFtZW50b1xcYnJhc2lsXFxwZXJkYV9jb2JlcnR1cmFfdmVnZXRhbF9hbm9faGFuc2VuXFxsb3NzeWVhci52cnQiIyJGOlxcRGFuaWxvXFxUcmFtcG9cXGRhdGFfZGlyXFxkYXRhXFxyZW1hbmVzY2VudGVzX2Zsb3Jlc3RhaXNfZGVzbWF0YW1lbnRvXFxicmFzaWxcXHBlcmRhX2NvYmVydHVyYV92ZWdldGFsX2Fub19oYW5zZW5cXGxvc3N5ZWFyLnRpZiIgIyJGOlxcRGFuaWxvXFxUcmFtcG9cXGRhdGFfZGlyXFxkYXRhXFxyZW1hbmVzY2VudGVzX2Zsb3Jlc3RhaXNfZGVzbWF0YW1lbnRvXFxicmFzaWxcXHByb2Rlc1xccHJvZGVzLnZydCIgIyJGOlxcRGFuaWxvXFxUcmFtcG9cXGRhdGFfZGlyXFxkYXRhXFxyZW1hbmVzY2VudGVzX2Zsb3Jlc3RhaXNfZGVzbWF0YW1lbnRvXFxicmFzaWxcXHBlcmRhX2NvYmVydHVyYV92ZWdldGFsX2Fub19oYW5zZW5cXGxvc3N5ZWFyLnRpZiIKICAgIHNsZFBhdGggPSAnSTpcXERhbmlsb1xcVHJhbXBvXFxkYXRhX2RpclxcZGF0YVxcbGF1cmVsXFxsYW5kX3VzZV8xOTkyXzIwMTVcXGxhbmRfdXNlXzE5OTJfMjAxNV83LnNsZCcKICAgIGxlZ2VuZE9iaiA9IGdldExlZ2VuZEZyb21QYXRoKHNsZFBhdGgpCiAgICByZWFsRmlsZU5hbWUgPSAnbGFuZF91c2VfMTk5Ml8yMDE1XzcnCiAgICBwcmludCgiaXNOb3REaW5hbWljYSIpCgojIGlmIF9fbmFtZV9fID09ICdfX21haW5fXyc6CiMgcmVhbEZpbGVOYW1lCnB1Ymxpc2hNYXBzKGdpdEV4ZSwgY3VyVXNlciwgZ2hQYXNzd29yZCwgbXVzdEFza1VzZXIsIGdpdFJlcG9zaXRvcnksIG91dHB1dERpciwgaW5wdXRfZmlsZSwgbGF5ZXJBdHRyLCBvcGVyYXRpb24sIG1heF96b29tLCBkb3dubG9hZExpbmssIGNlbGxUeXBlLCBudWxsVmFsdWUsIG9wZW5JbkJyb3dzZXIsIGxlZ2VuZE9iaiwgcmVhbEZpbGVOYW1lKQoKdHJ5OgogICAgZGluYW1pY2Eub3V0cHV0c1snb3V0J10gPSAxCmV4Y2VwdDoKICAgIHBhc3M=&quot;</inputport>
        <outputport name="result" id="v13" />
        <functor name="NumberString">
            <property key="dff.functor.alias" value="numberString2728" />
            <inputport name="value" peerid="v15" />
            <inputport name="valueNumber">1</inputport>
        </functor>
        <functor name="NumberString">
            <property key="dff.functor.alias" value="numberString2729" />
            <inputport name="value" peerid="v14" />
            <inputport name="valueNumber">2</inputport>
        </functor>
        <functor name="NumberValue">
            <property key="dff.functor.alias" value="numberValue2731" />
            <inputport name="value" peerid="v2" />
            <inputport name="valueNumber">1</inputport>
        </functor>
        <functor name="NumberString">
            <property key="dff.functor.alias" value="numberString2733" />
            <inputport name="value" peerid="v19" />
            <inputport name="valueNumber">3</inputport>
        </functor>
        <functor name="NumberTable">
            <property key="dff.functor.alias" value="numberTable2737" />
            <inputport name="table" peerid="v16" />
            <inputport name="tableNumber">1</inputport>
        </functor>
        <functor name="NumberString">
            <property key="dff.functor.alias" value="numberString2743" />
            <inputport name="value" peerid="v4" />
            <inputport name="valueNumber">4</inputport>
        </functor>
    </containerfunctor>
    <containerfunctor name="Group">
        <property key="dff.functor.alias" value="group2736" />
        <inputport name="sequenceInput">.none</inputport>
        <functor name="String">
            <property key="dff.functor.alias" value="gitRepository" />
            <property key="dff.functor.comment" value="Value or constant representing string." />
            <property key="submodel.in.constant.advanced" value="yes" />
            <property key="submodel.in.constant.description" value="Value or constant representing string." />
            <property key="submodel.in.constant.name" value="gitRepositoryName" />
            <property key="submodel.in.constant.optional" value="yes" />
            <property key="submodel.in.constant.order" value="5" />
            <inputport name="constant">$&quot;(Mappia_Dinamica)&quot;</inputport>
            <outputport name="object" id="v14" />
        </functor>
        <functor name="String">
            <property key="dff.functor.alias" value="input_file" />
            <inputport name="constant" peerid="v12" />
            <outputport name="object" id="v15" />
        </functor>
        <functor name="Table">
            <property key="dff.functor.alias" value="sldCsv" />
            <inputport name="constant" peerid="v5" />
            <outputport name="object" id="v16" />
        </functor>
    </containerfunctor>
    <containerfunctor name="Group">
        <property key="dff.functor.alias" value="verifyInputs" />
        <inputport name="sequenceInput">.none</inputport>
        <functor name="Table">
            <property key="dff.functor.alias" value="Raster Palette Csv" />
            <property key="dff.functor.comment" value='A CSV with the columns:&#x0A;&quot;Category*, From, To, Category_Name, red, green, blue, &quot;' />
            <property key="dff.functor.extendedcomment" value="EX:&#x0A;Category*, From, To, Category_Name, red, green, blue,&#x0A;0, -99, -99, Non-forest, 178, 178, 178,&#x0A;1, 0, 1.0, Forest, 0, 0, 255,&#x0A;2, 1.01, 2.00, River, 51, 194, 255," />
            <property key="submodel.in.constant.advanced" value="yes" />
            <property key="submodel.in.constant.description" value='A CSV with the columns:&#x0A;&quot;Category*, From, To, Category_Name, red, green, blue, &quot;' />
            <property key="submodel.in.constant.name" value="rasterPaletteCsv" />
            <property key="submodel.in.constant.optional" value="yes" />
            <property key="submodel.in.constant.order" value="3" />
            <inputport name="constant">[&#x0A;    &quot;Category*&quot;, &quot;From&quot;, &quot;To&quot;, &quot;Category_Name#str&quot;, &quot;red&quot;, &quot;green&quot;, &quot;blue&quot;, &#x0A;]</inputport>
            <outputport name="object" id="v17" />
        </functor>
        <functor name="ExtractStructNumber">
            <property key="dff.functor.alias" value="isCsvValid" />
            <inputport name="struct" peerid="v22" />
            <inputport name="name">$&quot;(result)&quot;</inputport>
            <outputport name="number" id="v18" />
        </functor>
        <functor name="String">
            <property key="dff.functor.alias" value="outputDir" />
            <property key="dff.functor.comment" value="A Directory EMPTY or With a repository already.&#x0A;The directory to save the publishing tiles.&#x0A;* Only use the same directory when using the same &apos;GitRepository&apos;.&#x0A;* On new repository please use a empty folder." />
            <property key="submodel.in.constant.advanced" value="no" />
            <property key="submodel.in.constant.description" value="A Directory EMPTY or With a repository already.&#x0A;The directory to save the publishing tiles.&#x0A;* Only use the same directory when using the same &apos;GitRepository&apos;.&#x0A;* On new repository please use a empty folder." />
            <property key="submodel.in.constant.name" value="outputDir" />
            <property key="submodel.in.constant.optional" value="no" />
            <property key="submodel.in.constant.order" value="2" />
            <outputport name="object" id="v19" />
        </functor>
        <functor name="ExtractStructNumber">
            <property key="dff.functor.alias" value="extractStructNumber3616" />
            <inputport name="struct" peerid="v23" />
            <inputport name="name">$&quot;(isdir)&quot;</inputport>
            <outputport name="number" id="v20" />
        </functor>
        <functor name="ExtractStructNumber">
            <property key="dff.functor.alias" value="isEmpty" />
            <inputport name="struct" peerid="v22" />
            <inputport name="name">$&quot;(isempty)&quot;</inputport>
            <outputport name="number" id="v21" />
        </functor>
        <containerfunctor name="CalculatePythonExpression">
            <property key="dff.container.collapsed" value="no" />
            <property key="dff.functor.alias" value="calculatePythonExpression3614" />
            <inputport name="expression">&quot;aW1wb3J0IGpzb24KY3N2TGVnZW5kID0gZGluYW1pY2EuaW5wdXRzWyJ0MSJdCgpoZWFkID0gY3N2TGVnZW5kWzBdCnByaW50KGhlYWQpCnJlc3VsdCA9IE5vbmUKIydDYXRlZ29yeScsICdGcm9tJywgJ1RvJywgJ0NhdGVnb3J5X05hbWUnLCAncmVkJywgJ2dyZWVuJywgJ2JsdWUnCmlmICJDYXRlZ29yeSIgbm90IGluIGhlYWQgb3IgIkZyb20iIG5vdCBpbiBoZWFkIG9yICJUbyIgbm90IGluIGhlYWQgb3IgIkNhdGVnb3J5X05hbWUiIG5vdCBpbiBoZWFkIG9yICJyZWQiIG5vdCBpbiBoZWFkIG9yICJncmVlbiIgbm90IGluIGhlYWQgb3IgImJsdWUiIG5vdCBpbiBoZWFkOgoJcHJpbnQoIkVycm9yLCBpbiBSYXN0ZXIgUGFsZXR0ZSBDU1YuIFRoZSB0YWJsZSBtdXN0IGhhdmUgZXhhY3RseSB0aGUgZm9ybWF0IG9mLCBjb2x1bW5zOlxuXG4nQ2F0ZWdvcnkqLCBGcm9tLCBUbywgQ2F0ZWdvcnlfTmFtZSwgcmVkLCBncmVlbiwgYmx1ZSciKQoJcHJpbnQoIllvdSBjYW4gbGVhdmUgaXQgZW1wdHkgdG8gY3JlYXRlIGl0IGF1dG9tYXRpY2FsbHkiKQoJcmVzdWx0ID0gMAplbHNlOgoJcmVzdWx0ID0gMQoJCmRpbmFtaWNhLm91dHB1dHNbJ3Jlc3VsdCddID0gcmVzdWx0CmRpbmFtaWNhLm91dHB1dHNbJ2lzZW1wdHknXSA9IDAgaWYgbGVuKGNzdkxlZ2VuZCkgPiAxIGVsc2UgMQ==&quot;</inputport>
            <outputport name="result" id="v22" />
            <functor name="NumberTable">
                <property key="dff.functor.alias" value="numberTable3615" />
                <inputport name="table" peerid="v17" />
                <inputport name="tableNumber">1</inputport>
            </functor>
        </containerfunctor>
        <containerfunctor name="CalculatePythonExpression">
            <property key="dff.container.collapsed" value="no" />
            <property key="dff.functor.alias" value="calculatePythonExpression4047" />
            <inputport name="expression">&quot;aW1wb3J0IG9zCnRyeToKCW9zLm1ha2VkaXJzKGRpbmFtaWNhLmlucHV0c1siczEiXSwgZXhpc3Rfb2s9VHJ1ZSkKZXhjZXB0OgoJcGFzcwpkaW5hbWljYS5vdXRwdXRzWydpc2RpciddID0gMSBpZiBvcy5wYXRoLmlzZGlyKGRpbmFtaWNhLmlucHV0c1siczEiXSkgZWxzZSAw&quot;</inputport>
            <outputport name="result" id="v23" />
            <functor name="NumberString">
                <property key="dff.functor.alias" value="numberString4049" />
                <inputport name="value" peerid="v19" />
                <inputport name="valueNumber">1</inputport>
            </functor>
        </containerfunctor>
        <containerfunctor name="IfNotThen">
            <property key="dff.functor.alias" value="ifNotThen3619" />
            <inputport name="condition" peerid="v20" />
            <functor name="Exit">
                <property key="dff.functor.alias" value="exit3618" />
                <inputport name="message">$&quot;(Please select a output directory that exists.)&quot;</inputport>
            </functor>
        </containerfunctor>
        <containerfunctor name="IfNotThen">
            <property key="dff.functor.alias" value="ifNotThen43513" />
            <inputport name="condition" peerid="v21" />
            <functor name="Table">
                <property key="dff.functor.alias" value="table41963" />
                <inputport name="constant" peerid="v17" />
                <outputport name="object" id="v24" />
            </functor>
            <containerfunctor name="IfNotThen">
                <property key="dff.functor.alias" value="ifNotThen3619" />
                <inputport name="condition" peerid="v18" />
                <functor name="Exit">
                    <property key="dff.functor.alias" value="exit3618" />
                    <inputport name="message">$&quot;(Error, in Raster Palette CSV. The table must have exactly the format of, columns:\n\n&apos;Category*, From, To, Category_Name, red, green, blue&apos;)&quot;</inputport>
                </functor>
            </containerfunctor>
        </containerfunctor>
    </containerfunctor>
    <containerfunctor name="IfThen">
        <property key="dff.functor.alias" value="ifThen143662" />
        <inputport name="condition" peerid="v21" />
        <functor name="CreateLegendFromQntEntry">
            <property key="dff.functor.alias" value="createLegendFromQntEntry138052" />
            <property key="submodel.in.maximumnumberofcategories.advanced" value="no" />
            <property key="submodel.in.maximumnumberofcategories.description" value="Maximum number of categories in the resulting categorization." />
            <property key="submodel.in.maximumnumberofcategories.name" value="maximumNumberOfCategories" />
            <property key="submodel.in.maximumnumberofcategories.optional" value="yes" />
            <property key="submodel.in.maximumnumberofcategories.order" value="7" />
            <inputport name="inputMap" peerid="v3" />
            <inputport name="MaximumNumberOfCategories">8</inputport>
            <outputport name="categoriesAsCsv" id="v25" />
        </functor>
    </containerfunctor>
</script>
