<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<script>
    <property key="dff.charset" value="windows-1252" />
    <property key="dff.date" value="2020-Jul-21 04:13:21" />
    <property key="dff.version" value="5.1.0.20200628" />
    <property key="submodel.description" value="Pluguin to publish your maps online. (Experimental)&#x0A;windows only for now" />
    <property key="submodel.documentation" value="https://mappia.earth/mappia_publisher/" />
    <property key="submodel.group" value="Web" />
    <property key="submodel.import" value='CreateLegendFromQntEntry { { &quot;inputMap&quot; : Map, &quot;MaximumNumberOfCategories&quot; : PositiveIntegerValue } { } { &quot;categoriesAsCsv&quot; : Table, &quot;generatedCategories&quot; : Categorization } }' />
    <property key="submodel.largeicon" value="iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAHuklEQVR42rVXCVCU5xmGNk0iVmLwBooCixwL7P57sPe9/7H3fR+wB9dyLofVig4ahLCLmhAp5hKNxsQmsWiiBicSDjUHU0OTpk47aae2TUwnbSedSqaxU+n3o2t2WTZCMn4z3+z/v9//fu/zvcfzfpuUtPTxQG4pXyyxB4YU/ta3yBJ1edLKlSuT7udI31xSwFQ6W2TetiNslXMScTcOs9XuFpJQrsQ8zWGmyjHKkFtHhGZ/ZwFDjACV5O9tNC0tLVXpbz9tatkzIfe3X9M3dr5PEStViTZfvmbNeobM3Fe+a+AG7KqfNjTvfpMk0qDf1f6PJLaal2Te4AWRpWqco3FfLGJIuoXW6iGG3DIqNPm7soiMIvDdo9kUDo9n8u2lIcYRibPu2RIuelZkrZo0Bvf8BfMEr+Qx+YVLNf4QMP4K7Gw4AZ5XgY3PbSykbuBqykc5SkcNkD3IUtrdfL33FFdXMQFO+xJFpDWnZRAyxdaa1wVm//Gk5cvXcbTuaRqskfONvsvZhdDGxZnetOlhiSNwEnYGjuLJhovIItVF/Hf16tUrgCdOcXTOPfPDUMKW81F34xWW2rENX8vII5PB6S/ja5BIJSjDLKObiMT132o7P780Gy1vPiu21x6KGMcH7n7c1ZEK4GhdQzyd5zAeJtwYCEmT3Nf2EVWqVkR0SvlKt6Lyp0ORdxJfhQiM/suFTKk0IQBdQ+cY5mn5OIdIzIqWI+VNJwkQSxAlSgYn7Yad9SMyb+srQGcyh8zIi9YRGn0d+IzWAe8H/d3PzaSkpKQvCAB21l0isuEWtsrxThlqrom4GS5v6qPB+uqoT38IibUuXf3O3/l7np9hKW09K9LTV0fvhXlaDxdzUDP+TKBziGWY+TRDYTuore/440/yIVqc8XVZWTkCo28yUn5speMZlsrxOn4ypsYV5OrLW/HkZMqtjSyF45LIWnM4n8bvgp2NR/l6z2NstfN9ibX66TwymzznNXfju6nrc+g0zLgPEmtOEVloGS43BLveAom7NQ4A2DgISmd3tIzEU6Bcreddgcl7UmDynwfJOM5Wux5bl5u7Fl8vYsNOzNs6EClbCNa6uFr3mzx9xRlza/enQnPlGwp/kBfjGfC9JrDjZBwAqSPwWh7E5s8nIrbGOVC779hNrr7iKpEpVkWvg1O55d62gZgiKiBvosvM5z27B/8u97RMkHlyTXTFsJSWeteO/j+Dx4djSAfQ6NSdzE/Op0pEPF35IbJQPcpS2dsEJt9QNpFeyVDaXmUqbEfXZhevm8t0bgyAB+hycwcdNY0XC+QwSai4SEGMDrmvfUrmbRkhsrA5RtywsbiwOnzkZmGZ6G7FJM01FkdgmC6z1IJYXhKYfb8oYiKyCHKRpXogl8LF7tS0gYYaJ2mooa6YL/PK/a2DpXyZmCGzvM1QWHbhJHW7DOXj0QkrdQbGxPaaMwVMqdCy5fEPxbZAz10AoPafVVS2fwJiNji/BOdKyuzfHwFwuzOlpzDllr2AH67om3b9FnhvOLuUlh+tAwCMzdsmuVQgU4E8GwMh+Ny+ff+vMwoKVs2tAMIYtm3tuw7i/fiG7MI4ygThCMcAAJtRYaNf6qj70NzWc42psD6F50sMAF4cAJxKV7DUzh3GYNdnnq6n/wDK8TYfFLGlGqmr4Zc0RO/DWypX6zoNerzjDtMBABWhCIAiGh8CFXMO5MJAAY1fDRjwIA6GatVNQ1uxYUovfILSi5yFgthnUBixEvplD60nENYIjJ5ursHzgdRR3w/CN4i6m5+IxrZMbK+7iiPEX7IhLklkrjoA4voOiP/eMtR4JIfE1LMU9n0A4HmQH4w5MEyJA65teIESQsbAnF1w9mA36F7dxxyduz3iJXX11jdKuJgpxjuauo5TTKWjcp7TlrGUjm3VfS/8m6VyXqGjhiYg+8HdBmSXdtB6ZV8lNP7NvEUNI4131H4stdf/Hr8+xMZZ79kGLhyvRssyiRQCKKuX0YrmaUBEU4DBzkFilW2uIfWqV0Dd8OeLMB6Z/6OEETEkVFtxD8TlR8bmMpJ1S+hvOKfjMeNoXAdoiGGkqAzlwY76brw3EEgsiOt1n6A2qz6ldmHXFzJUcaxptu/C4MIgwsg0VtV6APDKzoV6UbJz+/4pwAPH2RrXFF1mqIrwAFbRcmwzTSCjhOCfgY1uJjql58Xm2Rtfz8zi48mx5xb8Bm6qv0ooKWMt2A1Nrd0XsIrge6mpqWnRcrGtZrxkO7/n21zseTE4O/P1V7PRo388HgQrpL9Vukt0mBZGiuMAlPDVfH1D568kttqjkRLEB9ti+wgo/2cpxr8B8Xwi0P+lhOHq+BsZuDZpAh2XYFfDa0mZmcuAKIXRqL+eyLj3eEtC45Hx1MShxIkZQnnxd4Pc0rXqwPZxma/tzCrQ05k79f9IBAD9uW1W9Uz53Lz2z7/GGPYBcJE1aghdUB8KIWcWzIdHsrIeVdVsuwD44Tfc3eYvF1Nqn3zxpxgAioPOxZTnlwnviBkEQqahsfMDpKvmX/cRwI173tSLt3BooARv3ScAE4v6u0ANwYP32oz3hHZW2K+/O2lh9J4AoBBqWBQAYqfpQaDw8hKo996zF9m/5D+M5DCqAcrnQPl88R0NzwDD45ReTB/Z8/9yI4/haFpiAAAAAABJRU5ErkJggg==" />
    <property key="submodel.name" value="MappiaPreviewMapOnline" />
    <property key="submodel.smallicon" value="iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAC4UlEQVR42mNgQANSxsZcbon5PsEFzZkeicXNtsEJpW5R2RHGDr4iDAQAo3tCQb9bfN5Ju+DECQ7hGdF8MjJCweUd2o6R6V2usTmn/bOq1uu5uXFj08zkGpff4RSVYWblF11sF5TUYBuYaO+VVJZhG5Ya7BSe0WPpE+3sGp1dZx+S0gRyJYpur5SyeSDNILZdcFIFyDUg2jetIsU1NneioWeoqEtEhoNncqGvlVugmG96+VqgGjawZhkZGU6nyLR266CEWsfQRHsr39g8C48IBfuQpCqftIqd1gFxTQ7hKRZBuY3pJu5hwUDvFPllVk4x9wvWAxvgEpXnbxMQbwxi2wQml/uklp6y9InKYdDWZrMLSS0HucY2KDHEJ638rGtMbgdYD9A1UeVd+QwQJydWu0ZmRVoHxFba+SeGm3qEVtgExOVbB8ZH24elVtoGxXtb+kdXmHuG17nF5vo6hqd1OYYmewfmNiwDGxCQVX3YOjAuHhYe5t6RWSDawj/KxTe94iowUFNBfEu/mHxYbDmEpRVHV0+4L66nx83gHJ3daBUcH2zlG1MOdFqSiUtgoU1AbJpVQHymXVhCvUmV32qTVs9Hxi2eT0yavBZaRcQ2A2Ms3SEstRtsnF96ZZBPSqUX2Bbf+EjP5KJr1v4x6Q4NDixADXeNutz+I2OzHs8bJkke6r6p5SVgA0S1tXkCc2oXAgOyxjYo2RsUfSY1vi3GLR7PYZqqNrf/n3xoHtwQ6+rQXZZ+EYbwdOCXWbMcmNJMwH4vCluDbCNI899/f/+DwNRD88FiJt0ef4w6XVeZdnlJgA3QBkYZMNHMtAtJcjNr9nkA02w7IfDv3OPL/n//9QNswNIz6/77zoqHG27Y5bYVkRyNjVl9MyqXWbaGfEf399uv78EG2E0M/I8m9wkjUxg1uZehGzDt8IL/80+s/G/e5/0PTW4vZrb6z8Bo1OlWCpS8j24QEv5l1OW+x6DdQwEAz35TFJ4jlw4AAAAASUVORK5CYII=" />
    <functor name="String">
        <property key="dff.functor.alias" value="expressionNotUsed" />
        <inputport name="constant" peerid="v7" />
    </functor>
    <functor name="LoadLookupTable">
        <property key="dff.functor.alias" value="loadTemporaryFilterTable" />
        <inputport name="filename" peerid="v9" />
        <inputport name="suffixDigits">0</inputport>
        <inputport name="step">.none</inputport>
        <inputport name="workdir">.none</inputport>
        <outputport name="table" id="v1" />
    </functor>
    <functor name="IntegerValue">
        <property key="dff.functor.alias" value="Max Zoom" />
        <property key="dff.functor.comment" value="Max zoom of details." />
        <property key="dff.functor.extendedcomment" value="The maximum detail level.&#x0A;* Each increased zoom double the publication time.&#x0A;* https://wiki.openstreetmap.org/wiki/Zoom_levels" />
        <property key="submodel.in.constant.advanced" value="yes" />
        <property key="submodel.in.constant.description" value="Max zoom of details." />
        <property key="submodel.in.constant.name" value="maxZoom" />
        <property key="submodel.in.constant.optional" value="yes" />
        <property key="submodel.in.constant.order" value="4" />
        <inputport name="constant">5</inputport>
        <outputport name="object" id="v2" />
    </functor>
    <functor name="Map">
        <property key="dff.functor.alias" value="Map To Preview" />
        <property key="dff.functor.comment" value="Map to display online." />
        <property key="submodel.in.constant.advanced" value="no" />
        <property key="submodel.in.constant.description" value="Map to display online." />
        <property key="submodel.in.constant.name" value="mapToPreview" />
        <property key="submodel.in.constant.optional" value="no" />
        <property key="submodel.in.constant.order" value="1" />
        <outputport name="object" id="v3" />
    </functor>
    <functor name="ExtractStructNumber">
        <property key="dff.functor.alias" value="extractStructNumber802" />
        <property key="submodel.out.number.description" value="Returns 1 when finish" />
        <property key="submodel.out.number.name" value="output" />
        <property key="submodel.out.number.order" value="1" />
        <inputport name="struct" peerid="v13" />
        <inputport name="name">$&quot;(out)&quot;</inputport>
    </functor>
    <functor name="String">
        <property key="dff.functor.alias" value="Map Filename Or Title" />
        <property key="dff.functor.comment" value="The title or path for the published map." />
        <property key="submodel.in.constant.advanced" value="no" />
        <property key="submodel.in.constant.description" value="The title or path for the published map." />
        <property key="submodel.in.constant.name" value="mapFilenameOrTitle" />
        <property key="submodel.in.constant.optional" value="yes" />
        <property key="submodel.in.constant.order" value="6" />
        <inputport name="constant">$&quot;(New Dinamica Online Example Map)&quot;</inputport>
        <outputport name="object" id="v4" />
    </functor>
    <functor name="TableJunction">
        <property key="dff.functor.alias" value="tableJunction41962" />
        <inputport name="possibleTable1" peerid="v24" />
        <inputport name="possibleTable2" peerid="v25" />
        <outputport name="table" id="v5" />
    </functor>
    <containerfunctor name="CalculateMap">
        <property key="dff.container.collapsed" value="no" />
        <property key="dff.functor.alias" value="calculateMap2703" />
        <inputport name="expression">[&#x0A;    if isNull(i1) then&#x0A;        null&#x0A;    else &#x0A;        t1[&gt;=i1] ? v1&#x0A;]</inputport>
        <inputport name="cellType">.uint8</inputport>
        <inputport name="nullValue">.default</inputport>
        <inputport name="resultIsSparse">.no</inputport>
        <inputport name="resultFormat">.none</inputport>
        <outputport name="result" id="v6" />
        <functor name="NumberMap">
            <property key="dff.functor.alias" value="numberMap2704" />
            <inputport name="map" peerid="v3" />
            <inputport name="mapNumber">1</inputport>
        </functor>
        <functor name="NumberTable">
            <property key="dff.functor.alias" value="numberTable2716" />
            <inputport name="table" peerid="v1" />
            <inputport name="tableNumber">1</inputport>
        </functor>
        <functor name="NumberValue">
            <property key="dff.functor.alias" value="numberValue36570" />
            <inputport name="value" peerid="v10" />
            <inputport name="valueNumber">1</inputport>
        </functor>
    </containerfunctor>
    <containerfunctor name="Group">
        <property key="dff.functor.alias" value="group2717" />
        <inputport name="sequenceInput">.none</inputport>
        <functor name="ExtractStructString">
            <property key="dff.functor.alias" value="extractStructString2706" />
            <inputport name="struct" peerid="v11" />
            <inputport name="name">$&quot;(exp)&quot;</inputport>
            <outputport name="string" id="v7" />
        </functor>
        <functor name="ExtractStructString">
            <property key="dff.functor.alias" value="extractStructString2706" />
            <inputport name="struct" peerid="v11" />
            <inputport name="name">$&quot;(csv)&quot;</inputport>
            <outputport name="string" id="v8" />
        </functor>
        <functor name="SaveTextFile">
            <property key="dff.functor.alias" value="saveTemporaryFilterTable" />
            <inputport name="text" peerid="v8" />
            <inputport name="filename" peerid="v9" />
            <inputport name="suffixDigits">2</inputport>
            <inputport name="step">.none</inputport>
            <inputport name="workdir">.none</inputport>
        </functor>
        <functor name="GenerateTemporaryFile">
            <property key="dff.functor.alias" value="generateTemporaryFile2708" />
            <inputport name="extension">$&quot;(csv)&quot;</inputport>
            <inputport name="createFile">.no</inputport>
            <outputport name="filename" id="v9" />
        </functor>
        <functor name="ExtractStructNumber">
            <property key="dff.functor.alias" value="maxValue" />
            <property key="dff.functor.comment" value="Last else" />
            <inputport name="struct" peerid="v11" />
            <inputport name="name">$&quot;(max)&quot;</inputport>
            <outputport name="number" id="v10" />
        </functor>
        <containerfunctor name="CalculatePythonExpression">
            <property key="dff.container.collapsed" value="no" />
            <property key="dff.functor.alias" value="calculatePythonExpression2698" />
            <inputport name="expression">&quot;aW1wb3J0IGpzb24KY3N2TGVnZW5kID0gZGluYW1pY2EuaW5wdXRzWyJ0MSJdCgpnZW5Dc3YgPSBbJ0NhdGVnb3J5KiwgVG8sJ10KaGVhZCA9IGNzdkxlZ2VuZFswXQpyZXN1bHQgPSBbXQppRWxtID0gMApmb3IgZWxtIGluIGNzdkxlZ2VuZFsxOl06CgljdXJMaW5lID0gJycKCWlmIGxlbihyZXN1bHQpID09IDA6CgkJY3VyTGluZSA9ICdpZiBpMSA8PSAnICsgc3RyKGVsbVtoZWFkLmluZGV4KCdUbycpXSkgKyAnIHRoZW4gJyArIHN0cihpRWxtKQoJZWxpZiBpRWxtICsgMiA9PSBsZW4oY3N2TGVnZW5kKTogIyArMiDDqSBwcSB0aXJhIG8gaGVhZCBkbyBjc3YKCQljdXJMaW5lID0gJ2Vsc2UgJyArIHN0cihpRWxtKQoJZWxzZToKCQljdXJMaW5lID0gJyBlbHNlIGlmIGkxIDw9ICcgKyBzdHIoZWxtW2hlYWQuaW5kZXgoJ1RvJyldKSArICcgdGhlbiAnICsgc3RyKGlFbG0pCglyZXN1bHQuYXBwZW5kKGN1ckxpbmUpCglnZW5Dc3YuYXBwZW5kKHN0cihlbG1baGVhZC5pbmRleCgnVG8nKV0pICsgIiwgIiArIHN0cihpRWxtKSkKCWlFbG0gPSBpRWxtICsgMQpwcmludChqc29uLmR1bXBzKGNzdkxlZ2VuZCkpCnByaW50KCItLS0tLS0tLS0tLS0tLSIpCnByaW50KCdcbicuam9pbihyZXN1bHQpKQppRWxtID0gaUVsbSAtIDEKZGluYW1pY2Eub3V0cHV0c1snbWF4J10gPSBpRWxtCmRpbmFtaWNhLm91dHB1dHNbJ2V4cCddID0gJ1xuJy5qb2luKHJlc3VsdCkKZGluYW1pY2Eub3V0cHV0c1snY3N2J10gPSAnXG4nLmpvaW4oZ2VuQ3N2KQ==&quot;</inputport>
            <outputport name="result" id="v11" />
            <functor name="NumberTable">
                <property key="dff.functor.alias" value="numberTable2699" />
                <inputport name="table" peerid="v5" />
                <inputport name="tableNumber">1</inputport>
            </functor>
            <functor name="NumberString">
                <property key="dff.functor.alias" value="numberString2709" />
                <inputport name="value" peerid="v9" />
                <inputport name="valueNumber">1</inputport>
            </functor>
        </containerfunctor>
    </containerfunctor>
    <containerfunctor name="Group">
        <property key="dff.functor.alias" value="group2723" />
        <inputport name="sequenceInput">.none</inputport>
        <functor name="SaveMap">
            <property key="dff.functor.alias" value="saveMap2720" />
            <inputport name="map" peerid="v6" />
            <inputport name="filename" peerid="v12" />
            <inputport name="suffixDigits">2</inputport>
            <inputport name="step">.none</inputport>
            <inputport name="useCompression">.yes</inputport>
            <inputport name="workdir">.none</inputport>
            <inputport name="ignoreCostlySparseCategories">.yes</inputport>
        </functor>
        <functor name="GenerateTemporaryFile">
            <property key="dff.functor.alias" value="mapToPublish" />
            <inputport name="extension">$&quot;(tif)&quot;</inputport>
            <inputport name="createFile">.no</inputport>
            <outputport name="filename" id="v12" />
        </functor>
    </containerfunctor>
    <containerfunctor name="CalculatePythonExpression">
        <property key="dff.container.collapsed" value="no" />
        <property key="dff.functor.alias" value="calculatePythonExpression2724" />
        <inputport name="expression">&quot;IyEvdXNyL2Jpbi9weXRob24KIyAtKi0gY29kaW5nOiB1dGYtOCAtKi0KCiMgI0hhY2sgcGFyYSBjb3JyaWdpciBvIHByb2JsZW1hIGNvbSBvIGRlZmF1bHRlbmNvZGluZywgZGVzc2EgbWFuZWlyYSBmdW5jaW9uYSBlbSBxdWFscXVlciBjb21wdXRhZG9yIHF1ZSBwb3NzdWEgbyBlbmNvZGluZyAndXRmLTgnLgojIGltcG9ydCBzeXMKIyByZWxvYWQoc3lzKQojIHN5cy5zZXRkZWZhdWx0ZW5jb2RpbmcoInV0Zi04IikKCnZlcnNpb24gPSAnMC4xJwoKaW1wb3J0IG9zCmltcG9ydCBqc29uCmZyb20gcGF0aGxpYiBpbXBvcnQgUGF0aAppbXBvcnQgd2ViYnJvd3NlcgojIGltcG9ydCBzeXMKIyBpbXBvcnQgaW1wb3J0bGliCiMgIyBpbXBvcnRsaWIucmVsb2FkKHN5cykKIyAjIHN5cy5zZXRkZWZhdWx0ZW5jb2RpbmcoJ1VURjgnKQoKCmlzRGluYW1pY2EgPSBGYWxzZQp0cnk6CiAgICBkaW5hbWljYS5wYWNrYWdlKCJvcyIpCiAgICBpc0RpbmFtaWNhID0gVHJ1ZQpleGNlcHQ6CiAgICBpc0RpbmFtaWNhID0gRmFsc2UKCgp0cnk6CiAgICBmcm9tIG9zZ2VvIGltcG9ydCBvZ3IsIG9zciwgZ2RhbApleGNlcHQ6CiAgICBpbXBvcnQgdGVtcGZpbGUKICAgIGltcG9ydCBzaHV0aWwKCiAgICBpZiBpc0RpbmFtaWNhOgogICAgICAgIHByaW50KCJJbnN0YWxsaW5nIHB5dGhvbiBHREFMIikKICAgICAgICBkaW5hbWljYS5wYWNrYWdlKCJ3aGVlbD09MC4zMy42IiwgTm9uZSwgIndoZWVsIikKICAgICAgICBkaW5hbWljYS5wYWNrYWdlKCJ3Z2V0PT0zLjIiLCBOb25lLCAid2dldCIpCiAgICAgICAgZGlyZWN0b3J5ID0gdGVtcGZpbGUubWtkdGVtcCgpCiAgICAgICAgZ2RhbENvbXBpbGVkRmlsZSA9IG9zLnBhdGguam9pbihkaXJlY3RvcnksICdHREFMLTIuNC4xLWNwMzctY3AzN20td2luX2FtZDY0LndobCcpCiAgICAgICAgd2dldC5kb3dubG9hZCgiaHR0cHM6Ly9naXRodWIuY29tL2FzZml4aWEvcmFzdGVyc3RhdHNfd2hlZWwvcmF3L21hc3Rlci9HREFMLTIuNC4xLWNwMzctY3AzN20td2luX2FtZDY0LndobCIsIGdkYWxDb21waWxlZEZpbGUpCiAgICAgICAgZGluYW1pY2EucGFja2FnZSgiZ2RhbCIsIGdkYWxDb21waWxlZEZpbGUpCiAgICAgICAgb3MucmVtb3ZlKGdkYWxDb21waWxlZEZpbGUpCgpvcy5lbnZpcm9uWydHSVRfUFlUSE9OX1JFRlJFU0gnXSA9ICdxdWlldCcKaWYgaXNEaW5hbWljYToKICAgIGRpbmFtaWNhLnBhY2thZ2UoInJlcXVlc3RzIikKICAgIGRpbmFtaWNhLnBhY2thZ2UoIkdpdFB5dGhvbiIsIE5vbmUsICJnaXQiKQogICAgZGluYW1pY2EucGFja2FnZSgieG1sdG9kaWN0IikKICAgIGRpbmFtaWNhLnBhY2thZ2UoIlBpbGxvdyIsIE5vbmUsICJQSUwiKQoKdHJ5OgogICAgaW1wb3J0IFFNZXNzYWdlQm94CmV4Y2VwdDoKICAgIHBhc3MKCmltcG9ydCB0aHJlYWRpbmcsIHRpbWUsIGN0eXBlcywgY3R5cGVzLndpbnR5cGVzLCBtYXRoCgoKY2xhc3MgUU1lc3NhZ2VCb3goKToKICAgIG1lc3NhZ2VCb3ggPSBjdHlwZXMud2luZGxsLnVzZXIzMi5NZXNzYWdlQm94VwogICAgI3NldFRpbWVyID0gY3R5cGVzLndpbmRsbC51c2VyMzIuU2V0VGltZXJXICMoTlVMTCwgTlVMTCwgaW50KHRpbWVvdXQgKiAxMDAwKSwgTlVMTCkKICAgIElEQUJPUlQgPSAzICNUaGUgQWJvcnQgYnV0dG9uIHdhcyBzZWxlY3RlZC4KICAgIElEQ09OVElOVUUgPSAxMSAjVGhlIENvbnRpbnVlIGJ1dHRvbiB3YXMgc2VsZWN0ZWQuCiAgICBJRFJFVFJZID0gNCAjVGhlIFJldHJ5IGJ1dHRvbiB3YXMgc2VsZWN0ZWQuCiAgICBJRFRSWUFHQUlOID0gMTAgI1RoZSBUcnkgQWdhaW4gYnV0dG9uIHdhcyBzZWxlY3RlZC4KICAgIElEWUVTID0gNiAjVGhlIFllcyBidXR0b24gd2FzIHNlbGVjdGVkLgogICAgWWVzID0gNgogICAgSUROTyA9IDcgI1RoZSBObyBidXR0b24gd2FzIHNlbGVjdGVkLgogICAgTm8gPSA3CiAgICBJRENBTkNFTCA9IDIgI1RoZSBDYW5jZWwgYnV0dG9uIHdhcyBzZWxlY3RlZC4KICAgIENhbmNlbCA9IDIKICAgIElESUdOT1JFID0gNSAjVGhlIElnbm9yZSBidXR0b24gd2FzIHNlbGVjdGVkLgogICAgRGlzY2FyZCA9IDUKICAgIEluZm9ybWF0aW9uID0gNDAKICAgIElET0sgPSAxICNUaGUgT0sgYnV0dG9uIHdhcyBzZWxlY3RlZC4KICAgIE9rID0gMQoKICAgIFRPUF9NT1NUID0gMHg0MDAwMAogICAgTUJfT0sgPSAweDAKICAgIE1CX09LQ1hMID0gMHgwMQogICAgTUJfWUVTTk9DWEwgPSAweDAzCiAgICBNQl9ZRVNOTyA9IDB4MDQKICAgIE1CX0hFTFAgPSAweDQwMDAKICAgIElDT05fRVhMQUlNID0gMHgzMAogICAgSUNPTl9JTkZPID0gMHg0MAogICAgSUNPTl9TVE9QID0gMHgxMAoKICAgIFdNX0NMT1NFID0gMHgwMDEwCgogICAgbWVzc2FnZSA9IE5vbmUKICAgIHRpdGxlID0gTm9uZQogICAgdGltZW91dCA9IDEKICAgIGNhbGxiYWNrID0gTm9uZQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBmaW5kX21lc3NhZ2Vib3godGl0bGUsIHRocmVhZGlkLCBwcm9jZXNzaWQpOgogICAgICAgIGh3bmQgPSBjdHlwZXMud2luZGxsLnVzZXIzMi5GaW5kV2luZG93VyhOb25lLCB0aXRsZSkKICAgICAgICBpZiBod25kOgogICAgICAgICAgICBwID0gY3R5cGVzLndpbnR5cGVzLkRXT1JEKCkKICAgICAgICAgICAgdCA9IGN0eXBlcy53aW5kbGwudXNlcjMyLkdldFdpbmRvd1RocmVhZFByb2Nlc3NJZChod25kLCBjdHlwZXMuYnlyZWYocCkpCiAgICAgICAgICAgIGlmIHAudmFsdWUgPT0gcHJvY2Vzc2lkIGFuZCB0ID09IHRocmVhZGlkOgogICAgICAgICAgICAgICAgcmV0dXJuIGh3bmQKICAgICAgICByZXR1cm4gMAoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBzZXRDYWxsYmFjayhjYWxsYmFjayk6CiAgICAgICAgUU1lc3NhZ2VCb3guY2FsbGJhY2sgPSBjYWxsYmFjawoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBzZXRUZXh0KG1lc3NhZ2UpOgogICAgICAgIFFNZXNzYWdlQm94Lm1lc3NhZ2UgPSBtZXNzYWdlCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHNldFdpbmRvd1RpdGxlKHRpdGxlKToKICAgICAgICBRTWVzc2FnZUJveC50aXRsZSA9IHRpdGxlCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHNldEljb24oaWNvbik6CiAgICAgICAgcGFzcwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBzZXRTdGFuZGFyZEJ1dHRvbnMoYnV0dG9ucyk6CiAgICAgICAgcGFzcwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBleGVjXygpOgogICAgICAgIHRocmVhZGlkID0gY3R5cGVzLndpbmRsbC5rZXJuZWwzMi5HZXRDdXJyZW50VGhyZWFkSWQoKQogICAgICAgIHByb2Nlc3NpZCA9IGN0eXBlcy53aW5kbGwua2VybmVsMzIuR2V0Q3VycmVudFByb2Nlc3NJZCgpCiAgICAgICAgYWJvcnQgPSB0aHJlYWRpbmcuRXZlbnQoKQogICAgICAgIHQgPSB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1RTWVzc2FnZUJveC5jYWxsYmFja0hhbmRsZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJncz0oYWJvcnQsIHRocmVhZGlkLCBwcm9jZXNzaWQsIFFNZXNzYWdlQm94LnRpdGxlLCBRTWVzc2FnZUJveC50aW1lb3V0LCBRTWVzc2FnZUJveC5jYWxsYmFjaykpCiAgICAgICAgdC5zdGFydCgpCiAgICAgICAgcmV0dXJuIFFNZXNzYWdlQm94LnF1ZXN0aW9uKE5vbmUsIFFNZXNzYWdlQm94LnRpdGxlLCBRTWVzc2FnZUJveC5tZXNzYWdlKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBxdWVzdGlvbihuc2VpLCB0aXRsZSwgbXNnLCBkZWZhdWx0QnV0dG9uPU5vbmUsIGJ1dHRvbnM9Tm9uZSk6CiAgICAgICAgcmV0dXJuIFFNZXNzYWdlQm94Lm1lc3NhZ2VCb3goTm9uZSwgbXNnLCB0aXRsZSwgMykKCiAgICAjZGFuaWxvIGNhbGxiYWNrIHJldHVybiBUcnVlIHRvIHJ1biBhZ2FpbiBGYWxzZSB0byBzdG9wCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgY2FsbGJhY2tIYW5kbGVyKGFib3J0LCB0aHJlYWRpZCwgcHJvY2Vzc2lkLCB0aXRsZSwgY2FsbGJhY2tEZWxheSwgY2FsbGJhY2tGbik6CiAgICAgICAgIyBnaXZlIHdpbmRvd3Mgc29tZSB0aW1lIHRvIGNyZWF0ZSB0aGUgbWVzc2FnZSBib3gKICAgICAgICB0aW1lLnNsZWVwKG1heChjYWxsYmFja0RlbGF5LCAwLjIpKQogICAgICAgIGN1cnJlbnRUaW1lID0gbWF4KGNhbGxiYWNrRGVsYXksIDAuMikKICAgICAgICBjbGFzcyBidG5XcmFwcGVyOgogICAgICAgICAgICBtdXN0Q2xvc2UgPSBGYWxzZQogICAgICAgICAgICBkZWYgZG9uZShzZWxmLCBzdGF0ZSk6CiAgICAgICAgICAgICAgICBzZWxmLm11c3RDbG9zZSA9IFRydWUKICAgICAgICBjdXJCdG4gPSBidG5XcmFwcGVyKCkKICAgICAgICB3aGlsZSBub3QgY3VyQnRuLm11c3RDbG9zZSBhbmQgbm90IGFib3J0LmlzU2V0KCkgYW5kIGNhbGxiYWNrRm4oY3VyQnRuLCBjdXJyZW50VGltZSk6CiAgICAgICAgICAgIHRpbWUuc2xlZXAoY2FsbGJhY2tEZWxheSkKICAgICAgICAgICAgY3VycmVudFRpbWUgPSBjdXJyZW50VGltZSArIGNhbGxiYWNrRGVsYXkKICAgICAgICBod25kID0gUU1lc3NhZ2VCb3guZmluZF9tZXNzYWdlYm94KHRpdGxlLCB0aHJlYWRpZCwgcHJvY2Vzc2lkKQogICAgICAgIGlmIG5vdCBhYm9ydC5pc1NldCgpIGFuZCBod25kOgogICAgICAgICAgICBjdHlwZXMud2luZGxsLnVzZXIzMi5Qb3N0TWVzc2FnZVcoaHduZCwgUU1lc3NhZ2VCb3guV01fQ0xPU0UsIDAsIDApCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGVycm9yKG1zZywgZGVmYXVsdEJ1dHRvbj1Ob25lLCBidXR0b25zPU5vbmUpOgogICAgICAgIHJldHVybiBRTWVzc2FnZUJveC5tZXNzYWdlQm94KE5vbmUsIG1zZywgIkVycm9yIiwgMikKCgoKCgoKCmNsYXNzIEZlZWRiYWNrKCk6CiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgcHVzaENvbnNvbGVJbmZvKG1lc3NhZ2UpOgogICAgICAgIHByaW50KG1lc3NhZ2UpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHNldFByb2dyZXNzKHBlcmNlbnRhZ2UpOgogICAgICAgIHByaW50KCJQcm9ncmVzczogIiArIHN0cihwZXJjZW50YWdlKSkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgc2V0UHJvZ3Jlc3NUZXh0KG1lc3NhZ2UpOgogICAgICAgIHByaW50KG1lc3NhZ2UpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGlzQ2FuY2VsZWQoKToKICAgICAgICByZXR1cm4gRmFsc2UKCgoKCnRyeToKICAgIGZyb20gY29sb3JpemVfcmdiIGltcG9ydCBhcHBseUxlZ2VuZENzdiwgYXBwbHlMZWdlbmQsIHJlYWRMZWdlbmQsIHByZXBhcmVMZWdlbmQKZXhjZXB0OgogICAgcGFzcyAjTm90IGluIERpbmFtaWNhIENvZGUKCiMgdHJ5OgojICAgICBkaW5hbWljYS5wYWNrYWdlKCJQeVBORyIsIE5vbmUsICJwbmciKQojIGV4Y2VwdDoKIyAgICAgcGFzcwojCiMgaW1wb3J0IHBuZwojCiMgcyA9IFsnMTEwMDEwMDEwMDExJywKIyAgICAgICcxMDEwMTEwMTAxMDAnLAojICAgICAgJzExMDAxMDExMDEwMScsCiMgICAgICAnMTAwMDEwMDEwMDExJ10KIyBzID0gW1tpbnQoYykgZm9yIGMgaW4gcm93XSBmb3Igcm93IGluIHNdCiMKIyBwYWxldHRlPVsoMHg1NSwweDU1LDB4NTUpLCAoMHhmZiwweDk5LDB4OTkpXQojIHcgPSBwbmcuV3JpdGVyKGxlbihzWzBdKSwgbGVuKHMpLCBwYWxldHRlPXBhbGV0dGUsIGJpdGRlcHRoPTEpCiMgZiA9IG9wZW4oJ3BuZy5wbmcnLCAnd2InKQojIHcud3JpdGUoZiwgcykKCgpmcm9tIFBJTCBpbXBvcnQgSW1hZ2UKaW1wb3J0IGNzdgoKCgpjbGFzcyBMZWdlbmRFbnRyeToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjYXRlZ29yeSwgZnJvbVZhbHVlLCB0b1ZhbHVlLCBjYXRlZ29yeU5hbWUsIHJlZCwgZ3JlZW4sIGJsdWUpOgogICAgICAgIHNlbGYuY2F0ZWdvcnkgPSBpbnQoY2F0ZWdvcnkpCiAgICAgICAgc2VsZi5mcm9tVmFsdWUgPSBmbG9hdChmcm9tVmFsdWUpCiAgICAgICAgc2VsZi50b1ZhbHVlID0gZmxvYXQodG9WYWx1ZSkKICAgICAgICBzZWxmLmNhdGVnb3J5TmFtZSA9IGNhdGVnb3J5TmFtZQogICAgICAgIHNlbGYucmVkID0gaW50KHJlZCkKICAgICAgICBzZWxmLmdyZWVuID0gaW50KGdyZWVuKQogICAgICAgIHNlbGYuYmx1ZSA9IGludChibHVlKQoKICAgIGRlZiBnZXRSR0JBKHNlbGYpOgogICAgICAgIHJldHVybiAoc2VsZi5yZWQsIHNlbGYuZ3JlZW4sIHNlbGYuYmx1ZSwgMjU1KQoKZGVmIGFwcGx5TGVnZW5kKHBuZ1BhdGgsIGxlZ2VuZE9iaik6CiAgICB3aXRoIEltYWdlLm9wZW4ocG5nUGF0aCkgYXMgaW06CiAgICAgICAgaW0uY29udmVydCgnUkdCQScpCiAgICAgICAgYmFja2dyb3VuZCA9IEltYWdlLm5ldygiUkdCQSIsICgyNTYsIDI1NiksICgwLCAwLCAwLCAyNTUpKQogICAgICAgIHBpeGRhdGEgPSBpbS5sb2FkKCkKICAgICAgICB0b0RhdGEgPSBiYWNrZ3JvdW5kLmxvYWQoKQoKICAgICAgICB3aWR0aCA9IDI1NgogICAgICAgIGhlaWdodCA9IDI1NgogICAgICAgIGZvciB5IGluIHJhbmdlKGhlaWdodCk6CiAgICAgICAgICAgIGZvciB4IGluIHJhbmdlKHdpZHRoKToKICAgICAgICAgICAgICAgIGN1clZhbHVlID0gcGl4ZGF0YVt4LCB5XVswXSAjKyBwaXhkYXRhW3gsIHldWzFdCiAgICAgICAgICAgICAgICBpZiBwaXhkYXRhW3gsIHldID09ICgwLCAwKToKICAgICAgICAgICAgICAgICAgICB0b0RhdGFbeCwgeV0gPSAoMCwgMCwgMCwgMCkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgdG9EYXRhW3gsIHldID0gZ2V0TGVnZW5kRm9yVmFsdWUoY3VyVmFsdWUsIGxlZ2VuZE9iaikuZ2V0UkdCQSgpCiAgICAgICAgYmFja2dyb3VuZC5zYXZlKHBuZ1BhdGgsICJQTkciKQoKZGVmIHJlYWRMZWdlbmQoY3N2UGF0aCk6CiAgICByZXR1cm4gcHJlcGFyZUxlZ2VuZChbYSBmb3IgYSBpbiBjc3YucmVhZGVyKG9wZW4oY3N2UGF0aCwgInIiLCBlbmNvZGluZz0idXRmLTgiKSwgZXNjYXBlY2hhcj0nXFwnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBza2lwaW5pdGlhbHNwYWNlPUZhbHNlLCBkZWxpbWl0ZXI9JywnLCBxdW90aW5nPWNzdi5RVU9URV9OT05FKV0pCgpkZWYgYXBwbHlMZWdlbmRDc3YocG5nUGF0aCwgbGVnZW5kUGF0aCk6CiAgICByZXR1cm4gYXBwbHlMZWdlbmQocG5nUGF0aCwgcmVhZExlZ2VuZChsZWdlbmRQYXRoKSkKCmRlZiBwcmVwYXJlTGVnZW5kKGNzdkxlZ2VuZCk6CiAgICByZXN1bHQgPSBbXQogICAgaSA9IDAKICAgIGhlYWRUbXAgPSBjc3ZMZWdlbmQucG9wKDApCiAgICBpZiBub3QgKGxlbihoZWFkVG1wKSA+PSA3IGFuZCAnY2F0ZWdvcnknIGluIGhlYWRUbXBbMF0ubG93ZXIoKSBhbmQgJ2Zyb20nIGluIGhlYWRUbXBbMV0ubG93ZXIoKSBhbmQgJ3RvJyBpbiBoZWFkVG1wWzJdLmxvd2VyKCkKICAgICAgICAgICAgYW5kICdjYXRlZ29yeV9uYW1lJyBpbiBoZWFkVG1wWzNdLmxvd2VyKCkgYW5kICdyZWQnIGluIGhlYWRUbXBbNF0ubG93ZXIoKSBhbmQgJ2dyZWVuJyBpbiBoZWFkVG1wWzVdLmxvd2VyKCkKICAgICAgICAgICAgYW5kICdibHVlJyBpbiBoZWFkVG1wWzZdLmxvd2VyKCkpOgogICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiVGhlIENTViBTdHlsZSBpcyBpbnZhbGlkIHBsZWFzZSBjb25maXJtIHRoZSBGaWVsZHM6ICdDYXRlZ29yeSonLCAnIEZyb20nLCAnIFRvJywgJyBDYXRlZ29yeV9OYW1lJywgJyByZWQnLCAnIGdyZWVuJywgJyBibHVlJyIpCiAgICBmb3IgZWxtIGluIGNzdkxlZ2VuZDoKICAgICAgICByZXN1bHQuYXBwZW5kKExlZ2VuZEVudHJ5KGVsbVswXSwgZWxtWzFdLCBlbG1bMl0sIGVsbVszXSwgZWxtWzRdLCBlbG1bNV0sIGVsbVs2XSkpCiAgICByZXR1cm4gcmVzdWx0CgojQ2F0ZWdvcnkqLCBGcm9tLCBUbywgQ2F0ZWdvcnlfTmFtZSwgcmVkLCBncmVlbiwgYmx1ZSwKZGVmIGdldExlZ2VuZEZvclZhbHVlKHZhbHVlLCBsZWdlbmQpOgogICAgcmV0dXJuIFtsIGZvciBsIGluIGxlZ2VuZCBpZiBsLmNhdGVnb3J5ID09IHZhbHVlXVswXQoKIyAjICMgIyBkaWFsZWN0ID0gY3N2LkRpYWxlY3QoKQojICMgIyAjIGRpYWxlY3Quc2tpcGluaXRpYWxzcGFjZSA9IFRydWUKIyAjICMgIyBkaWFsZWN0LmRlbGltaXRlciA9ICcsJwojICMgIyAjIGRpYWxlY3QucXVvdGluZyA9ICciJwojICMgIyAjIGRpYWxlY3QuZXNjYXBlY2hhciA9ICdcXCcKIyAjIGFwcGx5TGVnZW5kKHBuZ1BhdGgsIHByZXBhcmVMZWdlbmQoY3N2LkRpY3RSZWFkZXIob3BlbignSTpcXERhbmlsb1xcVHJhbXBvXFxkYXRhX2RpclxcZGF0YVxcbGF1cmVsXFxsYW5kX3VzZV8xOTkyXzIwMTVcXGxhbmRfdXNlXzE5OTJfMjAxNV83LnNsZCcsICJyIiwgZW5jb2Rpbmc9InV0Zi04IiksIGVzY2FwZWNoYXI9J1xcJywgc2tpcGluaXRpYWxzcGFjZT1GYWxzZSwgZGVsaW1pdGVyPScsJywgcXVvdGluZz1jc3YuUVVPVEVfTk9ORSkpKQojIHNsZFBhdGggPSAnSTpcXERhbmlsb1xcVHJhbXBvXFxkYXRhX2RpclxcZGF0YVxcbGF1cmVsXFxsYW5kX3VzZV8xOTkyXzIwMTVcXGxhbmRfdXNlXzE5OTJfMjAxNV83LnNsZCcKIyBwbmdQYXRoID0gIkM6XFxVc2Vyc1xcRGFuaWxvXFxBcHBEYXRhXFxMb2NhbFxcVGVtcFxcb3V0cHV0RGlyXFxpeWllbGRfcnViYmVyMlxcMVxccmdiYVxcNFxcMDAwNV8wMDA3LnBuZyIKIyBhcHBseUxlZ2VuZENzdihwbmdQYXRoLCBzbGRQYXRoKQoKCnRyeToKICAgIGZyb20gVVRJTFMgaW1wb3J0IFVUSUxTCmV4Y2VwdDoKICAgIHBhc3MgI05vdCBpbiBEaW5hbWljYSBDb2RlCgppbXBvcnQgcmUKaW1wb3J0IHRpbWUKaW1wb3J0IG1hdGgKaW1wb3J0IG9zCmltcG9ydCB1bmljb2RlZGF0YQppbXBvcnQgdGVtcGZpbGUKZnJvbSBodHRwIGltcG9ydCBIVFRQU3RhdHVzCmZyb20gdXJsbGliLnBhcnNlIGltcG9ydCB1cmxlbmNvZGUKaW1wb3J0IHJlcXVlc3RzCmZyb20geG1sLnNheC5zYXh1dGlscyBpbXBvcnQgZXNjYXBlCmZyb20gemlwZmlsZSBpbXBvcnQgWmlwRmlsZQoKaXNEaW5hbWljYSA9IEZhbHNlCnRyeToKICAgIGRpbmFtaWNhLnBhY2thZ2UoIm9zIikKICAgIGlzRGluYW1pY2EgPSBUcnVlCmV4Y2VwdDoKICAgIGlzRGluYW1pY2EgPSBGYWxzZQoKdHJ5OgogICAgZnJvbSBRTWVzc2FnZUJveCBpbXBvcnQgUU1lc3NhZ2VCb3gKZXhjZXB0OgogICAgcGFzcyAjTm90IGluIERpbmFtaWNhIENvZGUKCnRyeToKICAgIGZyb20gcWdpcy5QeVF0LlF0V2lkZ2V0cyBpbXBvcnQgUU1lc3NhZ2VCb3gKICAgIGZyb20gcWdpcy5QeVF0LlF0Q29yZSBpbXBvcnQgUVRpbWVyCiAgICBmcm9tIHFnaXMuY29yZSBpbXBvcnQgKFFnc1Byb2plY3QsIFFnc0Nvb3JkaW5hdGVUcmFuc2Zvcm0sIFFnc01lc3NhZ2VMb2csIFFnc1ZlY3RvckxheWVyLCBRZ3NSYXN0ZXJMYXllcikKZXhjZXB0OgogICAgcGFzcyAjTm90IGluIFFHSVMKCmltcG9ydCByYW5kb20KaW1wb3J0IHN0cmluZwoKY2xhc3MgVVRJTFM6CgogICAgI0RhbmlsbyBvIHppcCBwcmVjaXNhIGRlbGV0YXIgZHBzCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgemlwRmlsZXMoZGlyLCBwYXR0ZXJuKToKICAgICAgICBjdXJUbXBGaWxlID0gdGVtcGZpbGUuTmFtZWRUZW1wb3JhcnlGaWxlKHN1ZmZpeD0nLnppcCcsIGRlbGV0ZT1GYWxzZSkKICAgICAgICBjb21wUGF0dGVybiA9IHJlLmNvbXBpbGUocGF0dGVybikKICAgICAgICAjIGNyZWF0ZSBhIFppcEZpbGUgb2JqZWN0CiAgICAgICAgd2l0aCBaaXBGaWxlKGN1clRtcEZpbGUsICd3JykgYXMgemlwT2JqOgogICAgICAgICAgICAjIEl0ZXJhdGUgb3ZlciBhbGwgdGhlIGZpbGVzIGluIGRpcmVjdG9yeQogICAgICAgICAgICBmb3IgZm9sZGVyTmFtZSwgc3ViZm9sZGVycywgZmlsZW5hbWVzIGluIG9zLndhbGsoZGlyKToKICAgICAgICAgICAgICAgIGZvciBmaWxlbmFtZSBpbiBmaWxlbmFtZXM6CiAgICAgICAgICAgICAgICAgICAgaWYgbm90IGNvbXBQYXR0ZXJuLm1hdGNoKGZpbGVuYW1lKToKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAjIGNyZWF0ZSBjb21wbGV0ZSBmaWxlcGF0aCBvZiBmaWxlIGluIGRpcmVjdG9yeQogICAgICAgICAgICAgICAgICAgIGZpbGVQYXRoID0gb3MucGF0aC5qb2luKGZvbGRlck5hbWUsIGZpbGVuYW1lKQogICAgICAgICAgICAgICAgICAgICMgQWRkIGZpbGUgdG8gemlwCiAgICAgICAgICAgICAgICAgICAgemlwT2JqLndyaXRlKGZpbGVQYXRoLCBvcy5wYXRoLmJhc2VuYW1lKGZpbGVQYXRoKSkKICAgICAgICAgICAgcmV0dXJuIGN1clRtcEZpbGUKICAgICAgICByZXR1cm4gTm9uZQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRGaWxlU2l6ZShkaXIsIHBhdHRlcm4pOgogICAgICAgIHRvdGFsID0gMAogICAgICAgIGNvbXBQYXR0ZXJuID0gcmUuY29tcGlsZShwYXR0ZXJuKQogICAgICAgIGZvciBmb2xkZXJOYW1lLCBzdWJmb2xkZXJzLCBmaWxlbmFtZXMgaW4gb3Mud2FsayhkaXIpOgogICAgICAgICAgICBmb3IgZmlsZW5hbWUgaW4gZmlsZW5hbWVzOgogICAgICAgICAgICAgICAgaWYgbm90IGNvbXBQYXR0ZXJuLm1hdGNoKGZpbGVuYW1lKToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgZmlsZVBhdGggPSBvcy5wYXRoLmpvaW4oZm9sZGVyTmFtZSwgZmlsZW5hbWUpCiAgICAgICAgICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShmaWxlUGF0aCk6CiAgICAgICAgICAgICAgICAgICAgdG90YWwgPSB0b3RhbCArIG9zLnBhdGguZ2V0c2l6ZShmaWxlUGF0aCkKICAgICAgICByZXR1cm4gdG90YWwKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgY2hlY2tGb3JDYW5jZWxlZChmZWVkYmFjaywgbXNnPSdDYW5jZWxsaW5nJyk6CiAgICAgICAgaWYgZmVlZGJhY2suaXNDYW5jZWxlZCgpOgogICAgICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8obXNnKQogICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oIlVzZXIgY2FuY2VsZWQgdGhlIHBsdWdpbiBleGVjdXRpb24uIikKCiAgICAjRGFuaWxvIC8vRGFuaWxvIHJldHVybiBhICBUZW1wb3JhcnlGaWxlIHdoZW4gd29ya3MKICAgICNEYW5pbG8gbyB6aXAgcHJlY2lzYSBkZWxldGFyCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2VuZXJhdGVaaXBMYXllcihsYXllcik6CiAgICAgICAgcHJpbnQoIkdlbmVyYXRpbmcgemlwIGZvciAiICsgbGF5ZXIubmFtZSgpICsgIiBsYXllci4iKQogICAgICAgIHNvdXJjZVVyaSA9IGxheWVyLmRhdGFQcm92aWRlcigpLmRhdGFTb3VyY2VVcmkoKQogICAgICAgIGFic29sdXRlUGF0aCA9IE5vbmUKICAgICAgICBpZiBpc2luc3RhbmNlKGxheWVyLCBRZ3NSYXN0ZXJMYXllcik6CiAgICAgICAgICAgIGlmICcudGlmZicgaW4gc291cmNlVXJpOgogICAgICAgICAgICAgICAgYWJzb2x1dGVQYXRoID0gc291cmNlVXJpWzooc291cmNlVXJpLmluZGV4KCIudGlmZiIpICsgNSldCiAgICAgICAgICAgIGVsaWYgJy50aWYnIGluIHNvdXJjZVVyaToKICAgICAgICAgICAgICAgIGFic29sdXRlUGF0aCA9IHNvdXJjZVVyaVs6KHNvdXJjZVVyaS5pbmRleCgiLnRpZiIpICsgNCldCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwcmludCgiT25seSB0aWZmIGFuZCB0aWYgaXMgYWxsb3dhYmxlIHRvIGRvd25sb2FkLiIpCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKGxheWVyLCBRZ3NWZWN0b3JMYXllcik6CiAgICAgICAgICAgIGlmICcuc2hwJyBpbiBzb3VyY2VVcmk6CiAgICAgICAgICAgICAgICBhYnNvbHV0ZVBhdGggPSBzb3VyY2VVcmlbOihzb3VyY2VVcmkuaW5kZXgoIi5zaHAiKSArIDQpXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcHJpbnQoIk9ubHkgc2hwIGZpbGUgaXMgYWxsb3dhYmxlIHRvIGRvd25sb2FkLiIpCiAgICAgICAgaWYgYWJzb2x1dGVQYXRoIGlzIG5vdCBOb25lOgogICAgICAgICAgICBmaWxlTmFtZSA9IG9zLnBhdGguYmFzZW5hbWUoYWJzb2x1dGVQYXRoKQogICAgICAgICAgICBmaWxlTmFtZVdpdGhvdXRFeHQgPSBvcy5wYXRoLnNwbGl0ZXh0KGZpbGVOYW1lKVswXQogICAgICAgICAgICBkaXJOYW1lID0gb3MucGF0aC5kaXJuYW1lKGFic29sdXRlUGF0aCkKICAgICAgICAgICAgemlwRmlsZSA9IFVUSUxTLnppcEZpbGVzKGRpck5hbWUgKyBvcy5wYXRoLnNlcCwgZmlsZU5hbWVXaXRob3V0RXh0ICsgIioiKQogICAgICAgICAgICB6aXBGaWxlLmNsb3NlKCkKICAgICAgICAgICAgaWYgb3MucGF0aC5nZXRzaXplKHppcEZpbGUubmFtZSkgPiAyZTk6CiAgICAgICAgICAgICAgICBwcmludCgiVGhlIG1hcCBmaWxlc2l6ZSBpcyBncmVhdGVyIHRoYW4gdGhlIEdpdEh1YiAyR2IgbGltaXQuIChhbGwgZmlsZXMgaW4gdGhpcyBmb2xkZXIgc3RhcnRpbmcgd2l0aCAiICsgZmlsZU5hbWVXaXRob3V0RXh0ICsgIiB3ZXJlIGluY2x1ZGVkLiIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByZXR1cm4gemlwRmlsZQogICAgICAgIHJldHVybiBOb25lCgoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBydW5Mb25nVGFzayhmdW5jdGlvbiwgZmVlZGJhY2ssIHdhaXRNZXNzYWdlPSJQbGVhc2UgV2FpdCIsIHNlY29uZHNSZXBvcnQ9NjAsICphcmdzLCAqKmt3QXJncyk6CiAgICAgICAgZnJvbSBjb25jdXJyZW50IGltcG9ydCBmdXR1cmVzCiAgICAgICAgIyBmZWVkYmFjay5zZXRQcm9ncmVzcygxKQogICAgICAgIHN0ZXBUaW1lciA9IDAuNQogICAgICAgIHRvdGFsVGltZSA9IDAKICAgICAgICB3aXRoIGZ1dHVyZXMuVGhyZWFkUG9vbEV4ZWN1dG9yKG1heF93b3JrZXJzPTEpIGFzIGV4ZWN1dG9yOgogICAgICAgICAgICBqb2IgPSBleGVjdXRvci5zdWJtaXQoZnVuY3Rpb24sICphcmdzLCAqKmt3QXJncykKICAgICAgICAgICAgZWxhcHNlZFRpbWUgPSAwCiAgICAgICAgICAgIHdoaWxlIGpvYi5kb25lKCkgPT0gRmFsc2U6CiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKHN0ZXBUaW1lcikKICAgICAgICAgICAgICAgIGVsYXBzZWRUaW1lID0gZWxhcHNlZFRpbWUgKyBzdGVwVGltZXIKICAgICAgICAgICAgICAgIHRvdGFsVGltZSA9IHRvdGFsVGltZSArIHN0ZXBUaW1lcgogICAgICAgICAgICAgICAgaWYgZWxhcHNlZFRpbWUgPiBzZWNvbmRzUmVwb3J0OgogICAgICAgICAgICAgICAgICAgIGNhbmNlbE1zZyA9ICJcbkNhbmNlbGxpbmcsIHBsZWFzZSB3YWl0IHRoZSBjdXJyZW50IHN0ZXAgdG8gZmluaXNoIGdyYWNlZnVsbHkuIiBpZiBmZWVkYmFjay5pc0NhbmNlbGVkKCkgZWxzZSAnJwogICAgICAgICAgICAgICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiRWxhcHNlZCAiICsgc3RyKHJvdW5kKHRvdGFsVGltZSkpICsgInM6ICIgKyB3YWl0TWVzc2FnZSArIGNhbmNlbE1zZykKICAgICAgICAgICAgICAgICAgICBlbGFwc2VkVGltZSA9IDAKICAgICAgICAgICAgICAgICMgaWYgY2FuQ2FuY2VsTm93IGFuZCBmZWVkYmFjay5pc0NhbmNlbGVkKCk6CiAgICAgICAgICAgICAgICAjICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkpvYiBzdGFydGluZyB0byBjYW5jZWwuIikKICAgICAgICAgICAgICAgICMgICAgIGpvYi5jYW5jZWwoKQogICAgICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkVsYXBzZWQgIiArIHN0cihyb3VuZCh0b3RhbFRpbWUpKSArICJzIG9uIHRoaXMgc3RlcC4iKQogICAgICAgICAgICAjIFVUSUxTLmNoZWNrRm9yQ2FuY2VsZWQoZmVlZGJhY2spCiAgICAgICAgICAgIHJldHVybiBqb2IucmVzdWx0KCkKCiAgICAiIiIKICAgIFVzZSBzYWZlciBuYW1lcy4KICAgICIiIgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIG5vcm1hbGl6ZU5hbWUobmFtZSwgaXNGaWxlbmFtZT1UcnVlLCBlc2NhcGVYbWw9VHJ1ZSwgcmVtb3ZlQWNjZW50cz1UcnVlKToKICAgICAgICBub3JtYWxpemVkID0gbmFtZQogICAgICAgIGlmIGVzY2FwZVhtbDoKICAgICAgICAgICAgbm9ybWFsaXplZCA9IFVUSUxTLmVzY2FwZVhtbChub3JtYWxpemVkKQogICAgICAgIGlmIHJlbW92ZUFjY2VudHM6CiAgICAgICAgICAgIG5vcm1hbGl6ZWQgPSBVVElMUy5zdHJpcF9hY2NlbnRzKG5vcm1hbGl6ZWQpCiAgICAgICAgaWYgaXNGaWxlbmFtZToKICAgICAgICAgICAgbm9ybWFsaXplZCA9IFVUSUxTLmVzY2FwZUZpbGVuYW1lKG5vcm1hbGl6ZWQpCiAgICAgICAgcmV0dXJuIG5vcm1hbGl6ZWQubG93ZXIoKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBlc2NhcGVGaWxlbmFtZShjb250ZW50KToKICAgICAgICByZXR1cm4gcmUuc3ViKHIiXFciLCAiXyIsIGNvbnRlbnQpCgogICAgI2h0dHBzOi8vcHluYXRpdmUuY29tL3B5dGhvbi1nZW5lcmF0ZS1yYW5kb20tc3RyaW5nLwogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHJhbmRvbVN0cmluZyhzdHJpbmdMZW5ndGg9MjcpOgogICAgICAgICIiIkdlbmVyYXRlIGEgcmFuZG9tIHN0cmluZyBvZiBmaXhlZCBsZW5ndGggIiIiCiAgICAgICAgbGV0dGVycyA9IHN0cmluZy5hc2NpaV9sb3dlcmNhc2UKICAgICAgICByZXR1cm4gJycuam9pbihyYW5kb20uY2hvaWNlKGxldHRlcnMpIGZvciBpIGluIHJhbmdlKHN0cmluZ0xlbmd0aCkpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHNlbmRSZXBvcnQoZGljdFBhcmFtKToKICAgICAgICByZXEgPSByZXF1ZXN0cy5nZXQodXJsPSdodHRwOi8vY3NyLnVmbWcuYnIvaW1hZ2VyeS9zYXZlX3JlcG9ydHMucGhwPycgKyB1cmxlbmNvZGUoZGljdFBhcmFtKSkKICAgICAgICBpZiByZXEuc3RhdHVzX2NvZGUgPT0gSFRUUFN0YXR1cy5PSzoKICAgICAgICAgICAgcmV0dXJuIHJlcS50ZXh0CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuICcnCgogICAgI1JldHVybiB0aGUgbWFwIGV4dGVudHMgaW4gdGhlIGdpdmVuIHByb2plY3Rpb24KICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRNYXBFeHRlbnQobGF5ZXIsIHByb2plY3Rpb24pOgogICAgICAgIG1hcEV4dGVudCA9IGxheWVyLmV4dGVudCgpCiAgICAgICAgcHJvamVjdGlvbi52YWxpZGF0ZSgpCiAgICAgICAgbGF5ZXIuY3JzKCkudmFsaWRhdGUoKQogICAgICAgIHNyY190b19wcm9qID0gUWdzQ29vcmRpbmF0ZVRyYW5zZm9ybShsYXllci5jcnMoKSwgcHJvamVjdGlvbiwgUWdzUHJvamVjdC5pbnN0YW5jZSgpLnRyYW5zZm9ybUNvbnRleHQoKSBpZiBnZXRhdHRyKGxheWVyLCAidHJhbnNmb3JtQ29udGV4dCIsIE5vbmUpIGlzIE5vbmUgZWxzZSBsYXllci50cmFuc2Zvcm1Db250ZXh0KCkpCiAgICAgICAgcmV0dXJuIHNyY190b19wcm9qLnRyYW5zZm9ybUJvdW5kaW5nQm94KG1hcEV4dGVudCkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZXNjYXBlWG1sKGNvbnRlbnQpOgogICAgICAgIHJldHVybiBlc2NhcGUoY29udGVudCkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgc3RyaXBfYWNjZW50cyhzKToKICAgICAgIHJldHVybiAnJy5qb2luKGMgZm9yIGMgaW4gdW5pY29kZWRhdGEubm9ybWFsaXplKCdORkQnLCBzKQogICAgICAgICAgICAgICAgICAgICAgaWYgdW5pY29kZWRhdGEuY2F0ZWdvcnkoYykgIT0gJ01uJykKCiAgICAjIFRNUyBmdW5jdGlvbnMgdGFrZW4gZnJvbSBodHRwczovL2FsYXN0YWlyYS53b3JkcHJlc3MuY29tLzIwMTEvMDcvMDYvY29udmVydGluZy10bXMtdGlsZS1jb29yZGluYXRlcy10by1nb29nbGViaW5nb3NtLXRpbGUtY29vcmRpbmF0ZXMvICNzcGVsbG9rCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgdG1zKHl0aWxlLCB6b29tKToKICAgICAgICBuID0gMi4wICoqIHpvb20KICAgICAgICB5dGlsZSA9IG4gLSB5dGlsZSAtIDEKICAgICAgICByZXR1cm4gaW50KHl0aWxlKQoKICAgICMgTWF0aCBmdW5jdGlvbnMgdGFrZW4gZnJvbSBodHRwczovL3dpa2kub3BlbnN0cmVldG1hcC5vcmcvd2lraS9TbGlwcHlfbWFwX3RpbGVuYW1lcyAjc3BlbGxvawogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGRlZzJudW0obGF0X2RlZywgbG9uX2RlZywgem9vbSk6CiAgICAgICAgUWdzTWVzc2FnZUxvZy5sb2dNZXNzYWdlKCIgZSAiLmpvaW4oW3N0cihsYXRfZGVnKSwgc3RyKGxvbl9kZWcpLCBzdHIoem9vbSldKSwgdGFnPSJQcm9jZXNzaW5nIikKICAgICAgICBsYXRfcmFkID0gbWF0aC5yYWRpYW5zKGxhdF9kZWcpCiAgICAgICAgbiA9IDIuMCAqKiB6b29tCiAgICAgICAgeHRpbGUgPSBpbnQoKGxvbl9kZWcgKyAxODAuMCkgLyAzNjAuMCAqIG4pCiAgICAgICAgeXRpbGUgPSBpbnQoKDEuMCAtIG1hdGguYXNpbmgobWF0aC50YW4obGF0X3JhZCkpIC8gbWF0aC5waSkgLyAyLjAgKiBuKQogICAgICAgIHJldHVybiAoeHRpbGUsIHl0aWxlKQoKICAgICMgTWF0aCBmdW5jdGlvbnMgdGFrZW4gZnJvbSBodHRwczovL3dpa2kub3BlbnN0cmVldG1hcC5vcmcvd2lraS9TbGlwcHlfbWFwX3RpbGVuYW1lcyAjc3BlbGxvawogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIG51bTJkZWcoeHRpbGUsIHl0aWxlLCB6b29tKToKICAgICAgICBuID0gMi4wICoqIHpvb20KICAgICAgICBsb25fZGVnID0geHRpbGUgLyBuICogMzYwLjAgLSAxODAuMAogICAgICAgIGxhdF9yYWQgPSBtYXRoLmF0YW4obWF0aC5zaW5oKG1hdGgucGkgKiAoMSAtIDIgKiB5dGlsZSAvIG4pKSkKICAgICAgICBsYXRfZGVnID0gbWF0aC5kZWdyZWVzKGxhdF9yYWQpCiAgICAgICAgcmV0dXJuIChsYXRfZGVnLCBsb25fZGVnKQoKICAgICMgVGhpcyBmdW5jdGlvbiBnZXRzIGEgc3lzdGVtIHZhcmlhYmxlCiAgICAjIGl0IHdhcyBuZWNlc3NhcnkgdG8gdXNlIHRoaXMgaW5zdGVhZCBvZiBvcy5lbnZpcm9uWyJQQVRIIl0gYmVjYXVzZSBRR0lTIG92ZXJ3cml0ZXMgdGhlIHBhdGggdmFyaWFibGUKICAgICMgdGhlIHdpbjMyIGxpYnJhcmllcyBhcHBlYXIgbm90IHRvIGJlIHBhcnQgb2YgdGhlIHN0YW5kYXJkIHB5dGhvbiBpbnN0YWxsLCBidXQgdGhleSBhcmUgaW5jbHVkZWQgaW4gdGhlCiAgICAjIHB5dGhvbiB2ZXJzaW9uIHRoYXQgY29tZXMgd2l0aCBRR0lTCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0ZW52X3N5c3RlbSh2YXJuYW1lLCBkZWZhdWx0PScnKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGltcG9ydCBvcwogICAgICAgICAgICBpbXBvcnQgd2luMzJhcGkKICAgICAgICAgICAgaW1wb3J0IHdpbjMyY29uCiAgICAgICAgICAgIHYgPSBkZWZhdWx0CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJrZXkgPSB3aW4zMmFwaS5SZWdPcGVuS2V5KHdpbjMyY29uLkhLRVlfTE9DQUxfTUFDSElORSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdTWVNURU1cXEN1cnJlbnRDb250cm9sU2V0XFxDb250cm9sXFxTZXNzaW9uIE1hbmFnZXJcXEVudmlyb25tZW50JykKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICB2ID0gc3RyKHdpbjMyYXBpLlJlZ1F1ZXJ5VmFsdWVFeChya2V5LCB2YXJuYW1lKVswXSkKICAgICAgICAgICAgICAgICAgICB2ID0gd2luMzJhcGkuRXhwYW5kRW52aXJvbm1lbnRTdHJpbmdzKHYpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAgICAgd2luMzJhcGkuUmVnQ2xvc2VLZXkocmtleSkKICAgICAgICAgICAgcmV0dXJuIHYKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHJldHVybiAnJwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBpc19leGUoZnBhdGgpOgogICAgICAgIHJldHVybiBvcy5wYXRoLmlzZmlsZShmcGF0aCkgYW5kIG9zLmFjY2VzcyhmcGF0aCwgb3MuWF9PSykKCiAgICAjIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzM3NzAxNy90ZXN0LWlmLWV4ZWN1dGFibGUtZXhpc3RzLWluLXB5dGhvbi8xMjYxMTUyMwogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHdoaWNoKHByb2dyYW0pOgogICAgICAgIGZwYXRoLCBmbmFtZSA9IG9zLnBhdGguc3BsaXQocHJvZ3JhbSkKICAgICAgICBpZiBmcGF0aDoKICAgICAgICAgICAgaWYgVVRJTFMuaXNfZXhlKHByb2dyYW0pOgogICAgICAgICAgICAgICAgcmV0dXJuIHByb2dyYW0KICAgICAgICBlbHNlOgogICAgICAgICAgICBmb3IgcGF0aCBpbiBvcy5lbnZpcm9uWyJQQVRIIl0uc3BsaXQob3MucGF0aHNlcCk6CiAgICAgICAgICAgICAgICBleGVfZmlsZSA9IG9zLnBhdGguam9pbihwYXRoLCBwcm9ncmFtKQogICAgICAgICAgICAgICAgaWYgVVRJTFMuaXNfZXhlKGV4ZV9maWxlKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhlX2ZpbGUKICAgICAgICAgICAgZm9yIHBhdGggaW4gVVRJTFMuZ2V0ZW52X3N5c3RlbSgiUEFUSCIpLnNwbGl0KG9zLnBhdGhzZXApOgogICAgICAgICAgICAgICAgZXhlX2ZpbGUgPSBvcy5wYXRoLmpvaW4ocGF0aCwgcHJvZ3JhbSkKICAgICAgICAgICAgICAgIGlmIFVUSUxTLmlzX2V4ZShleGVfZmlsZSk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4ZV9maWxlCgogICAgICAgIHJldHVybiBOb25lCgpjbGFzcyBVc2VySW50ZXJydXB0ZWQoRXhjZXB0aW9uKToKICAgIHBhc3MKCiMgY2xhc3MgVGltZWRNZXNzYWdlQm94KFFNZXNzYWdlQm94KToKIyAgICAgZGVmIF9faW5pdF9fKHNlbGYsIHRpbWVvdXQsIG1lc3NhZ2UsIGNhbGxiYWNrKToKIyAgICAgICAgIHN1cGVyKFRpbWVkTWVzc2FnZUJveCwgc2VsZikuX19pbml0X18oKQojICAgICAgICAgc2VsZi50aW1lb3V0ID0gdGltZW91dAojICAgICAgICAgc2VsZi5jYWxsYmFjayA9IGNhbGxiYWNrCiMKIyAgICAgZGVmIGludGVydmFsQ2FsbGJhY2soc2VsZik6CiMgICAgICAgICBzZWxmLmNhbGxiYWNrKCkKIyAgICAgICAgIFFUaW1lcigpLnNpbmdsZVNob3Qoc2VsZi50aW1lb3V0KjEwMDAsIHNlbGYuaW50ZXJ2YWxDYWxsYmFjaykKIwojICAgICBkZWYgc2hvd0V2ZW50KHNlbGYsIGV2ZW50KToKIyAgICAgICAgIFFUaW1lcigpLnNpbmdsZVNob3Qoc2VsZi50aW1lb3V0KjEwMDAsIHNlbGYuaW50ZXJ2YWxDYWxsYmFjaykKIyAgICAgICAgIHN1cGVyKFRpbWVkTWVzc2FnZUJveCwgc2VsZikuc2hvd0V2ZW50KGV2ZW50KQoKCnRyeToKICAgIGZyb20gR2l0SHViIGltcG9ydCBHaXRIdWIKZXhjZXB0OgogICAgcGFzcyAjTm90IGluIERpbmFtaWNhIENvZGUKCmltcG9ydCByZQppbXBvcnQgb3MKaW1wb3J0IHJhbmRvbQppbXBvcnQgd2ViYnJvd3NlcgppbXBvcnQgcmVxdWVzdHMKaW1wb3J0IHRpbWUKaW1wb3J0IGpzb24KaW1wb3J0IGdsb2IKaW1wb3J0IHRlbXBmaWxlCmltcG9ydCBwbGF0Zm9ybQppbXBvcnQgc3VicHJvY2Vzcwpmcm9tIGh0dHAgaW1wb3J0IEhUVFBTdGF0dXMKZnJvbSByZXF1ZXN0cyBpbXBvcnQgcmVxdWVzdApmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZQpmcm9tIHRpbWUgaW1wb3J0IHNsZWVwCgoKCmlzRGluYW1pY2EgPSBGYWxzZQp0cnk6CiAgICBkaW5hbWljYS5wYWNrYWdlKCJvcyIpCiAgICBpc0RpbmFtaWNhID0gVHJ1ZQpleGNlcHQ6CiAgICBpc0RpbmFtaWNhID0gRmFsc2UKCnRyeToKICAgIGZyb20gVVRJTFMgaW1wb3J0IFVUSUxTCiAgICBmcm9tIFFNZXNzYWdlQm94IGltcG9ydCBRTWVzc2FnZUJveApleGNlcHQ6CiAgICBwYXNzICNOb3QgaW4gRGluYW1pY2EgQ29kZQoKdHJ5OgogICAgZnJvbSBxZ2lzLlB5UXQuUXRXaWRnZXRzIGltcG9ydCBRTWVzc2FnZUJveApleGNlcHQ6CiAgICBwYXNzICNOb3QgaW4gUUdJUwoKY2xhc3MgR2l0SHViOgoKICAgIG9yaWdpbk5hbWUgPSAibWFwcGlhIgogICAgcmVsZWFzZU5hbWUgPSAiTWFwX0Rvd25sb2FkIgogICAgZ2l0aHViQXBpID0gJ2h0dHBzOi8vYXBpLmdpdGh1Yi5jb20vJwoKICAgIHBlcnNvbmFsX3Rva2VuID0gJycKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgdGVzdExvZ2luKHVzZXIsIHRva2VuKToKICAgICAgICByZXR1cm4gcmVxdWVzdHMuZ2V0KHVybD1HaXRIdWIuZ2l0aHViQXBpICsgJ3VzZXInLCBhdXRoPSh1c2VyLCB0b2tlbikpLnN0YXR1c19jb2RlID09IDIwMAoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBwcmVwYXJlRW52aXJvbm1lbnQoZ2l0RXhlY3V0YWJsZSk6CiAgICAgICAgaWYgbm90IGdpdEV4ZWN1dGFibGU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGdpdFByb2dyYW1Gb2xkZXIgPSBvcy5wYXRoLmRpcm5hbWUoZ2l0RXhlY3V0YWJsZSkKICAgICAgICAjZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKGdpdFByb2dyYW1Gb2xkZXIpICNjaW56YSBlc2NvbmRpZG8KICAgICAgICAjZmVlZGJhY2suc2V0UHJvZ3Jlc3NUZXh0KGdpdEV4ZWN1dGFibGUpICNwcmV0bwogICAgICAgIG9zLmVudmlyb25bJ0dJVF9QWVRIT05fR0lUX0VYRUNVVEFCTEUnXSA9IGdpdEV4ZWN1dGFibGUKICAgICAgICAjaW5pdGlhbFBhdGggPSBvcy5lbnZpcm9uWydQQVRIJ10KICAgICAgICBvcy5lbnZpcm9uWydHSVRfUFlUSE9OX1JFRlJFU0gnXSA9ICdxdWlldCcKICAgICAgICBpbXBvcnQgZ2l0CiAgICAgICAgZ2l0LnJlZnJlc2goZ2l0RXhlY3V0YWJsZSkKICAgICAgICB0cnk6CiAgICAgICAgICAgIG9zLmVudmlyb25bJ1BBVEgnXS5zcGxpdChvcy5wYXRoc2VwKS5pbmRleChnaXRQcm9ncmFtRm9sZGVyKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgb3MuZW52aXJvblsiUEFUSCJdID0gZ2l0UHJvZ3JhbUZvbGRlciArIG9zLnBhdGhzZXAgKyBvcy5lbnZpcm9uWyJQQVRIIl0KCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgaW5zdGFsbF9naXQobXVzdEFza1VzZXIpOgogICAgICAgIGRlZiB1c2VyQ29uZmlybWVkKCk6CiAgICAgICAgICAgIHJldHVybiBRTWVzc2FnZUJveC5ZZXMgPT0gUU1lc3NhZ2VCb3gucXVlc3Rpb24oTm9uZSwgIlJlcXVpcmVkIEdJVCBleGVjdXRhYmxlIHdhcyBub3QgZm91bmQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJDbGljayAnWUVTJyB0byBzdGFydCBkb3dubG9hZCBhbmQgY29udGludWUsIG90aGVyd2lzZSBwbGVhc2Ugc2VsZWN0IHRoZSBleGVjdXRhYmxlIG1hbnVhbGx5LiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdEJ1dHRvbj1RTWVzc2FnZUJveC5ZZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9ucz0oUU1lc3NhZ2VCb3guWWVzIHwgUU1lc3NhZ2VCb3guTm8gfCBRTWVzc2FnZUJveC5DYW5jZWwpKQoKICAgICAgICBpZiBub3QgKCJXaW5kb3dzIiBpbiBwbGF0Zm9ybS5zeXN0ZW0oKSBvciAiQ1lHV0lOX05UIiBpbiBwbGF0Zm9ybS5zeXN0ZW0oKSk6CiAgICAgICAgICAgIFFNZXNzYWdlQm94LnF1ZXN0aW9uKE5vbmUsICJGYWlsZWQgdG8gZmluZCBHSVQgZXhlY3V0YWJsZSIsICJQbGVhc2UgaW5zdGFsbCBnaXQgaW4geW91ciBzeXN0ZW0gYW5kIGZpbGwgdGhlIHBhcmFtZXRlciBHSVQgZXhlY3V0YWJsZSBwYXRoLiIpCiAgICAgICAgaWYgKG5vdCBtdXN0QXNrVXNlciBvciB1c2VyQ29uZmlybWVkKCkpID09IEZhbHNlOgogICAgICAgICAgICByZXR1cm4gJycKCiAgICAgICAgZGVmIGRvd25sb2FkX2ZpbGUodXJsLCB0b0Rpcik6CiAgICAgICAgICAgIGxvY2FsX2ZpbGVuYW1lID0gb3MucGF0aC5qb2luKHRvRGlyLCB1cmwuc3BsaXQoJy8nKVstMV0pCiAgICAgICAgICAgICMgTk9URSB0aGUgc3RyZWFtPVRydWUgcGFyYW1ldGVyIGJlbG93CiAgICAgICAgICAgIHdpdGggcmVxdWVzdHMuZ2V0KHVybCwgc3RyZWFtPVRydWUpIGFzIHI6CiAgICAgICAgICAgICAgICByLnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICAgICAgICAgICAgd2l0aCBvcGVuKGxvY2FsX2ZpbGVuYW1lLCAnd2InKSBhcyBmOgogICAgICAgICAgICAgICAgICAgIGZvciBjaHVuayBpbiByLml0ZXJfY29udGVudChjaHVua19zaXplPTgxOTIpOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBjaHVuazogICMgZmlsdGVyIG91dCBrZWVwLWFsaXZlIG5ldyBjaHVua3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYud3JpdGUoY2h1bmspCiAgICAgICAgICAgIHJldHVybiBsb2NhbF9maWxlbmFtZQoKICAgICAgICB0bXBEaXIgPSB0ZW1wZmlsZS5ta2R0ZW1wKCkKICAgICAgICBnaXRVcmwgPSAiaHR0cHM6Ly9naXRodWIuY29tL2dpdC1mb3Itd2luZG93cy9naXQvcmVsZWFzZXMvZG93bmxvYWQvdjIuMjUuMS53aW5kb3dzLjEvUG9ydGFibGVHaXQtMi4yNS4xLTY0LWJpdC43ei5leGUiCiAgICAgICAgIyBRTWVzc2FnZUJveC5pbmZvcm1hdGlvbihOb25lLCAiU3RhcnRpbmcgR0lUIGRvd25sb2FkIiwgIlRoaXMgc3RlcCB3aWxsIHRha2Ugc29tZSB0aW1lLCBpdCBkZXBlbmRzIG9uIHlvdXIgaW50ZXJuZXQgc3BlZWQuXG5DbGljayAnT0snIHRvIGNvbnRpbnVlLiIsIGRlZmF1bHRCdXR0b249UU1lc3NhZ2VCb3guT2ssIGJ1dHRvbnM9UU1lc3NhZ2VCb3guT2spCiAgICAgICAgc2VsZkV4dHJhY3RvciA9IGRvd25sb2FkX2ZpbGUoZ2l0VXJsLCB0bXBEaXIpCiAgICAgICAgcG9ydGFibGVHaXQgPSBvcy5wYXRoLmpvaW4odG1wRGlyLCAicG9ydGFibGVnaXQiKQogICAgICAgIGlmIChub3Qgb3MucGF0aC5pc2ZpbGUoc2VsZkV4dHJhY3RvcikpOgogICAgICAgICAgICByZXR1cm4gJycKICAgICAgICBzdWJwcm9jZXNzLmNoZWNrX291dHB1dChbc2VsZkV4dHJhY3RvciwgJy1vJywgcG9ydGFibGVHaXQsICIteSJdKQogICAgICAgIHJldHVybiBvcy5wYXRoLmpvaW4ocG9ydGFibGVHaXQsICdtaW5ndzY0JywgJ2JpbicsICdnaXQuZXhlJykKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0R2l0RXhlKCk6CiAgICAgICAgZ2l0RXhlID0gJycKICAgICAgICB0cnk6CiAgICAgICAgICAgIGdpdEV4ZSA9IG9zLmVudmlyb25bJ0dJVF9QWVRIT05fR0lUX0VYRUNVVEFCTEUnXQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwogICAgICAgIHJldHVybiBnaXRFeGUKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0UmVwb3NpdG9yeVNpemUodXNlciwgcmVwb3NpdG9yeSwgcGFzc3dvcmQpOgogICAgICAgIHJlc3BvbnNlID0gR2l0SHViLl9yZXF1ZXN0KCdHRVQnLCAnaHR0cHM6Ly9hcGkuZ2l0aHViLmNvbS9yZXBvcy8nICsgdXNlciArICIvIiArIHJlcG9zaXRvcnksIHRva2VuPXBhc3N3b3JkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM9eydDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbid9KQogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICAgICAgcmV0dXJuIGpzb24ubG9hZHMocmVzcG9uc2UuY29udGVudClbJ3NpemUnXQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcHJpbnQoIkZhaWxlZCB0byBnZXQgdGhlIHJlcG9zaXRvcnkgc2l6ZSwgaWdub3JpbmcgaXQuIikKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICByZXR1cm4gTm9uZQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRHaXRVcmwoZ2l0aHViVXNlciwgZ2l0aHViUmVwb3NpdG9yeSk6CiAgICAgICAgcmV0dXJuICJodHRwczovL2dpdGh1Yi5jb20vIiArIGdpdGh1YlVzZXIgKyAiLyIgKyBnaXRodWJSZXBvc2l0b3J5ICsgIi8iCgogICAgI05vIHBhc3N3b3JkIHRvIGFsbG93IHVzaW5nIGNvbmZpZ3VyZWQgU1NIS2V5LgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldEdpdFBhc3NVcmwodXNlciwgcmVwb3NpdG9yeSwgcGFzc3dvcmQpOgogICAgICAgIGlmIHBhc3N3b3JkIGlzIE5vbmUgb3Igbm90IHBhc3N3b3JkOgogICAgICAgICAgICByZXR1cm4gR2l0SHViLmdldEdpdFVybCh1c2VyLCByZXBvc2l0b3J5KQogICAgICAgIHJldHVybiAiaHR0cHM6Ly8iICsgdXNlciArICI6IiArIHBhc3N3b3JkICsgIkBnaXRodWIuY29tLyIgKyB1c2VyICsgIi8iICsgcmVwb3NpdG9yeSArICIvIgoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBsc3JlbW90ZSh1cmwpOgogICAgICAgIGltcG9ydCBnaXQKICAgICAgICByZW1vdGVfcmVmcyA9IHt9CiAgICAgICAgZyA9IGdpdC5jbWQuR2l0KCkKICAgICAgICBmb3IgcmVmIGluIGcubHNfcmVtb3RlKHVybCkuc3BsaXQoJ1xuJyk6CiAgICAgICAgICAgIGhhc2hfcmVmX2xpc3QgPSByZWYuc3BsaXQoJ1x0JykKICAgICAgICAgICAgcmVtb3RlX3JlZnNbaGFzaF9yZWZfbGlzdFsxXV0gPSBoYXNoX3JlZl9saXN0WzBdCiAgICAgICAgcmV0dXJuIHJlbW90ZV9yZWZzCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGV4aXN0c1JlcG9zaXRvcnkodXNlciwgcmVwb3NpdG9yeSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICAjZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJVUkw6ICIgKyBHaXRIdWIuZ2V0R2l0VXJsKHVzZXIsIHJlcG9zaXRvcnkpKQogICAgICAgICAgICByZXNwID0gcmVxdWVzdHMuZ2V0KEdpdEh1Yi5nZXRHaXRVcmwodXNlciwgcmVwb3NpdG9yeSkpCiAgICAgICAgICAgIGlmIHJlc3Auc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAjcmVzdWx0ID0gR2l0SHViLmxzcmVtb3RlKEdpdEh1Yi5nZXRHaXRVcmwodXNlciwgcmVwb3NpdG9yeSkpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgY29uZmlnVXNlcihyZXBvLCB1c2VyKToKICAgICAgICByZXBvLmdpdC5jb25maWcoInVzZXIuZW1haWwiLCB1c2VyKQogICAgICAgIHJlcG8uZ2l0LmNvbmZpZygidXNlci5uYW1lIiwgdXNlcikKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0UmVwb3NpdG9yeShmb2xkZXIsIHVzZXIsIHJlcG9zaXRvcnksIHBhc3N3b3JkLCBmZWVkYmFjayk6CiAgICAgICAgZnJvbSBnaXQgaW1wb3J0IFJlcG8KICAgICAgICBmcm9tIGdpdCBpbXBvcnQgSW52YWxpZEdpdFJlcG9zaXRvcnlFcnJvcgoKICAgICAgICAjICNOw6NvIGVzdMOhIGZ1bmNpb25hbmRvIGEgdmFsaWRhw6fDo28gI0ZJWE1FIFJlcG9zaXRvcnkgY3JlYXRpb24gdmVyaWZpY2F0aW9uIGlzIG5vdCB3b3JraW5nIChNb2RpZnkgdGhlIGNyZWF0ZSBSZXBvIGZ1bmN0aW9uIHRvIHZlcmlmeSB0aGUgY3JlYXRpb24pCiAgICAgICAgIyAjZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKHVzZXIgKyAnIGF0ICcgKyByZXBvc2l0b3J5KQogICAgICAgICMgaWYgbm90IEdpdEh1Yi5leGlzdHNSZXBvc2l0b3J5KHVzZXIsIHJlcG9zaXRvcnkpOgogICAgICAgICMgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiVGhlIHJlcG9zaXRvcnkgIiArIHJlcG9zaXRvcnkgKyAiIGRvZXNuJ3QgZXhpc3RzLlxuUGxlYXNlIGNyZWF0ZSBhIG5ldyBvbmUgYXQgaHR0cHM6Ly9naXRodWIuY29tL25ldyAuIikKICAgICAgICAjICAgICByZXR1cm4gTm9uZQoKICAgICAgICAjQ3JpYSBvdSBwZWdhIG8gcmVwb3NpdMOzcmlvIGF0dWFsLgogICAgICAgIHJlcG8gPSBOb25lCiAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGZvbGRlcikgb3IgKG9zLnBhdGguZXhpc3RzKGZvbGRlcikgYW5kIG5vdCBvcy5saXN0ZGlyKGZvbGRlcikpOgogICAgICAgICAgICByZXBvU2l6ZSA9IEdpdEh1Yi5nZXRSZXBvc2l0b3J5U2l6ZSh1c2VyLCByZXBvc2l0b3J5LCBwYXNzd29yZCkKICAgICAgICAgICAgaWYgcmVwb1NpemUgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICByZXBvU2l6ZSA9IHN0cihyZXBvU2l6ZSkgKyAiKGtiKSIKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJlcG9TaXplID0gJycKICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJDbG9uaW5nIGdpdCByZXBvc2l0b3J5OiAiICsgR2l0SHViLmdldEdpdFVybCh1c2VyLCByZXBvc2l0b3J5KSArICJcblBsZWFzZSB3YWl0LCBpdCB3aWxsIGRvd25sb2FkIGFsbCBtYXBzIGluIHlvdXIgcmVwb3NpdG9yeS4gIiArIHJlcG9TaXplKQogICAgICAgICAgICByZXBvID0gR2l0SW50ZXJhY3RpdmUuY2xvbmVSZXBvKHVzZXIsIHJlcG9zaXRvcnksIGZvbGRlciwgZmVlZGJhY2spI1JlcG8uY2xvbmVfZnJvbShHaXRIdWIuZ2V0R2l0VXJsKHVzZXIsIHJlcG9zaXRvcnkpLCBmb2xkZXIsIHJlY3Vyc2l2ZT1UcnVlLCBwcm9ncmVzcz1HaXRIdWIuZ2V0R2l0UHJvZ3Jlc3NSZXBvcnQoZmVlZGJhY2spKQogICAgICAgICAgICBhc3NlcnQgKG9zLnBhdGguZXhpc3RzKGZvbGRlcikpCiAgICAgICAgICAgIGFzc2VydChyZXBvKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJlcG8gPSBSZXBvKGZvbGRlcikKICAgICAgICAgICAgICAgIHJlcG9VcmwgPSByZXBvLmdpdC5yZW1vdGUoIi12IikKICAgICAgICAgICAgICAgIGV4cGVjdGVkVXJsID0gR2l0SHViLmdldEdpdFVybCh1c2VyLCByZXBvc2l0b3J5KQogICAgICAgICAgICAgICAgaWYgcmVwb1VybCBhbmQgbm90IChleHBlY3RlZFVybCBpbiByZS5jb21waWxlKCJbXFxuXFx0IF0iKS5zcGxpdChyZXBvVXJsKSk6CiAgICAgICAgICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJZb3VyIHJlbW90ZSBVUkwgIiArIHJlcG9VcmwgKyAiIGRvZXMgbm90IG1hdGNoIHRoZSBleHBlY3RlZCB1cmwgIiArIGV4cGVjdGVkVXJsKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICBleGNlcHQgSW52YWxpZEdpdFJlcG9zaXRvcnlFcnJvciBhcyBlOgogICAgICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJUaGUgZGVzdGluYXRpb24gZm9sZGVyIG11c3QgYmUgYSByZXBvc2l0b3J5IG9yIGFuIGVtcHR5IGZvbGRlci4gUmVhc29uOiAiICsgc3RyKGUpKQogICAgICAgICAgICAgICAgI3JlcG8gPSBSZXBvLmluaXQoZm9sZGVyLCBiYXJlPUZhbHNlKQogICAgICAgIHJldHVybiByZXBvCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGlzT3B0aW9uc09rKGZvbGRlciwgdXNlciwgcmVwb3NpdG9yeSwgZmVlZGJhY2ssIGdoUGFzc3dvcmQ9Tm9uZSwgbXVzdEFza1VzZXI9RmFsc2UpOgogICAgICAgIHRyeToKICAgICAgICAgICAgI0NyaWEgb3UgcGVnYSBvIHJlcG9zaXTDs3JpbyBhdHVhbC4KICAgICAgICAgICAgcmVwbyA9IEdpdEh1Yi5nZXRSZXBvc2l0b3J5KGZvbGRlciwgdXNlciwgcmVwb3NpdG9yeSwgZ2hQYXNzd29yZCwgZmVlZGJhY2spCiAgICAgICAgICAgIGlmIG5vdCByZXBvOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIEdpdEh1Yi5jb25maWdVc2VyKHJlcG8sIHVzZXIpCiAgICAgICAgICAgIGlmIHJlcG8uZ2l0LnN0YXR1cygiLS1wb3JjZWxhaW4iKToKICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gbm90IG11c3RBc2tVc2VyIG9yIFFNZXNzYWdlQm94LnF1ZXN0aW9uKE5vbmUsICJMb2NhbCByZXBvc2l0b3J5IGlzIG5vdCBjbGVhbi4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIlRoZSBmb2xkZXIgaGF2ZSBsb2NhbCBjaGFuZ2VzLCB3ZSBuZWVkIHRvIGZpeCB0byBjb250aW51ZS5cbkNsaWNrICdESVNDQVJEJyB0byBkaXNjYXJkIGNoYW5nZXMsICdZRVMnIHRvIGNvbW1pdCBjaGFuZ2VzLCBvdGhlcndpc2UgY2xpY2sgJ0NBTkNFTCcgdG8gY2FuY2VsIGFuZCByZXNvbHZlIG1hbnVhbGx5LiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXR0b25zPShRTWVzc2FnZUJveC5EaXNjYXJkIHwgUU1lc3NhZ2VCb3guWWVzIHwgUU1lc3NhZ2VCb3guQ2FuY2VsKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHRCdXR0b249UU1lc3NhZ2VCb3guRGlzY2FyZCkKICAgICAgICAgICAgICAgIGlmIG5vdCBtdXN0QXNrVXNlciBvciByZXNwb25zZSA9PSBRTWVzc2FnZUJveC5ZZXM6CiAgICAgICAgICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJQdWxsaW5nIHJlbW90ZSByZXBvc2l0b3J5IGNoYW5nZXMgdG8geW91ciBkaXJlY3RvcnkuIikKICAgICAgICAgICAgICAgICAgICBHaXRIdWIudHJ5UHVsbFJlcG9zaXRvcnkocmVwbywgdXNlciwgcmVwb3NpdG9yeSwgZmVlZGJhY2spICAjIERhbmlsbwogICAgICAgICAgICAgICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiQWRkaW5nIGFsbCBmaWxlcyBpbiBmb2xkZXIiKQogICAgICAgICAgICAgICAgICAgIEdpdEh1Yi5hZGRGaWxlcyhyZXBvLCB1c2VyLCByZXBvc2l0b3J5LCBmZWVkYmFjaykKICAgICAgICAgICAgICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkFkZGluZyBhbGwgZmlsZXMgaW4gZm9sZGVyIikKICAgICAgICAgICAgICAgICAgICBHaXRIdWIuZ2l0Q29tbWl0KHJlcG8sIG1zZz0iUUdJUyAtIEFkZGluZyBhbGwgZmlsZXMgaW4gZm9sZGVyICIgKyBkYXRldGltZS5ub3coKS5zdHJmdGltZSgiJWQvJW0vJVkgJUg6JU06JVMiKSwgZmVlZGJhY2s9ZmVlZGJhY2spCiAgICAgICAgICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJRR0lTIC0gU2VuZGluZyBjaGFuZ2VzIHRvIEdpdGh1YiIpCiAgICAgICAgICAgICAgICAgICAgIyB0cnk6CiAgICAgICAgICAgICAgICAgICAgIyAgICAgVVRJTFMucnVuTG9uZ1Rhc2socmVwby5naXQucHVsbCwgZmVlZGJhY2ssICdQZWFzZSB3YWl0LCBwdWxsaW5nIGNoYW5nZXMuJywgMzApCiAgICAgICAgICAgICAgICAgICAgIyBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgIyAgICAgcGFzcwogICAgICAgICAgICAgICAgICAgIEdpdEh1Yi5wdXNoQ2hhbmdlcyhyZXBvLCB1c2VyLCByZXBvc2l0b3J5LCBnaFBhc3N3b3JkLCBmZWVkYmFjaykKICAgICAgICAgICAgICAgIGVsaWYgcmVzcG9uc2UgPT0gUU1lc3NhZ2VCb3guRGlzY2FyZDoKICAgICAgICAgICAgICAgICAgICByZXBvLmdpdC5jbGVhbigiLWRmIikKICAgICAgICAgICAgICAgICAgICByZXBvLmdpdC5jaGVja291dCgnLS0nLCAnLicpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiRXJyb3I6IExvY2FsIHJlcG9zaXRvcnkgaXMgbm90IGNsZWFuLlxuUGxlYXNlIGNvbW1pdCB0aGUgY2hhbmdlcyBtYWRlIHRvIGxvY2FsIHJlcG9zaXRvcnkgYmVmb3JlIHJ1bi5cblVzZTogZ2l0IGFkZCAqIGFuZCBnaXQgY29tbWl0IC1tIFwiTVNHXCIiKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIEdpdEh1Yi50cnlQdWxsUmVwb3NpdG9yeShyZXBvLCB1c2VyLCByZXBvc2l0b3J5LCBmZWVkYmFjaykKICAgICAgICAgICAgICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkdpdDogQ2hlY2tpbmcgb3V0IGNoYW5nZXMuIikKICAgICAgICAgICAgICAgICAgICByZXBvLmdpdC5jaGVja291dCgnLS0nLCAnLicpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZXg6CiAgICAgICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiQ2FuY2VsZWQgZHVlIHRvOiB7MH0iLmZvcm1hdChleCkpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBmaW5kR2l0RXhlKGdpdEV4ZSwgZm91bmRfZ2l0LCBtdXN0QXNrVXNlcik6CiAgICAgICAgaWYgKG5vdCBnaXRFeGUgb3Igbm90IG9zLnBhdGguaXNmaWxlKGdpdEV4ZSkpIGFuZCAobm90ICdHSVRfUFlUSE9OX0dJVF9FWEVDVVRBQkxFJyBpbiBvcy5lbnZpcm9uIG9yIG5vdCBvcy5wYXRoLmlzZmlsZShvcy5lbnZpcm9uWydHSVRfUFlUSE9OX0dJVF9FWEVDVVRBQkxFJ10pKSBhbmQgKG5vdCBmb3VuZF9naXQgb3Igb3MucGF0aC5pc2ZpbGUoZm91bmRfZ2l0KSk6CiAgICAgICAgICAgIGdpdEV4ZSA9IEdpdEh1Yi5pbnN0YWxsX2dpdChtdXN0QXNrVXNlcikKICAgICAgICByZXR1cm4gZ2l0RXhlCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHRyeVB1bGxSZXBvc2l0b3J5KHJlcG8sIHVzZXIsIHJlcG9zaXRvcnksIGZlZWRiYWNrKToKICAgICAgICBHaXRIdWIuY29uZmlnVXNlcihyZXBvLCB1c2VyKQogICAgICAgIHRyeToKICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJHaXQ6IFB1bGxpbmcgcmVtb3RlIHJlcG9zaXRvcnkgY3VycmVudCBzdGF0ZS4iKQogICAgICAgICAgICAjIFVUSUxTLnJ1bkxvbmdUYXNrKHJlcG8uZ2l0LnB1bGwsIGZlZWRiYWNrLCAnUGVhc2Ugd2FpdCwgcHVsbGluZyBjaGFuZ2VzLicsIDMwLCAiIC1zIHJlY3Vyc2l2ZSAtWCBvdXJzICIgKyBHaXRIdWIuZ2V0R2l0VXJsKHVzZXIsIHJlcG9zaXRvcnkpICsgIm1hc3RlciIpCiAgICAgICAgICAgIFVUSUxTLnJ1bkxvbmdUYXNrKHJlcG8uZ2l0LnB1bGwsIGZlZWRiYWNrLCAnUGVhc2Ugd2FpdCwgcHVsbGluZyBjaGFuZ2VzLicsIDMwLCAiLXMiLCAicmVjdXJzaXZlIiwgIi1YIiwgIm91cnMiLCBHaXRIdWIuZ2V0R2l0VXJsKHVzZXIsIHJlcG9zaXRvcnkpLCAibWFzdGVyIikKICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJCZWZvcmUgZmV0Y2ggY2hhbmdlcy4iKQogICAgICAgICAgICBVVElMUy5ydW5Mb25nVGFzayhyZXBvLmdpdC5mZXRjaCwgZmVlZGJhY2ssICdQbGVhc2Ugd2FpdCwgZmV0Y2hpbmcgY2hhbmdlcy4nLCAzMCwgR2l0SHViLmdldEdpdFVybCh1c2VyLCByZXBvc2l0b3J5KSwgIm1hc3RlciIpCiAgICAgICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiR2l0OiBEb2luZyBjaGVja291dC4iKQogICAgICAgICAgICBVVElMUy5ydW5Mb25nVGFzayhyZXBvLmdpdC5jaGVja291dCwgZmVlZGJhY2ssICdQbGVhc2Ugd2FpdCwgZG9pbmcgY2hlY2tvdXQnLCAzMCwgIi0tb3VycyIpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGNyZWF0ZVJlcG8oZ2hSZXBvc2l0b3J5LCBnaFVzZXIsIGdoUGFzcywgZmVlZGJhY2spOgogICAgICAgIHBheWxvYWQgPSB7CiAgICAgICAgICAgICduYW1lJzogZ2hSZXBvc2l0b3J5LAogICAgICAgICAgICAnZGVzY3JpcHRpb24nOiAnUmVwb3NpdG9yeSBjb2ludGFpbmluZyBtYXBzIG9mIHRoZSBtYXBwaWEgcHVibGlzaGVyLicsCiAgICAgICAgICAgICdicmFuY2gnOiAnbWFzdGVyJywKICAgICAgICAgICAgJ2F1dG9faW5pdCc6ICd0cnVlJwogICAgICAgIH0KICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkNyZWF0aW5nIHRoZSBuZXcgcmVwb3NpdG9yeTogIiArIGdoUmVwb3NpdG9yeSkKICAgICAgICByZXNwID0gcmVxdWVzdHMucG9zdChHaXRIdWIuZ2l0aHViQXBpICsgJ3VzZXIvcmVwb3MnLCBhdXRoPShnaFVzZXIsIGdoUGFzcyksIGRhdGE9anNvbi5kdW1wcyhwYXlsb2FkKSkKICAgICAgICBpZiByZXNwLnN0YXR1c19jb2RlID09IDIwMToKICAgICAgICAgICAgc2xlZXAoMSkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgcnVuTG9uZ1Rhc2soZnVuY3Rpb24sIGZlZWRiYWNrLCB3YWl0TWVzc2FnZT0iUGxlYXNlIFdhaXQiLCBzZWNvbmRzUmVwb3J0PTYwLCAqYXJncywgKiprd0FyZ3MpOgogICAgICAgIGZyb20gY29uY3VycmVudCBpbXBvcnQgZnV0dXJlcwogICAgICAgICMgZmVlZGJhY2suc2V0UHJvZ3Jlc3MoMSkKICAgICAgICBzdGVwVGltZXIgPSAwLjUKICAgICAgICB0b3RhbFRpbWUgPSAwCiAgICAgICAgd2l0aCBmdXR1cmVzLlRocmVhZFBvb2xFeGVjdXRvcihtYXhfd29ya2Vycz0xKSBhcyBleGVjdXRvcjoKICAgICAgICAgICAgam9iID0gZXhlY3V0b3Iuc3VibWl0KGZ1bmN0aW9uLCAqYXJncywgKiprd0FyZ3MpCiAgICAgICAgICAgIGVsYXBzZWRUaW1lID0gMAogICAgICAgICAgICB3aGlsZSBqb2IuZG9uZSgpID09IEZhbHNlOgogICAgICAgICAgICAgICAgdGltZS5zbGVlcChzdGVwVGltZXIpCiAgICAgICAgICAgICAgICBlbGFwc2VkVGltZSA9IGVsYXBzZWRUaW1lICsgc3RlcFRpbWVyCiAgICAgICAgICAgICAgICB0b3RhbFRpbWUgPSB0b3RhbFRpbWUgKyBzdGVwVGltZXIKICAgICAgICAgICAgICAgIGlmIGVsYXBzZWRUaW1lID4gc2Vjb25kc1JlcG9ydDoKICAgICAgICAgICAgICAgICAgICBjYW5jZWxNc2cgPSAiXG5DYW5jZWxsaW5nLCBwbGVhc2Ugd2FpdCB0aGUgY3VycmVudCBzdGVwIHRvIGZpbmlzaCBncmFjZWZ1bGx5LiIgaWYgZmVlZGJhY2suaXNDYW5jZWxlZCgpIGVsc2UgJycKICAgICAgICAgICAgICAgICAgICBmZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkVsYXBzZWQgIiArIHN0cihyb3VuZCh0b3RhbFRpbWUpKSArICJzOiAiICsgd2FpdE1lc3NhZ2UgKyBjYW5jZWxNc2cpCiAgICAgICAgICAgICAgICAgICAgZWxhcHNlZFRpbWUgPSAwCiAgICAgICAgICAgICAgICAjIGlmIGNhbkNhbmNlbE5vdyBhbmQgZmVlZGJhY2suaXNDYW5jZWxlZCgpOgogICAgICAgICAgICAgICAgIyAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJKb2Igc3RhcnRpbmcgdG8gY2FuY2VsLiIpCiAgICAgICAgICAgICAgICAjICAgICBqb2IuY2FuY2VsKCkKICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJFbGFwc2VkICIgKyBzdHIocm91bmQodG90YWxUaW1lKSkgKyAicyBvbiB0aGlzIHN0ZXAuIikKICAgICAgICAgICAgIyBVVElMUy5jaGVja0ZvckNhbmNlbGVkKGZlZWRiYWNrKQogICAgICAgICAgICByZXR1cm4gam9iLnJlc3VsdCgpCgoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRHaXRDcmVkZW50aWFscyhjdXJVc2VyLCBjdXJQYXNzLCBtdXN0QXNrVXNlcik6CiAgICAgICAgc3RhdGUgPSBVVElMUy5yYW5kb21TdHJpbmcoKQogICAgICAgIGlmIChub3QgY3VyVXNlcik6CiAgICAgICAgICAgIGN1clVzZXIgPSAnJwogICAgICAgIGlmIChjdXJQYXNzIGlzIE5vbmUgb3Igbm90IGN1clBhc3Mgb3Igbm90IGN1clVzZXIpIG9yIChHaXRIdWIudGVzdExvZ2luKGN1clVzZXIsIGN1clBhc3MpID09IEZhbHNlIGFuZCAobXVzdEFza1VzZXIgb3IgUU1lc3NhZ2VCb3gucXVlc3Rpb24oCiAgICAgICAgICAgICAgICBOb25lLCAiQ3JlZGVudGlhbHMgcmVxdWlyZWQiLCAiUGxlYXNlIGluZm9ybSB5b3VyIGNyZWRlbnRpYWxzLCBjb3VsZCB3ZSBvcGVuIGxvZ2luIGxpbmsgZm9yIHlvdT8iKSA9PSBRTWVzc2FnZUJveC5ZZXMpKToKICAgICAgICAgICAgdXJsID0gJ2h0dHBzOi8vZ2l0aHViLmNvbS9sb2dpbi9vYXV0aC9hdXRob3JpemU/cmVkaXJlY3RfdXJpPWh0dHBzOi8vY3NyLnVmbWcuYnIvaW1hZ2VyeS9nZXRfa2V5LnBocCZjbGllbnRfaWQ9MTBiMjhhMzg4YjBlNjZlODdjZWUmbG9naW49JyArIGN1clVzZXIgKyAnJnNjb3BlPXJlYWQ6dXNlciUyMHJlcG8mc3RhdGU9JyArIHN0YXRlCiAgICAgICAgICAgIGNyZWRlbnRpYWxzID0gewogICAgICAgICAgICAgICAgJ3ZhbHVlJzogTm9uZQogICAgICAgICAgICB9CiAgICAgICAgICAgIEdpdEh1Yi5nZXRDcmVkZW50aWFscyhzdGF0ZSkKICAgICAgICAgICAgd2ViYnJvd3Nlci5vcGVuKHVybCwgMSkKICAgICAgICAgICAgaXNGaXJzdE9wZW4gPSBUcnVlCiAgICAgICAgICAgIGRlZiBjaGVja0xvZ2luVmFsaWRhdGlvbihidG4sIHRpbWVTcGVudCk6CiAgICAgICAgICAgICAgICBjcmVkZW50aWFsc1sndmFsdWUnXSA9IGNyZWRlbnRpYWxzWyd2YWx1ZSddIG9yIEdpdEh1Yi5nZXRDcmVkZW50aWFscyhzdGF0ZSkKICAgICAgICAgICAgICAgIGlmIGNyZWRlbnRpYWxzWyd2YWx1ZSddIGFuZCBub3QgbXVzdEFza1VzZXI6CiAgICAgICAgICAgICAgICAgICAgYnRuLmRvbmUoMCkKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIHdoaWxlIG5vdCBjcmVkZW50aWFsc1sndmFsdWUnXToKICAgICAgICAgICAgICAgIHNsZWVwKDEpCiAgICAgICAgICAgICAgICBhdXhNc2cgPSAnJyBpZiBpc0ZpcnN0T3BlbiBlbHNlICdcblxuV2FpdGluZyB2YWxpZGF0aW9uLCByZS1vcGVubmluZyB0aGUgYXV0aG9yaXphdGlvbiBnaXRodWIgcGFnZS5cblBsZWFzZSBsb2dpbiBvbiBhIEdpdGh1YiBhY2NvdW50IHRvIGNvbnRpbnVlLicKICAgICAgICAgICAgICAgIGlzRmlyc3RPcGVuID0gRmFsc2UKICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gQ3VzdG9tTWVzc2FnZUJveC5zaG93V2l0aENhbGxiYWNrKDIwMDAsCiAgICAgICAgICAgICAgICAgICAgICAiU3RlcHMgdG8gY29uZmlybSB5b3VyIGNyZWRlbnRpYWxzOlxuMSkgRW50ZXIgY3JlZGVudGlhbHNcbjIpIGNsaWNrIHRvICdhdXRob3JpemUgTWFwcGlhJyBcbjMpIFdhaXQgYW5kIENsaWNrICdZRVMnIHRvIGNvbmZpcm0uXG4gT3IgJ05PJyB0byBjYW5jZWwuXG5PcGVubmluZyB0aGUgZ2l0aHViIGF1dGhlbnRpY2F0aW9uIGxpbmsgaW4gYnJvd3Nlci4iICsgYXV4TXNnLAogICAgICAgICAgICAgICAgICAgICAgIlBsZWFzZSBjb25maXJtIGNyZWRlbnRpYWxzIGF0IEdpdGh1YiBzaXRlIHRvIGNvbnRpbnVlIiwgY2hlY2tMb2dpblZhbGlkYXRpb24sIGJ1dHRvbnM9UU1lc3NhZ2VCb3guWWVzIHwgUU1lc3NhZ2VCb3guTm8pCiAgICAgICAgICAgICAgICBjcmVkZW50aWFsc1sndmFsdWUnXSA9IGNyZWRlbnRpYWxzWyd2YWx1ZSddIG9yIEdpdEh1Yi5nZXRDcmVkZW50aWFscyhzdGF0ZSkKICAgICAgICAgICAgICAgIGlmIHJlc3BvbnNlID09IFFNZXNzYWdlQm94LlllcyBhbmQgbm90IGNyZWRlbnRpYWxzWyd2YWx1ZSddOgogICAgICAgICAgICAgICAgICAgIHdlYmJyb3dzZXIub3Blbih1cmwsIDIpCiAgICAgICAgICAgICAgICBlbGlmIHJlc3BvbnNlICE9IFFNZXNzYWdlQm94LlllcyBhbmQgbm90IGNyZWRlbnRpYWxzWyd2YWx1ZSddOgogICAgICAgICAgICAgICAgICAgIHJldHVybiAoTm9uZSwgTm9uZSkKICAgICAgICAgICAgcmV0dXJuIChjcmVkZW50aWFsc1sndmFsdWUnXVsndXNlciddLCBjcmVkZW50aWFsc1sndmFsdWUnXVsndG9rZW4nXSkKICAgICAgICByZXR1cm4gKGN1clVzZXIsIGN1clBhc3MpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGFkZEZpbGVzKHJlcG8sIHVzZXIsIHJlcG9zaXRvcnksIGZlZWRiYWNrKToKICAgICAgICByZXR1cm4gR2l0SW50ZXJhY3RpdmUuYWRkRmlsZXMocmVwbywgdXNlciwgcmVwb3NpdG9yeSwgZmVlZGJhY2spCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdpdENvbW1pdChyZXBvLCBtc2csIGZlZWRiYWNrKToKICAgICAgICByZXR1cm4gR2l0SW50ZXJhY3RpdmUuZ2l0Q29tbWl0KHJlcG8sIG1zZywgZmVlZGJhY2spCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHB1c2hDaGFuZ2VzKHJlcG8sIHVzZXIsIHJlcG9zaXRvcnksIHBhc3N3b3JkLCBmZWVkYmFjayk6CiAgICAgICAgcmV0dXJuIEdpdEludGVyYWN0aXZlLnB1c2hDaGFuZ2VzKHJlcG8sIHVzZXIsIHJlcG9zaXRvcnksIHBhc3N3b3JkLCBmZWVkYmFjaykKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgcHVibGlzaFRpbGVzVG9HaXRIdWIoZm9sZGVyLCB1c2VyLCByZXBvc2l0b3J5LCBmZWVkYmFjaywgdmVyc2lvbiwgcGFzc3dvcmQ9Tm9uZSk6CiAgICAgICAgaW1wb3J0IGdpdAogICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygnR2l0aHViIGZvdW5kIGNvbW1pdGluZyB0byB5b3VyIGFjY291bnQuJykKCiAgICAgICAgcmVwbyA9IEdpdEh1Yi5nZXRSZXBvc2l0b3J5KGZvbGRlciwgdXNlciwgcmVwb3NpdG9yeSwgcGFzc3dvcmQsIGZlZWRiYWNrKQoKICAgICAgICBub3cgPSBkYXRldGltZS5ub3coKQogICAgICAgICMgaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNjU2NTM1Ny9naXQtcHVzaC1yZXF1aXJlcy11c2VybmFtZS1hbmQtcGFzc3dvcmQKICAgICAgICByZXBvLmdpdC5jb25maWcoImNyZWRlbnRpYWwuaGVscGVyIiwgIiAiLCAic3RvcmUiKQogICAgICAgIEdpdEh1Yi50cnlQdWxsUmVwb3NpdG9yeShyZXBvLCB1c2VyLCByZXBvc2l0b3J5LCBmZWVkYmFjaykgI0RhbmlsbwogICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygnR2l0OiBBZGQgYWxsIGdlbmVyYXRlZCB0aWxlcyB0byB5b3VyIHJlcG9zaXRvcnkuJykKICAgICAgICBHaXRIdWIuYWRkRmlsZXMocmVwbywgdXNlciwgcmVwb3NpdG9yeSwgZmVlZGJhY2spCiAgICAgICAgI2ZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiR2l0OiBNZXJnaW4uIikKICAgICAgICAjcmVwby5naXQubWVyZ2UoIi1zIHJlY3Vyc2l2ZSIsICItWCBvdXJzIikKICAgICAgICAjZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJHaXQ6IFB1c2hpbmcgY2hhbmdlcy4iKQogICAgICAgICNyZXBvLmdpdC5wdXNoKEdpdEh1Yi5nZXRHaXRVcmwodXNlciwgcmVwb3NpdG9yeSksICJtYXN0ZXI6cmVmcy9oZWFkcy9tYXN0ZXIiKQogICAgICAgIGlmIHJlcG8uaW5kZXguZGlmZihOb25lKSBvciByZXBvLnVudHJhY2tlZF9maWxlczoKICAgICAgICAgICAgZmVlZGJhY2sucHVzaENvbnNvbGVJbmZvKCJObyBjaGFuZ2VzLCBub3RoaW5nIHRvIGNvbW1pdC4iKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiR2l0OiBDb21taXR0aW5nIGNoYW5nZXMuIC0tLS0tLS0tLS0tLS0yIikKICAgICAgICB0cnk6CiAgICAgICAgICAgIEdpdEh1Yi5naXRDb21taXQocmVwbywgIlFHSVMgLSAiICsgbm93LnN0cmZ0aW1lKCIlZC8lbS8lWSAlSDolTTolUyIpICsgIiB2ZXJzaW9uOiAiICsgdmVyc2lvbiwgZmVlZGJhY2spCiAgICAgICAgZXhjZXB0IGdpdC5leGMuR2l0Q29tbWFuZEVycm9yIGFzIGU6CiAgICAgICAgICAgIHByaW50KCJXYXJuaW5nOiByZWFzb24gIiArIHN0cihlKSkKICAgICAgICAjIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiQ1JFQVRJTkcgVEFHIikKICAgICAgICAjIHRhZyA9IG5vdy5zdHJmdGltZSgiJVklbSVkLSVIJU0lUyIpCiAgICAgICAgIyBuZXdfdGFnID0gcmVwby5jcmVhdGVfdGFnKHRhZywgbWVzc2FnZT0nQXV0b21hdGljIHRhZyAiezB9IicuZm9ybWF0KHRhZykpCiAgICAgICAgIyByZXBvLnJlbW90ZXNbb3JpZ2luTmFtZV0ucHVzaChuZXdfdGFnKQogICAgICAgIGZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiR2l0OiBQdXNoaW5nIG1vZGlmaWNhdGlvbnMgdG8gcmVtb3RlIHJlcG9zaXRvcnkuIikKICAgICAgICBHaXRIdWIucHVzaENoYW5nZXMocmVwbywgdXNlciwgcmVwb3NpdG9yeSwgcGFzc3dvcmQsIGZlZWRiYWNrKQogICAgICAgIHJldHVybiBOb25lCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldENyZWRlbnRpYWxzKHNlY3JldCk6CiAgICAgICAgI0RhbmlsbyAjRklYTUUgY29sb2NhciBVTklRVUUgbm8gQkQKICAgICAgICByZXNwID0gcmVxdWVzdHMuZ2V0KCdodHRwczovL2Nzci51Zm1nLmJyL2ltYWdlcnkvdmVyaWZ5X2tleS5waHA/c3RhdGU9JyArIHNlY3JldCkKICAgICAgICBpZiByZXNwLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgcmV0dXJuIGpzb24ubG9hZHMocmVzcC50ZXh0KQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgIyBAc3RhdGljbWV0aG9kCiAgICAjIGRlZiBnZXRBY2Nlc3NUb2tlbihjdXJVc2VyLCBjdXJQYXNzKToKICAgICMgICAgIGRlZiBpc05vdFRva2VuKGNvbnRlbnQpOgogICAgIyAgICAgICAgIHJldHVybiBub3QgcmUubWF0Y2gocideW2EtejAtOV17NDB9JCcsIGNvbnRlbnQpCiAgICAjICAgICAjIGRlZiBjcmVhdGVUb2tlbkZyb21QYXNzKHVzZXIsIHBhc3N3b3JkKToKICAgICMgICAgICMgICAgIHBhcmFtcyA9IHsKICAgICMgICAgICMgICAgICAgICAic2NvcGVzIjogWyJyZXBvIiwgIndyaXRlOm9yZyJdLAogICAgIyAgICAgIyAgICAgICAgICJub3RlIjogIk1hcHBpYSBBY2Nlc3MgKCIgKyBzdHIocmFuZG9tLnVuaWZvcm0oMCwgMSkgKiAxMDAwMDApICsgIikiCiAgICAjICAgICAjICAgICB9CiAgICAjICAgICAjICAgICByZXNwID0gcmVxdWVzdHMucG9zdCh1cmw9R2l0SHViLmdpdGh1YkFwaSArICdhdXRob3JpemF0aW9ucycsIGhlYWRlcnM9eydjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbid9LCBhdXRoPSh1c2VyLCBwYXNzd29yZCksIGRhdGE9anNvbi5kdW1wcyhwYXJhbXMpKQogICAgIyAgICAgIyAgICAgaWYgcmVzcC5zdGF0dXNfY29kZSA9PSBIVFRQU3RhdHVzLkNSRUFURUQ6CiAgICAjICAgICAjICAgICAgICAgcmV0dXJuIGpzb24ubG9hZHMocmVzcC50ZXh0KVsidG9rZW4iXQogICAgIyAgICAgIyAgICAgZWxpZiByZXNwLnN0YXR1c19jb2RlID09IEhUVFBTdGF0dXMuVU5QUk9DRVNTQUJMRV9FTlRJVFk6CiAgICAjICAgICAjICAgICAgICAgI2RldmVyaWEgdGVudGFyIG1haXMgdW1hIHZlegogICAgIyAgICAgIyAgICAgICAgIHJldHVybiBOb25lCiAgICAjICAgICAjICAgICBlbGlmIHJlc3Auc3RhdHVzX2NvZGUgPT0gSFRUUFN0YXR1cy5VTkFVVEhPUklaRUQ6CiAgICAjICAgICAjICAgICAgICAgUU1lc3NhZ2VCb3gud2FybmluZyhOb25lLCAiTWFwcGlhIFB1Ymxpc2hlciBFcnJvciIsICJGYWlsZWQgdG8gbG9naW4sIHBsZWFzZSBjaGVjayBpZiB0aGUgZW50ZXJlZCB1c2VybmFtZS9wYXNzd29yZCBpcyB2YWxpZCBhdCAoaHR0cHM6Ly9naXRodWIuY29tL2xvZ2luKSIpCiAgICAjICAgICAjICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJFcnJvcjogRmFpbGVkIHRvIGxvZ2luLCBwbGVhc2UgVmVyaWZ5IHRoZSBlbnRlcmVkIHVzZXJuYW1lL3Bhc3N3b3JkLiIpCiAgICAjICAgICAjICAgICBlbHNlOgogICAgIyAgICAgIyAgICAgICAgIFFNZXNzYWdlQm94Lndhcm5pbmcoTm9uZSwgIk1hcHBpYSBQdWJsaXNoZXIgRXJyb3IiLCAiRmFpbGVkIHRvIGNyZWF0ZSBhIG5ldyB0b2tlbi4gUmVzcG9uc2UgY29kZTogIiArIHN0cihyZXNwLnN0YXR1c19jb2RlKSArICIgQ29udGVudDogIiArIHN0cihyZXNwLnRleHQpKQogICAgIyAgICAgIyAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiRXJyb3I6IEZhaWxlZCB0byBjcmVhdGUgdG9rZW4uIFJlc3BvbnNlIGNvZGU6ICIgKyBzdHIocmVzcC5zdGF0dXNfY29kZSkgKyAiIENvbnRlbnQ6ICIgKyBzdHIocmVzcC50ZXh0KSkKICAgICMgICAgIGZvdW5kVG9rZW4gPSBOb25lCiAgICAjICAgICBpZiBub3QgR2l0SHViLnRlc3RMb2dpbihjdXJVc2VyLCBjdXJQYXNzKToKICAgICMgICAgICAgICBRTWVzc2FnZUJveC53YXJuaW5nKE5vbmUsICJNYXBwaWEgUHVibGlzaGVyIEVycm9yIiwKICAgICMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJGYWlsZWQgdG8gbG9naW4sIHBsZWFzZSBjaGVjayBpZiB0aGUgZW50ZXJlZCB1c2VybmFtZS9wYXNzd29yZCBpcyB2YWxpZCBhdCAoaHR0cHM6Ly9naXRodWIuY29tL2xvZ2luKSIpCiAgICAjICAgICAgICAgRXhjZXB0aW9uKCJFcnJvcjogRmFpbGVkIHRvIGxvZ2luLiIpCiAgICAjICAgICAgICAgZm91bmRUb2tlbiA9IE5vbmUKICAgICMgICAgIGVsaWYgbm90IGlzTm90VG9rZW4oY3VyUGFzcykgYW5kIEdpdEh1Yi50ZXN0TG9naW4oY3VyVXNlciwgY3VyUGFzcyk6CiAgICAjICAgICAgICAgZm91bmRUb2tlbiA9IGN1clBhc3MKICAgICMgICAgIGVsaWYgR2l0SHViLnBlcnNvbmFsX3Rva2VuIGFuZCBub3QgaXNOb3RUb2tlbihHaXRIdWIucGVyc29uYWxfdG9rZW4pIGFuZCBHaXRIdWIudGVzdExvZ2luKGN1clVzZXIsIEdpdEh1Yi5wZXJzb25hbF90b2tlbik6CiAgICAjICAgICAgICAgZm91bmRUb2tlbiA9IEdpdEh1Yi5wZXJzb25hbF90b2tlbgogICAgIyAgICAgIyBlbGlmIFFNZXNzYWdlQm94LnF1ZXN0aW9uKE5vbmUsICJLZXkgcmVxdWlyZWQgaW5zdGVhZCBvZiBwYXNzd29yZC4iLCAiV2FudCB0aGUgbWFwcGlhIHRvIGF1dG9tYXRpY2FsbHkgY3JlYXRlIGEga2V5IGZvciB5b3U/IE90aGVyd2lzZSBwbGVhc2UgYWNjZXNzIHRoZSBsaW5rOiBodHRwczovL2dpdGh1Yi5jb20vc2V0dGluZ3MvdG9rZW5zIHRvIGNyZWF0ZSB0aGUga2V5LiIsIGRlZmF1bHRCdXR0b249UU1lc3NhZ2VCb3guWWVzKSA9PSBRTWVzc2FnZUJveC5ZZXM6CiAgICAjICAgICAjICAgICByZXRyaWVzID0gMQogICAgIyAgICAgIyAgICAgdG9rZW4gPSBOb25lCiAgICAjICAgICAjICAgICB3aGlsZSB0b2tlbiBpcyBOb25lIGFuZCByZXRyaWVzIDw9IDU6CiAgICAjICAgICAjICAgICAgICAgdG9rZW4gPSBjcmVhdGVUb2tlbkZyb21QYXNzKGN1clVzZXIsIGN1clBhc3MpCiAgICAjICAgICAjICAgICAgICAgcmV0cmllcyA9IHJldHJpZXMgKyAxCiAgICAjICAgICAjICAgICBpZiB0b2tlbiBpcyBOb25lOgogICAgIyAgICAgIyAgICAgICAgIGlmIFFNZXNzYWdlQm94LnF1ZXN0aW9uKE5vbmUsICJUaGUgdG9rZW4gY3JlYXRpb24gaGF2ZSBmYWlsZWQuIFdhbnQgdG8gb3BlbiB0aGUgY3JlYXRpb24gbGluaz8iLCBkZWZhdWx0QnV0dG9uPVFNZXNzYWdlQm94LlllcykgPT0gUU1lc3NhZ2VCb3guWWVzOgogICAgIyAgICAgIyAgICAgICAgICAgICB3ZWJicm93c2VyLm9wZW5fbmV3KCdodHRwczovL2dpdGh1Yi5jb20vc2V0dGluZ3MvdG9rZW5zJykKICAgICMgICAgICMgICAgICAgICByYWlzZSBFeGNlcHRpb24oIkVycm9yOiBTb21ldGhpbmcgZ29lcyB3cm9uZyBjcmVhdGluZyB0aGUgdG9rZW4uIE9wZW5pbmcgdGhlIGJyb3dzZXIsIHBsZWFzZSBjcmVhdGUgeW91ciB0b2tlbiBtYW51YWxseSBhdCBodHRwczovL2dpdGh1Yi5jb20vc2V0dGluZ3MvdG9rZW5zIGFuZCBlbmFibGUgZW5hYmxlIHRoZSBzY29wZSBncm91cCAncmVwbycuIFBsZWFzZSBjb3B5IHRoZSByZXN1bHRpbmcgdGV4dC4iKQogICAgIyAgICAgIyAgICAgR2l0SHViLnBlcnNvbmFsX3Rva2VuID0gdG9rZW4KICAgICMgICAgICMgICAgIFFNZXNzYWdlQm94Lndhcm5pbmcoTm9uZSwgIkluZm9ybWF0aW9uIiwgIkNyZWF0ZWQgdGhlIGZvbGxvd2luZyB0b2tlbiwgcGxlYXNlIGNvcHkgaXQgdG8gdXNlIGxhdGVyICciICsgdG9rZW4gKyAiJy4iKQogICAgIyAgICAgIyAgICAgZm91bmRUb2tlbiA9IHRva2VuCiAgICAjICAgICBlbHNlOgogICAgIyAgICAgICAgIGZvdW5kVG9rZW4gPSBOb25lCiAgICAjICAgICByZXR1cm4gZm91bmRUb2tlbgoKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgX3JlcXVlc3QoKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICB3aXRoX2F1dGggPSBrd2FyZ3MucG9wKCJ3aXRoX2F1dGgiLCBUcnVlKQogICAgICAgIHRva2VuID0ga3dhcmdzLnBvcCgidG9rZW4iLCAnJykKICAgICAgICBpZiBub3QgdG9rZW46CiAgICAgICAgICAgIHRva2VuID0gb3MuZW52aXJvbi5nZXQoIkdJVEhVQl9UT0tFTiIsIE5vbmUpCiAgICAgICAgaWYgdG9rZW4gYW5kIHdpdGhfYXV0aDoKICAgICAgICAgICAga3dhcmdzWyJhdXRoIl0gPSAodG9rZW4sICd4LW9hdXRoLWJhc2ljJykKICAgICAgICBmb3IgXyBpbiByYW5nZSgzKToKICAgICAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0KCphcmdzLCAqKmt3YXJncykKICAgICAgICAgICAgaXNfdHJhdmlzID0gb3MuZ2V0ZW52KCJUUkFWSVMiLCBOb25lKSBpcyBub3QgTm9uZQogICAgICAgICAgICBpZiBpc190cmF2aXMgYW5kIDQwMCA8PSByZXNwb25zZS5zdGF0dXNfY29kZSA8IDUwMDoKICAgICAgICAgICAgICAgIHByaW50KCJSZXRyeWluZyBpbiAxcyAoJXMgQ2xpZW50IEVycm9yOiAlcyBmb3IgdXJsOiAlcykiICUgKAogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLnN0YXR1c19jb2RlLCByZXNwb25zZS5yZWFzb24sIHJlc3BvbnNlLnVybCkpCiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKDEpCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBicmVhawogICAgICAgIHJldHVybiByZXNwb25zZQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfcmVjdXJzaXZlX2doX2dldChocmVmLCBpdGVtcywgcGFzc3dvcmQ9Tm9uZSk6CiAgICAgICAgIiIiUmVjdXJzaXZlbHkgZ2V0IGxpc3Qgb2YgR2l0SHViIG9iamVjdHMuCgogICAgICAgIFNlZSBodHRwczovL2RldmVsb3Blci5naXRodWIuY29tL3YzL2d1aWRlcy90cmF2ZXJzaW5nLXdpdGgtcGFnaW5hdGlvbi8KICAgICAgICAiIiIKICAgICAgICByZXNwb25zZSA9IEdpdEh1Yi5fcmVxdWVzdCgnR0VUJywgaHJlZiwgdG9rZW49cGFzc3dvcmQpCiAgICAgICAgcmVzcG9uc2UucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgICAgaXRlbXMuZXh0ZW5kKHJlc3BvbnNlLmpzb24oKSkKICAgICAgICBpZiAibGluayIgbm90IGluIHJlc3BvbnNlLmhlYWRlcnM6CiAgICAgICAgICAgIHJldHVybgogICAgICAgICMgbGlua3MgPSBsaW5rX2hlYWRlci5wYXJzZShyZXNwb25zZS5oZWFkZXJzWyJsaW5rIl0pCiAgICAgICAgIyByZWxzID0ge2xpbmsucmVsOiBsaW5rLmhyZWYgZm9yIGxpbmsgaW4gbGlua3MubGlua3N9CiAgICAgICAgIyBpZiAibmV4dCIgaW4gcmVsczoKICAgICAgICAjICAgICBnaFJlbGVhc2UuX3JlY3Vyc2l2ZV9naF9nZXQocmVsc1sibmV4dCJdLCBpdGVtcykKCiAgICAjUmV0dXJuIGEgbGlzdCBvZiBhc3NldHMgaW4gY29tbWl0ICdyZWxlYXNlTmFtZScgd2l0aGluIHRoaXMgcmVwb3NpdG9yeS4KICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRBc3NldHModXNlciwgcmVwb3NpdG9yeSwgcGFzc3dvcmQsIHRhZ05hbWUpOgogICAgICAgIHJlbGVhc2UgPSBHaXRIdWIuZ2V0UmVsZWFzZSh1c2VyLCByZXBvc2l0b3J5LCBwYXNzd29yZCwgdGFnTmFtZSkKICAgICAgICBpZiBub3QgcmVsZWFzZToKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCdSZWxlYXNlIHdpdGggdGFnX25hbWUgezB9IG5vdCBmb3VuZCcuZm9ybWF0KHRhZ05hbWUpKQogICAgICAgIGFzc2V0cyA9IFtdCiAgICAgICAgR2l0SHViLl9yZWN1cnNpdmVfZ2hfZ2V0KEdpdEh1Yi5naXRodWJBcGkgKyAncmVwb3MvezB9L3JlbGVhc2VzL3sxfS9hc3NldHMnLmZvcm1hdCgKICAgICAgICAgICAgdXNlciArICIvIiArIHJlcG9zaXRvcnksIHJlbGVhc2VbImlkIl0pLCBhc3NldHMsIHBhc3N3b3JkKQogICAgICAgIHJldHVybiBhc3NldHMKCiAgICAjSWYgZXhpc3RzIGdldCB0aGUgcmVsZWFzZSB3aXRoIG5hbWUgJ3JlbGVhc2VOYW1lJy4KICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRSZWxlYXNlKHVzZXIsIHJlcG9zaXRvcnksIHBhc3N3b3JkLCB0YWdOYW1lKToKICAgICAgICBkZWYgX2dldFJlbGVhc2UoaHJlZiwgcGFzc3dvcmQsIHRhZ05hbWUpOgogICAgICAgICAgICByZWxlYXNlUmVzcCA9IEdpdEh1Yi5fcmVxdWVzdCgnR0VUJywgaHJlZiwgdG9rZW49cGFzc3dvcmQpCiAgICAgICAgICAgIHJlbGVhc2VSZXNwLnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICAgICAgICByZXN1bHQgPSBOb25lCiAgICAgICAgICAgIGZvciBjdXJSZXNwIGluIHJlbGVhc2VSZXNwLmpzb24oKToKICAgICAgICAgICAgICAgIGlmIChjdXJSZXNwIGFuZCAoY3VyUmVzcFsndGFnX25hbWUnXSA9PSB0YWdOYW1lKSk6CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gY3VyUmVzcAogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGlmIHJlc3VsdCBpcyBOb25lIGFuZCAnbGluaycgaW4gcmVsZWFzZVJlc3AuaGVhZGVyczoKICAgICAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiUGxlYXNlIHJlcG9ydDogbm90IGltcGxlbWVudGVkIHlldC4iICsganNvbi5kdW1wcyhyZWxlYXNlUmVzcC5oZWFkZXJzWyJsaW5rIl0pKQogICAgICAgICMgaWYgJ2xpbmsnIGluIHJlbGVhc2VSZXNwLmhlYWRlcnM6ICNEYW5pbG8gcHJlY2lzYSBpbXBsZW1lbnRhciBhaW5kYQogICAgICAgICNhZGQgcmVzcCB0byBjdXJSZXNwLgogICAgICAgICMgICAgICMgbGlua3MgPSBsaW5rX2hlYWRlci5wYXJzZShyZXNwb25zZS5oZWFkZXJzWyJsaW5rIl0pCiAgICAgICAgIyAgICAgIyByZWxzID0ge2xpbmsucmVsOiBsaW5rLmhyZWYgZm9yIGxpbmsgaW4gbGlua3MubGlua3N9CiAgICAgICAgIyAgICAgIyBpZiAibmV4dCIgaW4gcmVsczoKICAgICAgICAjICAgICAjICAgICBnaFJlbGVhc2UuX3JlY3Vyc2l2ZV9naF9nZXQocmVsc1sibmV4dCJdLCBpdGVtcywgdG9rZW4pCiAgICAgICAgIyAgICAgIyBEYW5pbG8gcHJlY2lzbyBmYXplciBvIHBhcnNlCiAgICAgICAgICAgIHJldHVybiByZXN1bHQKICAgICAgICByZXR1cm4gX2dldFJlbGVhc2UoR2l0SHViLmdpdGh1YkFwaSArICdyZXBvcy8nICsgdXNlciArICIvIiArIHJlcG9zaXRvcnkgKyAiL3JlbGVhc2VzIiwgcGFzc3dvcmQsIHRhZ05hbWUpCgogICAgI0NyZWF0ZSB0aGUgZG93bmxvYWQgdGFnIG9yIHJlcG9ydCBhIGVycm9yLgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGNyZWF0ZURvd25sb2FkVGFnKHVzZXIsIHJlcG9zaXRvcnksIHBhc3N3b3JkLCBmZWVkYmFjayk6CiAgICAgICAgZGF0YSA9IHsKICAgICAgICAgICAgJ3RhZ19uYW1lJzogR2l0SHViLnJlbGVhc2VOYW1lLAogICAgICAgICAgICAnbmFtZSc6IEdpdEh1Yi5yZWxlYXNlTmFtZSwKICAgICAgICAgICAgJ2JvZHknOiBHaXRIdWIucmVsZWFzZU5hbWUsCiAgICAgICAgICAgICdkcmFmdCc6IEZhbHNlLAogICAgICAgICAgICAncHJlcmVsZWFzZSc6IEZhbHNlCiAgICAgICAgfQogICAgICAgIHJlc3BvbnNlID0gR2l0SHViLl9yZXF1ZXN0KCdQT1NUJywgR2l0SHViLmdpdGh1YkFwaSArICdyZXBvcy8nICsgdXNlciArICIvIiArIHJlcG9zaXRvcnkgKyAiL3JlbGVhc2VzIiwgdG9rZW49cGFzc3dvcmQsIGRhdGE9anNvbi5kdW1wcyhkYXRhKSwgaGVhZGVycz17J0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ30pCiAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDQyMikgYW5kIEdpdEh1Yi5nZXRSZWxlYXNlKHVzZXIsIHJlcG9zaXRvcnksIHBhc3N3b3JkLCBHaXRIdWIucmVsZWFzZU5hbWUpIGlzIG5vdCBOb25lOiAjdm91IGNvbnNpZGVyYXIgcSBqYSBlc3TDoSBjcmlhZG8KICAgICAgICAgICAgcGFzcwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJlc3BvbnNlLnJhaXNlX2Zvcl9zdGF0dXMoKQoKICAgICNUcnkgdG8gYWRkIHRoZSAndXBsb2FkRmlsZScgYXMgYSBsYXllciBhc3NldC4KICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBhZGRSZWxlYXNlRmlsZSh1c2VyLCBwYXNzd29yZCwgcmVwb3NpdG9yeSwgbWF4UmV0cnksIGZvcmNlVXBkYXRlRmlsZSwgdXBsb2FkRmlsZSwgbGF5ZXIsIGZlZWRiYWNrKToKICAgICAgICBpZiB1cGxvYWRGaWxlIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgcmVsZWFzZVJlZiA9IEdpdEh1Yi5nZXRSZWxlYXNlKHVzZXIsIHJlcG9zaXRvcnksIHBhc3N3b3JkLCBHaXRIdWIucmVsZWFzZU5hbWUpCgogICAgICAgIGlmIHJlbGVhc2VSZWYgaXMgTm9uZSBvciByZWxlYXNlUmVmWyd1cGxvYWRfdXJsJ10gaXMgTm9uZToKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJSZWxlYXNlICciICsgR2l0SHViLnJlbGVhc2VOYW1lICsgIicgd2FzIG5vdCBmb3VuZCIpCiAgICAgICAgYXNzZXRzID0gR2l0SHViLmdldEFzc2V0cyh1c2VyLCByZXBvc2l0b3J5LCBwYXNzd29yZCwgR2l0SHViLnJlbGVhc2VOYW1lKQogICAgICAgIHVwbG9hZFVybCA9IHJlbGVhc2VSZWZbJ3VwbG9hZF91cmwnXQogICAgICAgIGlmICJ7IiBpbiB1cGxvYWRVcmw6CiAgICAgICAgICAgIHVwbG9hZFVybCA9IHVwbG9hZFVybFs6dXBsb2FkVXJsLmluZGV4KCJ7IildCiAgICAgICAgYmFzZW5hbWUgPSBVVElMUy5ub3JtYWxpemVOYW1lKG9zLnBhdGguYmFzZW5hbWUobGF5ZXIubmFtZSgpKSkgKyBzdHIob3MucGF0aC5zcGxpdGV4dCh1cGxvYWRGaWxlKVsxXSkKICAgICAgICAjRXhhbXBsZTogIydodHRwczovL2dpdGh1Yi5jb20vYXNmaXhpYS9NYXBwaWFfRXhhbXBsZV90L3JlbGVhc2VzL2Rvd25sb2FkL01hcF9Eb3dubG9hZC9kaXN0YW5jZV90b19kZWZvcmVzdGVkLnRpZicKICAgICAgICBmaWxlRG93bmxvYWRQYXRoID0gJ2h0dHBzOi8vZ2l0aHViLmNvbS8nICsgdXNlciArICIvIiArIHJlcG9zaXRvcnkgKyAiL3JlbGVhc2VzL2Rvd25sb2FkLyIgKyBHaXRIdWIucmVsZWFzZU5hbWUgKyAiLyIgKyBiYXNlbmFtZQoKICAgICAgICBmb3IgYXNzZXQgaW4gYXNzZXRzOgogICAgICAgICAgICBpZiBhc3NldFsibmFtZSJdID09IGJhc2VuYW1lOgogICAgICAgICAgICAgICAgIyBTZWUgaHR0cHM6Ly9kZXZlbG9wZXIuZ2l0aHViLmNvbS92My9yZXBvcy9yZWxlYXNlcy8jcmVzcG9uc2UtZm9yLXVwc3RyZWFtLWZhaWx1cmUgICMgbm9xYTogRTUwMQogICAgICAgICAgICAgICAgaWYgYXNzZXRbInN0YXRlIl0gPT0gIm5ldyIgb3IgYXNzZXRbInN0YXRlIl0gPT0gInVwbG9hZGVkIjogI292ZXJyaWRlIHRoZSBvbGQgZmlsZSBpZiBsYXN0IHVwbG9hZCBmYWlsZWQgb3IgdXBkYXRlIGlmICdmb3JjZVVwZGF0ZUZpbGUnIGlzIHRydWUuCiAgICAgICAgICAgICAgICAgICAgaWYgYXNzZXRbInN0YXRlIl0gPT0gInVwbG9hZGVkIiBhbmQgbm90IGZvcmNlVXBkYXRlRmlsZToKICAgICAgICAgICAgICAgICAgICAgICAgZmVlZGJhY2suc2V0UHJvZ3Jlc3NUZXh0KCJGaWxlICVzIGFscmVhZHkgdXBsb2FkZWQuIiAlIGFzc2V0WyduYW1lJ10pCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmaWxlRG93bmxvYWRQYXRoCiAgICAgICAgICAgICAgICAgICAgaWYgYXNzZXRbInN0YXRlIl0gPT0gIm5ldyI6CiAgICAgICAgICAgICAgICAgICAgICAgIGZlZWRiYWNrLnNldFByb2dyZXNzVGV4dCgiICBkZWxldGluZyAlcyAoaW52YWxpZCBhc3NldCAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ3aXRoIHN0YXRlIHNldCB0byAnbmV3JykiICUgYXNzZXRbJ25hbWUnXSkKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBmZWVkYmFjay5zZXRQcm9ncmVzc1RleHQoIlVwZGF0aW5nIGZpbGUgJXMuIiAlIGFzc2V0WyduYW1lJ10pCiAgICAgICAgICAgICAgICAgICAgdXJsID0gKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgR2l0SHViLmdpdGh1YkFwaQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKyAncmVwb3MvezB9L3JlbGVhc2VzL2Fzc2V0cy97MX0nLmZvcm1hdCh1c2VyICsgIi8iICsgcmVwb3NpdG9yeSwgYXNzZXRbJ2lkJ10pCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gR2l0SHViLl9yZXF1ZXN0KCdERUxFVEUnLCB1cmwsIHRva2VuPXBhc3N3b3JkKQogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLnJhaXNlX2Zvcl9zdGF0dXMoKQoKICAgICAgICBmaWxlX3NpemUgPSBvcy5wYXRoLmdldHNpemUodXBsb2FkRmlsZSkKICAgICAgICBmZWVkYmFjay5zZXRQcm9ncmVzc1RleHQoIiAgVXBsb2FkaW5nICVzIG9mIHNpemUgJXMgKE1CKSIgJSAoYmFzZW5hbWUsIHN0cihmaWxlX3NpemUgLyAxMGU1KSkpCgogICAgICAgIHVybCA9ICd7MH0/bmFtZT17MX0nLmZvcm1hdCh1cGxvYWRVcmwsIGJhc2VuYW1lKQoKICAgICAgICAjIEF0dGVtcHQgdXBsb2FkCiAgICAgICAgd2l0aCBvcGVuKHVwbG9hZEZpbGUsICdyYicpIGFzIGY6CiAgICAgICAgICAgIHdpdGggcHJvZ3Jlc3NfcmVwb3J0ZXJfY2xzKAogICAgICAgICAgICAgICAgICAgIGxhYmVsPWJhc2VuYW1lLCBsZW5ndGg9ZmlsZV9zaXplLCBmZWVkYmFjaz1mZWVkYmFjaykgYXMgcmVwb3J0ZXI6CiAgICAgICAgICAgICAgICByZXNwb25zZSA9IEdpdEh1Yi5fcmVxdWVzdCgKICAgICAgICAgICAgICAgICAgICAnUE9TVCcsIHVybCwgaGVhZGVycz17J0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nfSwKICAgICAgICAgICAgICAgICAgICBkYXRhPV9Qcm9ncmVzc0ZpbGVSZWFkZXIoZiwgcmVwb3J0ZXIpLCB0b2tlbj1wYXNzd29yZCkKICAgICAgICAgICAgICAgIGRhdGEgPSByZXNwb25zZS5qc29uKCkKCiAgICAgICAgaWYgcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPT0gNTAyIGFuZCBtYXhSZXRyeSA+IDE6CiAgICAgICAgICAgIGZlZWRiYWNrLnNldFByb2dyZXNzVGV4dCgiUmV0cnlpbmcgKHVwbG9hZCBmYWlsZWQgd2l0aCBzdGF0dXNfY29kZT01MDIpIikKICAgICAgICAgICAgcmV0dXJuIEdpdEh1Yi5hZGRSZWxlYXNlRmlsZSh1c2VyLCBwYXNzd29yZCwgcmVwb3NpdG9yeSwgbWF4UmV0cnkgLSAxLCBmb3JjZVVwZGF0ZUZpbGUsIHVwbG9hZEZpbGUsIGxheWVyLCBmZWVkYmFjaykKICAgICAgICBlbGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDUwMiBhbmQgbWF4UmV0cnkgPD0gMToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXNwb25zZS5yYWlzZV9mb3Jfc3RhdHVzKCkKICAgICAgICByZXR1cm4gZmlsZURvd25sb2FkUGF0aAoKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIEFVWCBDTEFTUyAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwoKY2xhc3MgcHJvZ3Jlc3NfcmVwb3J0ZXJfY2xzKG9iamVjdCk6CiAgICByZXBvcnRQcm9ncmVzcyA9IEZhbHNlCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGxhYmVsPScnLCBsZW5ndGg9MCwgZmVlZGJhY2s9Tm9uZSk6CiAgICAgICAgc2VsZi5sYWJlbCA9IGxhYmVsCiAgICAgICAgc2VsZi5sZW5ndGggPSBsZW5ndGgKICAgICAgICBzZWxmLnRvdGFsID0gMAogICAgICAgIHNlbGYubGFzdFJlcG9ydCA9IDAKICAgICAgICBzZWxmLmZlZWRiYWNrID0gZmVlZGJhY2sKCiAgICBkZWYgdXBkYXRlKHNlbGYsIGNodW5rX3NpemUpOgogICAgICAgIHNlbGYudG90YWwgPSBzZWxmLnRvdGFsICsgY2h1bmtfc2l6ZQogICAgICAgIGlmIHNlbGYuZmVlZGJhY2sgaXMgbm90IE5vbmUgYW5kIHNlbGYudG90YWwgPiAoc2VsZi5sYXN0UmVwb3J0ICsgKHNlbGYubGVuZ3RoICogMC4xKSk6CiAgICAgICAgICAgIHNlbGYuZmVlZGJhY2suc2V0UHJvZ3Jlc3NUZXh0KCdUb3RhbDogJyArIHN0cihzZWxmLnRvdGFsIC8gMTAwMCkgKyAiIChrYikiKQogICAgICAgICAgICBzZWxmLmxhc3RSZXBvcnQgPSBzZWxmLnRvdGFsCiAgICAgICAgcGFzcwoKICAgIGRlZiBfX2VudGVyX18oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYKCiAgICBkZWYgX19leGl0X18oc2VsZiwgZXhjX3R5cGUsIGV4Y192YWx1ZSwgdGIpOgogICAgICAgIHBhc3MKCiNXcmFwcGVyIHVzZWQgdG8gY2FwdHVyZSBGaWxlIElPIHJlYWQgcHJvZ3Jlc3MuCmNsYXNzIF9Qcm9ncmVzc0ZpbGVSZWFkZXIob2JqZWN0KToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBzdHJlYW0sIHJlcG9ydGVyKToKICAgICAgICBzZWxmLl9zdHJlYW0gPSBzdHJlYW0KICAgICAgICBzZWxmLl9yZXBvcnRlciA9IHJlcG9ydGVyCgogICAgZGVmIHJlYWQoc2VsZiwgX3NpemUpOgogICAgICAgIF9jaHVuayA9IHNlbGYuX3N0cmVhbS5yZWFkKF9zaXplKQogICAgICAgIHNlbGYuX3JlcG9ydGVyLnVwZGF0ZShsZW4oX2NodW5rKSkKICAgICAgICByZXR1cm4gX2NodW5rCgogICAgZGVmIF9fZ2V0YXR0cl9fKHNlbGYsIGF0dHIpOgogICAgICAgIHJldHVybiBnZXRhdHRyKHNlbGYuX3N0cmVhbSwgYXR0cikKCmNsYXNzIEN1c3RvbU1lc3NhZ2VCb3goUU1lc3NhZ2VCb3gpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsICpfX2FyZ3MpOgogICAgICAgIFFNZXNzYWdlQm94Ll9faW5pdF9fKHNlbGYpCiAgICAgICAgc2VsZi50aW1lb3V0ID0gMAogICAgICAgIHNlbGYuY2FsbGJhY2sgPSBOb25lCiAgICAgICAgc2VsZi5jdXJyZW50VGltZSA9IDAKCiAgICBkZWYgc2hvd0V2ZW50KHNlbGYsIFFTaG93RXZlbnQpOgogICAgICAgIHNlbGYuY3VycmVudFRpbWUgPSAwCiAgICAgICAgaWYgc2VsZi5hdXRvY2xvc2U6CiAgICAgICAgICAgIHNlbGYuc3RhcnRUaW1lcihzZWxmLnRpbWVvdXQpCgogICAgZGVmIHRpbWVyRXZlbnQoc2VsZiwgZXZlbnQpOgogICAgICAgICMgdHJ5OgogICAgICAgIGlmIHNlbGYuaXNIaWRkZW4oKToKICAgICAgICAgICAgc2VsZi5raWxsVGltZXIoZXZlbnQudGltZXJJZCgpKQogICAgICAgICAgICBzZWxmLmRlbGV0ZUxheWVyKCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmN1cnJlbnRUaW1lICs9IDEKICAgICAgICAgICAgc2VsZi5jYWxsYmFjayhzZWxmLCBzZWxmLmN1cnJlbnRUaW1lKQogICAgICAgICMgZXhjZXB0OgogICAgICAgICMgICAgIHNlbGYucXVpdCgpCiAgICAgICAgIyBpZiBzZWxmLmN1cnJlbnRUaW1lID49IHNlbGYudGltZW91dDoKICAgICAgICAjICAgICBzZWxmLmRvbmUoMCkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgc2hvd1dpdGhDYWxsYmFjayh0aW1lb3V0TXNDYWxsYmFjaywgbWVzc2FnZSwgdGl0bGUsIGNhbGxiYWNrLCBpY29uPVFNZXNzYWdlQm94LkluZm9ybWF0aW9uLCBidXR0b25zPVFNZXNzYWdlQm94Lk9rKToKICAgICAgICB3ID0gQ3VzdG9tTWVzc2FnZUJveCgpCiAgICAgICAgdy5hdXRvY2xvc2UgPSBUcnVlCiAgICAgICAgdy5jYWxsYmFjayA9IGNhbGxiYWNrCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3LnNldENhbGxiYWNrKGNhbGxiYWNrKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwogICAgICAgIHcudGltZW91dCA9IHRpbWVvdXRNc0NhbGxiYWNrCiAgICAgICAgdy5zZXRUZXh0KG1lc3NhZ2UpCiAgICAgICAgdy5zZXRXaW5kb3dUaXRsZSh0aXRsZSkKICAgICAgICB3LnNldEljb24oaWNvbikKICAgICAgICB3LnNldFN0YW5kYXJkQnV0dG9ucyhidXR0b25zKQogICAgICAgIHJldHVybiB3LmV4ZWNfKCkKCmNsYXNzIEdpdEludGVyYWN0aXZlKCkgOgoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBjbG9uZVJlcG8odXNlciwgcmVwb3NpdG9yeSwgZm9sZGVyLCBmZWVkYmFjayk6CiAgICAgICAgZnJvbSBnaXQgaW1wb3J0IFJlcG8KICAgICAgICByZXR1cm4gVVRJTFMucnVuTG9uZ1Rhc2soUmVwby5jbG9uZV9mcm9tLCBmZWVkYmFjaywgd2FpdE1lc3NhZ2U9IlBsZWFzZSB3YWl0IHRvIGNvbXBsZXRlIHRoZSBkb3dubG9hZC4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlY29uZHNSZXBvcnQ9MTUsIHVybD1HaXRIdWIuZ2V0R2l0VXJsKHVzZXIsIHJlcG9zaXRvcnkpLCB0b19wYXRoPWZvbGRlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWN1cnNpdmU9VHJ1ZSkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgcHVzaENoYW5nZXMocmVwbywgdXNlciwgcmVwb3NpdG9yeSwgcGFzc3dvcmQsIGZlZWRiYWNrKToKICAgICAgICByZXR1cm4gVVRJTFMucnVuTG9uZ1Rhc2socmVwby5naXQucHVzaCwgZmVlZGJhY2ssICdQbGVhc2Ugd2FpdCwgdXBsb2FkaW5nIGNoYW5nZXMuJywgMzAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEdpdEh1Yi5nZXRHaXRQYXNzVXJsKHVzZXIsIHJlcG9zaXRvcnksIHBhc3N3b3JkKSwgIm1hc3RlcjpyZWZzL2hlYWRzL21hc3RlciIpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdpdENvbW1pdChyZXBvLCBtc2csIGZlZWRiYWNrKToKICAgICAgICByZXR1cm4gVVRJTFMucnVuTG9uZ1Rhc2socmVwby5naXQuY29tbWl0LCBmZWVkYmFjaywgJ1BsZWFzZSB3YWl0LCB1cGxvYWRpbmcgY2hhbmdlcy4nLCAzMCwgbT1tc2cpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGFkZEZpbGVzKHJlcG8sIHVzZXIsIHJlcG9zaXRvcnksIGZlZWRiYWNrKToKICAgICAgICBvcmlnaW5OYW1lID0gIm1hcHBpYSIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlcG8uZ2l0LnJlbW90ZSgiYWRkIiwgb3JpZ2luTmFtZSwgR2l0SHViLmdldEdpdFVybCh1c2VyLCByZXBvc2l0b3J5KSkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHJlcG8uZ2l0LnJlbW90ZSgic2V0LXVybCIsIG9yaWdpbk5hbWUsIEdpdEh1Yi5nZXRHaXRVcmwodXNlciwgcmVwb3NpdG9yeSkpCiAgICAgICAgcmV0dXJuIFVUSUxTLnJ1bkxvbmdUYXNrKHJlcG8uZ2l0LmFkZCwgZmVlZGJhY2ssIHdhaXRNZXNzYWdlPSdQbGVhc2Ugd2FpdCwgaWRlbnRpZnlpbmcgY2hhbmdlcyBvbiB5b3VyIHJlcG9zaXRvcnkuJywgc2Vjb25kc1JlcG9ydD0zMCwgYWxsPVRydWUpICMgQWRpY2lvbmEgdG9kb3MgYXJxdWl2b3MKCgp0cnk6CiAgICBmcm9tIEZlZWRiYWNrIGltcG9ydCBGZWVkYmFjawpleGNlcHQ6CiAgICBwYXNzICNOb3QgaW4gRGluYW1pY2EgQ29kZQoKY2xhc3MgRmVlZGJhY2soKToKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBwdXNoQ29uc29sZUluZm8obWVzc2FnZSk6CiAgICAgICAgcHJpbnQobWVzc2FnZSkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgc2V0UHJvZ3Jlc3MocGVyY2VudGFnZSk6CiAgICAgICAgcHJpbnQoIlByb2dyZXNzOiAiICsgc3RyKHBlcmNlbnRhZ2UpKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBzZXRQcm9ncmVzc1RleHQobWVzc2FnZSk6CiAgICAgICAgcHJpbnQobWVzc2FnZSkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgaXNDYW5jZWxlZCgpOgogICAgICAgIHJldHVybiBGYWxzZQoKCgoKCnRyeToKICAgIGZyb20gZ2RhbDJ0aWxlc19sb2NhbCBpbXBvcnQgZ2VuZXJhdGVUaWxlRm9yTWFwCmV4Y2VwdDoKICAgIHBhc3MgI05vdCBpbiBEaW5hbWljYSBDb2RlCgojIS91c3IvYmluL2VudiBweXRob24KIyAtKi0gY29kaW5nOiB1dGYtOCAtKi0KIyAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKIyAgJElkJAojCiMgUHJvamVjdDogIEdvb2dsZSBTdW1tZXIgb2YgQ29kZSAyMDA3LCAyMDA4IChodHRwOi8vY29kZS5nb29nbGUuY29tL3NvYy8pCiMgU3VwcG9ydDogIEJSR00gKGh0dHA6Ly93d3cuYnJnbS5mcikKIyBQdXJwb3NlOiAgQ29udmVydCBhIHJhc3RlciBpbnRvIFRNUyAoVGlsZSBNYXAgU2VydmljZSkgdGlsZXMgaW4gYSBkaXJlY3RvcnkuCiMgICAgICAgICAgIC0gZ2VuZXJhdGUgR29vZ2xlIEVhcnRoIG1ldGFkYXRhIChLTUwgU3VwZXJPdmVybGF5KQojICAgICAgICAgICAtIGdlbmVyYXRlIHNpbXBsZSBIVE1MIHZpZXdlciBiYXNlZCBvbiBHb29nbGUgTWFwcyBhbmQgT3BlbkxheWVycwojICAgICAgICAgICAtIHN1cHBvcnQgb2YgZ2xvYmFsIHRpbGVzIChTcGhlcmljYWwgTWVyY2F0b3IpIGZvciBjb21wYXRpYmlsaXR5CiMgICAgICAgICAgICAgICB3aXRoIGludGVyYWN0aXZlIHdlYiBtYXBzIGEgbGEgR29vZ2xlIE1hcHMKIyBBdXRob3I6ICAgS2xva2FuIFBldHIgUHJpZGFsLCBrbG9rYW4gYXQga2xva2FuIGRvdCBjegojIFdlYjogICAgICBodHRwOi8vd3d3Lmtsb2thbi5jei9wcm9qZWN0cy9nZGFsMnRpbGVzLwojIEdVSTogICAgICBodHRwOi8vd3d3Lm1hcHRpbGVyLm9yZy8KIwojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiMgQ29weXJpZ2h0IChjKSAyMDA4LCBLbG9rYW4gUGV0ciBQcmlkYWwKIyBDb3B5cmlnaHQgKGMpIDIwMTAtMjAxMywgRXZlbiBSb3VhdWx0IDxldmVuIGRvdCByb3VhdWx0IGF0IG1pbmVzLXBhcmlzIGRvdCBvcmc+CiMKIyAgUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKIyAgY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwKIyAgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbgojICB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwKIyAgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlCiMgIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiMKIyAgVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKIyAgaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiMKIyAgVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKIyAgT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiMgIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMCiMgIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiMgIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HCiMgIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIKIyAgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgojICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgoKCgppbXBvcnQgbWF0aApmcm9tIG11bHRpcHJvY2Vzc2luZyBpbXBvcnQgUGlwZSwgUG9vbCwgUHJvY2VzcywgTWFuYWdlcgppbXBvcnQgb3MKaW1wb3J0IHRlbXBmaWxlCmltcG9ydCBzaHV0aWwKaW1wb3J0IHN5cwppbXBvcnQgdGltZQpmcm9tIHV1aWQgaW1wb3J0IHV1aWQ0CmZyb20geG1sLmV0cmVlIGltcG9ydCBFbGVtZW50VHJlZQoKZnJvbSBvc2dlbyBpbXBvcnQgZ2RhbApmcm9tIG9zZ2VvIGltcG9ydCBvc3IKCnRyeToKICAgIGZyb20gY29sb3JpemVfcmdiIGltcG9ydCBhcHBseUxlZ2VuZApleGNlcHQ6CiAgICBwYXNzICNOb3QgaW4gRGluYW1pY2EgQ29kZQoKdHJ5OgogICAgZnJvbSBQSUwgaW1wb3J0IEltYWdlCiAgICBpbXBvcnQgbnVtcHkKICAgIGltcG9ydCBvc2dlby5nZGFsX2FycmF5IGFzIGdkYWxhcnJheQpleGNlcHQgRXhjZXB0aW9uOgogICAgIyAnYW50aWFsaWFzJyByZXNhbXBsaW5nIGlzIG5vdCBhdmFpbGFibGUKICAgIHBhc3MKCl9fdmVyc2lvbl9fID0gIiRJZCQiCgpyZXNhbXBsaW5nX2xpc3QgPSAoJ2F2ZXJhZ2UnLCAnbmVhcicsICdiaWxpbmVhcicsICdjdWJpYycsICdjdWJpY3NwbGluZScsICdsYW5jem9zJywgICdhbnRpYWxpYXMnKQpwcm9maWxlX2xpc3QgPSAoJ21lcmNhdG9yJywgJ2dlb2RldGljJywgJ3Jhc3RlcicpCndlYnZpZXdlcl9saXN0ID0gKCdhbGwnLCAnZ29vZ2xlJywgJ29wZW5sYXllcnMnLCAnbGVhZmxldCcsICdub25lJykKCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgpfX2RvY19fZ2xvYmFsbWFwdGlsZXMgPSAiIiIKZ2xvYmFsbWFwdGlsZXMucHkKCkdsb2JhbCBNYXAgVGlsZXMgYXMgZGVmaW5lZCBpbiBUaWxlIE1hcCBTZXJ2aWNlIChUTVMpIFByb2ZpbGVzCj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgpGdW5jdGlvbnMgbmVjZXNzYXJ5IGZvciBnZW5lcmF0aW9uIG9mIGdsb2JhbCB0aWxlcyB1c2VkIG9uIHRoZSB3ZWIuCkl0IGNvbnRhaW5zIGNsYXNzZXMgaW1wbGVtZW50aW5nIGNvb3JkaW5hdGUgY29udmVyc2lvbnMgZm9yOgoKICAtIEdsb2JhbE1lcmNhdG9yIChiYXNlZCBvbiBFUFNHOjM4NTcpCiAgICAgICBmb3IgR29vZ2xlIE1hcHMsIFlhaG9vIE1hcHMsIEJpbmcgTWFwcyBjb21wYXRpYmxlIHRpbGVzCiAgLSBHbG9iYWxHZW9kZXRpYyAoYmFzZWQgb24gRVBTRzo0MzI2KQogICAgICAgZm9yIE9wZW5MYXllcnMgQmFzZSBNYXAgYW5kIEdvb2dsZSBFYXJ0aCBjb21wYXRpYmxlIHRpbGVzCgpNb3JlIGluZm8gYXQ6CgpodHRwOi8vd2lraS5vc2dlby5vcmcvd2lraS9UaWxlX01hcF9TZXJ2aWNlX1NwZWNpZmljYXRpb24KaHR0cDovL3dpa2kub3NnZW8ub3JnL3dpa2kvV01TX1RpbGluZ19DbGllbnRfUmVjb21tZW5kYXRpb24KaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L2JiMjU5Njg5LmFzcHgKaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9hcGlzL21hcHMvZG9jdW1lbnRhdGlvbi9vdmVybGF5cy5odG1sI0dvb2dsZV9NYXBzX0Nvb3JkaW5hdGVzCgpDcmVhdGVkIGJ5IEtsb2thbiBQZXRyIFByaWRhbCBvbiAyMDA4LTA3LTAzLgpHb29nbGUgU3VtbWVyIG9mIENvZGUgMjAwOCwgcHJvamVjdCBHREFMMlRpbGVzIGZvciBPU0dFTy4KCkluIGNhc2UgeW91IHVzZSB0aGlzIGNsYXNzIGluIHlvdXIgcHJvZHVjdCwgdHJhbnNsYXRlIGl0IHRvIGFub3RoZXIgbGFuZ3VhZ2UKb3IgZmluZCBpdCB1c2VmdWwgZm9yIHlvdXIgcHJvamVjdCBwbGVhc2UgbGV0IG1lIGtub3cuCk15IGVtYWlsOiBrbG9rYW4gYXQga2xva2FuIGRvdCBjei4KSSB3b3VsZCBsaWtlIHRvIGtub3cgd2hlcmUgaXQgd2FzIHVzZWQuCgpDbGFzcyBpcyBhdmFpbGFibGUgdW5kZXIgdGhlIG9wZW4tc291cmNlIEdEQUwgbGljZW5zZSAod3d3LmdkYWwub3JnKS4KIiIiCgpNQVhaT09NTEVWRUwgPSAzMgoKCmNsYXNzIEdsb2JhbE1lcmNhdG9yKG9iamVjdCk6CiAgICByIiIiCiAgICBUTVMgR2xvYmFsIE1lcmNhdG9yIFByb2ZpbGUKICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAgIEZ1bmN0aW9ucyBuZWNlc3NhcnkgZm9yIGdlbmVyYXRpb24gb2YgdGlsZXMgaW4gU3BoZXJpY2FsIE1lcmNhdG9yIHByb2plY3Rpb24sCiAgICBFUFNHOjM4NTcuCgogICAgU3VjaCB0aWxlcyBhcmUgY29tcGF0aWJsZSB3aXRoIEdvb2dsZSBNYXBzLCBCaW5nIE1hcHMsIFlhaG9vIE1hcHMsCiAgICBVSyBPcmRuYW5jZSBTdXJ2ZXkgT3BlblNwYWNlIEFQSSwgLi4uCiAgICBhbmQgeW91IGNhbiBvdmVybGF5IHRoZW0gb24gdG9wIG9mIGJhc2UgbWFwcyBvZiB0aG9zZSB3ZWIgbWFwcGluZyBhcHBsaWNhdGlvbnMuCgogICAgUGl4ZWwgYW5kIHRpbGUgY29vcmRpbmF0ZXMgYXJlIGluIFRNUyBub3RhdGlvbiAob3JpZ2luIFswLDBdIGluIGJvdHRvbS1sZWZ0KS4KCiAgICBXaGF0IGNvb3JkaW5hdGUgY29udmVyc2lvbnMgZG8gd2UgbmVlZCBmb3IgVE1TIEdsb2JhbCBNZXJjYXRvciB0aWxlczo6CgogICAgICAgICBMYXRMb24gICAgICA8LT4gICAgICAgTWV0ZXJzICAgICAgPC0+ICAgICBQaXhlbHMgICAgPC0+ICAgICAgIFRpbGUKCiAgICAgV0dTODQgY29vcmRpbmF0ZXMgICBTcGhlcmljYWwgTWVyY2F0b3IgIFBpeGVscyBpbiBweXJhbWlkICBUaWxlcyBpbiBweXJhbWlkCiAgICAgICAgIGxhdC9sb24gICAgICAgICAgICBYWSBpbiBtZXRlcnMgICAgIFhZIHBpeGVscyBaIHpvb20gICAgICBYWVogZnJvbSBUTVMKICAgICAgICBFUFNHOjQzMjYgICAgICAgICAgIEVQU0c6Mzg3CiAgICAgICAgIC4tLS0tLiAgICAgICAgICAgICAgLS0tLS0tLS0tICAgICAgICAgICAgICAgLS0gICAgICAgICAgICAgICAgVE1TCiAgICAgICAgLyAgICAgIFwgICAgIDwtPiAgICAgfCAgICAgICB8ICAgICA8LT4gICAgIC8tLS0tLyAgICA8LT4gICAgICBHb29nbGUKICAgICAgICBcICAgICAgLyAgICAgICAgICAgICB8ICAgICAgIHwgICAgICAgICAgIC8tLS0tLS0tLS8gICAgICAgICAgUXVhZFRyZWUKICAgICAgICAgLS0tLS0gICAgICAgICAgICAgICAtLS0tLS0tLS0gICAgICAgICAvLS0tLS0tLS0tLS0tLwogICAgICAgS01MLCBwdWJsaWMgICAgICAgICBXZWJNYXBTZXJ2aWNlICAgICAgICAgV2ViIENsaWVudHMgICAgICBUaWxlTWFwU2VydmljZQoKICAgIFdoYXQgaXMgdGhlIGNvb3JkaW5hdGUgZXh0ZW50IG9mIEVhcnRoIGluIEVQU0c6Mzg1Nz8KCiAgICAgIFstMjAwMzc1MDguMzQyNzg5MjQ0LCAtMjAwMzc1MDguMzQyNzg5MjQ0LCAyMDAzNzUwOC4zNDI3ODkyNDQsIDIwMDM3NTA4LjM0Mjc4OTI0NF0KICAgICAgQ29uc3RhbnQgMjAwMzc1MDguMzQyNzg5MjQ0IGNvbWVzIGZyb20gdGhlIGNpcmN1bWZlcmVuY2Ugb2YgdGhlIEVhcnRoIGluIG1ldGVycywKICAgICAgd2hpY2ggaXMgNDAgdGhvdXNhbmQga2lsb21ldGVycywgdGhlIGNvb3JkaW5hdGUgb3JpZ2luIGlzIGluIHRoZSBtaWRkbGUgb2YgZXh0ZW50LgogICAgICBJbiBmYWN0IHlvdSBjYW4gY2FsY3VsYXRlIHRoZSBjb25zdGFudCBhczogMiAqIG1hdGgucGkgKiA2Mzc4MTM3IC8gMi4wCiAgICAgICQgZWNobyAxODAgODUgfCBnZGFsdHJhbnNmb3JtIC1zX3NycyBFUFNHOjQzMjYgLXRfc3JzIEVQU0c6Mzg1NwogICAgICBQb2xhciBhcmVhcyB3aXRoIGFicyhsYXRpdHVkZSkgYmlnZ2VyIHRoZW4gODUuMDUxMTI4NzggYXJlIGNsaXBwZWQgb2ZmLgoKICAgIFdoYXQgYXJlIHpvb20gbGV2ZWwgY29uc3RhbnRzIChwaXhlbHMvbWV0ZXIpIGZvciBweXJhbWlkIHdpdGggRVBTRzozODU3PwoKICAgICAgd2hvbGUgcmVnaW9uIGlzIG9uIHRvcCBvZiBweXJhbWlkICh6b29tPTApIGNvdmVyZWQgYnkgMjU2eDI1NiBwaXhlbHMgdGlsZSwKICAgICAgZXZlcnkgbG93ZXIgem9vbSBsZXZlbCByZXNvbHV0aW9uIGlzIGFsd2F5cyBkaXZpZGVkIGJ5IHR3bwogICAgICBpbml0aWFsUmVzb2x1dGlvbiA9IDIwMDM3NTA4LjM0Mjc4OTI0NCAqIDIgLyAyNTYgPSAxNTY1NDMuMDMzOTI4MDQwNjIKCiAgICBXaGF0IGlzIHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gVE1TIGFuZCBHb29nbGUgTWFwcy9RdWFkVHJlZSB0aWxlIG5hbWUgY29udmVudGlvbj8KCiAgICAgIFRoZSB0aWxlIHJhc3RlciBpdHNlbGYgaXMgdGhlIHNhbWUgKGVxdWFsIGV4dGVudCwgcHJvamVjdGlvbiwgcGl4ZWwgc2l6ZSksCiAgICAgIHRoZXJlIGlzIGp1c3QgZGlmZmVyZW50IGlkZW50aWZpY2F0aW9uIG9mIHRoZSBzYW1lIHJhc3RlciB0aWxlLgogICAgICBUaWxlcyBpbiBUTVMgYXJlIGNvdW50ZWQgZnJvbSBbMCwwXSBpbiB0aGUgYm90dG9tLWxlZnQgY29ybmVyLCBpZCBpcyBYWVouCiAgICAgIEdvb2dsZSBwbGFjZWQgdGhlIG9yaWdpbiBbMCwwXSB0byB0aGUgdG9wLWxlZnQgY29ybmVyLCByZWZlcmVuY2UgaXMgWFlaLgogICAgICBNaWNyb3NvZnQgaXMgcmVmZXJlbmNpbmcgdGlsZXMgYnkgYSBRdWFkVHJlZSBuYW1lLCBkZWZpbmVkIG9uIHRoZSB3ZWJzaXRlOgogICAgICBodHRwOi8vbXNkbjIubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L2JiMjU5Njg5LmFzcHgKCiAgICBUaGUgbGF0L2xvbiBjb29yZGluYXRlcyBhcmUgdXNpbmcgV0dTODQgZGF0dW0sIHllcz8KCiAgICAgIFllcywgYWxsIGxhdC9sb24gd2UgYXJlIG1lbnRpb25pbmcgc2hvdWxkIHVzZSBXR1M4NCBHZW9kZXRpYyBEYXR1bS4KICAgICAgV2VsbCwgdGhlIHdlYiBjbGllbnRzIGxpa2UgR29vZ2xlIE1hcHMgYXJlIHByb2plY3RpbmcgdGhvc2UgY29vcmRpbmF0ZXMgYnkKICAgICAgU3BoZXJpY2FsIE1lcmNhdG9yLCBzbyBpbiBmYWN0IGxhdC9sb24gY29vcmRpbmF0ZXMgb24gc3BoZXJlIGFyZSB0cmVhdGVkIGFzIGlmCiAgICAgIHRoZSB3ZXJlIG9uIHRoZSBXR1M4NCBlbGxpcHNvaWQuCgogICAgICBGcm9tIE1TRE4gZG9jdW1lbnRhdGlvbjoKICAgICAgVG8gc2ltcGxpZnkgdGhlIGNhbGN1bGF0aW9ucywgd2UgdXNlIHRoZSBzcGhlcmljYWwgZm9ybSBvZiBwcm9qZWN0aW9uLCBub3QKICAgICAgdGhlIGVsbGlwc29pZGFsIGZvcm0uIFNpbmNlIHRoZSBwcm9qZWN0aW9uIGlzIHVzZWQgb25seSBmb3IgbWFwIGRpc3BsYXksCiAgICAgIGFuZCBub3QgZm9yIGRpc3BsYXlpbmcgbnVtZXJpYyBjb29yZGluYXRlcywgd2UgZG9uJ3QgbmVlZCB0aGUgZXh0cmEgcHJlY2lzaW9uCiAgICAgIG9mIGFuIGVsbGlwc29pZGFsIHByb2plY3Rpb24uIFRoZSBzcGhlcmljYWwgcHJvamVjdGlvbiBjYXVzZXMgYXBwcm94aW1hdGVseQogICAgICAwLjMzIHBlcmNlbnQgc2NhbGUgZGlzdG9ydGlvbiBpbiB0aGUgWSBkaXJlY3Rpb24sIHdoaWNoIGlzIG5vdCB2aXN1YWxseQogICAgICBub3RpY2VhYmxlLgoKICAgIEhvdyBkbyBJIGNyZWF0ZSBhIHJhc3RlciBpbiBFUFNHOjM4NTcgYW5kIGNvbnZlcnQgY29vcmRpbmF0ZXMgd2l0aCBQUk9KLjQ/CgogICAgICBZb3UgY2FuIHVzZSBzdGFuZGFyZCBHSVMgdG9vbHMgbGlrZSBnZGFsd2FycCwgY3MyY3Mgb3IgZ2RhbHRyYW5zZm9ybS4KICAgICAgQWxsIG9mIHRoZSB0b29scyBzdXBwb3J0cyAtdF9zcnMgJ2Vwc2c6Mzg1NycuCgogICAgICBGb3Igb3RoZXIgR0lTIHByb2dyYW1zIGNoZWNrIHRoZSBleGFjdCBkZWZpbml0aW9uIG9mIHRoZSBwcm9qZWN0aW9uOgogICAgICBNb3JlIGluZm8gYXQgaHR0cDovL3NwYXRpYWxyZWZlcmVuY2Uub3JnL3JlZi91c2VyL2dvb2dsZS1wcm9qZWN0aW9uLwogICAgICBUaGUgc2FtZSBwcm9qZWN0aW9uIGlzIGRlc2lnbmF0ZWQgYXMgRVBTRzozODU3LiBXS1QgZGVmaW5pdGlvbiBpcyBpbiB0aGUKICAgICAgb2ZmaWNpYWwgRVBTRyBkYXRhYmFzZS4KCiAgICAgIFByb2o0IFRleHQ6CiAgICAgICAgK3Byb2o9bWVyYyArYT02Mzc4MTM3ICtiPTYzNzgxMzcgK2xhdF90cz0wLjAgK2xvbl8wPTAuMCAreF8wPTAuMCAreV8wPTAKICAgICAgICAraz0xLjAgK3VuaXRzPW0gK25hZGdyaWRzPUBudWxsICtub19kZWZzCgogICAgICBIdW1hbiByZWFkYWJsZSBXS1QgZm9ybWF0IG9mIEVQU0c6Mzg1NzoKICAgICAgICAgUFJPSkNTWyJHb29nbGUgTWFwcyBHbG9iYWwgTWVyY2F0b3IiLAogICAgICAgICAgICAgR0VPR0NTWyJXR1MgODQiLAogICAgICAgICAgICAgICAgIERBVFVNWyJXR1NfMTk4NCIsCiAgICAgICAgICAgICAgICAgICAgIFNQSEVST0lEWyJXR1MgODQiLDYzNzgxMzcsMjk4LjI1NzIyMzU2MywKICAgICAgICAgICAgICAgICAgICAgICAgIEFVVEhPUklUWVsiRVBTRyIsIjcwMzAiXV0sCiAgICAgICAgICAgICAgICAgICAgIEFVVEhPUklUWVsiRVBTRyIsIjYzMjYiXV0sCiAgICAgICAgICAgICAgICAgUFJJTUVNWyJHcmVlbndpY2giLDBdLAogICAgICAgICAgICAgICAgIFVOSVRbImRlZ3JlZSIsMC4wMTc0NTMyOTI1MTk5NDMzXSwKICAgICAgICAgICAgICAgICBBVVRIT1JJVFlbIkVQU0ciLCI0MzI2Il1dLAogICAgICAgICAgICAgUFJPSkVDVElPTlsiTWVyY2F0b3JfMVNQIl0sCiAgICAgICAgICAgICBQQVJBTUVURVJbImNlbnRyYWxfbWVyaWRpYW4iLDBdLAogICAgICAgICAgICAgUEFSQU1FVEVSWyJzY2FsZV9mYWN0b3IiLDFdLAogICAgICAgICAgICAgUEFSQU1FVEVSWyJmYWxzZV9lYXN0aW5nIiwwXSwKICAgICAgICAgICAgIFBBUkFNRVRFUlsiZmFsc2Vfbm9ydGhpbmciLDBdLAogICAgICAgICAgICAgVU5JVFsibWV0cmUiLDEsCiAgICAgICAgICAgICAgICAgQVVUSE9SSVRZWyJFUFNHIiwiOTAwMSJdXV0KICAgICIiIgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB0aWxlU2l6ZT0yNTYpOgogICAgICAgICJJbml0aWFsaXplIHRoZSBUTVMgR2xvYmFsIE1lcmNhdG9yIHB5cmFtaWQiCiAgICAgICAgc2VsZi50aWxlU2l6ZSA9IHRpbGVTaXplCiAgICAgICAgc2VsZi5pbml0aWFsUmVzb2x1dGlvbiA9IDIgKiBtYXRoLnBpICogNjM3ODEzNyAvIHNlbGYudGlsZVNpemUKICAgICAgICAjIDE1NjU0My4wMzM5MjgwNDA2MiBmb3IgdGlsZVNpemUgMjU2IHBpeGVscwogICAgICAgIHNlbGYub3JpZ2luU2hpZnQgPSAyICogbWF0aC5waSAqIDYzNzgxMzcgLyAyLjAKICAgICAgICAjIDIwMDM3NTA4LjM0Mjc4OTI0NAoKICAgIGRlZiBMYXRMb25Ub01ldGVycyhzZWxmLCBsYXQsIGxvbik6CiAgICAgICAgIkNvbnZlcnRzIGdpdmVuIGxhdC9sb24gaW4gV0dTODQgRGF0dW0gdG8gWFkgaW4gU3BoZXJpY2FsIE1lcmNhdG9yIEVQU0c6Mzg1NyIKCiAgICAgICAgbXggPSBsb24gKiBzZWxmLm9yaWdpblNoaWZ0IC8gMTgwLjAKICAgICAgICBteSA9IG1hdGgubG9nKG1hdGgudGFuKCg5MCArIGxhdCkgKiBtYXRoLnBpIC8gMzYwLjApKSAvIChtYXRoLnBpIC8gMTgwLjApCgogICAgICAgIG15ID0gbXkgKiBzZWxmLm9yaWdpblNoaWZ0IC8gMTgwLjAKICAgICAgICByZXR1cm4gbXgsIG15CgogICAgZGVmIE1ldGVyc1RvTGF0TG9uKHNlbGYsIG14LCBteSk6CiAgICAgICAgIkNvbnZlcnRzIFhZIHBvaW50IGZyb20gU3BoZXJpY2FsIE1lcmNhdG9yIEVQU0c6Mzg1NyB0byBsYXQvbG9uIGluIFdHUzg0IERhdHVtIgoKICAgICAgICBsb24gPSAobXggLyBzZWxmLm9yaWdpblNoaWZ0KSAqIDE4MC4wCiAgICAgICAgbGF0ID0gKG15IC8gc2VsZi5vcmlnaW5TaGlmdCkgKiAxODAuMAoKICAgICAgICBsYXQgPSAxODAgLyBtYXRoLnBpICogKDIgKiBtYXRoLmF0YW4obWF0aC5leHAobGF0ICogbWF0aC5waSAvIDE4MC4wKSkgLSBtYXRoLnBpIC8gMi4wKQogICAgICAgIHJldHVybiBsYXQsIGxvbgoKICAgIGRlZiBQaXhlbHNUb01ldGVycyhzZWxmLCBweCwgcHksIHpvb20pOgogICAgICAgICJDb252ZXJ0cyBwaXhlbCBjb29yZGluYXRlcyBpbiBnaXZlbiB6b29tIGxldmVsIG9mIHB5cmFtaWQgdG8gRVBTRzozODU3IgoKICAgICAgICByZXMgPSBzZWxmLlJlc29sdXRpb24oem9vbSkKICAgICAgICBteCA9IHB4ICogcmVzIC0gc2VsZi5vcmlnaW5TaGlmdAogICAgICAgIG15ID0gcHkgKiByZXMgLSBzZWxmLm9yaWdpblNoaWZ0CiAgICAgICAgcmV0dXJuIG14LCBteQoKICAgIGRlZiBNZXRlcnNUb1BpeGVscyhzZWxmLCBteCwgbXksIHpvb20pOgogICAgICAgICJDb252ZXJ0cyBFUFNHOjM4NTcgdG8gcHlyYW1pZCBwaXhlbCBjb29yZGluYXRlcyBpbiBnaXZlbiB6b29tIGxldmVsIgoKICAgICAgICByZXMgPSBzZWxmLlJlc29sdXRpb24oem9vbSkKICAgICAgICBweCA9IChteCArIHNlbGYub3JpZ2luU2hpZnQpIC8gcmVzCiAgICAgICAgcHkgPSAobXkgKyBzZWxmLm9yaWdpblNoaWZ0KSAvIHJlcwogICAgICAgIHJldHVybiBweCwgcHkKCiAgICBkZWYgUGl4ZWxzVG9UaWxlKHNlbGYsIHB4LCBweSk6CiAgICAgICAgIlJldHVybnMgYSB0aWxlIGNvdmVyaW5nIHJlZ2lvbiBpbiBnaXZlbiBwaXhlbCBjb29yZGluYXRlcyIKCiAgICAgICAgdHggPSBpbnQobWF0aC5jZWlsKHB4IC8gZmxvYXQoc2VsZi50aWxlU2l6ZSkpIC0gMSkKICAgICAgICB0eSA9IGludChtYXRoLmNlaWwocHkgLyBmbG9hdChzZWxmLnRpbGVTaXplKSkgLSAxKQogICAgICAgIHJldHVybiB0eCwgdHkKCiAgICBkZWYgUGl4ZWxzVG9SYXN0ZXIoc2VsZiwgcHgsIHB5LCB6b29tKToKICAgICAgICAiTW92ZSB0aGUgb3JpZ2luIG9mIHBpeGVsIGNvb3JkaW5hdGVzIHRvIHRvcC1sZWZ0IGNvcm5lciIKCiAgICAgICAgbWFwU2l6ZSA9IHNlbGYudGlsZVNpemUgPDwgem9vbQogICAgICAgIHJldHVybiBweCwgbWFwU2l6ZSAtIHB5CgogICAgZGVmIE1ldGVyc1RvVGlsZShzZWxmLCBteCwgbXksIHpvb20pOgogICAgICAgICJSZXR1cm5zIHRpbGUgZm9yIGdpdmVuIG1lcmNhdG9yIGNvb3JkaW5hdGVzIgoKICAgICAgICBweCwgcHkgPSBzZWxmLk1ldGVyc1RvUGl4ZWxzKG14LCBteSwgem9vbSkKICAgICAgICByZXR1cm4gc2VsZi5QaXhlbHNUb1RpbGUocHgsIHB5KQoKICAgIGRlZiBUaWxlQm91bmRzKHNlbGYsIHR4LCB0eSwgem9vbSk6CiAgICAgICAgIlJldHVybnMgYm91bmRzIG9mIHRoZSBnaXZlbiB0aWxlIGluIEVQU0c6Mzg1NyBjb29yZGluYXRlcyIKCiAgICAgICAgbWlueCwgbWlueSA9IHNlbGYuUGl4ZWxzVG9NZXRlcnModHgqc2VsZi50aWxlU2l6ZSwgdHkqc2VsZi50aWxlU2l6ZSwgem9vbSkKICAgICAgICBtYXh4LCBtYXh5ID0gc2VsZi5QaXhlbHNUb01ldGVycygodHgrMSkqc2VsZi50aWxlU2l6ZSwgKHR5KzEpKnNlbGYudGlsZVNpemUsIHpvb20pCiAgICAgICAgcmV0dXJuIChtaW54LCBtaW55LCBtYXh4LCBtYXh5KQoKICAgIGRlZiBUaWxlTGF0TG9uQm91bmRzKHNlbGYsIHR4LCB0eSwgem9vbSk6CiAgICAgICAgIlJldHVybnMgYm91bmRzIG9mIHRoZSBnaXZlbiB0aWxlIGluIGxhdGl0dWRlL2xvbmdpdHVkZSB1c2luZyBXR1M4NCBkYXR1bSIKCiAgICAgICAgYm91bmRzID0gc2VsZi5UaWxlQm91bmRzKHR4LCB0eSwgem9vbSkKICAgICAgICBtaW5MYXQsIG1pbkxvbiA9IHNlbGYuTWV0ZXJzVG9MYXRMb24oYm91bmRzWzBdLCBib3VuZHNbMV0pCiAgICAgICAgbWF4TGF0LCBtYXhMb24gPSBzZWxmLk1ldGVyc1RvTGF0TG9uKGJvdW5kc1syXSwgYm91bmRzWzNdKQoKICAgICAgICByZXR1cm4gKG1pbkxhdCwgbWluTG9uLCBtYXhMYXQsIG1heExvbikKCiAgICBkZWYgUmVzb2x1dGlvbihzZWxmLCB6b29tKToKICAgICAgICAiUmVzb2x1dGlvbiAobWV0ZXJzL3BpeGVsKSBmb3IgZ2l2ZW4gem9vbSBsZXZlbCAobWVhc3VyZWQgYXQgRXF1YXRvcikiCgogICAgICAgICMgcmV0dXJuICgyICogbWF0aC5waSAqIDYzNzgxMzcpIC8gKHNlbGYudGlsZVNpemUgKiAyKip6b29tKQogICAgICAgIHJldHVybiBzZWxmLmluaXRpYWxSZXNvbHV0aW9uIC8gKDIqKnpvb20pCgogICAgZGVmIFpvb21Gb3JQaXhlbFNpemUoc2VsZiwgcGl4ZWxTaXplKToKICAgICAgICAiTWF4aW1hbCBzY2FsZWRvd24gem9vbSBvZiB0aGUgcHlyYW1pZCBjbG9zZXN0IHRvIHRoZSBwaXhlbFNpemUuIgoKICAgICAgICBmb3IgaSBpbiByYW5nZShNQVhaT09NTEVWRUwpOgogICAgICAgICAgICBpZiBwaXhlbFNpemUgPiBzZWxmLlJlc29sdXRpb24oaSk6CiAgICAgICAgICAgICAgICBpZiBpICE9IC0xOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBpLTEKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAgICAgIyBXZSBkb24ndCB3YW50IHRvIHNjYWxlIHVwCgogICAgZGVmIEdvb2dsZVRpbGUoc2VsZiwgdHgsIHR5LCB6b29tKToKICAgICAgICAiQ29udmVydHMgVE1TIHRpbGUgY29vcmRpbmF0ZXMgdG8gR29vZ2xlIFRpbGUgY29vcmRpbmF0ZXMiCgogICAgICAgICMgY29vcmRpbmF0ZSBvcmlnaW4gaXMgbW92ZWQgZnJvbSBib3R0b20tbGVmdCB0byB0b3AtbGVmdCBjb3JuZXIgb2YgdGhlIGV4dGVudAogICAgICAgIHJldHVybiB0eCwgKDIqKnpvb20gLSAxKSAtIHR5CgogICAgZGVmIFF1YWRUcmVlKHNlbGYsIHR4LCB0eSwgem9vbSk6CiAgICAgICAgIkNvbnZlcnRzIFRNUyB0aWxlIGNvb3JkaW5hdGVzIHRvIE1pY3Jvc29mdCBRdWFkVHJlZSIKCiAgICAgICAgcXVhZEtleSA9ICIiCiAgICAgICAgdHkgPSAoMioqem9vbSAtIDEpIC0gdHkKICAgICAgICBmb3IgaSBpbiByYW5nZSh6b29tLCAwLCAtMSk6CiAgICAgICAgICAgIGRpZ2l0ID0gMAogICAgICAgICAgICBtYXNrID0gMSA8PCAoaS0xKQogICAgICAgICAgICBpZiAodHggJiBtYXNrKSAhPSAwOgogICAgICAgICAgICAgICAgZGlnaXQgKz0gMQogICAgICAgICAgICBpZiAodHkgJiBtYXNrKSAhPSAwOgogICAgICAgICAgICAgICAgZGlnaXQgKz0gMgogICAgICAgICAgICBxdWFkS2V5ICs9IHN0cihkaWdpdCkKCiAgICAgICAgcmV0dXJuIHF1YWRLZXkKCgpjbGFzcyBHbG9iYWxHZW9kZXRpYyhvYmplY3QpOgogICAgciIiIgogICAgVE1TIEdsb2JhbCBHZW9kZXRpYyBQcm9maWxlCiAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgICBGdW5jdGlvbnMgbmVjZXNzYXJ5IGZvciBnZW5lcmF0aW9uIG9mIGdsb2JhbCB0aWxlcyBpbiBQbGF0ZSBDYXJyZSBwcm9qZWN0aW9uLAogICAgRVBTRzo0MzI2LCAidW5wcm9qZWN0ZWQgcHJvZmlsZSIuCgogICAgU3VjaCB0aWxlcyBhcmUgY29tcGF0aWJsZSB3aXRoIEdvb2dsZSBFYXJ0aCAoYXMgYW55IG90aGVyIEVQU0c6NDMyNiByYXN0ZXJzKQogICAgYW5kIHlvdSBjYW4gb3ZlcmxheSB0aGUgdGlsZXMgb24gdG9wIG9mIE9wZW5MYXllcnMgYmFzZSBtYXAuCgogICAgUGl4ZWwgYW5kIHRpbGUgY29vcmRpbmF0ZXMgYXJlIGluIFRNUyBub3RhdGlvbiAob3JpZ2luIFswLDBdIGluIGJvdHRvbS1sZWZ0KS4KCiAgICBXaGF0IGNvb3JkaW5hdGUgY29udmVyc2lvbnMgZG8gd2UgbmVlZCBmb3IgVE1TIEdsb2JhbCBHZW9kZXRpYyB0aWxlcz8KCiAgICAgIEdsb2JhbCBHZW9kZXRpYyB0aWxlcyBhcmUgdXNpbmcgZ2VvZGV0aWMgY29vcmRpbmF0ZXMgKGxhdGl0dWRlLGxvbmdpdHVkZSkKICAgICAgZGlyZWN0bHkgYXMgcGxhbmFyIGNvb3JkaW5hdGVzIFhZIChpdCBpcyBhbHNvIGNhbGxlZCBVbnByb2plY3RlZCBvciBQbGF0ZQogICAgICBDYXJyZSkuIFdlIG5lZWQgb25seSBzY2FsaW5nIHRvIHBpeGVsIHB5cmFtaWQgYW5kIGN1dHRpbmcgdG8gdGlsZXMuCiAgICAgIFB5cmFtaWQgaGFzIG9uIHRvcCBsZXZlbCB0d28gdGlsZXMsIHNvIGl0IGlzIG5vdCBzcXVhcmUgYnV0IHJlY3RhbmdsZS4KICAgICAgQXJlYSBbLTE4MCwtOTAsMTgwLDkwXSBpcyBzY2FsZWQgdG8gNTEyeDI1NiBwaXhlbHMuCiAgICAgIFRNUyBoYXMgY29vcmRpbmF0ZSBvcmlnaW4gKGZvciBwaXhlbHMgYW5kIHRpbGVzKSBpbiBib3R0b20tbGVmdCBjb3JuZXIuCiAgICAgIFJhc3RlcnMgYXJlIGluIEVQU0c6NDMyNiBhbmQgdGhlcmVmb3JlIGFyZSBjb21wYXRpYmxlIHdpdGggR29vZ2xlIEVhcnRoLgoKICAgICAgICAgTGF0TG9uICAgICAgPC0+ICAgICAgUGl4ZWxzICAgICAgPC0+ICAgICBUaWxlcwoKICAgICBXR1M4NCBjb29yZGluYXRlcyAgIFBpeGVscyBpbiBweXJhbWlkICBUaWxlcyBpbiBweXJhbWlkCiAgICAgICAgIGxhdC9sb24gICAgICAgICBYWSBwaXhlbHMgWiB6b29tICAgICAgWFlaIGZyb20gVE1TCiAgICAgICAgRVBTRzo0MzI2CiAgICAgICAgIC4tLS0tLiAgICAgICAgICAgICAgICAtLS0tCiAgICAgICAgLyAgICAgIFwgICAgIDwtPiAgICAvLS0tLS0tLS0vICAgIDwtPiAgICAgIFRNUwogICAgICAgIFwgICAgICAvICAgICAgICAgLy0tLS0tLS0tLS0tLS0tLwogICAgICAgICAtLS0tLSAgICAgICAgLy0tLS0tLS0tLS0tLS0tLS0tLS0tLwogICAgICAgV01TLCBLTUwgICAgV2ViIENsaWVudHMsIEdvb2dsZSBFYXJ0aCAgVGlsZU1hcFNlcnZpY2UKICAgICIiIgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB0bXNjb21wYXRpYmxlLCB0aWxlU2l6ZT0yNTYpOgogICAgICAgIHNlbGYudGlsZVNpemUgPSB0aWxlU2l6ZQogICAgICAgIGlmIHRtc2NvbXBhdGlibGUgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICMgRGVmYXVsdHMgdGhlIHJlc29sdXRpb24gZmFjdG9yIHRvIDAuNzAzMTI1ICgyIHRpbGVzIEAgbGV2ZWwgMCkKICAgICAgICAgICAgIyBBZGhlcnMgdG8gT1NHZW8gVE1TIHNwZWMKICAgICAgICAgICAgIyBodHRwOi8vd2lraS5vc2dlby5vcmcvd2lraS9UaWxlX01hcF9TZXJ2aWNlX1NwZWNpZmljYXRpb24jZ2xvYmFsLWdlb2RldGljCiAgICAgICAgICAgIHNlbGYucmVzRmFjdCA9IDE4MC4wIC8gc2VsZi50aWxlU2l6ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgRGVmYXVsdHMgdGhlIHJlc29sdXRpb24gZmFjdG9yIHRvIDEuNDA2MjUgKDEgdGlsZSBAIGxldmVsIDApCiAgICAgICAgICAgICMgQWRoZXJlcyBPcGVuTGF5ZXJzLCBNYXBQcm94eSwgZXRjIGRlZmF1bHQgcmVzb2x1dGlvbiBmb3IgV01UUwogICAgICAgICAgICBzZWxmLnJlc0ZhY3QgPSAzNjAuMCAvIHNlbGYudGlsZVNpemUKCiAgICBkZWYgTG9uTGF0VG9QaXhlbHMoc2VsZiwgbG9uLCBsYXQsIHpvb20pOgogICAgICAgICJDb252ZXJ0cyBsb24vbGF0IHRvIHBpeGVsIGNvb3JkaW5hdGVzIGluIGdpdmVuIHpvb20gb2YgdGhlIEVQU0c6NDMyNiBweXJhbWlkIgoKICAgICAgICByZXMgPSBzZWxmLnJlc0ZhY3QgLyAyKip6b29tCiAgICAgICAgcHggPSAoMTgwICsgbG9uKSAvIHJlcwogICAgICAgIHB5ID0gKDkwICsgbGF0KSAvIHJlcwogICAgICAgIHJldHVybiBweCwgcHkKCiAgICBkZWYgUGl4ZWxzVG9UaWxlKHNlbGYsIHB4LCBweSk6CiAgICAgICAgIlJldHVybnMgY29vcmRpbmF0ZXMgb2YgdGhlIHRpbGUgY292ZXJpbmcgcmVnaW9uIGluIHBpeGVsIGNvb3JkaW5hdGVzIgoKICAgICAgICB0eCA9IGludChtYXRoLmNlaWwocHggLyBmbG9hdChzZWxmLnRpbGVTaXplKSkgLSAxKQogICAgICAgIHR5ID0gaW50KG1hdGguY2VpbChweSAvIGZsb2F0KHNlbGYudGlsZVNpemUpKSAtIDEpCiAgICAgICAgcmV0dXJuIHR4LCB0eQoKICAgIGRlZiBMb25MYXRUb1RpbGUoc2VsZiwgbG9uLCBsYXQsIHpvb20pOgogICAgICAgICJSZXR1cm5zIHRoZSB0aWxlIGZvciB6b29tIHdoaWNoIGNvdmVycyBnaXZlbiBsb24vbGF0IGNvb3JkaW5hdGVzIgoKICAgICAgICBweCwgcHkgPSBzZWxmLkxvbkxhdFRvUGl4ZWxzKGxvbiwgbGF0LCB6b29tKQogICAgICAgIHJldHVybiBzZWxmLlBpeGVsc1RvVGlsZShweCwgcHkpCgogICAgZGVmIFJlc29sdXRpb24oc2VsZiwgem9vbSk6CiAgICAgICAgIlJlc29sdXRpb24gKGFyYy9waXhlbCkgZm9yIGdpdmVuIHpvb20gbGV2ZWwgKG1lYXN1cmVkIGF0IEVxdWF0b3IpIgoKICAgICAgICByZXR1cm4gc2VsZi5yZXNGYWN0IC8gMioqem9vbQoKICAgIGRlZiBab29tRm9yUGl4ZWxTaXplKHNlbGYsIHBpeGVsU2l6ZSk6CiAgICAgICAgIk1heGltYWwgc2NhbGVkb3duIHpvb20gb2YgdGhlIHB5cmFtaWQgY2xvc2VzdCB0byB0aGUgcGl4ZWxTaXplLiIKCiAgICAgICAgZm9yIGkgaW4gcmFuZ2UoTUFYWk9PTUxFVkVMKToKICAgICAgICAgICAgaWYgcGl4ZWxTaXplID4gc2VsZi5SZXNvbHV0aW9uKGkpOgogICAgICAgICAgICAgICAgaWYgaSAhPSAwOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBpLTEKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAgICAgIyBXZSBkb24ndCB3YW50IHRvIHNjYWxlIHVwCgogICAgZGVmIFRpbGVCb3VuZHMoc2VsZiwgdHgsIHR5LCB6b29tKToKICAgICAgICAiUmV0dXJucyBib3VuZHMgb2YgdGhlIGdpdmVuIHRpbGUiCiAgICAgICAgcmVzID0gc2VsZi5yZXNGYWN0IC8gMioqem9vbQogICAgICAgIHJldHVybiAoCiAgICAgICAgICAgIHR4KnNlbGYudGlsZVNpemUqcmVzIC0gMTgwLAogICAgICAgICAgICB0eSpzZWxmLnRpbGVTaXplKnJlcyAtIDkwLAogICAgICAgICAgICAodHgrMSkqc2VsZi50aWxlU2l6ZSpyZXMgLSAxODAsCiAgICAgICAgICAgICh0eSsxKSpzZWxmLnRpbGVTaXplKnJlcyAtIDkwCiAgICAgICAgKQoKICAgIGRlZiBUaWxlTGF0TG9uQm91bmRzKHNlbGYsIHR4LCB0eSwgem9vbSk6CiAgICAgICAgIlJldHVybnMgYm91bmRzIG9mIHRoZSBnaXZlbiB0aWxlIGluIHRoZSBTV05FIGZvcm0iCiAgICAgICAgYiA9IHNlbGYuVGlsZUJvdW5kcyh0eCwgdHksIHpvb20pCiAgICAgICAgcmV0dXJuIChiWzFdLCBiWzBdLCBiWzNdLCBiWzJdKQoKCmNsYXNzIFpvb21pZnkob2JqZWN0KToKICAgICIiIgogICAgVGlsZXMgY29tcGF0aWJsZSB3aXRoIHRoZSBab29taWZ5IHZpZXdlcgogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHdpZHRoLCBoZWlnaHQsIHRpbGVzaXplPTI1NiwgdGlsZWZvcm1hdD0nanBnJyk6CiAgICAgICAgIiIiSW5pdGlhbGl6YXRpb24gb2YgdGhlIFpvb21pZnkgdGlsZSB0cmVlIiIiCgogICAgICAgIHNlbGYudGlsZXNpemUgPSB0aWxlc2l6ZQogICAgICAgIHNlbGYudGlsZWZvcm1hdCA9IHRpbGVmb3JtYXQKICAgICAgICBpbWFnZXNpemUgPSAod2lkdGgsIGhlaWdodCkKICAgICAgICB0aWxlcyA9IChtYXRoLmNlaWwod2lkdGggLyB0aWxlc2l6ZSksIG1hdGguY2VpbChoZWlnaHQgLyB0aWxlc2l6ZSkpCgogICAgICAgICMgU2l6ZSAoaW4gdGlsZXMpIGZvciBlYWNoIHRpZXIgb2YgcHlyYW1pZC4KICAgICAgICBzZWxmLnRpZXJTaXplSW5UaWxlcyA9IFtdCiAgICAgICAgc2VsZi50aWVyU2l6ZUluVGlsZXMuYXBwZW5kKHRpbGVzKQoKICAgICAgICAjIEltYWdlIHNpemUgaW4gcGl4ZWxzIGZvciBlYWNoIHB5cmFtaWQgdGllcnNlbGYKICAgICAgICBzZWxmLnRpZXJJbWFnZVNpemUgPSBbXQogICAgICAgIHNlbGYudGllckltYWdlU2l6ZS5hcHBlbmQoaW1hZ2VzaXplKQoKICAgICAgICB3aGlsZSAoaW1hZ2VzaXplWzBdID4gdGlsZXNpemUgb3IgaW1hZ2VzaXplWzFdID4gdGlsZXNpemUpOgogICAgICAgICAgICBpbWFnZXNpemUgPSAobWF0aC5mbG9vcihpbWFnZXNpemVbMF0gLyAyKSwgbWF0aC5mbG9vcihpbWFnZXNpemVbMV0gLyAyKSkKICAgICAgICAgICAgdGlsZXMgPSAobWF0aC5jZWlsKGltYWdlc2l6ZVswXSAvIHRpbGVzaXplKSwgbWF0aC5jZWlsKGltYWdlc2l6ZVsxXSAvIHRpbGVzaXplKSkKICAgICAgICAgICAgc2VsZi50aWVyU2l6ZUluVGlsZXMuYXBwZW5kKHRpbGVzKQogICAgICAgICAgICBzZWxmLnRpZXJJbWFnZVNpemUuYXBwZW5kKGltYWdlc2l6ZSkKCiAgICAgICAgc2VsZi50aWVyU2l6ZUluVGlsZXMucmV2ZXJzZSgpCiAgICAgICAgc2VsZi50aWVySW1hZ2VTaXplLnJldmVyc2UoKQoKICAgICAgICAjIERlcHRoIG9mIHRoZSBab29taWZ5IHB5cmFtaWQsIG51bWJlciBvZiB0aWVycyAoem9vbSBsZXZlbHMpCiAgICAgICAgc2VsZi5udW1iZXJPZlRpZXJzID0gbGVuKHNlbGYudGllclNpemVJblRpbGVzKQoKICAgICAgICAjIE51bWJlciBvZiB0aWxlcyB1cCB0byB0aGUgZ2l2ZW4gdGllciBvZiBweXJhbWlkLgogICAgICAgIHNlbGYudGlsZUNvdW50VXBUb1RpZXIgPSBbXQogICAgICAgIHNlbGYudGlsZUNvdW50VXBUb1RpZXJbMF0gPSAwCiAgICAgICAgZm9yIGkgaW4gcmFuZ2UoMSwgc2VsZi5udW1iZXJPZlRpZXJzKzEpOgogICAgICAgICAgICBzZWxmLnRpbGVDb3VudFVwVG9UaWVyLmFwcGVuZCgKICAgICAgICAgICAgICAgIHNlbGYudGllclNpemVJblRpbGVzW2ktMV1bMF0gKiBzZWxmLnRpZXJTaXplSW5UaWxlc1tpLTFdWzFdICsKICAgICAgICAgICAgICAgIHNlbGYudGlsZUNvdW50VXBUb1RpZXJbaS0xXQogICAgICAgICAgICApCgogICAgZGVmIHRpbGVmaWxlbmFtZShzZWxmLCB4LCB5LCB6KToKICAgICAgICAiIiJSZXR1cm5zIGZpbGVuYW1lIGZvciB0aWxlIHdpdGggZ2l2ZW4gY29vcmRpbmF0ZXMiIiIKCiAgICAgICAgdGlsZUluZGV4ID0geCArIHkgKiBzZWxmLnRpZXJTaXplSW5UaWxlc1t6XVswXSArIHNlbGYudGlsZUNvdW50VXBUb1RpZXJbel0KICAgICAgICByZXR1cm4gb3MucGF0aC5qb2luKCJUaWxlR3JvdXAlLjBmIiAlIG1hdGguZmxvb3IodGlsZUluZGV4IC8gMjU2KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICIlcy0lcy0lcy4lcyIgJSAoeiwgeCwgeSwgc2VsZi50aWxlZm9ybWF0KSkKCgpjbGFzcyBHREFMRXJyb3IoRXhjZXB0aW9uKToKICAgIHBhc3MKCgpkZWYgZXhpdF93aXRoX2Vycm9yKG1lc3NhZ2UsIGRldGFpbHM9IiIpOgogICAgIyBNZXNzYWdlIHByaW50aW5nIGFuZCBleGl0IGNvZGUga2VwdCBmcm9tIHRoZSB3YXkgaXQgd29ya2VkIHVzaW5nIHRoZSBPcHRpb25QYXJzZXIgKGluIGNhc2UKICAgICMgc29tZW9uZSBwYXJzZXMgdGhlIGVycm9yIG91dHB1dCkKICAgIHN5cy5zdGRlcnIud3JpdGUoIlVzYWdlOiBnZGFsMnRpbGVzX2xvY2FsLnB5IFtvcHRpb25zXSBpbnB1dF9maWxlIFtvdXRwdXRdXG5cbiIpCiAgICBzeXMuc3RkZXJyLndyaXRlKCJnZGFsMnRpbGVzX2xvY2FsLnB5OiBlcnJvcjogJXNcbiIgJSBtZXNzYWdlKQogICAgaWYgZGV0YWlsczoKICAgICAgICBzeXMuc3RkZXJyLndyaXRlKCJcblxuJXNcbiIgJSBkZXRhaWxzKQoKICAgIHN5cy5leGl0KDIpCgoKZGVmIGdlbmVyYXRlX2ttbCh0eCwgdHksIHR6LCB0aWxlZXh0LCB0aWxlc2l6ZSwgdGlsZXN3bmUsIG9wdGlvbnMsIGNoaWxkcmVuPU5vbmUsICoqYXJncyk6CiAgICAiIiIKICAgIFRlbXBsYXRlIGZvciB0aGUgS01MLiBSZXR1cm5zIGZpbGxlZCBzdHJpbmcuCiAgICAiIiIKICAgIGlmIG5vdCBjaGlsZHJlbjoKICAgICAgICBjaGlsZHJlbiA9IFtdCgogICAgYXJnc1sndHgnXSwgYXJnc1sndHknXSwgYXJnc1sndHonXSA9IHR4LCB0eSwgdHoKICAgIGFyZ3NbJ3RpbGVmb3JtYXQnXSA9IHRpbGVleHQKICAgIGlmICd0aWxlc2l6ZScgbm90IGluIGFyZ3M6CiAgICAgICAgYXJnc1sndGlsZXNpemUnXSA9IHRpbGVzaXplCgogICAgaWYgJ21pbmxvZHBpeGVscycgbm90IGluIGFyZ3M6CiAgICAgICAgYXJnc1snbWlubG9kcGl4ZWxzJ10gPSBpbnQoYXJnc1sndGlsZXNpemUnXSAvIDIpCiAgICBpZiAnbWF4bG9kcGl4ZWxzJyBub3QgaW4gYXJnczoKICAgICAgICBhcmdzWydtYXhsb2RwaXhlbHMnXSA9IGludChhcmdzWyd0aWxlc2l6ZSddICogOCkKICAgIGlmIGNoaWxkcmVuID09IFtdOgogICAgICAgIGFyZ3NbJ21heGxvZHBpeGVscyddID0gLTEKCiAgICBpZiB0eCBpcyBOb25lOgogICAgICAgIHRpbGVrbWwgPSBGYWxzZQogICAgICAgIGFyZ3NbJ3RpdGxlJ10gPSBvcHRpb25zLnRpdGxlCiAgICBlbHNlOgogICAgICAgIHRpbGVrbWwgPSBUcnVlCiAgICAgICAgYXJnc1sndGl0bGUnXSA9ICIlZC8lZC8lZC5rbWwiICUgKHR6LCB0eCwgdHkpCiAgICAgICAgYXJnc1snc291dGgnXSwgYXJnc1snd2VzdCddLCBhcmdzWydub3J0aCddLCBhcmdzWydlYXN0J10gPSB0aWxlc3duZSh0eCwgdHksIHR6KQoKICAgIGlmIHR4ID09IDA6CiAgICAgICAgYXJnc1snZHJhd09yZGVyJ10gPSAyICogdHogKyAxCiAgICBlbGlmIHR4IGlzIG5vdCBOb25lOgogICAgICAgIGFyZ3NbJ2RyYXdPcmRlciddID0gMiAqIHR6CiAgICBlbHNlOgogICAgICAgIGFyZ3NbJ2RyYXdPcmRlciddID0gMAoKICAgIHVybCA9IG9wdGlvbnMudXJsCiAgICBpZiBub3QgdXJsOgogICAgICAgIGlmIHRpbGVrbWw6CiAgICAgICAgICAgIHVybCA9ICIuLi8uLi8iCiAgICAgICAgZWxzZToKICAgICAgICAgICAgdXJsID0gIiIKCiAgICBzID0gIiIiPD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPGttbCB4bWxucz0iaHR0cDovL3d3dy5vcGVuZ2lzLm5ldC9rbWwvMi4yIj4KICA8RG9jdW1lbnQ+CiAgICA8bmFtZT4lKHRpdGxlKXM8L25hbWU+CiAgICA8ZGVzY3JpcHRpb24+PC9kZXNjcmlwdGlvbj4KICAgIDxTdHlsZT4KICAgICAgPExpc3RTdHlsZSBpZD0iaGlkZUNoaWxkcmVuIj4KICAgICAgICA8bGlzdEl0ZW1UeXBlPmNoZWNrSGlkZUNoaWxkcmVuPC9saXN0SXRlbVR5cGU+CiAgICAgIDwvTGlzdFN0eWxlPgogICAgPC9TdHlsZT4iIiIgJSBhcmdzCiAgICBpZiB0aWxla21sOgogICAgICAgIHMgKz0gIiIiCiAgICA8UmVnaW9uPgogICAgICA8TGF0TG9uQWx0Qm94PgogICAgICAgIDxub3J0aD4lKG5vcnRoKS4xNGY8L25vcnRoPgogICAgICAgIDxzb3V0aD4lKHNvdXRoKS4xNGY8L3NvdXRoPgogICAgICAgIDxlYXN0PiUoZWFzdCkuMTRmPC9lYXN0PgogICAgICAgIDx3ZXN0PiUod2VzdCkuMTRmPC93ZXN0PgogICAgICA8L0xhdExvbkFsdEJveD4KICAgICAgPExvZD4KICAgICAgICA8bWluTG9kUGl4ZWxzPiUobWlubG9kcGl4ZWxzKWQ8L21pbkxvZFBpeGVscz4KICAgICAgICA8bWF4TG9kUGl4ZWxzPiUobWF4bG9kcGl4ZWxzKWQ8L21heExvZFBpeGVscz4KICAgICAgPC9Mb2Q+CiAgICA8L1JlZ2lvbj4KICAgIDxHcm91bmRPdmVybGF5PgogICAgICA8ZHJhd09yZGVyPiUoZHJhd09yZGVyKWQ8L2RyYXdPcmRlcj4KICAgICAgPEljb24+CiAgICAgICAgPGhyZWY+JSh0eSlkLiUodGlsZWZvcm1hdClzPC9ocmVmPgogICAgICA8L0ljb24+CiAgICAgIDxMYXRMb25Cb3g+CiAgICAgICAgPG5vcnRoPiUobm9ydGgpLjE0Zjwvbm9ydGg+CiAgICAgICAgPHNvdXRoPiUoc291dGgpLjE0Zjwvc291dGg+CiAgICAgICAgPGVhc3Q+JShlYXN0KS4xNGY8L2Vhc3Q+CiAgICAgICAgPHdlc3Q+JSh3ZXN0KS4xNGY8L3dlc3Q+CiAgICAgIDwvTGF0TG9uQm94PgogICAgPC9Hcm91bmRPdmVybGF5PgoiIiIgJSBhcmdzCgogICAgZm9yIGN4LCBjeSwgY3ogaW4gY2hpbGRyZW46CiAgICAgICAgY3NvdXRoLCBjd2VzdCwgY25vcnRoLCBjZWFzdCA9IHRpbGVzd25lKGN4LCBjeSwgY3opCiAgICAgICAgcyArPSAiIiIKICAgIDxOZXR3b3JrTGluaz4KICAgICAgPG5hbWU+JWQvJWQvJWQuJXM8L25hbWU+CiAgICAgIDxSZWdpb24+CiAgICAgICAgPExhdExvbkFsdEJveD4KICAgICAgICAgIDxub3J0aD4lLjE0Zjwvbm9ydGg+CiAgICAgICAgICA8c291dGg+JS4xNGY8L3NvdXRoPgogICAgICAgICAgPGVhc3Q+JS4xNGY8L2Vhc3Q+CiAgICAgICAgICA8d2VzdD4lLjE0Zjwvd2VzdD4KICAgICAgICA8L0xhdExvbkFsdEJveD4KICAgICAgICA8TG9kPgogICAgICAgICAgPG1pbkxvZFBpeGVscz4lZDwvbWluTG9kUGl4ZWxzPgogICAgICAgICAgPG1heExvZFBpeGVscz4tMTwvbWF4TG9kUGl4ZWxzPgogICAgICAgIDwvTG9kPgogICAgICA8L1JlZ2lvbj4KICAgICAgPExpbms+CiAgICAgICAgPGhyZWY+JXMlZC8lZC8lZC5rbWw8L2hyZWY+CiAgICAgICAgPHZpZXdSZWZyZXNoTW9kZT5vblJlZ2lvbjwvdmlld1JlZnJlc2hNb2RlPgogICAgICAgIDx2aWV3Rm9ybWF0Lz4KICAgICAgPC9MaW5rPgogICAgPC9OZXR3b3JrTGluaz4KICAgICAgICAiIiIgJSAoY3osIGN4LCBjeSwgYXJnc1sndGlsZWZvcm1hdCddLCBjbm9ydGgsIGNzb3V0aCwgY2Vhc3QsIGN3ZXN0LAogICAgICAgICAgICAgICBhcmdzWydtaW5sb2RwaXhlbHMnXSwgdXJsLCBjeiwgY3gsIGN5KQoKICAgIHMgKz0gIiIiICAgICAgPC9Eb2N1bWVudD4KPC9rbWw+CiAgICAiIiIKICAgIHJldHVybiBzCgoKZGVmIHNjYWxlX3F1ZXJ5X3RvX3RpbGUoZHNxdWVyeSwgZHN0aWxlLCB0aWxlZHJpdmVyLCBvcHRpb25zLCB0aWxlZmlsZW5hbWU9JycpOgogICAgIiIiU2NhbGVzIGRvd24gcXVlcnkgZGF0YXNldCB0byB0aGUgdGlsZSBkYXRhc2V0IiIiCgogICAgcXVlcnlzaXplID0gZHNxdWVyeS5SYXN0ZXJYU2l6ZQogICAgdGlsZXNpemUgPSBkc3RpbGUuUmFzdGVyWFNpemUKICAgIHRpbGViYW5kcyA9IGRzdGlsZS5SYXN0ZXJDb3VudAoKICAgIGlmIG9wdGlvbnMucmVzYW1wbGluZyA9PSAnYXZlcmFnZSc6CgogICAgICAgICMgRnVuY3Rpb246IGdkYWwuUmVnZW5lcmF0ZU92ZXJ2aWV3KCkKICAgICAgICBmb3IgaSBpbiByYW5nZSgxLCB0aWxlYmFuZHMrMSk6CiAgICAgICAgICAgICMgQmxhY2sgYm9yZGVyIGFyb3VuZCBOT0RBVEEKICAgICAgICAgICAgcmVzID0gZ2RhbC5SZWdlbmVyYXRlT3ZlcnZpZXcoZHNxdWVyeS5HZXRSYXN0ZXJCYW5kKGkpLCBkc3RpbGUuR2V0UmFzdGVyQmFuZChpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2F2ZXJhZ2UnKQogICAgICAgICAgICBpZiByZXMgIT0gMDoKICAgICAgICAgICAgICAgIGV4aXRfd2l0aF9lcnJvcigiUmVnZW5lcmF0ZU92ZXJ2aWV3KCkgZmFpbGVkIG9uICVzLCBlcnJvciAlZCIgJSAoCiAgICAgICAgICAgICAgICAgICAgdGlsZWZpbGVuYW1lLCByZXMpKQoKICAgIGVsaWYgb3B0aW9ucy5yZXNhbXBsaW5nID09ICdhbnRpYWxpYXMnOgoKICAgICAgICAjIFNjYWxpbmcgYnkgUElMIChQeXRob24gSW1hZ2luZyBMaWJyYXJ5KSAtIGltcHJvdmVkIExhbmN6b3MKICAgICAgICBhcnJheSA9IG51bXB5Lnplcm9zKChxdWVyeXNpemUsIHF1ZXJ5c2l6ZSwgdGlsZWJhbmRzKSwgbnVtcHkudWludDgpCiAgICAgICAgZm9yIGkgaW4gcmFuZ2UodGlsZWJhbmRzKToKICAgICAgICAgICAgYXJyYXlbOiwgOiwgaV0gPSBnZGFsYXJyYXkuQmFuZFJlYWRBc0FycmF5KGRzcXVlcnkuR2V0UmFzdGVyQmFuZChpKzEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMCwgMCwgcXVlcnlzaXplLCBxdWVyeXNpemUpCiAgICAgICAgaW0gPSBJbWFnZS5mcm9tYXJyYXkoYXJyYXksICdSR0JBJykgICAgICMgQWx3YXlzIGZvdXIgYmFuZHMKICAgICAgICBpbTEgPSBpbS5yZXNpemUoKHRpbGVzaXplLCB0aWxlc2l6ZSksIEltYWdlLkFOVElBTElBUykKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyh0aWxlZmlsZW5hbWUpOgogICAgICAgICAgICBpbTAgPSBJbWFnZS5vcGVuKHRpbGVmaWxlbmFtZSkKICAgICAgICAgICAgaW0xID0gSW1hZ2UuY29tcG9zaXRlKGltMSwgaW0wLCBpbTEpCiAgICAgICAgaW0xLnNhdmUodGlsZWZpbGVuYW1lLCB0aWxlZHJpdmVyKQoKICAgIGVsc2U6CgogICAgICAgIGlmIG9wdGlvbnMucmVzYW1wbGluZyA9PSAnbmVhcic6CiAgICAgICAgICAgIGdkYWxfcmVzYW1wbGluZyA9IGdkYWwuR1JBX05lYXJlc3ROZWlnaGJvdXIKCiAgICAgICAgZWxpZiBvcHRpb25zLnJlc2FtcGxpbmcgPT0gJ2JpbGluZWFyJzoKICAgICAgICAgICAgZ2RhbF9yZXNhbXBsaW5nID0gZ2RhbC5HUkFfQmlsaW5lYXIKCiAgICAgICAgZWxpZiBvcHRpb25zLnJlc2FtcGxpbmcgPT0gJ2N1YmljJzoKICAgICAgICAgICAgZ2RhbF9yZXNhbXBsaW5nID0gZ2RhbC5HUkFfQ3ViaWMKCiAgICAgICAgZWxpZiBvcHRpb25zLnJlc2FtcGxpbmcgPT0gJ2N1Ymljc3BsaW5lJzoKICAgICAgICAgICAgZ2RhbF9yZXNhbXBsaW5nID0gZ2RhbC5HUkFfQ3ViaWNTcGxpbmUKCiAgICAgICAgZWxpZiBvcHRpb25zLnJlc2FtcGxpbmcgPT0gJ2xhbmN6b3MnOgogICAgICAgICAgICBnZGFsX3Jlc2FtcGxpbmcgPSBnZGFsLkdSQV9MYW5jem9zCgogICAgICAgICMgT3RoZXIgYWxnb3JpdGhtcyBhcmUgaW1wbGVtZW50ZWQgYnkgZ2RhbC5SZXByb2plY3RJbWFnZSgpLgogICAgICAgIGRzcXVlcnkuU2V0R2VvVHJhbnNmb3JtKCgwLjAsIHRpbGVzaXplIC8gZmxvYXQocXVlcnlzaXplKSwgMC4wLCAwLjAsIDAuMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGlsZXNpemUgLyBmbG9hdChxdWVyeXNpemUpKSkKICAgICAgICBkc3RpbGUuU2V0R2VvVHJhbnNmb3JtKCgwLjAsIDEuMCwgMC4wLCAwLjAsIDAuMCwgMS4wKSkKCiAgICAgICAgcmVzID0gZ2RhbC5SZXByb2plY3RJbWFnZShkc3F1ZXJ5LCBkc3RpbGUsIE5vbmUsIE5vbmUsIGdkYWxfcmVzYW1wbGluZykKICAgICAgICBpZiByZXMgIT0gMDoKICAgICAgICAgICAgZXhpdF93aXRoX2Vycm9yKCJSZXByb2plY3RJbWFnZSgpIGZhaWxlZCBvbiAlcywgZXJyb3IgJWQiICUgKHRpbGVmaWxlbmFtZSwgcmVzKSkKCgpkZWYgc2V0dXBfbm9fZGF0YV92YWx1ZXMoaW5wdXRfZGF0YXNldCwgb3B0aW9ucyk6CiAgICAiIiIKICAgIEV4dHJhY3QgdGhlIE5PREFUQSB2YWx1ZXMgZnJvbSB0aGUgZGF0YXNldCBvciB1c2UgdGhlIHBhc3NlZCBhcmd1bWVudHMgYXMgb3ZlcnJpZGUgaWYgYW55CiAgICAiIiIKICAgIGluX25vZGF0YSA9IFtdCiAgICBpZiBvcHRpb25zLnNyY25vZGF0YToKICAgICAgICBuZHMgPSBsaXN0KG1hcChmbG9hdCwgb3B0aW9ucy5zcmNub2RhdGEuc3BsaXQoJywnKSkpCiAgICAgICAgaWYgbGVuKG5kcykgPCBpbnB1dF9kYXRhc2V0LlJhc3RlckNvdW50OgogICAgICAgICAgICBpbl9ub2RhdGEgPSAobmRzICogaW5wdXRfZGF0YXNldC5SYXN0ZXJDb3VudClbOmlucHV0X2RhdGFzZXQuUmFzdGVyQ291bnRdCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaW5fbm9kYXRhID0gbmRzCiAgICBlbHNlOgogICAgICAgIGZvciBpIGluIHJhbmdlKDEsIGlucHV0X2RhdGFzZXQuUmFzdGVyQ291bnQrMSk6CiAgICAgICAgICAgIHJhc3Rlcl9ub19kYXRhID0gaW5wdXRfZGF0YXNldC5HZXRSYXN0ZXJCYW5kKGkpLkdldE5vRGF0YVZhbHVlKCkKICAgICAgICAgICAgaWYgcmFzdGVyX25vX2RhdGEgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBpbl9ub2RhdGEuYXBwZW5kKHJhc3Rlcl9ub19kYXRhKQoKICAgIGlmIG9wdGlvbnMudmVyYm9zZToKICAgICAgICBwcmludCgiTk9EQVRBOiAlcyIgJSBpbl9ub2RhdGEpCgogICAgcmV0dXJuIGluX25vZGF0YQoKCmRlZiBzZXR1cF9pbnB1dF9zcnMoaW5wdXRfZGF0YXNldCwgb3B0aW9ucyk6CiAgICAiIiIKICAgIERldGVybWluZXMgYW5kIHJldHVybnMgdGhlIElucHV0IFNwYXRpYWwgUmVmZXJlbmNlIFN5c3RlbSAoU1JTKSBhcyBhbiBvc3Igb2JqZWN0IGFuZCBhcyBhCiAgICBXS1QgcmVwcmVzZW50YXRpb24KCiAgICBVc2VzIGluIHByaW9yaXR5IHRoZSBvbmUgcGFzc2VkIGluIHRoZSBjb21tYW5kIGxpbmUgYXJndW1lbnRzLiBJZiBOb25lLCB0cmllcyB0byBleHRyYWN0IHRoZW0KICAgIGZyb20gdGhlIGlucHV0IGRhdGFzZXQKICAgICIiIgoKICAgIGlucHV0X3NycyA9IE5vbmUKICAgIGlucHV0X3Nyc193a3QgPSBOb25lCgogICAgaWYgb3B0aW9ucy5zX3NyczoKICAgICAgICBpbnB1dF9zcnMgPSBvc3IuU3BhdGlhbFJlZmVyZW5jZSgpCiAgICAgICAgaW5wdXRfc3JzLlNldEZyb21Vc2VySW5wdXQob3B0aW9ucy5zX3NycykKICAgICAgICBpbnB1dF9zcnNfd2t0ID0gaW5wdXRfc3JzLkV4cG9ydFRvV2t0KCkKICAgIGVsc2U6CiAgICAgICAgaW5wdXRfc3JzX3drdCA9IGlucHV0X2RhdGFzZXQuR2V0UHJvamVjdGlvbigpCiAgICAgICAgaWYgbm90IGlucHV0X3Nyc193a3QgYW5kIGlucHV0X2RhdGFzZXQuR2V0R0NQQ291bnQoKSAhPSAwOgogICAgICAgICAgICBpbnB1dF9zcnNfd2t0ID0gaW5wdXRfZGF0YXNldC5HZXRHQ1BQcm9qZWN0aW9uKCkKICAgICAgICBpZiBpbnB1dF9zcnNfd2t0OgogICAgICAgICAgICBpbnB1dF9zcnMgPSBvc3IuU3BhdGlhbFJlZmVyZW5jZSgpCiAgICAgICAgICAgIGlucHV0X3Nycy5JbXBvcnRGcm9tV2t0KGlucHV0X3Nyc193a3QpCgogICAgcmV0dXJuIGlucHV0X3NycywgaW5wdXRfc3JzX3drdAoKCmRlZiBzZXR1cF9vdXRwdXRfc3JzKGlucHV0X3Nycywgb3B0aW9ucyk6CiAgICAiIiIKICAgIFNldHVwIHRoZSBkZXNpcmVkIFNSUyAoYmFzZWQgb24gb3B0aW9ucykKICAgICIiIgogICAgb3V0cHV0X3NycyA9IG9zci5TcGF0aWFsUmVmZXJlbmNlKCkKCiAgICBpZiBvcHRpb25zLnByb2ZpbGUgPT0gJ21lcmNhdG9yJzoKICAgICAgICBvdXRwdXRfc3JzLkltcG9ydEZyb21FUFNHKDM4NTcpCiAgICBlbGlmIG9wdGlvbnMucHJvZmlsZSA9PSAnZ2VvZGV0aWMnOgogICAgICAgIG91dHB1dF9zcnMuSW1wb3J0RnJvbUVQU0coNDMyNikKICAgIGVsc2U6CiAgICAgICAgb3V0cHV0X3NycyA9IGlucHV0X3NycwoKICAgIHJldHVybiBvdXRwdXRfc3JzCgoKZGVmIGhhc19nZW9yZWZlcmVuY2UoZGF0YXNldCk6CiAgICByZXR1cm4gKGRhdGFzZXQuR2V0R2VvVHJhbnNmb3JtKCkgIT0gKDAuMCwgMS4wLCAwLjAsIDAuMCwgMC4wLCAxLjApIG9yCiAgICAgICAgICAgIGRhdGFzZXQuR2V0R0NQQ291bnQoKSAhPSAwKQoKCmRlZiByZXByb2plY3RfZGF0YXNldChmcm9tX2RhdGFzZXQsIGZyb21fc3JzLCB0b19zcnMsIG9wdGlvbnM9Tm9uZSk6CiAgICAiIiIKICAgIFJldHVybnMgdGhlIGlucHV0IGRhdGFzZXQgaW4gdGhlIGV4cGVjdGVkICJkZXN0aW5hdGlvbiIgU1JTLgogICAgSWYgdGhlIGRhdGFzZXQgaXMgYWxyZWFkeSBpbiB0aGUgY29ycmVjdCBTUlMsIHJldHVybnMgaXQgdW5tb2RpZmllZAogICAgIiIiCiAgICBpZiBub3QgZnJvbV9zcnMgb3Igbm90IHRvX3NyczoKICAgICAgICByYWlzZSBHREFMRXJyb3IoImZyb20gYW5kIHRvIFNSUyBtdXN0IGJlIGRlZmluZWQgdG8gcmVwcm9qZWN0IHRoZSBkYXRhc2V0IikKCiAgICBpZiAoZnJvbV9zcnMuRXhwb3J0VG9Qcm9qNCgpICE9IHRvX3Nycy5FeHBvcnRUb1Byb2o0KCkpIG9yIChmcm9tX2RhdGFzZXQuR2V0R0NQQ291bnQoKSAhPSAwKToKICAgICAgICB0b19kYXRhc2V0ID0gZ2RhbC5BdXRvQ3JlYXRlV2FycGVkVlJUKGZyb21fZGF0YXNldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb21fc3JzLkV4cG9ydFRvV2t0KCksIHRvX3Nycy5FeHBvcnRUb1drdCgpKQoKICAgICAgICBpZiBvcHRpb25zIGFuZCBvcHRpb25zLnZlcmJvc2U6CiAgICAgICAgICAgIHByaW50KCJXYXJwaW5nIG9mIHRoZSByYXN0ZXIgYnkgQXV0b0NyZWF0ZVdhcnBlZFZSVCAocmVzdWx0IHNhdmVkIGludG8gJ3RpbGVzLnZydCcpIikKICAgICAgICAgICAgdG9fZGF0YXNldC5HZXREcml2ZXIoKS5DcmVhdGVDb3B5KCJ0aWxlcy52cnQiLCB0b19kYXRhc2V0KQoKICAgICAgICByZXR1cm4gdG9fZGF0YXNldAogICAgZWxzZToKICAgICAgICByZXR1cm4gZnJvbV9kYXRhc2V0CgoKZGVmIGFkZF9nZGFsX3dhcnBfb3B0aW9uc190b19zdHJpbmcodnJ0X3N0cmluZywgd2FycF9vcHRpb25zKToKICAgIGlmIG5vdCB3YXJwX29wdGlvbnM6CiAgICAgICAgcmV0dXJuIHZydF9zdHJpbmcKCiAgICB2cnRfcm9vdCA9IEVsZW1lbnRUcmVlLmZyb21zdHJpbmcodnJ0X3N0cmluZykKICAgIG9wdGlvbnMgPSB2cnRfcm9vdC5maW5kKCJHREFMV2FycE9wdGlvbnMiKQoKICAgIGlmIG9wdGlvbnMgaXMgTm9uZToKICAgICAgICByZXR1cm4gdnJ0X3N0cmluZwoKICAgIGZvciBrZXksIHZhbHVlIGluIHdhcnBfb3B0aW9ucy5pdGVtcygpOgogICAgICAgIHRiID0gRWxlbWVudFRyZWUuVHJlZUJ1aWxkZXIoKQogICAgICAgIHRiLnN0YXJ0KCJPcHRpb24iLCB7Im5hbWUiOiBrZXl9KQogICAgICAgIHRiLmRhdGEodmFsdWUpCiAgICAgICAgdGIuZW5kKCJPcHRpb24iKQogICAgICAgIGVsZW0gPSB0Yi5jbG9zZSgpCiAgICAgICAgb3B0aW9ucy5pbnNlcnQoMCwgZWxlbSkKCiAgICByZXR1cm4gRWxlbWVudFRyZWUudG9zdHJpbmcodnJ0X3Jvb3QpLmRlY29kZSgpCgoKZGVmIHVwZGF0ZV9ub19kYXRhX3ZhbHVlcyh3YXJwZWRfdnJ0X2RhdGFzZXQsIG5vZGF0YV92YWx1ZXMsIG9wdGlvbnM9Tm9uZSk6CiAgICAiIiIKICAgIFRha2VzIGFuIGFycmF5IG9mIE5PREFUQSB2YWx1ZXMgYW5kIGZvcmNlcyB0aGVtIG9uIHRoZSBXYXJwZWRWUlQgZmlsZSBkYXRhc2V0IHBhc3NlZAogICAgIiIiCiAgICAjIFRPRE86IGdiYXRhaWxsZSAtIFNlZW1zIHRoYXQgSSBmb3Jnb3QgdGVzdHMgdGhlcmUKICAgIGlmIG5vZGF0YV92YWx1ZXMgIT0gW106CiAgICAgICAgdGVtcF9maWxlID0gZ2V0dGVtcGZpbGVuYW1lKCctZ2RhbDJ0aWxlcy52cnQnKQogICAgICAgIHdhcnBlZF92cnRfZGF0YXNldC5HZXREcml2ZXIoKS5DcmVhdGVDb3B5KHRlbXBfZmlsZSwgd2FycGVkX3ZydF9kYXRhc2V0KQogICAgICAgIHdpdGggb3Blbih0ZW1wX2ZpbGUsICdyJykgYXMgZjoKICAgICAgICAgICAgdnJ0X3N0cmluZyA9IGYucmVhZCgpCgogICAgICAgIHZydF9zdHJpbmcgPSBhZGRfZ2RhbF93YXJwX29wdGlvbnNfdG9fc3RyaW5nKAogICAgICAgICAgICB2cnRfc3RyaW5nLCB7IklOSVRfREVTVCI6ICJOT19EQVRBIiwgIlVOSUZJRURfU1JDX05PREFUQSI6ICJZRVMifSkKCiMgVE9ETzogZ2JhdGFpbGxlIC0gY2hlY2sgdGhlIG5lZWQgZm9yIHRoaXMgcmVwbGFjZW1lbnQuIFNlZW1zIHRvIHdvcmsgd2l0aG91dAojICAgICAgICAgIyByZXBsYWNlIEJhbmRNYXBwaW5nIHRhZyBmb3IgTk9EQVRBIGJhbmRzLi4uLgojICAgICAgICAgZm9yIGkgaW4gcmFuZ2UobGVuKG5vZGF0YV92YWx1ZXMpKToKIyAgICAgICAgICAgICBzID0gcy5yZXBsYWNlKAojICAgICAgICAgICAgICAgICAnPEJhbmRNYXBwaW5nIHNyYz0iJWkiIGRzdD0iJWkiLz4nICUgKChpKzEpLCAoaSsxKSksCiMgICAgICAgICAgICAgICAgICIiIgojIDxCYW5kTWFwcGluZyBzcmM9IiVpIiBkc3Q9IiVpIj4KIyA8U3JjTm9EYXRhUmVhbD4laTwvU3JjTm9EYXRhUmVhbD4KIyA8U3JjTm9EYXRhSW1hZz4wPC9TcmNOb0RhdGFJbWFnPgojIDxEc3ROb0RhdGFSZWFsPiVpPC9Ec3ROb0RhdGFSZWFsPgojIDxEc3ROb0RhdGFJbWFnPjA8L0RzdE5vRGF0YUltYWc+CiMgPC9CYW5kTWFwcGluZz4KIyAgICAgICAgICAgICAgICAgIiIiICUgKChpKzEpLCAoaSsxKSwgbm9kYXRhX3ZhbHVlc1tpXSwgbm9kYXRhX3ZhbHVlc1tpXSkpCgogICAgICAgICMgc2F2ZSB0aGUgY29ycmVjdGVkIFZSVAogICAgICAgIHdpdGggb3Blbih0ZW1wX2ZpbGUsICd3JykgYXMgZjoKICAgICAgICAgICAgZi53cml0ZSh2cnRfc3RyaW5nKQoKICAgICAgICBjb3JyZWN0ZWRfZGF0YXNldCA9IGdkYWwuT3Blbih0ZW1wX2ZpbGUpCiAgICAgICAgb3MudW5saW5rKHRlbXBfZmlsZSkKCiAgICAgICAgIyBzZXQgTk9EQVRBX1ZBTFVFIG1ldGFkYXRhCiAgICAgICAgY29ycmVjdGVkX2RhdGFzZXQuU2V0TWV0YWRhdGFJdGVtKAogICAgICAgICAgICAnTk9EQVRBX1ZBTFVFUycsICcgJy5qb2luKFtzdHIoaSkgZm9yIGkgaW4gbm9kYXRhX3ZhbHVlc10pKQoKICAgICAgICBpZiBvcHRpb25zIGFuZCBvcHRpb25zLnZlcmJvc2U6CiAgICAgICAgICAgIHByaW50KCJNb2RpZmllZCB3YXJwaW5nIHJlc3VsdCBzYXZlZCBpbnRvICd0aWxlczEudnJ0JyIpCiAgICAgICAgICAgICMgVE9ETzogZ2JhdGFpbGxlIC0gdGVzdCByZXBsYWNpbmcgdGhhdCB3aXRoIGEgZ2RhbCB3cml0ZSBvZiB0aGUgZGF0YXNldCAobW9yZQogICAgICAgICAgICAjIGFjY3VyYXRlbHkgd2hhdCdzIHVzZWQsIGV2ZW4gaWYgc2hvdWxkIGJlIHRoZSBzYW1lCiAgICAgICAgICAgIHdpdGggb3BlbigidGlsZXMxLnZydCIsICJ3IikgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGUodnJ0X3N0cmluZykKCiAgICAgICAgcmV0dXJuIGNvcnJlY3RlZF9kYXRhc2V0CgoKZGVmIGFkZF9hbHBoYV9iYW5kX3RvX3N0cmluZ192cnQodnJ0X3N0cmluZyk6CiAgICAjIFRPRE86IGdiYXRhaWxsZSAtIE9sZCBjb2RlIHNwZWFrIG9mIHRoaXMgYmVpbmcgZXF1aXZhbGVudCB0byBnZGFsd2FycCAtZHN0YWxwaGEKICAgICMgVG8gYmUgY2hlY2tlZAoKICAgIHZydF9yb290ID0gRWxlbWVudFRyZWUuZnJvbXN0cmluZyh2cnRfc3RyaW5nKQoKICAgIGluZGV4ID0gMAogICAgbmJfYmFuZHMgPSAwCiAgICBmb3Igc3ViZWxlbSBpbiBsaXN0KHZydF9yb290KToKICAgICAgICBpZiBzdWJlbGVtLnRhZyA9PSAiVlJUUmFzdGVyQmFuZCI6CiAgICAgICAgICAgIG5iX2JhbmRzICs9IDEKICAgICAgICAgICAgY29sb3Jfbm9kZSA9IHN1YmVsZW0uZmluZCgiLi9Db2xvckludGVycCIpCiAgICAgICAgICAgIGlmIGNvbG9yX25vZGUgaXMgbm90IE5vbmUgYW5kIGNvbG9yX25vZGUudGV4dCA9PSAiQWxwaGEiOgogICAgICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJBbHBoYSBiYW5kIGFscmVhZHkgcHJlc2VudCIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgbmJfYmFuZHM6CiAgICAgICAgICAgICAgICAjIFRoaXMgbWVhbnMgdGhhdCB3ZSBhcmUgb25lIGVsZW1lbnQgYWZ0ZXIgdGhlIEJhbmQgZGVmaW5pdGlvbnMKICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgIGluZGV4ICs9IDEKCiAgICB0YiA9IEVsZW1lbnRUcmVlLlRyZWVCdWlsZGVyKCkKICAgIHRiLnN0YXJ0KCJWUlRSYXN0ZXJCYW5kIiwKICAgICAgICAgICAgIHsnZGF0YVR5cGUnOiAiQnl0ZSIsICJiYW5kIjogc3RyKG5iX2JhbmRzICsgMSksICJzdWJDbGFzcyI6ICJWUlRXYXJwZWRSYXN0ZXJCYW5kIn0pCiAgICB0Yi5zdGFydCgiQ29sb3JJbnRlcnAiLCB7fSkKICAgIHRiLmRhdGEoIkFscGhhIikKICAgIHRiLmVuZCgiQ29sb3JJbnRlcnAiKQogICAgdGIuZW5kKCJWUlRSYXN0ZXJCYW5kIikKICAgIGVsZW0gPSB0Yi5jbG9zZSgpCgogICAgdnJ0X3Jvb3QuaW5zZXJ0KGluZGV4LCBlbGVtKQoKICAgIHdhcnBfb3B0aW9ucyA9IHZydF9yb290LmZpbmQoIi4vL0dEQUxXYXJwT3B0aW9ucyIpCiAgICB0YiA9IEVsZW1lbnRUcmVlLlRyZWVCdWlsZGVyKCkKICAgIHRiLnN0YXJ0KCJEc3RBbHBoYUJhbmQiLCB7fSkKICAgIHRiLmRhdGEoc3RyKG5iX2JhbmRzICsgMSkpCiAgICB0Yi5lbmQoIkRzdEFscGhhQmFuZCIpCiAgICBlbGVtID0gdGIuY2xvc2UoKQogICAgd2FycF9vcHRpb25zLmFwcGVuZChlbGVtKQoKICAgICMgVE9ETzogZ2JhdGFpbGxlIC0gdGhpcyBpcyBhIEdEQUxXYXJwT3B0aW9ucy4gV2h5IHB1dCBpdCBpbiBhIHNwZWNpZmljIHBsYWNlPwogICAgdGIgPSBFbGVtZW50VHJlZS5UcmVlQnVpbGRlcigpCiAgICB0Yi5zdGFydCgiT3B0aW9uIiwgeyJuYW1lIjogIklOSVRfREVTVCJ9KQogICAgdGIuZGF0YSgiMCIpCiAgICB0Yi5lbmQoIk9wdGlvbiIpCiAgICBlbGVtID0gdGIuY2xvc2UoKQogICAgd2FycF9vcHRpb25zLmFwcGVuZChlbGVtKQoKICAgIHJldHVybiBFbGVtZW50VHJlZS50b3N0cmluZyh2cnRfcm9vdCkuZGVjb2RlKCkKCgpkZWYgdXBkYXRlX2FscGhhX3ZhbHVlX2Zvcl9ub25fYWxwaGFfaW5wdXRzKHdhcnBlZF92cnRfZGF0YXNldCwgb3B0aW9ucz1Ob25lKToKICAgICIiIgogICAgSGFuZGxlcyBkYXRhc2V0IHdpdGggMSBvciAzIGJhbmRzLCBpLmUuIHdpdGhvdXQgYWxwaGEgY2hhbm5lbCwgaW4gdGhlIGNhc2UgdGhlIG5vZGF0YSB2YWx1ZSBoYXMKICAgIG5vdCBiZWVuIGZvcmNlZCBieSBvcHRpb25zCiAgICAiIiIKICAgIGlmIHdhcnBlZF92cnRfZGF0YXNldC5SYXN0ZXJDb3VudCBpbiBbMSwgM106CiAgICAgICAgdGVtcGZpbGVuYW1lID0gZ2V0dGVtcGZpbGVuYW1lKCctZ2RhbDJ0aWxlcy52cnQnKQogICAgICAgIHdhcnBlZF92cnRfZGF0YXNldC5HZXREcml2ZXIoKS5DcmVhdGVDb3B5KHRlbXBmaWxlbmFtZSwgd2FycGVkX3ZydF9kYXRhc2V0KQogICAgICAgIHdpdGggb3Blbih0ZW1wZmlsZW5hbWUpIGFzIGY6CiAgICAgICAgICAgIG9yaWdfZGF0YSA9IGYucmVhZCgpCiAgICAgICAgYWxwaGFfZGF0YSA9IGFkZF9hbHBoYV9iYW5kX3RvX3N0cmluZ192cnQob3JpZ19kYXRhKQogICAgICAgIHdpdGggb3Blbih0ZW1wZmlsZW5hbWUsICd3JykgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShhbHBoYV9kYXRhKQoKICAgICAgICB3YXJwZWRfdnJ0X2RhdGFzZXQgPSBnZGFsLk9wZW4odGVtcGZpbGVuYW1lKQogICAgICAgIG9zLnVubGluayh0ZW1wZmlsZW5hbWUpCgogICAgICAgIGlmIG9wdGlvbnMgYW5kIG9wdGlvbnMudmVyYm9zZToKICAgICAgICAgICAgcHJpbnQoIk1vZGlmaWVkIC1kc3RhbHBoYSB3YXJwaW5nIHJlc3VsdCBzYXZlZCBpbnRvICd0aWxlczEudnJ0JyIpCiAgICAgICAgICAgICMgVE9ETzogZ2JhdGFpbGxlIC0gdGVzdCByZXBsYWNpbmcgdGhhdCB3aXRoIGEgZ2RhbCB3cml0ZSBvZiB0aGUgZGF0YXNldCAobW9yZQogICAgICAgICAgICAjIGFjY3VyYXRlbHkgd2hhdCdzIHVzZWQsIGV2ZW4gaWYgc2hvdWxkIGJlIHRoZSBzYW1lCiAgICAgICAgICAgIHdpdGggb3BlbigidGlsZXMxLnZydCIsICJ3IikgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGUoYWxwaGFfZGF0YSkKCiAgICByZXR1cm4gd2FycGVkX3ZydF9kYXRhc2V0CgoKZGVmIG5iX2RhdGFfYmFuZHMoZGF0YXNldCk6CiAgICAiIiIKICAgIFJldHVybiB0aGUgbnVtYmVyIG9mIGRhdGEgKG5vbi1hbHBoYSkgYmFuZHMgb2YgYSBnZGFsIGRhdGFzZXQKICAgICIiIgogICAgYWxwaGFiYW5kID0gZGF0YXNldC5HZXRSYXN0ZXJCYW5kKDEpLkdldE1hc2tCYW5kKCkKICAgIGlmICgoYWxwaGFiYW5kLkdldE1hc2tGbGFncygpICYgZ2RhbC5HTUZfQUxQSEEpIG9yCiAgICAgICAgICAgIGRhdGFzZXQuUmFzdGVyQ291bnQgPT0gNCBvcgogICAgICAgICAgICBkYXRhc2V0LlJhc3RlckNvdW50ID09IDIpOgogICAgICAgIHJldHVybiBkYXRhc2V0LlJhc3RlckNvdW50IC0gMQogICAgZWxzZToKICAgICAgICByZXR1cm4gZGF0YXNldC5SYXN0ZXJDb3VudAoKCmRlZiBnZXR0ZW1wZmlsZW5hbWUoc3VmZml4KToKICAgICIiIlJldHVybnMgYSB0ZW1wb3JhcnkgZmlsZW5hbWUiIiIKICAgIGlmICdfJyBpbiBvcy5lbnZpcm9uOgogICAgICAgICMgdGVtcGZpbGUubWt0ZW1wKCkgY3Jhc2hlcyBvbiBzb21lIFdpbmUgdmVyc2lvbnMgKHRoZSBvbmUgb2YgVWJ1bnR1IDEyLjA0IHBhcnRpY3VsYXJseSkKICAgICAgICBpZiBvcy5lbnZpcm9uWydfJ10uZmluZCgnd2luZScpID49IDA6CiAgICAgICAgICAgIHRtcGRpciA9ICcuJwogICAgICAgICAgICBpZiAnVE1QJyBpbiBvcy5lbnZpcm9uOgogICAgICAgICAgICAgICAgdG1wZGlyID0gb3MuZW52aXJvblsnVE1QJ10KICAgICAgICAgICAgaW1wb3J0IHRpbWUKICAgICAgICAgICAgaW1wb3J0IHJhbmRvbQogICAgICAgICAgICByYW5kb20uc2VlZCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgcmFuZG9tX3BhcnQgPSAnZmlsZSVkJyAlIHJhbmRvbS5yYW5kaW50KDAsIDEwMDAwMDAwMDApCiAgICAgICAgICAgIHJldHVybiBvcy5wYXRoLmpvaW4odG1wZGlyLCByYW5kb21fcGFydCArIHN1ZmZpeCkKCiAgICByZXR1cm4gdGVtcGZpbGUubWt0ZW1wKHN1ZmZpeCkKCgpkZWYgY3JlYXRlX2Jhc2VfdGlsZSh0aWxlX2pvYl9pbmZvLCB0aWxlX2RldGFpbCwgb3B0aW9ucywgcXVldWU9Tm9uZSk6CiAgICBnZGFsLkFsbFJlZ2lzdGVyKCkKCiAgICBkYXRhQmFuZHNDb3VudCA9IHRpbGVfam9iX2luZm8ubmJfZGF0YV9iYW5kcwogICAgb3V0cHV0ID0gdGlsZV9qb2JfaW5mby5vdXRwdXRfZmlsZV9wYXRoCiAgICB0aWxlZXh0ID0gdGlsZV9qb2JfaW5mby50aWxlX2V4dGVuc2lvbgogICAgdGlsZXNpemUgPSB0aWxlX2pvYl9pbmZvLnRpbGVfc2l6ZQogICAgb3B0aW9ucyA9IHRpbGVfam9iX2luZm8ub3B0aW9ucwoKICAgIHRpbGViYW5kcyA9IGRhdGFCYW5kc0NvdW50ICsgMQogICAgZHMgPSBnZGFsLk9wZW4odGlsZV9qb2JfaW5mby5zcmNfZmlsZSwgZ2RhbC5HQV9SZWFkT25seSkKICAgIG1lbV9kcnYgPSBnZGFsLkdldERyaXZlckJ5TmFtZSgnTUVNJykKICAgIG91dF9kcnYgPSBnZGFsLkdldERyaXZlckJ5TmFtZSh0aWxlX2pvYl9pbmZvLnRpbGVfZHJpdmVyKQogICAgYWxwaGFiYW5kID0gZHMuR2V0UmFzdGVyQmFuZCgxKS5HZXRNYXNrQmFuZCgpCgogICAgdHggPSB0aWxlX2RldGFpbC50eAogICAgdHkgPSB0aWxlX2RldGFpbC50eQogICAgdHogPSB0aWxlX2RldGFpbC50egogICAgcnggPSB0aWxlX2RldGFpbC5yeAogICAgcnkgPSB0aWxlX2RldGFpbC5yeQogICAgcnhzaXplID0gdGlsZV9kZXRhaWwucnhzaXplCiAgICByeXNpemUgPSB0aWxlX2RldGFpbC5yeXNpemUKICAgIHd4ID0gdGlsZV9kZXRhaWwud3gKICAgIHd5ID0gdGlsZV9kZXRhaWwud3kKICAgIHd4c2l6ZSA9IHRpbGVfZGV0YWlsLnd4c2l6ZQogICAgd3lzaXplID0gdGlsZV9kZXRhaWwud3lzaXplCiAgICBxdWVyeXNpemUgPSB0aWxlX2RldGFpbC5xdWVyeXNpemUKCiAgICAjIFRpbGUgZGF0YXNldCBpbiBtZW1vcnkKICAgIHRpbGVmaWxlbmFtZSA9IG9zLnBhdGguam9pbigKICAgICAgICBvdXRwdXQsIHN0cih0eiksICd7MDowNGR9Jy5mb3JtYXQodHgpICsgIl8iICsgJ3swOjA0ZH0nLmZvcm1hdCh0eSkgKyAiLiIgKyB0aWxlZXh0KQogICAgZHN0aWxlID0gbWVtX2Rydi5DcmVhdGUoJycsIHRpbGVzaXplLCB0aWxlc2l6ZSwgdGlsZWJhbmRzKQoKICAgIGRhdGEgPSBhbHBoYSA9IE5vbmUKCiAgICBpZiBvcHRpb25zLnZlcmJvc2U6CiAgICAgICAgcHJpbnQoIlx0UmVhZFJhc3RlciBFeHRlbnQ6ICIsCiAgICAgICAgICAgICAgKHJ4LCByeSwgcnhzaXplLCByeXNpemUpLCAod3gsIHd5LCB3eHNpemUsIHd5c2l6ZSkpCgogICAgIyBRdWVyeSBpcyBpbiAnbmVhcmVzdCBuZWlnaGJvdXInIGJ1dCBjYW4gYmUgYmlnZ2VyIGluIHRoZW4gdGhlIHRpbGVzaXplCiAgICAjIFdlIHNjYWxlIGRvd24gdGhlIHF1ZXJ5IHRvIHRoZSB0aWxlc2l6ZSBieSBzdXBwbGllZCBhbGdvcml0aG0uCgogICAgaWYgcnhzaXplICE9IDAgYW5kIHJ5c2l6ZSAhPSAwIGFuZCB3eHNpemUgIT0gMCBhbmQgd3lzaXplICE9IDA6CiAgICAgICAgZGF0YSA9IGRzLlJlYWRSYXN0ZXIocngsIHJ5LCByeHNpemUsIHJ5c2l6ZSwgd3hzaXplLCB3eXNpemUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFuZF9saXN0PWxpc3QocmFuZ2UoMSwgZGF0YUJhbmRzQ291bnQrMSkpKQogICAgICAgIGFscGhhID0gYWxwaGFiYW5kLlJlYWRSYXN0ZXIocngsIHJ5LCByeHNpemUsIHJ5c2l6ZSwgd3hzaXplLCB3eXNpemUpCgogICAgIyBUaGUgdGlsZSBpbiBtZW1vcnkgaXMgYSB0cmFuc3BhcmVudCBmaWxlIGJ5IGRlZmF1bHQuIFdyaXRlIHBpeGVsIHZhbHVlcyBpbnRvIGl0IGlmCiAgICAjIGFueQogICAgaWYgZGF0YToKICAgICAgICBpZiB0aWxlc2l6ZSA9PSBxdWVyeXNpemU6CiAgICAgICAgICAgICMgVXNlIHRoZSBSZWFkUmFzdGVyIHJlc3VsdCBkaXJlY3RseSBpbiB0aWxlcyAoJ25lYXJlc3QgbmVpZ2hib3VyJyBxdWVyeSkKICAgICAgICAgICAgZHN0aWxlLldyaXRlUmFzdGVyKHd4LCB3eSwgd3hzaXplLCB3eXNpemUsIGRhdGEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYW5kX2xpc3Q9bGlzdChyYW5nZSgxLCBkYXRhQmFuZHNDb3VudCsxKSkpCiAgICAgICAgICAgIGRzdGlsZS5Xcml0ZVJhc3Rlcih3eCwgd3ksIHd4c2l6ZSwgd3lzaXplLCBhbHBoYSwgYmFuZF9saXN0PVt0aWxlYmFuZHNdKQoKICAgICAgICAgICAgIyBOb3RlOiBGb3Igc291cmNlIGRyaXZlcnMgYmFzZWQgb24gV2F2ZUxldCBjb21wcmVzc2lvbiAoSlBFRzIwMDAsIEVDVywKICAgICAgICAgICAgIyBNclNJRCkgdGhlIFJlYWRSYXN0ZXIgZnVuY3Rpb24gcmV0dXJucyBoaWdoLXF1YWxpdHkgcmFzdGVyIChub3QgdWdseQogICAgICAgICAgICAjIG5lYXJlc3QgbmVpZ2hib3VyKQogICAgICAgICAgICAjIFRPRE86IFVzZSBkaXJlY3RseSAnbmVhcicgZm9yIFdhdmVMZXQgZmlsZXMKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIEJpZyBSZWFkUmFzdGVyIHF1ZXJ5IGluIG1lbW9yeSBzY2FsZWQgdG8gdGhlIHRpbGVzaXplIC0gYWxsIGJ1dCAnbmVhcicKICAgICAgICAgICAgIyBhbGdvCiAgICAgICAgICAgIGRzcXVlcnkgPSBtZW1fZHJ2LkNyZWF0ZSgnJywgcXVlcnlzaXplLCBxdWVyeXNpemUsIHRpbGViYW5kcykKICAgICAgICAgICAgIyBUT0RPOiBmaWxsIHRoZSBudWxsIHZhbHVlIGluIGNhc2UgYSB0aWxlIHdpdGhvdXQgYWxwaGEgaXMgcHJvZHVjZWQgKG5vdwogICAgICAgICAgICAjIG9ubHkgcG5nIHRpbGVzIGFyZSBzdXBwb3J0ZWQpCiAgICAgICAgICAgIGRzcXVlcnkuV3JpdGVSYXN0ZXIod3gsIHd5LCB3eHNpemUsIHd5c2l6ZSwgZGF0YSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYW5kX2xpc3Q9bGlzdChyYW5nZSgxLCBkYXRhQmFuZHNDb3VudCsxKSkpCiAgICAgICAgICAgIGRzcXVlcnkuV3JpdGVSYXN0ZXIod3gsIHd5LCB3eHNpemUsIHd5c2l6ZSwgYWxwaGEsIGJhbmRfbGlzdD1bdGlsZWJhbmRzXSkKCiAgICAgICAgICAgIHNjYWxlX3F1ZXJ5X3RvX3RpbGUoZHNxdWVyeSwgZHN0aWxlLCB0aWxlX2pvYl9pbmZvLnRpbGVfZHJpdmVyLCBvcHRpb25zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbGVmaWxlbmFtZT10aWxlZmlsZW5hbWUpCiAgICAgICAgICAgIGRlbCBkc3F1ZXJ5CgogICAgIyBGb3JjZSBmcmVlaW5nIHRoZSBtZW1vcnkgdG8gbWFrZSBzdXJlIHRoZSBDKysgZGVzdHJ1Y3RvciBpcyBjYWxsZWQgYW5kIHRoZSBtZW1vcnkgYXMgd2VsbCBhcwogICAgIyB0aGUgZmlsZSBsb2NrcyBhcmUgcmVsZWFzZWQKICAgIGRlbCBkcwogICAgZGVsIGRhdGEKCiAgICBpZiBvcHRpb25zLnJlc2FtcGxpbmcgIT0gJ2FudGlhbGlhcyc6CiAgICAgICAgIyBXcml0ZSBhIGNvcHkgb2YgdGlsZSB0byBwbmcvanBnCiAgICAgICAgb3V0X2Rydi5DcmVhdGVDb3B5KHRpbGVmaWxlbmFtZSwgZHN0aWxlLCBzdHJpY3Q9MCkKCiAgICBkZWwgZHN0aWxlCgogICAgb3B0aW9ucy5nZW5lcmF0ZWRGaWxlcy5hcHBlbmQodGlsZWZpbGVuYW1lKQogICAgIyBhcHBseUxlZ2VuZCh0aWxlZmlsZW5hbWUsIG9wdGlvbnMubGVnZW5kT2JqKQoKICAgICMgIyBDcmVhdGUgYSBLTUwgZmlsZSBmb3IgdGhpcyB0aWxlLgogICAgIyBpZiB0aWxlX2pvYl9pbmZvLmttbDoKICAgICMgICAgIGttbGZpbGVuYW1lID0gb3MucGF0aC5qb2luKG91dHB1dCwgc3RyKHR6KSwgc3RyKHR4KSwgJyVkLmttbCcgJSB0eSkKICAgICMgICAgIGlmIG5vdCBvcHRpb25zLnJlc3VtZSBvciBub3Qgb3MucGF0aC5leGlzdHMoa21sZmlsZW5hbWUpOgogICAgIyAgICAgICAgIHdpdGggb3BlbihrbWxmaWxlbmFtZSwgJ3diJykgYXMgZjoKICAgICMgICAgICAgICAgICAgZi53cml0ZShnZW5lcmF0ZV9rbWwoCiAgICAjICAgICAgICAgICAgICAgICB0eCwgdHksIHR6LCB0aWxlX2pvYl9pbmZvLnRpbGVfZXh0ZW5zaW9uLCB0aWxlX2pvYl9pbmZvLnRpbGVfc2l6ZSwKICAgICMgICAgICAgICAgICAgICAgIHRpbGVfam9iX2luZm8udGlsZV9zd25lLCB0aWxlX2pvYl9pbmZvLm9wdGlvbnMKICAgICMgICAgICAgICAgICAgKS5lbmNvZGUoJ3V0Zi04JykpCgogICAgaWYgcXVldWU6CiAgICAgICAgcXVldWUucHV0KCJ0aWxlICVzICVzICVzIiAlICh0eCwgdHksIHR6KSkKCgpkZWYgY3JlYXRlX292ZXJ2aWV3X3RpbGVzKHRpbGVfam9iX2luZm8sIG91dHB1dF9mb2xkZXIsIG9wdGlvbnMpOgogICAgIiIiR2VuZXJhdGlvbiBvZiB0aGUgb3ZlcnZpZXcgdGlsZXMgKGhpZ2hlciBpbiB0aGUgcHlyYW1pZCkgYmFzZWQgb24gZXhpc3RpbmcgdGlsZXMiIiIKICAgIG1lbV9kcml2ZXIgPSBnZGFsLkdldERyaXZlckJ5TmFtZSgnTUVNJykKICAgIHRpbGVfZHJpdmVyID0gdGlsZV9qb2JfaW5mby50aWxlX2RyaXZlcgogICAgb3V0X2RyaXZlciA9IGdkYWwuR2V0RHJpdmVyQnlOYW1lKHRpbGVfZHJpdmVyKQoKICAgIHRpbGViYW5kcyA9IHRpbGVfam9iX2luZm8ubmJfZGF0YV9iYW5kcyArIDEKCiAgICAjIFVzYWdlIG9mIGV4aXN0aW5nIHRpbGVzOiBmcm9tIDQgdW5kZXJseWluZyB0aWxlcyBnZW5lcmF0ZSBvbmUgYXMgb3ZlcnZpZXcuCgogICAgdGNvdW50ID0gMAogICAgZm9yIHR6IGluIHJhbmdlKHRpbGVfam9iX2luZm8udG1heHogLSAxLCB0aWxlX2pvYl9pbmZvLnRtaW56IC0gMSwgLTEpOgogICAgICAgIHRtaW54LCB0bWlueSwgdG1heHgsIHRtYXh5ID0gdGlsZV9qb2JfaW5mby50bWlubWF4W3R6XQogICAgICAgIHRjb3VudCArPSAoMSArIGFicyh0bWF4eC10bWlueCkpICogKDEgKyBhYnModG1heHktdG1pbnkpKQoKICAgIHRpID0gMAoKICAgIGlmIHRjb3VudCA9PSAwOgogICAgICAgIHJldHVybgoKICAgIGlmIG5vdCBvcHRpb25zLnF1aWV0OgogICAgICAgIHByaW50KCJHZW5lcmF0aW5nIE92ZXJ2aWV3IFRpbGVzOiIpCgogICAgcHJvZ3Jlc3NfYmFyID0gUHJvZ3Jlc3NCYXIodGNvdW50KQogICAgcHJvZ3Jlc3NfYmFyLnN0YXJ0KCkKCiAgICBmb3IgdHogaW4gcmFuZ2UodGlsZV9qb2JfaW5mby50bWF4eiAtIDEsIHRpbGVfam9iX2luZm8udG1pbnogLSAxLCAtMSk6CiAgICAgICAgdG1pbngsIHRtaW55LCB0bWF4eCwgdG1heHkgPSB0aWxlX2pvYl9pbmZvLnRtaW5tYXhbdHpdCiAgICAgICAgZm9yIHR5IGluIHJhbmdlKHRtYXh5LCB0bWlueSAtIDEsIC0xKToKICAgICAgICAgICAgZm9yIHR4IGluIHJhbmdlKHRtaW54LCB0bWF4eCArIDEpOgoKICAgICAgICAgICAgICAgIHRpICs9IDEKICAgICAgICAgICAgICAgIHl0aWxlID0gR0RBTDJUaWxlcy5nZXRZdGlsZSh0eSwgdHosIG9wdGlvbnMpCiAgICAgICAgICAgICAgICB0aWxlZmlsZW5hbWUgPSBvcy5wYXRoLmpvaW4ob3V0cHV0X2ZvbGRlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHIodHopLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICNzdHIodHgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMiJXMuJXMiICUgKHl0aWxlLCB0aWxlX2pvYl9pbmZvLnRpbGVfZXh0ZW5zaW9uKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnezA6MDRkfScuZm9ybWF0KHR4KSArICJfIiArICd7MDowNGR9Jy5mb3JtYXQoeXRpbGUpICsgIi4iICsgdGlsZV9qb2JfaW5mby50aWxlX2V4dGVuc2lvbikKCiAgICAgICAgICAgICAgICBpZiBvcHRpb25zLnZlcmJvc2U6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQodGksICcvJywgdGNvdW50LCB0aWxlZmlsZW5hbWUpCgogICAgICAgICAgICAgICAgaWYgb3B0aW9ucy5yZXN1bWUgYW5kIG9zLnBhdGguZXhpc3RzKHRpbGVmaWxlbmFtZSk6CiAgICAgICAgICAgICAgICAgICAgaWYgb3B0aW9ucy52ZXJib3NlOgogICAgICAgICAgICAgICAgICAgICAgICBwcmludCgiVGlsZSBnZW5lcmF0aW9uIHNraXBwZWQgYmVjYXVzZSBvZiAtLXJlc3VtZSIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3NfYmFyLmxvZ19wcm9ncmVzcygpCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICAgICAjIENyZWF0ZSBkaXJlY3RvcmllcyBmb3IgdGhlIHRpbGUKICAgICAgICAgICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmRpcm5hbWUodGlsZWZpbGVuYW1lKSk6CiAgICAgICAgICAgICAgICAgICAgb3MubWFrZWRpcnMob3MucGF0aC5kaXJuYW1lKHRpbGVmaWxlbmFtZSkpCgogICAgICAgICAgICAgICAgZHNxdWVyeSA9IG1lbV9kcml2ZXIuQ3JlYXRlKCcnLCAyICogdGlsZV9qb2JfaW5mby50aWxlX3NpemUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMiAqIHRpbGVfam9iX2luZm8udGlsZV9zaXplLCB0aWxlYmFuZHMpCiAgICAgICAgICAgICAgICAjIFRPRE86IGZpbGwgdGhlIG51bGwgdmFsdWUKICAgICAgICAgICAgICAgIGRzdGlsZSA9IG1lbV9kcml2ZXIuQ3JlYXRlKCcnLCB0aWxlX2pvYl9pbmZvLnRpbGVfc2l6ZSwgdGlsZV9qb2JfaW5mby50aWxlX3NpemUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aWxlYmFuZHMpCgogICAgICAgICAgICAgICAgIyBUT0RPOiBJbXBsZW1lbnQgbW9yZSBjbGV2ZXIgd2Fsa2luZyBvbiB0aGUgdGlsZXMgd2l0aCBjYWNoZSBmdW5jdGlvbmFsaXR5CiAgICAgICAgICAgICAgICAjIHByb2JhYmx5IHdhbGsgc2hvdWxkIHN0YXJ0IHdpdGggcmVhZGluZyBvZiBmb3VyIHRpbGVzIGZyb20gdG9wIGxlZnQgY29ybmVyCiAgICAgICAgICAgICAgICAjIEhpbGJlcnQgY3VydmUKCiAgICAgICAgICAgICAgICBjaGlsZHJlbiA9IFtdCiAgICAgICAgICAgICAgICAjIFJlYWQgdGhlIHRpbGVzIGFuZCB3cml0ZSB0aGVtIHRvIHF1ZXJ5IHdpbmRvdwogICAgICAgICAgICAgICAgZm9yIHkgaW4gcmFuZ2UoMiAqIHR5LCAyICogdHkgKyAyKToKICAgICAgICAgICAgICAgICAgICBmb3IgeCBpbiByYW5nZSgyICogdHgsIDIgKiB0eCArIDIpOgogICAgICAgICAgICAgICAgICAgICAgICBtaW54LCBtaW55LCBtYXh4LCBtYXh5ID0gdGlsZV9qb2JfaW5mby50bWlubWF4W3R6ICsgMV0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgeCA+PSBtaW54IGFuZCB4IDw9IG1heHggYW5kIHkgPj0gbWlueSBhbmQgeSA8PSBtYXh5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgeXRpbGUyID0gR0RBTDJUaWxlcy5nZXRZdGlsZSh5LCB0eisxLCBvcHRpb25zKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHNxdWVyeXRpbGUgPSBnZGFsLk9wZW4oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3MucGF0aC5qb2luKG91dHB1dF9mb2xkZXIsIHN0cih0eiArIDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnezA6MDRkfScuZm9ybWF0KHgpICsgIl8iICsgJ3swOjA0ZH0nLmZvcm1hdCh5dGlsZTIpICsgIi4iICsgdGlsZV9qb2JfaW5mby50aWxlX2V4dGVuc2lvbiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICNzdHIoeCksICIlcy4lcyIgJSAoeXRpbGUyLCB0aWxlX2pvYl9pbmZvLnRpbGVfZXh0ZW5zaW9uKSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2RhbC5HQV9SZWFkT25seSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eSA9PSAwIGFuZCB5ID09IDEpIG9yICh0eSAhPSAwIGFuZCAoeSAlICgyICogdHkpKSAhPSAwKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aWxlcG9zeSA9IDAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGlsZXBvc3kgPSB0aWxlX2pvYl9pbmZvLnRpbGVfc2l6ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdHg6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGlsZXBvc3ggPSB4ICUgKDIgKiB0eCkgKiB0aWxlX2pvYl9pbmZvLnRpbGVfc2l6ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiB0eCA9PSAwIGFuZCB4ID09IDE6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGlsZXBvc3ggPSB0aWxlX2pvYl9pbmZvLnRpbGVfc2l6ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aWxlcG9zeCA9IDAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRzcXVlcnkuV3JpdGVSYXN0ZXIoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGlsZXBvc3gsIHRpbGVwb3N5LCB0aWxlX2pvYl9pbmZvLnRpbGVfc2l6ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aWxlX2pvYl9pbmZvLnRpbGVfc2l6ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkc3F1ZXJ5dGlsZS5SZWFkUmFzdGVyKDAsIDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aWxlX2pvYl9pbmZvLnRpbGVfc2l6ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbGVfam9iX2luZm8udGlsZV9zaXplKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYW5kX2xpc3Q9bGlzdChyYW5nZSgxLCB0aWxlYmFuZHMgKyAxKSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbi5hcHBlbmQoW3gsIHksIHR6ICsgMV0pCgogICAgICAgICAgICAgICAgc2NhbGVfcXVlcnlfdG9fdGlsZShkc3F1ZXJ5LCBkc3RpbGUsIHRpbGVfZHJpdmVyLCBvcHRpb25zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aWxlZmlsZW5hbWU9dGlsZWZpbGVuYW1lKQogICAgICAgICAgICAgICAgIyBXcml0ZSBhIGNvcHkgb2YgdGlsZSB0byBwbmcvanBnCiAgICAgICAgICAgICAgICBpZiBvcHRpb25zLnJlc2FtcGxpbmcgIT0gJ2FudGlhbGlhcyc6CiAgICAgICAgICAgICAgICAgICAgIyBXcml0ZSBhIGNvcHkgb2YgdGlsZSB0byBwbmcvanBnCiAgICAgICAgICAgICAgICAgICAgb3V0X2RyaXZlci5DcmVhdGVDb3B5KHRpbGVmaWxlbmFtZSwgZHN0aWxlLCBzdHJpY3Q9MCkKCiAgICAgICAgICAgICAgICBkZWwgZHN0aWxlCgogICAgICAgICAgICAgICAgb3B0aW9ucy5nZW5lcmF0ZWRGaWxlcy5hcHBlbmQodGlsZWZpbGVuYW1lKQogICAgICAgICAgICAgICAgIyBhcHBseUxlZ2VuZCh0aWxlZmlsZW5hbWUsIG9wdGlvbnMubGVnZW5kT2JqKQoKICAgICAgICAgICAgICAgIGlmIG9wdGlvbnMudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICBwcmludCgiXHRidWlsZCBmcm9tIHpvb20iLCB0eiArIDEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIiB0aWxlczoiLCAoMiAqIHR4LCAyICogdHkpLCAoMiAqIHR4ICsgMSwgMiAqIHR5KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAoMiAqIHR4LCAyICogdHkgKyAxKSwgKDIgKiB0eCArIDEsIDIgKiB0eSArIDEpKQoKICAgICAgICAgICAgICAgICMgIyBDcmVhdGUgYSBLTUwgZmlsZSBmb3IgdGhpcyB0aWxlLgogICAgICAgICAgICAgICAgIyBpZiB0aWxlX2pvYl9pbmZvLmttbDoKICAgICAgICAgICAgICAgICMgICAgIHdpdGggb3Blbihvcy5wYXRoLmpvaW4oCiAgICAgICAgICAgICAgICAjICAgICAgICAgb3V0cHV0X2ZvbGRlciwKICAgICAgICAgICAgICAgICMgICAgICAgICAnJWQvJWQvJWQua21sJyAlICh0eiwgdHgsIHR5KQogICAgICAgICAgICAgICAgIyAgICAgKSwgJ3diJykgYXMgZjoKICAgICAgICAgICAgICAgICMgICAgICAgICBmLndyaXRlKGdlbmVyYXRlX2ttbCgKICAgICAgICAgICAgICAgICMgICAgICAgICAgICAgdHgsIHR5LCB0eiwgdGlsZV9qb2JfaW5mby50aWxlX2V4dGVuc2lvbiwgdGlsZV9qb2JfaW5mby50aWxlX3NpemUsCiAgICAgICAgICAgICAgICAjICAgICAgICAgICAgIGdldF90aWxlX3N3bmUodGlsZV9qb2JfaW5mbywgb3B0aW9ucyksIG9wdGlvbnMsIGNoaWxkcmVuCiAgICAgICAgICAgICAgICAjICAgICAgICAgKS5lbmNvZGUoJ3V0Zi04JykpCgogICAgICAgICAgICAgICAgaWYgbm90IG9wdGlvbnMudmVyYm9zZSBhbmQgbm90IG9wdGlvbnMucXVpZXQ6CiAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3NfYmFyLmxvZ19wcm9ncmVzcygpCgoKZGVmIG9wdHBhcnNlX2luaXQoKToKICAgICIiIlByZXBhcmUgdGhlIG9wdGlvbiBwYXJzZXIgZm9yIGlucHV0IChhcmd2KSIiIgoKICAgIGZyb20gb3B0cGFyc2UgaW1wb3J0IE9wdGlvblBhcnNlciwgT3B0aW9uR3JvdXAKICAgIHVzYWdlID0gIlVzYWdlOiAlcHJvZyBbb3B0aW9uc10gaW5wdXRfZmlsZSBbb3V0cHV0XSIKICAgIHAgPSBPcHRpb25QYXJzZXIodXNhZ2UsIHZlcnNpb249IiVwcm9nICIgKyBfX3ZlcnNpb25fXykKICAgIHAuYWRkX29wdGlvbigiLXAiLCAiLS1wcm9maWxlIiwgZGVzdD0ncHJvZmlsZScsCiAgICAgICAgICAgICAgICAgdHlwZT0nY2hvaWNlJywgY2hvaWNlcz1wcm9maWxlX2xpc3QsCiAgICAgICAgICAgICAgICAgaGVscD0oIlRpbGUgY3V0dGluZyBwcm9maWxlICglcykgLSBkZWZhdWx0ICdtZXJjYXRvcicgIgogICAgICAgICAgICAgICAgICAgICAgICIoR29vZ2xlIE1hcHMgY29tcGF0aWJsZSkiICUgIiwiLmpvaW4ocHJvZmlsZV9saXN0KSkpCiAgICBwLmFkZF9vcHRpb24oIi1yIiwgIi0tcmVzYW1wbGluZyIsIGRlc3Q9InJlc2FtcGxpbmciLAogICAgICAgICAgICAgICAgIHR5cGU9J2Nob2ljZScsIGNob2ljZXM9cmVzYW1wbGluZ19saXN0LAogICAgICAgICAgICAgICAgIGhlbHA9IlJlc2FtcGxpbmcgbWV0aG9kICglcykgLSBkZWZhdWx0ICdhdmVyYWdlJyIgJSAiLCIuam9pbihyZXNhbXBsaW5nX2xpc3QpKQogICAgcC5hZGRfb3B0aW9uKCItcyIsICItLXNfc3JzIiwgZGVzdD0ic19zcnMiLCBtZXRhdmFyPSJTUlMiLAogICAgICAgICAgICAgICAgIGhlbHA9IlRoZSBzcGF0aWFsIHJlZmVyZW5jZSBzeXN0ZW0gdXNlZCBmb3IgdGhlIHNvdXJjZSBpbnB1dCBkYXRhIikKICAgIHAuYWRkX29wdGlvbigiLXoiLCAiLS16b29tIiwgZGVzdD0iem9vbSIsCiAgICAgICAgICAgICAgICAgaGVscD0iWm9vbSBsZXZlbHMgdG8gcmVuZGVyIChmb3JtYXQ6JzItNScgb3IgJzEwJykuIikKICAgIHAuYWRkX29wdGlvbigiLWUiLCAiLS1yZXN1bWUiLCBkZXN0PSJyZXN1bWUiLCBhY3Rpb249InN0b3JlX3RydWUiLAogICAgICAgICAgICAgICAgIGhlbHA9IlJlc3VtZSBtb2RlLiBHZW5lcmF0ZSBvbmx5IG1pc3NpbmcgZmlsZXMuIikKICAgIHAuYWRkX29wdGlvbigiLWEiLCAiLS1zcmNub2RhdGEiLCBkZXN0PSJzcmNub2RhdGEiLCBtZXRhdmFyPSJOT0RBVEEiLAogICAgICAgICAgICAgICAgIGhlbHA9Ik5PREFUQSB0cmFuc3BhcmVuY3kgdmFsdWUgdG8gYXNzaWduIHRvIHRoZSBpbnB1dCBkYXRhIikKICAgIHAuYWRkX29wdGlvbigiLWQiLCAiLS10bXNjb21wYXRpYmxlIiwgZGVzdD0idG1zY29tcGF0aWJsZSIsIGFjdGlvbj0ic3RvcmVfdHJ1ZSIsCiAgICAgICAgICAgICAgICAgaGVscD0oIldoZW4gdXNpbmcgdGhlIGdlb2RldGljIHByb2ZpbGUsIHNwZWNpZmllcyB0aGUgYmFzZSByZXNvbHV0aW9uICIKICAgICAgICAgICAgICAgICAgICAgICAiYXMgMC43MDMxMjUgb3IgMiB0aWxlcyBhdCB6b29tIGxldmVsIDAuIikpCiAgICBwLmFkZF9vcHRpb24oIi14IiwgIi0teHl6IiwgCiAgICAgICAgICAgICAgICAgYWN0aW9uPSdzdG9yZV90cnVlJywgZGVzdD0neHl6JywKICAgICAgICAgICAgICAgICBoZWxwPSJVc2UgWFlaIHRpbGUgbnVtYmVyaW5nIGluc3RlYWQgb2YgVE1TIikKICAgIHAuYWRkX29wdGlvbigiLXYiLCAiLS12ZXJib3NlIiwKICAgICAgICAgICAgICAgICBhY3Rpb249InN0b3JlX3RydWUiLCBkZXN0PSJ2ZXJib3NlIiwKICAgICAgICAgICAgICAgICBoZWxwPSJQcmludCBzdGF0dXMgbWVzc2FnZXMgdG8gc3Rkb3V0IikKICAgIHAuYWRkX29wdGlvbigiLXEiLCAiLS1xdWlldCIsCiAgICAgICAgICAgICAgICAgYWN0aW9uPSJzdG9yZV90cnVlIiwgZGVzdD0icXVpZXQiLAogICAgICAgICAgICAgICAgIGhlbHA9IkRpc2FibGUgbWVzc2FnZXMgYW5kIHN0YXR1cyB0byBzdGRvdXQiKQogICAgcC5hZGRfb3B0aW9uKCItLXByb2Nlc3NlcyIsCiAgICAgICAgICAgICAgICAgZGVzdD0ibmJfcHJvY2Vzc2VzIiwKICAgICAgICAgICAgICAgICB0eXBlPSdpbnQnLAogICAgICAgICAgICAgICAgIGhlbHA9Ik51bWJlciBvZiBwcm9jZXNzZXMgdG8gdXNlIGZvciB0aWxpbmciKQoKICAgICMgS01MIG9wdGlvbnMKICAgIGcgPSBPcHRpb25Hcm91cChwLCAiS01MIChHb29nbGUgRWFydGgpIG9wdGlvbnMiLAogICAgICAgICAgICAgICAgICAgICJPcHRpb25zIGZvciBnZW5lcmF0ZWQgR29vZ2xlIEVhcnRoIFN1cGVyT3ZlcmxheSBtZXRhZGF0YSIpCiAgICBnLmFkZF9vcHRpb24oIi1rIiwgIi0tZm9yY2Uta21sIiwgZGVzdD0na21sJywgYWN0aW9uPSJzdG9yZV90cnVlIiwKICAgICAgICAgICAgICAgICBoZWxwPSgiR2VuZXJhdGUgS01MIGZvciBHb29nbGUgRWFydGggLSBkZWZhdWx0IGZvciAnZ2VvZGV0aWMnIHByb2ZpbGUgYW5kICIKICAgICAgICAgICAgICAgICAgICAgICAiJ3Jhc3RlcicgaW4gRVBTRzo0MzI2LiBGb3IgYSBkYXRhc2V0IHdpdGggZGlmZmVyZW50IHByb2plY3Rpb24gdXNlICIKICAgICAgICAgICAgICAgICAgICAgICAid2l0aCBjYXV0aW9uISIpKQogICAgZy5hZGRfb3B0aW9uKCItbiIsICItLW5vLWttbCIsIGRlc3Q9J2ttbCcsIGFjdGlvbj0ic3RvcmVfZmFsc2UiLAogICAgICAgICAgICAgICAgIGhlbHA9IkF2b2lkIGF1dG9tYXRpYyBnZW5lcmF0aW9uIG9mIEtNTCBmaWxlcyBmb3IgRVBTRzo0MzI2IikKICAgIGcuYWRkX29wdGlvbigiLXUiLCAiLS11cmwiLCBkZXN0PSd1cmwnLAogICAgICAgICAgICAgICAgIGhlbHA9IlVSTCBhZGRyZXNzIHdoZXJlIHRoZSBnZW5lcmF0ZWQgdGlsZXMgYXJlIGdvaW5nIHRvIGJlIHB1Ymxpc2hlZCIpCiAgICBwLmFkZF9vcHRpb25fZ3JvdXAoZykKCiAgICAjIEhUTUwgb3B0aW9ucwogICAgZyA9IE9wdGlvbkdyb3VwKHAsICJXZWIgdmlld2VyIG9wdGlvbnMiLAogICAgICAgICAgICAgICAgICAgICJPcHRpb25zIGZvciBnZW5lcmF0ZWQgSFRNTCB2aWV3ZXJzIGEgbGEgR29vZ2xlIE1hcHMiKQogICAgZy5hZGRfb3B0aW9uKCItdyIsICItLXdlYnZpZXdlciIsIGRlc3Q9J3dlYnZpZXdlcicsIHR5cGU9J2Nob2ljZScsIGNob2ljZXM9d2Vidmlld2VyX2xpc3QsCiAgICAgICAgICAgICAgICAgaGVscD0iV2ViIHZpZXdlciB0byBnZW5lcmF0ZSAoJXMpIC0gZGVmYXVsdCAnYWxsJyIgJSAiLCIuam9pbih3ZWJ2aWV3ZXJfbGlzdCkpCiAgICBnLmFkZF9vcHRpb24oIi10IiwgIi0tdGl0bGUiLCBkZXN0PSd0aXRsZScsCiAgICAgICAgICAgICAgICAgaGVscD0iVGl0bGUgb2YgdGhlIG1hcCIpCiAgICBnLmFkZF9vcHRpb24oIi1jIiwgIi0tY29weXJpZ2h0IiwgZGVzdD0nY29weXJpZ2h0JywKICAgICAgICAgICAgICAgICBoZWxwPSJDb3B5cmlnaHQgZm9yIHRoZSBtYXAiKQogICAgZy5hZGRfb3B0aW9uKCItZyIsICItLWdvb2dsZWtleSIsIGRlc3Q9J2dvb2dsZWtleScsCiAgICAgICAgICAgICAgICAgaGVscD0iR29vZ2xlIE1hcHMgQVBJIGtleSBmcm9tIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vYXBpcy9tYXBzL3NpZ251cC5odG1sIikKICAgIGcuYWRkX29wdGlvbigiLWIiLCAiLS1iaW5na2V5IiwgZGVzdD0nYmluZ2tleScsCiAgICAgICAgICAgICAgICAgaGVscD0iQmluZyBNYXBzIEFQSSBrZXkgZnJvbSBodHRwczovL3d3dy5iaW5nbWFwc3BvcnRhbC5jb20vIikKICAgIHAuYWRkX29wdGlvbl9ncm91cChnKQoKICAgIHAuc2V0X2RlZmF1bHRzKHZlcmJvc2U9RmFsc2UsIHByb2ZpbGU9Im1lcmNhdG9yIiwga21sPUZhbHNlLCB1cmw9JycsIHpvb209JzAtMicsIHh5ej1UcnVlLAogICAgICAgICAgICAgICAgICAgd2Vidmlld2VyPSdub25lJywgY29weXJpZ2h0PScnLCByZXNhbXBsaW5nPSduZWFyJywgcmVzdW1lPUZhbHNlLAogICAgICAgICAgICAgICAgICAgZ29vZ2xla2V5PSdJTlNFUlRfWU9VUl9LRVlfSEVSRScsIGJpbmdrZXk9J0lOU0VSVF9ZT1VSX0tFWV9IRVJFJywKICAgICAgICAgICAgICAgICAgIHByb2Nlc3Nlcz0xKQoKICAgIHJldHVybiBwCgoKZGVmIHByb2Nlc3NfYXJncyhhcmd2KToKICAgIHBhcnNlciA9IG9wdHBhcnNlX2luaXQoKQogICAgb3B0aW9ucywgYXJncyA9IHBhcnNlci5wYXJzZV9hcmdzKGFyZ3M9YXJndikKCiAgICAjIEFyZ3Mgc2hvdWxkIGJlIGVpdGhlciBhbiBpbnB1dCBmaWxlIE9SIGFuIGlucHV0IGZpbGUgYW5kIGFuIG91dHB1dCBmb2xkZXIKICAgIGlmIChsZW4oYXJncykgPT0gMCk6CiAgICAgICAgZXhpdF93aXRoX2Vycm9yKCJZb3UgbmVlZCB0byBzcGVjaWZ5IGF0IGxlYXN0IGFuIGlucHV0IGZpbGUgYXMgYXJndW1lbnQgdG8gdGhlIHNjcmlwdCIpCiAgICBpZiAobGVuKGFyZ3MpID4gMik6CiAgICAgICAgZXhpdF93aXRoX2Vycm9yKCJQcm9jZXNzaW5nIG9mIHNldmVyYWwgaW5wdXQgZmlsZXMgaXMgbm90IHN1cHBvcnRlZC4iLAogICAgICAgICAgICAgICAgICAgICAgICAiUGxlYXNlIGZpcnN0IHVzZSBhIHRvb2wgbGlrZSBnZGFsX3ZydG1lcmdlLnB5IG9yIGdkYWxfbWVyZ2UucHkgb24gdGhlICIKICAgICAgICAgICAgICAgICAgICAgICAgImZpbGVzOiBnZGFsX3ZydG1lcmdlLnB5IC1vIG1lcmdlZC52cnQgJXMiICUgIiAiLmpvaW4oYXJncykpCgogICAgaW5wdXRfZmlsZSA9IGFyZ3NbMF0KICAgIGlmIG5vdCBvcy5wYXRoLmlzZmlsZShpbnB1dF9maWxlKToKICAgICAgICBleGl0X3dpdGhfZXJyb3IoIlRoZSBwcm92aWRlZCBpbnB1dCBmaWxlICVzIGRvZXMgbm90IGV4aXN0IG9yIGlzIG5vdCBhIGZpbGUiICUgaW5wdXRfZmlsZSkKCiAgICBpZiBsZW4oYXJncykgPT0gMjoKICAgICAgICBvdXRwdXRfZm9sZGVyID0gYXJnc1sxXQogICAgZWxzZToKICAgICAgICBvdXRwdXRfZm9sZGVyID0gb3MucGF0aC5iYXNlbmFtZShpbnB1dF9maWxlKQoKICAgIG9wdGlvbnMgPSBvcHRpb25zX3Bvc3RfcHJvY2Vzc2luZyhvcHRpb25zLCBpbnB1dF9maWxlLCBvdXRwdXRfZm9sZGVyKQoKICAgIHJldHVybiBpbnB1dF9maWxlLCBvdXRwdXRfZm9sZGVyLCBvcHRpb25zCgoKZGVmIG9wdGlvbnNfcG9zdF9wcm9jZXNzaW5nKG9wdGlvbnMsIGlucHV0X2ZpbGUsIG91dHB1dF9mb2xkZXIpOgogICAgaWYgbm90IG9wdGlvbnMudGl0bGU6CiAgICAgICAgb3B0aW9ucy50aXRsZSA9IG9zLnBhdGguYmFzZW5hbWUoaW5wdXRfZmlsZSkKCiAgICBpZiBvcHRpb25zLnVybCBhbmQgbm90IG9wdGlvbnMudXJsLmVuZHN3aXRoKCcvJyk6CiAgICAgICAgb3B0aW9ucy51cmwgKz0gJy8nCiAgICBpZiBvcHRpb25zLnVybDoKICAgICAgICBvdXRfcGF0aCA9IG91dHB1dF9mb2xkZXIKICAgICAgICBpZiBvdXRfcGF0aC5lbmRzd2l0aCgiLyIpOgogICAgICAgICAgICBvdXRfcGF0aCA9IG91dF9wYXRoWzotMV0KICAgICAgICBvcHRpb25zLnVybCArPSBvcy5wYXRoLmJhc2VuYW1lKG91dF9wYXRoKSArICcvJwoKICAgICMgU3VwcG9ydGVkIG9wdGlvbnMKICAgIGlmIG9wdGlvbnMucmVzYW1wbGluZyA9PSAnYXZlcmFnZSc6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBnZGFsLlJlZ2VuZXJhdGVPdmVydmlldzoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBleGl0X3dpdGhfZXJyb3IoIidhdmVyYWdlJyByZXNhbXBsaW5nIGFsZ29yaXRobSBpcyBub3QgYXZhaWxhYmxlLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiUGxlYXNlIHVzZSAtciAnbmVhcicgYXJndW1lbnQgb3IgdXBncmFkZSB0byBuZXdlciB2ZXJzaW9uIG9mIEdEQUwuIikKCiAgICBlbGlmIG9wdGlvbnMucmVzYW1wbGluZyA9PSAnYW50aWFsaWFzJzoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIG51bXB5OiAgICAgIyBweWxpbnQ6ZGlzYWJsZT1XMDEyNQogICAgICAgICAgICAgICAgcGFzcwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGV4aXRfd2l0aF9lcnJvcigiJ2FudGlhbGlhcycgcmVzYW1wbGluZyBhbGdvcml0aG0gaXMgbm90IGF2YWlsYWJsZS4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIkluc3RhbGwgUElMIChQeXRob24gSW1hZ2luZyBMaWJyYXJ5KSBhbmQgbnVtcHkuIikKCiAgICB0cnk6CiAgICAgICAgb3MucGF0aC5iYXNlbmFtZShpbnB1dF9maWxlKS5lbmNvZGUoJ2FzY2lpJykKICAgIGV4Y2VwdCBVbmljb2RlRW5jb2RlRXJyb3I6CiAgICAgICAgZnVsbF9hc2NpaSA9IEZhbHNlCiAgICBlbHNlOgogICAgICAgIGZ1bGxfYXNjaWkgPSBUcnVlCgogICAgIyBMQ19DVFlQRSBjaGVjawogICAgaWYgbm90IGZ1bGxfYXNjaWkgYW5kICdVVEYtOCcgbm90IGluIG9zLmVudmlyb24uZ2V0KCJMQ19DVFlQRSIsICIiKToKICAgICAgICBpZiBub3Qgb3B0aW9ucy5xdWlldDoKICAgICAgICAgICAgcHJpbnQoIlxuV0FSTklORzogIgogICAgICAgICAgICAgICAgICAiWW91IGFyZSBydW5uaW5nIGdkYWwydGlsZXNfbG9jYWwucHkgd2l0aCBhIExDX0NUWVBFIGVudmlyb25tZW50IHZhcmlhYmxlIHRoYXQgaXMgIgogICAgICAgICAgICAgICAgICAibm90IFVURi04IGNvbXBhdGlibGUsIGFuZCB5b3VyIGlucHV0IGZpbGUgY29udGFpbnMgbm9uLWFzY2lpIGNoYXJhY3RlcnMuICIKICAgICAgICAgICAgICAgICAgIlRoZSBnZW5lcmF0ZWQgc2FtcGxlIGdvb2dsZW1hcHMsIG9wZW5sYXllcnMgb3IgIgogICAgICAgICAgICAgICAgICAibGVhZmxldCBmaWxlcyBtaWdodCBjb250YWluIHNvbWUgaW52YWxpZCBjaGFyYWN0ZXJzIGFzIGEgcmVzdWx0XG4iKQoKICAgICMgT3V0cHV0IHRoZSByZXN1bHRzCiAgICBpZiBvcHRpb25zLnZlcmJvc2U6CiAgICAgICAgcHJpbnQoIk9wdGlvbnM6Iiwgb3B0aW9ucykKICAgICAgICBwcmludCgiSW5wdXQ6IiwgaW5wdXRfZmlsZSkKICAgICAgICBwcmludCgiT3V0cHV0OiIsIG91dHB1dF9mb2xkZXIpCiAgICAgICAgcHJpbnQoIkNhY2hlOiAlcyBNQiIgJSAoZ2RhbC5HZXRDYWNoZU1heCgpIC8gMTAyNCAvIDEwMjQpKQogICAgICAgIHByaW50KCcnKQoKICAgIHJldHVybiBvcHRpb25zCgoKY2xhc3MgVGlsZURldGFpbChvYmplY3QpOgogICAgdHggPSAwCiAgICB0eSA9IDAKICAgIHR6ID0gMAogICAgcnggPSAwCiAgICByeSA9IDAKICAgIHJ4c2l6ZSA9IDAKICAgIHJ5c2l6ZSA9IDAKICAgIHd4ID0gMAogICAgd3kgPSAwCiAgICB3eHNpemUgPSAwCiAgICB3eXNpemUgPSAwCiAgICBxdWVyeXNpemUgPSAwCgogICAgZGVmIF9faW5pdF9fKHNlbGYsICoqa3dhcmdzKToKICAgICAgICBmb3Iga2V5IGluIGt3YXJnczoKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCBrZXkpOgogICAgICAgICAgICAgICAgc2V0YXR0cihzZWxmLCBrZXksIGt3YXJnc1trZXldKQoKICAgIGRlZiBfX3VuaWNvZGVfXyhzZWxmKToKICAgICAgICByZXR1cm4gIlRpbGVEZXRhaWwgJXNcbiVzXG4lc1xuIiAlIChzZWxmLnR4LCBzZWxmLnR5LCBzZWxmLnR6KQoKICAgIGRlZiBfX3N0cl9fKHNlbGYpOgogICAgICAgIHJldHVybiAiVGlsZURldGFpbCAlc1xuJXNcbiVzXG4iICUgKHNlbGYudHgsIHNlbGYudHksIHNlbGYudHopCgogICAgZGVmIF9fcmVwcl9fKHNlbGYpOgogICAgICAgIHJldHVybiAiVGlsZURldGFpbCAlc1xuJXNcbiVzXG4iICUgKHNlbGYudHgsIHNlbGYudHksIHNlbGYudHopCgoKY2xhc3MgVGlsZUpvYkluZm8ob2JqZWN0KToKICAgICIiIgogICAgUGxhaW4gb2JqZWN0IHRvIGhvbGQgdGlsZSBqb2IgY29uZmlndXJhdGlvbiBmb3IgYSBkYXRhc2V0CiAgICAiIiIKICAgIHNyY19maWxlID0gIiIKICAgIG5iX2RhdGFfYmFuZHMgPSAwCiAgICBvdXRwdXRfZmlsZV9wYXRoID0gIiIKICAgIHRpbGVfZXh0ZW5zaW9uID0gIiIKICAgIHRpbGVfc2l6ZSA9IDAKICAgIHRpbGVfZHJpdmVyID0gTm9uZQogICAga21sID0gRmFsc2UKICAgIHRtaW5tYXggPSBbXQogICAgdG1pbnogPSAwCiAgICB0bWF4eiA9IDAKICAgIGluX3Nyc193a3QgPSAwCiAgICBvdXRfZ2VvX3RyYW5zID0gW10KICAgIG9taW55ID0gMAogICAgaXNfZXBzZ180MzI2ID0gRmFsc2UKICAgIG9wdGlvbnMgPSBOb25lCgogICAgZGVmIF9faW5pdF9fKHNlbGYsICoqa3dhcmdzKToKICAgICAgICBmb3Iga2V5IGluIGt3YXJnczoKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCBrZXkpOgogICAgICAgICAgICAgICAgc2V0YXR0cihzZWxmLCBrZXksIGt3YXJnc1trZXldKQoKICAgIGRlZiBfX3VuaWNvZGVfXyhzZWxmKToKICAgICAgICByZXR1cm4gIlRpbGVKb2JJbmZvICVzXG4iICUgKHNlbGYuc3JjX2ZpbGUpCgogICAgZGVmIF9fc3RyX18oc2VsZik6CiAgICAgICAgcmV0dXJuICJUaWxlSm9iSW5mbyAlc1xuIiAlIChzZWxmLnNyY19maWxlKQoKICAgIGRlZiBfX3JlcHJfXyhzZWxmKToKICAgICAgICByZXR1cm4gIlRpbGVKb2JJbmZvICVzXG4iICUgKHNlbGYuc3JjX2ZpbGUpCgoKY2xhc3MgR2RhbDJUaWxlc0Vycm9yKEV4Y2VwdGlvbik6CiAgICBwYXNzCgoKY2xhc3MgR0RBTDJUaWxlcyhvYmplY3QpOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBpbnB1dF9maWxlLCBvdXRwdXRfZm9sZGVyLCBvcHRpb25zKToKICAgICAgICAiIiJDb25zdHJ1Y3RvciBmdW5jdGlvbiAtIGluaXRpYWxpemF0aW9uIiIiCiAgICAgICAgc2VsZi5vdXRfZHJ2ID0gTm9uZQogICAgICAgIHNlbGYubWVtX2RydiA9IE5vbmUKICAgICAgICBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0ID0gTm9uZQogICAgICAgIHNlbGYub3V0X3NycyA9IE5vbmUKICAgICAgICBzZWxmLm5hdGl2ZXpvb20gPSBOb25lCiAgICAgICAgc2VsZi50bWlubWF4ID0gTm9uZQogICAgICAgIHNlbGYudHNpemUgPSBOb25lCiAgICAgICAgc2VsZi5tZXJjYXRvciA9IE5vbmUKICAgICAgICBzZWxmLmdlb2RldGljID0gTm9uZQogICAgICAgIHNlbGYuYWxwaGFiYW5kID0gTm9uZQogICAgICAgIHNlbGYuZGF0YUJhbmRzQ291bnQgPSBOb25lCiAgICAgICAgc2VsZi5vdXRfZ3QgPSBOb25lCiAgICAgICAgc2VsZi50aWxlc3duZSA9IE5vbmUKICAgICAgICBzZWxmLnN3bmUgPSBOb25lCiAgICAgICAgc2VsZi5vbWlueCA9IE5vbmUKICAgICAgICBzZWxmLm9tYXh4ID0gTm9uZQogICAgICAgIHNlbGYub21heHkgPSBOb25lCiAgICAgICAgc2VsZi5vbWlueSA9IE5vbmUKCiAgICAgICAgc2VsZi5pbnB1dF9maWxlID0gTm9uZQogICAgICAgIHNlbGYub3V0cHV0X2ZvbGRlciA9IE5vbmUKCiAgICAgICAgIyBUaWxlIGZvcm1hdAogICAgICAgIHNlbGYudGlsZXNpemUgPSAyNTYKICAgICAgICBzZWxmLnRpbGVkcml2ZXIgPSAnUE5HJwogICAgICAgIHNlbGYudGlsZWV4dCA9ICdwbmcnCiAgICAgICAgc2VsZi50bXBfZGlyID0gdGVtcGZpbGUubWtkdGVtcCgpCiAgICAgICAgc2VsZi50bXBfdnJ0X2ZpbGVuYW1lID0gb3MucGF0aC5qb2luKHNlbGYudG1wX2Rpciwgc3RyKHV1aWQ0KCkpICsgJy52cnQnKQoKICAgICAgICAjIFNob3VsZCB3ZSByZWFkIGJpZ2dlciB3aW5kb3cgb2YgdGhlIGlucHV0IHJhc3RlciBhbmQgc2NhbGUgaXQgZG93bj8KICAgICAgICAjIE5vdGU6IE1vZGlmaWVkIGxhdGVyIGJ5IG9wZW5faW5wdXQoKQogICAgICAgICMgTm90IGZvciAnbmVhcicgcmVzYW1wbGluZwogICAgICAgICMgTm90IGZvciBXYXZlbGV0IGJhc2VkIGRyaXZlcnMgKEpQRUcyMDAwLCBFQ1csIE1yU0lEKQogICAgICAgICMgTm90IGZvciAncmFzdGVyJyBwcm9maWxlCiAgICAgICAgc2VsZi5zY2FsZWRxdWVyeSA9IFRydWUKICAgICAgICAjIEhvdyBiaWcgc2hvdWxkIGJlIHF1ZXJ5IHdpbmRvdyBiZSBmb3Igc2NhbGluZyBkb3duCiAgICAgICAgIyBMYXRlciBvbiByZXNldCBhY2NvcmRpbmcgdGhlIGNob3NlbiByZXNhbXBsaW5nIGFsZ29yaWdodG0KICAgICAgICBzZWxmLnF1ZXJ5c2l6ZSA9IDQgKiBzZWxmLnRpbGVzaXplCgogICAgICAgICMgU2hvdWxkIHdlIHVzZSBSZWFkIG9uIHRoZSBpbnB1dCBmaWxlIGZvciBnZW5lcmF0aW5nIG92ZXJ2aWV3IHRpbGVzPwogICAgICAgICMgTm90ZTogTW9kaWZpZWQgbGF0ZXIgYnkgb3Blbl9pbnB1dCgpCiAgICAgICAgIyBPdGhlcndpc2UgdGhlIG92ZXJ2aWV3IHRpbGVzIGFyZSBnZW5lcmF0ZWQgZnJvbSBleGlzdGluZyB1bmRlcmx5aW5nIHRpbGVzCiAgICAgICAgc2VsZi5vdmVydmlld3F1ZXJ5ID0gRmFsc2UKCiAgICAgICAgc2VsZi5pbnB1dF9maWxlID0gaW5wdXRfZmlsZQogICAgICAgIHNlbGYub3V0cHV0X2ZvbGRlciA9IG91dHB1dF9mb2xkZXIKICAgICAgICBzZWxmLm9wdGlvbnMgPSBvcHRpb25zCgogICAgICAgIGlmIHNlbGYub3B0aW9ucy5yZXNhbXBsaW5nID09ICduZWFyJzoKICAgICAgICAgICAgc2VsZi5xdWVyeXNpemUgPSBzZWxmLnRpbGVzaXplCgogICAgICAgIGVsaWYgc2VsZi5vcHRpb25zLnJlc2FtcGxpbmcgPT0gJ2JpbGluZWFyJzoKICAgICAgICAgICAgc2VsZi5xdWVyeXNpemUgPSBzZWxmLnRpbGVzaXplICogMgoKICAgICAgICAjIFVzZXIgc3BlY2lmaWVkIHpvb20gbGV2ZWxzCiAgICAgICAgc2VsZi50bWlueiA9IE5vbmUKICAgICAgICBzZWxmLnRtYXh6ID0gTm9uZQogICAgICAgIGlmIHNlbGYub3B0aW9ucy56b29tOgogICAgICAgICAgICBtaW5tYXggPSBzZWxmLm9wdGlvbnMuem9vbS5zcGxpdCgnLScsIDEpCiAgICAgICAgICAgIG1pbm1heC5leHRlbmQoWycnXSkKICAgICAgICAgICAgem9vbV9taW4sIHpvb21fbWF4ID0gbWlubWF4WzoyXQogICAgICAgICAgICBzZWxmLnRtaW56ID0gaW50KHpvb21fbWluKQogICAgICAgICAgICBpZiB6b29tX21heDoKICAgICAgICAgICAgICAgIHNlbGYudG1heHogPSBpbnQoem9vbV9tYXgpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLnRtYXh6ID0gaW50KHpvb21fbWluKQoKICAgICAgICAjIEtNTCBnZW5lcmF0aW9uCiAgICAgICAgc2VsZi5rbWwgPSBzZWxmLm9wdGlvbnMua21sCgogICAgIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBkZWYgb3Blbl9pbnB1dChzZWxmKToKICAgICAgICAiIiJJbml0aWFsaXphdGlvbiBvZiB0aGUgaW5wdXQgcmFzdGVyLCByZXByb2plY3Rpb24gaWYgbmVjZXNzYXJ5IiIiCiAgICAgICAgZ2RhbC5BbGxSZWdpc3RlcigpCgogICAgICAgIHNlbGYub3V0X2RydiA9IGdkYWwuR2V0RHJpdmVyQnlOYW1lKHNlbGYudGlsZWRyaXZlcikKICAgICAgICBzZWxmLm1lbV9kcnYgPSBnZGFsLkdldERyaXZlckJ5TmFtZSgnTUVNJykKCiAgICAgICAgaWYgbm90IHNlbGYub3V0X2RydjoKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJUaGUgJyVzJyBkcml2ZXIgd2FzIG5vdCBmb3VuZCwgaXMgaXQgYXZhaWxhYmxlIGluIHRoaXMgR0RBTCBidWlsZD8iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi50aWxlZHJpdmVyKQogICAgICAgIGlmIG5vdCBzZWxmLm1lbV9kcnY6CiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiVGhlICdNRU0nIGRyaXZlciB3YXMgbm90IGZvdW5kLCBpcyBpdCBhdmFpbGFibGUgaW4gdGhpcyBHREFMIGJ1aWxkPyIpCgogICAgICAgICMgT3BlbiB0aGUgaW5wdXQgZmlsZQoKICAgICAgICBpZiBzZWxmLmlucHV0X2ZpbGU6CiAgICAgICAgICAgIGlucHV0X2RhdGFzZXQgPSBnZGFsLk9wZW4oc2VsZi5pbnB1dF9maWxlLCBnZGFsLkdBX1JlYWRPbmx5KQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiTm8gaW5wdXQgZmlsZSB3YXMgc3BlY2lmaWVkIikKCiAgICAgICAgaWYgc2VsZi5vcHRpb25zLnZlcmJvc2U6CiAgICAgICAgICAgIHByaW50KCJJbnB1dCBmaWxlOiIsCiAgICAgICAgICAgICAgICAgICIoICVzUCB4ICVzTCAtICVzIGJhbmRzKSIgJSAoaW5wdXRfZGF0YXNldC5SYXN0ZXJYU2l6ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnB1dF9kYXRhc2V0LlJhc3RlcllTaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0X2RhdGFzZXQuUmFzdGVyQ291bnQpKQoKICAgICAgICBpZiBub3QgaW5wdXRfZGF0YXNldDoKICAgICAgICAgICAgIyBOb3RlOiBHREFMIHByaW50cyB0aGUgRVJST1IgbWVzc2FnZSB0b28KICAgICAgICAgICAgZXhpdF93aXRoX2Vycm9yKCJJdCBpcyBub3QgcG9zc2libGUgdG8gb3BlbiB0aGUgaW5wdXQgZmlsZSAnJXMnLiIgJSBzZWxmLmlucHV0X2ZpbGUpCgogICAgICAgICMgUmVhZCBtZXRhZGF0YSBmcm9tIHRoZSBpbnB1dCBmaWxlCiAgICAgICAgaWYgaW5wdXRfZGF0YXNldC5SYXN0ZXJDb3VudCA9PSAwOgogICAgICAgICAgICBleGl0X3dpdGhfZXJyb3IoIklucHV0IGZpbGUgJyVzJyBoYXMgbm8gcmFzdGVyIGJhbmQiICUgc2VsZi5pbnB1dF9maWxlKQoKICAgICAgICBpZiBpbnB1dF9kYXRhc2V0LkdldFJhc3RlckJhbmQoMSkuR2V0UmFzdGVyQ29sb3JUYWJsZSgpOgogICAgICAgICAgICBleGl0X3dpdGhfZXJyb3IoCiAgICAgICAgICAgICAgICAiUGxlYXNlIGNvbnZlcnQgdGhpcyBmaWxlIHRvIFJHQi9SR0JBIGFuZCBydW4gZ2RhbDJ0aWxlcyBvbiB0aGUgcmVzdWx0LiIsCiAgICAgICAgICAgICAgICAiRnJvbSBwYWxldHRlZCBmaWxlIHlvdSBjYW4gY3JlYXRlIFJHQkEgZmlsZSAodGVtcC52cnQpIGJ5OlxuIgogICAgICAgICAgICAgICAgImdkYWxfdHJhbnNsYXRlIC1vZiB2cnQgLWV4cGFuZCByZ2JhICVzIHRlbXAudnJ0XG4iCiAgICAgICAgICAgICAgICAidGhlbiBydW46XG4iCiAgICAgICAgICAgICAgICAiZ2RhbDJ0aWxlcyB0ZW1wLnZydCIgJSBzZWxmLmlucHV0X2ZpbGUKICAgICAgICAgICAgKQoKICAgICAgICBpbl9ub2RhdGEgPSBzZXR1cF9ub19kYXRhX3ZhbHVlcyhpbnB1dF9kYXRhc2V0LCBzZWxmLm9wdGlvbnMpCgogICAgICAgIGlmIHNlbGYub3B0aW9ucy52ZXJib3NlOgogICAgICAgICAgICBwcmludCgiUHJlcHJvY2Vzc2VkIGZpbGU6IiwKICAgICAgICAgICAgICAgICAgIiggJXNQIHggJXNMIC0gJXMgYmFuZHMpIiAlIChpbnB1dF9kYXRhc2V0LlJhc3RlclhTaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0X2RhdGFzZXQuUmFzdGVyWVNpemUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXRfZGF0YXNldC5SYXN0ZXJDb3VudCkpCgogICAgICAgIGluX3Nycywgc2VsZi5pbl9zcnNfd2t0ID0gc2V0dXBfaW5wdXRfc3JzKGlucHV0X2RhdGFzZXQsIHNlbGYub3B0aW9ucykKCiAgICAgICAgc2VsZi5vdXRfc3JzID0gc2V0dXBfb3V0cHV0X3Nycyhpbl9zcnMsIHNlbGYub3B0aW9ucykKCiAgICAgICAgIyBJZiBpbnB1dCBhbmQgb3V0cHV0IHJlZmVyZW5jZSBzeXN0ZW1zIGFyZSBkaWZmZXJlbnQsIHdlIHJlcHJvamVjdCB0aGUgaW5wdXQgZGF0YXNldCBpbnRvCiAgICAgICAgIyB0aGUgb3V0cHV0IHJlZmVyZW5jZSBzeXN0ZW0gZm9yIGVhc2llciBtYW5pcHVsYXRpb24KCiAgICAgICAgc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldCA9IE5vbmUKCiAgICAgICAgaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgaW4gKCdtZXJjYXRvcicsICdnZW9kZXRpYycpOgoKICAgICAgICAgICAgaWYgbm90IGluX3NyczoKICAgICAgICAgICAgICAgIGV4aXRfd2l0aF9lcnJvcigKICAgICAgICAgICAgICAgICAgICAiSW5wdXQgZmlsZSBoYXMgdW5rbm93biBTUlMuIiwKICAgICAgICAgICAgICAgICAgICAiVXNlIC0tc19zcnMgRVNQRzp4eXogKG9yIHNpbWlsYXIpIHRvIHByb3ZpZGUgc291cmNlIHJlZmVyZW5jZSBzeXN0ZW0uIikKCiAgICAgICAgICAgIGlmIG5vdCBoYXNfZ2VvcmVmZXJlbmNlKGlucHV0X2RhdGFzZXQpOgogICAgICAgICAgICAgICAgZXhpdF93aXRoX2Vycm9yKAogICAgICAgICAgICAgICAgICAgICJUaGVyZSBpcyBubyBnZW9yZWZlcmVuY2UgLSBuZWl0aGVyIGFmZmluZSB0cmFuc2Zvcm1hdGlvbiAod29ybGRmaWxlKSAiCiAgICAgICAgICAgICAgICAgICAgIm5vciBHQ1BzLiBZb3UgY2FuIGdlbmVyYXRlIG9ubHkgJ3Jhc3RlcicgcHJvZmlsZSB0aWxlcy4iLAogICAgICAgICAgICAgICAgICAgICJFaXRoZXIgZ2RhbDJ0aWxlcyB3aXRoIHBhcmFtZXRlciAtcCAncmFzdGVyJyBvciB1c2UgYW5vdGhlciBHSVMgIgogICAgICAgICAgICAgICAgICAgICJzb2Z0d2FyZSBmb3IgZ2VvcmVmZXJlbmNlIGUuZy4gZ2RhbF90cmFuc2Zvcm0gLWdjcCAvIC1hX3VsbHIgLyAtYV9zcnMiCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICBpZiAoKGluX3Nycy5FeHBvcnRUb1Byb2o0KCkgIT0gc2VsZi5vdXRfc3JzLkV4cG9ydFRvUHJvajQoKSkgb3IKICAgICAgICAgICAgICAgICAgICAoaW5wdXRfZGF0YXNldC5HZXRHQ1BDb3VudCgpICE9IDApKToKICAgICAgICAgICAgICAgIHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQgPSByZXByb2plY3RfZGF0YXNldCgKICAgICAgICAgICAgICAgICAgICBpbnB1dF9kYXRhc2V0LCBpbl9zcnMsIHNlbGYub3V0X3NycykKCiAgICAgICAgICAgICAgICBpZiBpbl9ub2RhdGE6CiAgICAgICAgICAgICAgICAgICAgc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldCA9IHVwZGF0ZV9ub19kYXRhX3ZhbHVlcygKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldCwgaW5fbm9kYXRhLCBvcHRpb25zPXNlbGYub3B0aW9ucykKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldCA9IHVwZGF0ZV9hbHBoYV92YWx1ZV9mb3Jfbm9uX2FscGhhX2lucHV0cygKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldCwgb3B0aW9ucz1zZWxmLm9wdGlvbnMpCgogICAgICAgICAgICBpZiBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0IGFuZCBzZWxmLm9wdGlvbnMudmVyYm9zZToKICAgICAgICAgICAgICAgIHByaW50KCJQcm9qZWN0ZWQgZmlsZToiLCAidGlsZXMudnJ0IiwgIiggJXNQIHggJXNMIC0gJXMgYmFuZHMpIiAlICgKICAgICAgICAgICAgICAgICAgICBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0LlJhc3RlclhTaXplLAogICAgICAgICAgICAgICAgICAgIHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQuUmFzdGVyWVNpemUsCiAgICAgICAgICAgICAgICAgICAgc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldC5SYXN0ZXJDb3VudCkpCgogICAgICAgIGlmIG5vdCBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0OgogICAgICAgICAgICBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0ID0gaW5wdXRfZGF0YXNldAoKICAgICAgICAjU2FsdmEgbyBhcnF1aXZvIHJlcHJvamV0YWRvCiAgICAgICAgc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldC5HZXREcml2ZXIoKS5DcmVhdGVDb3B5KHNlbGYudG1wX3ZydF9maWxlbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldCkKCiAgICAgICAgIyBHZXQgYWxwaGEgYmFuZCAoZWl0aGVyIGRpcmVjdGx5IG9yIGZyb20gTk9EQVRBIHZhbHVlKQogICAgICAgIHNlbGYuYWxwaGFiYW5kID0gc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldC5HZXRSYXN0ZXJCYW5kKDEpLkdldE1hc2tCYW5kKCkKICAgICAgICBzZWxmLmRhdGFCYW5kc0NvdW50ID0gbmJfZGF0YV9iYW5kcyhzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0KQoKICAgICAgICAjIEtNTCB0ZXN0CiAgICAgICAgc2VsZi5pc2Vwc2c0MzI2ID0gRmFsc2UKICAgICAgICBzcnM0MzI2ID0gb3NyLlNwYXRpYWxSZWZlcmVuY2UoKQogICAgICAgIHNyczQzMjYuSW1wb3J0RnJvbUVQU0coNDMyNikKICAgICAgICBpZiBzZWxmLm91dF9zcnMgYW5kIHNyczQzMjYuRXhwb3J0VG9Qcm9qNCgpID09IHNlbGYub3V0X3Nycy5FeHBvcnRUb1Byb2o0KCk6CiAgICAgICAgICAgIHNlbGYua21sID0gVHJ1ZQogICAgICAgICAgICBzZWxmLmlzZXBzZzQzMjYgPSBUcnVlCiAgICAgICAgICAgIGlmIHNlbGYub3B0aW9ucy52ZXJib3NlOgogICAgICAgICAgICAgICAgcHJpbnQoIktNTCBhdXRvdGVzdCBPSyEiKQoKICAgICAgICAjIFJlYWQgdGhlIGdlb3JlZmVyZW5jZQogICAgICAgIHNlbGYub3V0X2d0ID0gc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldC5HZXRHZW9UcmFuc2Zvcm0oKQoKICAgICAgICAjIFRlc3QgdGhlIHNpemUgb2YgdGhlIHBpeGVsCgogICAgICAgICMgUmVwb3J0IGVycm9yIGluIGNhc2Ugcm90YXRpb24vc2tldyBpcyBpbiBnZW90cmFuc2Zvcm0gKHBvc3NpYmxlIG9ubHkgaW4gJ3Jhc3RlcicgcHJvZmlsZSkKICAgICAgICBpZiAoc2VsZi5vdXRfZ3RbMl0sIHNlbGYub3V0X2d0WzRdKSAhPSAoMCwgMCk6CiAgICAgICAgICAgIGV4aXRfd2l0aF9lcnJvcigiR2VvcmVmZXJlbmNlIG9mIHRoZSByYXN0ZXIgY29udGFpbnMgcm90YXRpb24gb3Igc2tldy4gIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIlN1Y2ggcmFzdGVyIGlzIG5vdCBzdXBwb3J0ZWQuIFBsZWFzZSB1c2UgZ2RhbHdhcnAgZmlyc3QuIikKCiAgICAgICAgIyBIZXJlIHdlIGV4cGVjdDogcGl4ZWwgaXMgc3F1YXJlLCBubyByb3RhdGlvbiBvbiB0aGUgcmFzdGVyCgogICAgICAgICMgT3V0cHV0IEJvdW5kcyAtIGNvb3JkaW5hdGVzIGluIHRoZSBvdXRwdXQgU1JTCiAgICAgICAgc2VsZi5vbWlueCA9IHNlbGYub3V0X2d0WzBdCiAgICAgICAgc2VsZi5vbWF4eCA9IHNlbGYub3V0X2d0WzBdICsgc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldC5SYXN0ZXJYU2l6ZSAqIHNlbGYub3V0X2d0WzFdCiAgICAgICAgc2VsZi5vbWF4eSA9IHNlbGYub3V0X2d0WzNdCiAgICAgICAgc2VsZi5vbWlueSA9IHNlbGYub3V0X2d0WzNdIC0gc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldC5SYXN0ZXJZU2l6ZSAqIHNlbGYub3V0X2d0WzFdCiAgICAgICAgIyBOb3RlOiBtYXliZSByb3VuZCh4LCAxNCkgdG8gYXZvaWQgdGhlIGdkYWxfdHJhbnNsYXRlIGJlaGF2aW91ciwgd2hlbiAwIGJlY29tZXMgLTFlLTE1CgogICAgICAgIGlmIHNlbGYub3B0aW9ucy52ZXJib3NlOgogICAgICAgICAgICBwcmludCgiQm91bmRzIChvdXRwdXQgc3JzKToiLCByb3VuZChzZWxmLm9taW54LCAxMyksIHNlbGYub21pbnksIHNlbGYub21heHgsIHNlbGYub21heHkpCgogICAgICAgICMgQ2FsY3VsYXRpbmcgcmFuZ2VzIGZvciB0aWxlcyBpbiBkaWZmZXJlbnQgem9vbSBsZXZlbHMKICAgICAgICBpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAnbWVyY2F0b3InOgoKICAgICAgICAgICAgc2VsZi5tZXJjYXRvciA9IEdsb2JhbE1lcmNhdG9yKCkKCiAgICAgICAgICAgICMgRnVuY3Rpb24gd2hpY2ggZ2VuZXJhdGVzIFNXTkUgaW4gTGF0TG9uZyBmb3IgZ2l2ZW4gdGlsZQogICAgICAgICAgICBzZWxmLnRpbGVzd25lID0gc2VsZi5tZXJjYXRvci5UaWxlTGF0TG9uQm91bmRzCgogICAgICAgICAgICAjIEdlbmVyYXRlIHRhYmxlIHdpdGggbWluIG1heCB0aWxlIGNvb3JkaW5hdGVzIGZvciBhbGwgem9vbWxldmVscwogICAgICAgICAgICBzZWxmLnRtaW5tYXggPSBsaXN0KHJhbmdlKDAsIDMyKSkKICAgICAgICAgICAgZm9yIHR6IGluIHJhbmdlKDAsIDMyKToKICAgICAgICAgICAgICAgIHRtaW54LCB0bWlueSA9IHNlbGYubWVyY2F0b3IuTWV0ZXJzVG9UaWxlKHNlbGYub21pbngsIHNlbGYub21pbnksIHR6KQogICAgICAgICAgICAgICAgdG1heHgsIHRtYXh5ID0gc2VsZi5tZXJjYXRvci5NZXRlcnNUb1RpbGUoc2VsZi5vbWF4eCwgc2VsZi5vbWF4eSwgdHopCiAgICAgICAgICAgICAgICAjIGNyb3AgdGlsZXMgZXh0ZW5kaW5nIHdvcmxkIGxpbWl0cyAoKy0xODAsKy05MCkKICAgICAgICAgICAgICAgIHRtaW54LCB0bWlueSA9IG1heCgwLCB0bWlueCksIG1heCgwLCB0bWlueSkKICAgICAgICAgICAgICAgIHRtYXh4LCB0bWF4eSA9IG1pbigyKip0ei0xLCB0bWF4eCksIG1pbigyKip0ei0xLCB0bWF4eSkKICAgICAgICAgICAgICAgIHNlbGYudG1pbm1heFt0el0gPSAodG1pbngsIHRtaW55LCB0bWF4eCwgdG1heHkpCgogICAgICAgICAgICAjIFRPRE86IE1hcHMgY3Jvc3NpbmcgMTgwRSAoQWxhc2thPykKCiAgICAgICAgICAgICMgR2V0IHRoZSBtaW5pbWFsIHpvb20gbGV2ZWwgKG1hcCBjb3ZlcnMgYXJlYSBlcXVpdmFsZW50IHRvIG9uZSB0aWxlKQogICAgICAgICAgICBpZiBzZWxmLnRtaW56IGlzIE5vbmU6CiAgICAgICAgICAgICAgICBzZWxmLnRtaW56ID0gc2VsZi5tZXJjYXRvci5ab29tRm9yUGl4ZWxTaXplKAogICAgICAgICAgICAgICAgICAgIHNlbGYub3V0X2d0WzFdICoKICAgICAgICAgICAgICAgICAgICBtYXgoc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldC5SYXN0ZXJYU2l6ZSwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldC5SYXN0ZXJZU2l6ZSkgLwogICAgICAgICAgICAgICAgICAgIGZsb2F0KHNlbGYudGlsZXNpemUpKQoKICAgICAgICAgICAgIyBHZXQgdGhlIG1heGltYWwgem9vbSBsZXZlbAogICAgICAgICAgICAjIChjbG9zZXN0IHBvc3NpYmxlIHpvb20gbGV2ZWwgdXAgb24gdGhlIHJlc29sdXRpb24gb2YgcmFzdGVyKQogICAgICAgICAgICBpZiBzZWxmLnRtYXh6IGlzIE5vbmU6CiAgICAgICAgICAgICAgICBzZWxmLnRtYXh6ID0gc2VsZi5tZXJjYXRvci5ab29tRm9yUGl4ZWxTaXplKHNlbGYub3V0X2d0WzFdKQoKICAgICAgICAgICAgaWYgc2VsZi5vcHRpb25zLnZlcmJvc2U6CiAgICAgICAgICAgICAgICBwcmludCgiQm91bmRzIChsYXRsb25nKToiLAogICAgICAgICAgICAgICAgICAgICAgc2VsZi5tZXJjYXRvci5NZXRlcnNUb0xhdExvbihzZWxmLm9taW54LCBzZWxmLm9taW55KSwKICAgICAgICAgICAgICAgICAgICAgIHNlbGYubWVyY2F0b3IuTWV0ZXJzVG9MYXRMb24oc2VsZi5vbWF4eCwgc2VsZi5vbWF4eSkpCiAgICAgICAgICAgICAgICBwcmludCgnTWluWm9vbUxldmVsOicsIHNlbGYudG1pbnopCiAgICAgICAgICAgICAgICBwcmludCgiTWF4Wm9vbUxldmVsOiIsCiAgICAgICAgICAgICAgICAgICAgICBzZWxmLnRtYXh6LAogICAgICAgICAgICAgICAgICAgICAgIigiLAogICAgICAgICAgICAgICAgICAgICAgc2VsZi5tZXJjYXRvci5SZXNvbHV0aW9uKHNlbGYudG1heHopLAogICAgICAgICAgICAgICAgICAgICAgIikiKQoKICAgICAgICBpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAnZ2VvZGV0aWMnOgoKICAgICAgICAgICAgc2VsZi5nZW9kZXRpYyA9IEdsb2JhbEdlb2RldGljKHNlbGYub3B0aW9ucy50bXNjb21wYXRpYmxlKQoKICAgICAgICAgICAgIyBGdW5jdGlvbiB3aGljaCBnZW5lcmF0ZXMgU1dORSBpbiBMYXRMb25nIGZvciBnaXZlbiB0aWxlCiAgICAgICAgICAgIHNlbGYudGlsZXN3bmUgPSBzZWxmLmdlb2RldGljLlRpbGVMYXRMb25Cb3VuZHMKCiAgICAgICAgICAgICMgR2VuZXJhdGUgdGFibGUgd2l0aCBtaW4gbWF4IHRpbGUgY29vcmRpbmF0ZXMgZm9yIGFsbCB6b29tbGV2ZWxzCiAgICAgICAgICAgIHNlbGYudG1pbm1heCA9IGxpc3QocmFuZ2UoMCwgMzIpKQogICAgICAgICAgICBmb3IgdHogaW4gcmFuZ2UoMCwgMzIpOgogICAgICAgICAgICAgICAgdG1pbngsIHRtaW55ID0gc2VsZi5nZW9kZXRpYy5Mb25MYXRUb1RpbGUoc2VsZi5vbWlueCwgc2VsZi5vbWlueSwgdHopCiAgICAgICAgICAgICAgICB0bWF4eCwgdG1heHkgPSBzZWxmLmdlb2RldGljLkxvbkxhdFRvVGlsZShzZWxmLm9tYXh4LCBzZWxmLm9tYXh5LCB0eikKICAgICAgICAgICAgICAgICMgY3JvcCB0aWxlcyBleHRlbmRpbmcgd29ybGQgbGltaXRzICgrLTE4MCwrLTkwKQogICAgICAgICAgICAgICAgdG1pbngsIHRtaW55ID0gbWF4KDAsIHRtaW54KSwgbWF4KDAsIHRtaW55KQogICAgICAgICAgICAgICAgdG1heHgsIHRtYXh5ID0gbWluKDIqKih0eisxKS0xLCB0bWF4eCksIG1pbigyKip0ei0xLCB0bWF4eSkKICAgICAgICAgICAgICAgIHNlbGYudG1pbm1heFt0el0gPSAodG1pbngsIHRtaW55LCB0bWF4eCwgdG1heHkpCgogICAgICAgICAgICAjIFRPRE86IE1hcHMgY3Jvc3NpbmcgMTgwRSAoQWxhc2thPykKCiAgICAgICAgICAgICMgR2V0IHRoZSBtYXhpbWFsIHpvb20gbGV2ZWwKICAgICAgICAgICAgIyAoY2xvc2VzdCBwb3NzaWJsZSB6b29tIGxldmVsIHVwIG9uIHRoZSByZXNvbHV0aW9uIG9mIHJhc3RlcikKICAgICAgICAgICAgaWYgc2VsZi50bWlueiBpcyBOb25lOgogICAgICAgICAgICAgICAgc2VsZi50bWlueiA9IHNlbGYuZ2VvZGV0aWMuWm9vbUZvclBpeGVsU2l6ZSgKICAgICAgICAgICAgICAgICAgICBzZWxmLm91dF9ndFsxXSAqCiAgICAgICAgICAgICAgICAgICAgbWF4KHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQuUmFzdGVyWFNpemUsCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQuUmFzdGVyWVNpemUpIC8KICAgICAgICAgICAgICAgICAgICBmbG9hdChzZWxmLnRpbGVzaXplKSkKCiAgICAgICAgICAgICMgR2V0IHRoZSBtYXhpbWFsIHpvb20gbGV2ZWwKICAgICAgICAgICAgIyAoY2xvc2VzdCBwb3NzaWJsZSB6b29tIGxldmVsIHVwIG9uIHRoZSByZXNvbHV0aW9uIG9mIHJhc3RlcikKICAgICAgICAgICAgaWYgc2VsZi50bWF4eiBpcyBOb25lOgogICAgICAgICAgICAgICAgc2VsZi50bWF4eiA9IHNlbGYuZ2VvZGV0aWMuWm9vbUZvclBpeGVsU2l6ZShzZWxmLm91dF9ndFsxXSkKCiAgICAgICAgICAgIGlmIHNlbGYub3B0aW9ucy52ZXJib3NlOgogICAgICAgICAgICAgICAgcHJpbnQoIkJvdW5kcyAobGF0bG9uZyk6Iiwgc2VsZi5vbWlueCwgc2VsZi5vbWlueSwgc2VsZi5vbWF4eCwgc2VsZi5vbWF4eSkKCiAgICAgICAgaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ3Jhc3Rlcic6CgogICAgICAgICAgICBkZWYgbG9nMih4KToKICAgICAgICAgICAgICAgIHJldHVybiBtYXRoLmxvZzEwKHgpIC8gbWF0aC5sb2cxMCgyKQoKICAgICAgICAgICAgc2VsZi5uYXRpdmV6b29tID0gaW50KAogICAgICAgICAgICAgICAgbWF4KG1hdGguY2VpbChsb2cyKHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQuUmFzdGVyWFNpemUvZmxvYXQoc2VsZi50aWxlc2l6ZSkpKSwKICAgICAgICAgICAgICAgICAgICBtYXRoLmNlaWwobG9nMihzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0LlJhc3RlcllTaXplL2Zsb2F0KHNlbGYudGlsZXNpemUpKSkpKQoKICAgICAgICAgICAgaWYgc2VsZi5vcHRpb25zLnZlcmJvc2U6CiAgICAgICAgICAgICAgICBwcmludCgiTmF0aXZlIHpvb20gb2YgdGhlIHJhc3RlcjoiLCBzZWxmLm5hdGl2ZXpvb20pCgogICAgICAgICAgICAjIEdldCB0aGUgbWluaW1hbCB6b29tIGxldmVsICh3aG9sZSByYXN0ZXIgaW4gb25lIHRpbGUpCiAgICAgICAgICAgIGlmIHNlbGYudG1pbnogaXMgTm9uZToKICAgICAgICAgICAgICAgIHNlbGYudG1pbnogPSAwCgogICAgICAgICAgICAjIEdldCB0aGUgbWF4aW1hbCB6b29tIGxldmVsIChuYXRpdmUgcmVzb2x1dGlvbiBvZiB0aGUgcmFzdGVyKQogICAgICAgICAgICBpZiBzZWxmLnRtYXh6IGlzIE5vbmU6CiAgICAgICAgICAgICAgICBzZWxmLnRtYXh6ID0gc2VsZi5uYXRpdmV6b29tCgogICAgICAgICAgICAjIEdlbmVyYXRlIHRhYmxlIHdpdGggbWluIG1heCB0aWxlIGNvb3JkaW5hdGVzIGZvciBhbGwgem9vbWxldmVscwogICAgICAgICAgICBzZWxmLnRtaW5tYXggPSBsaXN0KHJhbmdlKDAsIHNlbGYudG1heHorMSkpCiAgICAgICAgICAgIHNlbGYudHNpemUgPSBsaXN0KHJhbmdlKDAsIHNlbGYudG1heHorMSkpCiAgICAgICAgICAgIGZvciB0eiBpbiByYW5nZSgwLCBzZWxmLnRtYXh6KzEpOgogICAgICAgICAgICAgICAgdHNpemUgPSAyLjAqKihzZWxmLm5hdGl2ZXpvb20tdHopKnNlbGYudGlsZXNpemUKICAgICAgICAgICAgICAgIHRtaW54LCB0bWlueSA9IDAsIDAKICAgICAgICAgICAgICAgIHRtYXh4ID0gaW50KG1hdGguY2VpbChzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0LlJhc3RlclhTaXplIC8gdHNpemUpKSAtIDEKICAgICAgICAgICAgICAgIHRtYXh5ID0gaW50KG1hdGguY2VpbChzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0LlJhc3RlcllTaXplIC8gdHNpemUpKSAtIDEKICAgICAgICAgICAgICAgIHNlbGYudHNpemVbdHpdID0gbWF0aC5jZWlsKHRzaXplKQogICAgICAgICAgICAgICAgc2VsZi50bWlubWF4W3R6XSA9ICh0bWlueCwgdG1pbnksIHRtYXh4LCB0bWF4eSkKCiAgICAgICAgICAgICMgRnVuY3Rpb24gd2hpY2ggZ2VuZXJhdGVzIFNXTkUgaW4gTGF0TG9uZyBmb3IgZ2l2ZW4gdGlsZQogICAgICAgICAgICBpZiBzZWxmLmttbCBhbmQgc2VsZi5pbl9zcnNfd2t0OgogICAgICAgICAgICAgICAgY3QgPSBvc3IuQ29vcmRpbmF0ZVRyYW5zZm9ybWF0aW9uKGluX3Nycywgc3JzNDMyNikKCiAgICAgICAgICAgICAgICBkZWYgcmFzdGVydGlsZXN3bmUoeCwgeSwgeik6CiAgICAgICAgICAgICAgICAgICAgcGl4ZWxzaXpleCA9ICgyKiooc2VsZi50bWF4ei16KSAqIHNlbGYub3V0X2d0WzFdKSAgICAgICAjIFgtcGl4ZWwgc2l6ZSBpbiBsZXZlbAogICAgICAgICAgICAgICAgICAgIHdlc3QgPSBzZWxmLm91dF9ndFswXSArIHgqc2VsZi50aWxlc2l6ZSpwaXhlbHNpemV4CiAgICAgICAgICAgICAgICAgICAgZWFzdCA9IHdlc3QgKyBzZWxmLnRpbGVzaXplKnBpeGVsc2l6ZXgKICAgICAgICAgICAgICAgICAgICBzb3V0aCA9IHNlbGYub21pbnkgKyB5KnNlbGYudGlsZXNpemUqcGl4ZWxzaXpleAogICAgICAgICAgICAgICAgICAgIG5vcnRoID0gc291dGggKyBzZWxmLnRpbGVzaXplKnBpeGVsc2l6ZXgKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5pc2Vwc2c0MzI2OgogICAgICAgICAgICAgICAgICAgICAgICAjIFRyYW5zZm9ybWF0aW9uIHRvIEVQU0c6NDMyNiAoV0dTODQgZGF0dW0pCiAgICAgICAgICAgICAgICAgICAgICAgIHdlc3QsIHNvdXRoID0gY3QuVHJhbnNmb3JtUG9pbnQod2VzdCwgc291dGgpWzoyXQogICAgICAgICAgICAgICAgICAgICAgICBlYXN0LCBub3J0aCA9IGN0LlRyYW5zZm9ybVBvaW50KGVhc3QsIG5vcnRoKVs6Ml0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gc291dGgsIHdlc3QsIG5vcnRoLCBlYXN0CgogICAgICAgICAgICAgICAgc2VsZi50aWxlc3duZSA9IHJhc3RlcnRpbGVzd25lCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLnRpbGVzd25lID0gbGFtYmRhIHgsIHksIHo6ICgwLCAwLCAwLCAwKSAgICMgbm9xYQoKICAgIGRlZiBnZW5lcmF0ZV9tZXRhZGF0YShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBHZW5lcmF0aW9uIG9mIG1haW4gbWV0YWRhdGEgZmlsZXMgYW5kIEhUTUwgdmlld2VycyAobWV0YWRhdGEgcmVsYXRlZCB0byBwYXJ0aWN1bGFyCiAgICAgICAgdGlsZXMgYXJlIGdlbmVyYXRlZCBkdXJpbmcgdGhlIHRpbGUgcHJvY2Vzc2luZykuCiAgICAgICAgIiIiCgogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhzZWxmLm91dHB1dF9mb2xkZXIpOgogICAgICAgICAgICBvcy5tYWtlZGlycyhzZWxmLm91dHB1dF9mb2xkZXIpCgogICAgICAgIGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdtZXJjYXRvcic6CgogICAgICAgICAgICBzb3V0aCwgd2VzdCA9IHNlbGYubWVyY2F0b3IuTWV0ZXJzVG9MYXRMb24oc2VsZi5vbWlueCwgc2VsZi5vbWlueSkKICAgICAgICAgICAgbm9ydGgsIGVhc3QgPSBzZWxmLm1lcmNhdG9yLk1ldGVyc1RvTGF0TG9uKHNlbGYub21heHgsIHNlbGYub21heHkpCiAgICAgICAgICAgIHNvdXRoLCB3ZXN0ID0gbWF4KC04NS4wNTExMjg3OCwgc291dGgpLCBtYXgoLTE4MC4wLCB3ZXN0KQogICAgICAgICAgICBub3J0aCwgZWFzdCA9IG1pbig4NS4wNTExMjg3OCwgbm9ydGgpLCBtaW4oMTgwLjAsIGVhc3QpCiAgICAgICAgICAgIHNlbGYuc3duZSA9IChzb3V0aCwgd2VzdCwgbm9ydGgsIGVhc3QpCgogICAgICAgICAgICAjIEdlbmVyYXRlIGdvb2dsZW1hcHMuaHRtbAogICAgICAgICAgICBpZiBzZWxmLm9wdGlvbnMud2Vidmlld2VyIGluICgnYWxsJywgJ2dvb2dsZScpIGFuZCBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAnbWVyY2F0b3InOgogICAgICAgICAgICAgICAgaWYgKG5vdCBzZWxmLm9wdGlvbnMucmVzdW1lIG9yIG5vdAogICAgICAgICAgICAgICAgICAgICAgICBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4oc2VsZi5vdXRwdXRfZm9sZGVyLCAnZ29vZ2xlbWFwcy5odG1sJykpKToKICAgICAgICAgICAgICAgICAgICB3aXRoIG9wZW4ob3MucGF0aC5qb2luKHNlbGYub3V0cHV0X2ZvbGRlciwgJ2dvb2dsZW1hcHMuaHRtbCcpLCAnd2InKSBhcyBmOgogICAgICAgICAgICAgICAgICAgICAgICBmLndyaXRlKHNlbGYuZ2VuZXJhdGVfZ29vZ2xlbWFwcygpLmVuY29kZSgndXRmLTgnKSkKCiAgICAgICAgICAgICMgR2VuZXJhdGUgb3BlbmxheWVycy5odG1sCiAgICAgICAgICAgIGlmIHNlbGYub3B0aW9ucy53ZWJ2aWV3ZXIgaW4gKCdhbGwnLCAnb3BlbmxheWVycycpOgogICAgICAgICAgICAgICAgaWYgKG5vdCBzZWxmLm9wdGlvbnMucmVzdW1lIG9yIG5vdAogICAgICAgICAgICAgICAgICAgICAgICBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4oc2VsZi5vdXRwdXRfZm9sZGVyLCAnb3BlbmxheWVycy5odG1sJykpKToKICAgICAgICAgICAgICAgICAgICB3aXRoIG9wZW4ob3MucGF0aC5qb2luKHNlbGYub3V0cHV0X2ZvbGRlciwgJ29wZW5sYXllcnMuaHRtbCcpLCAnd2InKSBhcyBmOgogICAgICAgICAgICAgICAgICAgICAgICBmLndyaXRlKHNlbGYuZ2VuZXJhdGVfb3BlbmxheWVycygpLmVuY29kZSgndXRmLTgnKSkKCiAgICAgICAgICAgICMgR2VuZXJhdGUgbGVhZmxldC5odG1sCiAgICAgICAgICAgIGlmIHNlbGYub3B0aW9ucy53ZWJ2aWV3ZXIgaW4gKCdhbGwnLCAnbGVhZmxldCcpOgogICAgICAgICAgICAgICAgaWYgKG5vdCBzZWxmLm9wdGlvbnMucmVzdW1lIG9yIG5vdAogICAgICAgICAgICAgICAgICAgICAgICBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4oc2VsZi5vdXRwdXRfZm9sZGVyLCAnbGVhZmxldC5odG1sJykpKToKICAgICAgICAgICAgICAgICAgICB3aXRoIG9wZW4ob3MucGF0aC5qb2luKHNlbGYub3V0cHV0X2ZvbGRlciwgJ2xlYWZsZXQuaHRtbCcpLCAnd2InKSBhcyBmOgogICAgICAgICAgICAgICAgICAgICAgICBmLndyaXRlKHNlbGYuZ2VuZXJhdGVfbGVhZmxldCgpLmVuY29kZSgndXRmLTgnKSkKCiAgICAgICAgZWxpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAnZ2VvZGV0aWMnOgoKICAgICAgICAgICAgd2VzdCwgc291dGggPSBzZWxmLm9taW54LCBzZWxmLm9taW55CiAgICAgICAgICAgIGVhc3QsIG5vcnRoID0gc2VsZi5vbWF4eCwgc2VsZi5vbWF4eQogICAgICAgICAgICBzb3V0aCwgd2VzdCA9IG1heCgtOTAuMCwgc291dGgpLCBtYXgoLTE4MC4wLCB3ZXN0KQogICAgICAgICAgICBub3J0aCwgZWFzdCA9IG1pbig5MC4wLCBub3J0aCksIG1pbigxODAuMCwgZWFzdCkKICAgICAgICAgICAgc2VsZi5zd25lID0gKHNvdXRoLCB3ZXN0LCBub3J0aCwgZWFzdCkKCiAgICAgICAgICAgICMgR2VuZXJhdGUgb3BlbmxheWVycy5odG1sCiAgICAgICAgICAgIGlmIHNlbGYub3B0aW9ucy53ZWJ2aWV3ZXIgaW4gKCdhbGwnLCAnb3BlbmxheWVycycpOgogICAgICAgICAgICAgICAgaWYgKG5vdCBzZWxmLm9wdGlvbnMucmVzdW1lIG9yIG5vdAogICAgICAgICAgICAgICAgICAgICAgICBvcy5wYXRoLmV4aXN0cyhvcy5wYXRoLmpvaW4oc2VsZi5vdXRwdXRfZm9sZGVyLCAnb3BlbmxheWVycy5odG1sJykpKToKICAgICAgICAgICAgICAgICAgICB3aXRoIG9wZW4ob3MucGF0aC5qb2luKHNlbGYub3V0cHV0X2ZvbGRlciwgJ29wZW5sYXllcnMuaHRtbCcpLCAnd2InKSBhcyBmOgogICAgICAgICAgICAgICAgICAgICAgICBmLndyaXRlKHNlbGYuZ2VuZXJhdGVfb3BlbmxheWVycygpLmVuY29kZSgndXRmLTgnKSkKCiAgICAgICAgZWxpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAncmFzdGVyJzoKCiAgICAgICAgICAgIHdlc3QsIHNvdXRoID0gc2VsZi5vbWlueCwgc2VsZi5vbWlueQogICAgICAgICAgICBlYXN0LCBub3J0aCA9IHNlbGYub21heHgsIHNlbGYub21heHkKCiAgICAgICAgICAgIHNlbGYuc3duZSA9IChzb3V0aCwgd2VzdCwgbm9ydGgsIGVhc3QpCgogICAgICAgICAgICAjIEdlbmVyYXRlIG9wZW5sYXllcnMuaHRtbAogICAgICAgICAgICBpZiBzZWxmLm9wdGlvbnMud2Vidmlld2VyIGluICgnYWxsJywgJ29wZW5sYXllcnMnKToKICAgICAgICAgICAgICAgIGlmIChub3Qgc2VsZi5vcHRpb25zLnJlc3VtZSBvciBub3QKICAgICAgICAgICAgICAgICAgICAgICAgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKHNlbGYub3V0cHV0X2ZvbGRlciwgJ29wZW5sYXllcnMuaHRtbCcpKSk6CiAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKG9zLnBhdGguam9pbihzZWxmLm91dHB1dF9mb2xkZXIsICdvcGVubGF5ZXJzLmh0bWwnKSwgJ3diJykgYXMgZjoKICAgICAgICAgICAgICAgICAgICAgICAgZi53cml0ZShzZWxmLmdlbmVyYXRlX29wZW5sYXllcnMoKS5lbmNvZGUoJ3V0Zi04JykpCgogICAgICAgICMgR2VuZXJhdGUgdGlsZW1hcHJlc291cmNlLnhtbC4KICAgICAgICBpZiBub3Qgc2VsZi5vcHRpb25zLnJlc3VtZSBvciBub3Qgb3MucGF0aC5leGlzdHMob3MucGF0aC5qb2luKHNlbGYub3V0cHV0X2ZvbGRlciwgJ3RpbGVtYXByZXNvdXJjZS54bWwnKSk6CiAgICAgICAgICAgIHdpdGggb3Blbihvcy5wYXRoLmpvaW4oc2VsZi5vdXRwdXRfZm9sZGVyLCAndGlsZW1hcHJlc291cmNlLnhtbCcpLCAnd2InKSBhcyBmOgogICAgICAgICAgICAgICAgZi53cml0ZShzZWxmLmdlbmVyYXRlX3RpbGVtYXByZXNvdXJjZSgpLmVuY29kZSgndXRmLTgnKSkKCiAgICAgICAgaWYgc2VsZi5rbWw6CiAgICAgICAgICAgICMgVE9ETzogTWF5YmUgcHJvYmxlbSBmb3Igbm90IGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkIHRtaW56CiAgICAgICAgICAgICMgVGhlIHJvb3QgS01MIHNob3VsZCBjb250YWluIGxpbmtzIHRvIGFsbCB0aWxlcyBpbiB0aGUgdG1pbnogbGV2ZWwKICAgICAgICAgICAgY2hpbGRyZW4gPSBbXQogICAgICAgICAgICB4bWluLCB5bWluLCB4bWF4LCB5bWF4ID0gc2VsZi50bWlubWF4W3NlbGYudG1pbnpdCiAgICAgICAgICAgIGZvciB4IGluIHJhbmdlKHhtaW4sIHhtYXgrMSk6CiAgICAgICAgICAgICAgICBmb3IgeSBpbiByYW5nZSh5bWluLCB5bWF4KzEpOgogICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuLmFwcGVuZChbeCwgeSwgc2VsZi50bWluel0pCiAgICAgICAgICAgICMgR2VuZXJhdGUgUm9vdCBLTUwKICAgICAgICAgICAgaWYgc2VsZi5rbWw6CiAgICAgICAgICAgICAgICBpZiAobm90IHNlbGYub3B0aW9ucy5yZXN1bWUgb3Igbm90CiAgICAgICAgICAgICAgICAgICAgICAgIG9zLnBhdGguZXhpc3RzKG9zLnBhdGguam9pbihzZWxmLm91dHB1dF9mb2xkZXIsICdkb2Mua21sJykpKToKICAgICAgICAgICAgICAgICAgICB3aXRoIG9wZW4ob3MucGF0aC5qb2luKHNlbGYub3V0cHV0X2ZvbGRlciwgJ2RvYy5rbWwnKSwgJ3diJykgYXMgZjoKICAgICAgICAgICAgICAgICAgICAgICAgZi53cml0ZShnZW5lcmF0ZV9rbWwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBOb25lLCBOb25lLCBOb25lLCBzZWxmLnRpbGVleHQsIHNlbGYudGlsZXNpemUsIHNlbGYudGlsZXN3bmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm9wdGlvbnMsIGNoaWxkcmVuCiAgICAgICAgICAgICAgICAgICAgICAgICkuZW5jb2RlKCd1dGYtOCcpKQoKICAgIGRlZiBnZW5lcmF0ZV9iYXNlX3RpbGVzKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEdlbmVyYXRpb24gb2YgdGhlIGJhc2UgdGlsZXMgKHRoZSBsb3dlc3QgaW4gdGhlIHB5cmFtaWQpIGRpcmVjdGx5IGZyb20gdGhlIGlucHV0IHJhc3RlcgogICAgICAgICIiIgoKICAgICAgICBpZiBub3Qgc2VsZi5vcHRpb25zLnF1aWV0OgogICAgICAgICAgICBwcmludCgiR2VuZXJhdGluZyBCYXNlIFRpbGVzOiIpCgogICAgICAgIGlmIHNlbGYub3B0aW9ucy52ZXJib3NlOgogICAgICAgICAgICBwcmludCgnJykKICAgICAgICAgICAgcHJpbnQoIlRpbGVzIGdlbmVyYXRlZCBmcm9tIHRoZSBtYXggem9vbSBsZXZlbDoiKQogICAgICAgICAgICBwcmludCgiLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSIpCiAgICAgICAgICAgIHByaW50KCcnKQoKICAgICAgICAjIFNldCB0aGUgYm91bmRzCiAgICAgICAgdG1pbngsIHRtaW55LCB0bWF4eCwgdG1heHkgPSBzZWxmLnRtaW5tYXhbc2VsZi50bWF4el0KCiAgICAgICAgZHMgPSBzZWxmLndhcnBlZF9pbnB1dF9kYXRhc2V0CiAgICAgICAgdGlsZWJhbmRzID0gc2VsZi5kYXRhQmFuZHNDb3VudCArIDEKICAgICAgICBxdWVyeXNpemUgPSBzZWxmLnF1ZXJ5c2l6ZQoKICAgICAgICBpZiBzZWxmLm9wdGlvbnMudmVyYm9zZToKICAgICAgICAgICAgcHJpbnQoImRhdGFCYW5kc0NvdW50OiAiLCBzZWxmLmRhdGFCYW5kc0NvdW50KQogICAgICAgICAgICBwcmludCgidGlsZWJhbmRzOiAiLCB0aWxlYmFuZHMpCgogICAgICAgIHRjb3VudCA9ICgxK2Ficyh0bWF4eC10bWlueCkpICogKDErYWJzKHRtYXh5LXRtaW55KSkKICAgICAgICB0aSA9IDAKCiAgICAgICAgdGlsZV9kZXRhaWxzID0gW10KCiAgICAgICAgdHogPSBzZWxmLnRtYXh6CiAgICAgICAgZm9yIHR5IGluIHJhbmdlKHRtYXh5LCB0bWlueS0xLCAtMSk6CiAgICAgICAgICAgIGZvciB0eCBpbiByYW5nZSh0bWlueCwgdG1heHgrMSk6CgogICAgICAgICAgICAgICAgdGkgKz0gMQogICAgICAgICAgICAgICAgeXRpbGUgPSBHREFMMlRpbGVzLmdldFl0aWxlKHR5LCB0eiwgc2VsZi5vcHRpb25zKQogICAgICAgICAgICAgICAgdGlsZWZpbGVuYW1lID0gb3MucGF0aC5qb2luKAogICAgICAgICAgICAgICAgICAgIHNlbGYub3V0cHV0X2ZvbGRlciwgc3RyKHR6KSwgJ3swOjA0ZH0nLmZvcm1hdCh0eCkgKyAiXyIgKyAnezA6MDRkfScuZm9ybWF0KHl0aWxlKSArICIuIiArIHNlbGYudGlsZWV4dCkKICAgICAgICAgICAgICAgIGlmIHNlbGYub3B0aW9ucy52ZXJib3NlOgogICAgICAgICAgICAgICAgICAgIHByaW50KHRpLCAnLycsIHRjb3VudCwgdGlsZWZpbGVuYW1lKQoKICAgICAgICAgICAgICAgIGlmIHNlbGYub3B0aW9ucy5yZXN1bWUgYW5kIG9zLnBhdGguZXhpc3RzKHRpbGVmaWxlbmFtZSk6CiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5vcHRpb25zLnZlcmJvc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KCJUaWxlIGdlbmVyYXRpb24gc2tpcHBlZCBiZWNhdXNlIG9mIC0tcmVzdW1lIikKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgICAgICMgQ3JlYXRlIGRpcmVjdG9yaWVzIGZvciB0aGUgdGlsZQogICAgICAgICAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKG9zLnBhdGguZGlybmFtZSh0aWxlZmlsZW5hbWUpKToKICAgICAgICAgICAgICAgICAgICBvcy5tYWtlZGlycyhvcy5wYXRoLmRpcm5hbWUodGlsZWZpbGVuYW1lKSkKCiAgICAgICAgICAgICAgICBpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAnbWVyY2F0b3InOgogICAgICAgICAgICAgICAgICAgICMgVGlsZSBib3VuZHMgaW4gRVBTRzozODU3CiAgICAgICAgICAgICAgICAgICAgYiA9IHNlbGYubWVyY2F0b3IuVGlsZUJvdW5kcyh0eCwgdHksIHR6KQogICAgICAgICAgICAgICAgZWxpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAnZ2VvZGV0aWMnOgogICAgICAgICAgICAgICAgICAgIGIgPSBzZWxmLmdlb2RldGljLlRpbGVCb3VuZHModHgsIHR5LCB0eikKCiAgICAgICAgICAgICAgICAjIERvbid0IHNjYWxlIHVwIGJ5IG5lYXJlc3QgbmVpZ2hib3VyLCBiZXR0ZXIgY2hhbmdlIHRoZSBxdWVyeXNpemUKICAgICAgICAgICAgICAgICMgdG8gdGhlIG5hdGl2ZSByZXNvbHV0aW9uIChhbmQgcmV0dXJuIHNtYWxsZXIgcXVlcnkgdGlsZSkgZm9yIHNjYWxpbmcKCiAgICAgICAgICAgICAgICBpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSBpbiAoJ21lcmNhdG9yJywgJ2dlb2RldGljJyk6CiAgICAgICAgICAgICAgICAgICAgcmIsIHdiID0gc2VsZi5nZW9fcXVlcnkoZHMsIGJbMF0sIGJbM10sIGJbMl0sIGJbMV0pCgogICAgICAgICAgICAgICAgICAgICMgUGl4ZWwgc2l6ZSBpbiB0aGUgcmFzdGVyIGNvdmVyaW5nIHF1ZXJ5IGdlbyBleHRlbnQKICAgICAgICAgICAgICAgICAgICBuYXRpdmVzaXplID0gd2JbMF0gKyB3YlsyXQogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYub3B0aW9ucy52ZXJib3NlOgogICAgICAgICAgICAgICAgICAgICAgICBwcmludCgiXHROYXRpdmUgRXh0ZW50IChxdWVyeXNpemUiLCBuYXRpdmVzaXplLCAiKTogIiwgcmIsIHdiKQoKICAgICAgICAgICAgICAgICAgICAjIFRpbGUgYm91bmRzIGluIHJhc3RlciBjb29yZGluYXRlcyBmb3IgUmVhZFJhc3RlciBxdWVyeQogICAgICAgICAgICAgICAgICAgIHJiLCB3YiA9IHNlbGYuZ2VvX3F1ZXJ5KGRzLCBiWzBdLCBiWzNdLCBiWzJdLCBiWzFdLCBxdWVyeXNpemU9cXVlcnlzaXplKQoKICAgICAgICAgICAgICAgICAgICByeCwgcnksIHJ4c2l6ZSwgcnlzaXplID0gcmIKICAgICAgICAgICAgICAgICAgICB3eCwgd3ksIHd4c2l6ZSwgd3lzaXplID0gd2IKCiAgICAgICAgICAgICAgICBlbHNlOiAgICAgIyAncmFzdGVyJyBwcm9maWxlOgoKICAgICAgICAgICAgICAgICAgICB0c2l6ZSA9IGludChzZWxmLnRzaXplW3R6XSkgICAjIHRpbGVzaXplIGluIHJhc3RlciBjb29yZGluYXRlcyBmb3IgYWN0dWFsIHpvb20KICAgICAgICAgICAgICAgICAgICB4c2l6ZSA9IHNlbGYud2FycGVkX2lucHV0X2RhdGFzZXQuUmFzdGVyWFNpemUgICAgICMgc2l6ZSBvZiB0aGUgcmFzdGVyIGluIHBpeGVscwogICAgICAgICAgICAgICAgICAgIHlzaXplID0gc2VsZi53YXJwZWRfaW5wdXRfZGF0YXNldC5SYXN0ZXJZU2l6ZQogICAgICAgICAgICAgICAgICAgIGlmIHR6ID49IHNlbGYubmF0aXZlem9vbToKICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnlzaXplID0gc2VsZi50aWxlc2l6ZQoKICAgICAgICAgICAgICAgICAgICByeCA9ICh0eCkgKiB0c2l6ZQogICAgICAgICAgICAgICAgICAgIHJ4c2l6ZSA9IDAKICAgICAgICAgICAgICAgICAgICBpZiB0eCA9PSB0bWF4eDoKICAgICAgICAgICAgICAgICAgICAgICAgcnhzaXplID0geHNpemUgJSB0c2l6ZQogICAgICAgICAgICAgICAgICAgIGlmIHJ4c2l6ZSA9PSAwOgogICAgICAgICAgICAgICAgICAgICAgICByeHNpemUgPSB0c2l6ZQoKICAgICAgICAgICAgICAgICAgICByeXNpemUgPSAwCiAgICAgICAgICAgICAgICAgICAgaWYgdHkgPT0gdG1heHk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJ5c2l6ZSA9IHlzaXplICUgdHNpemUKICAgICAgICAgICAgICAgICAgICBpZiByeXNpemUgPT0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgcnlzaXplID0gdHNpemUKICAgICAgICAgICAgICAgICAgICByeSA9IHlzaXplIC0gKHR5ICogdHNpemUpIC0gcnlzaXplCgogICAgICAgICAgICAgICAgICAgIHd4LCB3eSA9IDAsIDAKICAgICAgICAgICAgICAgICAgICB3eHNpemUgPSBpbnQocnhzaXplL2Zsb2F0KHRzaXplKSAqIHNlbGYudGlsZXNpemUpCiAgICAgICAgICAgICAgICAgICAgd3lzaXplID0gaW50KHJ5c2l6ZS9mbG9hdCh0c2l6ZSkgKiBzZWxmLnRpbGVzaXplKQogICAgICAgICAgICAgICAgICAgIGlmIHd5c2l6ZSAhPSBzZWxmLnRpbGVzaXplOgogICAgICAgICAgICAgICAgICAgICAgICB3eSA9IHNlbGYudGlsZXNpemUgLSB3eXNpemUKCiAgICAgICAgICAgICAgICAjIFJlYWQgdGhlIHNvdXJjZSByYXN0ZXIgaWYgYW55dGhpbmcgaXMgZ29pbmcgaW5zaWRlIHRoZSB0aWxlIGFzIHBlciB0aGUgY29tcHV0ZWQKICAgICAgICAgICAgICAgICMgZ2VvX3F1ZXJ5CiAgICAgICAgICAgICAgICB0aWxlX2RldGFpbHMuYXBwZW5kKAogICAgICAgICAgICAgICAgICAgIFRpbGVEZXRhaWwoCiAgICAgICAgICAgICAgICAgICAgICAgIHR4PXR4LCB0eT15dGlsZSwgdHo9dHosIHJ4PXJ4LCByeT1yeSwgcnhzaXplPXJ4c2l6ZSwgcnlzaXplPXJ5c2l6ZSwgd3g9d3gsCiAgICAgICAgICAgICAgICAgICAgICAgIHd5PXd5LCB3eHNpemU9d3hzaXplLCB3eXNpemU9d3lzaXplLCBxdWVyeXNpemU9cXVlcnlzaXplLAogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICkKCiAgICAgICAgY29uZiA9IFRpbGVKb2JJbmZvKAogICAgICAgICAgICBzcmNfZmlsZT1zZWxmLnRtcF92cnRfZmlsZW5hbWUsCiAgICAgICAgICAgIG5iX2RhdGFfYmFuZHM9c2VsZi5kYXRhQmFuZHNDb3VudCwKICAgICAgICAgICAgb3V0cHV0X2ZpbGVfcGF0aD1zZWxmLm91dHB1dF9mb2xkZXIsCiAgICAgICAgICAgIHRpbGVfZXh0ZW5zaW9uPXNlbGYudGlsZWV4dCwKICAgICAgICAgICAgdGlsZV9kcml2ZXI9c2VsZi50aWxlZHJpdmVyLAogICAgICAgICAgICB0aWxlX3NpemU9c2VsZi50aWxlc2l6ZSwKICAgICAgICAgICAga21sPXNlbGYua21sLAogICAgICAgICAgICB0bWlubWF4PXNlbGYudG1pbm1heCwKICAgICAgICAgICAgdG1pbno9c2VsZi50bWlueiwKICAgICAgICAgICAgdG1heHo9c2VsZi50bWF4eiwKICAgICAgICAgICAgaW5fc3JzX3drdD1zZWxmLmluX3Nyc193a3QsCiAgICAgICAgICAgIG91dF9nZW9fdHJhbnM9c2VsZi5vdXRfZ3QsCiAgICAgICAgICAgIG9taW55PXNlbGYub21pbnksCiAgICAgICAgICAgIGlzX2Vwc2dfNDMyNj1zZWxmLmlzZXBzZzQzMjYsCiAgICAgICAgICAgIG9wdGlvbnM9c2VsZi5vcHRpb25zLAogICAgICAgICkKCiAgICAgICAgcmV0dXJuIGNvbmYsIHRpbGVfZGV0YWlscwoKICAgIGRlZiBnZW9fcXVlcnkoc2VsZiwgZHMsIHVseCwgdWx5LCBscngsIGxyeSwgcXVlcnlzaXplPTApOgogICAgICAgICIiIgogICAgICAgIEZvciBnaXZlbiBkYXRhc2V0IGFuZCBxdWVyeSBpbiBjYXJ0b2dyYXBoaWMgY29vcmRpbmF0ZXMgcmV0dXJucyBwYXJhbWV0ZXJzIGZvciBSZWFkUmFzdGVyKCkKICAgICAgICBpbiByYXN0ZXIgY29vcmRpbmF0ZXMgYW5kIHgveSBzaGlmdHMgKGZvciBib3JkZXIgdGlsZXMpLiBJZiB0aGUgcXVlcnlzaXplIGlzIG5vdCBnaXZlbiwgdGhlCiAgICAgICAgZXh0ZW50IGlzIHJldHVybmVkIGluIHRoZSBuYXRpdmUgcmVzb2x1dGlvbiBvZiBkYXRhc2V0IGRzLgoKICAgICAgICByYWlzZXMgR2RhbDJUaWxlc0Vycm9yIGlmIHRoZSBkYXRhc2V0IGRvZXMgbm90IGNvbnRhaW4gYW55dGhpbmcgaW5zaWRlIHRoaXMgZ2VvX3F1ZXJ5CiAgICAgICAgIiIiCiAgICAgICAgZ2VvdHJhbiA9IGRzLkdldEdlb1RyYW5zZm9ybSgpCiAgICAgICAgcnggPSBpbnQoKHVseCAtIGdlb3RyYW5bMF0pIC8gZ2VvdHJhblsxXSArIDAuMDAxKQogICAgICAgIHJ5ID0gaW50KCh1bHkgLSBnZW90cmFuWzNdKSAvIGdlb3RyYW5bNV0gKyAwLjAwMSkKICAgICAgICByeHNpemUgPSBpbnQoKGxyeCAtIHVseCkgLyBnZW90cmFuWzFdICsgMC41KQogICAgICAgIHJ5c2l6ZSA9IGludCgobHJ5IC0gdWx5KSAvIGdlb3RyYW5bNV0gKyAwLjUpCgogICAgICAgIGlmIG5vdCBxdWVyeXNpemU6CiAgICAgICAgICAgIHd4c2l6ZSwgd3lzaXplID0gcnhzaXplLCByeXNpemUKICAgICAgICBlbHNlOgogICAgICAgICAgICB3eHNpemUsIHd5c2l6ZSA9IHF1ZXJ5c2l6ZSwgcXVlcnlzaXplCgogICAgICAgICMgQ29vcmRpbmF0ZXMgc2hvdWxkIG5vdCBnbyBvdXQgb2YgdGhlIGJvdW5kcyBvZiB0aGUgcmFzdGVyCiAgICAgICAgd3ggPSAwCiAgICAgICAgaWYgcnggPCAwOgogICAgICAgICAgICByeHNoaWZ0ID0gYWJzKHJ4KQogICAgICAgICAgICB3eCA9IGludCh3eHNpemUgKiAoZmxvYXQocnhzaGlmdCkgLyByeHNpemUpKQogICAgICAgICAgICB3eHNpemUgPSB3eHNpemUgLSB3eAogICAgICAgICAgICByeHNpemUgPSByeHNpemUgLSBpbnQocnhzaXplICogKGZsb2F0KHJ4c2hpZnQpIC8gcnhzaXplKSkKICAgICAgICAgICAgcnggPSAwCiAgICAgICAgaWYgcngrcnhzaXplID4gZHMuUmFzdGVyWFNpemU6CiAgICAgICAgICAgIHd4c2l6ZSA9IGludCh3eHNpemUgKiAoZmxvYXQoZHMuUmFzdGVyWFNpemUgLSByeCkgLyByeHNpemUpKQogICAgICAgICAgICByeHNpemUgPSBkcy5SYXN0ZXJYU2l6ZSAtIHJ4CgogICAgICAgIHd5ID0gMAogICAgICAgIGlmIHJ5IDwgMDoKICAgICAgICAgICAgcnlzaGlmdCA9IGFicyhyeSkKICAgICAgICAgICAgd3kgPSBpbnQod3lzaXplICogKGZsb2F0KHJ5c2hpZnQpIC8gcnlzaXplKSkKICAgICAgICAgICAgd3lzaXplID0gd3lzaXplIC0gd3kKICAgICAgICAgICAgcnlzaXplID0gcnlzaXplIC0gaW50KHJ5c2l6ZSAqIChmbG9hdChyeXNoaWZ0KSAvIHJ5c2l6ZSkpCiAgICAgICAgICAgIHJ5ID0gMAogICAgICAgIGlmIHJ5K3J5c2l6ZSA+IGRzLlJhc3RlcllTaXplOgogICAgICAgICAgICB3eXNpemUgPSBpbnQod3lzaXplICogKGZsb2F0KGRzLlJhc3RlcllTaXplIC0gcnkpIC8gcnlzaXplKSkKICAgICAgICAgICAgcnlzaXplID0gZHMuUmFzdGVyWVNpemUgLSByeQoKICAgICAgICByZXR1cm4gKHJ4LCByeSwgcnhzaXplLCByeXNpemUpLCAod3gsIHd5LCB3eHNpemUsIHd5c2l6ZSkKCiAgICBkZWYgZ2VuZXJhdGVfdGlsZW1hcHJlc291cmNlKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFRlbXBsYXRlIGZvciB0aWxlbWFwcmVzb3VyY2UueG1sLiBSZXR1cm5zIGZpbGxlZCBzdHJpbmcuIEV4cGVjdGVkIHZhcmlhYmxlczoKICAgICAgICAgIHRpdGxlLCBub3J0aCwgc291dGgsIGVhc3QsIHdlc3QsIGlzZXBzZzQzMjYsIHByb2plY3Rpb24sIHB1Ymxpc2h1cmwsCiAgICAgICAgICB6b29tcGl4ZWxzLCB0aWxlc2l6ZSwgdGlsZWZvcm1hdCwgcHJvZmlsZQogICAgICAgICIiIgoKICAgICAgICBhcmdzID0ge30KICAgICAgICBhcmdzWyd0aXRsZSddID0gc2VsZi5vcHRpb25zLnRpdGxlCiAgICAgICAgYXJnc1snc291dGgnXSwgYXJnc1snd2VzdCddLCBhcmdzWydub3J0aCddLCBhcmdzWydlYXN0J10gPSBzZWxmLnN3bmUKICAgICAgICBhcmdzWyd0aWxlc2l6ZSddID0gc2VsZi50aWxlc2l6ZQogICAgICAgIGFyZ3NbJ3RpbGVmb3JtYXQnXSA9IHNlbGYudGlsZWV4dAogICAgICAgIGFyZ3NbJ3B1Ymxpc2h1cmwnXSA9IHNlbGYub3B0aW9ucy51cmwKICAgICAgICBhcmdzWydwcm9maWxlJ10gPSBzZWxmLm9wdGlvbnMucHJvZmlsZQoKICAgICAgICBpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAnbWVyY2F0b3InOgogICAgICAgICAgICBhcmdzWydzcnMnXSA9ICJFUFNHOjM4NTciCiAgICAgICAgZWxpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAnZ2VvZGV0aWMnOgogICAgICAgICAgICBhcmdzWydzcnMnXSA9ICJFUFNHOjQzMjYiCiAgICAgICAgZWxpZiBzZWxmLm9wdGlvbnMuc19zcnM6CiAgICAgICAgICAgIGFyZ3NbJ3NycyddID0gc2VsZi5vcHRpb25zLnNfc3JzCiAgICAgICAgZWxpZiBzZWxmLm91dF9zcnM6CiAgICAgICAgICAgIGFyZ3NbJ3NycyddID0gc2VsZi5vdXRfc3JzLkV4cG9ydFRvV2t0KCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBhcmdzWydzcnMnXSA9ICIiCgogICAgICAgIHMgPSAiIiI8P3htbCB2ZXJzaW9uPSIxLjAiIGVuY29kaW5nPSJ1dGYtOCI/PgogICAgPFRpbGVNYXAgdmVyc2lvbj0iMS4wLjAiIHRpbGVtYXBzZXJ2aWNlPSJodHRwOi8vdG1zLm9zZ2VvLm9yZy8xLjAuMCI+CiAgICAgIDxUaXRsZT4lKHRpdGxlKXM8L1RpdGxlPgogICAgICA8QWJzdHJhY3Q+PC9BYnN0cmFjdD4KICAgICAgPFNSUz4lKHNycylzPC9TUlM+CiAgICAgIDxCb3VuZGluZ0JveCBtaW54PSIlKHdlc3QpLjE0ZiIgbWlueT0iJShzb3V0aCkuMTRmIiBtYXh4PSIlKGVhc3QpLjE0ZiIgbWF4eT0iJShub3J0aCkuMTRmIi8+CiAgICAgIDxPcmlnaW4geD0iJSh3ZXN0KS4xNGYiIHk9IiUoc291dGgpLjE0ZiIvPgogICAgICA8VGlsZUZvcm1hdCB3aWR0aD0iJSh0aWxlc2l6ZSlkIiBoZWlnaHQ9IiUodGlsZXNpemUpZCIgbWltZS10eXBlPSJpbWFnZS8lKHRpbGVmb3JtYXQpcyIgZXh0ZW5zaW9uPSIlKHRpbGVmb3JtYXQpcyIvPgogICAgICA8VGlsZVNldHMgcHJvZmlsZT0iJShwcm9maWxlKXMiPgoiIiIgJSBhcmdzICAgICMgbm9xYQogICAgICAgIGZvciB6IGluIHJhbmdlKHNlbGYudG1pbnosIHNlbGYudG1heHorMSk6CiAgICAgICAgICAgIGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdyYXN0ZXInOgogICAgICAgICAgICAgICAgcyArPSAiIiIgICAgICAgIDxUaWxlU2V0IGhyZWY9IiVzJWQiIHVuaXRzLXBlci1waXhlbD0iJS4xNGYiIG9yZGVyPSIlZCIvPlxuIiIiICUgKAogICAgICAgICAgICAgICAgICAgIGFyZ3NbJ3B1Ymxpc2h1cmwnXSwgeiwgKDIqKihzZWxmLm5hdGl2ZXpvb20teikgKiBzZWxmLm91dF9ndFsxXSksIHopCiAgICAgICAgICAgIGVsaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ21lcmNhdG9yJzoKICAgICAgICAgICAgICAgIHMgKz0gIiIiICAgICAgICA8VGlsZVNldCBocmVmPSIlcyVkIiB1bml0cy1wZXItcGl4ZWw9IiUuMTRmIiBvcmRlcj0iJWQiLz5cbiIiIiAlICgKICAgICAgICAgICAgICAgICAgICBhcmdzWydwdWJsaXNodXJsJ10sIHosIDE1NjU0My4wMzM5LzIqKnosIHopCiAgICAgICAgICAgIGVsaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ2dlb2RldGljJzoKICAgICAgICAgICAgICAgIHMgKz0gIiIiICAgICAgICA8VGlsZVNldCBocmVmPSIlcyVkIiB1bml0cy1wZXItcGl4ZWw9IiUuMTRmIiBvcmRlcj0iJWQiLz5cbiIiIiAlICgKICAgICAgICAgICAgICAgICAgICBhcmdzWydwdWJsaXNodXJsJ10sIHosIDAuNzAzMTI1LzIqKnosIHopCiAgICAgICAgcyArPSAiIiIgICAgICA8L1RpbGVTZXRzPgogICAgPC9UaWxlTWFwPgogICAgIiIiCiAgICAgICAgcmV0dXJuIHMKCiAgICBkZWYgZ2VuZXJhdGVfZ29vZ2xlbWFwcyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBUZW1wbGF0ZSBmb3IgZ29vZ2xlbWFwcy5odG1sIGltcGxlbWVudGluZyBPdmVybGF5IG9mIHRpbGVzIGZvciAnbWVyY2F0b3InIHByb2ZpbGUuCiAgICAgICAgSXQgcmV0dXJucyBmaWxsZWQgc3RyaW5nLiBFeHBlY3RlZCB2YXJpYWJsZXM6CiAgICAgICAgdGl0bGUsIGdvb2dsZW1hcHNrZXksIG5vcnRoLCBzb3V0aCwgZWFzdCwgd2VzdCwgbWluem9vbSwgbWF4em9vbSwgdGlsZXNpemUsIHRpbGVmb3JtYXQsCiAgICAgICAgcHVibGlzaHVybAogICAgICAgICIiIgogICAgICAgIGFyZ3MgPSB7fQogICAgICAgIGFyZ3NbJ3RpdGxlJ10gPSBzZWxmLm9wdGlvbnMudGl0bGUKICAgICAgICBhcmdzWydnb29nbGVtYXBza2V5J10gPSBzZWxmLm9wdGlvbnMuZ29vZ2xla2V5CiAgICAgICAgYXJnc1snc291dGgnXSwgYXJnc1snd2VzdCddLCBhcmdzWydub3J0aCddLCBhcmdzWydlYXN0J10gPSBzZWxmLnN3bmUKICAgICAgICBhcmdzWydtaW56b29tJ10gPSBzZWxmLnRtaW56CiAgICAgICAgYXJnc1snbWF4em9vbSddID0gc2VsZi50bWF4egogICAgICAgIGFyZ3NbJ3RpbGVzaXplJ10gPSBzZWxmLnRpbGVzaXplCiAgICAgICAgYXJnc1sndGlsZWZvcm1hdCddID0gc2VsZi50aWxlZXh0CiAgICAgICAgYXJnc1sncHVibGlzaHVybCddID0gc2VsZi5vcHRpb25zLnVybAogICAgICAgIGFyZ3NbJ2NvcHlyaWdodCddID0gc2VsZi5vcHRpb25zLmNvcHlyaWdodAoKICAgICAgICBzID0gciIiIjwhRE9DVFlQRSBodG1sIFBVQkxJQyAiLS8vVzNDLy9EVEQgWEhUTUwgMS4wIFN0cmljdC8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9UUi94aHRtbDEvRFREL3hodG1sMS1zdHJpY3QuZHRkIj4KICAgICAgICAgICAgPGh0bWwgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHhtbG5zOnY9InVybjpzY2hlbWFzLW1pY3Jvc29mdC1jb206dm1sIj4KICAgICAgICAgICAgICA8aGVhZD4KICAgICAgICAgICAgICAgIDx0aXRsZT4lKHRpdGxlKXM8L3RpdGxlPgogICAgICAgICAgICAgICAgPG1ldGEgaHR0cC1lcXVpdj0iY29udGVudC10eXBlIiBjb250ZW50PSJ0ZXh0L2h0bWw7IGNoYXJzZXQ9dXRmLTgiLz4KICAgICAgICAgICAgICAgIDxtZXRhIGh0dHAtZXF1aXY9J2ltYWdldG9vbGJhcicgY29udGVudD0nbm8nLz4KICAgICAgICAgICAgICAgIDxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+IHZcOioge2JlaGF2aW9yOnVybCgjZGVmYXVsdCNWTUwpO30KICAgICAgICAgICAgICAgICAgICBodG1sLCBib2R5IHsgb3ZlcmZsb3c6IGhpZGRlbjsgcGFkZGluZzogMDsgaGVpZ2h0OiAxMDAlJTsgd2lkdGg6IDEwMCUlOyBmb250LWZhbWlseTogJ0x1Y2lkYSBHcmFuZGUnLEdlbmV2YSxBcmlhbCxWZXJkYW5hLHNhbnMtc2VyaWY7IH0KICAgICAgICAgICAgICAgICAgICBib2R5IHsgbWFyZ2luOiAxMHB4OyBiYWNrZ3JvdW5kOiAjZmZmOyB9CiAgICAgICAgICAgICAgICAgICAgaDEgeyBtYXJnaW46IDA7IHBhZGRpbmc6IDZweDsgYm9yZGVyOjA7IGZvbnQtc2l6ZTogMjBwdDsgfQogICAgICAgICAgICAgICAgICAgICNoZWFkZXIgeyBoZWlnaHQ6IDQzcHg7IHBhZGRpbmc6IDA7IGJhY2tncm91bmQtY29sb3I6ICNlZWU7IGJvcmRlcjogMXB4IHNvbGlkICM4ODg7IH0KICAgICAgICAgICAgICAjc3ViaGVhZGVyIHsgaGVpZ2h0OiAxMnB4OyB0ZXh0LWFsaWduOiByaWdodDsgZm9udC1zaXplOiAxMHB4OyBjb2xvcjogIzU1NTt9CiAgICAgICAgICAgICAgI21hcCB7IGhlaWdodDogOTUlJTsgYm9yZGVyOiAxcHggc29saWQgIzg4ODsgfQogICAgICAgICAgPC9zdHlsZT4KICAgICAgICAgIDxzY3JpcHQgc3JjPSdodHRwOi8vbWFwcy5nb29nbGUuY29tL21hcHM/ZmlsZT1hcGkmYW1wO3Y9MiZhbXA7a2V5PSUoZ29vZ2xlbWFwc2tleSlzJz48L3NjcmlwdD4KICAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAvLzwhW0NEQVRBWwoKICAgICAgICAgIC8qCiAgICAgICAgICAgICAgICAgKiBDb25zdGFudHMgZm9yIGdpdmVuIG1hcAogICAgICAgICAgICAgICAgICogVE9ETzogcmVhZCBpdCBmcm9tIHRpbGVtYXByZXNvdXJjZS54bWwKICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgIHZhciBtYXBCb3VuZHMgPSBuZXcgR0xhdExuZ0JvdW5kcyhuZXcgR0xhdExuZyglKHNvdXRoKXMsICUod2VzdClzKSwgbmV3IEdMYXRMbmcoJShub3J0aClzLCAlKGVhc3QpcykpOwogICAgICAgICAgICAgICAgdmFyIG1hcE1pblpvb20gPSAlKG1pbnpvb20pczsKICAgICAgICAgICAgICAgIHZhciBtYXBNYXhab29tID0gJShtYXh6b29tKXM7CgogICAgICAgICAgICAgICAgdmFyIG9wYWNpdHkgPSAwLjc1OwogICAgICAgICAgICAgICAgdmFyIG1hcDsKICAgICAgICAgICAgICAgIHZhciBoeWJyaWRPdmVybGF5OwoKICAgICAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgICAgKiBDcmVhdGUgYSBDdXN0b20gT3BhY2l0eSBHQ29udHJvbAogICAgICAgICAgICAgICAgICogaHR0cDovL3d3dy5tYXB0aWxlci5vcmcvZ29vZ2xlLW1hcHMtb3ZlcmxheS1vcGFjaXR5LWNvbnRyb2wvCiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICB2YXIgQ1RyYW5zcGFyZW5jeUxFTkdUSCA9IDU4OwogICAgICAgICAgICAgICAgLy8gbWF4aW11bSB3aWR0aCB0aGF0IHRoZSBrbm9iIGNhbiBtb3ZlIChzbGlkZSB3aWR0aCBtaW51cyBrbm9iIHdpZHRoKQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIENUcmFuc3BhcmVuY3lDb250cm9sKCBvdmVybGF5ICkgewogICAgICAgICAgICAgICAgICAgIHRoaXMub3ZlcmxheSA9IG92ZXJsYXk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGFjaXR5ID0gb3ZlcmxheS5nZXRUaWxlTGF5ZXIoKS5nZXRPcGFjaXR5KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBDVHJhbnNwYXJlbmN5Q29udHJvbC5wcm90b3R5cGUgPSBuZXcgR0NvbnRyb2woKTsKCiAgICAgICAgICAgICAgICAvLyBUaGlzIGZ1bmN0aW9uIHBvc2l0aW9ucyB0aGUgc2xpZGVyIHRvIG1hdGNoIHRoZSBzcGVjaWZpZWQgb3BhY2l0eQogICAgICAgICAgICAgICAgQ1RyYW5zcGFyZW5jeUNvbnRyb2wucHJvdG90eXBlLnNldFNsaWRlciA9IGZ1bmN0aW9uKHBvcykgewogICAgICAgICAgICAgICAgICAgIHZhciBsZWZ0ID0gTWF0aC5yb3VuZCgoQ1RyYW5zcGFyZW5jeUxFTkdUSCpwb3MpKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNsaWRlLmxlZnQgPSBsZWZ0OwogICAgICAgICAgICAgICAgICAgIHRoaXMua25vYi5zdHlsZS5sZWZ0ID0gbGVmdCsicHgiOwogICAgICAgICAgICAgICAgICAgIHRoaXMua25vYi5zdHlsZS50b3AgPSAiMHB4IjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBUaGlzIGZ1bmN0aW9uIHJlYWRzIHRoZSBzbGlkZXIgYW5kIHNldHMgdGhlIG92ZXJsYXkgb3BhY2l0eSBsZXZlbAogICAgICAgICAgICAgICAgQ1RyYW5zcGFyZW5jeUNvbnRyb2wucHJvdG90eXBlLnNldE9wYWNpdHkgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAvLyBzZXQgdGhlIGdsb2JhbCB2YXJpYWJsZQogICAgICAgICAgICAgICAgICAgIG9wYWNpdHkgPSB0aGlzLnNsaWRlLmxlZnQvQ1RyYW5zcGFyZW5jeUxFTkdUSDsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1hcC5jbGVhck92ZXJsYXlzKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYXAuYWRkT3ZlcmxheSh0aGlzLm92ZXJsYXksIHsgelByaW9yaXR5OiAwIH0pOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm1hcC5nZXRDdXJyZW50TWFwVHlwZSgpID09IEdfSFlCUklEX01BUCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1hcC5hZGRPdmVybGF5KGh5YnJpZE92ZXJsYXkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBUaGlzIGdldHMgY2FsbGVkIGJ5IHRoZSBBUEkgd2hlbiBhZGRDb250cm9sKG5ldyBDVHJhbnNwYXJlbmN5Q29udHJvbCgpKQogICAgICAgICAgICAgICAgQ1RyYW5zcGFyZW5jeUNvbnRyb2wucHJvdG90eXBlLmluaXRpYWxpemUgPSBmdW5jdGlvbihtYXApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdGhhdD10aGlzOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWFwID0gbWFwOwoKICAgICAgICAgICAgICAgICAgICAvLyBJcyB0aGlzIE1TSUUsIGlmIHNvIHdlIG5lZWQgdG8gdXNlIEFscGhhSW1hZ2VMb2FkZXIKICAgICAgICAgICAgICAgICAgICB2YXIgYWdlbnQgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKChhZ2VudC5pbmRleE9mKCJtc2llIikgPiAtMSkgJiYgKGFnZW50LmluZGV4T2YoIm9wZXJhIikgPCAxKSl7dGhpcy5pZSA9IHRydWV9IGVsc2Uge3RoaXMuaWUgPSBmYWxzZX0KCiAgICAgICAgICAgICAgICAgICAgLy8gY3JlYXRlIHRoZSBiYWNrZ3JvdW5kIGdyYXBoaWMgYXMgYSA8ZGl2PiBjb250YWluaW5nIGFuIGltYWdlCiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5zdHlsZS53aWR0aD0iNzBweCI7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLnN0eWxlLmhlaWdodD0iMjFweCI7CgogICAgICAgICAgICAgICAgICAgIC8vIEhhbmRsZSB0cmFuc3BhcmVudCBQTkcgZmlsZXMgaW4gTVNJRQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmllKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgbG9hZGVyID0gImZpbHRlcjpwcm9naWQ6RFhJbWFnZVRyYW5zZm9ybS5NaWNyb3NvZnQuQWxwaGFJbWFnZUxvYWRlcihzcmM9J2h0dHA6Ly93d3cubWFwdGlsZXIub3JnL2ltZy9vcGFjaXR5LXNsaWRlci5wbmcnLCBzaXppbmdNZXRob2Q9J2Nyb3AnKTsiOwogICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLmlubmVySFRNTCA9ICc8ZGl2IHN0eWxlPSJoZWlnaHQ6MjFweDsgd2lkdGg6NzBweDsgJyArbG9hZGVyKyAnIiA+PC9kaXY+JzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLmlubmVySFRNTCA9ICc8ZGl2IHN0eWxlPSJoZWlnaHQ6MjFweDsgd2lkdGg6NzBweDsgYmFja2dyb3VuZC1pbWFnZTogdXJsKGh0dHA6Ly93d3cubWFwdGlsZXIub3JnL2ltZy9vcGFjaXR5LXNsaWRlci5wbmcpIiA+PC9kaXY+JzsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSB0aGUga25vYiBhcyBhIEdEcmFnZ2FibGVPYmplY3QKICAgICAgICAgICAgICAgICAgICAvLyBIYW5kbGUgdHJhbnNwYXJlbnQgUE5HIGZpbGVzIGluIE1TSUUKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pZSkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGxvYWRlciA9ICJwcm9naWQ6RFhJbWFnZVRyYW5zZm9ybS5NaWNyb3NvZnQuQWxwaGFJbWFnZUxvYWRlcihzcmM9J2h0dHA6Ly93d3cubWFwdGlsZXIub3JnL2ltZy9vcGFjaXR5LXNsaWRlci5wbmcnLCBzaXppbmdNZXRob2Q9J2Nyb3AnKTsiOwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5rbm9iID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmtub2Iuc3R5bGUuaGVpZ2h0PSIyMXB4IjsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMua25vYi5zdHlsZS53aWR0aD0iMTNweCI7CiAgICAgICAgICAgICAgICAgIHRoaXMua25vYi5zdHlsZS5vdmVyZmxvdz0iaGlkZGVuIjsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMua25vYl9pbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMua25vYl9pbWcuc3R5bGUuaGVpZ2h0PSIyMXB4IjsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMua25vYl9pbWcuc3R5bGUud2lkdGg9IjgzcHgiOwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5rbm9iX2ltZy5zdHlsZS5maWx0ZXI9bG9hZGVyOwogICAgICAgICAgICAgICAgICB0aGlzLmtub2JfaW1nLnN0eWxlLnBvc2l0aW9uPSJyZWxhdGl2ZSI7CiAgICAgICAgICAgICAgICAgIHRoaXMua25vYl9pbWcuc3R5bGUubGVmdD0iLTcwcHgiOwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5rbm9iLmFwcGVuZENoaWxkKHRoaXMua25vYl9pbWcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmtub2IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMua25vYi5zdHlsZS5oZWlnaHQ9IjIxcHgiOwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5rbm9iLnN0eWxlLndpZHRoPSIxM3B4IjsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMua25vYi5zdHlsZS5iYWNrZ3JvdW5kSW1hZ2U9InVybChodHRwOi8vd3d3Lm1hcHRpbGVyLm9yZy9pbWcvb3BhY2l0eS1zbGlkZXIucG5nKSI7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmtub2Iuc3R5bGUuYmFja2dyb3VuZFBvc2l0aW9uPSItNzBweCAwcHgiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy5rbm9iKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNsaWRlPW5ldyBHRHJhZ2dhYmxlT2JqZWN0KHRoaXMua25vYiwge2NvbnRhaW5lcjpjb250YWluZXJ9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNsaWRlLnNldERyYWdnYWJsZUN1cnNvcigncG9pbnRlcicpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2xpZGUuc2V0RHJhZ2dpbmdDdXJzb3IoJ3BvaW50ZXInKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGNvbnRhaW5lcjsKCiAgICAgICAgICAgICAgICAgICAgLy8gYXR0YWNoIHRoZSBjb250cm9sIHRvIHRoZSBtYXAKICAgICAgICAgICAgICAgICAgICBtYXAuZ2V0Q29udGFpbmVyKCkuYXBwZW5kQ2hpbGQoY29udGFpbmVyKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gaW5pdCBzbGlkZXIKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFNsaWRlcih0aGlzLm9wYWNpdHkpOwoKICAgICAgICAgICAgICAgICAgICAvLyBMaXN0ZW4gZm9yIHRoZSBzbGlkZXIgYmVpbmcgbW92ZWQgYW5kIHNldCB0aGUgb3BhY2l0eQogICAgICAgICAgICAgICAgICAgIEdFdmVudC5hZGRMaXN0ZW5lcih0aGlzLnNsaWRlLCAiZHJhZ2VuZCIsIGZ1bmN0aW9uKCkge3RoYXQuc2V0T3BhY2l0eSgpfSk7CiAgICAgICAgICAgICAgICAgICAgLy9HRXZlbnQuYWRkTGlzdGVuZXIodGhpcy5jb250YWluZXIsICJjbGljayIsIGZ1bmN0aW9uKCB4LCB5ICkgeyBhbGVydCh4LCB5KSB9KTsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgLy8gU2V0IHRoZSBkZWZhdWx0IHBvc2l0aW9uIGZvciB0aGUgY29udHJvbAogICAgICAgICAgICAgICAgICBDVHJhbnNwYXJlbmN5Q29udHJvbC5wcm90b3R5cGUuZ2V0RGVmYXVsdFBvc2l0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBHQ29udHJvbFBvc2l0aW9uKEdfQU5DSE9SX1RPUF9SSUdIVCwgbmV3IEdTaXplKDcsIDQ3KSk7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICogRnVsbC1zY3JlZW4gV2luZG93IFJlc2l6ZQogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0V2luZG93SGVpZ2h0KCkgewogICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLmlubmVySGVpZ2h0KSByZXR1cm4gc2VsZi5pbm5lckhlaWdodDsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0OwogICAgICAgICAgICAgICAgICAgIGlmIChkb2N1bWVudC5ib2R5KSByZXR1cm4gZG9jdW1lbnQuYm9keS5jbGllbnRIZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0V2luZG93V2lkdGgoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYuaW5uZXJXaWR0aCkgcmV0dXJuIHNlbGYuaW5uZXJXaWR0aDsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aDsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuYm9keSkgcmV0dXJuIGRvY3VtZW50LmJvZHkuY2xpZW50V2lkdGg7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVzaXplKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBtYXAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibWFwIik7CiAgICAgICAgICAgICAgICAgICAgdmFyIGhlYWRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJoZWFkZXIiKTsKICAgICAgICAgICAgICAgICAgICB2YXIgc3ViaGVhZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInN1YmhlYWRlciIpOwogICAgICAgICAgICAgICAgICAgIG1hcC5zdHlsZS5oZWlnaHQgPSAoZ2V0V2luZG93SGVpZ2h0KCktODApICsgInB4IjsKICAgICAgICAgICAgICAgICAgICBtYXAuc3R5bGUud2lkdGggPSAoZ2V0V2luZG93V2lkdGgoKS0yMCkgKyAicHgiOwogICAgICAgICAgICAgICAgICAgIGhlYWRlci5zdHlsZS53aWR0aCA9IChnZXRXaW5kb3dXaWR0aCgpLTIwKSArICJweCI7CiAgICAgICAgICAgICAgICAgICAgc3ViaGVhZGVyLnN0eWxlLndpZHRoID0gKGdldFdpbmRvd1dpZHRoKCktMjApICsgInB4IjsKICAgICAgICAgICAgICAgICAgICAvLyBtYXAuY2hlY2tSZXNpemUoKTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLyoKICAgICAgICAgICAgICAgICAqIE1haW4gbG9hZCBmdW5jdGlvbjoKICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGxvYWQoKSB7CgogICAgICAgICAgICAgICAgICAgaWYgKEdCcm93c2VySXNDb21wYXRpYmxlKCkpIHsKCiAgICAgICAgICAgICAgICAgICAgICAvLyBCdWcgaW4gdGhlIEdvb2dsZSBNYXBzOiBDb3B5cmlnaHQgZm9yIE92ZXJsYXkgaXMgbm90IGNvcnJlY3RseSBkaXNwbGF5ZWQKICAgICAgICAgICAgICAgICAgICAgIHZhciBnY3IgPSBHTWFwVHlwZS5wcm90b3R5cGUuZ2V0Q29weXJpZ2h0czsKICAgICAgICAgICAgICAgICAgICAgIEdNYXBUeXBlLnByb3RvdHlwZS5nZXRDb3B5cmlnaHRzID0gZnVuY3Rpb24oYm91bmRzLHpvb20pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWyIlKGNvcHlyaWdodClzIl0uY29uY2F0KGdjci5jYWxsKHRoaXMsYm91bmRzLHpvb20pKTsKICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICBtYXAgPSBuZXcgR01hcDIoIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJtYXAiKSwgeyBiYWNrZ3JvdW5kQ29sb3I6ICcjZmZmJyB9ICk7CgogICAgICAgICAgICAgICAgICAgICAgbWFwLmFkZE1hcFR5cGUoR19QSFlTSUNBTF9NQVApOwogICAgICAgICAgICAgICAgICAgICAgbWFwLnNldE1hcFR5cGUoR19QSFlTSUNBTF9NQVApOwoKICAgICAgICAgICAgICAgICAgICAgIG1hcC5zZXRDZW50ZXIoIG1hcEJvdW5kcy5nZXRDZW50ZXIoKSwgbWFwLmdldEJvdW5kc1pvb21MZXZlbCggbWFwQm91bmRzICkpOwoKICAgICAgICAgICAgICAgICAgICAgIGh5YnJpZE92ZXJsYXkgPSBuZXcgR1RpbGVMYXllck92ZXJsYXkoIEdfSFlCUklEX01BUC5nZXRUaWxlTGF5ZXJzKClbMV0gKTsKICAgICAgICAgICAgICAgICAgICAgIEdFdmVudC5hZGRMaXN0ZW5lcihtYXAsICJtYXB0eXBlY2hhbmdlZCIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWFwLmdldEN1cnJlbnRNYXBUeXBlKCkgPT0gR19IWUJSSURfTUFQKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXAuYWRkT3ZlcmxheShoeWJyaWRPdmVybGF5KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwLnJlbW92ZU92ZXJsYXkoaHlicmlkT3ZlcmxheSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0gKTsKCiAgICAgICAgICAgICAgICAgICAgICB2YXIgdGlsZWxheWVyID0gbmV3IEdUaWxlTGF5ZXIoR0NvcHlyaWdodENvbGxlY3Rpb24oJycpLCBtYXBNaW5ab29tLCBtYXBNYXhab29tKTsKICAgICAgICAgICAgICAgICAgICAgIHZhciBtZXJjYXRvciA9IG5ldyBHTWVyY2F0b3JQcm9qZWN0aW9uKG1hcE1heFpvb20rMSk7CiAgICAgICAgICAgICAgICAgICAgICB0aWxlbGF5ZXIuZ2V0VGlsZVVybCA9IGZ1bmN0aW9uKHRpbGUsem9vbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoem9vbSA8IG1hcE1pblpvb20pIHx8ICh6b29tID4gbWFwTWF4Wm9vbSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICJodHRwOi8vd3d3Lm1hcHRpbGVyLm9yZy9pbWcvbm9uZS5wbmciOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgeW1heCA9IDEgPDwgem9vbTsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgeSA9IHltYXggLSB0aWxlLnkgLTE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRpbGVCb3VuZHMgPSBuZXcgR0xhdExuZ0JvdW5kcygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVyY2F0b3IuZnJvbVBpeGVsVG9MYXRMbmcoIG5ldyBHUG9pbnQoICh0aWxlLngpKjI1NiwgKHRpbGUueSsxKSoyNTYgKSAsIHpvb20gKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVyY2F0b3IuZnJvbVBpeGVsVG9MYXRMbmcoIG5ldyBHUG9pbnQoICh0aWxlLngrMSkqMjU2LCAodGlsZS55KSoyNTYgKSAsIHpvb20gKQogICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hcEJvdW5kcy5pbnRlcnNlY3RzKHRpbGVCb3VuZHMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB6b29tKyIvIit0aWxlLngrIi8iK3krIi5wbmciOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAiaHR0cDovL3d3dy5tYXB0aWxlci5vcmcvaW1nL25vbmUucG5nIjsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAvLyBJRSA3LTogc3VwcG9ydCBmb3IgUE5HIGFscGhhIGNoYW5uZWwKICAgICAgICAgICAgICAgICAgICAgIC8vIFVuZm9ydHVuYXRlbHksIHRoZSBvcGFjaXR5IGZvciB3aG9sZSBvdmVybGF5IGlzIHRoZW4gbm90IGNoYW5nZWFibGUsIGVpdGhlciBvci4uLgogICAgICAgICAgICAgICAgICAgICAgdGlsZWxheWVyLmlzUG5nID0gZnVuY3Rpb24oKSB7IHJldHVybiB0cnVlO307CiAgICAgICAgICAgICAgICAgICAgICB0aWxlbGF5ZXIuZ2V0T3BhY2l0eSA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gb3BhY2l0eTsgfQoKICAgICAgICAgICAgICAgICAgICAgIG92ZXJsYXkgPSBuZXcgR1RpbGVMYXllck92ZXJsYXkoIHRpbGVsYXllciApOwogICAgICAgICAgICAgICAgICAgICAgbWFwLmFkZE92ZXJsYXkob3ZlcmxheSk7CgogICAgICAgICAgICAgICAgICAgICAgbWFwLmFkZENvbnRyb2wobmV3IEdMYXJnZU1hcENvbnRyb2woKSk7CiAgICAgICAgICAgICAgICAgICAgICBtYXAuYWRkQ29udHJvbChuZXcgR0hpZXJhcmNoaWNhbE1hcFR5cGVDb250cm9sKCkpOwogICAgICAgICAgICAgICAgICAgICAgbWFwLmFkZENvbnRyb2wobmV3IENUcmFuc3BhcmVuY3lDb250cm9sKCBvdmVybGF5ICkpOwogICAgICAgICIiIiAlIGFyZ3MgICAgIyBub3FhCiAgICAgICAgaWYgc2VsZi5rbWw6CiAgICAgICAgICAgIHMgKz0gIiIiCiAgICAgICAgICAgICAgICAgICAgICBtYXAuYWRkTWFwVHlwZShHX1NBVEVMTElURV8zRF9NQVApOwogICAgICAgICAgICAgICAgICAgICAgbWFwLmdldEVhcnRoSW5zdGFuY2UoZ2V0RWFydGhJbnN0YW5jZUNCKTsKICAgICAgICAiIiIKICAgICAgICBzICs9ICIiIgoKICAgICAgICAgICAgICAgICAgICAgIG1hcC5lbmFibGVDb250aW51b3VzWm9vbSgpOwogICAgICAgICAgICAgICAgICAgICAgbWFwLmVuYWJsZVNjcm9sbFdoZWVsWm9vbSgpOwoKICAgICAgICAgICAgICAgICAgICAgIG1hcC5zZXRNYXBUeXBlKEdfSFlCUklEX01BUCk7CiAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICByZXNpemUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAiIiIKICAgICAgICBpZiBzZWxmLmttbDoKICAgICAgICAgICAgcyArPSAiIiIKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGdldEVhcnRoSW5zdGFuY2VDQihvYmplY3QpIHsKICAgICAgICAgICAgICAgICAgIHZhciBnZSA9IG9iamVjdDsKCiAgICAgICAgICAgICAgICAgICBpZiAoZ2UpIHsKICAgICAgICAgICAgICAgICAgICAgICB2YXIgdXJsID0gZG9jdW1lbnQubG9jYXRpb24udG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICAgICB1cmwgPSB1cmwuc3Vic3RyKDAsdXJsLmxhc3RJbmRleE9mKCcvJykpKycvZG9jLmttbCc7CiAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxpbmsgPSBnZS5jcmVhdGVMaW5rKCIiKTsKICAgICAgICAgICAgICAgICAgICAgICBpZiAoIiUocHVibGlzaHVybClzIikgeyBsaW5rLnNldEhyZWYoIiUocHVibGlzaHVybClzL2RvYy5rbWwiKSB9CiAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7IGxpbmsuc2V0SHJlZih1cmwpIH07CiAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ldHdvcmtMaW5rID0gZ2UuY3JlYXRlTmV0d29ya0xpbmsoIiIpOwogICAgICAgICAgICAgICAgICAgICAgIG5ldHdvcmtMaW5rLnNldE5hbWUoIlRNUyBNYXAgT3ZlcmxheSIpOwogICAgICAgICAgICAgICAgICAgICAgIG5ldHdvcmtMaW5rLnNldEZseVRvVmlldyh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICBuZXR3b3JrTGluay5zZXRMaW5rKGxpbmspOwogICAgICAgICAgICAgICAgICAgICAgIGdlLmdldEZlYXR1cmVzKCkuYXBwZW5kQ2hpbGQobmV0d29ya0xpbmspOwogICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAvLyBhbGVydCgiWW91IHNob3VsZCBvcGVuIGEgS01MIGluIEdvb2dsZSBFYXJ0aCIpOwogICAgICAgICAgICAgICAgICAgICAgIC8vIGFkZCBkaXYgd2l0aCB0aGUgbGluayB0byBnZW5lcmF0ZWQgS01MLi4uIC0gbWF5YmUgSmF2YVNjcmlwdCByZWRpcmVjdCB0byB0aGUgVVJMIG9mIEtNTD8KICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAiIiIgJSBhcmdzICAgICMgbm9xYQogICAgICAgIHMgKz0gIiIiCiAgICAgICAgICAgICAgICBvbnJlc2l6ZT1mdW5jdGlvbigpeyByZXNpemUoKTsgfTsKCiAgICAgICAgICAgICAgICAvL11dPgogICAgICAgICAgICAgICAgPC9zY3JpcHQ+CiAgICAgICAgICAgICAgPC9oZWFkPgogICAgICAgICAgICAgIDxib2R5IG9ubG9hZD0ibG9hZCgpIj4KICAgICAgICAgICAgICAgICAgPGRpdiBpZD0iaGVhZGVyIj48aDE+JSh0aXRsZSlzPC9oMT48L2Rpdj4KICAgICAgICAgICAgICAgICAgPGRpdiBpZD0ic3ViaGVhZGVyIj5HZW5lcmF0ZWQgYnkgPGEgaHJlZj0iaHR0cDovL3d3dy5rbG9rYW4uY3ovcHJvamVjdHMvZ2RhbDJ0aWxlcy8iPkdEQUwyVGlsZXM8L2E+LCBDb3B5cmlnaHQgJmNvcHk7IDIwMDggPGEgaHJlZj0iaHR0cDovL3d3dy5rbG9rYW4uY3ovIj5LbG9rYW4gUGV0ciBQcmlkYWw8L2E+LCAgPGEgaHJlZj0iaHR0cDovL3d3dy5nZGFsLm9yZy8iPkdEQUw8L2E+ICZhbXA7IDxhIGhyZWY9Imh0dHA6Ly93d3cub3NnZW8ub3JnLyI+T1NHZW88L2E+IDxhIGhyZWY9Imh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vc29jLyI+R1NvQzwvYT4KICAgICAgICAgICAgPCEtLSBQTEVBU0UsIExFVCBUSElTIE5PVEUgQUJPVVQgQVVUSE9SIEFORCBQUk9KRUNUIFNPTUVXSEVSRSBPTiBZT1VSIFdFQlNJVEUsIE9SIEFUIExFQVNUIElOIFRIRSBDT01NRU5UIElOIEhUTUwuIFRIQU5LIFlPVSAtLT4KICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICA8ZGl2IGlkPSJtYXAiPjwvZGl2PgogICAgICAgICAgICAgIDwvYm9keT4KICAgICAgICAgICAgPC9odG1sPgogICAgICAgICIiIiAlIGFyZ3MgICAgIyBub3FhCgogICAgICAgIHJldHVybiBzCgogICAgZGVmIGdlbmVyYXRlX2xlYWZsZXQoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgVGVtcGxhdGUgZm9yIGxlYWZsZXQuaHRtbCBpbXBsZW1lbnRpbmcgb3ZlcmxheSBvZiB0aWxlcyBmb3IgJ21lcmNhdG9yJyBwcm9maWxlLgogICAgICAgIEl0IHJldHVybnMgZmlsbGVkIHN0cmluZy4gRXhwZWN0ZWQgdmFyaWFibGVzOgogICAgICAgIHRpdGxlLCBub3J0aCwgc291dGgsIGVhc3QsIHdlc3QsIG1pbnpvb20sIG1heHpvb20sIHRpbGVzaXplLCB0aWxlZm9ybWF0LCBwdWJsaXNodXJsCiAgICAgICAgIiIiCgogICAgICAgIGFyZ3MgPSB7fQogICAgICAgIGFyZ3NbJ3RpdGxlJ10gPSBzZWxmLm9wdGlvbnMudGl0bGUucmVwbGFjZSgnIicsICdcXCInKQogICAgICAgIGFyZ3NbJ2h0bWx0aXRsZSddID0gc2VsZi5vcHRpb25zLnRpdGxlCiAgICAgICAgYXJnc1snc291dGgnXSwgYXJnc1snd2VzdCddLCBhcmdzWydub3J0aCddLCBhcmdzWydlYXN0J10gPSBzZWxmLnN3bmUKICAgICAgICBhcmdzWydjZW50ZXJsb24nXSA9IChhcmdzWydub3J0aCddICsgYXJnc1snc291dGgnXSkgLyAyLgogICAgICAgIGFyZ3NbJ2NlbnRlcmxhdCddID0gKGFyZ3NbJ3dlc3QnXSArIGFyZ3NbJ2Vhc3QnXSkgLyAyLgogICAgICAgIGFyZ3NbJ21pbnpvb20nXSA9IHNlbGYudG1pbnoKICAgICAgICBhcmdzWydtYXh6b29tJ10gPSBzZWxmLnRtYXh6CiAgICAgICAgYXJnc1snYmVnaW56b29tJ10gPSBzZWxmLnRtYXh6CiAgICAgICAgYXJnc1sndGlsZXNpemUnXSA9IHNlbGYudGlsZXNpemUgICMgbm90IHVzZWQKICAgICAgICBhcmdzWyd0aWxlZm9ybWF0J10gPSBzZWxmLnRpbGVleHQKICAgICAgICBhcmdzWydwdWJsaXNodXJsJ10gPSBzZWxmLm9wdGlvbnMudXJsICAjIG5vdCB1c2VkCiAgICAgICAgYXJnc1snY29weXJpZ2h0J10gPSBzZWxmLm9wdGlvbnMuY29weXJpZ2h0LnJlcGxhY2UoJyInLCAnXFwiJykKCiAgICAgICAgcyA9ICIiIjwhRE9DVFlQRSBodG1sPgogICAgICAgIDxodG1sIGxhbmc9ImVuIj4KICAgICAgICAgIDxoZWFkPgogICAgICAgICAgICA8bWV0YSBjaGFyc2V0PSJ1dGYtOCI+CiAgICAgICAgICAgIDxtZXRhIG5hbWU9J3ZpZXdwb3J0JyBjb250ZW50PSd3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MS4wLCBtYXhpbXVtLXNjYWxlPTEuMCwgdXNlci1zY2FsYWJsZT1ubycgLz4KICAgICAgICAgICAgPHRpdGxlPiUoaHRtbHRpdGxlKXM8L3RpdGxlPgoKICAgICAgICAgICAgPCEtLSBMZWFmbGV0IC0tPgogICAgICAgICAgICA8bGluayByZWw9InN0eWxlc2hlZXQiIGhyZWY9Imh0dHA6Ly9jZG4ubGVhZmxldGpzLmNvbS9sZWFmbGV0LTAuNy41L2xlYWZsZXQuY3NzIiAvPgogICAgICAgICAgICA8c2NyaXB0IHNyYz0iaHR0cDovL2Nkbi5sZWFmbGV0anMuY29tL2xlYWZsZXQtMC43LjUvbGVhZmxldC5qcyI+PC9zY3JpcHQ+CgogICAgICAgICAgICA8c3R5bGU+CiAgICAgICAgICAgICAgICBib2R5IHsgbWFyZ2luOjA7IHBhZGRpbmc6MDsgfQogICAgICAgICAgICAgICAgYm9keSwgdGFibGUsIHRyLCB0ZCwgdGgsIGRpdiwgaDEsIGgyLCBpbnB1dCB7IGZvbnQtZmFtaWx5OiAiQ2FsaWJyaSIsICJUcmVidWNoZXQgTVMiLCAiVWJ1bnR1IiwgU2VyaWY7IGZvbnQtc2l6ZTogMTFwdDsgfQogICAgICAgICAgICAgICAgI21hcCB7IHBvc2l0aW9uOmFic29sdXRlOyB0b3A6MDsgYm90dG9tOjA7IHdpZHRoOjEwMCUlOyB9IC8qIGZ1bGwgc2l6ZSAqLwogICAgICAgICAgICAgICAgLmN0bCB7CiAgICAgICAgICAgICAgICAgICAgcGFkZGluZzogMnB4IDEwcHggMnB4IDEwcHg7CiAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7CiAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogcmdiYSgyNTUsMjU1LDI1NSwwLjkpOwogICAgICAgICAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMCAxNXB4IHJnYmEoMCwwLDAsMC4yKTsKICAgICAgICAgICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1cHg7CiAgICAgICAgICAgICAgICAgICAgdGV4dC1hbGlnbjogcmlnaHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAudGl0bGUgewogICAgICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogMThwdDsKICAgICAgICAgICAgICAgICAgICBmb250LXdlaWdodDogYm9sZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5zcmMgewogICAgICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogMTBwdDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIDwvc3R5bGU+CgogICAgICAgIDwvaGVhZD4KICAgICAgICA8Ym9keT4KCiAgICAgICAgPGRpdiBpZD0ibWFwIj48L2Rpdj4KCiAgICAgICAgPHNjcmlwdD4KICAgICAgICAvKiAqKioqIExlYWZsZXQgKioqKiAqLwoKICAgICAgICAvLyBCYXNlIGxheWVycwogICAgICAgIC8vICAuLiBPcGVuU3RyZWV0TWFwCiAgICAgICAgdmFyIG9zbSA9IEwudGlsZUxheWVyKCdodHRwOi8ve3N9LnRpbGUub3NtLm9yZy97en0ve3h9L3t5fS5wbmcnLCB7YXR0cmlidXRpb246ICcmY29weTsgPGEgaHJlZj0iaHR0cDovL29zbS5vcmcvY29weXJpZ2h0Ij5PcGVuU3RyZWV0TWFwPC9hPiBjb250cmlidXRvcnMnfSk7CgogICAgICAgIC8vICAuLiBDYXJ0b0RCIFBvc2l0cm9uCiAgICAgICAgdmFyIGNhcnRvZGIgPSBMLnRpbGVMYXllcignaHR0cDovL3tzfS5iYXNlbWFwcy5jYXJ0b2Nkbi5jb20vbGlnaHRfYWxsL3t6fS97eH0ve3l9LnBuZycsIHthdHRyaWJ1dGlvbjogJyZjb3B5OyA8YSBocmVmPSJodHRwOi8vd3d3Lm9wZW5zdHJlZXRtYXAub3JnL2NvcHlyaWdodCI+T3BlblN0cmVldE1hcDwvYT4gY29udHJpYnV0b3JzLCAmY29weTsgPGEgaHJlZj0iaHR0cDovL2NhcnRvZGIuY29tL2F0dHJpYnV0aW9ucyI+Q2FydG9EQjwvYT4nfSk7CgogICAgICAgIC8vICAuLiBPU00gVG9uZXIKICAgICAgICB2YXIgdG9uZXIgPSBMLnRpbGVMYXllcignaHR0cDovL3tzfS50aWxlLnN0YW1lbi5jb20vdG9uZXIve3p9L3t4fS97eX0ucG5nJywge2F0dHJpYnV0aW9uOiAnTWFwIHRpbGVzIGJ5IDxhIGhyZWY9Imh0dHA6Ly9zdGFtZW4uY29tIj5TdGFtZW4gRGVzaWduPC9hPiwgdW5kZXIgPGEgaHJlZj0iaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbGljZW5zZXMvYnkvMy4wIj5DQyBCWSAzLjA8L2E+LiBEYXRhIGJ5IDxhIGhyZWY9Imh0dHA6Ly9vcGVuc3RyZWV0bWFwLm9yZyI+T3BlblN0cmVldE1hcDwvYT4sIHVuZGVyIDxhIGhyZWY9Imh0dHA6Ly93d3cub3BlbnN0cmVldG1hcC5vcmcvY29weXJpZ2h0Ij5PRGJMPC9hPi4nfSk7CgogICAgICAgIC8vICAuLiBXaGl0ZSBiYWNrZ3JvdW5kCiAgICAgICAgdmFyIHdoaXRlID0gTC50aWxlTGF5ZXIoImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBUUFBQUFFQUFRTUFBQUJtdkRvbEFBQUFBMUJNVkVYLy8vK254QnZJQUFBQUgwbEVRVlFZR2UzQkFRMEFBQURDSVB1bmZnNDNZQUFBQUFBQUFBQUE1d0loQUFBQjlhSzlCQUFBQUFCSlJVNUVya0pnZ2c9PSIpOwoKICAgICAgICAvLyBPdmVybGF5IGxheWVycyAoVE1TKQogICAgICAgIHZhciBseXIgPSBMLnRpbGVMYXllcignLi97en0ve3h9L3t5fS4lKHRpbGVmb3JtYXQpcycsIHt0bXM6IHRydWUsIG9wYWNpdHk6IDAuNywgYXR0cmlidXRpb246ICIlKGNvcHlyaWdodClzIn0pOwoKICAgICAgICAvLyBNYXAKICAgICAgICB2YXIgbWFwID0gTC5tYXAoJ21hcCcsIHsKICAgICAgICAgICAgY2VudGVyOiBbJShjZW50ZXJsb24pcywgJShjZW50ZXJsYXQpc10sCiAgICAgICAgICAgIHpvb206ICUoYmVnaW56b29tKXMsCiAgICAgICAgICAgIG1pblpvb206ICUobWluem9vbSlzLAogICAgICAgICAgICBtYXhab29tOiAlKG1heHpvb20pcywKICAgICAgICAgICAgbGF5ZXJzOiBbb3NtXQogICAgICAgIH0pOwoKICAgICAgICB2YXIgYmFzZW1hcHMgPSB7Ik9wZW5TdHJlZXRNYXAiOiBvc20sICJDYXJ0b0RCIFBvc2l0cm9uIjogY2FydG9kYiwgIlN0YW1lbiBUb25lciI6IHRvbmVyLCAiV2l0aG91dCBiYWNrZ3JvdW5kIjogd2hpdGV9CiAgICAgICAgdmFyIG92ZXJsYXltYXBzID0geyJMYXllciI6IGx5cn0KCiAgICAgICAgLy8gVGl0bGUKICAgICAgICB2YXIgdGl0bGUgPSBMLmNvbnRyb2woKTsKICAgICAgICB0aXRsZS5vbkFkZCA9IGZ1bmN0aW9uKG1hcCkgewogICAgICAgICAgICB0aGlzLl9kaXYgPSBMLkRvbVV0aWwuY3JlYXRlKCdkaXYnLCAnY3RsIHRpdGxlJyk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlKCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9kaXY7CiAgICAgICAgfTsKICAgICAgICB0aXRsZS51cGRhdGUgPSBmdW5jdGlvbihwcm9wcykgewogICAgICAgICAgICB0aGlzLl9kaXYuaW5uZXJIVE1MID0gIiUodGl0bGUpcyI7CiAgICAgICAgfTsKICAgICAgICB0aXRsZS5hZGRUbyhtYXApOwoKICAgICAgICAvLyBOb3RlCiAgICAgICAgdmFyIHNyYyA9ICdHZW5lcmF0ZWQgYnkgPGEgaHJlZj0iaHR0cDovL3d3dy5rbG9rYW4uY3ovcHJvamVjdHMvZ2RhbDJ0aWxlcy8iPkdEQUwyVGlsZXM8L2E+LCBDb3B5cmlnaHQgJmNvcHk7IDIwMDggPGEgaHJlZj0iaHR0cDovL3d3dy5rbG9rYW4uY3ovIj5LbG9rYW4gUGV0ciBQcmlkYWw8L2E+LCAgPGEgaHJlZj0iaHR0cDovL3d3dy5nZGFsLm9yZy8iPkdEQUw8L2E+ICZhbXA7IDxhIGhyZWY9Imh0dHA6Ly93d3cub3NnZW8ub3JnLyI+T1NHZW88L2E+IDxhIGhyZWY9Imh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vc29jLyI+R1NvQzwvYT4nOwogICAgICAgIHZhciB0aXRsZSA9IEwuY29udHJvbCh7cG9zaXRpb246ICdib3R0b21sZWZ0J30pOwogICAgICAgIHRpdGxlLm9uQWRkID0gZnVuY3Rpb24obWFwKSB7CiAgICAgICAgICAgIHRoaXMuX2RpdiA9IEwuRG9tVXRpbC5jcmVhdGUoJ2RpdicsICdjdGwgc3JjJyk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlKCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9kaXY7CiAgICAgICAgfTsKICAgICAgICB0aXRsZS51cGRhdGUgPSBmdW5jdGlvbihwcm9wcykgewogICAgICAgICAgICB0aGlzLl9kaXYuaW5uZXJIVE1MID0gc3JjOwogICAgICAgIH07CiAgICAgICAgdGl0bGUuYWRkVG8obWFwKTsKCgogICAgICAgIC8vIEFkZCBiYXNlIGxheWVycwogICAgICAgIEwuY29udHJvbC5sYXllcnMoYmFzZW1hcHMsIG92ZXJsYXltYXBzLCB7Y29sbGFwc2VkOiBmYWxzZX0pLmFkZFRvKG1hcCk7CgogICAgICAgIC8vIEZpdCB0byBvdmVybGF5IGJvdW5kcyAoU1cgYW5kIE5FIHBvaW50cyB3aXRoIChsYXQsIGxvbikpCiAgICAgICAgbWFwLmZpdEJvdW5kcyhbWyUoc291dGgpcywgJShlYXN0KXNdLCBbJShub3J0aClzLCAlKHdlc3Qpc11dKTsKCiAgICAgICAgPC9zY3JpcHQ+CgogICAgICAgIDwvYm9keT4KICAgICAgICA8L2h0bWw+CgogICAgICAgICIiIiAlIGFyZ3MgICAgIyBub3FhCgogICAgICAgIHJldHVybiBzCgogICAgZGVmIGdlbmVyYXRlX29wZW5sYXllcnMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgVGVtcGxhdGUgZm9yIG9wZW5sYXllcnMuaHRtbCBpbXBsZW1lbnRpbmcgb3ZlcmxheSBvZiBhdmFpbGFibGUgU3BoZXJpY2FsIE1lcmNhdG9yIGxheWVycy4KCiAgICAgICAgSXQgcmV0dXJucyBmaWxsZWQgc3RyaW5nLiBFeHBlY3RlZCB2YXJpYWJsZXM6CiAgICAgICAgdGl0bGUsIGJpbmdrZXksIG5vcnRoLCBzb3V0aCwgZWFzdCwgd2VzdCwgbWluem9vbSwgbWF4em9vbSwgdGlsZXNpemUsIHRpbGVmb3JtYXQsIHB1Ymxpc2h1cmwKICAgICAgICAiIiIKCiAgICAgICAgYXJncyA9IHt9CiAgICAgICAgYXJnc1sndGl0bGUnXSA9IHNlbGYub3B0aW9ucy50aXRsZQogICAgICAgIGFyZ3NbJ2JpbmdrZXknXSA9IHNlbGYub3B0aW9ucy5iaW5na2V5CiAgICAgICAgYXJnc1snc291dGgnXSwgYXJnc1snd2VzdCddLCBhcmdzWydub3J0aCddLCBhcmdzWydlYXN0J10gPSBzZWxmLnN3bmUKICAgICAgICBhcmdzWydtaW56b29tJ10gPSBzZWxmLnRtaW56CiAgICAgICAgYXJnc1snbWF4em9vbSddID0gc2VsZi50bWF4egogICAgICAgIGFyZ3NbJ3RpbGVzaXplJ10gPSBzZWxmLnRpbGVzaXplCiAgICAgICAgYXJnc1sndGlsZWZvcm1hdCddID0gc2VsZi50aWxlZXh0CiAgICAgICAgYXJnc1sncHVibGlzaHVybCddID0gc2VsZi5vcHRpb25zLnVybAogICAgICAgIGFyZ3NbJ2NvcHlyaWdodCddID0gc2VsZi5vcHRpb25zLmNvcHlyaWdodAogICAgICAgIGlmIHNlbGYub3B0aW9ucy50bXNjb21wYXRpYmxlOgogICAgICAgICAgICBhcmdzWyd0bXNvZmZzZXQnXSA9ICItMSIKICAgICAgICBlbHNlOgogICAgICAgICAgICBhcmdzWyd0bXNvZmZzZXQnXSA9ICIiCiAgICAgICAgaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ3Jhc3Rlcic6CiAgICAgICAgICAgIGFyZ3NbJ3Jhc3Rlcnpvb21sZXZlbHMnXSA9IHNlbGYudG1heHorMQogICAgICAgICAgICBhcmdzWydyYXN0ZXJtYXhyZXNvbHV0aW9uJ10gPSAyKiooc2VsZi5uYXRpdmV6b29tKSAqIHNlbGYub3V0X2d0WzFdCgogICAgICAgIHMgPSByIiIiPCFET0NUWVBFIGh0bWwgUFVCTElDICItLy9XM0MvL0RURCBYSFRNTCAxLjAgU3RyaWN0Ly9FTiIgImh0dHA6Ly93d3cudzMub3JnL1RSL3hodG1sMS9EVEQveGh0bWwxLXN0cmljdC5kdGQiPgogICAgICAgIDxodG1sIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIgogICAgICAgICAgPGhlYWQ+CiAgICAgICAgICAgIDx0aXRsZT4lKHRpdGxlKXM8L3RpdGxlPgogICAgICAgICAgICA8bWV0YSBodHRwLWVxdWl2PSdpbWFnZXRvb2xiYXInIGNvbnRlbnQ9J25vJy8+CiAgICAgICAgICAgIDxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+IHZcOioge2JlaGF2aW9yOnVybCgjZGVmYXVsdCNWTUwpO30KICAgICAgICAgICAgICAgIGh0bWwsIGJvZHkgeyBvdmVyZmxvdzogaGlkZGVuOyBwYWRkaW5nOiAwOyBoZWlnaHQ6IDEwMCUlOyB3aWR0aDogMTAwJSU7IGZvbnQtZmFtaWx5OiAnTHVjaWRhIEdyYW5kZScsR2VuZXZhLEFyaWFsLFZlcmRhbmEsc2Fucy1zZXJpZjsgfQogICAgICAgICAgICAgICAgYm9keSB7IG1hcmdpbjogMTBweDsgYmFja2dyb3VuZDogI2ZmZjsgfQogICAgICAgICAgICAgICAgaDEgeyBtYXJnaW46IDA7IHBhZGRpbmc6IDZweDsgYm9yZGVyOjA7IGZvbnQtc2l6ZTogMjBwdDsgfQogICAgICAgICAgICAjaGVhZGVyIHsgaGVpZ2h0OiA0M3B4OyBwYWRkaW5nOiAwOyBiYWNrZ3JvdW5kLWNvbG9yOiAjZWVlOyBib3JkZXI6IDFweCBzb2xpZCAjODg4OyB9CiAgICAgICAgICAgICNzdWJoZWFkZXIgeyBoZWlnaHQ6IDEycHg7IHRleHQtYWxpZ246IHJpZ2h0OyBmb250LXNpemU6IDEwcHg7IGNvbG9yOiAjNTU1O30KICAgICAgICAgICAgI21hcCB7IGhlaWdodDogOTUlJTsgYm9yZGVyOiAxcHggc29saWQgIzg4ODsgfQogICAgICAgICAgICAub2xJbWFnZUxvYWRFcnJvciB7IGRpc3BsYXk6IG5vbmU7IH0KICAgICAgICAgICAgLm9sQ29udHJvbExheWVyU3dpdGNoZXIgLmxheWVyc0RpdiB7IGJvcmRlci1yYWRpdXM6IDEwcHggMCAwIDEwcHg7IH0KICAgICAgICA8L3N0eWxlPiIiIiAlIGFyZ3MgICAgIyBub3FhCgogICAgICAgIGlmIHNlbGYub3B0aW9ucy5wcm9maWxlID09ICdtZXJjYXRvcic6CiAgICAgICAgICAgIHMgKz0gIiIiCiAgICAgICAgICAgIDxzY3JpcHQgc3JjPSdodHRwOi8vbWFwcy5nb29nbGUuY29tL21hcHMvYXBpL2pzP3NlbnNvcj1mYWxzZSZ2PTMuNyc+PC9zY3JpcHQ+CiAgICAgICAgICAgICIiIiAlIGFyZ3MKCiAgICAgICAgcyArPSAiIiIKICAgICAgICAgICAgPHNjcmlwdCBzcmM9Imh0dHA6Ly93d3cub3BlbmxheWVycy5vcmcvYXBpLzIuMTIvT3BlbkxheWVycy5qcyI+PC9zY3JpcHQ+CiAgICAgICAgICAgIDxzY3JpcHQ+CiAgICAgICAgICAgICAgdmFyIG1hcDsKICAgICAgICAgICAgICB2YXIgbWFwQm91bmRzID0gbmV3IE9wZW5MYXllcnMuQm91bmRzKCAlKHdlc3QpcywgJShzb3V0aClzLCAlKGVhc3QpcywgJShub3J0aClzKTsKICAgICAgICAgICAgICB2YXIgbWFwTWluWm9vbSA9ICUobWluem9vbSlzOwogICAgICAgICAgICAgIHZhciBtYXBNYXhab29tID0gJShtYXh6b29tKXM7CiAgICAgICAgICAgICAgdmFyIGVtcHR5VGlsZVVSTCA9ICJodHRwOi8vd3d3Lm1hcHRpbGVyLm9yZy9pbWcvbm9uZS5wbmciOwogICAgICAgICAgICAgIE9wZW5MYXllcnMuSU1BR0VfUkVMT0FEX0FUVEVNUFRTID0gMzsKCiAgICAgICAgICAgICAgZnVuY3Rpb24gaW5pdCgpeyIiIiAlIGFyZ3MKCiAgICAgICAgaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ21lcmNhdG9yJzoKICAgICAgICAgICAgcyArPSAiIiIKICAgICAgICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgICAgICAgICAgICAgICAgICBkaXY6ICJtYXAiLAogICAgICAgICAgICAgICAgICAgICAgY29udHJvbHM6IFtdLAogICAgICAgICAgICAgICAgICAgICAgcHJvamVjdGlvbjogIkVQU0c6Mzg1NyIsCiAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5UHJvamVjdGlvbjogbmV3IE9wZW5MYXllcnMuUHJvamVjdGlvbigiRVBTRzo0MzI2IiksCiAgICAgICAgICAgICAgICAgICAgICBudW1ab29tTGV2ZWxzOiAyMAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBtYXAgPSBuZXcgT3BlbkxheWVycy5NYXAob3B0aW9ucyk7CgogICAgICAgICAgICAgICAgICAvLyBDcmVhdGUgR29vZ2xlIE1lcmNhdG9yIGxheWVycwogICAgICAgICAgICAgICAgICB2YXIgZ21hcCA9IG5ldyBPcGVuTGF5ZXJzLkxheWVyLkdvb2dsZSgiR29vZ2xlIFN0cmVldHMiLAogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBnb29nbGUubWFwcy5NYXBUeXBlSWQuUk9BRE1BUCwKICAgICAgICAgICAgICAgICAgICAgIHNwaGVyaWNhbE1lcmNhdG9yOiB0cnVlCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB2YXIgZ3NhdCA9IG5ldyBPcGVuTGF5ZXJzLkxheWVyLkdvb2dsZSgiR29vZ2xlIFNhdGVsbGl0ZSIsCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IGdvb2dsZS5tYXBzLk1hcFR5cGVJZC5TQVRFTExJVEUsCiAgICAgICAgICAgICAgICAgICAgICBzcGhlcmljYWxNZXJjYXRvcjogdHJ1ZQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgdmFyIGdoeWIgPSBuZXcgT3BlbkxheWVycy5MYXllci5Hb29nbGUoIkdvb2dsZSBIeWJyaWQiLAogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBnb29nbGUubWFwcy5NYXBUeXBlSWQuSFlCUklELAogICAgICAgICAgICAgICAgICAgICAgc3BoZXJpY2FsTWVyY2F0b3I6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHZhciBndGVyID0gbmV3IE9wZW5MYXllcnMuTGF5ZXIuR29vZ2xlKCJHb29nbGUgVGVycmFpbiIsCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IGdvb2dsZS5tYXBzLk1hcFR5cGVJZC5URVJSQUlOLAogICAgICAgICAgICAgICAgICAgICAgc3BoZXJpY2FsTWVyY2F0b3I6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAvLyBDcmVhdGUgQmluZyBsYXllcnMKICAgICAgICAgICAgICAgICAgdmFyIGJyb2FkID0gbmV3IE9wZW5MYXllcnMuTGF5ZXIuQmluZyh7CiAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAiQmluZyBSb2FkcyIsCiAgICAgICAgICAgICAgICAgICAgICBrZXk6ICIlKGJpbmdrZXkpcyIsCiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAiUm9hZCIsCiAgICAgICAgICAgICAgICAgICAgICBzcGhlcmljYWxNZXJjYXRvcjogdHJ1ZQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgdmFyIGJhZXIgPSBuZXcgT3BlbkxheWVycy5MYXllci5CaW5nKHsKICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICJCaW5nIEFlcmlhbCIsCiAgICAgICAgICAgICAgICAgICAgICBrZXk6ICIlKGJpbmdrZXkpcyIsCiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAiQWVyaWFsIiwKICAgICAgICAgICAgICAgICAgICAgIHNwaGVyaWNhbE1lcmNhdG9yOiB0cnVlCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB2YXIgYmh5YiA9IG5ldyBPcGVuTGF5ZXJzLkxheWVyLkJpbmcoewogICAgICAgICAgICAgICAgICAgICAgbmFtZTogIkJpbmcgSHlicmlkIiwKICAgICAgICAgICAgICAgICAgICAgIGtleTogIiUoYmluZ2tleSlzIiwKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJBZXJpYWxXaXRoTGFiZWxzIiwKICAgICAgICAgICAgICAgICAgICAgIHNwaGVyaWNhbE1lcmNhdG9yOiB0cnVlCiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgLy8gQ3JlYXRlIE9TTSBsYXllcgogICAgICAgICAgICAgICAgICB2YXIgb3NtID0gbmV3IE9wZW5MYXllcnMuTGF5ZXIuT1NNKCJPcGVuU3RyZWV0TWFwIik7CgogICAgICAgICAgIiIiICUgYXJncyAgICAjIG5vcWEKCQkgIAogICAgICAgICAgICBpZiBzZWxmLm9wdGlvbnMueHl6OgogICAgICAgICAgICAgICAgcyArPSAiIiIJCSAgCiAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBUTVMgT3ZlcmxheSBsYXllcgogICAgICAgICAgICAgICAgICAgdmFyIHRtc292ZXJsYXkgPSBuZXcgT3BlbkxheWVycy5MYXllci5YWVooIlhZWiBPdmVybGF5IiwKICAgICAgICAgICAgICAgICAgICAgICIke3p9LyR7eH0vJHt5fS5wbmciLCB7CiAgICAgICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uRWZmZWN0OiAncmVzaXplJywKICAgICAgICAgICAgICAgICAgICAgIGlzQmFzZUxheWVyOiBmYWxzZQogICAgICAgICAgICAgICAgICB9KTsKCQkJCSAgCgkJICAgICAgICAiIiIgJSBhcmdzICAgICMgbm9xYQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcyArPSAiIiIJCSAgCiAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBUTVMgT3ZlcmxheSBsYXllcgogICAgICAgICAgICAgICAgICAgdmFyIHRtc292ZXJsYXkgPSBuZXcgT3BlbkxheWVycy5MYXllci5UTVMoIlRNUyBPdmVybGF5IiwgIiIsCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIHNlcnZpY2VWZXJzaW9uOiAnLicsCiAgICAgICAgICAgICAgICAgICAgICBsYXllcm5hbWU6ICcuJywKICAgICAgICAgICAgICAgICAgICAgIGFscGhhOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgdHlwZTogJyUodGlsZWZvcm1hdClzJywKICAgICAgICAgICAgICAgICAgICAgIGlzQmFzZUxheWVyOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgIGdldFVSTDogZ2V0VVJMCiAgICAgICAgICAgICAgICAgIH0pOwoJCQkJICAKCQkgICAgICAgICIiIiAlIGFyZ3MgICAgIyBub3FhCQkgIAoJCSAgCiAgICAgICAgICAgIHMgKz0gIiIiICAKICAgICAgICAgICAgICAgICAgaWYgKE9wZW5MYXllcnMuVXRpbC5hbHBoYUhhY2soKSA9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgdG1zb3ZlcmxheS5zZXRPcGFjaXR5KDAuNyk7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIG1hcC5hZGRMYXllcnMoW2dtYXAsIGdzYXQsIGdoeWIsIGd0ZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyb2FkLCBiYWVyLCBiaHliLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvc20sIHRtc292ZXJsYXldKTsKCiAgICAgICAgICAgICAgICAgIHZhciBzd2l0Y2hlckNvbnRyb2wgPSBuZXcgT3BlbkxheWVycy5Db250cm9sLkxheWVyU3dpdGNoZXIoKTsKICAgICAgICAgICAgICAgICAgbWFwLmFkZENvbnRyb2woc3dpdGNoZXJDb250cm9sKTsKICAgICAgICAgICAgICAgICAgc3dpdGNoZXJDb250cm9sLm1heGltaXplQ29udHJvbCgpOwoKICAgICAgICAgICAgICAgICAgbWFwLnpvb21Ub0V4dGVudChtYXBCb3VuZHMudHJhbnNmb3JtKG1hcC5kaXNwbGF5UHJvamVjdGlvbiwgbWFwLnByb2plY3Rpb24pKTsKICAgICAgICAgICIiIiAlIGFyZ3MgICAgIyBub3FhCgogICAgICAgIGVsaWYgc2VsZi5vcHRpb25zLnByb2ZpbGUgPT0gJ2dlb2RldGljJzoKICAgICAgICAgICAgcyArPSAiIiIKICAgICAgICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgICAgICAgICAgICAgICAgICBkaXY6ICJtYXAiLAogICAgICAgICAgICAgICAgICAgICAgY29udHJvbHM6IFtdLAogICAgICAgICAgICAgICAgICAgICAgcHJvamVjdGlvbjogIkVQU0c6NDMyNiIKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgbWFwID0gbmV3IE9wZW5MYXllcnMuTWFwKG9wdGlvbnMpOwoKICAgICAgICAgICAgICAgICAgdmFyIHdtcyA9IG5ldyBPcGVuTGF5ZXJzLkxheWVyLldNUygiVk1hcDAiLAogICAgICAgICAgICAgICAgICAgICAgImh0dHA6Ly90aWxlY2FjaGUub3NnZW8ub3JnL3dtcy1jL0Jhc2ljLnB5PyIsCiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbGF5ZXJzOiAnYmFzaWMnLAogICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdDogJ2ltYWdlL3BuZycKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgdmFyIHRtc292ZXJsYXkgPSBuZXcgT3BlbkxheWVycy5MYXllci5UTVMoIlRNUyBPdmVybGF5IiwgIiIsCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIHNlcnZpY2VWZXJzaW9uOiAnLicsCiAgICAgICAgICAgICAgICAgICAgICBsYXllcm5hbWU6ICcuJywKICAgICAgICAgICAgICAgICAgICAgIGFscGhhOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgdHlwZTogJyUodGlsZWZvcm1hdClzJywKICAgICAgICAgICAgICAgICAgICAgIGlzQmFzZUxheWVyOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgIGdldFVSTDogZ2V0VVJMCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICBpZiAoT3BlbkxheWVycy5VdGlsLmFscGhhSGFjaygpID09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICB0bXNvdmVybGF5LnNldE9wYWNpdHkoMC43KTsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgbWFwLmFkZExheWVycyhbd21zLHRtc292ZXJsYXldKTsKCiAgICAgICAgICAgICAgICAgIHZhciBzd2l0Y2hlckNvbnRyb2wgPSBuZXcgT3BlbkxheWVycy5Db250cm9sLkxheWVyU3dpdGNoZXIoKTsKICAgICAgICAgICAgICAgICAgbWFwLmFkZENvbnRyb2woc3dpdGNoZXJDb250cm9sKTsKICAgICAgICAgICAgICAgICAgc3dpdGNoZXJDb250cm9sLm1heGltaXplQ29udHJvbCgpOwoKICAgICAgICAgICAgICAgICAgbWFwLnpvb21Ub0V4dGVudChtYXBCb3VuZHMpOwogICAgICAgICAgICIiIiAlIGFyZ3MgICAjIG5vcWEKCiAgICAgICAgZWxpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAncmFzdGVyJzoKICAgICAgICAgICAgcyArPSAiIiIKICAgICAgICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgICAgICAgICAgICAgICAgICBkaXY6ICJtYXAiLAogICAgICAgICAgICAgICAgICAgICAgY29udHJvbHM6IFtdLAogICAgICAgICAgICAgICAgICAgICAgbWF4RXh0ZW50OiBuZXcgT3BlbkxheWVycy5Cb3VuZHMoJSh3ZXN0KXMsICUoc291dGgpcywgJShlYXN0KXMsICUobm9ydGgpcyksCiAgICAgICAgICAgICAgICAgICAgICBtYXhSZXNvbHV0aW9uOiAlKHJhc3Rlcm1heHJlc29sdXRpb24pZiwKICAgICAgICAgICAgICAgICAgICAgIG51bVpvb21MZXZlbHM6ICUocmFzdGVyem9vbWxldmVscylkCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIG1hcCA9IG5ldyBPcGVuTGF5ZXJzLk1hcChvcHRpb25zKTsKCiAgICAgICAgICAgICAgICAgIHZhciBsYXllciA9IG5ldyBPcGVuTGF5ZXJzLkxheWVyLlRNUygiVE1TIExheWVyIiwgIiIsCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIHNlcnZpY2VWZXJzaW9uOiAnLicsCiAgICAgICAgICAgICAgICAgICAgICBsYXllcm5hbWU6ICcuJywKICAgICAgICAgICAgICAgICAgICAgIGFscGhhOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgdHlwZTogJyUodGlsZWZvcm1hdClzJywKICAgICAgICAgICAgICAgICAgICAgIGdldFVSTDogZ2V0VVJMCiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgbWFwLmFkZExheWVyKGxheWVyKTsKICAgICAgICAgICAgICAgICAgbWFwLnpvb21Ub0V4dGVudChtYXBCb3VuZHMpOwogICAgICAgICIiIiAlIGFyZ3MgICAgIyBub3FhCgogICAgICAgIHMgKz0gIiIiCiAgICAgICAgICAgICAgICAgIG1hcC5hZGRDb250cm9scyhbbmV3IE9wZW5MYXllcnMuQ29udHJvbC5QYW5ab29tQmFyKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3IE9wZW5MYXllcnMuQ29udHJvbC5OYXZpZ2F0aW9uKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3IE9wZW5MYXllcnMuQ29udHJvbC5Nb3VzZVBvc2l0aW9uKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3IE9wZW5MYXllcnMuQ29udHJvbC5BcmdQYXJzZXIoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgT3BlbkxheWVycy5Db250cm9sLkF0dHJpYnV0aW9uKCldKTsKICAgICAgICAgICAgICB9CiAgICAgICAgIiIiICUgYXJncwoKICAgICAgICBpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAnbWVyY2F0b3InIGFuZCBzZWxmLm9wdGlvbnMueHl6IGlzIE5vbmU6CiAgICAgICAgICAgIHMgKz0gIiIiCiAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0VVJMKGJvdW5kcykgewogICAgICAgICAgICAgICAgICBib3VuZHMgPSB0aGlzLmFkanVzdEJvdW5kcyhib3VuZHMpOwogICAgICAgICAgICAgICAgICB2YXIgcmVzID0gdGhpcy5nZXRTZXJ2ZXJSZXNvbHV0aW9uKCk7CiAgICAgICAgICAgICAgICAgIHZhciB4ID0gTWF0aC5yb3VuZCgoYm91bmRzLmxlZnQgLSB0aGlzLnRpbGVPcmlnaW4ubG9uKSAvIChyZXMgKiB0aGlzLnRpbGVTaXplLncpKTsKICAgICAgICAgICAgICAgICAgdmFyIHkgPSBNYXRoLnJvdW5kKChib3VuZHMuYm90dG9tIC0gdGhpcy50aWxlT3JpZ2luLmxhdCkgLyAocmVzICogdGhpcy50aWxlU2l6ZS5oKSk7CiAgICAgICAgICAgICAgICAgIHZhciB6ID0gdGhpcy5nZXRTZXJ2ZXJab29tKCk7CiAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm1hcC5iYXNlTGF5ZXIuQ0xBU1NfTkFNRSA9PT0gJ09wZW5MYXllcnMuTGF5ZXIuQmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgIHorPTE7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHBhdGggPSB0aGlzLnNlcnZpY2VWZXJzaW9uICsgIi8iICsgdGhpcy5sYXllcm5hbWUgKyAiLyIgKyB6ICsgIi8iICsgeCArICIvIiArIHkgKyAiLiIgKyB0aGlzLnR5cGU7CiAgICAgICAgICAgICAgICAgIHZhciB1cmwgPSB0aGlzLnVybDsKICAgICAgICAgICAgICAgICAgaWYgKE9wZW5MYXllcnMuVXRpbC5pc0FycmF5KHVybCkpIHsKICAgICAgICAgICAgICAgICAgICAgIHVybCA9IHRoaXMuc2VsZWN0VXJsKHBhdGgsIHVybCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKG1hcEJvdW5kcy5pbnRlcnNlY3RzQm91bmRzKGJvdW5kcykgJiYgKHogPj0gbWFwTWluWm9vbSkgJiYgKHogPD0gbWFwTWF4Wm9vbSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1cmwgKyBwYXRoOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVtcHR5VGlsZVVSTDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgIiIiICUgYXJncyAgICAjIG5vcWEKCiAgICAgICAgZWxpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAnZ2VvZGV0aWMnOgogICAgICAgICAgICBzICs9ICIiIgogICAgICAgICAgICAgIGZ1bmN0aW9uIGdldFVSTChib3VuZHMpIHsKICAgICAgICAgICAgICAgICAgYm91bmRzID0gdGhpcy5hZGp1c3RCb3VuZHMoYm91bmRzKTsKICAgICAgICAgICAgICAgICAgdmFyIHJlcyA9IHRoaXMuZ2V0U2VydmVyUmVzb2x1dGlvbigpOwogICAgICAgICAgICAgICAgICB2YXIgeCA9IE1hdGgucm91bmQoKGJvdW5kcy5sZWZ0IC0gdGhpcy50aWxlT3JpZ2luLmxvbikgLyAocmVzICogdGhpcy50aWxlU2l6ZS53KSk7CiAgICAgICAgICAgICAgICAgIHZhciB5ID0gTWF0aC5yb3VuZCgoYm91bmRzLmJvdHRvbSAtIHRoaXMudGlsZU9yaWdpbi5sYXQpIC8gKHJlcyAqIHRoaXMudGlsZVNpemUuaCkpOwogICAgICAgICAgICAgICAgICB2YXIgeiA9IHRoaXMuZ2V0U2VydmVyWm9vbSgpJSh0bXNvZmZzZXQpczsKICAgICAgICAgICAgICAgICAgdmFyIHBhdGggPSB0aGlzLnNlcnZpY2VWZXJzaW9uICsgIi8iICsgdGhpcy5sYXllcm5hbWUgKyAiLyIgKyB6ICsgIi8iICsgeCArICIvIiArIHkgKyAiLiIgKyB0aGlzLnR5cGU7CiAgICAgICAgICAgICAgICAgIHZhciB1cmwgPSB0aGlzLnVybDsKICAgICAgICAgICAgICAgICAgaWYgKE9wZW5MYXllcnMuVXRpbC5pc0FycmF5KHVybCkpIHsKICAgICAgICAgICAgICAgICAgICAgIHVybCA9IHRoaXMuc2VsZWN0VXJsKHBhdGgsIHVybCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKG1hcEJvdW5kcy5pbnRlcnNlY3RzQm91bmRzKGJvdW5kcykgJiYgKHogPj0gbWFwTWluWm9vbSkgJiYgKHogPD0gbWFwTWF4Wm9vbSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1cmwgKyBwYXRoOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVtcHR5VGlsZVVSTDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgIiIiICUgYXJncyAgICAjIG5vcWEKCiAgICAgICAgZWxpZiBzZWxmLm9wdGlvbnMucHJvZmlsZSA9PSAncmFzdGVyJzoKICAgICAgICAgICAgcyArPSAiIiIKICAgICAgICAgICAgICBmdW5jdGlvbiBnZXRVUkwoYm91bmRzKSB7CiAgICAgICAgICAgICAgICAgIGJvdW5kcyA9IHRoaXMuYWRqdXN0Qm91bmRzKGJvdW5kcyk7CiAgICAgICAgICAgICAgICAgIHZhciByZXMgPSB0aGlzLmdldFNlcnZlclJlc29sdXRpb24oKTsKICAgICAgICAgICAgICAgICAgdmFyIHggPSBNYXRoLnJvdW5kKChib3VuZHMubGVmdCAtIHRoaXMudGlsZU9yaWdpbi5sb24pIC8gKHJlcyAqIHRoaXMudGlsZVNpemUudykpOwogICAgICAgICAgICAgICAgICB2YXIgeSA9IE1hdGgucm91bmQoKGJvdW5kcy5ib3R0b20gLSB0aGlzLnRpbGVPcmlnaW4ubGF0KSAvIChyZXMgKiB0aGlzLnRpbGVTaXplLmgpKTsKICAgICAgICAgICAgICAgICAgdmFyIHogPSB0aGlzLmdldFNlcnZlclpvb20oKTsKICAgICAgICAgICAgICAgICAgdmFyIHBhdGggPSB0aGlzLnNlcnZpY2VWZXJzaW9uICsgIi8iICsgdGhpcy5sYXllcm5hbWUgKyAiLyIgKyB6ICsgIi8iICsgeCArICIvIiArIHkgKyAiLiIgKyB0aGlzLnR5cGU7CiAgICAgICAgICAgICAgICAgIHZhciB1cmwgPSB0aGlzLnVybDsKICAgICAgICAgICAgICAgICAgaWYgKE9wZW5MYXllcnMuVXRpbC5pc0FycmF5KHVybCkpIHsKICAgICAgICAgICAgICAgICAgICAgIHVybCA9IHRoaXMuc2VsZWN0VXJsKHBhdGgsIHVybCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKG1hcEJvdW5kcy5pbnRlcnNlY3RzQm91bmRzKGJvdW5kcykgJiYgKHogPj0gbWFwTWluWm9vbSkgJiYgKHogPD0gbWFwTWF4Wm9vbSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1cmwgKyBwYXRoOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVtcHR5VGlsZVVSTDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgIiIiICUgYXJncyAgICAjIG5vcWEKCiAgICAgICAgcyArPSAiIiIKICAgICAgICAgICBmdW5jdGlvbiBnZXRXaW5kb3dIZWlnaHQoKSB7CiAgICAgICAgICAgICAgICBpZiAoc2VsZi5pbm5lckhlaWdodCkgcmV0dXJuIHNlbGYuaW5uZXJIZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0KQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodDsKICAgICAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuYm9keSkgcmV0dXJuIGRvY3VtZW50LmJvZHkuY2xpZW50SGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBnZXRXaW5kb3dXaWR0aCgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5pbm5lcldpZHRoKSByZXR1cm4gc2VsZi5pbm5lcldpZHRoOwogICAgICAgICAgICAgICAgICAgIGlmIChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoOwogICAgICAgICAgICAgICAgICAgIGlmIChkb2N1bWVudC5ib2R5KSByZXR1cm4gZG9jdW1lbnQuYm9keS5jbGllbnRXaWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVzaXplKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBtYXAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibWFwIik7CiAgICAgICAgICAgICAgICAgICAgdmFyIGhlYWRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJoZWFkZXIiKTsKICAgICAgICAgICAgICAgICAgICB2YXIgc3ViaGVhZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInN1YmhlYWRlciIpOwogICAgICAgICAgICAgICAgICAgIG1hcC5zdHlsZS5oZWlnaHQgPSAoZ2V0V2luZG93SGVpZ2h0KCktODApICsgInB4IjsKICAgICAgICAgICAgICAgICAgICBtYXAuc3R5bGUud2lkdGggPSAoZ2V0V2luZG93V2lkdGgoKS0yMCkgKyAicHgiOwogICAgICAgICAgICAgICAgICAgIGhlYWRlci5zdHlsZS53aWR0aCA9IChnZXRXaW5kb3dXaWR0aCgpLTIwKSArICJweCI7CiAgICAgICAgICAgICAgICAgICAgc3ViaGVhZGVyLnN0eWxlLndpZHRoID0gKGdldFdpbmRvd1dpZHRoKCktMjApICsgInB4IjsKICAgICAgICAgICAgICAgICAgICBpZiAobWFwLnVwZGF0ZVNpemUpIHsgbWFwLnVwZGF0ZVNpemUoKTsgfTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBvbnJlc2l6ZT1mdW5jdGlvbigpeyByZXNpemUoKTsgfTsKCiAgICAgICAgICAgICAgICA8L3NjcmlwdD4KICAgICAgICAgICAgICA8L2hlYWQ+CiAgICAgICAgICAgICAgPGJvZHkgb25sb2FkPSJpbml0KCkiPgogICAgICAgICAgICAgICAgPGRpdiBpZD0iaGVhZGVyIj48aDE+JSh0aXRsZSlzPC9oMT48L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgaWQ9InN1YmhlYWRlciI+R2VuZXJhdGVkIGJ5IDxhIGhyZWY9Imh0dHA6Ly93d3cua2xva2FuLmN6L3Byb2plY3RzL2dkYWwydGlsZXMvIj5HREFMMlRpbGVzPC9hPiwgQ29weXJpZ2h0ICZjb3B5OyAyMDA4IDxhIGhyZWY9Imh0dHA6Ly93d3cua2xva2FuLmN6LyI+S2xva2FuIFBldHIgUHJpZGFsPC9hPiwgIDxhIGhyZWY9Imh0dHA6Ly93d3cuZ2RhbC5vcmcvIj5HREFMPC9hPiAmYW1wOyA8YSBocmVmPSJodHRwOi8vd3d3Lm9zZ2VvLm9yZy8iPk9TR2VvPC9hPiA8YSBocmVmPSJodHRwOi8vY29kZS5nb29nbGUuY29tL3NvYy8iPkdTb0M8L2E+CiAgICAgICAgICAgICAgICA8IS0tIFBMRUFTRSwgTEVUIFRISVMgTk9URSBBQk9VVCBBVVRIT1IgQU5EIFBST0pFQ1QgU09NRVdIRVJFIE9OIFlPVVIgV0VCU0lURSwgT1IgQVQgTEVBU1QgSU4gVEhFIENPTU1FTlQgSU4gSFRNTC4gVEhBTksgWU9VIC0tPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGlkPSJtYXAiPjwvZGl2PgogICAgICAgICAgICAgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L2phdmFzY3JpcHQiID5yZXNpemUoKTwvc2NyaXB0PgogICAgICAgICAgICAgIDwvYm9keT4KICAgICAgICAgICAgPC9odG1sPiIiIiAlIGFyZ3MgICAjIG5vcWEKCiAgICAgICAgcmV0dXJuIHMKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0WXRpbGUodHksIHR6LCBvcHRpb25zKToKICAgICAgICAiIiIKICAgICAgICBDYWxjdWxhdGVzIHRoZSB5LXRpbGUgbnVtYmVyIGJhc2VkIG9uIHdoZXRoZXIgWFlaIG9yIFRNUyAoZGVmYXVsdCkgc3lzdGVtIGlzIHVzZWQKICAgICAgICA6cGFyYW0gdHk6IFRoZSB5LXRpbGUgbnVtYmVyCiAgICAgICAgOnJldHVybjogVGhlIHRyYW5zZm9ybWVkIHRpbGUgbnVtYmVyCiAgICAgICAgIiIiCiAgICAgICAgaWYgb3B0aW9ucy54eXo6CiAgICAgICAgICAgIHJldHVybiAoMioqdHogLSAxKSAtIHR5ICAjIENvbnZlcnQgZnJvbSBUTVMgdG8gWFlaIG51bWJlcmluZyBzeXN0ZW0KICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gdHkKCgpkZWYgd29ya2VyX3RpbGVfZGV0YWlscyhpbnB1dF9maWxlLCBvdXRwdXRfZm9sZGVyLCBvcHRpb25zLCBzZW5kX3BpcGU9Tm9uZSk6CiAgICB0cnk6CiAgICAgICAgZ2RhbDJ0aWxlcyA9IEdEQUwyVGlsZXMoaW5wdXRfZmlsZSwgb3V0cHV0X2ZvbGRlciwgb3B0aW9ucykKICAgICAgICBnZGFsMnRpbGVzLm9wZW5faW5wdXQoKQogICAgICAgIGdkYWwydGlsZXMuZ2VuZXJhdGVfbWV0YWRhdGEoKQogICAgICAgIHRpbGVfam9iX2luZm8sIHRpbGVfZGV0YWlscyA9IGdkYWwydGlsZXMuZ2VuZXJhdGVfYmFzZV90aWxlcygpCiAgICAgICAgcmV0dXJuX2RhdGEgPSAodGlsZV9qb2JfaW5mbywgdGlsZV9kZXRhaWxzKQogICAgICAgIGlmIHNlbmRfcGlwZToKICAgICAgICAgICAgc2VuZF9waXBlLnNlbmQocmV0dXJuX2RhdGEpCgogICAgICAgIHJldHVybiByZXR1cm5fZGF0YQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KCJ3b3JrZXJfdGlsZV9kZXRhaWxzIGZhaWxlZCAiLCBzdHIoZSkpCgoKZGVmIHByb2dyZXNzX3ByaW50ZXJfdGhyZWFkKHF1ZXVlLCBuYl9qb2JzKToKICAgIHBiID0gUHJvZ3Jlc3NCYXIobmJfam9icykKICAgIHBiLnN0YXJ0KCkKICAgIGZvciBfIGluIHJhbmdlKG5iX2pvYnMpOgogICAgICAgIHF1ZXVlLmdldCgpCiAgICAgICAgcGIubG9nX3Byb2dyZXNzKCkKICAgICAgICBxdWV1ZS50YXNrX2RvbmUoKQoKCmNsYXNzIFByb2dyZXNzQmFyKG9iamVjdCk6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHRvdGFsX2l0ZW1zKToKICAgICAgICBzZWxmLnRvdGFsX2l0ZW1zID0gdG90YWxfaXRlbXMKICAgICAgICBzZWxmLm5iX2l0ZW1zX2RvbmUgPSAwCiAgICAgICAgc2VsZi5jdXJyZW50X3Byb2dyZXNzID0gMAogICAgICAgIHNlbGYuU1RFUCA9IDIuNQoKICAgIGRlZiBzdGFydChzZWxmKToKICAgICAgICBzeXMuc3Rkb3V0LndyaXRlKCIwIikKCiAgICBkZWYgbG9nX3Byb2dyZXNzKHNlbGYsIG5iX2l0ZW1zPTEpOgogICAgICAgIHNlbGYubmJfaXRlbXNfZG9uZSArPSBuYl9pdGVtcwogICAgICAgIHByb2dyZXNzID0gZmxvYXQoc2VsZi5uYl9pdGVtc19kb25lKSAvIHNlbGYudG90YWxfaXRlbXMgKiAxMDAKICAgICAgICBpZiBwcm9ncmVzcyA+PSBzZWxmLmN1cnJlbnRfcHJvZ3Jlc3MgKyBzZWxmLlNURVA6CiAgICAgICAgICAgIGRvbmUgPSBGYWxzZQogICAgICAgICAgICB3aGlsZSBub3QgZG9uZToKICAgICAgICAgICAgICAgIGlmIHNlbGYuY3VycmVudF9wcm9ncmVzcyArIHNlbGYuU1RFUCA8PSBwcm9ncmVzczoKICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfcHJvZ3Jlc3MgKz0gc2VsZi5TVEVQCiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5jdXJyZW50X3Byb2dyZXNzICUgMTAgPT0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgc3lzLnN0ZG91dC53cml0ZShzdHIoaW50KHNlbGYuY3VycmVudF9wcm9ncmVzcykpKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLmN1cnJlbnRfcHJvZ3Jlc3MgPT0gMTAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3lzLnN0ZG91dC53cml0ZSgiXG4iKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHN5cy5zdGRvdXQud3JpdGUoIi4iKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBkb25lID0gVHJ1ZQogICAgICAgIHN5cy5zdGRvdXQuZmx1c2goKQoKCmRlZiBnZXRfdGlsZV9zd25lKHRpbGVfam9iX2luZm8sIG9wdGlvbnMpOgogICAgaWYgb3B0aW9ucy5wcm9maWxlID09ICdtZXJjYXRvcic6CiAgICAgICAgbWVyY2F0b3IgPSBHbG9iYWxNZXJjYXRvcigpCiAgICAgICAgdGlsZV9zd25lID0gbWVyY2F0b3IuVGlsZUxhdExvbkJvdW5kcwogICAgZWxpZiBvcHRpb25zLnByb2ZpbGUgPT0gJ2dlb2RldGljJzoKICAgICAgICBnZW9kZXRpYyA9IEdsb2JhbEdlb2RldGljKG9wdGlvbnMudG1zY29tcGF0aWJsZSkKICAgICAgICB0aWxlX3N3bmUgPSBnZW9kZXRpYy5UaWxlTGF0TG9uQm91bmRzCiAgICBlbGlmIG9wdGlvbnMucHJvZmlsZSA9PSAncmFzdGVyJzoKICAgICAgICBzcnM0MzI2ID0gb3NyLlNwYXRpYWxSZWZlcmVuY2UoKQogICAgICAgIHNyczQzMjYuSW1wb3J0RnJvbUVQU0coNDMyNikKICAgICAgICBpZiB0aWxlX2pvYl9pbmZvLmttbCBhbmQgdGlsZV9qb2JfaW5mby5pbl9zcnNfd2t0OgogICAgICAgICAgICBpbl9zcnMgPSBvc3IuU3BhdGlhbFJlZmVyZW5jZSgpCiAgICAgICAgICAgIGluX3Nycy5JbXBvcnRGcm9tV2t0KHRpbGVfam9iX2luZm8uaW5fc3JzX3drdCkKICAgICAgICAgICAgY3QgPSBvc3IuQ29vcmRpbmF0ZVRyYW5zZm9ybWF0aW9uKGluX3Nycywgc3JzNDMyNikKCiAgICAgICAgICAgIGRlZiByYXN0ZXJ0aWxlc3duZSh4LCB5LCB6KToKICAgICAgICAgICAgICAgIHBpeGVsc2l6ZXggPSAoMiAqKiAodGlsZV9qb2JfaW5mby50bWF4eiAtIHopICogdGlsZV9qb2JfaW5mby5vdXRfZ2VvX3RyYW5zWzFdKQogICAgICAgICAgICAgICAgd2VzdCA9IHRpbGVfam9iX2luZm8ub3V0X2dlb190cmFuc1swXSArIHggKiB0aWxlX2pvYl9pbmZvLnRpbGVzaXplICogcGl4ZWxzaXpleAogICAgICAgICAgICAgICAgZWFzdCA9IHdlc3QgKyB0aWxlX2pvYl9pbmZvLnRpbGVzaXplICogcGl4ZWxzaXpleAogICAgICAgICAgICAgICAgc291dGggPSB0aWxlX2pvYl9pbmZvLm9taW55ICsgeSAqIHRpbGVfam9iX2luZm8udGlsZXNpemUgKiBwaXhlbHNpemV4CiAgICAgICAgICAgICAgICBub3J0aCA9IHNvdXRoICsgdGlsZV9qb2JfaW5mby50aWxlc2l6ZSAqIHBpeGVsc2l6ZXgKICAgICAgICAgICAgICAgIGlmIG5vdCB0aWxlX2pvYl9pbmZvLmlzX2Vwc2dfNDMyNjoKICAgICAgICAgICAgICAgICAgICAjIFRyYW5zZm9ybWF0aW9uIHRvIEVQU0c6NDMyNiAoV0dTODQgZGF0dW0pCiAgICAgICAgICAgICAgICAgICAgd2VzdCwgc291dGggPSBjdC5UcmFuc2Zvcm1Qb2ludCh3ZXN0LCBzb3V0aClbOjJdCiAgICAgICAgICAgICAgICAgICAgZWFzdCwgbm9ydGggPSBjdC5UcmFuc2Zvcm1Qb2ludChlYXN0LCBub3J0aClbOjJdCiAgICAgICAgICAgICAgICByZXR1cm4gc291dGgsIHdlc3QsIG5vcnRoLCBlYXN0CgogICAgICAgICAgICB0aWxlX3N3bmUgPSByYXN0ZXJ0aWxlc3duZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHRpbGVfc3duZSA9IGxhbWJkYSB4LCB5LCB6OiAoMCwgMCwgMCwgMCkgICAjIG5vcWEKICAgIGVsc2U6CiAgICAgICAgdGlsZV9zd25lID0gbGFtYmRhIHgsIHksIHo6ICgwLCAwLCAwLCAwKSAgICMgbm9xYQoKICAgIHJldHVybiB0aWxlX3N3bmUKCgpkZWYgc2luZ2xlX3RocmVhZGVkX3RpbGluZyhpbnB1dF9maWxlLCBvdXRwdXRfZm9sZGVyLCBvcHRpb25zKToKICAgICIiIgogICAgS2VlcCBhIHNpbmdsZSB0aHJlYWRlZCB2ZXJzaW9uIHRoYXQgc3RheXMgY2xlYXIgb2YgbXVsdGlwcm9jZXNzaW5nLCBmb3IgcGxhdGZvcm1zIHRoYXQgd291bGQgbm90CiAgICBzdXBwb3J0IGl0CiAgICAiIiIKICAgIGlmIG9wdGlvbnMudmVyYm9zZToKICAgICAgICBwcmludCgiQmVnaW4gdGlsZXMgZGV0YWlscyBjYWxjIikKICAgIGNvbmYsIHRpbGVfZGV0YWlscyA9IHdvcmtlcl90aWxlX2RldGFpbHMoaW5wdXRfZmlsZSwgb3V0cHV0X2ZvbGRlciwgb3B0aW9ucykKCiAgICBpZiBvcHRpb25zLnZlcmJvc2U6CiAgICAgICAgcHJpbnQoIlRpbGVzIGRldGFpbHMgY2FsYyBjb21wbGV0ZS4iKQoKICAgIGlmIG5vdCBvcHRpb25zLnZlcmJvc2UgYW5kIG5vdCBvcHRpb25zLnF1aWV0OgogICAgICAgIHByb2dyZXNzX2JhciA9IFByb2dyZXNzQmFyKGxlbih0aWxlX2RldGFpbHMpKQogICAgICAgIHByb2dyZXNzX2Jhci5zdGFydCgpCgogICAgZm9yIHRpbGVfZGV0YWlsIGluIHRpbGVfZGV0YWlsczoKICAgICAgICBjcmVhdGVfYmFzZV90aWxlKGNvbmYsIHRpbGVfZGV0YWlsLCBvcHRpb25zKQoKICAgICAgICBpZiBub3Qgb3B0aW9ucy52ZXJib3NlIGFuZCBub3Qgb3B0aW9ucy5xdWlldDoKICAgICAgICAgICAgcHJvZ3Jlc3NfYmFyLmxvZ19wcm9ncmVzcygpCgogICAgY3JlYXRlX292ZXJ2aWV3X3RpbGVzKGNvbmYsIG91dHB1dF9mb2xkZXIsIG9wdGlvbnMpCgogICAgc2h1dGlsLnJtdHJlZShvcy5wYXRoLmRpcm5hbWUoY29uZi5zcmNfZmlsZSkpCgoKZGVmIG11bHRpX3RocmVhZGVkX3RpbGluZyhpbnB1dF9maWxlLCBvdXRwdXRfZm9sZGVyLCBvcHRpb25zKToKICAgIG5iX3Byb2Nlc3NlcyA9IG9wdGlvbnMubmJfcHJvY2Vzc2VzIG9yIDEKICAgIChjb25mX3JlY2VpdmVyLCBjb25mX3NlbmRlcikgPSBQaXBlKEZhbHNlKQoKICAgIGlmIG9wdGlvbnMudmVyYm9zZToKICAgICAgICBwcmludCgiQmVnaW4gdGlsZXMgZGV0YWlscyBjYWxjIikKICAgIHAgPSBQcm9jZXNzKHRhcmdldD13b3JrZXJfdGlsZV9kZXRhaWxzLAogICAgICAgICAgICAgICAgYXJncz1baW5wdXRfZmlsZSwgb3V0cHV0X2ZvbGRlciwgb3B0aW9uc10sCiAgICAgICAgICAgICAgICBrd2FyZ3M9eyJzZW5kX3BpcGUiOiBjb25mX3NlbmRlcn0pCiAgICBwLnN0YXJ0KCkKICAgICMgTWFrZSBzdXJlIHRvIGNvbnN1bWUgdGhlIHF1ZXVlIGJlZm9yZSBqb2luaW5nLiBJZiB0aGUgcGF5bG9hZCBpcyB0b28gYmlnLCBpdCB3b24ndCBiZSBwdXQgaW4KICAgICMgb25lIGdvIGluIHRoZSBxdWV1ZSBhbmQgdGhlcmVmb3JlIHRoZSBzZW5kaW5nIHByb2Nlc3Mgd2lsbCBuZXZlciBmaW5pc2gsIHdhaXRpbmcgZm9yIHNwYWNlIGluCiAgICAjIHRoZSBxdWV1ZSB0byBzZW5kIGRhdGEKICAgIGNvbmYsIHRpbGVfZGV0YWlscyA9IGNvbmZfcmVjZWl2ZXIucmVjdigpCiAgICBwLmpvaW4oKQogICAgaWYgb3B0aW9ucy52ZXJib3NlOgogICAgICAgIHByaW50KCJUaWxlcyBkZXRhaWxzIGNhbGMgY29tcGxldGUuIikKICAgICMgSGF2ZSB0byBjcmVhdGUgdGhlIFF1ZXVlIHRocm91Z2ggYSBtdWx0aXByb2Nlc3NpbmcuTWFuYWdlciB0byBnZXQgYSBRdWV1ZSBQcm94eSwKICAgICMgb3RoZXJ3aXNlIHlvdSBjYW4ndCBwYXNzIGl0IGFzIGEgcGFyYW0gaW4gdGhlIG1ldGhvZCBpbnZva2VkIGJ5IHRoZSBwb29sLi4uCiAgICBtYW5hZ2VyID0gTWFuYWdlcigpCiAgICBxdWV1ZSA9IG1hbmFnZXIuUXVldWUoKQogICAgcG9vbCA9IFBvb2wocHJvY2Vzc2VzPW5iX3Byb2Nlc3NlcykKICAgICMgVE9ETzogZ2JhdGFpbGxlIC0gY2hlY2sgdGhlIGNvbmZzIGZvciB3aGljaCBlYWNoIGVsZW1lbnQgaXMgYW4gYXJyYXkuLi4gb25lIHVzZWxlc3MgbGV2ZWw/CiAgICAjIFRPRE86IGdiYXRhaWxsZSAtIGFzc2lnbiBhbiBJRCB0byBlYWNoIGpvYiBmb3IgcHJpbnQgaW4gdmVyYm9zZSBtb2RlICJSZWFkUmFzdGVyIEV4dGVudCAuLi4iCiAgICAjIFRPRE86IGdiYXRhaWxsZSAtIGNoZWNrIG1lbW9yeSBmb290cHJpbnQgYW5kIHRpbWUgb24gYmlnIGltYWdlLiBhcmUgdGhleSBvcGVuZWQgeCB0aW1lcwogICAgZm9yIHRpbGVfZGV0YWlsIGluIHRpbGVfZGV0YWlsczoKICAgICAgICBwb29sLmFwcGx5X2FzeW5jKGNyZWF0ZV9iYXNlX3RpbGUsIChjb25mLCB0aWxlX2RldGFpbCwgb3B0aW9ucyksIHsicXVldWUiOiBxdWV1ZX0pCgogICAgaWYgbm90IG9wdGlvbnMudmVyYm9zZSBhbmQgbm90IG9wdGlvbnMucXVpZXQ6CiAgICAgICAgcCA9IFByb2Nlc3ModGFyZ2V0PXByb2dyZXNzX3ByaW50ZXJfdGhyZWFkLCBhcmdzPVtxdWV1ZSwgbGVuKHRpbGVfZGV0YWlscyldKQogICAgICAgIHAuc3RhcnQoKQoKICAgIHBvb2wuY2xvc2UoKQogICAgcG9vbC5qb2luKCkgICAgICMgSm9icyBmaW5pc2hlZAogICAgaWYgbm90IG9wdGlvbnMudmVyYm9zZSBhbmQgbm90IG9wdGlvbnMucXVpZXQ6CiAgICAgICAgcC5qb2luKCkgICAgICAgICMgVHJhY2VzIGRvbmUKCiAgICBjcmVhdGVfb3ZlcnZpZXdfdGlsZXMoY29uZiwgb3V0cHV0X2ZvbGRlciwgb3B0aW9ucykKCiAgICBzaHV0aWwucm10cmVlKG9zLnBhdGguZGlybmFtZShjb25mLnNyY19maWxlKSkKCgojIGRlZiBtYWluKCk6CiMgICAgICMgVE9ETzogZ2JhdGFpbGxlIC0gdXNlIG1rZHRlbXAgdG8gd29yayBpbiBhIHRlbXAgZGlyZWN0b3J5CiMgICAgICMgVE9ETzogZ2JhdGFpbGxlIC0gZGVidWcgaW50ZXJtZWRpYXRlIHRpbGVzLnZydCBub3QgcHJvZHVjZWQgYW55bW9yZT8KIyAgICAgIyBUT0RPOiBnYmF0YWlsbGUgLSBSZWZhY3RvciBnZW5lcmF0ZSBvdmVydmlldyB0aWxlcyB0byBub3QgZGVwZW5kIG9uIHNlbGYgdmFyaWFibGVzCiMgICAgIGFyZ3YgPSBnZGFsLkdlbmVyYWxDbWRMaW5lUHJvY2Vzc29yKHN5cy5hcmd2KQojICAgICBpbnB1dF9maWxlLCBvdXRwdXRfZm9sZGVyLCBvcHRpb25zID0gcHJvY2Vzc19hcmdzKGFyZ3ZbMTpdKQojICAgICBuYl9wcm9jZXNzZXMgPSBvcHRpb25zLm5iX3Byb2Nlc3NlcyBvciAxCiMKIyAgICAgaWYgbmJfcHJvY2Vzc2VzID09IDE6CiMgICAgICAgICBzaW5nbGVfdGhyZWFkZWRfdGlsaW5nKGlucHV0X2ZpbGUsIG91dHB1dF9mb2xkZXIsIG9wdGlvbnMpCiMgICAgIGVsc2U6CiMgICAgICAgICBtdWx0aV90aHJlYWRlZF90aWxpbmcoaW5wdXRfZmlsZSwgb3V0cHV0X2ZvbGRlciwgb3B0aW9ucykKIwojIGlmIF9fbmFtZV9fID09ICdfX21haW5fXyc6CiMgICAgICMgc3RhcnRfdGltZSA9IHRpbWUudGltZSgpCiMgICAgIG1haW4oKQojICAgICAjIHByaW50KCItLS0gJXMgc2Vjb25kcyAtLS0iICUgKHRpbWUudGltZSgpIC0gc3RhcnRfdGltZSkpCgojZ2RhbF90cmFuc2xhdGUgLW9mIHZydCAtZXhwYW5kIHJnYmEgRjpcRGFuaWxvXFRyYW1wb1xkYXRhX2RpclxkYXRhXHJlbWFuZXNjZW50ZXNfZmxvcmVzdGFpc19kZXNtYXRhbWVudG9cYnJhc2lsXHByb2Rlc1xwcm9kZXMudGlmIHByb2Rlcy52cnQKIyBpbnB1dF9maWxlID0gIkY6XFxEYW5pbG9cXFRyYW1wb1xcZGF0YV9kaXJcXGRhdGFcXHJlbWFuZXNjZW50ZXNfZmxvcmVzdGFpc19kZXNtYXRhbWVudG9cXGJyYXNpbFxccHJvZGVzXFxwcm9kZXMudnJ0IiAjIkY6XFxEYW5pbG9cXFRyYW1wb1xcZGF0YV9kaXJcXGRhdGFcXHJlbWFuZXNjZW50ZXNfZmxvcmVzdGFpc19kZXNtYXRhbWVudG9cXGJyYXNpbFxccGVyZGFfY29iZXJ0dXJhX3ZlZ2V0YWxfYW5vX2hhbnNlblxcbG9zc3llYXIudGlmIgojIG91dHB1dF9mb2xkZXIgPSAiRjpcXERhbmlsb1xcVGVtcFxccmVzdWx0XFxwcm9kZXNfcHVibGlzaFxcIgojZ2VuZXJhdGVUaWxlRm9yTWFwKGlucHV0X2ZpbGUsIG91dHB1dF9mb2xkZXIpCgpjbGFzcyBPcHRpb25zOgogICAgcHJvZmlsZSA9ICJtZXJjYXRvciIKICAgIHJlc2FtcGxpbmcgPSAnbmVhcicKICAgIHNfc3JzID0gTm9uZQogICAgem9vbT0gJzAtMicKICAgIHJlc3VtZSA9IEZhbHNlCiAgICBzcmNub2RhdGEgPSAnJwogICAgdG1zY29tcGF0aWJsZSA9IEZhbHNlCiAgICB4eXogPSBUcnVlCiAgICB2ZXJib3NlID0gRmFsc2UKICAgIHF1aWV0ID0gVHJ1ZQogICAgbmJfcHJvY2Vzc2VzID0gMQogICAga21sID0gRmFsc2UKICAgIHVybCA9ICcnCiAgICB3ZWJ2aWV3ZXIgPSdub25lJwogICAgdGl0bGUgPSAnJwogICAgY29weXJpZ2h0ID0gJycKICAgIGdvb2dsZWtleSA9ICcnCiAgICBiaW5na2V5ID0gJycKICAgIGxlZ2VuZE9iaiA9IE5vbmUKICAgIGdlbmVyYXRlZEZpbGVzID0gW10KCmRlZiBnZW5lcmF0ZVRpbGVGb3JNYXAoaW5wdXRfZmlsZSwgb3V0cHV0X2ZvbGRlciwgbWF4Wm9vbSwgcmVzdW1lLCBsZWdlbmRPYmopOgogICAgb3B0aW9ucyA9IE9wdGlvbnMoKQogICAgb3B0aW9ucy52ZXJib3NlID0gRmFsc2UKICAgIG9wdGlvbnMucmVzYW1wbGluZyA9ICduZWFyJwogICAgb3B0aW9ucy56b29tID0gJzAtJyArIHN0cihtYXhab29tKQogICAgb3B0aW9ucy5yZXN1bWUgPSByZXN1bWUKICAgIG9wdGlvbnMubGVnZW5kT2JqID0gbGVnZW5kT2JqCiAgICBzaW5nbGVfdGhyZWFkZWRfdGlsaW5nKGlucHV0X2ZpbGUsIG91dHB1dF9mb2xkZXIsIG9wdGlvbnMpCiAgICBmb3IgZmlsZW5hbWUgaW4gb3B0aW9ucy5nZW5lcmF0ZWRGaWxlczoKICAgICAgICBhcHBseUxlZ2VuZChmaWxlbmFtZSwgb3B0aW9ucy5sZWdlbmRPYmopCiAgICAjbXVsdGlfdGhyZWFkZWRfdGlsaW5nKGlucHV0X2ZpbGUsIG91dHB1dF9mb2xkZXIsIG9wdGlvbnMpCgoKdHJ5OgogICAgZnJvbSBXTVNDYXBhYmlsaXRpZXMgaW1wb3J0IFdNU0NhcGFiaWxpdGllcwogICAgZnJvbSBXTVNDYXBhYmlsaXRpZXMgaW1wb3J0IFdNU0JCb3gKZXhjZXB0OgogICAgcGFzcyAjTm90IGluIERpbmFtaWNhIENvZGUKCiMhL3Vzci9iaW4vZW52IHB5dGhvbgojIC0qLSBjb2Rpbmc6IHV0Zi04IC0qLQoKCmlzRGluYW1pY2EgPSBGYWxzZQp0cnk6CiAgICBkaW5hbWljYS5wYWNrYWdlKCJvcyIpCiAgICBpc0RpbmFtaWNhID0gVHJ1ZQpleGNlcHQ6CiAgICBpc0RpbmFtaWNhID0gRmFsc2UKCmlmIG5vdCBpc0RpbmFtaWNhOgogICAgdHJ5OgogICAgICAgIGZyb20gLlVUSUxTIGltcG9ydCBVVElMUwogICAgICAgIGZyb20gLiBpbXBvcnQgeG1sdG9kaWN0CiAgICBleGNlcHQ6CiAgICAgICAgcGFzcyAjTm90IGluIFFHSVMKCiAgICB0cnk6CiAgICAgICAgZnJvbSBVVElMUyBpbXBvcnQgVVRJTFMKICAgICAgICBmcm9tIHhtbHRvZGljdCBpbXBvcnQgeG1sdG9kaWN0CiAgICBleGNlcHQ6CiAgICAgICAgcGFzcyAjTm90IGluIERpbmFtaWNhIENvZGUKCmZyb20gY29sbGVjdGlvbnMgaW1wb3J0IE9yZGVyZWREaWN0CmltcG9ydCBjb2xsZWN0aW9ucwpmcm9tIHBhdGhsaWIgaW1wb3J0IFBhdGgKaW1wb3J0IGpzb24KaW1wb3J0IG9zCmltcG9ydCBpbwppbXBvcnQgY3N2CmltcG9ydCByZQoKIyB0cnk6CiMgICAgIGZyb20gcWdpcy5jb3JlIGltcG9ydCAoUWdzQ29vcmRpbmF0ZVJlZmVyZW5jZVN5c3RlbSwgUWdzUHJvamVjdCwgUWdzUG9pbnRYWSwgUWdzQ29vcmRpbmF0ZVRyYW5zZm9ybSwgUWdzVmVjdG9yTGF5ZXIpCiMgZXhjZXB0OgojICAgICBwYXNzCgpjbGFzcyBXTVNDYXBhYmlsaXRpZXM6CgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldERlZmF1bHRDYXBhYmlsaXRpZXMoKToKICAgICAgICByZXR1cm4gJycnPD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48IURPQ1RZUEUgV01UX01TX0NhcGFiaWxpdGllcyBTWVNURU0gImh0dHA6Ly9tYXBzLmNzci51Zm1nLmJyOjgwL2dlb3NlcnZlci9zY2hlbWFzL3dtcy8xLjEuMS9XTVNfTVNfQ2FwYWJpbGl0aWVzLmR0ZCJbCiAgICA8IUVMRU1FTlQgVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMgKFRpbGVTZXQqKSA+CiAgICA8IUVMRU1FTlQgVGlsZVNldCAoU1JTLCBCb3VuZGluZ0JveD8sIFJlc29sdXRpb25zLCBXaWR0aCwgSGVpZ2h0LCBGb3JtYXQsIExheWVycyosIFN0eWxlcyopID4KICAgIDwhRUxFTUVOVCBSZXNvbHV0aW9ucyAoI1BDREFUQSkgPgogICAgPCFFTEVNRU5UIFdpZHRoICgjUENEQVRBKSA+CiAgICA8IUVMRU1FTlQgSGVpZ2h0ICgjUENEQVRBKSA+CiAgICA8IUVMRU1FTlQgTGF5ZXJzICgjUENEQVRBKSA+CiAgICA8IUVMRU1FTlQgU3R5bGVzICgjUENEQVRBKSA+CiAgICBdPgogICAgPFdNVF9NU19DYXBhYmlsaXRpZXMgdmVyc2lvbj0iMS4xLjEiIHVwZGF0ZVNlcXVlbmNlPSI2MzI1OCI+CiAgICAgIDxTZXJ2aWNlPgogICAgICAgIDxOYW1lPk9HQzpXTVM8L05hbWU+CiAgICAgICAgPFRpdGxlPkNTUiBXZWIgTWFwIFNlcnZpY2U8L1RpdGxlPgogICAgICAgIDxBYnN0cmFjdD5Db21wbGlhbnQgV01TIFJlc3BvbnNlPC9BYnN0cmFjdD4KICAgICAgICA8S2V5d29yZExpc3Q+CiAgICAgICAgICA8S2V5d29yZD5XRlM8L0tleXdvcmQ+CiAgICAgICAgICA8S2V5d29yZD5XTVM8L0tleXdvcmQ+CiAgICAgICAgICA8S2V5d29yZD5HRU9TRVJWRVI8L0tleXdvcmQ+CiAgICAgICAgPC9LZXl3b3JkTGlzdD4KICAgICAgICA8T25saW5lUmVzb3VyY2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOnR5cGU9InNpbXBsZSIgeGxpbms6aHJlZj0iaHR0cDovL2dlb3NlcnZlci5zb3VyY2Vmb3JnZS5uZXQvaHRtbC9pbmRleC5waHAiLz4KICAgICAgICA8Q29udGFjdEluZm9ybWF0aW9uPgogICAgICAgICAgPENvbnRhY3RQZXJzb25QcmltYXJ5PgogICAgICAgICAgICA8Q29udGFjdFBlcnNvbj5HSVRIVUIgb3duZXI8L0NvbnRhY3RQZXJzb24+CiAgICAgICAgICAgIDxDb250YWN0T3JnYW5pemF0aW9uPkdJVEhVQiBvd25lcjwvQ29udGFjdE9yZ2FuaXphdGlvbj4KICAgICAgICAgIDwvQ29udGFjdFBlcnNvblByaW1hcnk+CiAgICAgICAgICA8Q29udGFjdFBvc2l0aW9uPkNoaWVmIGdlb2dyYXBoZXI8L0NvbnRhY3RQb3NpdGlvbj4KICAgICAgICAgIDxDb250YWN0QWRkcmVzcz4KICAgICAgICAgICAgPEFkZHJlc3NUeXBlPldvcms8L0FkZHJlc3NUeXBlPgogICAgICAgICAgICA8QWRkcmVzcy8+CiAgICAgICAgICAgIDxDaXR5PkFsZXhhbmRyaWE8L0NpdHk+CiAgICAgICAgICAgIDxTdGF0ZU9yUHJvdmluY2UvPgogICAgICAgICAgICA8UG9zdENvZGUvPgogICAgICAgICAgICA8Q291bnRyeT5FZ3lwdDwvQ291bnRyeT4KICAgICAgICAgIDwvQ29udGFjdEFkZHJlc3M+CiAgICAgICAgICA8Q29udGFjdFZvaWNlVGVsZXBob25lLz4KICAgICAgICAgIDxDb250YWN0RmFjc2ltaWxlVGVsZXBob25lLz4KICAgICAgICAgIDxDb250YWN0RWxlY3Ryb25pY01haWxBZGRyZXNzPmNsYXVkaXVzLnB0b2xvbWFldXNAZ21haWwuY29tPC9Db250YWN0RWxlY3Ryb25pY01haWxBZGRyZXNzPgogICAgICAgIDwvQ29udGFjdEluZm9ybWF0aW9uPgogICAgICAgIDxGZWVzPk5PTkU8L0ZlZXM+CiAgICAgICAgPEFjY2Vzc0NvbnN0cmFpbnRzPk5PTkU8L0FjY2Vzc0NvbnN0cmFpbnRzPgogICAgICA8L1NlcnZpY2U+CiAgICAgIDxDYXBhYmlsaXR5PgogICAgICAgIDxSZXF1ZXN0PgogICAgICAgICAgPEdldENhcGFiaWxpdGllcz4KICAgICAgICAgICAgPEZvcm1hdD5hcHBsaWNhdGlvbi92bmQub2djLndtc194bWw8L0Zvcm1hdD4KICAgICAgICAgICAgPERDUFR5cGU+CiAgICAgICAgICAgICAgPEhUVFA+CiAgICAgICAgICAgICAgICA8R2V0PgogICAgICAgICAgICAgICAgICA8T25saW5lUmVzb3VyY2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOnR5cGU9InNpbXBsZSIgeGxpbms6aHJlZj0iaHR0cDovL21hcHMuY3NyLnVmbWcuYnI6ODAvZ2Vvc2VydmVyL3dtcz9TRVJWSUNFPVdNUyZhbXA7Ii8+CiAgICAgICAgICAgICAgICA8L0dldD4KICAgICAgICAgICAgICAgIDxQb3N0PgogICAgICAgICAgICAgICAgICA8T25saW5lUmVzb3VyY2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOnR5cGU9InNpbXBsZSIgeGxpbms6aHJlZj0iaHR0cDovL21hcHMuY3NyLnVmbWcuYnI6ODAvZ2Vvc2VydmVyL3dtcz9TRVJWSUNFPVdNUyZhbXA7Ii8+CiAgICAgICAgICAgICAgICA8L1Bvc3Q+CiAgICAgICAgICAgICAgPC9IVFRQPgogICAgICAgICAgICA8L0RDUFR5cGU+CiAgICAgICAgICA8L0dldENhcGFiaWxpdGllcz4KICAgICAgICAgIDxHZXRNYXA+CiAgICAgICAgICAgIDxGb3JtYXQ+aW1hZ2UvcG5nPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxEQ1BUeXBlPgogICAgICAgICAgICAgIDxIVFRQPgogICAgICAgICAgICAgICAgPEdldD4KICAgICAgICAgICAgICAgICAgPE9ubGluZVJlc291cmNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazp0eXBlPSJzaW1wbGUiIHhsaW5rOmhyZWY9Imh0dHA6Ly9tYXBzLmNzci51Zm1nLmJyOjgwL2dlb3NlcnZlci93bXM/U0VSVklDRT1XTVMmYW1wOyIvPgogICAgICAgICAgICAgICAgPC9HZXQ+CiAgICAgICAgICAgICAgPC9IVFRQPgogICAgICAgICAgICA8L0RDUFR5cGU+CiAgICAgICAgICA8L0dldE1hcD4KICAgICAgICAgIDxHZXRGZWF0dXJlSW5mbz4KICAgICAgICAgICAgPEZvcm1hdD50ZXh0L3BsYWluPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxGb3JtYXQ+YXBwbGljYXRpb24vdm5kLm9nYy5nbWw8L0Zvcm1hdD4KICAgICAgICAgICAgPEZvcm1hdD5hcHBsaWNhdGlvbi92bmQub2djLmdtbC8zLjEuMTwvRm9ybWF0PgogICAgICAgICAgICA8Rm9ybWF0PnRleHQvaHRtbDwvRm9ybWF0PgogICAgICAgICAgICA8Rm9ybWF0PmFwcGxpY2F0aW9uL2pzb248L0Zvcm1hdD4KICAgICAgICAgICAgPERDUFR5cGU+CiAgICAgICAgICAgICAgPEhUVFA+CiAgICAgICAgICAgICAgICA8R2V0PgogICAgICAgICAgICAgICAgICA8T25saW5lUmVzb3VyY2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOnR5cGU9InNpbXBsZSIgeGxpbms6aHJlZj0iaHR0cDovL21hcHMuY3NyLnVmbWcuYnI6ODAvZ2Vvc2VydmVyL3dtcz9TRVJWSUNFPVdNUyZhbXA7Ii8+CiAgICAgICAgICAgICAgICA8L0dldD4KICAgICAgICAgICAgICAgIDxQb3N0PgogICAgICAgICAgICAgICAgICA8T25saW5lUmVzb3VyY2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOnR5cGU9InNpbXBsZSIgeGxpbms6aHJlZj0iaHR0cDovL21hcHMuY3NyLnVmbWcuYnI6ODAvZ2Vvc2VydmVyL3dtcz9TRVJWSUNFPVdNUyZhbXA7Ii8+CiAgICAgICAgICAgICAgICA8L1Bvc3Q+CiAgICAgICAgICAgICAgPC9IVFRQPgogICAgICAgICAgICA8L0RDUFR5cGU+CiAgICAgICAgICA8L0dldEZlYXR1cmVJbmZvPgogICAgICAgICAgPERlc2NyaWJlTGF5ZXI+CiAgICAgICAgICAgIDxGb3JtYXQ+YXBwbGljYXRpb24vdm5kLm9nYy53bXNfeG1sPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxEQ1BUeXBlPgogICAgICAgICAgICAgIDxIVFRQPgogICAgICAgICAgICAgICAgPEdldD4KICAgICAgICAgICAgICAgICAgPE9ubGluZVJlc291cmNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazp0eXBlPSJzaW1wbGUiIHhsaW5rOmhyZWY9Imh0dHA6Ly9tYXBzLmNzci51Zm1nLmJyOjgwL2dlb3NlcnZlci93bXM/U0VSVklDRT1XTVMmYW1wOyIvPgogICAgICAgICAgICAgICAgPC9HZXQ+CiAgICAgICAgICAgICAgPC9IVFRQPgogICAgICAgICAgICA8L0RDUFR5cGU+CiAgICAgICAgICA8L0Rlc2NyaWJlTGF5ZXI+CiAgICAgICAgICA8R2V0TGVnZW5kR3JhcGhpYz4KICAgICAgICAgICAgPEZvcm1hdD5pbWFnZS9wbmc8L0Zvcm1hdD4KICAgICAgICAgICAgPERDUFR5cGU+CiAgICAgICAgICAgICAgPEhUVFA+CiAgICAgICAgICAgICAgICA8R2V0PgogICAgICAgICAgICAgICAgICA8T25saW5lUmVzb3VyY2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOnR5cGU9InNpbXBsZSIgeGxpbms6aHJlZj0iaHR0cDovL21hcHMuY3NyLnVmbWcuYnI6ODAvZ2Vvc2VydmVyL3dtcz9TRVJWSUNFPVdNUyZhbXA7Ii8+CiAgICAgICAgICAgICAgICA8L0dldD4KICAgICAgICAgICAgICA8L0hUVFA+CiAgICAgICAgICAgIDwvRENQVHlwZT4KICAgICAgICAgIDwvR2V0TGVnZW5kR3JhcGhpYz4KICAgICAgICAgIDxHZXRTdHlsZXM+CiAgICAgICAgICAgIDxGb3JtYXQ+YXBwbGljYXRpb24vdm5kLm9nYy5zbGQreG1sPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxEQ1BUeXBlPgogICAgICAgICAgICAgIDxIVFRQPgogICAgICAgICAgICAgICAgPEdldD4KICAgICAgICAgICAgICAgICAgPE9ubGluZVJlc291cmNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazp0eXBlPSJzaW1wbGUiIHhsaW5rOmhyZWY9Imh0dHA6Ly9tYXBzLmNzci51Zm1nLmJyOjgwL2dlb3NlcnZlci93bXM/U0VSVklDRT1XTVMmYW1wOyIvPgogICAgICAgICAgICAgICAgPC9HZXQ+CiAgICAgICAgICAgICAgPC9IVFRQPgogICAgICAgICAgICA8L0RDUFR5cGU+CiAgICAgICAgICA8L0dldFN0eWxlcz4KICAgICAgICA8L1JlcXVlc3Q+CiAgICAgICAgPEV4Y2VwdGlvbj4KICAgICAgICAgIDxGb3JtYXQ+YXBwbGljYXRpb24vdm5kLm9nYy5zZV94bWw8L0Zvcm1hdD4KICAgICAgICAgIDxGb3JtYXQ+YXBwbGljYXRpb24vdm5kLm9nYy5zZV9pbmltYWdlPC9Gb3JtYXQ+CiAgICAgICAgPC9FeGNlcHRpb24+CiAgICAgICAgPFZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzPgogICAgICAgICAgPG5vdGVtcHR5Pjwvbm90ZW1wdHk+CiAgICAgICAgPC9WZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcz4KICAgICAgICA8VXNlckRlZmluZWRTeW1ib2xpemF0aW9uIFN1cHBvcnRTTEQ9IjEiIFVzZXJMYXllcj0iMSIgVXNlclN0eWxlPSIxIiBSZW1vdGVXRlM9IjEiLz4KICAgICAgICA8TGF5ZXIgcXVlcnlhYmxlPSIwIiBvcGFxdWU9IjAiIG5vU3Vic2V0cz0iMCI+CiAgICAgICAgICA8VGl0bGU+TWFwU2VydmVyIHZpYSBHSXRIdWI8L1RpdGxlPgogICAgICAgICAgPEFic3RyYWN0PkdpdEh1YiBXTVM8L0Fic3RyYWN0PgogICAgICAgICAgPCEtLUFsbCBzdXBwb3J0ZWQgRVBTRyBwcm9qZWN0aW9uczotLT4KICAgICAgICAgIDxTUlM+RVBTRzozODU3PC9TUlM+CiAgICAgICAgICA8U1JTPkVQU0c6NDMyNjwvU1JTPgogICAgICAgICAgPFNSUz5FUFNHOjkwMDkxMzwvU1JTPgogICAgICAgICAgPFNSUz5FUFNHOjQyMzAzPC9TUlM+CiAgICAgICAgICA8TGF0TG9uQm91bmRpbmdCb3ggbWlueD0iLTE4MC4wMDAwNDA3NDE5OTk5OCIgbWlueT0iLTkwLjAiIG1heHg9IjE4MC4wMDAwMDAwMDAwMDAxIiBtYXh5PSI5MC4wIi8+CiAgICAgICAgPC9MYXllcj4KICAgICAgPC9DYXBhYmlsaXR5PgogICAgPC9XTVRfTVNfQ2FwYWJpbGl0aWVzPicnJwoKICAgICMgQHN0YXRpY21ldGhvZAogICAgIyBkZWYgY29udmVydENvb3JkaW5hdGVQcm9qKGNyc1Byb2osIGZyb21YLCBmcm9tWSwgb3V0cHV0UHJvamVjdGVkKToKICAgICMKICAgICMgICAgIHJlZ2V4ID0gciJeWyBdKlBST0pDUyIKICAgICMgICAgIGlzUHJvamVjdGVkID0gcmUubWF0Y2gocmVnZXgsIGNyc1Byb2opCiAgICAjCiAgICAjICAgICBpZiAoaXNQcm9qZWN0ZWQgYW5kIG91dHB1dFByb2plY3RlZCkgb3IgKCBub3QgaXNQcm9qZWN0ZWQgYW5kICBub3Qgb3V0cHV0UHJvamVjdGVkKToKICAgICMgICAgICAgICByZXR1cm4gKGZyb21YLCBmcm9tWSkKICAgICMgICAgIGVsc2U6CiAgICAjICAgICAgICAgZlByb2ogPSBRZ3NDb29yZGluYXRlUmVmZXJlbmNlU3lzdGVtKCkKICAgICMgICAgICAgICBmUHJvai5jcmVhdGVGcm9tV2t0KGNyc1Byb2opCiAgICAjICAgICAgICAgdFByb2ogPSBRZ3NDb29yZGluYXRlUmVmZXJlbmNlU3lzdGVtKCkKICAgICMgICAgICAgICB0UHJvai5jcmVhdGVGcm9tUHJvajQoIitwcm9qPW1lcmMgK2E9NjM3ODEzNyArYj02Mzc4MTM3ICtsYXRfdHM9MC4wICtsb25fMD0wLjAgK3hfMD0wLjAgK3lfMD0wICtrPTEuMCArdW5pdHM9bSArbmFkZ3JpZHM9QG51bGwgK3drdGV4dCAgK25vX2RlZnMiIGlmIG91dHB1dFByb2plY3RlZCBlbHNlICIrcHJvaj1sb25nbGF0ICtkYXR1bT1XR1M4NCArbm9fZGVmcyAiKQogICAgIyAgICAgICAgIG5ld0Nvb3JkID0gUWdzQ29vcmRpbmF0ZVRyYW5zZm9ybShmUHJvaiwgdFByb2osIFFnc1Byb2plY3QuaW5zdGFuY2UoKSkudHJhbnNmb3JtKFFnc1BvaW50WFkoZnJvbVgsIGZyb21ZKSwgVHJ1ZSkKICAgICMgICAgIHJldHVybiAobmV3Q29vcmQueCwgbmV3Q29vcmQueSkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0TWFwS2V5d29yZChpc1NoYXBlZmlsZSwgbWF4Wm9vbSwgZGxMaW5rPU5vbmUpOgogICAgICAgIGlmIGRsTGluayBpcyBOb25lIG9yIGxlbihkbExpbmspID09IDA6CiAgICAgICAgICAgIGRsTGluayA9ICdkaXNhYmxlZG93bmxvYWQnCiAgICAgICAgZWxpZiAnOicgaW4gZGxMaW5rOgogICAgICAgICAgICBkbExpbmsgPSBkbExpbmtbKGRsTGluay5pbmRleCgnOicpICsgMSk6XQogICAgICAgIGVsaWYgJ8u4JyBpbiBkbExpbms6CiAgICAgICAgICAgIGRsTGluayA9IGRsTGlua1soZGxMaW5rLmluZGV4KCfLuCcpICsgMSk6XQogICAgICAgIHJldHVybiAiZ3JvdXDLuCIgKyAoJ3NocCcgaWYgaXNTaGFwZWZpbGUgZWxzZSAndGlmJykgKyAiy7jLuMu4IiArIGRsTGluayArICLLuG5vdExpc3RpbmfLuMu4bWF4Wm9vbcu4IiArIHN0cihtYXhab29tKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRNYXBEZXNjcmlwdGlvbihsYXllck5hbWVJRCwgbGF5ZXJBdHRyLCBsYXRNaW5YLCBsYXRNaW5ZLCBsYXRNYXhYLCBsYXRNYXhZLCBwcm9qTWluWCwgcHJvak1pblksIHByb2pNYXhYLCBwcm9qTWF4WSwgbWF4Wm9vbSwgaXNTaGFwZWZpbGUsIGRMaW5rKToKICAgICAgICBsYXllckF0dHIgPSBVVElMUy5ub3JtYWxpemVOYW1lKGxheWVyQXR0cikKICAgICAgICBsYXllck5hbWVJRCA9IFVUSUxTLm5vcm1hbGl6ZU5hbWUobGF5ZXJOYW1lSUQpCiAgICAgICAgIyBJbnZlcnRpIG8gbWlueC9taW55IGUgbWF4WC9tYXhZIGRvIGVwc2cgNDMyNiBwcSBlc3RhdmEgdHJvY2FuZG8gbm8gZ2Vvc2VydmVyLCBtYXMgbiBzZWkgcHEgaXNzbyBhY29udGVjZS4KICAgICAgICByZXR1cm4gIiIiPENPTlRFTlQ+CiAgICAgICAgICA8TGF5ZXIgcXVlcnlhYmxlPSIxIiBvcGFxdWU9IjAiPgogICAgICAgICAgPE5hbWU+R0g6IiIiICsgbGF5ZXJOYW1lSUQgKyAiIiI8L05hbWU+CiAgICAgICAgICA8VGl0bGU+IiIiICsgbGF5ZXJOYW1lSUQgKyAiIiI8L1RpdGxlPgogICAgICAgICAgPEFic3RyYWN0PkdIOiIiIiArIGxheWVyTmFtZUlEICsgIiIiIEFCU1RSQUNUPC9BYnN0cmFjdD4KICAgICAgICAgIDxLZXl3b3JkTGlzdD4KICAgICAgICAgICAgPEtleXdvcmQ+IiIiICsgV01TQ2FwYWJpbGl0aWVzLmdldE1hcEtleXdvcmQoaXNTaGFwZWZpbGUsIG1heFpvb20sIGRMaW5rKSArICIiIjwvS2V5d29yZD4KICAgICAgICAgIDwvS2V5d29yZExpc3Q+CiAgICAgICAgICA8U1JTPkVQU0c6NDMyNjwvU1JTPgogICAgICAgICAgPExhdExvbkJvdW5kaW5nQm94IG1pbng9XCIiIiIgKyBzdHIobGF0TWluWCkgKyAiIiJcIiBtaW55PVwiIiIiICsgc3RyKGxhdE1pblkpICsgIiIiXCIgbWF4eD1cIiIiIiArIHN0cigKICAgICAgICAgICAgbGF0TWF4WCkgKyAiIiJcIiBtYXh5PVwiIiIiICsgc3RyKGxhdE1heFkpICsgIiIiXCIvPgogICAgICAgICAgPEJvdW5kaW5nQm94IFNSUz0iRVBTRzo0MzI2IiBtaW54PVwiIiIiICsgc3RyKHByb2pNaW5YKSArICIiIlwiIG1pbnk9XCIiIiIgKyBzdHIoCiAgICAgICAgICAgIHByb2pNaW5ZKSArICIiIlwiIG1heHg9XCIiIiIgKyBzdHIocHJvak1heFgpICsgIiIiXCIgbWF4eT1cIiIiIiArIHN0cihwcm9qTWF4WSkgKyAiIiJcIi8+CiAgICAgICAgICA8U3R5bGU+CiAgICAgICAgICAgPE5hbWU+IiIiICsgbGF5ZXJBdHRyICsgIiIiPC9OYW1lPgogICAgICAgICAgIDxUaXRsZT4iIiIgKyBsYXllckF0dHIgKyAiIiI8L1RpdGxlPgogICAgICAgICAgIDxBYnN0cmFjdC8+CiAgICAgICAgICAgPExlZ2VuZFVSTCB3aWR0aD0iMjAiIGhlaWdodD0iMjAiPgogICAgICAgICAgIDxGb3JtYXQ+aW1hZ2UvcG5nPC9Gb3JtYXQ+CiAgICAgICAgICAgPE9ubGluZVJlc291cmNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazp0eXBlPSJzaW1wbGUiIHhsaW5rOmhyZWY9Imh0dHBzOi8vbWFwcy5jc3IudWZtZy5icjo0NDMvZ2Vvc2VydmVyL3dtcz9yZXF1ZXN0PUdldExlZ2VuZEdyYXBoaWMmYW1wO2Zvcm1hdD1pbWFnZSUyRnBuZyZhbXA7d2lkdGg9MjAmYW1wO2hlaWdodD0yMCZhbXA7bGF5ZXI9IiIiICsgbGF5ZXJOYW1lSUQgKyAiIiJcIi8+CiAgICAgICAgICAgPC9MZWdlbmRVUkw+CiAgICAgICAgICA8L1N0eWxlPgogICAgICAgIDwvTGF5ZXI+CiAgICAgICAgPC9DT05URU5UPgogICAgICAgICIiIgoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRUaWxlU2V0RGVzY3JpcHRpb24oZmlsZU5hbWVJZCwgbGF0TWluWCwgbGF0TWluWSwgbGF0TWF4WCwgbGF0TWF4WSwgcHJvak1pblgsIHByb2pNaW5ZLCBwcm9qTWF4WCwgcHJvak1heFkpOgogICAgICAgICMgPEJvdW5kaW5nQm94IFNSUz0iRVBTRzo0MzI2IiBtaW54PVwiIiIiICsgc3RyKGxhdE1pblgpICsgIiIiXCIgbWlueT1cIiIiIiArIHN0cihsYXRNaW5ZKSArICIiIlwiIG1heHg9XCIiIiIgKyBzdHIobGF0TWF4WCkgKyAiIiJcIiBtYXh5PVwiIiIiICsgc3RyKGxhdE1heFkpICsgIiIiXCIvPgogICAgICAgIHJldHVybiAiIiI8P3htbCB2ZXJzaW9uPVwiMS4wXCIgZW5jb2Rpbmc9XCJVVEYtOFwiPz4KICAgICAgICA8Q09OVEVOVD4KICAgICAgICAgIDxUaWxlU2V0PgogICAgICAgICAgICA8U1JTPkVQU0c6NDMyNjwvU1JTPgogICAgICAgICAgICA8Qm91bmRpbmdCb3ggU1JTPSJFUFNHOjQzMjYiIG1pbng9Ii0xODAuMCIgbWlueT0iLTkwLjAiIG1heHg9IjAuMCIgbWF4eT0iOTAuMCIvPgogICAgICAgIDxSZXNvbHV0aW9ucz4wLjcwMzEyNSAwLjM1MTU2MjUgMC4xNzU3ODEyNSAwLjA4Nzg5MDYyNSAwLjA0Mzk0NTMxMjUgMC4wMjE5NzI2NTYyNSAwLjAxMDk4NjMyODEyNSAwLjAwNTQ5MzE2NDA2MjUgMC4wMDI3NDY1ODIwMzEyNSAwLjAwMTM3MzI5MTAxNTYyNSA2Ljg2NjQ1NTA3ODEyNUUtNCAzLjQzMzIyNzUzOTA2MjVFLTQgMS43MTY2MTM3Njk1MzEyNUUtNCA4LjU4MzA2ODg0NzY1NjI1RS01IDQuMjkxNTM0NDIzODI4MTI1RS01IDIuMTQ1NzY3MjExOTE0MDYyNUUtNSAxLjA3Mjg4MzYwNTk1NzAzMTJFLTUgNS4zNjQ0MTgwMjk3ODUxNTZFLTYgMi42ODIyMDkwMTQ4OTI1NzhFLTYgMS4zNDExMDQ1MDc0NDYyODlFLTYgNi43MDU1MjI1MzcyMzE0NDVFLTcgMy4zNTI3NjEyNjg2MTU3MjI3RS03IDwvUmVzb2x1dGlvbnM+CiAgICAgICAgICAgIDxXaWR0aD4yNTY8L1dpZHRoPgogICAgICAgICAgICA8SGVpZ2h0PjI1NjwvSGVpZ2h0PgogICAgICAgICAgICA8Rm9ybWF0PmltYWdlL3BuZzwvRm9ybWF0PgogICAgICAgICAgICA8TGF5ZXJzPkdIOiIiIiArIGZpbGVOYW1lSWQgKyAiIiI8L0xheWVycz4KICAgICAgICAgICAgPFN0eWxlcy8+CiAgICAgICAgICA8L1RpbGVTZXQ+CiAgICAgICAgICA8VGlsZVNldD4KICAgICAgICAgICAgPFNSUz5FUFNHOjkwMDkxMzwvU1JTPgogICAgICAgICAgICA8Qm91bmRpbmdCb3ggU1JTPSJFUFNHOjkwMDkxMyIgbWlueD0iLTIuMDAzNzUwODM0RTciIG1pbnk9Ii0yLjAwMzc1MDgzNEU3IiBtYXh4PSIyLjAwMzc1MDgzNEU3IiBtYXh5PSIyLjAwMzc1MDgzNEU3Ii8+CiAgICAgICAgPFJlc29sdXRpb25zPjE1NjU0My4wMzM5MDYyNSA3ODI3MS41MTY5NTMxMjUgMzkxMzUuNzU4NDc2NTYyNSAxOTU2Ny44NzkyMzgyODEyNSA5NzgzLjkzOTYxOTE0MDYyNSA0ODkxLjk2OTgwOTU3MDMxMjUgMjQ0NS45ODQ5MDQ3ODUxNTYyIDEyMjIuOTkyNDUyMzkyNTc4MSA2MTEuNDk2MjI2MTk2Mjg5MSAzMDUuNzQ4MTEzMDk4MTQ0NTMgMTUyLjg3NDA1NjU0OTA3MjI2IDc2LjQzNzAyODI3NDUzNjEzIDM4LjIxODUxNDEzNzI2ODA2NiAxOS4xMDkyNTcwNjg2MzQwMzMgOS41NTQ2Mjg1MzQzMTcwMTcgNC43NzczMTQyNjcxNTg1MDggMi4zODg2NTcxMzM1NzkyNTQgMS4xOTQzMjg1NjY3ODk2MjcgMC41OTcxNjQyODMzOTQ4MTM1IDAuMjk4NTgyMTQxNjk3NDA2NzcgMC4xNDkyOTEwNzA4NDg3MDMzOCAwLjA3NDY0NTUzNTQyNDM1MTY5IDAuMDM3MzIyNzY3NzEyMTc1ODQ2IDAuMDE4NjYxMzgzODU2MDg3OTIzIDAuMDA5MzMwNjkxOTI4MDQzOTYxIDAuMDA0NjY1MzQ1OTY0MDIxOTgxIDAuMDAyMzMyNjcyOTgyMDEwOTkwNCAwLjAwMTE2NjMzNjQ5MTAwNTQ5NTIgNS44MzE2ODI0NTUwMjc0NzZFLTQgMi45MTU4NDEyMjc1MTM3MzhFLTQgMS40NTc5MjA2MTM3NTY4NjlFLTQgPC9SZXNvbHV0aW9ucz4KICAgICAgICAgICAgPFdpZHRoPjI1NjwvV2lkdGg+CiAgICAgICAgICAgIDxIZWlnaHQ+MjU2PC9IZWlnaHQ+CiAgICAgICAgICAgIDxGb3JtYXQ+aW1hZ2UvcG5nPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxMYXllcnM+R0g6IiIiICsgZmlsZU5hbWVJZCArICIiIjwvTGF5ZXJzPgogICAgICAgICAgICA8U3R5bGVzLz4KICAgICAgICAgIDwvVGlsZVNldD4KICAgICAgICAgIDwvQ09OVEVOVD4KICAgICAgICAiIiIKICAgICAgICAjIDxCb3VuZGluZ0JveCBTUlM9IkVQU0c6OTAwOTEzIiBtaW54PVwiIiIiICsgc3RyKHByb2pNaW5YKSArICIiIlwiIG1pbnk9XCIiIiIgKyBzdHIocHJvak1pblkpICsgIiIiXCIgbWF4eD1cIiIiIiArIHN0cihwcm9qTWF4WCkgKyAiIiJcIiBtYXh5PVwiIiIiICsgc3RyKHByb2pNYXhZKSArICIiIlwiLz4KCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0QWxsTGF5ZXJzKGNvbnRlbnQsIGxheWVyQXR0cj0nMScpOgogICAgICAgICNGSVhNRSBzaG91bGQgdXNlIHRoZSBzdHlsZSBuYW1lIHRvIGlkZW50aWZ5IHRoZSBsYXllciBhdHRyaWJ1dGVzCiAgICAgICAgZG9jID0geG1sdG9kaWN0LnBhcnNlKGNvbnRlbnQpCiAgICAgICAgYWxsTGF5ZXJzID0gW10KICAgICAgICB0cnk6CiAgICAgICAgICAgIGxheWVyRGVmaW5pdGlvbnMgPSBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddCiAgICAgICAgICAgIGlmIGxheWVyRGVmaW5pdGlvbnMgaXMgbm90IE5vbmUgYW5kIGlzaW5zdGFuY2UobGF5ZXJEZWZpbml0aW9ucywgbGlzdCkgYW5kIGxlbihsYXllckRlZmluaXRpb25zKToKICAgICAgICAgICAgICAgIGFsbExheWVycyA9IFtjdXJMYXllclsiTmFtZSJdIGZvciBjdXJMYXllciBpbiBsYXllckRlZmluaXRpb25zXQogICAgICAgICAgICBlbGlmIGxheWVyRGVmaW5pdGlvbnMgaXMgbm90IE5vbmUgYW5kIGlzaW5zdGFuY2UoZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXSwgY29sbGVjdGlvbnMuT3JkZXJlZERpY3QpIGFuZCBsZW4obGF5ZXJEZWZpbml0aW9ucyk6CiAgICAgICAgICAgICAgICBhbGxMYXllcnMgPSBbbGF5ZXJEZWZpbml0aW9uc1siTmFtZSJdXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvciBhcyBlOgogICAgICAgICAgICBwYXNzCiAgICAgICAgcmV0dXJuIGFsbExheWVycwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRPcGVyYXRpb25zTGlzdEZvckN1c3RvbUxheWVyKGRvY0xheWVyKToKICAgICAgICAjRklYTUUgTsOjbyBkZXZlcmlhIG1vZGlmaWNhciBvIGlucHV0IG51bWEgZnVuY2FvIGRlIGdldAogICAgICAgICNGSVhNRSBjb2RpZ28gZHVwbGljYWRvCiAgICAgICAgaWYgbm90ICJPcGVyYXRpb24iIGluIGRvY0xheWVyOgogICAgICAgICAgICBkb2NMYXllclsiT3BlcmF0aW9uIl0gPSBbXQogICAgICAgIGVsaWYgaXNpbnN0YW5jZShkb2NMYXllclsiT3BlcmF0aW9uIl0sIGNvbGxlY3Rpb25zLk9yZGVyZWREaWN0KToKICAgICAgICAgICAgZG9jTGF5ZXJbIk9wZXJhdGlvbiJdID0gW2RvY0xheWVyWyJPcGVyYXRpb24iXV0KCiAgICAgICAgaWYgbGVuKGRvY0xheWVyWyJPcGVyYXRpb24iXSkgPT0gMDoKICAgICAgICAgICAgcmV0dXJuIFtdCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKGRvY0xheWVyWyJPcGVyYXRpb24iXSwgc3RyKToKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKGpzb24uZHVtcHMoZG9jTGF5ZXIpKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBbeyd0eXBlJzogb3BlcmF0aW9uWyJAdHlwZSJdLCAnYXR0cmlidXRlJzogb3BlcmF0aW9uWyIjdGV4dCJdfSBmb3Igb3BlcmF0aW9uIGluIGRvY0xheWVyWydPcGVyYXRpb24nXV0KCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldEFsbEN1c3RvbUxheWVycyhjb250ZW50LCBsYXllckF0dHI9JzEnKToKICAgICAgICBkb2MgPSB4bWx0b2RpY3QucGFyc2UoY29udGVudCkKICAgICAgICBhbGxDdXN0b21MYXllcnMgPSBbXQogICAgICAgIGlmICdDdXN0b21MYXllcicgIGluIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ106CiAgICAgICAgICAgIGxheWVyRGVmaW5pdGlvbnMgPSBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWydDdXN0b21MYXllciddCgogICAgICAgICAgICBpZiBsYXllckRlZmluaXRpb25zIGlzIG5vdCBOb25lIGFuZCBpc2luc3RhbmNlKGxheWVyRGVmaW5pdGlvbnMsIGNvbGxlY3Rpb25zLk9yZGVyZWREaWN0KToKICAgICAgICAgICAgICAgIGxheWVyRGVmaW5pdGlvbnMgPSBbbGF5ZXJEZWZpbml0aW9uc10KICAgICAgICAgICAgaWYgbGF5ZXJEZWZpbml0aW9ucyBpcyBub3QgTm9uZSBhbmQgaXNpbnN0YW5jZShsYXllckRlZmluaXRpb25zLCBsaXN0KSBhbmQgbGVuKGxheWVyRGVmaW5pdGlvbnMpID4gMDoKICAgICAgICAgICAgICAgIGZvciBjdXJMYXllciBpbiBsYXllckRlZmluaXRpb25zOgogICAgICAgICAgICAgICAgICAgIGZvciBvcGVyYXRpb24gaW4gV01TQ2FwYWJpbGl0aWVzLmdldE9wZXJhdGlvbnNMaXN0Rm9yQ3VzdG9tTGF5ZXIoY3VyTGF5ZXIpOgogICAgICAgICAgICAgICAgICAgICAgICBhbGxDdXN0b21MYXllcnMuYXBwZW5kKGN1ckxheWVyWyJOYW1lIl0gKyAiOyIgKyBvcGVyYXRpb25bJ2F0dHJpYnV0ZSddKQogICAgICAgICAgICAgICAgICAgICAgICAjYWxsQ3VzdG9tTGF5ZXJzLmFwcGVuZChjdXJMYXllclsiTmFtZSJdICsgIjoiICsgb3BlcmF0aW9uWydhdHRyaWJ1dGUnXSArICI6IiArIG9wZXJhdGlvblsndHlwZSddKQogICAgICAgIHJldHVybiBhbGxDdXN0b21MYXllcnMKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0Q3VycmVudENhcGFiaWxpdGllc0RvYyhkaXJlY3RvcnkpOgogICAgICAgIGNhcGFiaWxpdGllc1BhdGggPSBvcy5wYXRoLmpvaW4oZGlyZWN0b3J5LCAiZ2V0Q2FwYWJpbGl0aWVzLnhtbCIpCiAgICAgICAgaWYgb3MucGF0aC5pc2ZpbGUoY2FwYWJpbGl0aWVzUGF0aCk6CiAgICAgICAgICAgIHdpdGggaW8ub3BlbihjYXBhYmlsaXRpZXNQYXRoLCBtb2RlPSJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgY2FwYWJpbGl0aWVzRmlsZToKICAgICAgICAgICAgICAgIGNhcGFiaWxpdGllc0NvbnRlbnQgPSBjYXBhYmlsaXRpZXNGaWxlLnJlYWQoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGNhcGFiaWxpdGllc0NvbnRlbnQgPSBXTVNDYXBhYmlsaXRpZXMuZ2V0RGVmYXVsdENhcGFiaWxpdGllcygpCiAgICAgICAgZG9jID0geG1sdG9kaWN0LnBhcnNlKGNhcGFiaWxpdGllc0NvbnRlbnQpCiAgICAgICAgcmV0dXJuIGRvYwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBzYXZlQ3VycmVudENhcGFiaWxpdGllcyhkaXJlY3RvcnksIGRvYyk6CiAgICAgICAgY2FwYWJpbGl0aWVzUGF0aCA9IG9zLnBhdGguam9pbihkaXJlY3RvcnksICJnZXRDYXBhYmlsaXRpZXMueG1sIikKICAgICAgICB3aXRoIGlvLm9wZW4oY2FwYWJpbGl0aWVzUGF0aCwgbW9kZT0idyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGNhcGFiaWxpdGllc0ZpbGU6CiAgICAgICAgICAgIGNhcGFiaWxpdGllc0ZpbGUud3JpdGUoeG1sdG9kaWN0LnVucGFyc2UoZG9jLCBwcmV0dHk9VHJ1ZSkpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldEN1c3RvbUxheWVyRGVmYXVsdERlZmluaXRpb24obGF5ZXJOYW1lKToKICAgICAgICBsYXllck5hbWUgPSBVVElMUy5ub3JtYWxpemVOYW1lKGxheWVyTmFtZSkKICAgICAgICByZXR1cm4geG1sdG9kaWN0LnBhcnNlKCIiIjw/eG1sIHZlcnNpb249XCIxLjBcIiBlbmNvZGluZz1cIlVURi04XCI/PgogICAgICAgICAgICA8Q09OVEVOVD4KICAgICAgICAgICAgICAgIDxOYW1lPkdIOiIiIiArIGxheWVyTmFtZSArICIiIjwvTmFtZT4KICAgICAgICAgICAgICAgIDxUaXRsZT4iIiIrbGF5ZXJOYW1lICsiIiI8L1RpdGxlPgogICAgICAgICAgICA8L0NPTlRFTlQ+IiIiKVsiQ09OVEVOVCJdCgogICAgI2N1c3RvbURvYyDDqSB1bSBEaWN0IHZpbmRvIGRvIHhtbHRvZGljdC4gbGF5ZXJBdHRyIGUgb3BlcmF0aW9uIHPDo28gc3RyaW5ncwogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGFkZE9wZXJhdGlvbihjdXN0b21Eb2MsIGxheWVyQXR0ciwgb3BlcmF0aW9uKToKICAgICAgICBsYXllckF0dHIgPSBVVElMUy5ub3JtYWxpemVOYW1lKGxheWVyQXR0cikKICAgICAgICBpZiBub3QgIk9wZXJhdGlvbiIgaW4gY3VzdG9tRG9jOgogICAgICAgICAgICBjdXN0b21Eb2NbIk9wZXJhdGlvbiJdID0gbGlzdCgpCiAgICAgICAgaWYgaXNpbnN0YW5jZShjdXN0b21Eb2NbIk9wZXJhdGlvbiJdLCBjb2xsZWN0aW9ucy5PcmRlcmVkRGljdCk6CiAgICAgICAgICAgIGN1c3RvbURvY1siT3BlcmF0aW9uIl0gPSBbY3VzdG9tRG9jWyJPcGVyYXRpb24iXV0KCiAgICAgICAgZm91bmQgPSBGYWxzZQogICAgICAgIGZvciBjdXJPcGVyYXRpb25EaWN0IGluIGN1c3RvbURvY1siT3BlcmF0aW9uIl06CiAgICAgICAgICAgIGlmIG5vdCBmb3VuZCBhbmQgJ0B0eXBlJyBpbiBjdXJPcGVyYXRpb25EaWN0IGFuZCBjdXJPcGVyYXRpb25EaWN0WydAdHlwZSddID09IG9wZXJhdGlvbiBhbmQgY3VyT3BlcmF0aW9uRGljdFsnI3RleHQnXSA9PSBsYXllckF0dHI6CiAgICAgICAgICAgICAgICBmb3VuZCA9IFRydWUKICAgICAgICBpZiBub3QgZm91bmQ6CiAgICAgICAgICAgIGN1c3RvbURvY1snT3BlcmF0aW9uJ10uYXBwZW5kKHhtbHRvZGljdC5wYXJzZSgiIiI8P3htbCB2ZXJzaW9uPVwiMS4wXCIgZW5jb2Rpbmc9XCJVVEYtOFwiPz4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxDT05URU5UPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPE9wZXJhdGlvbiB0eXBlPVwiIiIiICsgb3BlcmF0aW9uICsgIiIiXCI+IiIiICsgbGF5ZXJBdHRyICsgIiIiPC9PcGVyYXRpb24+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L0NPTlRFTlQ+IiIiKVsiQ09OVEVOVCJdWyJPcGVyYXRpb24iXSkKICAgICAgICByZXR1cm4gY3VzdG9tRG9jCgoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiB1cGRhdGVDdXN0b21YTUwoZGlyZWN0b3J5LCBsYXllclRpdGxlLCBsYXllckF0dHIsIG9wZXJhdGlvbik6CiAgICAgICAgZG9jID0gV01TQ2FwYWJpbGl0aWVzLmdldEN1cnJlbnRDYXBhYmlsaXRpZXNEb2MoZGlyZWN0b3J5KQogICAgICAgIGZpbGVuYW1lID0gVVRJTFMubm9ybWFsaXplTmFtZShsYXllclRpdGxlKSAgIyBsYXllciBOYW1lIG5vIHFnaXMKCiAgICAgICAgaWYgJ0N1c3RvbUxheWVyJyBpbiBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddOgogICAgICAgICAgICBpZiB0eXBlKGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bIkN1c3RvbUxheWVyIl0pIGlzIGNvbGxlY3Rpb25zLk9yZGVyZWREaWN0OgogICAgICAgICAgICAgICAgY3VyTGF5ZXIgPSBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWyJDdXN0b21MYXllciJdCiAgICAgICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWyJDdXN0b21MYXllciJdID0gW2N1ckxheWVyXQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bJ0N1c3RvbUxheWVyJ10gPSBbXQoKICAgICAgICBjdXJMYXllckRlZmluaXRpb24gPSBOb25lCiAgICAgICAgaWYgJ0N1c3RvbUxheWVyJyBpbiBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddOgogICAgICAgICAgICBmb3IgaUxheWVyIGluIHJhbmdlKGxlbihkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWyJDdXN0b21MYXllciJdKSAtIDEsIC0xLCAtMSk6CiAgICAgICAgICAgICAgICBjdXJMYXllciA9IGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bIkN1c3RvbUxheWVyIl1baUxheWVyXQogICAgICAgICAgICAgICAgaWYgIk5hbWUiIGluIGN1ckxheWVyIGFuZCBmaWxlbmFtZSBpbiBjdXJMYXllclsiTmFtZSJdOgogICAgICAgICAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bIkN1c3RvbUxheWVyIl0ucG9wKGlMYXllcikKICAgICAgICAgICAgICAgICAgICBjdXJMYXllckRlZmluaXRpb24gPSBjdXJMYXllcgogICAgICAgICAgICAgICAgICAgICNUT0RPIHZlcmlmaWNhciBzZSBuw6NvIHJlc3RhcmFtIG91dHJvcyBjb20gbWVzbW8gbm9tZS4KICAgICAgICBpZiBjdXJMYXllckRlZmluaXRpb24gaXMgTm9uZToKICAgICAgICAgICAgY3VyTGF5ZXJEZWZpbml0aW9uID0gV01TQ2FwYWJpbGl0aWVzLmdldEN1c3RvbUxheWVyRGVmYXVsdERlZmluaXRpb24oZmlsZW5hbWUpCiAgICAgICAgV01TQ2FwYWJpbGl0aWVzLmFkZE9wZXJhdGlvbihjdXJMYXllckRlZmluaXRpb24sIGxheWVyQXR0ciwgb3BlcmF0aW9uKQogICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bIkN1c3RvbUxheWVyIl0uYXBwZW5kKGN1ckxheWVyRGVmaW5pdGlvbikKICAgICAgICBXTVNDYXBhYmlsaXRpZXMuc2F2ZUN1cnJlbnRDYXBhYmlsaXRpZXMoZGlyZWN0b3J5LCBkb2MpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHNldENhcGFiaWxpdGllc0RlZmF1bHRNYXhab29tKGRpcmVjdG9yeSk6CiAgICAgICAgZG9jID0gV01TQ2FwYWJpbGl0aWVzLmdldEN1cnJlbnRDYXBhYmlsaXRpZXNEb2MoZGlyZWN0b3J5KQoKICAgICAgICBpZiAnTGF5ZXInIGluIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ106CiAgICAgICAgICAgIGlmIHR5cGUoZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXSkgaXMgY29sbGVjdGlvbnMuT3JkZXJlZERpY3Q6CiAgICAgICAgICAgICAgICBjdXJMYXllciA9IGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10KICAgICAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10gPSBbY3VyTGF5ZXJdCgogICAgICAgIGlmICdMYXllcicgaW4gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXToKICAgICAgICAgICAgZm9yIGlMYXllciBpbiByYW5nZShsZW4oZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXSkgLSAxLCAtMSwgLTEpOgogICAgICAgICAgICAgICAgY3VyTGF5ZXIgPSBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddW2lMYXllcl0KICAgICAgICAgICAgICAgIGlmICJLZXl3b3JkTGlzdCIgaW4gY3VyTGF5ZXIgYW5kIHR5cGUoY3VyTGF5ZXJbJ0tleXdvcmRMaXN0J10pIGlzIGNvbGxlY3Rpb25zLk9yZGVyZWREaWN0IGFuZCAoIktleXdvcmQiIGluIGN1ckxheWVyWydLZXl3b3JkTGlzdCddKSBhbmQgY3VyTGF5ZXJbJ0tleXdvcmRMaXN0J11bJ0tleXdvcmQnXSA9PSAnR0lUSFVCJzoKICAgICAgICAgICAgICAgICAgICBjdXJMYXllclsnS2V5d29yZExpc3QnXVsnS2V5d29yZCddID0gV01TQ2FwYWJpbGl0aWVzLmdldE1hcEtleXdvcmQoRmFsc2UsIDgpCiAgICAgICAgV01TQ2FwYWJpbGl0aWVzLnNhdmVDdXJyZW50Q2FwYWJpbGl0aWVzKGRpcmVjdG9yeSwgZG9jKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiB1cGRhdGVYTUwoZGlyZWN0b3J5LCBsYXllckV4dGVudHMsIGxheWVyTWVyY2F0b3JFeHRlbnRzLCBpc1NoYXBlZmlsZSwgbGF5ZXJUaXRsZSwgbGF5ZXJBdHRyLCBtYXhab29tLCBkb3dubG9hZExpbmspOgogICAgICAgIGRvYyA9IFdNU0NhcGFiaWxpdGllcy5nZXRDdXJyZW50Q2FwYWJpbGl0aWVzRG9jKGRpcmVjdG9yeSkKCiAgICAgICAgZmlsZW5hbWUgPSBVVElMUy5ub3JtYWxpemVOYW1lKGxheWVyVGl0bGUpICNsYXllciBOYW1lIG5vIHFnaXMKCiAgICAgICAgYXNzZXJ0IGlzaW5zdGFuY2UobGF5ZXJFeHRlbnRzLCBXTVNCQm94KSBhbmQgaXNpbnN0YW5jZShsYXllck1lcmNhdG9yRXh0ZW50cywgV01TQkJveCkKCiAgICAgICAgIyAjZXh0ZW50cywgcHJvamVjdGlvbgogICAgICAgICMgcHJvak1heFggPSBsYXllci5leHRlbnQoKS54TWF4aW11bSgpCiAgICAgICAgcHJvak1heFggPSBsYXllckV4dGVudHMueE1heGltdW0oKQogICAgICAgICMgcHJvak1pblggPSBsYXllci5leHRlbnQoKS54TWluaW11bSgpCiAgICAgICAgcHJvak1pblggPSBsYXllckV4dGVudHMueE1pbmltdW0oKQogICAgICAgICMgcHJvak1heFkgPSBsYXllci5leHRlbnQoKS55TWF4aW11bSgpCiAgICAgICAgcHJvak1heFkgPSBsYXllckV4dGVudHMueU1heGltdW0oKQogICAgICAgICMgcHJvak1pblkgPSBsYXllci5leHRlbnQoKS55TWluaW11bSgpCiAgICAgICAgcHJvak1pblkgPSBsYXllckV4dGVudHMueU1pbmltdW0oKQogICAgICAgICMgbGxFeHRlbnQgPSBVVElMUy5nZXRNYXBFeHRlbnQobGF5ZXIsIFFnc0Nvb3JkaW5hdGVSZWZlcmVuY2VTeXN0ZW0oJ0VQU0c6NDMyNicpKQogICAgICAgICMgbGF0TWF4WCA9IGxsRXh0ZW50LnhNYXhpbXVtKCkKICAgICAgICBsYXRNYXhYID0gbGF5ZXJNZXJjYXRvckV4dGVudHMueE1heGltdW0oKQogICAgICAgICMgbGF0TWluWCA9IGxsRXh0ZW50LnhNaW5pbXVtKCkKICAgICAgICBsYXRNaW5YID0gbGF5ZXJNZXJjYXRvckV4dGVudHMueE1pbmltdW0oKQogICAgICAgICMgbGF0TWF4WSA9IGxsRXh0ZW50LnlNYXhpbXVtKCkKICAgICAgICBsYXRNYXhZID0gbGF5ZXJNZXJjYXRvckV4dGVudHMueU1heGltdW0oKQogICAgICAgICMgbGF0TWluWSA9IGxsRXh0ZW50LnlNaW5pbXVtKCkKICAgICAgICBsYXRNaW5ZID0gbGF5ZXJNZXJjYXRvckV4dGVudHMueU1pbmltdW0oKQogICAgICAgICNpc1NoYXBlZmlsZSA9IChpc2luc3RhbmNlKGxheWVyLCBRZ3NWZWN0b3JMYXllcikpCgoKICAgICAgICBpZiAnTGF5ZXInIGluIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ106CiAgICAgICAgICAgIGlmIHR5cGUoZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXSkgaXMgY29sbGVjdGlvbnMuT3JkZXJlZERpY3Q6CiAgICAgICAgICAgICAgICBjdXJMYXllciA9IGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10KICAgICAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10gPSBbY3VyTGF5ZXJdCgogICAgICAgIGlmICdMYXllcicgaW4gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXToKICAgICAgICAgICAgZm9yIGlMYXllciBpbiByYW5nZShsZW4oZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXSkgLSAxLCAtMSwgLTEpOgogICAgICAgICAgICAgICAgY3VyTGF5ZXIgPSBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddW2lMYXllcl0KICAgICAgICAgICAgICAgIGlmICJOYW1lIiBpbiBjdXJMYXllciBhbmQgY3VyTGF5ZXJbIk5hbWUiXSA9PSAiR0g6IiArIGZpbGVuYW1lOgogICAgICAgICAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10ucG9wKGlMYXllcikKCiAgICAgICAgI0ZJWE1FIE9uZSBhdHRyaWJ1dGUgb25seS4gKElzIGFsd2F5cyBvdmVyd3JpdGluZykKICAgICAgICBuZXdMYXllckRlc2NyaXB0aW9uID0geG1sdG9kaWN0LnBhcnNlKAogICAgICAgICAgICBXTVNDYXBhYmlsaXRpZXMuZ2V0TWFwRGVzY3JpcHRpb24oZmlsZW5hbWUsIGxheWVyQXR0ciwgbGF0TWluWCwgbGF0TWluWSwgbGF0TWF4WCwgbGF0TWF4WSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2pNaW5YLCBwcm9qTWluWSwgcHJvak1heFgsIHByb2pNYXhZLCBtYXhab29tLCBpc1NoYXBlZmlsZSwgZG93bmxvYWRMaW5rKSlbJ0NPTlRFTlQnXQogICAgICAgIGlmICdMYXllcicgaW4gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXToKICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXS5hcHBlbmQobmV3TGF5ZXJEZXNjcmlwdGlvblsnTGF5ZXInXSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddID0gbmV3TGF5ZXJEZXNjcmlwdGlvbgoKICAgICAgICBuZXdUaWxlU2V0RGVzY3JpcHRpb24gPSB4bWx0b2RpY3QucGFyc2UoCiAgICAgICAgICAgIFdNU0NhcGFiaWxpdGllcy5nZXRUaWxlU2V0RGVzY3JpcHRpb24oZmlsZW5hbWUsIGxhdE1pblgsIGxhdE1pblksIGxhdE1heFgsIGxhdE1heFksIHByb2pNaW5YLCBwcm9qTWluWSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9qTWF4WCwgcHJvak1heFkpKVsnQ09OVEVOVCddCgogICAgICAgIGlmIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ10gaXMgbm90IE5vbmUgYW5kICdUaWxlU2V0JyBpbiBcCiAgICAgICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddOgogICAgICAgICAgICBpZiB0eXBlKGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bCiAgICAgICAgICAgICAgICAgICAgICAgICdUaWxlU2V0J10pIGlzIGNvbGxlY3Rpb25zLk9yZGVyZWREaWN0OgogICAgICAgICAgICAgICAgY3VyVGlsZVNldCA9IGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bJ1RpbGVTZXQnXQogICAgICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsnVGlsZVNldCddID0gWwogICAgICAgICAgICAgICAgICAgIGN1clRpbGVTZXRdICAjIFRyYW5zZm9ybXMgaW50byBhIGxpc3QKCiAgICAgICAgaWYgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXSBpcyBub3QgTm9uZSBhbmQgJ1RpbGVTZXQnIGluIFwKICAgICAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ106CiAgICAgICAgICAgIGZvciBpVGlsZVNldCBpbiByYW5nZSgKICAgICAgICAgICAgICAgICAgICBsZW4oZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsnVGlsZVNldCddKSAtIDEsCiAgICAgICAgICAgICAgICAgICAgLTEsIC0xKToKICAgICAgICAgICAgICAgIGN1clRpbGVTZXQgPSBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWydUaWxlU2V0J11baVRpbGVTZXRdCiAgICAgICAgICAgICAgICBpZiAiTGF5ZXJzIiBpbiBjdXJUaWxlU2V0IGFuZCBjdXJUaWxlU2V0WyJMYXllcnMiXSA9PSAiR0g6IiArIGZpbGVuYW1lOgogICAgICAgICAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bJ1RpbGVTZXQnXS5wb3AoaVRpbGVTZXQpCiAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bJ1RpbGVTZXQnXSArPSBuZXdUaWxlU2V0RGVzY3JpcHRpb25bCiAgICAgICAgICAgICAgICAnVGlsZVNldCddICAjIERvaXMgZWxlbWVudG9zIGMgbWVzbWEgY2hhdmUgcmVwcmVzZW50YSBjb20gbGlzdGEKICAgICAgICBlbHNlOgogICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddID0gbmV3VGlsZVNldERlc2NyaXB0aW9uCiAgICAgICAgV01TQ2FwYWJpbGl0aWVzLnNhdmVDdXJyZW50Q2FwYWJpbGl0aWVzKGRpcmVjdG9yeSwgZG9jKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiB3cml0ZV9kZXNjcmlwdGlvbihkaXJlY3RvcnksIGxheWVyVGl0bGUsIGxheWVyQXR0ciwgY2VsbFR5cGVOYW1lLCBudWxsVmFsdWUsIG9wZXJhdGlvbik6CiAgICAgICAgbGF5ZXJUaXRsZSA9IFVUSUxTLm5vcm1hbGl6ZU5hbWUobGF5ZXJUaXRsZSkKICAgICAgICBjZWxsVHlwZU5hbWUgPSBVVElMUy5ub3JtYWxpemVOYW1lKGNlbGxUeXBlTmFtZSkKICAgICAgICBmaWxlY3N2ID0gImRlc2NyaXB0aW9uLmNzdiIKICAgICAgICBjc3ZQYXRoID0gb3MucGF0aC5qb2luKGRpcmVjdG9yeSwgZmlsZWNzdikKICAgICAgICBqc29uUGF0aCA9IG9zLnBhdGguam9pbihkaXJlY3RvcnksICJkZXNjcmlwdGlvbi5qc29uIikKICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShjc3ZQYXRoKToKICAgICAgICAgICAgY3N2RmlsZSA9IG9wZW4oY3N2UGF0aCwgInIiLCBlbmNvZGluZz0idXRmLTgiKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGNzdkZpbGUgPSBpby5TdHJpbmdJTygiS2V5KiwgY2VsbCwgbnVsbCwgb3BlcmF0aW9uLCBhdHRyLFxuLTk5OTksIFwiXCIsIC0xLCBcIlwiLCBuZW5odW1hLCAiKQoKICAgICAgICBjc3ZfcmVhZGVyID0gY3N2LkRpY3RSZWFkZXIoY3N2RmlsZSwgZGVsaW1pdGVyPScsJykKICAgICAgICBsaW5lX2NvdW50ID0gMAogICAgICAgIGVsZW1lbnRzID0gW2NlbGxUeXBlTmFtZSwgc3RyKG51bGxWYWx1ZSksIG9wZXJhdGlvbiwgbGF5ZXJBdHRyXQogICAgICAgIGZvciByb3cgaW4gY3N2X3JlYWRlcjoKICAgICAgICAgICAgY3VyRW50cnkgPSB7CiAgICAgICAgICAgICAgICAnY2VsbFR5cGUnOiByb3dbJyBjZWxsJ10uc3RyaXAoKSwKICAgICAgICAgICAgICAgICdudWxsVmFsdWUnOiByb3dbJyBudWxsJ10uc3RyaXAoKSwKICAgICAgICAgICAgICAgICdvcGVyYXRpb24nOiByb3dbJyBvcGVyYXRpb24nXS5zdHJpcCgpLAogICAgICAgICAgICAgICAgJ2F0dHJpYnV0ZSc6IHJvd1snIGF0dHInXS5zdHJpcCgpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgbGluZV9jb3VudCA+IDAgYW5kIGN1ckVudHJ5WydvcGVyYXRpb24nXSAhPSBvcGVyYXRpb24gYW5kIGN1ckVudHJ5WydhdHRyaWJ1dGUnXSAhPSBsYXllckF0dHI6CiAgICAgICAgICAgICAgICAjIEtleSAqLCBjZWxsLCBudWxsLCBvcGVyYXRpb24sIGF0dHIsCiAgICAgICAgICAgICAgICBlbGVtZW50cy5hcHBlbmQoY3VyRW50cnlbJ2NlbGxUeXBlJ10pCiAgICAgICAgICAgICAgICBlbGVtZW50cy5hcHBlbmQoY3VyRW50cnlbJ251bGxWYWx1ZSddKQogICAgICAgICAgICAgICAgZWxlbWVudHMuYXBwZW5kKGN1ckVudHJ5WydvcGVyYXRpb24nXSkKICAgICAgICAgICAgICAgIGVsZW1lbnRzLmFwcGVuZChjdXJFbnRyeVsnYXR0cmlidXRlJ10pCiAgICAgICAgICAgIGxpbmVfY291bnQgKz0gMQogICAgICAgIHdpdGggb3Blbihqc29uUGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBqc29uRmlsZToKICAgICAgICAgICAganNvbkZpbGUud3JpdGUoanNvbi5kdW1wcyhlbGVtZW50cykpCiAgICAgICAgY3N2RmlsZS5jbG9zZSgpCgpjbGFzcyBXTVNCQm94KCk6CiAgICB4TWF4ID0gTm9uZQogICAgZGVmIHhNYXhpbXVtKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLnhNYXgKCiAgICB4TWluID0gTm9uZQogICAgZGVmIHhNaW5pbXVtKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLnhNaW4KCiAgICB5TWF4ID0gTm9uZQogICAgZGVmIHlNYXhpbXVtKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLnlNYXgKCiAgICB5TWluID0gTm9uZQogICAgZGVmIHlNaW5pbXVtKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLnlNaW4KCiAgICBkZWYgX19pbml0X18oc2VsZiwgeE1heCwgeE1pbiwgeU1heCwgeU1pbik6CiAgICAgICAgc2VsZi54TWF4ID0geE1heAogICAgICAgIHNlbGYueE1pbiA9IHhNaW4KICAgICAgICBzZWxmLnlNYXggPSB5TWF4CiAgICAgICAgc2VsZi55TWluID0geU1pbgoKCgp0cnk6CiAgICBmcm9tIEdEQUxfVVRJTFMgaW1wb3J0IEdEQUxfVVRJTFMKZXhjZXB0OgogICAgcGFzcyAjTm90IGluIERpbmFtaWNhIENvZGUKCmZyb20gb3NnZW8gaW1wb3J0IGdkYWwsb2dyLG9zcgoKI1RoYW5rcyB0byBodHRwczovL2dpcy5zdGFja2V4Y2hhbmdlLmNvbS9xdWVzdGlvbnMvNTc4MzQvaG93LXRvLWdldC1yYXN0ZXItY29ybmVyLWNvb3JkaW5hdGVzLXVzaW5nLXB5dGhvbi1nZGFsLWJpbmRpbmdzCmNsYXNzIEdEQUxfVVRJTFM6CgogICAgI0RhbmlsbyB2YWkgNCBwb250b3MgW0xlZnQgQm90dG9tLCAgTGVmdCBUb3AsIFJpZ2h0IEJvdHRvbSwgUmlnaHQgVG9wXQogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIF9nZXRFeHRlbnQoZ3QsY29scyxyb3dzKToKICAgICAgICAnJycgUmV0dXJuIGxpc3Qgb2YgY29ybmVyIGNvb3JkaW5hdGVzIGZyb20gYSBnZW90cmFuc2Zvcm0KCiAgICAgICAgICAgIEB0eXBlIGd0OiAgIEN7dHVwbGUvbGlzdH0KICAgICAgICAgICAgQHBhcmFtIGd0OiBnZW90cmFuc2Zvcm0KICAgICAgICAgICAgQHR5cGUgY29sczogICBDe2ludH0KICAgICAgICAgICAgQHBhcmFtIGNvbHM6IG51bWJlciBvZiBjb2x1bW5zIGluIHRoZSBkYXRhc2V0CiAgICAgICAgICAgIEB0eXBlIHJvd3M6ICAgQ3tpbnR9CiAgICAgICAgICAgIEBwYXJhbSByb3dzOiBudW1iZXIgb2Ygcm93cyBpbiB0aGUgZGF0YXNldAogICAgICAgICAgICBAcnR5cGU6ICAgIEN7W2Zsb2F0LC4uLixmbG9hdF19CiAgICAgICAgICAgIEByZXR1cm46ICAgY29vcmRpbmF0ZXMgb2YgZWFjaCBjb3JuZXIKICAgICAgICAnJycKICAgICAgICBleHQ9W10KICAgICAgICB4YXJyPVswLGNvbHNdCiAgICAgICAgeWFycj1bMCxyb3dzXQoKICAgICAgICBmb3IgcHggaW4geGFycjoKICAgICAgICAgICAgZm9yIHB5IGluIHlhcnI6CiAgICAgICAgICAgICAgICB4PWd0WzBdKyhweCpndFsxXSkrKHB5Kmd0WzJdKQogICAgICAgICAgICAgICAgeT1ndFszXSsocHgqZ3RbNF0pKyhweSpndFs1XSkKICAgICAgICAgICAgICAgIGV4dC5hcHBlbmQoW3gseV0pCiAgICAgICAgICAgICAgICBwcmludCh4LHkpCiAgICAgICAgICAgIHlhcnIucmV2ZXJzZSgpCiAgICAgICAgcmV0dXJuIGV4dAoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfcmVwcm9qZWN0Q29vcmRzKGNvb3JkcyxzcmNfc3JzLHRndF9zcnMpOgogICAgICAgICcnJyBSZXByb2plY3QgYSBsaXN0IG9mIHgseSBjb29yZGluYXRlcy4KCiAgICAgICAgICAgIEB0eXBlIGdlb206ICAgICBDe3R1cGxlL2xpc3R9CiAgICAgICAgICAgIEBwYXJhbSBnZW9tOiAgICBMaXN0IG9mIFtbeCx5XSwuLi5beCx5XV0gY29vcmRpbmF0ZXMKICAgICAgICAgICAgQHR5cGUgc3JjX3NyczogIEN7b3NyLlNwYXRpYWxSZWZlcmVuY2V9CiAgICAgICAgICAgIEBwYXJhbSBzcmNfc3JzOiBPU1IgU3BhdGlhbFJlZmVyZW5jZSBvYmplY3QKICAgICAgICAgICAgQHR5cGUgdGd0X3NyczogIEN7b3NyLlNwYXRpYWxSZWZlcmVuY2V9CiAgICAgICAgICAgIEBwYXJhbSB0Z3Rfc3JzOiBPU1IgU3BhdGlhbFJlZmVyZW5jZSBvYmplY3QKICAgICAgICAgICAgQHJ0eXBlOiAgICAgICAgIEN7dHVwbGUvbGlzdH0KICAgICAgICAgICAgQHJldHVybjogICAgICAgIExpc3Qgb2YgdHJhbnNmb3JtZWQgW1t4LHldLC4uLlt4LHldXSBjb29yZGluYXRlcwogICAgICAgICcnJwogICAgICAgIHRyYW5zX2Nvb3Jkcz1bXQogICAgICAgIHRyYW5zZm9ybSA9IG9zci5Db29yZGluYXRlVHJhbnNmb3JtYXRpb24oIHNyY19zcnMsIHRndF9zcnMpCiAgICAgICAgZm9yIHgseSBpbiBjb29yZHM6CiAgICAgICAgICAgIHgseSx6ID0gdHJhbnNmb3JtLlRyYW5zZm9ybVBvaW50KHgseSkKICAgICAgICAgICAgdHJhbnNfY29vcmRzLmFwcGVuZChbeCx5XSkKICAgICAgICByZXR1cm4gdHJhbnNfY29vcmRzCgogICAgI2RhbmlsbyBzZSBvIGVwc2dDb2RlIMOpIE5vbmUgcmV0b3JuYSBvIGRvIHByw7NwcmlvIG1hcGEgc2VtIGFsdGVyYXIuCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0RXh0ZW50KHJhc3RlclBhdGgsIGVwc2dDb2RlPU5vbmUpOgogICAgICAgIGRzID0gZ2RhbC5PcGVuKHJhc3RlclBhdGgsIGdkYWwuR0FfUmVhZE9ubHkpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBndCA9IGRzLkdldEdlb1RyYW5zZm9ybSgpCiAgICAgICAgICAgIGNvbHMgPSBkcy5SYXN0ZXJYU2l6ZQogICAgICAgICAgICByb3dzID0gZHMuUmFzdGVyWVNpemUKICAgICAgICAgICAgZXh0ID0gR0RBTF9VVElMUy5fZ2V0RXh0ZW50KGd0LCBjb2xzLCByb3dzKQogICAgICAgICAgICBpZiBlcHNnQ29kZSBpcyBOb25lOgogICAgICAgICAgICAgICAgcmV0dXJuIEdEQUxfVVRJTFMuZ2V0QXJyYXlGcm9tRXh0KGV4dCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNyY19zcnM9b3NyLlNwYXRpYWxSZWZlcmVuY2UoKQogICAgICAgICAgICAgICAgc3JjX3Nycy5JbXBvcnRGcm9tV2t0KGRzLkdldFByb2plY3Rpb24oKSkKICAgICAgICAgICAgICAgIHRndF9zcnMgPSBvc3IuU3BhdGlhbFJlZmVyZW5jZSgpCiAgICAgICAgICAgICAgICB0Z3Rfc3JzLkltcG9ydEZyb21FUFNHKGVwc2dDb2RlKQogICAgICAgICAgICAgICAgcmV0dXJuIEdEQUxfVVRJTFMuZ2V0QXJyYXlGcm9tRXh0KEdEQUxfVVRJTFMuX3JlcHJvamVjdENvb3JkcyhleHQsc3JjX3Nycyx0Z3Rfc3JzKSkKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICBkcyA9IE5vbmUKCiAgICAjUmV0b3JuYSB4TWF4LCB4TWluLCB5TWF4LCB5TWluIGRvIGV4dGVudHMuCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0QXJyYXlGcm9tRXh0KGV4dCk6CiAgICAgICAgbWF4UG9pbnQgPSBleHRbM10KICAgICAgICBtaW5Qb2ludCA9IGV4dFsxXQogICAgICAgIHJldHVybiAobWF4UG9pbnRbMF0sIG1pblBvaW50WzBdLCBtYXhQb2ludFsxXSwgbWluUG9pbnRbMV0pCgogICAgIyBAc3RhdGljbWV0aG9kCiAgICAjICNQZWdhIGFzIGluZm9ybWFjb2VzIGRlIGNlbHVsYSBkaXJldG8gZG8gcmFzdGVyLCB1c2FuZG8gbyBHREFMLgogICAgIyBkZWYgZ2V0UmFzdGVyQ2VsbEluZm8obWFwRGF0YVBhdGgpOgogICAgIyAgICAgIyBjZWxsSW5mbyA9IGRpY3QoKQogICAgIyAgICAgIyAjIGlmIFV0aWxzLmlzUmFzdGVyRmlsZShzZWxmLl9fbWFwRGF0YVBhdGgpIDoKICAgICMgICAgICMgaERhdGFzZXQgPSBnZGFsLk9wZW4obWFwRGF0YVBhdGgsIGdkYWwuR0FfUmVhZE9ubHkpCiAgICAjICAgICAjIHRyeToKICAgICMgICAgICMgICAgIGlmIGhEYXRhc2V0IGlzIG5vdCBOb25lIGFuZCBoRGF0YXNldC5SYXN0ZXJDb3VudCA+IDAgOgogICAgIyAgICAgIyAgICAgICAgIGN1ckJhbmQgPSBoRGF0YXNldC5HZXRSYXN0ZXJCYW5kKDEpCiAgICAjICAgICAjICAgICAgICAgdW5pY29kZShnZGFsLkdldERhdGFUeXBlTmFtZShjdXJCYW5kLkRhdGFUeXBlKSkKICAgICMgICAgICMgICAgICAgICBjZWxsSW5mb1t1Ik51bGwgQ2VsbCBWYWx1ZSJdID0gdW5pY29kZShjdXJCYW5kLkdldE5vRGF0YVZhbHVlKCkpCiAgICAjICAgICAjICAgICAgICAgY2VsbEluZm9bdSJOdW1iZXIgb2YgTGluZXMiXSA9IHVuaWNvZGUoaERhdGFzZXQuUmFzdGVyWVNpemUpCiAgICAjICAgICAjICAgICAgICAgY2VsbEluZm9bdSJOdW1iZXIgb2YgQ29sdW1ucyJdID0gdW5pY29kZShoRGF0YXNldC5SYXN0ZXJYU2l6ZSkKICAgICMgICAgICMgICAgICAgICBhZGZHZW9UcmFuc2Zvcm0gPSBoRGF0YXNldC5HZXRHZW9UcmFuc2Zvcm0oY2FuX3JldHVybl9udWxsID0gVHJ1ZSkKICAgICMgICAgICMgICAgICAgICBpZiBhZGZHZW9UcmFuc2Zvcm0gaXMgbm90IE5vbmUgOgogICAgIyAgICAgIyAgICAgICAgICAgICBjZWxsSW5mb1t1IkNlbGwgV2lkdGgiXSA9IHVuaWNvZGUoYWRmR2VvVHJhbnNmb3JtWzFdKQogICAgIyAgICAgIyAgICAgICAgICAgICBjZWxsSW5mb1t1IkNlbGwgSGVpZ2h0Il0gPSB1bmljb2RlKGZhYnMoYWRmR2VvVHJhbnNmb3JtWzVdKSkKICAgICMgICAgICMgICAgICAgICBjZWxsSW5mb1t1Ik51bWJlciBvZiBMYXllcnMiXSA9IHVuaWNvZGUoaERhdGFzZXQuUmFzdGVyQ291bnQpCiAgICAjICAgICAjIGZpbmFsbHk6CiAgICAjICAgICAjICAgICBoRGF0YXNldCA9IE5vbmUKICAgICMgICAgICMgcmV0dXJuIGNlbGxJbmZvCiAgICAjICAgICByZXR1cm4gIiIKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0Q2VsbFR5cGUocmFzdGVyUGF0aCk6CiAgICAgICAgdW5pY29kZShnZGFsLkdldERhdGFUeXBlTmFtZShjdXJCYW5kLkRhdGFUeXBlKSkKCgoKCgp0cnk6CiAgICBmcm9tIFdNU0NhcGFiaWxpdGllcyBpbXBvcnQgV01TQ2FwYWJpbGl0aWVzCmV4Y2VwdDoKICAgIHBhc3MKCiMhL3Vzci9iaW4vZW52IHB5dGhvbgojIC0qLSBjb2Rpbmc6IHV0Zi04IC0qLQoKCmlzRGluYW1pY2EgPSBGYWxzZQp0cnk6CiAgICBkaW5hbWljYS5wYWNrYWdlKCJvcyIpCiAgICBpc0RpbmFtaWNhID0gVHJ1ZQpleGNlcHQ6CiAgICBpc0RpbmFtaWNhID0gRmFsc2UKCmlmIG5vdCBpc0RpbmFtaWNhOgogICAgdHJ5OgogICAgICAgIGZyb20gLlVUSUxTIGltcG9ydCBVVElMUwogICAgICAgIGZyb20gLiBpbXBvcnQgeG1sdG9kaWN0CiAgICBleGNlcHQ6CiAgICAgICAgcGFzcyAjTm90IGluIFFHSVMKCiAgICB0cnk6CiAgICAgICAgZnJvbSBVVElMUyBpbXBvcnQgVVRJTFMKICAgICAgICBmcm9tIHhtbHRvZGljdCBpbXBvcnQgeG1sdG9kaWN0CiAgICBleGNlcHQ6CiAgICAgICAgcGFzcyAjTm90IGluIERpbmFtaWNhIENvZGUKCmZyb20gY29sbGVjdGlvbnMgaW1wb3J0IE9yZGVyZWREaWN0CmltcG9ydCBjb2xsZWN0aW9ucwpmcm9tIHBhdGhsaWIgaW1wb3J0IFBhdGgKaW1wb3J0IGpzb24KaW1wb3J0IG9zCmltcG9ydCBpbwppbXBvcnQgY3N2CmltcG9ydCByZQoKIyB0cnk6CiMgICAgIGZyb20gcWdpcy5jb3JlIGltcG9ydCAoUWdzQ29vcmRpbmF0ZVJlZmVyZW5jZVN5c3RlbSwgUWdzUHJvamVjdCwgUWdzUG9pbnRYWSwgUWdzQ29vcmRpbmF0ZVRyYW5zZm9ybSwgUWdzVmVjdG9yTGF5ZXIpCiMgZXhjZXB0OgojICAgICBwYXNzCgpjbGFzcyBXTVNDYXBhYmlsaXRpZXM6CgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldERlZmF1bHRDYXBhYmlsaXRpZXMoKToKICAgICAgICByZXR1cm4gJycnPD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48IURPQ1RZUEUgV01UX01TX0NhcGFiaWxpdGllcyBTWVNURU0gImh0dHA6Ly9tYXBzLmNzci51Zm1nLmJyOjgwL2dlb3NlcnZlci9zY2hlbWFzL3dtcy8xLjEuMS9XTVNfTVNfQ2FwYWJpbGl0aWVzLmR0ZCJbCiAgICA8IUVMRU1FTlQgVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMgKFRpbGVTZXQqKSA+CiAgICA8IUVMRU1FTlQgVGlsZVNldCAoU1JTLCBCb3VuZGluZ0JveD8sIFJlc29sdXRpb25zLCBXaWR0aCwgSGVpZ2h0LCBGb3JtYXQsIExheWVycyosIFN0eWxlcyopID4KICAgIDwhRUxFTUVOVCBSZXNvbHV0aW9ucyAoI1BDREFUQSkgPgogICAgPCFFTEVNRU5UIFdpZHRoICgjUENEQVRBKSA+CiAgICA8IUVMRU1FTlQgSGVpZ2h0ICgjUENEQVRBKSA+CiAgICA8IUVMRU1FTlQgTGF5ZXJzICgjUENEQVRBKSA+CiAgICA8IUVMRU1FTlQgU3R5bGVzICgjUENEQVRBKSA+CiAgICBdPgogICAgPFdNVF9NU19DYXBhYmlsaXRpZXMgdmVyc2lvbj0iMS4xLjEiIHVwZGF0ZVNlcXVlbmNlPSI2MzI1OCI+CiAgICAgIDxTZXJ2aWNlPgogICAgICAgIDxOYW1lPk9HQzpXTVM8L05hbWU+CiAgICAgICAgPFRpdGxlPkNTUiBXZWIgTWFwIFNlcnZpY2U8L1RpdGxlPgogICAgICAgIDxBYnN0cmFjdD5Db21wbGlhbnQgV01TIFJlc3BvbnNlPC9BYnN0cmFjdD4KICAgICAgICA8S2V5d29yZExpc3Q+CiAgICAgICAgICA8S2V5d29yZD5XRlM8L0tleXdvcmQ+CiAgICAgICAgICA8S2V5d29yZD5XTVM8L0tleXdvcmQ+CiAgICAgICAgICA8S2V5d29yZD5HRU9TRVJWRVI8L0tleXdvcmQ+CiAgICAgICAgPC9LZXl3b3JkTGlzdD4KICAgICAgICA8T25saW5lUmVzb3VyY2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOnR5cGU9InNpbXBsZSIgeGxpbms6aHJlZj0iaHR0cDovL2dlb3NlcnZlci5zb3VyY2Vmb3JnZS5uZXQvaHRtbC9pbmRleC5waHAiLz4KICAgICAgICA8Q29udGFjdEluZm9ybWF0aW9uPgogICAgICAgICAgPENvbnRhY3RQZXJzb25QcmltYXJ5PgogICAgICAgICAgICA8Q29udGFjdFBlcnNvbj5HSVRIVUIgb3duZXI8L0NvbnRhY3RQZXJzb24+CiAgICAgICAgICAgIDxDb250YWN0T3JnYW5pemF0aW9uPkdJVEhVQiBvd25lcjwvQ29udGFjdE9yZ2FuaXphdGlvbj4KICAgICAgICAgIDwvQ29udGFjdFBlcnNvblByaW1hcnk+CiAgICAgICAgICA8Q29udGFjdFBvc2l0aW9uPkNoaWVmIGdlb2dyYXBoZXI8L0NvbnRhY3RQb3NpdGlvbj4KICAgICAgICAgIDxDb250YWN0QWRkcmVzcz4KICAgICAgICAgICAgPEFkZHJlc3NUeXBlPldvcms8L0FkZHJlc3NUeXBlPgogICAgICAgICAgICA8QWRkcmVzcy8+CiAgICAgICAgICAgIDxDaXR5PkFsZXhhbmRyaWE8L0NpdHk+CiAgICAgICAgICAgIDxTdGF0ZU9yUHJvdmluY2UvPgogICAgICAgICAgICA8UG9zdENvZGUvPgogICAgICAgICAgICA8Q291bnRyeT5FZ3lwdDwvQ291bnRyeT4KICAgICAgICAgIDwvQ29udGFjdEFkZHJlc3M+CiAgICAgICAgICA8Q29udGFjdFZvaWNlVGVsZXBob25lLz4KICAgICAgICAgIDxDb250YWN0RmFjc2ltaWxlVGVsZXBob25lLz4KICAgICAgICAgIDxDb250YWN0RWxlY3Ryb25pY01haWxBZGRyZXNzPmNsYXVkaXVzLnB0b2xvbWFldXNAZ21haWwuY29tPC9Db250YWN0RWxlY3Ryb25pY01haWxBZGRyZXNzPgogICAgICAgIDwvQ29udGFjdEluZm9ybWF0aW9uPgogICAgICAgIDxGZWVzPk5PTkU8L0ZlZXM+CiAgICAgICAgPEFjY2Vzc0NvbnN0cmFpbnRzPk5PTkU8L0FjY2Vzc0NvbnN0cmFpbnRzPgogICAgICA8L1NlcnZpY2U+CiAgICAgIDxDYXBhYmlsaXR5PgogICAgICAgIDxSZXF1ZXN0PgogICAgICAgICAgPEdldENhcGFiaWxpdGllcz4KICAgICAgICAgICAgPEZvcm1hdD5hcHBsaWNhdGlvbi92bmQub2djLndtc194bWw8L0Zvcm1hdD4KICAgICAgICAgICAgPERDUFR5cGU+CiAgICAgICAgICAgICAgPEhUVFA+CiAgICAgICAgICAgICAgICA8R2V0PgogICAgICAgICAgICAgICAgICA8T25saW5lUmVzb3VyY2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOnR5cGU9InNpbXBsZSIgeGxpbms6aHJlZj0iaHR0cDovL21hcHMuY3NyLnVmbWcuYnI6ODAvZ2Vvc2VydmVyL3dtcz9TRVJWSUNFPVdNUyZhbXA7Ii8+CiAgICAgICAgICAgICAgICA8L0dldD4KICAgICAgICAgICAgICAgIDxQb3N0PgogICAgICAgICAgICAgICAgICA8T25saW5lUmVzb3VyY2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOnR5cGU9InNpbXBsZSIgeGxpbms6aHJlZj0iaHR0cDovL21hcHMuY3NyLnVmbWcuYnI6ODAvZ2Vvc2VydmVyL3dtcz9TRVJWSUNFPVdNUyZhbXA7Ii8+CiAgICAgICAgICAgICAgICA8L1Bvc3Q+CiAgICAgICAgICAgICAgPC9IVFRQPgogICAgICAgICAgICA8L0RDUFR5cGU+CiAgICAgICAgICA8L0dldENhcGFiaWxpdGllcz4KICAgICAgICAgIDxHZXRNYXA+CiAgICAgICAgICAgIDxGb3JtYXQ+aW1hZ2UvcG5nPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxEQ1BUeXBlPgogICAgICAgICAgICAgIDxIVFRQPgogICAgICAgICAgICAgICAgPEdldD4KICAgICAgICAgICAgICAgICAgPE9ubGluZVJlc291cmNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazp0eXBlPSJzaW1wbGUiIHhsaW5rOmhyZWY9Imh0dHA6Ly9tYXBzLmNzci51Zm1nLmJyOjgwL2dlb3NlcnZlci93bXM/U0VSVklDRT1XTVMmYW1wOyIvPgogICAgICAgICAgICAgICAgPC9HZXQ+CiAgICAgICAgICAgICAgPC9IVFRQPgogICAgICAgICAgICA8L0RDUFR5cGU+CiAgICAgICAgICA8L0dldE1hcD4KICAgICAgICAgIDxHZXRGZWF0dXJlSW5mbz4KICAgICAgICAgICAgPEZvcm1hdD50ZXh0L3BsYWluPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxGb3JtYXQ+YXBwbGljYXRpb24vdm5kLm9nYy5nbWw8L0Zvcm1hdD4KICAgICAgICAgICAgPEZvcm1hdD5hcHBsaWNhdGlvbi92bmQub2djLmdtbC8zLjEuMTwvRm9ybWF0PgogICAgICAgICAgICA8Rm9ybWF0PnRleHQvaHRtbDwvRm9ybWF0PgogICAgICAgICAgICA8Rm9ybWF0PmFwcGxpY2F0aW9uL2pzb248L0Zvcm1hdD4KICAgICAgICAgICAgPERDUFR5cGU+CiAgICAgICAgICAgICAgPEhUVFA+CiAgICAgICAgICAgICAgICA8R2V0PgogICAgICAgICAgICAgICAgICA8T25saW5lUmVzb3VyY2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOnR5cGU9InNpbXBsZSIgeGxpbms6aHJlZj0iaHR0cDovL21hcHMuY3NyLnVmbWcuYnI6ODAvZ2Vvc2VydmVyL3dtcz9TRVJWSUNFPVdNUyZhbXA7Ii8+CiAgICAgICAgICAgICAgICA8L0dldD4KICAgICAgICAgICAgICAgIDxQb3N0PgogICAgICAgICAgICAgICAgICA8T25saW5lUmVzb3VyY2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOnR5cGU9InNpbXBsZSIgeGxpbms6aHJlZj0iaHR0cDovL21hcHMuY3NyLnVmbWcuYnI6ODAvZ2Vvc2VydmVyL3dtcz9TRVJWSUNFPVdNUyZhbXA7Ii8+CiAgICAgICAgICAgICAgICA8L1Bvc3Q+CiAgICAgICAgICAgICAgPC9IVFRQPgogICAgICAgICAgICA8L0RDUFR5cGU+CiAgICAgICAgICA8L0dldEZlYXR1cmVJbmZvPgogICAgICAgICAgPERlc2NyaWJlTGF5ZXI+CiAgICAgICAgICAgIDxGb3JtYXQ+YXBwbGljYXRpb24vdm5kLm9nYy53bXNfeG1sPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxEQ1BUeXBlPgogICAgICAgICAgICAgIDxIVFRQPgogICAgICAgICAgICAgICAgPEdldD4KICAgICAgICAgICAgICAgICAgPE9ubGluZVJlc291cmNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazp0eXBlPSJzaW1wbGUiIHhsaW5rOmhyZWY9Imh0dHA6Ly9tYXBzLmNzci51Zm1nLmJyOjgwL2dlb3NlcnZlci93bXM/U0VSVklDRT1XTVMmYW1wOyIvPgogICAgICAgICAgICAgICAgPC9HZXQ+CiAgICAgICAgICAgICAgPC9IVFRQPgogICAgICAgICAgICA8L0RDUFR5cGU+CiAgICAgICAgICA8L0Rlc2NyaWJlTGF5ZXI+CiAgICAgICAgICA8R2V0TGVnZW5kR3JhcGhpYz4KICAgICAgICAgICAgPEZvcm1hdD5pbWFnZS9wbmc8L0Zvcm1hdD4KICAgICAgICAgICAgPERDUFR5cGU+CiAgICAgICAgICAgICAgPEhUVFA+CiAgICAgICAgICAgICAgICA8R2V0PgogICAgICAgICAgICAgICAgICA8T25saW5lUmVzb3VyY2UgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhsaW5rOnR5cGU9InNpbXBsZSIgeGxpbms6aHJlZj0iaHR0cDovL21hcHMuY3NyLnVmbWcuYnI6ODAvZ2Vvc2VydmVyL3dtcz9TRVJWSUNFPVdNUyZhbXA7Ii8+CiAgICAgICAgICAgICAgICA8L0dldD4KICAgICAgICAgICAgICA8L0hUVFA+CiAgICAgICAgICAgIDwvRENQVHlwZT4KICAgICAgICAgIDwvR2V0TGVnZW5kR3JhcGhpYz4KICAgICAgICAgIDxHZXRTdHlsZXM+CiAgICAgICAgICAgIDxGb3JtYXQ+YXBwbGljYXRpb24vdm5kLm9nYy5zbGQreG1sPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxEQ1BUeXBlPgogICAgICAgICAgICAgIDxIVFRQPgogICAgICAgICAgICAgICAgPEdldD4KICAgICAgICAgICAgICAgICAgPE9ubGluZVJlc291cmNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazp0eXBlPSJzaW1wbGUiIHhsaW5rOmhyZWY9Imh0dHA6Ly9tYXBzLmNzci51Zm1nLmJyOjgwL2dlb3NlcnZlci93bXM/U0VSVklDRT1XTVMmYW1wOyIvPgogICAgICAgICAgICAgICAgPC9HZXQ+CiAgICAgICAgICAgICAgPC9IVFRQPgogICAgICAgICAgICA8L0RDUFR5cGU+CiAgICAgICAgICA8L0dldFN0eWxlcz4KICAgICAgICA8L1JlcXVlc3Q+CiAgICAgICAgPEV4Y2VwdGlvbj4KICAgICAgICAgIDxGb3JtYXQ+YXBwbGljYXRpb24vdm5kLm9nYy5zZV94bWw8L0Zvcm1hdD4KICAgICAgICAgIDxGb3JtYXQ+YXBwbGljYXRpb24vdm5kLm9nYy5zZV9pbmltYWdlPC9Gb3JtYXQ+CiAgICAgICAgPC9FeGNlcHRpb24+CiAgICAgICAgPFZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzPgogICAgICAgICAgPG5vdGVtcHR5Pjwvbm90ZW1wdHk+CiAgICAgICAgPC9WZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcz4KICAgICAgICA8VXNlckRlZmluZWRTeW1ib2xpemF0aW9uIFN1cHBvcnRTTEQ9IjEiIFVzZXJMYXllcj0iMSIgVXNlclN0eWxlPSIxIiBSZW1vdGVXRlM9IjEiLz4KICAgICAgICA8TGF5ZXIgcXVlcnlhYmxlPSIwIiBvcGFxdWU9IjAiIG5vU3Vic2V0cz0iMCI+CiAgICAgICAgICA8VGl0bGU+TWFwU2VydmVyIHZpYSBHSXRIdWI8L1RpdGxlPgogICAgICAgICAgPEFic3RyYWN0PkdpdEh1YiBXTVM8L0Fic3RyYWN0PgogICAgICAgICAgPCEtLUFsbCBzdXBwb3J0ZWQgRVBTRyBwcm9qZWN0aW9uczotLT4KICAgICAgICAgIDxTUlM+RVBTRzozODU3PC9TUlM+CiAgICAgICAgICA8U1JTPkVQU0c6NDMyNjwvU1JTPgogICAgICAgICAgPFNSUz5FUFNHOjkwMDkxMzwvU1JTPgogICAgICAgICAgPFNSUz5FUFNHOjQyMzAzPC9TUlM+CiAgICAgICAgICA8TGF0TG9uQm91bmRpbmdCb3ggbWlueD0iLTE4MC4wMDAwNDA3NDE5OTk5OCIgbWlueT0iLTkwLjAiIG1heHg9IjE4MC4wMDAwMDAwMDAwMDAxIiBtYXh5PSI5MC4wIi8+CiAgICAgICAgPC9MYXllcj4KICAgICAgPC9DYXBhYmlsaXR5PgogICAgPC9XTVRfTVNfQ2FwYWJpbGl0aWVzPicnJwoKICAgICMgQHN0YXRpY21ldGhvZAogICAgIyBkZWYgY29udmVydENvb3JkaW5hdGVQcm9qKGNyc1Byb2osIGZyb21YLCBmcm9tWSwgb3V0cHV0UHJvamVjdGVkKToKICAgICMKICAgICMgICAgIHJlZ2V4ID0gciJeWyBdKlBST0pDUyIKICAgICMgICAgIGlzUHJvamVjdGVkID0gcmUubWF0Y2gocmVnZXgsIGNyc1Byb2opCiAgICAjCiAgICAjICAgICBpZiAoaXNQcm9qZWN0ZWQgYW5kIG91dHB1dFByb2plY3RlZCkgb3IgKCBub3QgaXNQcm9qZWN0ZWQgYW5kICBub3Qgb3V0cHV0UHJvamVjdGVkKToKICAgICMgICAgICAgICByZXR1cm4gKGZyb21YLCBmcm9tWSkKICAgICMgICAgIGVsc2U6CiAgICAjICAgICAgICAgZlByb2ogPSBRZ3NDb29yZGluYXRlUmVmZXJlbmNlU3lzdGVtKCkKICAgICMgICAgICAgICBmUHJvai5jcmVhdGVGcm9tV2t0KGNyc1Byb2opCiAgICAjICAgICAgICAgdFByb2ogPSBRZ3NDb29yZGluYXRlUmVmZXJlbmNlU3lzdGVtKCkKICAgICMgICAgICAgICB0UHJvai5jcmVhdGVGcm9tUHJvajQoIitwcm9qPW1lcmMgK2E9NjM3ODEzNyArYj02Mzc4MTM3ICtsYXRfdHM9MC4wICtsb25fMD0wLjAgK3hfMD0wLjAgK3lfMD0wICtrPTEuMCArdW5pdHM9bSArbmFkZ3JpZHM9QG51bGwgK3drdGV4dCAgK25vX2RlZnMiIGlmIG91dHB1dFByb2plY3RlZCBlbHNlICIrcHJvaj1sb25nbGF0ICtkYXR1bT1XR1M4NCArbm9fZGVmcyAiKQogICAgIyAgICAgICAgIG5ld0Nvb3JkID0gUWdzQ29vcmRpbmF0ZVRyYW5zZm9ybShmUHJvaiwgdFByb2osIFFnc1Byb2plY3QuaW5zdGFuY2UoKSkudHJhbnNmb3JtKFFnc1BvaW50WFkoZnJvbVgsIGZyb21ZKSwgVHJ1ZSkKICAgICMgICAgIHJldHVybiAobmV3Q29vcmQueCwgbmV3Q29vcmQueSkKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0TWFwS2V5d29yZChpc1NoYXBlZmlsZSwgbWF4Wm9vbSwgZGxMaW5rPU5vbmUpOgogICAgICAgIGlmIGRsTGluayBpcyBOb25lIG9yIGxlbihkbExpbmspID09IDA6CiAgICAgICAgICAgIGRsTGluayA9ICdkaXNhYmxlZG93bmxvYWQnCiAgICAgICAgZWxpZiAnOicgaW4gZGxMaW5rOgogICAgICAgICAgICBkbExpbmsgPSBkbExpbmtbKGRsTGluay5pbmRleCgnOicpICsgMSk6XQogICAgICAgIGVsaWYgJ8u4JyBpbiBkbExpbms6CiAgICAgICAgICAgIGRsTGluayA9IGRsTGlua1soZGxMaW5rLmluZGV4KCfLuCcpICsgMSk6XQogICAgICAgIHJldHVybiAiZ3JvdXDLuCIgKyAoJ3NocCcgaWYgaXNTaGFwZWZpbGUgZWxzZSAndGlmJykgKyAiy7jLuMu4IiArIGRsTGluayArICLLuG5vdExpc3RpbmfLuMu4bWF4Wm9vbcu4IiArIHN0cihtYXhab29tKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRNYXBEZXNjcmlwdGlvbihsYXllck5hbWVJRCwgbGF5ZXJBdHRyLCBsYXRNaW5YLCBsYXRNaW5ZLCBsYXRNYXhYLCBsYXRNYXhZLCBwcm9qTWluWCwgcHJvak1pblksIHByb2pNYXhYLCBwcm9qTWF4WSwgbWF4Wm9vbSwgaXNTaGFwZWZpbGUsIGRMaW5rKToKICAgICAgICBsYXllckF0dHIgPSBVVElMUy5ub3JtYWxpemVOYW1lKGxheWVyQXR0cikKICAgICAgICBsYXllck5hbWVJRCA9IFVUSUxTLm5vcm1hbGl6ZU5hbWUobGF5ZXJOYW1lSUQpCiAgICAgICAgIyBJbnZlcnRpIG8gbWlueC9taW55IGUgbWF4WC9tYXhZIGRvIGVwc2cgNDMyNiBwcSBlc3RhdmEgdHJvY2FuZG8gbm8gZ2Vvc2VydmVyLCBtYXMgbiBzZWkgcHEgaXNzbyBhY29udGVjZS4KICAgICAgICByZXR1cm4gIiIiPENPTlRFTlQ+CiAgICAgICAgICA8TGF5ZXIgcXVlcnlhYmxlPSIxIiBvcGFxdWU9IjAiPgogICAgICAgICAgPE5hbWU+R0g6IiIiICsgbGF5ZXJOYW1lSUQgKyAiIiI8L05hbWU+CiAgICAgICAgICA8VGl0bGU+IiIiICsgbGF5ZXJOYW1lSUQgKyAiIiI8L1RpdGxlPgogICAgICAgICAgPEFic3RyYWN0PkdIOiIiIiArIGxheWVyTmFtZUlEICsgIiIiIEFCU1RSQUNUPC9BYnN0cmFjdD4KICAgICAgICAgIDxLZXl3b3JkTGlzdD4KICAgICAgICAgICAgPEtleXdvcmQ+IiIiICsgV01TQ2FwYWJpbGl0aWVzLmdldE1hcEtleXdvcmQoaXNTaGFwZWZpbGUsIG1heFpvb20sIGRMaW5rKSArICIiIjwvS2V5d29yZD4KICAgICAgICAgIDwvS2V5d29yZExpc3Q+CiAgICAgICAgICA8U1JTPkVQU0c6NDMyNjwvU1JTPgogICAgICAgICAgPExhdExvbkJvdW5kaW5nQm94IG1pbng9XCIiIiIgKyBzdHIobGF0TWluWCkgKyAiIiJcIiBtaW55PVwiIiIiICsgc3RyKGxhdE1pblkpICsgIiIiXCIgbWF4eD1cIiIiIiArIHN0cigKICAgICAgICAgICAgbGF0TWF4WCkgKyAiIiJcIiBtYXh5PVwiIiIiICsgc3RyKGxhdE1heFkpICsgIiIiXCIvPgogICAgICAgICAgPEJvdW5kaW5nQm94IFNSUz0iRVBTRzo0MzI2IiBtaW54PVwiIiIiICsgc3RyKHByb2pNaW5YKSArICIiIlwiIG1pbnk9XCIiIiIgKyBzdHIoCiAgICAgICAgICAgIHByb2pNaW5ZKSArICIiIlwiIG1heHg9XCIiIiIgKyBzdHIocHJvak1heFgpICsgIiIiXCIgbWF4eT1cIiIiIiArIHN0cihwcm9qTWF4WSkgKyAiIiJcIi8+CiAgICAgICAgICA8U3R5bGU+CiAgICAgICAgICAgPE5hbWU+IiIiICsgbGF5ZXJBdHRyICsgIiIiPC9OYW1lPgogICAgICAgICAgIDxUaXRsZT4iIiIgKyBsYXllckF0dHIgKyAiIiI8L1RpdGxlPgogICAgICAgICAgIDxBYnN0cmFjdC8+CiAgICAgICAgICAgPExlZ2VuZFVSTCB3aWR0aD0iMjAiIGhlaWdodD0iMjAiPgogICAgICAgICAgIDxGb3JtYXQ+aW1hZ2UvcG5nPC9Gb3JtYXQ+CiAgICAgICAgICAgPE9ubGluZVJlc291cmNlIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bGluazp0eXBlPSJzaW1wbGUiIHhsaW5rOmhyZWY9Imh0dHBzOi8vbWFwcy5jc3IudWZtZy5icjo0NDMvZ2Vvc2VydmVyL3dtcz9yZXF1ZXN0PUdldExlZ2VuZEdyYXBoaWMmYW1wO2Zvcm1hdD1pbWFnZSUyRnBuZyZhbXA7d2lkdGg9MjAmYW1wO2hlaWdodD0yMCZhbXA7bGF5ZXI9IiIiICsgbGF5ZXJOYW1lSUQgKyAiIiJcIi8+CiAgICAgICAgICAgPC9MZWdlbmRVUkw+CiAgICAgICAgICA8L1N0eWxlPgogICAgICAgIDwvTGF5ZXI+CiAgICAgICAgPC9DT05URU5UPgogICAgICAgICIiIgoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRUaWxlU2V0RGVzY3JpcHRpb24oZmlsZU5hbWVJZCwgbGF0TWluWCwgbGF0TWluWSwgbGF0TWF4WCwgbGF0TWF4WSwgcHJvak1pblgsIHByb2pNaW5ZLCBwcm9qTWF4WCwgcHJvak1heFkpOgogICAgICAgICMgPEJvdW5kaW5nQm94IFNSUz0iRVBTRzo0MzI2IiBtaW54PVwiIiIiICsgc3RyKGxhdE1pblgpICsgIiIiXCIgbWlueT1cIiIiIiArIHN0cihsYXRNaW5ZKSArICIiIlwiIG1heHg9XCIiIiIgKyBzdHIobGF0TWF4WCkgKyAiIiJcIiBtYXh5PVwiIiIiICsgc3RyKGxhdE1heFkpICsgIiIiXCIvPgogICAgICAgIHJldHVybiAiIiI8P3htbCB2ZXJzaW9uPVwiMS4wXCIgZW5jb2Rpbmc9XCJVVEYtOFwiPz4KICAgICAgICA8Q09OVEVOVD4KICAgICAgICAgIDxUaWxlU2V0PgogICAgICAgICAgICA8U1JTPkVQU0c6NDMyNjwvU1JTPgogICAgICAgICAgICA8Qm91bmRpbmdCb3ggU1JTPSJFUFNHOjQzMjYiIG1pbng9Ii0xODAuMCIgbWlueT0iLTkwLjAiIG1heHg9IjAuMCIgbWF4eT0iOTAuMCIvPgogICAgICAgIDxSZXNvbHV0aW9ucz4wLjcwMzEyNSAwLjM1MTU2MjUgMC4xNzU3ODEyNSAwLjA4Nzg5MDYyNSAwLjA0Mzk0NTMxMjUgMC4wMjE5NzI2NTYyNSAwLjAxMDk4NjMyODEyNSAwLjAwNTQ5MzE2NDA2MjUgMC4wMDI3NDY1ODIwMzEyNSAwLjAwMTM3MzI5MTAxNTYyNSA2Ljg2NjQ1NTA3ODEyNUUtNCAzLjQzMzIyNzUzOTA2MjVFLTQgMS43MTY2MTM3Njk1MzEyNUUtNCA4LjU4MzA2ODg0NzY1NjI1RS01IDQuMjkxNTM0NDIzODI4MTI1RS01IDIuMTQ1NzY3MjExOTE0MDYyNUUtNSAxLjA3Mjg4MzYwNTk1NzAzMTJFLTUgNS4zNjQ0MTgwMjk3ODUxNTZFLTYgMi42ODIyMDkwMTQ4OTI1NzhFLTYgMS4zNDExMDQ1MDc0NDYyODlFLTYgNi43MDU1MjI1MzcyMzE0NDVFLTcgMy4zNTI3NjEyNjg2MTU3MjI3RS03IDwvUmVzb2x1dGlvbnM+CiAgICAgICAgICAgIDxXaWR0aD4yNTY8L1dpZHRoPgogICAgICAgICAgICA8SGVpZ2h0PjI1NjwvSGVpZ2h0PgogICAgICAgICAgICA8Rm9ybWF0PmltYWdlL3BuZzwvRm9ybWF0PgogICAgICAgICAgICA8TGF5ZXJzPkdIOiIiIiArIGZpbGVOYW1lSWQgKyAiIiI8L0xheWVycz4KICAgICAgICAgICAgPFN0eWxlcy8+CiAgICAgICAgICA8L1RpbGVTZXQ+CiAgICAgICAgICA8VGlsZVNldD4KICAgICAgICAgICAgPFNSUz5FUFNHOjkwMDkxMzwvU1JTPgogICAgICAgICAgICA8Qm91bmRpbmdCb3ggU1JTPSJFUFNHOjkwMDkxMyIgbWlueD0iLTIuMDAzNzUwODM0RTciIG1pbnk9Ii0yLjAwMzc1MDgzNEU3IiBtYXh4PSIyLjAwMzc1MDgzNEU3IiBtYXh5PSIyLjAwMzc1MDgzNEU3Ii8+CiAgICAgICAgPFJlc29sdXRpb25zPjE1NjU0My4wMzM5MDYyNSA3ODI3MS41MTY5NTMxMjUgMzkxMzUuNzU4NDc2NTYyNSAxOTU2Ny44NzkyMzgyODEyNSA5NzgzLjkzOTYxOTE0MDYyNSA0ODkxLjk2OTgwOTU3MDMxMjUgMjQ0NS45ODQ5MDQ3ODUxNTYyIDEyMjIuOTkyNDUyMzkyNTc4MSA2MTEuNDk2MjI2MTk2Mjg5MSAzMDUuNzQ4MTEzMDk4MTQ0NTMgMTUyLjg3NDA1NjU0OTA3MjI2IDc2LjQzNzAyODI3NDUzNjEzIDM4LjIxODUxNDEzNzI2ODA2NiAxOS4xMDkyNTcwNjg2MzQwMzMgOS41NTQ2Mjg1MzQzMTcwMTcgNC43NzczMTQyNjcxNTg1MDggMi4zODg2NTcxMzM1NzkyNTQgMS4xOTQzMjg1NjY3ODk2MjcgMC41OTcxNjQyODMzOTQ4MTM1IDAuMjk4NTgyMTQxNjk3NDA2NzcgMC4xNDkyOTEwNzA4NDg3MDMzOCAwLjA3NDY0NTUzNTQyNDM1MTY5IDAuMDM3MzIyNzY3NzEyMTc1ODQ2IDAuMDE4NjYxMzgzODU2MDg3OTIzIDAuMDA5MzMwNjkxOTI4MDQzOTYxIDAuMDA0NjY1MzQ1OTY0MDIxOTgxIDAuMDAyMzMyNjcyOTgyMDEwOTkwNCAwLjAwMTE2NjMzNjQ5MTAwNTQ5NTIgNS44MzE2ODI0NTUwMjc0NzZFLTQgMi45MTU4NDEyMjc1MTM3MzhFLTQgMS40NTc5MjA2MTM3NTY4NjlFLTQgPC9SZXNvbHV0aW9ucz4KICAgICAgICAgICAgPFdpZHRoPjI1NjwvV2lkdGg+CiAgICAgICAgICAgIDxIZWlnaHQ+MjU2PC9IZWlnaHQ+CiAgICAgICAgICAgIDxGb3JtYXQ+aW1hZ2UvcG5nPC9Gb3JtYXQ+CiAgICAgICAgICAgIDxMYXllcnM+R0g6IiIiICsgZmlsZU5hbWVJZCArICIiIjwvTGF5ZXJzPgogICAgICAgICAgICA8U3R5bGVzLz4KICAgICAgICAgIDwvVGlsZVNldD4KICAgICAgICAgIDwvQ09OVEVOVD4KICAgICAgICAiIiIKICAgICAgICAjIDxCb3VuZGluZ0JveCBTUlM9IkVQU0c6OTAwOTEzIiBtaW54PVwiIiIiICsgc3RyKHByb2pNaW5YKSArICIiIlwiIG1pbnk9XCIiIiIgKyBzdHIocHJvak1pblkpICsgIiIiXCIgbWF4eD1cIiIiIiArIHN0cihwcm9qTWF4WCkgKyAiIiJcIiBtYXh5PVwiIiIiICsgc3RyKHByb2pNYXhZKSArICIiIlwiLz4KCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0QWxsTGF5ZXJzKGNvbnRlbnQsIGxheWVyQXR0cj0nMScpOgogICAgICAgICNGSVhNRSBzaG91bGQgdXNlIHRoZSBzdHlsZSBuYW1lIHRvIGlkZW50aWZ5IHRoZSBsYXllciBhdHRyaWJ1dGVzCiAgICAgICAgZG9jID0geG1sdG9kaWN0LnBhcnNlKGNvbnRlbnQpCiAgICAgICAgYWxsTGF5ZXJzID0gW10KICAgICAgICB0cnk6CiAgICAgICAgICAgIGxheWVyRGVmaW5pdGlvbnMgPSBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddCiAgICAgICAgICAgIGlmIGxheWVyRGVmaW5pdGlvbnMgaXMgbm90IE5vbmUgYW5kIGlzaW5zdGFuY2UobGF5ZXJEZWZpbml0aW9ucywgbGlzdCkgYW5kIGxlbihsYXllckRlZmluaXRpb25zKToKICAgICAgICAgICAgICAgIGFsbExheWVycyA9IFtjdXJMYXllclsiTmFtZSJdIGZvciBjdXJMYXllciBpbiBsYXllckRlZmluaXRpb25zXQogICAgICAgICAgICBlbGlmIGxheWVyRGVmaW5pdGlvbnMgaXMgbm90IE5vbmUgYW5kIGlzaW5zdGFuY2UoZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXSwgY29sbGVjdGlvbnMuT3JkZXJlZERpY3QpIGFuZCBsZW4obGF5ZXJEZWZpbml0aW9ucyk6CiAgICAgICAgICAgICAgICBhbGxMYXllcnMgPSBbbGF5ZXJEZWZpbml0aW9uc1siTmFtZSJdXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvciBhcyBlOgogICAgICAgICAgICBwYXNzCiAgICAgICAgcmV0dXJuIGFsbExheWVycwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBnZXRPcGVyYXRpb25zTGlzdEZvckN1c3RvbUxheWVyKGRvY0xheWVyKToKICAgICAgICAjRklYTUUgTsOjbyBkZXZlcmlhIG1vZGlmaWNhciBvIGlucHV0IG51bWEgZnVuY2FvIGRlIGdldAogICAgICAgICNGSVhNRSBjb2RpZ28gZHVwbGljYWRvCiAgICAgICAgaWYgbm90ICJPcGVyYXRpb24iIGluIGRvY0xheWVyOgogICAgICAgICAgICBkb2NMYXllclsiT3BlcmF0aW9uIl0gPSBbXQogICAgICAgIGVsaWYgaXNpbnN0YW5jZShkb2NMYXllclsiT3BlcmF0aW9uIl0sIGNvbGxlY3Rpb25zLk9yZGVyZWREaWN0KToKICAgICAgICAgICAgZG9jTGF5ZXJbIk9wZXJhdGlvbiJdID0gW2RvY0xheWVyWyJPcGVyYXRpb24iXV0KCiAgICAgICAgaWYgbGVuKGRvY0xheWVyWyJPcGVyYXRpb24iXSkgPT0gMDoKICAgICAgICAgICAgcmV0dXJuIFtdCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKGRvY0xheWVyWyJPcGVyYXRpb24iXSwgc3RyKToKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKGpzb24uZHVtcHMoZG9jTGF5ZXIpKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBbeyd0eXBlJzogb3BlcmF0aW9uWyJAdHlwZSJdLCAnYXR0cmlidXRlJzogb3BlcmF0aW9uWyIjdGV4dCJdfSBmb3Igb3BlcmF0aW9uIGluIGRvY0xheWVyWydPcGVyYXRpb24nXV0KCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldEFsbEN1c3RvbUxheWVycyhjb250ZW50LCBsYXllckF0dHI9JzEnKToKICAgICAgICBkb2MgPSB4bWx0b2RpY3QucGFyc2UoY29udGVudCkKICAgICAgICBhbGxDdXN0b21MYXllcnMgPSBbXQogICAgICAgIGlmICdDdXN0b21MYXllcicgIGluIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ106CiAgICAgICAgICAgIGxheWVyRGVmaW5pdGlvbnMgPSBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWydDdXN0b21MYXllciddCgogICAgICAgICAgICBpZiBsYXllckRlZmluaXRpb25zIGlzIG5vdCBOb25lIGFuZCBpc2luc3RhbmNlKGxheWVyRGVmaW5pdGlvbnMsIGNvbGxlY3Rpb25zLk9yZGVyZWREaWN0KToKICAgICAgICAgICAgICAgIGxheWVyRGVmaW5pdGlvbnMgPSBbbGF5ZXJEZWZpbml0aW9uc10KICAgICAgICAgICAgaWYgbGF5ZXJEZWZpbml0aW9ucyBpcyBub3QgTm9uZSBhbmQgaXNpbnN0YW5jZShsYXllckRlZmluaXRpb25zLCBsaXN0KSBhbmQgbGVuKGxheWVyRGVmaW5pdGlvbnMpID4gMDoKICAgICAgICAgICAgICAgIGZvciBjdXJMYXllciBpbiBsYXllckRlZmluaXRpb25zOgogICAgICAgICAgICAgICAgICAgIGZvciBvcGVyYXRpb24gaW4gV01TQ2FwYWJpbGl0aWVzLmdldE9wZXJhdGlvbnNMaXN0Rm9yQ3VzdG9tTGF5ZXIoY3VyTGF5ZXIpOgogICAgICAgICAgICAgICAgICAgICAgICBhbGxDdXN0b21MYXllcnMuYXBwZW5kKGN1ckxheWVyWyJOYW1lIl0gKyAiOyIgKyBvcGVyYXRpb25bJ2F0dHJpYnV0ZSddKQogICAgICAgICAgICAgICAgICAgICAgICAjYWxsQ3VzdG9tTGF5ZXJzLmFwcGVuZChjdXJMYXllclsiTmFtZSJdICsgIjoiICsgb3BlcmF0aW9uWydhdHRyaWJ1dGUnXSArICI6IiArIG9wZXJhdGlvblsndHlwZSddKQogICAgICAgIHJldHVybiBhbGxDdXN0b21MYXllcnMKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0Q3VycmVudENhcGFiaWxpdGllc0RvYyhkaXJlY3RvcnkpOgogICAgICAgIGNhcGFiaWxpdGllc1BhdGggPSBvcy5wYXRoLmpvaW4oZGlyZWN0b3J5LCAiZ2V0Q2FwYWJpbGl0aWVzLnhtbCIpCiAgICAgICAgaWYgb3MucGF0aC5pc2ZpbGUoY2FwYWJpbGl0aWVzUGF0aCk6CiAgICAgICAgICAgIHdpdGggaW8ub3BlbihjYXBhYmlsaXRpZXNQYXRoLCBtb2RlPSJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgY2FwYWJpbGl0aWVzRmlsZToKICAgICAgICAgICAgICAgIGNhcGFiaWxpdGllc0NvbnRlbnQgPSBjYXBhYmlsaXRpZXNGaWxlLnJlYWQoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGNhcGFiaWxpdGllc0NvbnRlbnQgPSBXTVNDYXBhYmlsaXRpZXMuZ2V0RGVmYXVsdENhcGFiaWxpdGllcygpCiAgICAgICAgZG9jID0geG1sdG9kaWN0LnBhcnNlKGNhcGFiaWxpdGllc0NvbnRlbnQpCiAgICAgICAgcmV0dXJuIGRvYwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBzYXZlQ3VycmVudENhcGFiaWxpdGllcyhkaXJlY3RvcnksIGRvYyk6CiAgICAgICAgY2FwYWJpbGl0aWVzUGF0aCA9IG9zLnBhdGguam9pbihkaXJlY3RvcnksICJnZXRDYXBhYmlsaXRpZXMueG1sIikKICAgICAgICB3aXRoIGlvLm9wZW4oY2FwYWJpbGl0aWVzUGF0aCwgbW9kZT0idyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGNhcGFiaWxpdGllc0ZpbGU6CiAgICAgICAgICAgIGNhcGFiaWxpdGllc0ZpbGUud3JpdGUoeG1sdG9kaWN0LnVucGFyc2UoZG9jLCBwcmV0dHk9VHJ1ZSkpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldEN1c3RvbUxheWVyRGVmYXVsdERlZmluaXRpb24obGF5ZXJOYW1lKToKICAgICAgICBsYXllck5hbWUgPSBVVElMUy5ub3JtYWxpemVOYW1lKGxheWVyTmFtZSkKICAgICAgICByZXR1cm4geG1sdG9kaWN0LnBhcnNlKCIiIjw/eG1sIHZlcnNpb249XCIxLjBcIiBlbmNvZGluZz1cIlVURi04XCI/PgogICAgICAgICAgICA8Q09OVEVOVD4KICAgICAgICAgICAgICAgIDxOYW1lPkdIOiIiIiArIGxheWVyTmFtZSArICIiIjwvTmFtZT4KICAgICAgICAgICAgICAgIDxUaXRsZT4iIiIrbGF5ZXJOYW1lICsiIiI8L1RpdGxlPgogICAgICAgICAgICA8L0NPTlRFTlQ+IiIiKVsiQ09OVEVOVCJdCgogICAgI2N1c3RvbURvYyDDqSB1bSBEaWN0IHZpbmRvIGRvIHhtbHRvZGljdC4gbGF5ZXJBdHRyIGUgb3BlcmF0aW9uIHPDo28gc3RyaW5ncwogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGFkZE9wZXJhdGlvbihjdXN0b21Eb2MsIGxheWVyQXR0ciwgb3BlcmF0aW9uKToKICAgICAgICBsYXllckF0dHIgPSBVVElMUy5ub3JtYWxpemVOYW1lKGxheWVyQXR0cikKICAgICAgICBpZiBub3QgIk9wZXJhdGlvbiIgaW4gY3VzdG9tRG9jOgogICAgICAgICAgICBjdXN0b21Eb2NbIk9wZXJhdGlvbiJdID0gbGlzdCgpCiAgICAgICAgaWYgaXNpbnN0YW5jZShjdXN0b21Eb2NbIk9wZXJhdGlvbiJdLCBjb2xsZWN0aW9ucy5PcmRlcmVkRGljdCk6CiAgICAgICAgICAgIGN1c3RvbURvY1siT3BlcmF0aW9uIl0gPSBbY3VzdG9tRG9jWyJPcGVyYXRpb24iXV0KCiAgICAgICAgZm91bmQgPSBGYWxzZQogICAgICAgIGZvciBjdXJPcGVyYXRpb25EaWN0IGluIGN1c3RvbURvY1siT3BlcmF0aW9uIl06CiAgICAgICAgICAgIGlmIG5vdCBmb3VuZCBhbmQgJ0B0eXBlJyBpbiBjdXJPcGVyYXRpb25EaWN0IGFuZCBjdXJPcGVyYXRpb25EaWN0WydAdHlwZSddID09IG9wZXJhdGlvbiBhbmQgY3VyT3BlcmF0aW9uRGljdFsnI3RleHQnXSA9PSBsYXllckF0dHI6CiAgICAgICAgICAgICAgICBmb3VuZCA9IFRydWUKICAgICAgICBpZiBub3QgZm91bmQ6CiAgICAgICAgICAgIGN1c3RvbURvY1snT3BlcmF0aW9uJ10uYXBwZW5kKHhtbHRvZGljdC5wYXJzZSgiIiI8P3htbCB2ZXJzaW9uPVwiMS4wXCIgZW5jb2Rpbmc9XCJVVEYtOFwiPz4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxDT05URU5UPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPE9wZXJhdGlvbiB0eXBlPVwiIiIiICsgb3BlcmF0aW9uICsgIiIiXCI+IiIiICsgbGF5ZXJBdHRyICsgIiIiPC9PcGVyYXRpb24+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L0NPTlRFTlQ+IiIiKVsiQ09OVEVOVCJdWyJPcGVyYXRpb24iXSkKICAgICAgICByZXR1cm4gY3VzdG9tRG9jCgoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiB1cGRhdGVDdXN0b21YTUwoZGlyZWN0b3J5LCBsYXllclRpdGxlLCBsYXllckF0dHIsIG9wZXJhdGlvbik6CiAgICAgICAgZG9jID0gV01TQ2FwYWJpbGl0aWVzLmdldEN1cnJlbnRDYXBhYmlsaXRpZXNEb2MoZGlyZWN0b3J5KQogICAgICAgIGZpbGVuYW1lID0gVVRJTFMubm9ybWFsaXplTmFtZShsYXllclRpdGxlKSAgIyBsYXllciBOYW1lIG5vIHFnaXMKCiAgICAgICAgaWYgJ0N1c3RvbUxheWVyJyBpbiBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddOgogICAgICAgICAgICBpZiB0eXBlKGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bIkN1c3RvbUxheWVyIl0pIGlzIGNvbGxlY3Rpb25zLk9yZGVyZWREaWN0OgogICAgICAgICAgICAgICAgY3VyTGF5ZXIgPSBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWyJDdXN0b21MYXllciJdCiAgICAgICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWyJDdXN0b21MYXllciJdID0gW2N1ckxheWVyXQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bJ0N1c3RvbUxheWVyJ10gPSBbXQoKICAgICAgICBjdXJMYXllckRlZmluaXRpb24gPSBOb25lCiAgICAgICAgaWYgJ0N1c3RvbUxheWVyJyBpbiBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddOgogICAgICAgICAgICBmb3IgaUxheWVyIGluIHJhbmdlKGxlbihkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWyJDdXN0b21MYXllciJdKSAtIDEsIC0xLCAtMSk6CiAgICAgICAgICAgICAgICBjdXJMYXllciA9IGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bIkN1c3RvbUxheWVyIl1baUxheWVyXQogICAgICAgICAgICAgICAgaWYgIk5hbWUiIGluIGN1ckxheWVyIGFuZCBmaWxlbmFtZSBpbiBjdXJMYXllclsiTmFtZSJdOgogICAgICAgICAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bIkN1c3RvbUxheWVyIl0ucG9wKGlMYXllcikKICAgICAgICAgICAgICAgICAgICBjdXJMYXllckRlZmluaXRpb24gPSBjdXJMYXllcgogICAgICAgICAgICAgICAgICAgICNUT0RPIHZlcmlmaWNhciBzZSBuw6NvIHJlc3RhcmFtIG91dHJvcyBjb20gbWVzbW8gbm9tZS4KICAgICAgICBpZiBjdXJMYXllckRlZmluaXRpb24gaXMgTm9uZToKICAgICAgICAgICAgY3VyTGF5ZXJEZWZpbml0aW9uID0gV01TQ2FwYWJpbGl0aWVzLmdldEN1c3RvbUxheWVyRGVmYXVsdERlZmluaXRpb24oZmlsZW5hbWUpCiAgICAgICAgV01TQ2FwYWJpbGl0aWVzLmFkZE9wZXJhdGlvbihjdXJMYXllckRlZmluaXRpb24sIGxheWVyQXR0ciwgb3BlcmF0aW9uKQogICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bIkN1c3RvbUxheWVyIl0uYXBwZW5kKGN1ckxheWVyRGVmaW5pdGlvbikKICAgICAgICBXTVNDYXBhYmlsaXRpZXMuc2F2ZUN1cnJlbnRDYXBhYmlsaXRpZXMoZGlyZWN0b3J5LCBkb2MpCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHNldENhcGFiaWxpdGllc0RlZmF1bHRNYXhab29tKGRpcmVjdG9yeSk6CiAgICAgICAgZG9jID0gV01TQ2FwYWJpbGl0aWVzLmdldEN1cnJlbnRDYXBhYmlsaXRpZXNEb2MoZGlyZWN0b3J5KQoKICAgICAgICBpZiAnTGF5ZXInIGluIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ106CiAgICAgICAgICAgIGlmIHR5cGUoZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXSkgaXMgY29sbGVjdGlvbnMuT3JkZXJlZERpY3Q6CiAgICAgICAgICAgICAgICBjdXJMYXllciA9IGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10KICAgICAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10gPSBbY3VyTGF5ZXJdCgogICAgICAgIGlmICdMYXllcicgaW4gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXToKICAgICAgICAgICAgZm9yIGlMYXllciBpbiByYW5nZShsZW4oZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXSkgLSAxLCAtMSwgLTEpOgogICAgICAgICAgICAgICAgY3VyTGF5ZXIgPSBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddW2lMYXllcl0KICAgICAgICAgICAgICAgIGlmICJLZXl3b3JkTGlzdCIgaW4gY3VyTGF5ZXIgYW5kIHR5cGUoY3VyTGF5ZXJbJ0tleXdvcmRMaXN0J10pIGlzIGNvbGxlY3Rpb25zLk9yZGVyZWREaWN0IGFuZCAoIktleXdvcmQiIGluIGN1ckxheWVyWydLZXl3b3JkTGlzdCddKSBhbmQgY3VyTGF5ZXJbJ0tleXdvcmRMaXN0J11bJ0tleXdvcmQnXSA9PSAnR0lUSFVCJzoKICAgICAgICAgICAgICAgICAgICBjdXJMYXllclsnS2V5d29yZExpc3QnXVsnS2V5d29yZCddID0gV01TQ2FwYWJpbGl0aWVzLmdldE1hcEtleXdvcmQoRmFsc2UsIDgpCiAgICAgICAgV01TQ2FwYWJpbGl0aWVzLnNhdmVDdXJyZW50Q2FwYWJpbGl0aWVzKGRpcmVjdG9yeSwgZG9jKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiB1cGRhdGVYTUwoZGlyZWN0b3J5LCBsYXllckV4dGVudHMsIGxheWVyTWVyY2F0b3JFeHRlbnRzLCBpc1NoYXBlZmlsZSwgbGF5ZXJUaXRsZSwgbGF5ZXJBdHRyLCBtYXhab29tLCBkb3dubG9hZExpbmspOgogICAgICAgIGRvYyA9IFdNU0NhcGFiaWxpdGllcy5nZXRDdXJyZW50Q2FwYWJpbGl0aWVzRG9jKGRpcmVjdG9yeSkKCiAgICAgICAgZmlsZW5hbWUgPSBVVElMUy5ub3JtYWxpemVOYW1lKGxheWVyVGl0bGUpICNsYXllciBOYW1lIG5vIHFnaXMKCiAgICAgICAgYXNzZXJ0IGlzaW5zdGFuY2UobGF5ZXJFeHRlbnRzLCBXTVNCQm94KSBhbmQgaXNpbnN0YW5jZShsYXllck1lcmNhdG9yRXh0ZW50cywgV01TQkJveCkKCiAgICAgICAgIyAjZXh0ZW50cywgcHJvamVjdGlvbgogICAgICAgICMgcHJvak1heFggPSBsYXllci5leHRlbnQoKS54TWF4aW11bSgpCiAgICAgICAgcHJvak1heFggPSBsYXllckV4dGVudHMueE1heGltdW0oKQogICAgICAgICMgcHJvak1pblggPSBsYXllci5leHRlbnQoKS54TWluaW11bSgpCiAgICAgICAgcHJvak1pblggPSBsYXllckV4dGVudHMueE1pbmltdW0oKQogICAgICAgICMgcHJvak1heFkgPSBsYXllci5leHRlbnQoKS55TWF4aW11bSgpCiAgICAgICAgcHJvak1heFkgPSBsYXllckV4dGVudHMueU1heGltdW0oKQogICAgICAgICMgcHJvak1pblkgPSBsYXllci5leHRlbnQoKS55TWluaW11bSgpCiAgICAgICAgcHJvak1pblkgPSBsYXllckV4dGVudHMueU1pbmltdW0oKQogICAgICAgICMgbGxFeHRlbnQgPSBVVElMUy5nZXRNYXBFeHRlbnQobGF5ZXIsIFFnc0Nvb3JkaW5hdGVSZWZlcmVuY2VTeXN0ZW0oJ0VQU0c6NDMyNicpKQogICAgICAgICMgbGF0TWF4WCA9IGxsRXh0ZW50LnhNYXhpbXVtKCkKICAgICAgICBsYXRNYXhYID0gbGF5ZXJNZXJjYXRvckV4dGVudHMueE1heGltdW0oKQogICAgICAgICMgbGF0TWluWCA9IGxsRXh0ZW50LnhNaW5pbXVtKCkKICAgICAgICBsYXRNaW5YID0gbGF5ZXJNZXJjYXRvckV4dGVudHMueE1pbmltdW0oKQogICAgICAgICMgbGF0TWF4WSA9IGxsRXh0ZW50LnlNYXhpbXVtKCkKICAgICAgICBsYXRNYXhZID0gbGF5ZXJNZXJjYXRvckV4dGVudHMueU1heGltdW0oKQogICAgICAgICMgbGF0TWluWSA9IGxsRXh0ZW50LnlNaW5pbXVtKCkKICAgICAgICBsYXRNaW5ZID0gbGF5ZXJNZXJjYXRvckV4dGVudHMueU1pbmltdW0oKQogICAgICAgICNpc1NoYXBlZmlsZSA9IChpc2luc3RhbmNlKGxheWVyLCBRZ3NWZWN0b3JMYXllcikpCgoKICAgICAgICBpZiAnTGF5ZXInIGluIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ106CiAgICAgICAgICAgIGlmIHR5cGUoZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXSkgaXMgY29sbGVjdGlvbnMuT3JkZXJlZERpY3Q6CiAgICAgICAgICAgICAgICBjdXJMYXllciA9IGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10KICAgICAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10gPSBbY3VyTGF5ZXJdCgogICAgICAgIGlmICdMYXllcicgaW4gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXToKICAgICAgICAgICAgZm9yIGlMYXllciBpbiByYW5nZShsZW4oZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXSkgLSAxLCAtMSwgLTEpOgogICAgICAgICAgICAgICAgY3VyTGF5ZXIgPSBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddWydMYXllciddW2lMYXllcl0KICAgICAgICAgICAgICAgIGlmICJOYW1lIiBpbiBjdXJMYXllciBhbmQgY3VyTGF5ZXJbIk5hbWUiXSA9PSAiR0g6IiArIGZpbGVuYW1lOgogICAgICAgICAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ0xheWVyJ11bJ0xheWVyJ10ucG9wKGlMYXllcikKCiAgICAgICAgI0ZJWE1FIE9uZSBhdHRyaWJ1dGUgb25seS4gKElzIGFsd2F5cyBvdmVyd3JpdGluZykKICAgICAgICBuZXdMYXllckRlc2NyaXB0aW9uID0geG1sdG9kaWN0LnBhcnNlKAogICAgICAgICAgICBXTVNDYXBhYmlsaXRpZXMuZ2V0TWFwRGVzY3JpcHRpb24oZmlsZW5hbWUsIGxheWVyQXR0ciwgbGF0TWluWCwgbGF0TWluWSwgbGF0TWF4WCwgbGF0TWF4WSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2pNaW5YLCBwcm9qTWluWSwgcHJvak1heFgsIHByb2pNYXhZLCBtYXhab29tLCBpc1NoYXBlZmlsZSwgZG93bmxvYWRMaW5rKSlbJ0NPTlRFTlQnXQogICAgICAgIGlmICdMYXllcicgaW4gZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXToKICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnTGF5ZXInXVsnTGF5ZXInXS5hcHBlbmQobmV3TGF5ZXJEZXNjcmlwdGlvblsnTGF5ZXInXSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydMYXllciddID0gbmV3TGF5ZXJEZXNjcmlwdGlvbgoKICAgICAgICBuZXdUaWxlU2V0RGVzY3JpcHRpb24gPSB4bWx0b2RpY3QucGFyc2UoCiAgICAgICAgICAgIFdNU0NhcGFiaWxpdGllcy5nZXRUaWxlU2V0RGVzY3JpcHRpb24oZmlsZW5hbWUsIGxhdE1pblgsIGxhdE1pblksIGxhdE1heFgsIGxhdE1heFksIHByb2pNaW5YLCBwcm9qTWluWSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9qTWF4WCwgcHJvak1heFkpKVsnQ09OVEVOVCddCgogICAgICAgIGlmIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ10gaXMgbm90IE5vbmUgYW5kICdUaWxlU2V0JyBpbiBcCiAgICAgICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddOgogICAgICAgICAgICBpZiB0eXBlKGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bCiAgICAgICAgICAgICAgICAgICAgICAgICdUaWxlU2V0J10pIGlzIGNvbGxlY3Rpb25zLk9yZGVyZWREaWN0OgogICAgICAgICAgICAgICAgY3VyVGlsZVNldCA9IGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bJ1RpbGVTZXQnXQogICAgICAgICAgICAgICAgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsnVGlsZVNldCddID0gWwogICAgICAgICAgICAgICAgICAgIGN1clRpbGVTZXRdICAjIFRyYW5zZm9ybXMgaW50byBhIGxpc3QKCiAgICAgICAgaWYgZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXSBpcyBub3QgTm9uZSBhbmQgJ1RpbGVTZXQnIGluIFwKICAgICAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ106CiAgICAgICAgICAgIGZvciBpVGlsZVNldCBpbiByYW5nZSgKICAgICAgICAgICAgICAgICAgICBsZW4oZG9jWydXTVRfTVNfQ2FwYWJpbGl0aWVzJ11bJ0NhcGFiaWxpdHknXVsnVmVuZG9yU3BlY2lmaWNDYXBhYmlsaXRpZXMnXVsnVGlsZVNldCddKSAtIDEsCiAgICAgICAgICAgICAgICAgICAgLTEsIC0xKToKICAgICAgICAgICAgICAgIGN1clRpbGVTZXQgPSBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddWydUaWxlU2V0J11baVRpbGVTZXRdCiAgICAgICAgICAgICAgICBpZiAiTGF5ZXJzIiBpbiBjdXJUaWxlU2V0IGFuZCBjdXJUaWxlU2V0WyJMYXllcnMiXSA9PSAiR0g6IiArIGZpbGVuYW1lOgogICAgICAgICAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bJ1RpbGVTZXQnXS5wb3AoaVRpbGVTZXQpCiAgICAgICAgICAgIGRvY1snV01UX01TX0NhcGFiaWxpdGllcyddWydDYXBhYmlsaXR5J11bJ1ZlbmRvclNwZWNpZmljQ2FwYWJpbGl0aWVzJ11bJ1RpbGVTZXQnXSArPSBuZXdUaWxlU2V0RGVzY3JpcHRpb25bCiAgICAgICAgICAgICAgICAnVGlsZVNldCddICAjIERvaXMgZWxlbWVudG9zIGMgbWVzbWEgY2hhdmUgcmVwcmVzZW50YSBjb20gbGlzdGEKICAgICAgICBlbHNlOgogICAgICAgICAgICBkb2NbJ1dNVF9NU19DYXBhYmlsaXRpZXMnXVsnQ2FwYWJpbGl0eSddWydWZW5kb3JTcGVjaWZpY0NhcGFiaWxpdGllcyddID0gbmV3VGlsZVNldERlc2NyaXB0aW9uCiAgICAgICAgV01TQ2FwYWJpbGl0aWVzLnNhdmVDdXJyZW50Q2FwYWJpbGl0aWVzKGRpcmVjdG9yeSwgZG9jKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiB3cml0ZV9kZXNjcmlwdGlvbihkaXJlY3RvcnksIGxheWVyVGl0bGUsIGxheWVyQXR0ciwgY2VsbFR5cGVOYW1lLCBudWxsVmFsdWUsIG9wZXJhdGlvbik6CiAgICAgICAgbGF5ZXJUaXRsZSA9IFVUSUxTLm5vcm1hbGl6ZU5hbWUobGF5ZXJUaXRsZSkKICAgICAgICBjZWxsVHlwZU5hbWUgPSBVVElMUy5ub3JtYWxpemVOYW1lKGNlbGxUeXBlTmFtZSkKICAgICAgICBmaWxlY3N2ID0gImRlc2NyaXB0aW9uLmNzdiIKICAgICAgICBjc3ZQYXRoID0gb3MucGF0aC5qb2luKGRpcmVjdG9yeSwgZmlsZWNzdikKICAgICAgICBqc29uUGF0aCA9IG9zLnBhdGguam9pbihkaXJlY3RvcnksICJkZXNjcmlwdGlvbi5qc29uIikKICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShjc3ZQYXRoKToKICAgICAgICAgICAgY3N2RmlsZSA9IG9wZW4oY3N2UGF0aCwgInIiLCBlbmNvZGluZz0idXRmLTgiKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGNzdkZpbGUgPSBpby5TdHJpbmdJTygiS2V5KiwgY2VsbCwgbnVsbCwgb3BlcmF0aW9uLCBhdHRyLFxuLTk5OTksIFwiXCIsIC0xLCBcIlwiLCBuZW5odW1hLCAiKQoKICAgICAgICBjc3ZfcmVhZGVyID0gY3N2LkRpY3RSZWFkZXIoY3N2RmlsZSwgZGVsaW1pdGVyPScsJykKICAgICAgICBsaW5lX2NvdW50ID0gMAogICAgICAgIGVsZW1lbnRzID0gW2NlbGxUeXBlTmFtZSwgc3RyKG51bGxWYWx1ZSksIG9wZXJhdGlvbiwgbGF5ZXJBdHRyXQogICAgICAgIGZvciByb3cgaW4gY3N2X3JlYWRlcjoKICAgICAgICAgICAgY3VyRW50cnkgPSB7CiAgICAgICAgICAgICAgICAnY2VsbFR5cGUnOiByb3dbJyBjZWxsJ10uc3RyaXAoKSwKICAgICAgICAgICAgICAgICdudWxsVmFsdWUnOiByb3dbJyBudWxsJ10uc3RyaXAoKSwKICAgICAgICAgICAgICAgICdvcGVyYXRpb24nOiByb3dbJyBvcGVyYXRpb24nXS5zdHJpcCgpLAogICAgICAgICAgICAgICAgJ2F0dHJpYnV0ZSc6IHJvd1snIGF0dHInXS5zdHJpcCgpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgbGluZV9jb3VudCA+IDAgYW5kIGN1ckVudHJ5WydvcGVyYXRpb24nXSAhPSBvcGVyYXRpb24gYW5kIGN1ckVudHJ5WydhdHRyaWJ1dGUnXSAhPSBsYXllckF0dHI6CiAgICAgICAgICAgICAgICAjIEtleSAqLCBjZWxsLCBudWxsLCBvcGVyYXRpb24sIGF0dHIsCiAgICAgICAgICAgICAgICBlbGVtZW50cy5hcHBlbmQoY3VyRW50cnlbJ2NlbGxUeXBlJ10pCiAgICAgICAgICAgICAgICBlbGVtZW50cy5hcHBlbmQoY3VyRW50cnlbJ251bGxWYWx1ZSddKQogICAgICAgICAgICAgICAgZWxlbWVudHMuYXBwZW5kKGN1ckVudHJ5WydvcGVyYXRpb24nXSkKICAgICAgICAgICAgICAgIGVsZW1lbnRzLmFwcGVuZChjdXJFbnRyeVsnYXR0cmlidXRlJ10pCiAgICAgICAgICAgIGxpbmVfY291bnQgKz0gMQogICAgICAgIHdpdGggb3Blbihqc29uUGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBqc29uRmlsZToKICAgICAgICAgICAganNvbkZpbGUud3JpdGUoanNvbi5kdW1wcyhlbGVtZW50cykpCiAgICAgICAgY3N2RmlsZS5jbG9zZSgpCgpjbGFzcyBXTVNCQm94KCk6CiAgICB4TWF4ID0gTm9uZQogICAgZGVmIHhNYXhpbXVtKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLnhNYXgKCiAgICB4TWluID0gTm9uZQogICAgZGVmIHhNaW5pbXVtKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLnhNaW4KCiAgICB5TWF4ID0gTm9uZQogICAgZGVmIHlNYXhpbXVtKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLnlNYXgKCiAgICB5TWluID0gTm9uZQogICAgZGVmIHlNaW5pbXVtKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLnlNaW4KCiAgICBkZWYgX19pbml0X18oc2VsZiwgeE1heCwgeE1pbiwgeU1heCwgeU1pbik6CiAgICAgICAgc2VsZi54TWF4ID0geE1heAogICAgICAgIHNlbGYueE1pbiA9IHhNaW4KICAgICAgICBzZWxmLnlNYXggPSB5TWF4CiAgICAgICAgc2VsZi55TWluID0geU1pbgoKCmRlZiBjaGVja0dpdEV4ZWN1dGFibGUoZ2l0RXhlKToKICAgIGlmIG5vdCBnaXRFeGUgb3Igbm90IG9zLnBhdGguaXNmaWxlKGdpdEV4ZSk6CiAgICAgICAgUU1lc3NhZ2VCb3guZXJyb3IoIlNlbGVjdCB5b3VyIGdpdCBleGVjdXRhYmxlIHByb2dyYW0uXG4iICsgc3RyKAogICAgICAgICAgICBnaXRFeGUpICsgIlxuSXQgY2FuIGJlIGRvd25sb2FkYWJsZSBhdDogaHR0cHM6Ly9naXQtc2NtLmNvbS9kb3dubG9hZHMiKQogICAgICAgIGV4aXQoMSkKCmRlZiB3cml0ZUxlZ2VuZEpzb24obWFwRGlyLCBsZWdlbmRPYmopOgogICAgY29udGVudCA9IFtdCiAgICBmb3IgbGVnZW5kIGluIGxlZ2VuZE9iajoKICAgICAgICBjb250ZW50LmFwcGVuZCh7ImNvbG9yIjogW2xlZ2VuZC5yZWQsIGxlZ2VuZC5ncmVlbiwgbGVnZW5kLmJsdWVdLCAidGl0bGUiOiBsZWdlbmQuY2F0ZWdvcnlOYW1lfSkKICAgIGpzb25GaWxlID0gUGF0aChvcy5wYXRoLmpvaW4obWFwRGlyLCAibGVnZW5kLmpzb24iKSkKICAgIGpzb25GaWxlLndyaXRlX3RleHQoanNvbi5kdW1wcyhjb250ZW50KSwgZW5jb2Rpbmc9InV0Zi04IikKCmRlZiBnZXRMZWdlbmRGcm9tUGF0aChzbGRQYXRoKToKICAgIHJldHVybiByZWFkTGVnZW5kKHNsZFBhdGgpCgpkZWYgcHVibGlzaE1hcHMoZ2l0RXhlLCBnaFVzZXIsIGdoUGFzc3dvcmQsIG11c3RBc2tVc2VyLCBnaXRSZXBvc2l0b3J5LCBvdXRwdXREaXIsIGlucHV0X2ZpbGUsIGxheWVyQXR0ciwgb3BlcmF0aW9uLCBtYXhfem9vbSwgZG93bmxvYWRMaW5rLCBjZWxsVHlwZSwgbnVsbFZhbHVlLCBvcGVuSW5Ccm93c2VyLCBsZWdlbmRPYmosIGZpbGVuYW1lVGl0bGUpOgogICAgZ2l0RXhlID0gZ2l0RXhlIGlmIG9zLnBhdGguaXNmaWxlKGdpdEV4ZSkgZWxzZSBVVElMUy53aGljaCgiZ2l0LmV4ZSIpICAjIERhbmlsbyB0ZXN0YXIgcW5kIG7Do28gYWNoYSBvIGdpdC5leGUKICAgIGZvdW5kR2l0ID0gJycKICAgIGdpdEV4ZSA9IEdpdEh1Yi5maW5kR2l0RXhlKGdpdEV4ZSwgZm91bmRHaXQsIG11c3RBc2tVc2VyKQogICAgY2hlY2tHaXRFeGVjdXRhYmxlKGdpdEV4ZSkKICAgIEZlZWRiYWNrLnB1c2hDb25zb2xlSW5mbygiR2l0IGV4ZWN1dGFibGUgcGF0aCBmb3VuZDogIiArIGdpdEV4ZSkKICAgIGdoVXNlciwgZ2hQYXNzd29yZCA9IEdpdEh1Yi5nZXRHaXRDcmVkZW50aWFscyhnaFVzZXIsIGdoUGFzc3dvcmQsIG11c3RBc2tVc2VyKQogICAgaWYgZ2hVc2VyIGlzIE5vbmUgb3IgZ2hQYXNzd29yZCBpcyBOb25lOgogICAgICAgIFFNZXNzYWdlQm94LmVycm9yKCJFcnJvcjogR2l0aHViIGNyZWRlbnRpYWxzIGZhaWxlZCB0byBhdXRoZW50aWNhdGUuIikKICAgICAgICBleGl0KDEpCiAgICBGZWVkYmFjay5wdXNoQ29uc29sZUluZm8oIkF1dGhlbnRpY2F0aW9uIENvbmZpcm1lZDogIiArIGdpdEV4ZSkKCiAgICBpZiBub3QgR2l0SHViLmV4aXN0c1JlcG9zaXRvcnkoZ2hVc2VyLCBnaXRSZXBvc2l0b3J5KSBhbmQgbm90IEdpdEh1Yi5jcmVhdGVSZXBvKGdpdFJlcG9zaXRvcnksIGdoVXNlciwgZ2hQYXNzd29yZCwgRmVlZGJhY2soKSk6CiAgICAgICAgUU1lc3NhZ2VCb3guZXJyb3IoCiAgICAgICAgICAgICJFcnJvcjogRmFpbGVkIHRvIGNyZWF0ZSB0aGUgcmVwb3NpdG9yeSAiICsgZ2l0UmVwb3NpdG9yeSArICIuXG5QbGVhc2UgY3JlYXRlIGEgb25lIGF0OiBodHRwczovL2dpdGh1Yi5jb20vbmV3IikKICAgICAgICBleGl0KDEpCgogICAgR2l0SHViLnByZXBhcmVFbnZpcm9ubWVudChnaXRFeGUpCiAgICBpZiBub3QgR2l0SHViLmlzT3B0aW9uc09rKG91dHB1dERpciwgZ2hVc2VyLCBnaXRSZXBvc2l0b3J5LCBGZWVkYmFjaygpLCBnaFBhc3N3b3JkLCBtdXN0QXNrVXNlcik6CiAgICAgICAgUU1lc3NhZ2VCb3guZXJyb3IoIkVycm9yOiBDYW5jZWxpbmcgdGhlIGV4ZWN1dGlvbiwgcGxlYXNlIHNlbGVjdCBhbm90aGVyIG91dHB1dCBmb2xkZXIuIikKICAgICAgICBleGl0KDEpCgogICAgIyBmaWxlTmFtZSA9IG9zLnBhdGguYmFzZW5hbWUoaW5wdXRfZmlsZSkKICAgICMgZmlsZU5hbWVXaXRob3V0RXh0ID0gb3MucGF0aC5zcGxpdGV4dChmaWxlTmFtZSlbMF0KICAgIGxheWVyVGl0bGUgPSBVVElMUy5ub3JtYWxpemVOYW1lKGZpbGVuYW1lVGl0bGUpCiAgICBtYXBEaXIgPSBvcy5wYXRoLmpvaW4ob3V0cHV0RGlyLCBsYXllclRpdGxlLCBsYXllckF0dHIsIG9wZXJhdGlvbikKICAgIGRlc2NyaXB0aW9uRGlyID0gb3MucGF0aC5qb2luKG91dHB1dERpciwgbGF5ZXJUaXRsZSwgbGF5ZXJBdHRyKQoKICAgIGdlbmVyYXRlVGlsZUZvck1hcChpbnB1dF9maWxlLCBtYXBEaXIsIG1heF96b29tLCByZXN1bWU9RmFsc2UsIGxlZ2VuZE9iaj1sZWdlbmRPYmopICNwcm9jZXNzYXIgb3MgdGlsZXMKICAgIFdNU0NhcGFiaWxpdGllcy53cml0ZV9kZXNjcmlwdGlvbihkZXNjcmlwdGlvbkRpciwgbGF5ZXJUaXRsZSwgbGF5ZXJBdHRyLCBjZWxsVHlwZSwgbnVsbFZhbHVlLCBvcGVyYXRpb24pCiAgICB3cml0ZUxlZ2VuZEpzb24obWFwRGlyLCBsZWdlbmRPYmopCiAgICBsYXllckV4dGVudHMgPSBXTVNCQm94KCpHREFMX1VUSUxTLmdldEV4dGVudChpbnB1dF9maWxlKSkKICAgIGxheWVyTWVyY2F0b3JFeHRlbnRzID0gV01TQkJveCgqR0RBTF9VVElMUy5nZXRFeHRlbnQoaW5wdXRfZmlsZSwgNDMyNikpCiAgICBXTVNDYXBhYmlsaXRpZXMudXBkYXRlWE1MKG91dHB1dERpciwgbGF5ZXJFeHRlbnRzLCBsYXllck1lcmNhdG9yRXh0ZW50cywgRmFsc2UsIGxheWVyVGl0bGUsIGxheWVyQXR0ciwgbWF4X3pvb20sIGRvd25sb2FkTGluaykKICAgIEdpdEh1Yi5wdWJsaXNoVGlsZXNUb0dpdEh1YihvdXRwdXREaXIsIGdoVXNlciwgZ2l0UmVwb3NpdG9yeSwgRmVlZGJhY2soKSwgdmVyc2lvbiwgZ2hQYXNzd29yZCkKICAgIGlmIG9wZW5JbkJyb3dzZXI6CiAgICAgICAgc3RvcmVVcmwgPSBHaXRIdWIuZ2V0R2l0VXJsKGdoVXNlciwgZ2l0UmVwb3NpdG9yeSkKICAgICAgICBjdXJNYXBzVXJsID0gImh0dHBzOi8vbWFwcy5jc3IudWZtZy5ici9jYWxjdWxhdG9yLz9xdWVyeWlkPTE1MiZzdG9yZXVybD0iICsgc3RvcmVVcmwgKyAiLyZyZW1vdGVtYXA9IiArICJHSDoiICsgbGF5ZXJUaXRsZSArICI7IiArIGxheWVyQXR0cgogICAgICAgIHdlYmJyb3dzZXIub3Blbl9uZXcoY3VyTWFwc1VybCkKICAgICMgI0dlcmEgVGh1bWJuYWlsPwoKY3VyVXNlciA9IE5vbmUKZ2hQYXNzd29yZCA9IE5vbmUKbXVzdEFza1VzZXIgPSBGYWxzZQpnaXRFeGUgPSAnJwpsYXllckF0dHIgPSAnMScKb3BlcmF0aW9uID0gJ3JnYmEnCmRvd25sb2FkTGluayA9IE5vbmUKY2VsbFR5cGUgPSAnaW50MzInCm51bGxWYWx1ZSA9IC0xMjgKb3BlbkluQnJvd3NlciA9IFRydWUKCgppZiBpc0RpbmFtaWNhOgogICAgcHJpbnQoanNvbi5kdW1wcyhkaW5hbWljYS5pbnB1dHMpKQogICAgbWF4X3pvb20gPSBpbnQocm91bmQoZGluYW1pY2EuaW5wdXRzWyJ2MSJdKSkgICMgNwogICAgZ2l0UmVwb3NpdG9yeSA9IGRpbmFtaWNhLmlucHV0c1siczIiXSAgIyAnTWFwcGlhX0V4YW1wbGVfcDYnCiAgICBvdXRwdXREaXIgPSBkaW5hbWljYS5pbnB1dHNbInMzIl0gKyAiXFwiICAjICdDOlxcVXNlcnNcXERhbmlsb1xcQXBwRGF0YVxcTG9jYWxcXFRlbXBcXG91dHB1dERpclxcJwogICAgI3NsZFBhdGggPSBkaW5hbWljYS5pbnB1dHNbInM0Il0gICMgJ0k6XFxEYW5pbG9cXFRyYW1wb1xcZGF0YV9kaXJcXGRhdGFcXGxhdXJlbFxcbGFuZF91c2VfMTk5Ml8yMDE1XFxsYW5kX3VzZV8xOTkyXzIwMTVfNy5zbGQnCiAgICByZWFsRmlsZU5hbWUgPSBkaW5hbWljYS5pbnB1dHNbInM0Il0KICAgIGlucHV0X2ZpbGUgPSBkaW5hbWljYS5pbnB1dHNbInMxIl0gICMgIkY6XFxEYW5pbG9cXFRyYW1wb1xcZGF0YV9kaXJcXGRhdGFcXHRlc3RlXFxpeWllbGRfcnViYmVyMi50aWYiICNpeWllbGRfcnViYmVyLnRpZiIgIyJGOlxcRGFuaWxvXFxUcmFtcG9cXGRhdGFfZGlyXFxkYXRhXFx0ZXN0ZVxcYnlpZWxkX3J1YmJlci50aWYiICMiRjpcXERhbmlsb1xcVHJhbXBvXFxkYXRhX2RpclxcZGF0YVxccmVtYW5lc2NlbnRlc19mbG9yZXN0YWlzX2Rlc21hdGFtZW50b1xcYnJhc2lsXFxwZXJkYV9jb2JlcnR1cmFfdmVnZXRhbF9hbm9faGFuc2VuXFxsb3NzeWVhci52cnQiIyJGOlxcRGFuaWxvXFxUcmFtcG9cXGRhdGFfZGlyXFxkYXRhXFxyZW1hbmVzY2VudGVzX2Zsb3Jlc3RhaXNfZGVzbWF0YW1lbnRvXFxicmFzaWxcXHBlcmRhX2NvYmVydHVyYV92ZWdldGFsX2Fub19oYW5zZW5cXGxvc3N5ZWFyLnRpZiIgIyJGOlxcRGFuaWxvXFxUcmFtcG9cXGRhdGFfZGlyXFxkYXRhXFxyZW1hbmVzY2VudGVzX2Zsb3Jlc3RhaXNfZGVzbWF0YW1lbnRvXFxicmFzaWxcXHByb2Rlc1xccHJvZGVzLnZydCIgIyJGOlxcRGFuaWxvXFxUcmFtcG9cXGRhdGFfZGlyXFxkYXRhXFxyZW1hbmVzY2VudGVzX2Zsb3Jlc3RhaXNfZGVzbWF0YW1lbnRvXFxicmFzaWxcXHBlcmRhX2NvYmVydHVyYV92ZWdldGFsX2Fub19oYW5zZW5cXGxvc3N5ZWFyLnRpZiIKICAgIGNzdklucHV0ID0gZGluYW1pY2EuaW5wdXRzWyd0MSddCiAgICBsZWdlbmRPYmogPSBwcmVwYXJlTGVnZW5kKGNzdklucHV0KQogICAgcHJpbnQoImlzRGluYW1pY2EiKQplbHNlOgogICAgZ2l0UmVwb3NpdG9yeSA9ICdNYXBwaWFfRXhhbXBsZV9wNicKICAgIG1heF96b29tID0gNgogICAgb3V0cHV0RGlyID0gJ0M6XFxVc2Vyc1xcRGFuaWxvXFxBcHBEYXRhXFxMb2NhbFxcVGVtcFxcb3V0cHV0RGlyXFwnCiAgICBpbnB1dF9maWxlID0gIkY6XFxEYW5pbG9cXFRyYW1wb1xcZGF0YV9kaXJcXGRhdGFcXHRlc3RlXFxpeWllbGRfcnViYmVyMi50aWYiICAjIGl5aWVsZF9ydWJiZXIudGlmIiAjIkY6XFxEYW5pbG9cXFRyYW1wb1xcZGF0YV9kaXJcXGRhdGFcXHRlc3RlXFxieWllbGRfcnViYmVyLnRpZiIgIyJGOlxcRGFuaWxvXFxUcmFtcG9cXGRhdGFfZGlyXFxkYXRhXFxyZW1hbmVzY2VudGVzX2Zsb3Jlc3RhaXNfZGVzbWF0YW1lbnRvXFxicmFzaWxcXHBlcmRhX2NvYmVydHVyYV92ZWdldGFsX2Fub19oYW5zZW5cXGxvc3N5ZWFyLnZydCIjIkY6XFxEYW5pbG9cXFRyYW1wb1xcZGF0YV9kaXJcXGRhdGFcXHJlbWFuZXNjZW50ZXNfZmxvcmVzdGFpc19kZXNtYXRhbWVudG9cXGJyYXNpbFxccGVyZGFfY29iZXJ0dXJhX3ZlZ2V0YWxfYW5vX2hhbnNlblxcbG9zc3llYXIudGlmIiAjIkY6XFxEYW5pbG9cXFRyYW1wb1xcZGF0YV9kaXJcXGRhdGFcXHJlbWFuZXNjZW50ZXNfZmxvcmVzdGFpc19kZXNtYXRhbWVudG9cXGJyYXNpbFxccHJvZGVzXFxwcm9kZXMudnJ0IiAjIkY6XFxEYW5pbG9cXFRyYW1wb1xcZGF0YV9kaXJcXGRhdGFcXHJlbWFuZXNjZW50ZXNfZmxvcmVzdGFpc19kZXNtYXRhbWVudG9cXGJyYXNpbFxccGVyZGFfY29iZXJ0dXJhX3ZlZ2V0YWxfYW5vX2hhbnNlblxcbG9zc3llYXIudGlmIgogICAgc2xkUGF0aCA9ICdJOlxcRGFuaWxvXFxUcmFtcG9cXGRhdGFfZGlyXFxkYXRhXFxsYXVyZWxcXGxhbmRfdXNlXzE5OTJfMjAxNVxcbGFuZF91c2VfMTk5Ml8yMDE1Xzcuc2xkJwogICAgbGVnZW5kT2JqID0gZ2V0TGVnZW5kRnJvbVBhdGgoc2xkUGF0aCkKICAgIHJlYWxGaWxlTmFtZSA9ICdsYW5kX3VzZV8xOTkyXzIwMTVfNycKICAgIHByaW50KCJpc05vdERpbmFtaWNhIikKCiMgaWYgX19uYW1lX18gPT0gJ19fbWFpbl9fJzoKIyByZWFsRmlsZU5hbWUKcHVibGlzaE1hcHMoZ2l0RXhlLCBjdXJVc2VyLCBnaFBhc3N3b3JkLCBtdXN0QXNrVXNlciwgZ2l0UmVwb3NpdG9yeSwgb3V0cHV0RGlyLCBpbnB1dF9maWxlLCBsYXllckF0dHIsIG9wZXJhdGlvbiwgbWF4X3pvb20sIGRvd25sb2FkTGluaywgY2VsbFR5cGUsIG51bGxWYWx1ZSwgb3BlbkluQnJvd3NlciwgbGVnZW5kT2JqLCByZWFsRmlsZU5hbWUpCgp0cnk6CiAgICBkaW5hbWljYS5vdXRwdXRzWydvdXQnXSA9IDEKZXhjZXB0OgogICAgcGFzcw==&quot;</inputport>
        <outputport name="result" id="v13" />
        <functor name="NumberString">
            <property key="dff.functor.alias" value="numberString2728" />
            <inputport name="value" peerid="v15" />
            <inputport name="valueNumber">1</inputport>
        </functor>
        <functor name="NumberString">
            <property key="dff.functor.alias" value="numberString2729" />
            <inputport name="value" peerid="v14" />
            <inputport name="valueNumber">2</inputport>
        </functor>
        <functor name="NumberValue">
            <property key="dff.functor.alias" value="numberValue2731" />
            <inputport name="value" peerid="v2" />
            <inputport name="valueNumber">1</inputport>
        </functor>
        <functor name="NumberString">
            <property key="dff.functor.alias" value="numberString2733" />
            <inputport name="value" peerid="v19" />
            <inputport name="valueNumber">3</inputport>
        </functor>
        <functor name="NumberTable">
            <property key="dff.functor.alias" value="numberTable2737" />
            <inputport name="table" peerid="v16" />
            <inputport name="tableNumber">1</inputport>
        </functor>
        <functor name="NumberString">
            <property key="dff.functor.alias" value="numberString2743" />
            <inputport name="value" peerid="v4" />
            <inputport name="valueNumber">4</inputport>
        </functor>
    </containerfunctor>
    <containerfunctor name="Group">
        <property key="dff.functor.alias" value="group2736" />
        <inputport name="sequenceInput">.none</inputport>
        <functor name="String">
            <property key="dff.functor.alias" value="gitRepository" />
            <property key="dff.functor.comment" value="Value or constant representing string." />
            <property key="submodel.in.constant.advanced" value="yes" />
            <property key="submodel.in.constant.description" value="Value or constant representing string." />
            <property key="submodel.in.constant.name" value="gitRepositoryName" />
            <property key="submodel.in.constant.optional" value="yes" />
            <property key="submodel.in.constant.order" value="5" />
            <inputport name="constant">$&quot;(Mappia_Dinamica)&quot;</inputport>
            <outputport name="object" id="v14" />
        </functor>
        <functor name="String">
            <property key="dff.functor.alias" value="input_file" />
            <inputport name="constant" peerid="v12" />
            <outputport name="object" id="v15" />
        </functor>
        <functor name="Table">
            <property key="dff.functor.alias" value="sldCsv" />
            <inputport name="constant" peerid="v5" />
            <outputport name="object" id="v16" />
        </functor>
    </containerfunctor>
    <containerfunctor name="Group">
        <property key="dff.functor.alias" value="verifyInputs" />
        <inputport name="sequenceInput">.none</inputport>
        <functor name="Table">
            <property key="dff.functor.alias" value="Raster Palette Csv" />
            <property key="dff.functor.comment" value='A CSV with the columns:&#x0A;&quot;Category*, From, To, Category_Name, red, green, blue, &quot;' />
            <property key="dff.functor.extendedcomment" value="EX:&#x0A;Category*, From, To, Category_Name, red, green, blue,&#x0A;0, -99, -99, Non-forest, 178, 178, 178,&#x0A;1, 0, 1.0, Forest, 0, 0, 255,&#x0A;2, 1.01, 2.00, River, 51, 194, 255," />
            <property key="submodel.in.constant.advanced" value="yes" />
            <property key="submodel.in.constant.description" value='A CSV with the columns:&#x0A;&quot;Category*, From, To, Category_Name, red, green, blue, &quot;' />
            <property key="submodel.in.constant.name" value="rasterPaletteCsv" />
            <property key="submodel.in.constant.optional" value="yes" />
            <property key="submodel.in.constant.order" value="3" />
            <inputport name="constant">[&#x0A;    &quot;Category*&quot;, &quot;From&quot;, &quot;To&quot;, &quot;Category_Name#str&quot;, &quot;red&quot;, &quot;green&quot;, &quot;blue&quot;, &#x0A;]</inputport>
            <outputport name="object" id="v17" />
        </functor>
        <functor name="ExtractStructNumber">
            <property key="dff.functor.alias" value="isCsvValid" />
            <inputport name="struct" peerid="v22" />
            <inputport name="name">$&quot;(result)&quot;</inputport>
            <outputport name="number" id="v18" />
        </functor>
        <functor name="String">
            <property key="dff.functor.alias" value="outputDir" />
            <property key="dff.functor.comment" value="A Directory EMPTY or With a repository already.&#x0A;The directory to save the publishing tiles.&#x0A;* Only use the same directory when using the same &apos;GitRepository&apos;.&#x0A;* On new repository please use a empty folder." />
            <property key="submodel.in.constant.advanced" value="no" />
            <property key="submodel.in.constant.description" value="A Directory EMPTY or With a repository already.&#x0A;The directory to save the publishing tiles.&#x0A;* Only use the same directory when using the same &apos;GitRepository&apos;.&#x0A;* On new repository please use a empty folder." />
            <property key="submodel.in.constant.name" value="outputDir" />
            <property key="submodel.in.constant.optional" value="no" />
            <property key="submodel.in.constant.order" value="2" />
            <outputport name="object" id="v19" />
        </functor>
        <functor name="ExtractStructNumber">
            <property key="dff.functor.alias" value="extractStructNumber3616" />
            <inputport name="struct" peerid="v23" />
            <inputport name="name">$&quot;(isdir)&quot;</inputport>
            <outputport name="number" id="v20" />
        </functor>
        <functor name="ExtractStructNumber">
            <property key="dff.functor.alias" value="isEmpty" />
            <inputport name="struct" peerid="v22" />
            <inputport name="name">$&quot;(isempty)&quot;</inputport>
            <outputport name="number" id="v21" />
        </functor>
        <containerfunctor name="CalculatePythonExpression">
            <property key="dff.container.collapsed" value="no" />
            <property key="dff.functor.alias" value="calculatePythonExpression3614" />
            <inputport name="expression">&quot;aW1wb3J0IGpzb24KY3N2TGVnZW5kID0gZGluYW1pY2EuaW5wdXRzWyJ0MSJdCgpoZWFkID0gY3N2TGVnZW5kWzBdCnByaW50KGhlYWQpCnJlc3VsdCA9IE5vbmUKIydDYXRlZ29yeScsICdGcm9tJywgJ1RvJywgJ0NhdGVnb3J5X05hbWUnLCAncmVkJywgJ2dyZWVuJywgJ2JsdWUnCmlmICJDYXRlZ29yeSIgbm90IGluIGhlYWQgb3IgIkZyb20iIG5vdCBpbiBoZWFkIG9yICJUbyIgbm90IGluIGhlYWQgb3IgIkNhdGVnb3J5X05hbWUiIG5vdCBpbiBoZWFkIG9yICJyZWQiIG5vdCBpbiBoZWFkIG9yICJncmVlbiIgbm90IGluIGhlYWQgb3IgImJsdWUiIG5vdCBpbiBoZWFkOgoJcHJpbnQoIkVycm9yLCBpbiBSYXN0ZXIgUGFsZXR0ZSBDU1YuIFRoZSB0YWJsZSBtdXN0IGhhdmUgZXhhY3RseSB0aGUgZm9ybWF0IG9mLCBjb2x1bW5zOlxuXG4nQ2F0ZWdvcnkqLCBGcm9tLCBUbywgQ2F0ZWdvcnlfTmFtZSwgcmVkLCBncmVlbiwgYmx1ZSciKQoJcHJpbnQoIllvdSBjYW4gbGVhdmUgaXQgZW1wdHkgdG8gY3JlYXRlIGl0IGF1dG9tYXRpY2FsbHkiKQoJcmVzdWx0ID0gMAplbHNlOgoJcmVzdWx0ID0gMQoJCmRpbmFtaWNhLm91dHB1dHNbJ3Jlc3VsdCddID0gcmVzdWx0CmRpbmFtaWNhLm91dHB1dHNbJ2lzZW1wdHknXSA9IDAgaWYgbGVuKGNzdkxlZ2VuZCkgPiAxIGVsc2UgMQ==&quot;</inputport>
            <outputport name="result" id="v22" />
            <functor name="NumberTable">
                <property key="dff.functor.alias" value="numberTable3615" />
                <inputport name="table" peerid="v17" />
                <inputport name="tableNumber">1</inputport>
            </functor>
        </containerfunctor>
        <containerfunctor name="CalculatePythonExpression">
            <property key="dff.container.collapsed" value="no" />
            <property key="dff.functor.alias" value="calculatePythonExpression4047" />
            <inputport name="expression">&quot;aW1wb3J0IG9zCnRyeToKCW9zLm1ha2VkaXJzKGRpbmFtaWNhLmlucHV0c1siczEiXSwgZXhpc3Rfb2s9VHJ1ZSkKZXhjZXB0OgoJcGFzcwpkaW5hbWljYS5vdXRwdXRzWydpc2RpciddID0gMSBpZiBvcy5wYXRoLmlzZGlyKGRpbmFtaWNhLmlucHV0c1siczEiXSkgZWxzZSAw&quot;</inputport>
            <outputport name="result" id="v23" />
            <functor name="NumberString">
                <property key="dff.functor.alias" value="numberString4049" />
                <inputport name="value" peerid="v19" />
                <inputport name="valueNumber">1</inputport>
            </functor>
        </containerfunctor>
        <containerfunctor name="IfNotThen">
            <property key="dff.functor.alias" value="ifNotThen3619" />
            <inputport name="condition" peerid="v20" />
            <functor name="Exit">
                <property key="dff.functor.alias" value="exit3618" />
                <inputport name="message">$&quot;(Please select a output directory that exists.)&quot;</inputport>
            </functor>
        </containerfunctor>
        <containerfunctor name="IfNotThen">
            <property key="dff.functor.alias" value="ifNotThen43513" />
            <inputport name="condition" peerid="v21" />
            <functor name="Table">
                <property key="dff.functor.alias" value="table41963" />
                <inputport name="constant" peerid="v17" />
                <outputport name="object" id="v24" />
            </functor>
            <containerfunctor name="IfNotThen">
                <property key="dff.functor.alias" value="ifNotThen3619" />
                <inputport name="condition" peerid="v18" />
                <functor name="Exit">
                    <property key="dff.functor.alias" value="exit3618" />
                    <inputport name="message">$&quot;(Error, in Raster Palette CSV. The table must have exactly the format of, columns:\n\n&apos;Category*, From, To, Category_Name, red, green, blue&apos;)&quot;</inputport>
                </functor>
            </containerfunctor>
        </containerfunctor>
    </containerfunctor>
    <containerfunctor name="IfThen">
        <property key="dff.functor.alias" value="ifThen143662" />
        <inputport name="condition" peerid="v21" />
        <functor name="CreateLegendFromQntEntry">
            <property key="dff.functor.alias" value="createLegendFromQntEntry300181" />
            <property key="submodel.in.maximumnumberofcategories.advanced" value="no" />
            <property key="submodel.in.maximumnumberofcategories.description" value="Maximum number of categories in the resulting categorization." />
            <property key="submodel.in.maximumnumberofcategories.name" value="maximumNumberOfCategories" />
            <property key="submodel.in.maximumnumberofcategories.optional" value="yes" />
            <property key="submodel.in.maximumnumberofcategories.order" value="7" />
            <inputport name="inputMap" peerid="v3" />
            <inputport name="MaximumNumberOfCategories">8</inputport>
            <outputport name="categoriesAsCsv" id="v25" />
        </functor>
    </containerfunctor>
</script>
